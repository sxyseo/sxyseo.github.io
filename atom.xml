<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>少将博客 Abel&#39;s blog</title>
  
  <subtitle>实战、分享、共成长</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://jiangshaobo.cn/"/>
  <updated>2018-03-11T10:22:03.000Z</updated>
  <id>https://jiangshaobo.cn/</id>
  
  <author>
    <name>Abel</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>HTTP</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/HTTP.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/HTTP.html</id>
    <published>2018-03-11T03:58:31.000Z</published>
    <updated>2018-03-11T10:22:03.000Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#基础概念">基础概念</a><ul><li><a href="#web-基础">Web 基础</a></li><li><a href="#url">URL</a></li><li><a href="#请求和响应报文">请求和响应报文</a></li></ul></li><li><a href="#http-方法">HTTP 方法</a><ul><li><a href="#get获取资源">GET：获取资源</a></li><li><a href="#post传输实体主体">POST：传输实体主体</a></li><li><a href="#head获取报文首部">HEAD：获取报文首部</a></li><li><a href="#put上传文件">PUT：上传文件</a></li><li><a href="#delete删除文件">DELETE：删除文件</a></li><li><a href="#options查询支持的方法">OPTIONS：查询支持的方法</a></li><li><a href="#trace追踪路径">TRACE：追踪路径</a></li><li><a href="#connect要求用隧道协议连接代理">CONNECT：要求用隧道协议连接代理</a></li></ul></li><li><a href="#http-状态码">HTTP 状态码</a><ul><li><a href="#2xx-成功">2XX 成功</a></li><li><a href="#3xx-重定向">3XX 重定向</a></li><li><a href="#4xx-客户端错误">4XX 客户端错误</a></li><li><a href="#5xx-服务器错误">5XX 服务器错误</a></li></ul></li><li><a href="#http-首部">HTTP 首部</a><ul><li><a href="#通用首部字段">通用首部字段</a></li><li><a href="#请求首部字段">请求首部字段</a></li><li><a href="#响应首部字段">响应首部字段</a></li><li><a href="#实体首部字段">实体首部字段</a></li></ul></li><li><a href="#具体应用">具体应用</a><ul><li><a href="#cookie">Cookie</a></li><li><a href="#缓存">缓存</a></li><li><a href="#持久连接">持久连接</a></li><li><a href="#编码">编码</a></li><li><a href="#分块传输">分块传输</a></li><li><a href="#多部分对象集合">多部分对象集合</a></li><li><a href="#范围请求">范围请求</a></li><li><a href="#内容协商">内容协商</a></li><li><a href="#虚拟主机">虚拟主机</a></li><li><a href="#通信数据转发">通信数据转发</a></li></ul></li><li><a href="#https">HTTPs</a><ul><li><a href="#加密">加密</a></li><li><a href="#认证">认证</a></li><li><a href="#完整性">完整性</a></li></ul></li><li><a href="#http10-与-http11-的区别">HTTP/1.0 与 HTTP/1.1 的区别</a><!-- GFM-TOC --></li></ul><h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><h2 id="Web-基础"><a href="#Web-基础" class="headerlink" title="Web 基础"></a>Web 基础</h2><ul><li>HTTP（HyperText Transfer Protocol，超文本传输协议）。</li><li>WWW（World Wide Web）的三种技术：HTML、HTTP、URL。</li><li>RFC（Request for Comments，征求修正意见书），互联网的设计文档。</li></ul><h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><ul><li>URI（Uniform Resource Indentifier，统一资源标识符）</li><li>URL（Uniform Resource Locator，统一资源定位符）</li><li>URN（Uniform Resource Name，统一资源名称），例如 urn:isbn:0-486-27557-4 。</li></ul><p>URI 包含 URL 和 URN，目前 WEB 只有 URL 比较流行，所以见到的基本都是 URL。</p><a id="more"></a><p><br><div align="center"> <img src="/pics/4102b7d0-39b9-48d8-82ae-ac4addb7ebfb.jpg"> </div><br></p><h2 id="请求和响应报文"><a href="#请求和响应报文" class="headerlink" title="请求和响应报文"></a>请求和响应报文</h2><p><strong>请求报文</strong> </p><p><br><div align="center"> <img src="/pics/22b39f77-ac47-4978-91ed-84aaf457644c.jpg"> </div><br></p><p><strong>响应报文</strong> </p><p><br><div align="center"> <img src="/pics/00d8d345-cd4a-48af-919e-209d2788eca7.jpg"> </div><br></p><h1 id="HTTP-方法"><a href="#HTTP-方法" class="headerlink" title="HTTP 方法"></a>HTTP 方法</h1><p>客户端发送的请求报文第一行为请求行，包含了方法字段。</p><h2 id="GET：获取资源"><a href="#GET：获取资源" class="headerlink" title="GET：获取资源"></a>GET：获取资源</h2><h2 id="POST：传输实体主体"><a href="#POST：传输实体主体" class="headerlink" title="POST：传输实体主体"></a>POST：传输实体主体</h2><p>POST 主要目的不是获取资源，而是传输实体主体数据。</p><p>GET 和 POST 的请求都能使用额外的参数，但是 GET 的参数是以查询字符串出现在 URL 中，而 POST 的参数存储在实体主体部分。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/test/demo_form.asp?name1=value1&amp;name2=value2</span> HTTP/1.1</span><br></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /test/demo_form<span class="selector-class">.asp</span> HTTP/<span class="number">1.1</span></span><br><span class="line">Host: w3schools.com</span><br><span class="line">name1=value1&amp;name2=value2</span><br></pre></td></tr></table></figure><p>GET 的传参方式相比于 POST 安全性较差，因为 GET 传的参数在 URL 是可见的，可能会泄露私密信息。并且 GET 只支持 ASCII 字符，如果参数为中文则可能会出现乱码，而 POST 支持标准字符集。</p><h2 id="HEAD：获取报文首部"><a href="#HEAD：获取报文首部" class="headerlink" title="HEAD：获取报文首部"></a>HEAD：获取报文首部</h2><p>和 GET 方法一样，但是不返回报文实体主体部分。</p><p>主要用于确认 URL 的有效性以及资源更新的日期时间等。</p><h2 id="PUT：上传文件"><a href="#PUT：上传文件" class="headerlink" title="PUT：上传文件"></a>PUT：上传文件</h2><p>由于自身不带验证机制，任何人都可以上传文件，因此存在安全性问题，一般 WEB 网站不使用该方法。</p><h2 id="DELETE：删除文件"><a href="#DELETE：删除文件" class="headerlink" title="DELETE：删除文件"></a>DELETE：删除文件</h2><p>与 PUT 功能相反，并且同样不带验证机制。</p><h2 id="OPTIONS：查询支持的方法"><a href="#OPTIONS：查询支持的方法" class="headerlink" title="OPTIONS：查询支持的方法"></a>OPTIONS：查询支持的方法</h2><p>查询指定的 URL 能够支持的方法。</p><p>会返回 Allow: GET, POST, HEAD, OPTIONS 这样的内容。</p><h2 id="TRACE：追踪路径"><a href="#TRACE：追踪路径" class="headerlink" title="TRACE：追踪路径"></a>TRACE：追踪路径</h2><p>服务器会将通信路径返回给客户端。</p><p>发送请求时，在 Max-Forwards 首部字段中填入数值，每经过一个服务器就会减 1，当数值为 0 时就停止传输。</p><p>TRACE 一般不会使用，并且它容易受到 XST 攻击（Cross-Site Tracing，跨站追踪），因此更不会去使用它。</p><p><br><div align="center"> <img src="/pics/c8637fd2-3aaa-46c4-b7d9-f24d3fa04781.jpg"> </div><br></p><h2 id="CONNECT：要求用隧道协议连接代理"><a href="#CONNECT：要求用隧道协议连接代理" class="headerlink" title="CONNECT：要求用隧道协议连接代理"></a>CONNECT：要求用隧道协议连接代理</h2><p>主要使用 SSL（Secure Sokets Layer，安全套接字）和 TLS（Transport Layer Security，传输层安全）协议把通信内容加密后经网络隧道传输。</p><p><br><div align="center"> <img src="/pics/5994928c-3d2d-45bd-abb1-adc4f5f4d775.jpg"> </div><br></p><h1 id="HTTP-状态码"><a href="#HTTP-状态码" class="headerlink" title="HTTP 状态码"></a>HTTP 状态码</h1><p>服务器返回的响应报文中第一行为状态行，包含了状态码以及原因短语，来告知客户端请求的结果。</p><table><thead><tr><th>状态码</th><th>类别</th><th>原因短语</th></tr></thead><tbody><tr><td>1XX</td><td>Informational（信息性状态码）</td><td>接收的请求正在处理</td></tr><tr><td>2XX</td><td>Success（成功状态码）</td><td>请求正常处理完毕</td></tr><tr><td>3XX</td><td>Redirection（重定向状态码）</td><td>需要进行附加操作以完成请求</td></tr><tr><td>4XX</td><td>Client Error（客户端错误状态码）</td><td>服务器无法处理请求</td></tr><tr><td>5XX</td><td>Server Error（服务器错误状态码）</td><td>服务器处理请求出错</td></tr></tbody></table><h2 id="2XX-成功"><a href="#2XX-成功" class="headerlink" title="2XX 成功"></a>2XX 成功</h2><ul><li><p><strong>200 OK</strong> </p></li><li><p><strong>204 No Content</strong> ：请求已经成功处理，但是返回的响应报文不包含实体的主体部分。一般在只需要从客户端往服务器发送信息，而不需要返回数据时使用。</p></li><li><p><strong>206 Partial Content</strong> </p></li></ul><h2 id="3XX-重定向"><a href="#3XX-重定向" class="headerlink" title="3XX 重定向"></a>3XX 重定向</h2><ul><li><p><strong>301 Moved Permanently</strong> ：永久性重定向</p></li><li><p><strong>302 Found</strong> ：临时性重定向</p></li><li><p><strong>303 See Other</strong> </p></li><li><p>注：虽然 HTTP 协议规定 301、302 状态下重定向时不允许把 POST 方法改成 GET 方法，但是大多数浏览器都会 在 301、302 和 303 状态下的重定向把 POST 方法改成 GET 方法。</p></li><li><p><strong>304 Not Modified</strong> ：如果请求报文首部包含一些条件，例如：If-Match，If-ModifiedSince，If-None-Match，If-Range，If-Unmodified-Since，但是不满足条件，则服务器会返回 304 状态码。</p></li><li><p><strong>307 Temporary Redirect</strong> ：临时重定向，与 302 的含义类似，但是 307 要求浏览器不会把重定向请求的 POST 方法改成 GET 方法。</p></li></ul><h2 id="4XX-客户端错误"><a href="#4XX-客户端错误" class="headerlink" title="4XX 客户端错误"></a>4XX 客户端错误</h2><ul><li><p><strong>400 Bad Request</strong> ：请求报文中存在语法错误</p></li><li><p><strong>401 Unauthorized</strong> ：该状态码表示发送的请求需要有通过 HTTP 认证（BASIC 认证、DIGEST 认证）的认证信息。如果之前已进行过一次请求，则表示用户认证失败。</p></li></ul><p><br><div align="center"> <img src="/pics/b1b4cf7d-c54a-4ff1-9741-cd2eea331123.jpg"> </div><br></p><ul><li><p><strong>403 Forbidden</strong> ：请求被拒绝，服务器端没有必要给出拒绝的详细理由。</p></li><li><p><strong>404 Not Found</strong> </p></li></ul><h2 id="5XX-服务器错误"><a href="#5XX-服务器错误" class="headerlink" title="5XX 服务器错误"></a>5XX 服务器错误</h2><ul><li><p><strong>500 Internal Server Error</strong> ：服务器正在执行请求时发生错误</p></li><li><p><strong>503 Service Unavilable</strong> ：该状态码表明服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。</p></li></ul><h1 id="HTTP-首部"><a href="#HTTP-首部" class="headerlink" title="HTTP 首部"></a>HTTP 首部</h1><p>有 4 种类型的首部字段：通用首部字段、请求首部字段、响应首部字段和实体首部字段。</p><p>各种首部字段及其含义如下（不需要全记，仅供查阅）：</p><h2 id="通用首部字段"><a href="#通用首部字段" class="headerlink" title="通用首部字段"></a>通用首部字段</h2><table><thead><tr><th>首部字段名</th><th>说明</th></tr></thead><tbody><tr><td>Cache-Control</td><td>控制缓存的行为</td></tr><tr><td>Connection</td><td>逐跳首部、 连接的管理</td></tr><tr><td>Date</td><td>创建报文的日期时间</td></tr><tr><td>Pragma</td><td>报文指令</td></tr><tr><td>Trailer</td><td>报文末端的首部一览</td></tr><tr><td>Transfer-Encoding</td><td>指定报文主体的传输编码方式</td></tr><tr><td>Upgrade</td><td>升级为其他协议</td></tr><tr><td>Via</td><td>代理服务器的相关信息</td></tr><tr><td>Warning</td><td>错误通知</td></tr></tbody></table><h2 id="请求首部字段"><a href="#请求首部字段" class="headerlink" title="请求首部字段"></a>请求首部字段</h2><table><thead><tr><th>首部字段名</th><th>说明</th></tr></thead><tbody><tr><td>Accept</td><td>用户代理可处理的媒体类型</td></tr><tr><td>Accept-Charset</td><td>优先的字符集</td></tr><tr><td>Accept-Encoding</td><td>优先的内容编码</td></tr><tr><td>Accept-Language</td><td>优先的语言（自然语言）</td></tr><tr><td>Authorization</td><td>Web 认证信息</td></tr><tr><td>Expect</td><td>期待服务器的特定行为</td></tr><tr><td>From</td><td>用户的电子邮箱地址</td></tr><tr><td>Host</td><td>请求资源所在服务器</td></tr><tr><td>If-Match</td><td>比较实体标记（ETag）</td></tr><tr><td>If-Modified-Since</td><td>比较资源的更新时间</td></tr><tr><td>If-None-Match</td><td>比较实体标记（与 If-Match 相反）</td></tr><tr><td>If-Range</td><td>资源未更新时发送实体 Byte 的范围请求</td></tr><tr><td>If-Unmodified-Since</td><td>比较资源的更新时间（与 If-Modified-Since 相反）</td></tr><tr><td>Max-Forwards</td><td>最大传输逐跳数</td></tr><tr><td>Proxy-Authorization</td><td>代理服务器要求客户端的认证信息</td></tr><tr><td>Range</td><td>实体的字节范围请求</td></tr><tr><td>Referer</td><td>对请求中 URI 的原始获取方</td></tr><tr><td>TE</td><td>传输编码的优先级</td></tr><tr><td>User-Agent</td><td>HTTP 客户端程序的信息</td></tr></tbody></table><h2 id="响应首部字段"><a href="#响应首部字段" class="headerlink" title="响应首部字段"></a>响应首部字段</h2><table><thead><tr><th>首部字段名</th><th>说明</th></tr></thead><tbody><tr><td>Accept-Ranges</td><td>是否接受字节范围请求</td></tr><tr><td>Age</td><td>推算资源创建经过时间</td></tr><tr><td>ETag</td><td>资源的匹配信息</td></tr><tr><td>Location</td><td>令客户端重定向至指定 URI</td></tr><tr><td>Proxy-Authenticate</td><td>代理服务器对客户端的认证信息</td></tr><tr><td>Retry-After</td><td>对再次发起请求的时机要求</td></tr><tr><td>Server</td><td>HTTP 服务器的安装信息</td></tr><tr><td>Vary</td><td>代理服务器缓存的管理信息</td></tr><tr><td>WWW-Authenticate</td><td>服务器对客户端的认证信息</td></tr></tbody></table><h2 id="实体首部字段"><a href="#实体首部字段" class="headerlink" title="实体首部字段"></a>实体首部字段</h2><table><thead><tr><th>首部字段名</th><th>说明</th></tr></thead><tbody><tr><td>Allow</td><td>资源可支持的 HTTP 方法</td></tr><tr><td>Content-Encoding</td><td>实体主体适用的编码方式</td></tr><tr><td>Content-Language</td><td>实体主体的自然语言</td></tr><tr><td>Content-Length</td><td>实体主体的大小（单位： 字节）</td></tr><tr><td>Content-Location</td><td>替代对应资源的 URI</td></tr><tr><td>Content-MD5</td><td>实体主体的报文摘要</td></tr><tr><td>Content-Range</td><td>实体主体的位置范围</td></tr><tr><td>Content-Type</td><td>实体主体的媒体类型</td></tr><tr><td>Expires</td><td>实体主体过期的日期时间</td></tr><tr><td>Last-Modified</td><td>资源的最后修改日期时间</td></tr></tbody></table><h1 id="具体应用"><a href="#具体应用" class="headerlink" title="具体应用"></a>具体应用</h1><h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><p>HTTP 协议是无状态的，主要是为了让 HTTP 协议尽可能简单，使得它能够处理大量事务。HTTP/1.1 引入 Cookie 来保存状态信息。</p><p>服务器发送的响应报文包含 Set-Cookie 字段，客户端得到响应报文后把 Cookie 内容保存到浏览器中。下次再发送请求时，从浏览器中读出 Cookie 值，在请求报文中包含 Cookie 字段，这样服务器就知道客户端的状态信息了。Cookie 状态信息保存在客户端浏览器中，而不是服务器上。</p><p><br><div align="center"> <img src="/pics/ff17c103-750a-4bb8-9afa-576327023af9.png"> </div><br></p><p>Set-Cookie 字段有以下属性：</p><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>NAME=VALUE</td><td>赋予 Cookie 的名称和其值（必需项）</td></tr><tr><td>expires=DATE</td><td>Cookie 的有效期（若不明确指定则默认为浏览器关闭前为止）</td></tr><tr><td>path=PATH</td><td>将服务器上的文件目录作为 Cookie 的适用对象（若不指定则默认为文档所在的文件目录）</td></tr><tr><td>domain= 域名</td><td>作为 Cookie 适用对象的域名（若不指定则默认为创建 Cookie 的服务器的域名）</td></tr><tr><td>Secure</td><td>仅在 HTTPS 安全通信时才会发送 Cookie</td></tr><tr><td>HttpOnly</td><td>加以限制，使 Cookie 不能被 JavaScript 脚本访问</td></tr></tbody></table><p><strong>Session 和 Cookie 区别</strong> </p><p>Session 是服务器用来跟踪用户的一种手段，每个 Session 都有一个唯一标识：Session ID。当服务器创建了一个 Session 时，给客户端发送的响应报文就包含了 Set-Cookie 字段，其中有一个名为 sid 的键值对，这个键值对就是 Session ID。客户端收到后就把 Cookie 保存在浏览器中，并且之后发送的请求报文都包含 Session ID。HTTP 就是通过 Session 和 Cookie 这两种方式一起合作来实现跟踪用户状态的，Session 用于服务器端，Cookie 用于客户端。</p><p><strong>浏览器禁用 Cookie 的情况</strong> </p><p>会使用 URL 重写技术，在 URL 后面加上 sid=xxx 。</p><p><strong>使用 Cookie 实现用户名和密码的自动填写</strong> </p><p>网站脚本会自动从 Cookie 中读取用户名和密码，从而实现自动填写。</p><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>有两种缓存方法：让代理服务器进行缓存和让客户端浏览器进行缓存。</p><p>Cache-Control 用于控制缓存的行为。Cache-Control: no-cache 有两种含义，如果是客户端向缓存服务器发送的请求报文中含有该指令，表示客户端不想要缓存的资源；如果是源服务器向缓存服务器发送的响应报文中含有该指令，表示缓存服务器不能对资源进行缓存。</p><p>Expires 字段可以用于告知缓存服务器该资源什么时候会过期。当首部字段 Cache-Control 有指定 max-age 指令时，比起首部字段 Expires，会优先处理 max-age 指令。</p><h2 id="持久连接"><a href="#持久连接" class="headerlink" title="持久连接"></a>持久连接</h2><p>当浏览器访问一个包含多张图片的 HTML 页面时，除了请求访问 HTML 页面资源，还会请求图片资源，如果每进行一次 HTTP 通信就要断开一次 TCP 连接，连接建立和断开的开销会很大。 <strong>持久连接</strong>  只需要进行一次 TCP 连接就能进行多次 HTTP 通信。HTTP/1.1 开始，所有的连接默认都是持久连接。</p><p><br><div align="center"> <img src="/pics/c73a0b78-5f46-4d2d-a009-dab2a999b5d8.jpg"> </div><br></p><p>持久连接需要使用 Connection 首部字段进行管理。HTTP/1.1 开始 HTTP 默认是持久化连接的，如果要断开 TCP 连接，需要由客户端或者服务器端提出断开，使用 Connection: close；而在 HTTP/1.1 之前默认是非持久化连接的，如果要维持持续连接，需要使用 Keep-Alive。</p><p>管线化方式可以同时发送多个请求和响应，而不需要发送一个请求然后等待响应之后再发下一个请求。</p><p><br><div align="center"> <img src="/pics/6943e2af-5a70-4004-8bee-b33d60f39da3.jpg"> </div><br></p><h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>编码（Encoding）主要是为了对实体进行压缩。常用的编码有：gzip、compress、deflate、identity，其中 identity 表示不执行压缩的编码格式。</p><h2 id="分块传输"><a href="#分块传输" class="headerlink" title="分块传输"></a>分块传输</h2><p>分块传输（Chunked Transfer Coding）可以把数据分割成多块，让浏览器逐步显示页面。</p><h2 id="多部分对象集合"><a href="#多部分对象集合" class="headerlink" title="多部分对象集合"></a>多部分对象集合</h2><p>一份报文主体内可含有多种类型的实体同时发送，每个部分之间用 boundary 字段定义的分隔符进行分隔；每个部分都可以有首部字段。</p><p>例如，上传多个表单时可以使用如下方式：</p><p><br><div align="center"> <img src="/pics/2279cc60-9714-4e0e-aac9-4c348e0c2165.png"> </div><br></p><h2 id="范围请求"><a href="#范围请求" class="headerlink" title="范围请求"></a>范围请求</h2><p>如果网络出现中断，服务器只发送了一部分数据，范围请求使得客户端能够只请求未发送的那部分数据，从而避免服务器端重新发送所有数据。</p><p>在请求报文首部中添加 Range 字段，然后指定请求的范围，例如 Range:bytes=5001-10000。请求成功的话服务器发送 206 Partial Content 状态。</p><h2 id="内容协商"><a href="#内容协商" class="headerlink" title="内容协商"></a>内容协商</h2><p>通过内容协商返回最合适的内容，例如根据浏览器的默认语言选择返回中文界面还是英文界面。</p><p>涉及以下首部字段：Accept、Accept-Charset、Accept-Encoding、Accept-Language、Content-Language。</p><h2 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h2><p>使用虚拟主机技术，使得一台服务器拥有多个域名，并且在逻辑上可以看成多个服务器。</p><h2 id="通信数据转发"><a href="#通信数据转发" class="headerlink" title="通信数据转发"></a>通信数据转发</h2><p><strong>代理</strong> </p><p>代理服务器接受客户端的请求，并且转发给其它服务器。</p><p>代理服务器一般是透明的，不会改变 URL。</p><p>使用代理的主要目的是：缓存、网络访问控制以及访问日志记录。</p><p><br><div align="center"> <img src="/pics/c07035c3-a9ba-4508-8e3c-d8ae4c6ee9ee.jpg"> </div><br></p><p><strong>网关</strong> </p><p>与代理服务器不同的是，网关服务器会将 HTTP 转化为其它协议进行通信，从而请求其它非 HTTP 服务器的服务。</p><p><br><div align="center"> <img src="/pics/81375888-6be1-476f-9521-42eea3e3154f.jpg"> </div><br></p><p><strong>隧道</strong> </p><p>使用 SSL 等加密手段，为客户端和服务器之间建立一条安全的通信线路。</p><p><br><div align="center"> <img src="/pics/64b95403-d976-421a-8b45-bac89c0b5185.jpg"> </div><br></p><h1 id="HTTPs"><a href="#HTTPs" class="headerlink" title="HTTPs"></a>HTTPs</h1><p>HTTP 有以下安全性问题：</p><ol><li>使用明文进行通信，内容可能会被窃听；</li><li>不验证通信方的身份，通信方的身份有可能遭遇伪装；</li><li>无法证明报文的完整性，报文有可能遭篡改。</li></ol><p>HTTPs 并不是新协议，而是 HTTP 先和 SSL（Secure Socket Layer）通信，再由 SSL 和 TCP 通信。通过使用 SSL，HTTPs 提供了加密、认证和完整性保护。</p><h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p>有两种加密方式：对称密钥加密和公开密钥加密。对称密钥加密的加密和解密使用同一密钥，而公开密钥加密使用一对密钥用于加密和解密，分别为公开密钥和私有密钥。公开密钥所有人都可以获得，通信发送方获得接收方的公开密钥之后，就可以使用公开密钥进行加密，接收方收到通信内容后使用私有密钥解密。</p><p>对称密钥加密的缺点：无法安全传输密钥；公开密钥加密的缺点：相对来说更耗时。</p><p>HTTPs 采用  <strong>混合的加密机制</strong> ，使用公开密钥加密用于传输对称密钥，之后使用对称密钥加密进行通信。（下图中，共享密钥即对称密钥）</p><p><br><div align="center"> <img src="/pics/110b1a9b-87cd-45c3-a21d-824623715b33.jpg"> </div><br></p><h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><p>通过使用  <strong>证书</strong>  来对通信方进行认证。证书中有公开密钥数据，如果可以验证公开密钥的确属于通信方的，那么就可以确定通信方是可靠的。</p><p>数字证书认证机构（CA，Certificate Authority）可以对其颁发的公开密钥证书对其进行验证。</p><p>进行 HTTPs 通信时，服务器会把证书发送给客户端，客户端取得其中的公开密钥之后，就可以开始通信。</p><p>使用 OpenSSL 这套开源程序，每个人都可以构建一套属于自己的认证机构，从而自己给自己颁发服务器证书。浏览器在访问该服务器时，会显示“无法确认连接安全性”或“该网站的安全证书存在问题”等警告消息。</p><p>客户端证书需要用户自行安装，只有在业务需要非常高的安全性时才使用客户端证书，例如网上银行。</p><h2 id="完整性"><a href="#完整性" class="headerlink" title="完整性"></a>完整性</h2><p>SSL 提供摘要功能来验证完整性。</p><h1 id="HTTP-1-0-与-HTTP-1-1-的区别"><a href="#HTTP-1-0-与-HTTP-1-1-的区别" class="headerlink" title="HTTP/1.0 与 HTTP/1.1 的区别"></a>HTTP/1.0 与 HTTP/1.1 的区别</h1><p>HTTP/1.1 新增了以下内容：</p><ul><li>默认为长连接；</li><li>提供了范围请求功能；</li><li>提供了虚拟主机的功能；</li><li>多了一些缓存处理字段；</li><li>多了一些状态码；</li></ul><hr><p>本文来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#基础概念&quot;&gt;基础概念&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#web-基础&quot;&gt;Web 基础&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#url&quot;&gt;URL&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#请求和响应报文&quot;&gt;请求和响应报文&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#http-方法&quot;&gt;HTTP 方法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#get获取资源&quot;&gt;GET：获取资源&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#post传输实体主体&quot;&gt;POST：传输实体主体&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#head获取报文首部&quot;&gt;HEAD：获取报文首部&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#put上传文件&quot;&gt;PUT：上传文件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#delete删除文件&quot;&gt;DELETE：删除文件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#options查询支持的方法&quot;&gt;OPTIONS：查询支持的方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#trace追踪路径&quot;&gt;TRACE：追踪路径&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#connect要求用隧道协议连接代理&quot;&gt;CONNECT：要求用隧道协议连接代理&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#http-状态码&quot;&gt;HTTP 状态码&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#2xx-成功&quot;&gt;2XX 成功&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3xx-重定向&quot;&gt;3XX 重定向&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4xx-客户端错误&quot;&gt;4XX 客户端错误&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5xx-服务器错误&quot;&gt;5XX 服务器错误&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#http-首部&quot;&gt;HTTP 首部&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#通用首部字段&quot;&gt;通用首部字段&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#请求首部字段&quot;&gt;请求首部字段&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#响应首部字段&quot;&gt;响应首部字段&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#实体首部字段&quot;&gt;实体首部字段&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#具体应用&quot;&gt;具体应用&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#cookie&quot;&gt;Cookie&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#缓存&quot;&gt;缓存&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#持久连接&quot;&gt;持久连接&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#编码&quot;&gt;编码&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分块传输&quot;&gt;分块传输&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#多部分对象集合&quot;&gt;多部分对象集合&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#范围请求&quot;&gt;范围请求&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#内容协商&quot;&gt;内容协商&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#虚拟主机&quot;&gt;虚拟主机&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#通信数据转发&quot;&gt;通信数据转发&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#https&quot;&gt;HTTPs&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#加密&quot;&gt;加密&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#认证&quot;&gt;认证&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#完整性&quot;&gt;完整性&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#http10-与-http11-的区别&quot;&gt;HTTP/1.0 与 HTTP/1.1 的区别&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;基础概念&quot;&gt;&lt;a href=&quot;#基础概念&quot; class=&quot;headerlink&quot; title=&quot;基础概念&quot;&gt;&lt;/a&gt;基础概念&lt;/h1&gt;&lt;h2 id=&quot;Web-基础&quot;&gt;&lt;a href=&quot;#Web-基础&quot; class=&quot;headerlink&quot; title=&quot;Web 基础&quot;&gt;&lt;/a&gt;Web 基础&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;HTTP（HyperText Transfer Protocol，超文本传输协议）。&lt;/li&gt;
&lt;li&gt;WWW（World Wide Web）的三种技术：HTML、HTTP、URL。&lt;/li&gt;
&lt;li&gt;RFC（Request for Comments，征求修正意见书），互联网的设计文档。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;URL&quot;&gt;&lt;a href=&quot;#URL&quot; class=&quot;headerlink&quot; title=&quot;URL&quot;&gt;&lt;/a&gt;URL&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;URI（Uniform Resource Indentifier，统一资源标识符）&lt;/li&gt;
&lt;li&gt;URL（Uniform Resource Locator，统一资源定位符）&lt;/li&gt;
&lt;li&gt;URN（Uniform Resource Name，统一资源名称），例如 urn:isbn:0-486-27557-4 。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;URI 包含 URL 和 URN，目前 WEB 只有 URL 比较流行，所以见到的基本都是 URL。&lt;/p&gt;
    
    </summary>
    
    
      <category term="http" scheme="https://jiangshaobo.cn/tags/http/"/>
    
  </entry>
  
  <entry>
    <title>Java 基础</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/Java%20%E5%9F%BA%E7%A1%80.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/Java 基础.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:32:56.418Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#关键字">关键字</a><ul><li><a href="#1-final">1. final</a></li><li><a href="#2-static">2. static</a></li></ul></li><li><a href="#object-通用方法">Object 通用方法</a><ul><li><a href="#1-概览">1. 概览</a></li><li><a href="#2-clone">2. clone()</a></li><li><a href="#3-equals">3. equals()</a></li></ul></li><li><a href="#继承">继承</a><ul><li><a href="#1-访问权限">1. 访问权限</a></li><li><a href="#2-抽象类与接口的区别">2. 抽象类与接口的区别</a></li><li><a href="#3-super">3. super()</a></li></ul></li><li><a href="#string">String</a><ul><li><a href="#1-string,-stringbuffer-and-stringbuilder">1. String, StringBuffer and StringBuilder</a></li><li><a href="#2-string-不可变的原因">2. String 不可变的原因</a></li><li><a href="#3-stringintern">3. String.intern()</a></li></ul></li><li><a href="#基本类型与运算">基本类型与运算</a><ul><li><a href="#1-包装类型">1. 包装类型</a></li><li><a href="#2-switch">2. switch</a></li></ul></li><li><a href="#反射">反射</a></li><li><a href="#异常">异常</a></li><li><a href="#泛型">泛型</a></li><li><a href="#特性">特性</a><ul><li><a href="#1-三大特性">1. 三大特性</a></li><li><a href="#2-java-各版本的新特性">2. Java 各版本的新特性</a></li><li><a href="#3-java-与-c++-的区别">3. Java 与 C++ 的区别</a></li><li><a href="#4-jre-or-jdk">4. JRE or JDK</a><!-- GFM-TOC --></li></ul></li></ul><h1 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h1><h2 id="1-final"><a href="#1-final" class="headerlink" title="1. final"></a>1. final</h2><p><strong>数据</strong> </p><p>声明数据为常量，可以是编译时常量，也可以是在运行时被初始化后不能被改变的常量。</p><p>对于基本类型，final 使数值不变；对于引用对象，final 使引用不变，也就不能引用其它对象，但是被引用的对象本身是可以修改的。</p><p><strong>方法</strong> </p><p>声明方法不能被子类覆盖。</p><p>private 方法隐式地被指定为 final，如果在子类中定义的方法和基类中的一个 private 方法签名相同，此时子类的方法不是覆盖基类方法，而是重载了。</p><a id="more"></a><p><strong>类</strong> </p><p>声明类不允许被继承。</p><h2 id="2-static"><a href="#2-static" class="headerlink" title="2. static"></a>2. static</h2><p><strong>变量</strong> </p><p>静态变量在内存中只存在一份，只在类第一次实例化时初始化一次，同时类所有的实例都共享静态变量，可以直接通过类名来访问它。</p><p>但是实例变量则不同，它是伴随着实例的，每创建一个实例就会产生一个实例变量，它与该实例同生共死。</p><p><strong>方法</strong> </p><p>静态方法在类加载的时候就存在了，它不依赖于任何实例，所以 static 方法必须实现，也就是说他不能是抽象方法 abstract。</p><p><strong>静态语句块</strong> </p><p>静态语句块和静态变量一样在类第一次实例化时运行一次。</p><p><strong>初始化顺序</strong> </p><p>静态数据优先于其它数据的初始化，静态变量和静态语句块哪个先运行取决于它们在代码中的顺序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String staticField = <span class="string">"静态变量"</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">"静态初始化块"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实例变量和普通语句块的初始化在静态变量和静态语句块初始化结束之后。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String field = <span class="string">"变量"</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    System.out.println(<span class="string">"初始化块"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后才是构造函数中的数据进行初始化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InitialOrderTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"构造器"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>存在继承的情况下，初始化顺序为：</p><ol><li>父类（静态变量、静态初始化块）</li><li>子类（静态变量、静态初始化块）</li><li>父类（变量、初始化块）</li><li>父类（构造器）</li><li>子类（变量、初始化块）</li><li>子类（构造器）</li></ol><h1 id="Object-通用方法"><a href="#Object-通用方法" class="headerlink" title="Object 通用方法"></a>Object 通用方法</h1><h2 id="1-概览"><a href="#1-概览" class="headerlink" title="1. 概览"></a>1. 概览</h2><ul><li>public final native Class&lt;?&gt; getClass()</li><li>public native int hashCode()</li><li>public boolean equals(Object obj)</li><li>protected native Object clone() throws CloneNotSupportedException</li><li>public String toString()</li><li>public final native void notify()</li><li>public final native void notifyAll()</li><li>public final native void wait(long timeout) throws InterruptedException</li><li>public final void wait(long timeout, int nanos) throws InterruptedException</li><li>public final void wait() throws InterruptedException</li><li>protected void finalize() throws Throwable { }</li></ul><h2 id="2-clone"><a href="#2-clone" class="headerlink" title="2. clone()"></a>2. clone()</h2><p><strong>浅拷贝</strong> </p><p>引用类型引用的是同一个对象，clone() 方法默认就是浅拷贝实现。</p><p><br><div align="center"> <img src="../pics/d990c0e7-64d1-4ba3-8356-111bc91e53c5.png"> </div><br></p><p><strong>深拷贝</strong> </p><p>可以使用序列化实现。</p><p><br><div align="center"> <img src="../pics/2e5620c4-b558-46fe-8f12-00c9dd597a61.png"> </div><br></p><blockquote><p><a href="https://stackoverflow.com/questions/869033/how-do-i-copy-an-object-in-java" target="_blank" rel="noopener">How do I copy an object in Java?</a></p></blockquote><h2 id="3-equals"><a href="#3-equals" class="headerlink" title="3. equals()"></a>3. equals()</h2><ul><li>对于基本类型，== 就是判断两个值是否相等；</li><li>对于引用类型，== 是判断两个引用是否引用同一个对象，而 equals() 是判断引用的对象是否等价。</li></ul><p>等价性：<a href="https://github.com/CyC2018/InterviewNotes/blob/master/notes/Java%20%E5%AE%B9%E5%99%A8.md#%E6%95%A3%E5%88%97" target="_blank" rel="noopener"> 散列 </a></p><h1 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h1><h2 id="1-访问权限"><a href="#1-访问权限" class="headerlink" title="1. 访问权限"></a>1. 访问权限</h2><p>Java 中有三个访问权限修饰符：private、protected 以及 public，如果不加访问修饰符，表示包级可见。</p><p>可以对类或类中的成员（字段以及方法）加上访问修饰符。成员可见表示其它类可以用成员所在类的对象访问到该成员；类可见表示其它类可以用这个类创建对象，可以把类当做包中的一个成员，然后包表示一个类，这样就好理解了。</p><p>protected 用于修饰成员，表示在继承体系中成员对于子类可见。但是这个访问修饰符对于类没有意义，因为包没有继承体系。</p><p>更详细的内容：<a href="http://www.importnew.com/18097.html" target="_blank" rel="noopener"> 浅析 Java 中的访问权限控制 </a></p><h2 id="2-抽象类与接口的区别"><a href="#2-抽象类与接口的区别" class="headerlink" title="2. 抽象类与接口的区别"></a>2. 抽象类与接口的区别</h2><p>抽象类至少包含一个抽象方法，该抽象方法必须在子类中实现。由于抽象类没有抽象方法的具体实现，因此不能对抽象类进行实例化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericServlet</span> <span class="keyword">implements</span> <span class="title">Servlet</span>, <span class="title">ServletConfig</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// abstract method</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Its implementation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// other method related to Servlet</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接口定义了一组方法，但是接口都没有方法的实现，也就是说这些方法都是抽象方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Externalizable</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更详细的内容：<a href="http://www.importnew.com/12399.html" target="_blank" rel="noopener">Java 抽象类与接口的区别 </a></p><h2 id="3-super"><a href="#3-super" class="headerlink" title="3. super()"></a>3. super()</h2><p>用来访问父类的构造函数父类的方法，第二种情况中，子类需要重载父类的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subclass</span> <span class="keyword">extends</span> <span class="title">Superclass</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overrides printMethod in Superclass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.printMethod();</span><br><span class="line">        System.out.println(<span class="string">"Printed in Subclass"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subclass s = <span class="keyword">new</span> Subclass();</span><br><span class="line">        s.printMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://docs.oracle.com/javase/tutorial/java/IandI/super.html" target="_blank" rel="noopener">Using the Keyword super</a></p></blockquote><h1 id="String"><a href="#String" class="headerlink" title="String"></a>String</h1><h2 id="1-String-StringBuffer-and-StringBuilder"><a href="#1-String-StringBuffer-and-StringBuilder" class="headerlink" title="1. String, StringBuffer and StringBuilder"></a>1. String, StringBuffer and StringBuilder</h2><p><strong>是否可变</strong> </p><p>String 不可变，StringBuffer 和 StringBuilder 可变。</p><p><strong>是否线程安全</strong> </p><p>String 不可变，因此是线程安全的。</p><p>StringBuilder 不是线程安全的；StringBuffer 是线程安全的，使用 synchronized 来同步。</p><blockquote><p><a href="https://stackoverflow.com/questions/2971315/string-stringbuffer-and-stringbuilder" target="_blank" rel="noopener">String, StringBuffer, and StringBuilder</a></p></blockquote><h2 id="2-String-不可变的原因"><a href="#2-String-不可变的原因" class="headerlink" title="2. String 不可变的原因"></a>2. String 不可变的原因</h2><p><strong>可以缓存 hash 值</strong> </p><p>因为 String 的 hash 值经常被使用，例如 String 用做 HashMap 等。不可变的特性可以使得 hash 值也不可变，因此就只需要进行一次计算。</p><p><strong>String Pool 的需要</strong> </p><p>如果 String 已经被创建过了，那么就会从 String Pool 中取得引用。只有 String 是不可变的，才可能使用 String Pool。</p><p><br><div align="center"> <img src="../pics/f76067a5-7d5f-4135-9549-8199c77d8f1c.jpg"> </div><br></p><p><strong>安全性</strong> </p><p>String 经常作为参数，例如网络连接参数等，在作为网络连接参数的情况下，如果 String 是可变的，那么在网络连接过程中，String 被改变，改变 String 对象的那一方以为现在连接的是其它主机，而实际情况却不一定是。String 不可变性可以保证参数不可变。</p><p><strong>线程安全</strong> </p><p>String 不可变性天生具备线程安全，可以在多个线程中使用。</p><blockquote><p><a href="https://www.programcreek.com/2013/04/why-string-is-immutable-in-java/" target="_blank" rel="noopener">Why String is immutable in Java?</a></p></blockquote><h2 id="3-String-intern"><a href="#3-String-intern" class="headerlink" title="3. String.intern()"></a>3. String.intern()</h2><p>使用 String.intern() 可以保证所有相同内容的字符串变量引用相同的内存对象。</p><p>更详细的内容：<a href="https://www.jianshu.com/p/95f516cb75ef" target="_blank" rel="noopener"> 揭开 String.intern() 那神秘的面纱 </a></p><h1 id="基本类型与运算"><a href="#基本类型与运算" class="headerlink" title="基本类型与运算"></a>基本类型与运算</h1><h2 id="1-包装类型"><a href="#1-包装类型" class="headerlink" title="1. 包装类型"></a>1. 包装类型</h2><p>八个基本类型：boolean 1 byte 8 char 16 short 16 int 32 float 32 long 64 double 64</p><p>基本类型都有对应的包装类型，它们之间的赋值使用自动装箱与拆箱完成。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Integer x = <span class="number">2</span>;     <span class="comment">// 装箱</span></span><br><span class="line"><span class="keyword">int</span> y = x;         <span class="comment">// 拆箱</span></span><br></pre></td></tr></table></figure><p>new Integer(123) 与 Integer.valueOf(123) 的区别在于，Integer.valueOf(123) 可能会使用缓存对象，因此多次使用 Integer.valueOf(123) 会取得同一个对象的引用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     Integer a = <span class="keyword">new</span> Integer(<span class="number">1</span>);</span><br><span class="line">     Integer b = <span class="keyword">new</span> Integer(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">     System.out.println(<span class="string">"a==b? "</span> + (a==b));</span><br><span class="line"></span><br><span class="line">     Integer c = Integer.valueOf(<span class="number">1</span>);</span><br><span class="line">     Integer d = Integer.valueOf(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">     System.out.println(<span class="string">"c==d? "</span> + (c==d));</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a==b? false</span><br><span class="line">c==d? true</span><br></pre></td></tr></table></figure><p>valueOf() 方法的实现比较简单，就是先判断值是否在缓存池中，如果在的话就直接使用缓存池的内容。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> offset = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= -<span class="number">128</span> &amp;&amp; i &lt;= <span class="number">127</span>) &#123; <span class="comment">// must cache</span></span><br><span class="line">        <span class="keyword">return</span> IntegerCache.cache[i + offset];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Integer(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The following is the list of primitives stored as immutable objects:</p><ul><li>boolean values true and false</li><li>all byte values</li><li>short values between -128 and 127</li><li>int values between -128 and 127</li><li>char in the range \u0000 to \u007F</li></ul><p>自动装箱过程编译器会调用 valueOf() 方法，因此多个 Integer 对象使用装箱来创建并且值相同，那么就会引用相同的对象，这样做很显然是为了节省内存开销。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Integer x = <span class="number">1</span>;</span><br><span class="line">Integer y = <span class="number">1</span>;</span><br><span class="line">System.out.println(c==d); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://stackoverflow.com/questions/9030817/differences-between-new-integer123-integer-valueof123-and-just-123" target="_blank" rel="noopener">Differences between new Integer(123), Integer.valueOf(123) and just 123</a></p></blockquote><h2 id="2-switch"><a href="#2-switch" class="headerlink" title="2. switch"></a>2. switch</h2><p>A switch works with the byte, short, char, and int primitive data types. It also works with enumerated types (discussed in Classes and Inheritance) and a few special classes that “wrap” certain primitive types: Character, Byte, Short, and Integer (discussed in Simple Data Objects).</p><p>In the JDK 7 release, you can use a String object in the expression of a switch statement.</p><p>switch 不支持 long，是因为 swicth 的设计初衷是为那些只需要对少数几个值进行等值判断，如果值过于复杂，那么还是用 if 比较合适。</p><blockquote><p><a href="https://stackoverflow.com/questions/2676210/why-cant-your-switch-statement-data-type-be-long-java" target="_blank" rel="noopener">Why can’t your switch statement data type be long, Java?</a></p></blockquote><p>switch 使用查找表的方式来实现，JVM 中使用的指令是 lookupswitch。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">  Code:</span><br><span class="line">   Stack=<span class="number">1</span>, Locals=<span class="number">1</span>, Args_size=<span class="number">1</span></span><br><span class="line">   <span class="number">0</span>:   iconst_1</span><br><span class="line">   <span class="number">1</span>:   lookupswitch&#123; <span class="comment">//2</span></span><br><span class="line">                <span class="number">1</span>: <span class="number">28</span>;</span><br><span class="line">                <span class="number">2</span>: <span class="number">31</span>;</span><br><span class="line">                <span class="keyword">default</span>: <span class="number">31</span> &#125;</span><br><span class="line">   <span class="number">28</span>:  goto    <span class="number">31</span></span><br><span class="line">   <span class="number">31</span>:  <span class="keyword">return</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://stackoverflow.com/questions/12020048/how-does-javas-switch-work-under-the-hood" target="_blank" rel="noopener">How does Java’s switch work under the hood?</a></p></blockquote><h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><p>每个类都有一个  <strong>Class</strong>  对象，包含了与类有关的信息。当编译一个新类时，会产生一个同名的 .class 文件，该文件内容保存着 Class 对象。</p><p>类加载相当于 Class 对象的加载。类在第一次使用时才动态加载到 JVM 中，可以使用 Class.forName(‘com.mysql.jdbc.Driver.class’) 这种方式来控制类的加载，该方法会返回一个 Class 对象。</p><p>反射可以提供运行时的类信息，并且这个类可以在运行时才加载进来，甚至在编译时期该类的 .class 不存在也可以加载进来。</p><p>Class 和 java.lang.reflect 一起对反射提供了支持，java.lang.reflect 类库包含了  <strong>Field</strong> 、<strong>Method</strong> 以及 <strong>Constructor</strong> 类。可以使用 get() 和 set() 方法读取和修改 Field 对象关联的字段，可以使用 invoke() 方法调用与 Method 对象关联的方法，可以用 Constructor 创建新的对象。</p><p>IDE 使用反射机制获取类的信息，在使用一个类的对象时，能够把类的字段、方法和构造函数等信息列出来供用户选择。</p><p>更详细的内容：<a href="http://www.sczyh30.com/posts/Java/java-reflection-1/" target="_blank" rel="noopener"> 深入解析 Java 反射（1）- 基础 </a></p><h1 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h1><p>Throwable 可以用来表示任何可以作为异常抛出的类，分为两种： <strong>Error</strong>  和 <strong>Exception</strong>，其中 Error 用来表示编译时系统错误。</p><p>Exception 分为两种： <strong>受检异常</strong>  和 <strong>非受检异常</strong>。受检异常需要用 try…catch… 语句捕获并进行处理，并且可以从异常中恢复；非受检异常是程序运行时错误，例如除 0 会引发 Arithmetic Exception，此时程序奔溃并且无法恢复。</p><p><br><div align="center"> <img src="../pics/48f8f98e-8dfd-450d-8b5b-df4688f0d377.jpg"> </div><br></p><p>更详细的内容：</p><ul><li><a href="https://www.tianmaying.com/tutorial/Java-Exception" target="_blank" rel="noopener">Java 入门之异常处理 </a></li><li><a href="http://www.importnew.com/7383.html" target="_blank" rel="noopener">Java 异常的面试问题及答案 -Part 1</a></li></ul><h1 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h1><p>泛型提供了编译时的类型检测机制，该机制允许程序员在编译时检测到非法的类型。泛型是 Java 中一个非常重要的知识点，在 Java 集合类框架中泛型被广泛应用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// T stands for "Type"</span></span><br><span class="line">    <span class="keyword">private</span> T t;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T t)</span> </span>&#123; <span class="keyword">this</span>.t = t; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> t; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更详细的内容：</p><ul><li><a href="https://www.ziwenxie.site/2017/03/01/java-generic/" target="_blank" rel="noopener">Java 泛型详解 </a></li><li><a href="https://cloud.tencent.com/developer/article/1033693" target="_blank" rel="noopener">10 道 Java 泛型面试题 </a></li></ul><h1 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h1><h2 id="1-三大特性"><a href="#1-三大特性" class="headerlink" title="1. 三大特性"></a>1. 三大特性</h2><p><a href="https://github.com/CyC2018/InterviewNotes/blob/master/notes/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%80%9D%E6%83%B3.md#%E5%B0%81%E8%A3%85%E7%BB%A7%E6%89%BF%E5%A4%9A%E6%80%81" target="_blank" rel="noopener"> 封装、继承、多态 </a></p><h2 id="2-Java-各版本的新特性"><a href="#2-Java-各版本的新特性" class="headerlink" title="2. Java 各版本的新特性"></a>2. Java 各版本的新特性</h2><p>New highlights in Java SE 8</p><ol><li>Lambda Expressions</li><li>Pipelines and Streams</li><li>Date and Time API</li><li>Default Methods</li><li>Type Annotations</li><li>Nashhorn JavaScript Engine</li><li>Concurrent Accumulators</li><li>Parallel operations</li><li>PermGen Error Removed</li></ol><p>New highlights in Java SE 7</p><ol><li>Strings in Switch Statement</li><li>Type Inference for Generic Instance Creation</li><li>Multiple Exception Handling</li><li>Support for Dynamic Languages</li><li>Try with Resources</li><li>Java nio Package</li><li>Binary Literals, Underscore in literals</li><li>Diamond Syntax</li></ol><blockquote><p><a href="http://www.selfgrowth.com/articles/difference-between-java-18-and-java-17" target="_blank" rel="noopener">Difference between Java 1.8 and Java 1.7?</a></p></blockquote><p>更详细的内容：<a href="http://www.importnew.com/19345.html" target="_blank" rel="noopener">Java 8 特性 </a></p><h2 id="3-Java-与-C-的区别"><a href="#3-Java-与-C-的区别" class="headerlink" title="3. Java 与 C++ 的区别"></a>3. Java 与 C++ 的区别</h2><p>Java 是纯粹的面向对象语言，所有的对象都继承自 java.lang.Object，C++ 为了兼容 C 即支持面向对象也支持面向过程。</p><p>比较详细的内容：</p><table><thead><tr><th>Java</th><th>C++</th></tr></thead><tbody><tr><td>Java does not support pointers, templates, unions, operator overloading, structures etc. The Java language promoters initially said “No pointers!”, but when many programmers questioned how you can work without pointers, the promoters began saying “Restricted pointers.” Java supports what it calls “references”. References act a lot like pointers in C++ languages but you cannot perform arithmetic on pointers in Java. References have types, and they’re type-safe. These references cannot be interpreted as raw address and unsafe conversion is not allowed.</td><td>C++ supports structures, unions, templates, operator overloading, pointers and pointer arithmetic.</td></tr><tr><td>Java support automatic garbage collection. It does not support destructors as C++ does.</td><td>C++ support destructors, which is automatically invoked when the object is destroyed.</td></tr><tr><td>Java does not support conditional compilation and inclusion.</td><td>Conditional inclusion (#ifdef #ifndef type) is one of the main features of C++.</td></tr><tr><td>Java has built in support for threads. In Java, there is a <code>Thread</code> class that you inherit to create a new thread and override the <code>run()</code> method.</td><td>C++ has no built in support for threads. C++ relies on non-standard third-party libraries for thread support.</td></tr><tr><td>Java does not support default arguments. There is no scope resolution operator (::) in Java. The method definitions must always occur within a class, so there is no need for scope resolution there either.</td><td>C++ supports default arguments. C++ has scope resolution operator (::) which is used to to define a method outside a class and to access a global variable within from the scope where a local variable also exists with the same name.</td></tr><tr><td>There is no <em>goto</em> statement in Java. The keywords <code>const</code> and <code>goto</code> are reserved, even though they are not used.</td><td>C++ has <em>goto</em> statement. However, it is not considered good practice to use of <em>goto</em> statement.</td></tr><tr><td>Java doesn’t provide multiple inheritance, at least not in the same sense that C++ does.</td><td>C++ does support multiple inheritance. The keyword <code>virtual</code> is used to resolve ambiguities during multiple inheritance if there is any.</td></tr><tr><td>Exception handling in Java is different because there are no destructors. Also, in Java, try/catch must be defined if the function declares that it may throw an exception.</td><td>While in C++, you may not include the try/catch even if the function throws an exception.</td></tr><tr><td>Java has method overloading, but no operator overloading. The <code>String</code> class does use the <code>+</code> and <code>+=</code> operators to concatenate strings and <code>String</code>expressions use automatic type conversion, but that’s a special built-in case.</td><td>C++ supports both method overloading and operator overloading.</td></tr><tr><td>Java has built-in support for documentation comments (<code>/** ... */</code>); therefore, Java source files can contain their own documentation, which is read by a separate tool usually <code>javadoc</code> and reformatted into HTML. This helps keeping documentation maintained in easy way.</td><td>C++ does not support documentation comments.</td></tr><tr><td>Java is interpreted for the most part and hence platform independent.</td><td>C++ generates object code and the same code may not run on different platforms.</td></tr></tbody></table><blockquote><p><a href="http://cs-fundamentals.com/tech-interview/java/differences-between-java-and-cpp.php" target="_blank" rel="noopener">What are the main differences between Java and C++?</a></p></blockquote><h2 id="4-JRE-or-JDK"><a href="#4-JRE-or-JDK" class="headerlink" title="4. JRE or JDK"></a>4. JRE or JDK</h2><ul><li>JRE is the JVM program, Java application need to run on JRE.</li><li>JDK is a superset of JRE, JRE + tools for developing java programs. e.g, it provides the compiler “javac”</li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#关键字&quot;&gt;关键字&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-final&quot;&gt;1. final&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-static&quot;&gt;2. static&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#object-通用方法&quot;&gt;Object 通用方法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-概览&quot;&gt;1. 概览&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-clone&quot;&gt;2. clone()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-equals&quot;&gt;3. equals()&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#继承&quot;&gt;继承&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-访问权限&quot;&gt;1. 访问权限&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-抽象类与接口的区别&quot;&gt;2. 抽象类与接口的区别&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-super&quot;&gt;3. super()&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#string&quot;&gt;String&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-string,-stringbuffer-and-stringbuilder&quot;&gt;1. String, StringBuffer and StringBuilder&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-string-不可变的原因&quot;&gt;2. String 不可变的原因&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-stringintern&quot;&gt;3. String.intern()&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#基本类型与运算&quot;&gt;基本类型与运算&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-包装类型&quot;&gt;1. 包装类型&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-switch&quot;&gt;2. switch&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#反射&quot;&gt;反射&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#异常&quot;&gt;异常&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#泛型&quot;&gt;泛型&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#特性&quot;&gt;特性&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-三大特性&quot;&gt;1. 三大特性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-java-各版本的新特性&quot;&gt;2. Java 各版本的新特性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-java-与-c++-的区别&quot;&gt;3. Java 与 C++ 的区别&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-jre-or-jdk&quot;&gt;4. JRE or JDK&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;关键字&quot;&gt;&lt;a href=&quot;#关键字&quot; class=&quot;headerlink&quot; title=&quot;关键字&quot;&gt;&lt;/a&gt;关键字&lt;/h1&gt;&lt;h2 id=&quot;1-final&quot;&gt;&lt;a href=&quot;#1-final&quot; class=&quot;headerlink&quot; title=&quot;1. final&quot;&gt;&lt;/a&gt;1. final&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;数据&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;声明数据为常量，可以是编译时常量，也可以是在运行时被初始化后不能被改变的常量。&lt;/p&gt;
&lt;p&gt;对于基本类型，final 使数值不变；对于引用对象，final 使引用不变，也就不能引用其它对象，但是被引用的对象本身是可以修改的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;方法&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;声明方法不能被子类覆盖。&lt;/p&gt;
&lt;p&gt;private 方法隐式地被指定为 final，如果在子类中定义的方法和基类中的一个 private 方法签名相同，此时子类的方法不是覆盖基类方法，而是重载了。&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>算法</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E7%AE%97%E6%B3%95.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/算法.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T10:12:26.000Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#算法分析">算法分析</a><ul><li><a href="#1-函数转换">1. 函数转换</a></li><li><a href="#2-数学模型">2. 数学模型</a></li><li><a href="#3-threesum">3. ThreeSum</a></li><li><a href="#4-倍率实验">4. 倍率实验</a></li><li><a href="#5-注意事项">5. 注意事项</a></li></ul></li><li><a href="#排序">排序</a><ul><li><a href="#1-初级排序算法">1. 初级排序算法</a><ul><li><a href="#11-约定">1.1 约定</a></li><li><a href="#12-选择排序">1.2 选择排序</a></li><li><a href="#13-插入排序">1.3 插入排序</a></li><li><a href="#14-选择排序和插入排序的比较">1.4 选择排序和插入排序的比较</a></li><li><a href="#15-希尔排序">1.5 希尔排序</a></li></ul></li><li><a href="#2-归并排序">2 归并排序</a><ul><li><a href="#21-归并方法">2.1 归并方法</a></li><li><a href="#22-自顶向下归并排序">2.2 自顶向下归并排序</a></li><li><a href="#23-自底向上归并排序">2.3 自底向上归并排序</a></li></ul></li><li><a href="#3-快速排序">3. 快速排序</a><ul><li><a href="#31-基本算法">3.1 基本算法</a></li><li><a href="#32-切分">3.2 切分</a></li><li><a href="#33-性能分析">3.3 性能分析</a></li><li><a href="#34-算法改进">3.4 算法改进</a><ul><li><a href="#341-切换到插入排序">3.4.1 切换到插入排序</a></li><li><a href="#342-三取样">3.4.2 三取样</a></li><li><a href="#343-三向切分">3.4.3 三向切分</a></li></ul></li></ul></li><li><a href="#4-优先队列">4. 优先队列</a><ul><li><a href="#41-堆">4.1 堆</a></li><li><a href="#42-上浮和下沉">4.2 上浮和下沉</a></li><li><a href="#43-插入元素">4.3 插入元素</a></li><li><a href="#44-删除最大元素">4.4 删除最大元素</a></li><li><a href="#45-堆排序">4.5 堆排序</a></li><li><a href="#46-分析">4.6 分析</a></li></ul></li><li><a href="#5-应用">5. 应用</a><ul><li><a href="#51-排序算法的比较">5.1 排序算法的比较</a></li><li><a href="#52-java-的排序算法实现">5.2 Java 的排序算法实现</a></li><li><a href="#53-基于切分的快速选择算法">5.3 基于切分的快速选择算法</a></li></ul></li></ul></li><li><a href="#查找">查找</a><ul><li><a href="#1-符号表">1. 符号表</a><ul><li><a href="#11-无序符号表">1.1 无序符号表</a></li><li><a href="#12-有序符号表">1.2 有序符号表</a></li><li><a href="#13-二分查找实现有序符号表">1.3 二分查找实现有序符号表</a></li></ul></li><li><a href="#2-二叉查找树">2. 二叉查找树</a><ul><li><a href="#21-get">2.1 get()</a></li><li><a href="#22-put">2.2 put()</a></li><li><a href="#23-分析">2.3 分析</a></li><li><a href="#24-floor">2.4 floor()</a></li><li><a href="#25-rank">2.5 rank()</a></li><li><a href="#26-min">2.6 min()</a></li><li><a href="#27-deletemin">2.7 deleteMin()</a></li><li><a href="#28-delete">2.8 delete()</a></li><li><a href="#29-keys">2.9 keys()</a></li><li><a href="#210-性能分析">2.10 性能分析</a></li></ul></li><li><a href="#3-平衡查找树">3. 平衡查找树</a><ul><li><a href="#31-2-3-查找树">3.1 2-3 查找树</a><ul><li><a href="#311-插入操作">3.1.1 插入操作</a></li><li><a href="#312-性质">3.1.2 性质</a></li></ul></li><li><a href="#32-红黑二叉查找树">3.2 红黑二叉查找树</a><ul><li><a href="#321-左旋转">3.2.1 左旋转</a></li><li><a href="#322-右旋转">3.2.2 右旋转</a></li><li><a href="#323-颜色转换">3.2.3 颜色转换</a></li><li><a href="#324-插入">3.2.4 插入</a></li><li><a href="#325-删除最小键">3.2.5 删除最小键</a></li><li><a href="#326-分析">3.2.6 分析</a></li></ul></li></ul></li><li><a href="#4-散列表">4. 散列表</a><ul><li><a href="#41-散列函数">4.1 散列函数</a></li><li><a href="#42-基于拉链法的散列表">4.2 基于拉链法的散列表</a></li><li><a href="#43-基于线性探测法的散列表">4.3 基于线性探测法的散列表</a><ul><li><a href="#431-查找">4.3.1 查找</a></li><li><a href="#432-插入">4.3.2 插入</a></li><li><a href="#433-删除">4.3.3 删除</a></li><li><a href="#434-调整数组大小">4.3.4 调整数组大小</a></li></ul></li></ul></li><li><a href="#5-应用">5. 应用</a><ul><li><a href="#51-各种符号表实现的比较">5.1 各种符号表实现的比较</a></li><li><a href="#52-java-的符号表实现">5.2 Java 的符号表实现</a></li><li><a href="#53-集合类型">5.3 集合类型</a></li><li><a href="#54-稀疏向量乘法">5.4 稀疏向量乘法</a><!-- GFM-TOC --></li></ul></li></ul></li></ul><h1 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h1><h2 id="1-函数转换"><a href="#1-函数转换" class="headerlink" title="1. 函数转换"></a>1. 函数转换</h2><p>指数函数可以转换为线性函数，从而在函数图像上显示的更直观。</p><p>T(N)=aN<sup>3</sup> 转换为 lg(T(N))=3lgN+lga</p><p><br><div align="center"> <img src="/pics/5510045a-8f32-487f-a756-463e51a6dab0.png"> </div><br></p><h2 id="2-数学模型"><a href="#2-数学模型" class="headerlink" title="2. 数学模型"></a>2. 数学模型</h2><p><strong>近似</strong> </p><p>使用 ~f(N) 来表示所有随着 N 的增大除以 f(N) 的结果趋近于 1 的函数 , 例如 N<sup>3</sup>/6-N<sup>2</sup>/2+N/3 ~ N<sup>3</sup>/6。</p><a id="more"></a><p><br><div align="center"> <img src="/pics/ca3a793e-06e5-4ff3-b28e-a9c20540d164.png"> </div><br></p><p><strong>增长数量级</strong> </p><p>增长数量级将算法与它的实现隔离开来，一个算法的增长数量级为 N<sup>3</sup> 与它是否用 Java 实现，是否运行于特定计算机上无关。</p><p><br><div align="center"> <img src="/pics/1ea4dc9a-c4dd-46b5-bb11-49f98d57ded1.png"> </div><br></p><p><strong>内循环</strong> </p><p>执行最频繁的指令决定了程序执行的总时间，把这些指令称为程序的内循环。</p><p><strong>成本模型</strong> </p><p>使用成本模型来评估算法，例如数组的访问次数就是一种成本模型。</p><h2 id="3-ThreeSum"><a href="#3-ThreeSum" class="headerlink" title="3. ThreeSum"></a>3. ThreeSum</h2><p>ThreeSum 程序用于统计一个数组中三元组的和为 0 的数量。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreeSum</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">(<span class="keyword">int</span>[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; N; j++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = j + <span class="number">1</span>; k &lt; N; k++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (a[i] + a[j] + a[k] == <span class="number">0</span>) &#123;</span><br><span class="line">                        cnt++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该程序的内循环为 if (a[i] + a[j] + a[k] == 0) 语句，总共执行的次数为 N<sup>3</sup>/6-N<sup>2</sup>/2+N/3，因此它的近似执行次数为 ~N<sup>3</sup>/6，增长数量级为 N<sup>3</sup>。</p><p><strong>改进</strong> </p><p>通过将数组先排序，对两个元素求和，并用二分查找方法查找是否存在该和的相反数，如果存在，就说明存在三元组的和为 0。</p><p>该方法可以将 ThreeSum 算法增长数量级降低为 N<sup>2</sup>logN。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreeSumFast</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">(<span class="keyword">int</span>[] a)</span> </span>&#123;</span><br><span class="line">        Arrays.sort(a);</span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; N; j++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = j + <span class="number">1</span>; k &lt; N; k++) &#123;</span><br><span class="line">                    <span class="comment">// rank() 方法返回元素在数组中的下标，如果元素不存在，这里会返回 -1。应该注意这里的下标必须大于 j，这样就不会重复统计了。</span></span><br><span class="line">                    <span class="keyword">if</span> (BinarySearch.rank(-a[i] - a[j], a) &gt; j) &#123;</span><br><span class="line">                        cnt++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-倍率实验"><a href="#4-倍率实验" class="headerlink" title="4. 倍率实验"></a>4. 倍率实验</h2><p>如果 T(N) ~ aN<sup>b</sup>lgN，那么 T(2N)/T(N) ~ 2<sup>b</sup>，例如对于暴力方法的 ThreeSum 算法，近似时间为 ~N<sup>3</sup>/6，对它进行倍率实验得到如下结果：</p><p><br><div align="center"> <img src="/pics/6f5ed46f-86d7-4852-a34f-c1cf1b6343a0.png"> </div><br></p><p>可见 T(2N)/T(N)~2<sup>3</sup>，也就是 b 为 3。</p><h2 id="5-注意事项"><a href="#5-注意事项" class="headerlink" title="5. 注意事项"></a>5. 注意事项</h2><p><strong>大常数</strong> </p><p>在求近似时，如果低级项的常数系数很大，那么近似的结果就是错误的。</p><p><strong>缓存</strong> </p><p>计算机系统会使用缓存技术来组织内存，访问数组相邻的元素会比访问不相邻的元素快很多。</p><p><strong>对最坏情况下的性能的保证</strong> </p><p>在核反应堆、心脏起搏器或者刹车控制器中的软件，最坏情况下的性能是十分重要的。</p><p><strong>随机化算法</strong> </p><p>通过打乱输入，去除算法对输入的依赖。</p><p><strong>均摊分析</strong> </p><p>将所有操作的总成本所以操作总数来将成本均摊。例如对一个空栈进行 N 次连续的 push() 调用需要访问数组的元素为 N+4+8+16+…+2N=5N-4（N 是向数组写入元素，其余的都是调整数组大小时进行复制需要的访问数组操作），均摊后每次操作访问数组的平均次数为常数。</p><h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><h2 id="1-初级排序算法"><a href="#1-初级排序算法" class="headerlink" title="1. 初级排序算法"></a>1. 初级排序算法</h2><h3 id="1-1-约定"><a href="#1-1-约定" class="headerlink" title="1.1 约定"></a>1.1 约定</h3><p>待排序的元素需要实现 Java 的 Comparable 接口，该接口有 compareTo() 方法。</p><p>研究排序算法的成本模型时，计算的是比较和交换的次数。</p><p>使用辅助函数 less() 和 exch() 来进行比较和交换的操作，使得代码的可读性和可移植性更好。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">less</span><span class="params">(Comparable v, Comparable w)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v.compareTo(w) &lt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exch</span><span class="params">(Comparable[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">    Comparable t = a[i];</span><br><span class="line">    a[i] = a[j];</span><br><span class="line">    a[j] = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-选择排序"><a href="#1-2-选择排序" class="headerlink" title="1.2 选择排序"></a>1.2 选择排序</h3><p>找到数组中的最小元素，然后将它与数组的第一个元素交换位置。然后再从剩下的元素中找到最小的元素，将它与数组的第二个元素交换位置。不断进行这样的操作，直到将整个数组排序。</p><p><br><div align="center"> <img src="/pics/222768a7-914f-4d64-b874-d98f3b926fb6.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Selection</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> min = i;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; N; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (less(a[j], a[min])) min = j;</span><br><span class="line">            &#125;</span><br><span class="line">            exch(a, i, min);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>选择排序需要 ~N<sup>2</sup>/2 次比较和 ~N 次交换，它的运行时间与输入无关，这个特点使得它对一个已经排序的数组也需要这么多的比较和交换操作。</p><h3 id="1-3-插入排序"><a href="#1-3-插入排序" class="headerlink" title="1.3 插入排序"></a>1.3 插入排序</h3><p>将一个元素插入到已排序的数组中，使得插入之后的数组也是有序的。插入排序从左到右插入每个元素，每次插入之后左部的子数组是有序的。</p><p><br><div align="center"> <img src="/pics/065c3bbb-3ea0-4dbf-8f26-01d0e0ba7db7.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Insertion</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &gt; <span class="number">0</span> &amp;&amp; less(a[j], a[j - <span class="number">1</span>]); j--) &#123;</span><br><span class="line">                exch(a, j, j - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>插入排序的复杂度取决于数组的初始顺序，如果数组已经部分有序了，那么插入排序会很快。平均情况下插入排序需要 ~N<sup>2</sup>/4 比较以及 ~N<sup>2</sup>/4 次交换，最坏的情况下需要 ~N<sup>2</sup>/2 比较以及 ~N<sup>2</sup>/2 次交换，最坏的情况是数组是逆序的；而最好的情况下需要 N-1 次比较和 0 次交换，最好的情况就是数组已经有序了。</p><p>插入排序对于部分有序数组和小规模数组特别高效。</p><h3 id="1-4-选择排序和插入排序的比较"><a href="#1-4-选择排序和插入排序的比较" class="headerlink" title="1.4 选择排序和插入排序的比较"></a>1.4 选择排序和插入排序的比较</h3><p>对于随机排序的无重复主键的数组，插入排序和选择排序的运行时间是平方级别的，两者之比是一个较小的常数。</p><h3 id="1-5-希尔排序"><a href="#1-5-希尔排序" class="headerlink" title="1.5 希尔排序"></a>1.5 希尔排序</h3><p>对于大规模的数组，插入排序很慢，因为它只能交换相邻的元素，如果要把元素从一端移到另一端，就需要很多次操作。</p><p>希尔排序的出现就是为了改进插入排序的这种局限性，它通过交换不相邻的元素，使得元素更快的移到正确的位置上。</p><p>希尔排序使用插入排序对间隔 h 的序列进行排序，如果 h 很大，那么元素就能很快的移到很远的地方。通过不断减小 h，最后令 h=1，就可以使得整个数组是有序的。</p><p><br><div align="center"> <img src="/pics/8320bad6-3f91-4a15-8e3d-68e8f39649b5.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shell</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = a.length;</span><br><span class="line">        <span class="keyword">int</span> h = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (h &lt; N / <span class="number">3</span>) &#123;</span><br><span class="line">            h = <span class="number">3</span> * h + <span class="number">1</span>;<span class="comment">// 1, 4, 13, 40, ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (h &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = h; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &gt;= h &amp;&amp; less(a[j], a[j - h]); j -= h) &#123;</span><br><span class="line">                    exch(a, j, j - h);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            h = h / <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>希尔排序的运行时间达不到平方级别，使用递增序列 1, 4, 13, 40, … 的希尔排序所需要的比较次数不会超过 N 的若干倍乘于递增序列的长度。后面介绍的高级排序算法只会比希尔排序快两倍左右。</p><h2 id="2-归并排序"><a href="#2-归并排序" class="headerlink" title="2 归并排序"></a>2 归并排序</h2><p>归并排序的思想是将数组分成两部分，分别进行排序，然后归并起来。</p><p><br><div align="center"> <img src="/pics/dcf265ad-fe35-424d-b4b7-d149cdf239f4.png"> </div><br></p><h3 id="2-1-归并方法"><a href="#2-1-归并方法" class="headerlink" title="2.1 归并方法"></a>2.1 归并方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeSort</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Comparable[] aux;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> mid, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = lo, j = mid + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = lo; k &lt;= hi; k++) &#123;</span><br><span class="line">            aux[k] = a[k]; <span class="comment">// 将数据复制到辅助数组</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = lo; k &lt;= hi; k++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; mid) a[k] = aux[j++];</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (j &gt; hi) a[k] = aux[i++];</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (aux[i].compareTo(a[j]) &lt; <span class="number">0</span>) a[k] = aux[i++]; <span class="comment">// 先进行这一步，保证稳定性</span></span><br><span class="line">            <span class="keyword">else</span> a[k] = aux[j++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-自顶向下归并排序"><a href="#2-2-自顶向下归并排序" class="headerlink" title="2.2 自顶向下归并排序"></a>2.2 自顶向下归并排序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span> </span>&#123;</span><br><span class="line">    aux = <span class="keyword">new</span> Comparable[a.length];</span><br><span class="line">    sort(a, <span class="number">0</span>, a.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hi &lt;= lo) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = lo + (hi - lo) / <span class="number">2</span>;</span><br><span class="line">    sort(a, lo, mid);</span><br><span class="line">    sort(a, mid + <span class="number">1</span>, hi);</span><br><span class="line">    merge(a, lo, mid, hi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><div align="center"> <img src="/pics/6468a541-3a9a-4008-82b6-03a0fe941d2a.png"> </div><br></p><p><br><div align="center"> <img src="/pics/c7665f73-c52f-4ce4-aed3-592bbd76265b.png"> </div><br></p><p>很容易看出该排序算法的时间复杂度为 O(Nlg<sub>N</sub>)。</p><p>因为小数组的递归操作会过于频繁，因此使用插入排序来处理小数组将会获得更高的性能。</p><h3 id="2-3-自底向上归并排序"><a href="#2-3-自底向上归并排序" class="headerlink" title="2.3 自底向上归并排序"></a>2.3 自底向上归并排序</h3><p>先归并那些微型数组，然后成对归并得到的子数组。</p><p><br><div align="center"> <img src="/pics/c7b9b4c8-83d1-4eb0-8408-ea6576a9ed90.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">busort</span><span class="params">(Comparable[] a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N = a.length;</span><br><span class="line">    aux = <span class="keyword">new</span> Comparable[N];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> sz = <span class="number">1</span>; sz &lt; N; sz += sz) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> lo = <span class="number">0</span>; lo &lt; N - sz; lo += sz + sz) &#123;</span><br><span class="line">            merge(a, lo, lo + sz - <span class="number">1</span>, Math.min(lo + sz + sz - <span class="number">1</span>, N - <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-快速排序"><a href="#3-快速排序" class="headerlink" title="3. 快速排序"></a>3. 快速排序</h2><h3 id="3-1-基本算法"><a href="#3-1-基本算法" class="headerlink" title="3.1 基本算法"></a>3.1 基本算法</h3><p>归并排序将数组分为两个子数组分别排序，并将有序的子数组归并使得整个数组排序；快速排序通过一个切分元素将数组分为两个子数组，左子数组小于等于切分元素，右子数组大于等于切分元素，将这两个子数组排序也就将整个数组排序了。</p><p><br><div align="center"> <img src="/pics/61b4832d-71f3-413c-84b6-237e219b9fdc.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuickSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span> </span>&#123;</span><br><span class="line">        shuffle(a);</span><br><span class="line">        sort(a, <span class="number">0</span>, a.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hi &lt;= lo) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> j = partition(a, lo, hi);</span><br><span class="line">        sort(a, lo, j - <span class="number">1</span>);</span><br><span class="line">        sort(a, j + <span class="number">1</span>, hi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-切分"><a href="#3-2-切分" class="headerlink" title="3.2 切分"></a>3.2 切分</h3><p>取 a[lo] 作为切分元素，然后从数组的左端向右扫描直到找到第一个大于等于它的元素，再从数组的右端向左扫描找到第一个小于等于它的元素，交换这两个元素，并不断继续这个过程，就可以保证左指针的左侧元素都不大于切分元素，右指针 j 的右侧元素都不小于切分元素。当两个指针相遇时，将切分元素 a[lo] 和左子数组最右侧的元素 a[j] 交换然后返回 j 即可。</p><p><br><div align="center"> <img src="/pics/e198c201-f386-4491-8ad6-f7e433bf992d.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = lo, j = hi + <span class="number">1</span>;</span><br><span class="line">    Comparable v = a[lo];</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (less(a[++i], v)) <span class="keyword">if</span> (i == hi) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">while</span> (less(v, a[--j])) <span class="keyword">if</span> (j == lo) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= j) <span class="keyword">break</span>;</span><br><span class="line">        exch(a, i, j);</span><br><span class="line">    &#125;</span><br><span class="line">    exch(a, lo, j);</span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-性能分析"><a href="#3-3-性能分析" class="headerlink" title="3.3 性能分析"></a>3.3 性能分析</h3><p>快速排序是原地排序，不需要辅助数组，但是递归调用需要辅助栈。</p><p>快速排序最好的情况下是每次都正好能将数组对半分，这样递归调用次数才是最少的。这种情况下比较次数为 C<sub>N</sub>=2C<sub>N/2</sub>+N，也就是复杂度为 O(Nlg<sub>N</sub>)。</p><p>最坏的情况下，第一次从最小的元素切分，第二次从第二小的元素切分，如此这般。因此最坏的情况下需要比较 N<sup>2</sup>/2。为了防止数组最开始就是有序的，在进行快速排序时需要随机打乱数组。</p><h3 id="3-4-算法改进"><a href="#3-4-算法改进" class="headerlink" title="3.4 算法改进"></a>3.4 算法改进</h3><h4 id="3-4-1-切换到插入排序"><a href="#3-4-1-切换到插入排序" class="headerlink" title="3.4.1 切换到插入排序"></a>3.4.1 切换到插入排序</h4><p>因为快速排序在小数组中也会调用自己，对于小数组，插入排序比快速排序的性能更好，因此在小数组中可以切换到插入排序。</p><h4 id="3-4-2-三取样"><a href="#3-4-2-三取样" class="headerlink" title="3.4.2 三取样"></a>3.4.2 三取样</h4><p>最好的情况下是每次都能取数组的中位数作为切分元素，但是计算中位数的代价很高。人们发现取 3 个元素并将大小居中的元素作为切分元素的效果最好。</p><h4 id="3-4-3-三向切分"><a href="#3-4-3-三向切分" class="headerlink" title="3.4.3 三向切分"></a>3.4.3 三向切分</h4><p>对于有大量重复元素的数组，可以将数组切分为三部分，分别对应小于、等于和大于切分元素。</p><p>三向切分快速排序对于只有若干不同主键的随机数组可以在线性时间内完成排序。</p><p><br><div align="center"> <img src="/pics/9d2226dc-c4a3-40ec-9b3e-a46bf86af499.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quick3Way</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hi &lt;= lo) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> lt = lo, i = lo + <span class="number">1</span>, gt = hi;</span><br><span class="line">        Comparable v = a[lo];</span><br><span class="line">        <span class="keyword">while</span> (i &lt;= gt) &#123;</span><br><span class="line">            <span class="keyword">int</span> cmp = a[i].compareTo(v);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) exch(a, lt++, i++);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) exch(a, i, gt--);</span><br><span class="line">            <span class="keyword">else</span> i++;</span><br><span class="line">        &#125;</span><br><span class="line">        sort(a, lo, lt - <span class="number">1</span>);</span><br><span class="line">        sort(a, gt + <span class="number">1</span>, hi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-优先队列"><a href="#4-优先队列" class="headerlink" title="4. 优先队列"></a>4. 优先队列</h2><p>优先队列主要用于处理最大元素。</p><h3 id="4-1-堆"><a href="#4-1-堆" class="headerlink" title="4.1 堆"></a>4.1 堆</h3><p>定义：一颗二叉树的每个节点都大于等于它的两个子节点。</p><p>堆可以用数组来表示，因为堆是一种完全二叉树，而完全二叉树很容易就存储在数组中。位置 k 的节点的父节点位置为 k/2，而它的两个子节点的位置分别为 2k 和 2k+1。这里我们不使用数组索引为 0 的位置，是为了更清晰地理解节点的关系。</p><p><br><div align="center"> <img src="/pics/a9b6c1db-0f4a-4e91-8ac8-6b19bd106b51.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MaxPQ</span>&lt;<span class="title">Key</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Key</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Key[] pq;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> N = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MaxPQ</span><span class="params">(<span class="keyword">int</span> maxN)</span> </span>&#123;</span><br><span class="line">        pq = (Key[]) <span class="keyword">new</span> Comparable[maxN + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> N == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">less</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pq[i].compareTo(pq[j]) &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exch</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        Key t = pq[i];</span><br><span class="line">        pq[i] = pq[j];</span><br><span class="line">        pq[j] = t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-上浮和下沉"><a href="#4-2-上浮和下沉" class="headerlink" title="4.2 上浮和下沉"></a>4.2 上浮和下沉</h3><p>在堆中，当一个节点比父节点大，那么需要交换这个两个节点。交换后还可能比它新的父节点大，因此需要不断地进行比较和交换操作。把这种操作称为上浮。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swim</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">1</span> &amp;&amp; less(k / <span class="number">2</span>, k)) &#123;</span><br><span class="line">        exch(k / <span class="number">2</span>, k);</span><br><span class="line">        k = k / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类似地，当一个节点比子节点来得小，也需要不断的向下比较和交换操作，把这种操作称为下沉。一个节点有两个子节点，应当与两个子节点中最大那么节点进行交换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sink</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">2</span> * k &lt;= N) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">2</span> * k;</span><br><span class="line">        <span class="keyword">if</span> (j &lt; N &amp;&amp; less(j, j + <span class="number">1</span>)) j++;</span><br><span class="line">        <span class="keyword">if</span> (!less(k, j)) <span class="keyword">break</span>;</span><br><span class="line">        exch(k, j);</span><br><span class="line">        k = j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-插入元素"><a href="#4-3-插入元素" class="headerlink" title="4.3 插入元素"></a>4.3 插入元素</h3><p>将新元素放到数组末尾，然后上浮到合适的位置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Key v)</span> </span>&#123;</span><br><span class="line">    pq[++N] = v;</span><br><span class="line">    swim(N);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-删除最大元素"><a href="#4-4-删除最大元素" class="headerlink" title="4.4 删除最大元素"></a>4.4 删除最大元素</h3><p>从数组顶端删除最大的元素，并将数组的最后一个元素放到顶端，并让这个元素下沉到合适的位置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Key <span class="title">delMax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Key max = pq[<span class="number">1</span>];</span><br><span class="line">    exch(<span class="number">1</span>, N--);</span><br><span class="line">    pq[N + <span class="number">1</span>] = <span class="keyword">null</span>;</span><br><span class="line">    sink(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-5-堆排序"><a href="#4-5-堆排序" class="headerlink" title="4.5 堆排序"></a>4.5 堆排序</h3><p>由于堆可以很容易得到最大的元素并删除它，不断地进行这种操作可以得到一个递减序列。如果把最大元素和当前堆中数组的最后一个元素交换位置，并且不删除它，那么就可以得到一个从尾到头的递减序列，从正向来看就是一个递增序列。因此很容易使用堆来进行排序，并且堆排序是原地排序，不占用额外空间。</p><p>堆排序要分两个阶段，第一个阶段是把无序数组建立一个堆；第二个阶段是交换最大元素和当前堆的数组最后一个元素，并且进行下沉操作维持堆的有序状态。</p><p>无序数组建立堆最直接的方法是从左到右遍历数组，然后进行上浮操作。一个更高效的方法是从右至左进行下沉操作，如果一个节点的两个节点都已经是堆有序，那么进行下沉操作可以使得这个节点为根节点的堆有序。叶子节点不需要进行下沉操作，因此可以忽略叶子节点的元素，因此只需要遍历一半的元素即可。</p><p><br><div align="center"> <img src="/pics/a2670745-a7b1-497b-90a4-dbddc4e2006d.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N = a.length;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> k = N/<span class="number">2</span>; k &gt;= <span class="number">1</span>; k--)&#123;</span><br><span class="line">        sink(a, k, N);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(N &gt; <span class="number">1</span>)&#123;</span><br><span class="line">        exch(a, <span class="number">1</span>, N--);</span><br><span class="line">        sink(a, <span class="number">1</span>, N);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-6-分析"><a href="#4-6-分析" class="headerlink" title="4.6 分析"></a>4.6 分析</h3><p>一个堆的高度为 lgN，因此在堆中插入元素和删除最大元素的复杂度都为 lgN。</p><p>对于堆排序，由于要对 N 个节点进行下沉操作，因此复杂度为 NlgN。</p><p>堆排序时一种原地排序，没有利用额外的空间。</p><p>现代操作系统很少使用堆排序，因为它无法利用缓存，也就是数组元素很少和相邻的元素进行比较。</p><h2 id="5-应用"><a href="#5-应用" class="headerlink" title="5. 应用"></a>5. 应用</h2><h3 id="5-1-排序算法的比较"><a href="#5-1-排序算法的比较" class="headerlink" title="5.1 排序算法的比较"></a>5.1 排序算法的比较</h3><p><br><div align="center"> <img src="/pics/be53c00b-2534-4dc6-ad03-c55995c47db9.jpg"> </div><br></p><p>快速排序时最快的通用排序算法，它的内循环的指令很少，而且它还能利用缓存，因为它总是顺序地访问数据。它的运行时间增长数量级为 ~cNlgN，这里的 c 比其他线性对数级别的排序算法都要小。使用三向切分之后，实际应用中可能出现的某些分布的输入能够达到线性级别，而其它排序算法仍然需要线性对数时间。</p><h3 id="5-2-Java-的排序算法实现"><a href="#5-2-Java-的排序算法实现" class="headerlink" title="5.2 Java 的排序算法实现"></a>5.2 Java 的排序算法实现</h3><p>Java 系统库中的主要排序方法为 java.util.Arrays.sort()，对于原始数据类型使用三向切分的快速排序，对于引用类型使用归并排序。</p><h3 id="5-3-基于切分的快速选择算法"><a href="#5-3-基于切分的快速选择算法" class="headerlink" title="5.3 基于切分的快速选择算法"></a>5.3 基于切分的快速选择算法</h3><p>快速排序的 partition() 方法，会将数组的 a[lo] 至 a[hi] 重新排序并返回一个整数 j 使得 a[lo..j-1] 小于等于 a[j]，且 a[j+1..hi] 大于等于 a[j]。那么如果 j=k，a[j] 就是第 k 个数。</p><p>该算法是线性级别的，因为每次正好将数组二分，那么比较的总次数为 (N+N/2+N/4+..)，直到找到第 k 个元素，这个和显然小于 2N。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Comparable <span class="title">select</span><span class="params">(Comparable[] a, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lo = <span class="number">0</span>, hi = a.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (hi &gt; lo) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = partion(a, lo, hi);</span><br><span class="line">        <span class="keyword">if</span> (j == k) <span class="keyword">return</span> a[k];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (j &gt; k) hi = j - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> lo = j + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a[k];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h1><p>本章使用三种经典的数据类型来实现高效的符号表：二叉查找树、红黑树和散列表。</p><h2 id="1-符号表"><a href="#1-符号表" class="headerlink" title="1. 符号表"></a>1. 符号表</h2><h3 id="1-1-无序符号表"><a href="#1-1-无序符号表" class="headerlink" title="1.1 无序符号表"></a>1.1 无序符号表</h3><p><br><div align="center"> <img src="/pics/b69d7184-ab62-4957-ba29-fb4fa25f9b65.jpg"> </div><br></p><h3 id="1-2-有序符号表"><a href="#1-2-有序符号表" class="headerlink" title="1.2 有序符号表"></a>1.2 有序符号表</h3><p><br><div align="center"> <img src="/pics/ba6ae411-82da-4d86-a434-6776d1731e8e.jpg"> </div><br></p><p>有序符号表的键需要实现 Comparable 接口。</p><p>查找的成本模型：键的比较次数，在不进行比较时使用数组的访问次数。</p><h3 id="1-3-二分查找实现有序符号表"><a href="#1-3-二分查找实现有序符号表" class="headerlink" title="1.3 二分查找实现有序符号表"></a>1.3 二分查找实现有序符号表</h3><p>使用一对平行数组，一个存储键一个存储值。</p><p>需要创建一个 Key 类型的 Comparable 对象数组和一个 Value 类型的 Object 对象数组。</p><p>rank() 方法至关重要，当键在表中时，它能够知道该键的位置；当键不在表中时，它也能知道在何处插入新键。</p><p>复杂度：二分查找最多需要 lgN+1 次比较，使用二分查找实现的符号表的查找操作所需要的时间最多是对数级别的。但是插入操作需要移动数组元素，是线性级别的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinarySearchST</span>&lt;<span class="title">Key</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Key</span>&gt;, <span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Key[] keys;</span><br><span class="line">    <span class="keyword">private</span> Value[] values;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> N;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BinarySearchST</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        keys = (Key[]) <span class="keyword">new</span> Comparable[capacity];</span><br><span class="line">        values = (Value[]) <span class="keyword">new</span> Object[capacity];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Value <span class="title">get</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = rank(key);</span><br><span class="line">        <span class="keyword">if</span> (i &lt; N &amp;&amp; keys[i].compareTo(key) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> values[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rank</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lo = <span class="number">0</span>, hi = N - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (lo &lt;= hi) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = lo + (hi - lo) / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> cmp = key.compareTo(keys[mid]);</span><br><span class="line">            <span class="keyword">if</span> (cmp == <span class="number">0</span>) <span class="keyword">return</span> mid;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) hi = mid - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> lo = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Key key, Value value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = rank(key);</span><br><span class="line">        <span class="keyword">if</span> (i &lt; N &amp;&amp; keys[i].compareTo(key) == <span class="number">0</span>) &#123;</span><br><span class="line">            values[i] = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = N; j &gt; i; j--) &#123;</span><br><span class="line">            keys[j] = keys[j - <span class="number">1</span>];</span><br><span class="line">            values[j] = values[j - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        keys[i] = key;</span><br><span class="line">        values[i] = value;</span><br><span class="line">        N++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Key <span class="title">ceiling</span><span class="params">(Key key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = rank(key);</span><br><span class="line">        <span class="keyword">return</span> keys[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-二叉查找树"><a href="#2-二叉查找树" class="headerlink" title="2. 二叉查找树"></a>2. 二叉查找树</h2><p><strong>二叉树</strong>  定义为一个空链接，或者是一个有左右两个链接的节点，每个链接都指向一颗子二叉树。</p><p><strong>二叉查找树</strong> （BST）是一颗二叉树，并且每个节点的键都大于其左子树中的任意节点的键而小于右子树的任意节点的键。</p><p><br><div align="center"> <img src="/pics/25226bb2-92cc-40cb-9e7f-c44e79fbb64a.jpg"> </div><br></p><p>二叉查找树的查找操作每次迭代都会让区间减少一半，和二分查找类似。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BST</span>&lt;<span class="title">Key</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Key</span>&gt;, <span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Key key;</span><br><span class="line">        <span class="keyword">private</span> Value val;</span><br><span class="line">        <span class="keyword">private</span> Node left, right;</span><br><span class="line">        <span class="comment">// 以该节点为根的子树中节点总数</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> N;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(Key key, Value val, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">            <span class="keyword">this</span>.N = N;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> x.N;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-1-get"><a href="#2-1-get" class="headerlink" title="2.1 get()"></a>2.1 get()</h3><p>如果树是空的，则查找未命中；如果被查找的键和根节点的键相等，查找命中，否则递归地在子树中查找：如果被查找的键较小就在左子树中查找，较大就在右子树中查找。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Value <span class="title">get</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get(root, key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Value <span class="title">get</span><span class="params">(Node x, Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmp == <span class="number">0</span>) <span class="keyword">return</span> x.val;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) <span class="keyword">return</span> get(x.left, key);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> get(x.right, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-put"><a href="#2-2-put" class="headerlink" title="2.2 put()"></a>2.2 put()</h3><p>当插入的键不存在于树中，需要创建一个新节点，并且更新上层节点的链接使得该节点正确链接到树中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Key key, Value val)</span> </span>&#123;</span><br><span class="line">    root = put(root, key, val);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">put</span><span class="params">(Node x, Key key, Value val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> Node(key, val, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmp == <span class="number">0</span>) x.val = val;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) x.left = put(x.left, key, val);</span><br><span class="line">    <span class="keyword">else</span> x.right = put(x.right, key, val);</span><br><span class="line">    x.N = size(x.left) + size(x.right) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-分析"><a href="#2-3-分析" class="headerlink" title="2.3 分析"></a>2.3 分析</h3><p>二叉查找树的算法运行时间取决于树的形状，而树的形状又取决于键被插入的先后顺序。最好的情况下树是完全平衡的，每条空链接和根节点的距离都为 lgN。在最坏的情况下，树的高度为 N。</p><p><br><div align="center"> <img src="/pics/73a3983d-dd18-4373-897e-64b706a7e370.jpg"> </div><br></p><p>复杂度：查找和插入操作都为对数级别。</p><h3 id="2-4-floor"><a href="#2-4-floor" class="headerlink" title="2.4 floor()"></a>2.4 floor()</h3><p>如果 key 小于根节点的 key，那么小于等于 key 的最大键节点一定在左子树中；如果 key 大于根节点的 key，只有当根节点右子树中存在小于等于 key 的节点，小于等于 key 的最大键节点才在右子树中，否则根节点就是小于等于 key 的最大键节点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Key <span class="title">floor</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">    Node x = floor(root, key);</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> x.key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">floor</span><span class="params">(Node x, Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmp == <span class="number">0</span>) <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) <span class="keyword">return</span> floor(x.left, key);</span><br><span class="line">    Node t = floor(x.right, key);</span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-rank"><a href="#2-5-rank" class="headerlink" title="2.5 rank()"></a>2.5 rank()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rank</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rank(key, root);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">rank</span><span class="params">(Key key, Node x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmp == <span class="number">0</span>) <span class="keyword">return</span> size(x.left);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) <span class="keyword">return</span> rank(key, x.left);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">1</span> + size(x.left) + rank(key, x.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-6-min"><a href="#2-6-min" class="headerlink" title="2.6 min()"></a>2.6 min()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">min</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x.left == <span class="keyword">null</span>) <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">return</span> min(x.left);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-7-deleteMin"><a href="#2-7-deleteMin" class="headerlink" title="2.7 deleteMin()"></a>2.7 deleteMin()</h3><p>令指向最小节点的链接指向最小节点的右子树。</p><p><br><div align="center"> <img src="/pics/6e2cb20a-8d2a-46fe-9ac7-68a2126b7bd5.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteMin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    root = deleteMin(root);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">deleteMin</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x.left == <span class="keyword">null</span>) <span class="keyword">return</span> x.right;</span><br><span class="line">    x.left = deleteMin(x.left);</span><br><span class="line">    x.N = size(x.left) + size(x.right) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-8-delete"><a href="#2-8-delete" class="headerlink" title="2.8 delete()"></a>2.8 delete()</h3><p>如果待删除的节点只有一个子树，那么只需要让指向待删除节点的链接指向唯一的子树即可；否则，让右子树的最小节点替换该节点。</p><p><br><div align="center"> <img src="/pics/b488282d-bfe0-464f-9e91-1f5b83a975bd.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">    root = delete(root, key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">delete</span><span class="params">(Node x, Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) x.left = delete(x.left, key);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) x.right = delete(x.right, key);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.right == <span class="keyword">null</span>) <span class="keyword">return</span> x.left;</span><br><span class="line">        <span class="keyword">if</span> (x.left == <span class="keyword">null</span>) <span class="keyword">return</span> x.right;</span><br><span class="line">        Node t = x;</span><br><span class="line">        x = min(t.right);</span><br><span class="line">        x.right = deleteMin(t.right);</span><br><span class="line">        x.left = t.left;</span><br><span class="line">    &#125;</span><br><span class="line">    x.N = size(x.left) + size(x.right) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-9-keys"><a href="#2-9-keys" class="headerlink" title="2.9 keys()"></a>2.9 keys()</h3><p>利用二叉查找树中序遍历的结果为有序序列的特点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;Key&gt; <span class="title">keys</span><span class="params">(Key lo, Key hi)</span> </span>&#123;</span><br><span class="line">    Queue&lt;Key&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    keys(root, queue, lo, hi);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">keys</span><span class="params">(Node x, Queue&lt;Key&gt; queue, Key lo, Key hi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> cmpLo = lo.compareTo(x.key);</span><br><span class="line">    <span class="keyword">int</span> cmpHi = hi.compareTo(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmpLo &lt; <span class="number">0</span>) keys(x.left, queue, lo, hi);</span><br><span class="line">    <span class="keyword">if</span> (cmpLo &lt;= <span class="number">0</span> &amp;&amp; cmpHi &gt;= <span class="number">0</span>) queue.add(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmpHi &gt; <span class="number">0</span>) keys(x.right, queue, lo, hi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-10-性能分析"><a href="#2-10-性能分析" class="headerlink" title="2.10 性能分析"></a>2.10 性能分析</h3><p>复杂度：二叉查找树所有操作在最坏的情况下所需要的时间都和树的高度成正比。</p><h2 id="3-平衡查找树"><a href="#3-平衡查找树" class="headerlink" title="3. 平衡查找树"></a>3. 平衡查找树</h2><h3 id="3-1-2-3-查找树"><a href="#3-1-2-3-查找树" class="headerlink" title="3.1 2-3 查找树"></a>3.1 2-3 查找树</h3><p><br><div align="center"> <img src="/pics/2548f2ec-7b00-4ec7-b286-20fc3022e084.jpg"> </div><br></p><p>一颗完美平衡的 2-3 查找树的所有空链接到根节点的距离应该是相同的。</p><h4 id="3-1-1-插入操作"><a href="#3-1-1-插入操作" class="headerlink" title="3.1.1 插入操作"></a>3.1.1 插入操作</h4><p>当插入之后产生一个临时 4- 节点时，需要将 4- 节点分裂成 3 个 2- 节点，并将中间的 2- 节点移到上层节点中。如果上移操作继续产生临时 4- 节点则一直进行分裂上移，直到不存在临时 4- 节点。</p><p><br><div align="center"> <img src="/pics/912174d8-0786-4222-b7ef-a611d36e5db9.jpg"> </div><br></p><h4 id="3-1-2-性质"><a href="#3-1-2-性质" class="headerlink" title="3.1.2 性质"></a>3.1.2 性质</h4><p>2-3 查找树插入操作的变换都是局部的，除了相关的节点和链接之外不必修改或者检查树的其它部分，而这些局部变换不会影响树的全局有序性和平衡性。</p><p>2-3 查找树的查找和插入操作复杂度和插入顺序  <strong>无关</strong> ，在最坏的情况下查找和插入操作访问的节点必然不超过 logN 个，含有 10 亿个节点的 2-3 查找树最多只需要访问 30 个节点就能进行任意的查找和插入操作。</p><h3 id="3-2-红黑二叉查找树"><a href="#3-2-红黑二叉查找树" class="headerlink" title="3.2 红黑二叉查找树"></a>3.2 红黑二叉查找树</h3><p>2-3 查找树需要用到 2- 节点和 3- 节点，红黑树使用红链接来实现 3- 节点。指向一个节点的链接颜色如果为红色，那么这个节点和上层节点表示的是一个 3- 节点，而黑色则是普通链接。</p><p><br><div align="center"> <img src="/pics/7080a928-06ba-4e10-9792-b8dd190dc8e2.jpg"> </div><br></p><p>红黑树具有以下性质：</p><ol><li>红链接都为左链接；</li><li>完美黑色平衡，即任意空链接到根节点的路径上的黑链接数量相同。</li></ol><p>画红黑树时可以将红链接画平。</p><p><br><div align="center"> <img src="/pics/62077f5d-a06d-4129-9b43-78715b82cb03.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedBlackBST</span>&lt;<span class="title">Key</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Key</span>&gt;, <span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> RED = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> BLACK = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        Key key;</span><br><span class="line">        Value val;</span><br><span class="line">        Node left, right;</span><br><span class="line">        <span class="keyword">int</span> N;</span><br><span class="line">        <span class="keyword">boolean</span> color;</span><br><span class="line"></span><br><span class="line">        Node(Key key, Value val, <span class="keyword">int</span> n, <span class="keyword">boolean</span> color) &#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">            N = n;</span><br><span class="line">            <span class="keyword">this</span>.color = color;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRed</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> x.color == RED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-1-左旋转"><a href="#3-2-1-左旋转" class="headerlink" title="3.2.1 左旋转"></a>3.2.1 左旋转</h4><p>因为合法的红链接都为左链接，如果出现右链接为红链接，那么就需要进行左旋转操作。</p><p><br><div align="center"> <img src="/pics/33a4e822-2dd0-481e-ac89-7f6161034402.jpg"> </div><br></p><p><br><div align="center"> <img src="/pics/5e0cef33-4087-4f21-a428-16d5fddda671.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">rotateLeft</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">    Node x = h.right;</span><br><span class="line">    h.right = x.left;</span><br><span class="line">    x.left = h;</span><br><span class="line">    x.color = h.color;</span><br><span class="line">    h.color = RED;</span><br><span class="line">    x.N = h.N;</span><br><span class="line">    h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-2-右旋转"><a href="#3-2-2-右旋转" class="headerlink" title="3.2.2 右旋转"></a>3.2.2 右旋转</h4><p>进行右旋转是为了转换两个连续的左红链接，这会在之后的插入过程中探讨。</p><p><br><div align="center"> <img src="/pics/dfd078b2-aa4f-4c50-8319-232922d822b8.jpg"> </div><br></p><p><br><div align="center"> <img src="/pics/3f8d8c9d-a9a9-4d7a-813c-2de05ee5a97e.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">rotateRight</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">    Node x = h.left;</span><br><span class="line">    h.left = x.right;</span><br><span class="line">    x.color = h.color;</span><br><span class="line">    h.color = RED;</span><br><span class="line">    x.N = h.N;</span><br><span class="line">    h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-3-颜色转换"><a href="#3-2-3-颜色转换" class="headerlink" title="3.2.3 颜色转换"></a>3.2.3 颜色转换</h4><p>一个 4- 节点在红黑树中表现为一个节点的左右子节点都是红色的。分裂 4- 节点除了需要将子节点的颜色由红变黑之外，同时需要将父节点的颜色由黑变红，从 2-3 树的角度看就是将中间节点移到上层节点。</p><p><br><div align="center"> <img src="/pics/de7c5a31-55f5-4e9d-92ec-4ed5b2ec3828.jpg"> </div><br></p><p><br><div align="center"> <img src="/pics/e5ad625e-729d-4a8d-923a-7c3df5773e1c.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">flipColors</span><span class="params">(Node h)</span></span>&#123;</span><br><span class="line">    h.color = RED;</span><br><span class="line">    h.left.color = BLACK;</span><br><span class="line">    h.right.color = BLACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-4-插入"><a href="#3-2-4-插入" class="headerlink" title="3.2.4 插入"></a>3.2.4 插入</h4><p>先将一个节点按二叉查找树的方法插入到正确位置，然后再进行如下颜色操作：</p><ul><li>如果右子节点是红色的而左子节点是黑色的，进行左旋转；</li><li>如果左子节点是红色的且它的左子节点也是红色的，进行右旋转；</li><li>如果左右子节点均为红色的，进行颜色转换。</li></ul><p><br><div align="center"> <img src="/pics/40639782-5df2-4e96-a4f3-f9dd664d0ca1.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Key key, Value val)</span> </span>&#123;</span><br><span class="line">    root = put(root, key, val);</span><br><span class="line">    root.color = BLACK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">put</span><span class="params">(Node x, Key key, Value val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> Node(key, val, <span class="number">1</span>, RED);</span><br><span class="line">    <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">    <span class="keyword">if</span> (cmp == <span class="number">0</span>) x.val = val;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) x.left = put(x.left, key, val);</span><br><span class="line">    <span class="keyword">else</span> x.right = put(x.right, key, val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isRed(x.right) &amp;&amp; !isRed(x.left)) x = rotateLeft(x);</span><br><span class="line">    <span class="keyword">if</span> (isRed(x.left) &amp;&amp; isRed(x.left.left)) x = rotateRight(x);</span><br><span class="line">    <span class="keyword">if</span> (isRed(x.left) &amp;&amp; isRed(x.right)) flipColors(x);</span><br><span class="line"></span><br><span class="line">    x.N = size(x.left) + size(x.right) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到该插入操作和 BST 的插入操作类似，只是在最后加入了旋转和颜色变换操作即可。</p><p>根节点一定为黑色，因为根节点没有上层节点，也就没有上层节点的左链接指向根节点。flipColors() 有可能会使得根节点的颜色变为红色，每当根节点由红色变成黑色时树的黑链接高度加 1.</p><h4 id="3-2-5-删除最小键"><a href="#3-2-5-删除最小键" class="headerlink" title="3.2.5 删除最小键"></a>3.2.5 删除最小键</h4><p>如果最小键在一个 2- 节点中，那么删除该键会留下一个空链接，就破坏了平衡性，因此要确保最小键不在 2- 节点中。将 2- 节点转换成 3- 节点或者 4- 节点有两种方法，一种是向上层节点拿一个 key，一种是向兄弟节点拿一个 key。如果上层节点是 2- 节点，那么就没办法从上层节点拿 key 了，因此要保证删除路径上的所有节点都不是 2- 节点。在向下删除的过程中，保证以下情况之一发生：</p><ol><li>如果当前节点的左子节点不是 2- 节点，完成；</li><li>如果当前节点的左子节点是 2- 节点而它的兄弟节点不是 2- 节点，向兄弟节点拿一个 key 过来；</li><li>如果当前节点的左子节点和它的兄弟节点都是 2- 节点，将左子节点、父节点中的最小键和最近的兄弟节点合并为一个 4- 节点。</li></ol><p><br><div align="center"> <img src="/pics/b001fa64-307c-49af-b4b2-2043fc26154e.png"> </div><br></p><p>最后得到一个含有最小键的 3- 节点或者 4- 节点，直接从中删除。然后再从头分解所有临时的 4- 节点。</p><p><br><div align="center"> <img src="/pics/70b66757-755c-4e17-a7b7-5ce808023643.png"> </div><br></p><h4 id="3-2-6-分析"><a href="#3-2-6-分析" class="headerlink" title="3.2.6 分析"></a>3.2.6 分析</h4><p>一颗大小为 N 的红黑树的高度不会超过 2lgN。最坏的情况下是它所对应的 2-3 树中构成最左边的路径节点全部都是 3- 节点而其余都是 2- 节点。</p><p>红黑树大多数的操作所需要的时间都是对数级别的。</p><h2 id="4-散列表"><a href="#4-散列表" class="headerlink" title="4. 散列表"></a>4. 散列表</h2><p>散列表类似于数组，可以把散列表的散列值看成数组的索引值。访问散列表和访问数组元素一样快速，它可以在常数时间内实现查找和插入的符号表。</p><p>由于无法通过散列值知道键的大小关系，因此散列表无法实现有序性操作。</p><h3 id="4-1-散列函数"><a href="#4-1-散列函数" class="headerlink" title="4.1 散列函数"></a>4.1 散列函数</h3><p>对于一个大小为 M 的散列表，散列函数能够把任意键转换为 [0, M-1] 内的正整数，该正整数即为 hash 值。</p><p>散列表有冲突的存在，也就是两个不同的键可能有相同的 hash 值。</p><p>散列函数应该满足以下三个条件：</p><ol><li>一致性：相等的键应当有相等的 hash 值。</li><li>高效性：计算应当简便，有必要的话可以把 hash 值缓存起来，在调用 hash 函数时直接返回。</li><li>均匀性：所有键的 hash 值应当均匀地分布到 [0, M-1] 之间，这个条件至关重要，直接影响到散列表的性能。</li></ol><p>除留余数法可以将整数散列到 [0, M-1] 之间，例如一个正整数 k，计算 k%M 既可得到一个 [0, M-1] 之间的 hash 值。注意 M 必须是一个素数，否则无法利用键包含的所有信息。例如 M 为 10<sup>k</sup>，那么只能利用键的后 k 位。</p><p>对于其它数，可以将其转换成整数的形式，然后利用除留余数法。例如对于浮点数，可以将其表示成二进制形式，然后使用二进制形式的整数值进行除留余数法。</p><p>对于有多部分组合的键，每部分都需要计算 hash 值，并且最后合并时需要让每部分 hash 值都具有同等重要的地位。可以将该键看成 R 进制的整数，键中每部分都具有不同的权值。</p><p>例如，字符串的散列函数实现如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> hash = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++)</span><br><span class="line">    hash = (R * hash + s.charAt(i)) % M;</span><br></pre></td></tr></table></figure><p>再比如，拥有多个成员的自定义类的哈希函数如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> hash = (((day * R + month) % M) * R + year) % M;</span><br></pre></td></tr></table></figure><p>R 的值不是很重要，通常取 31。</p><p>Java 中的 hashCode() 实现了 hash 函数，但是默认使用对象的内存地址值。在使用 hashCode() 函数时，应当结合除留余数法来使用。因为内存地址是 32 位整数，我们只需要 31 位的非负整数，因此应当屏蔽符号位之后再使用除留余数法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> hash = (x.hashCode() &amp; <span class="number">0x7fffffff</span>) % M;</span><br></pre></td></tr></table></figure><p>使用 Java 自带的 HashMap 等自带的哈希表实现时，只需要去实现 Key 类型的 hashCode() 函数即可。Java 规定 hashCode() 能够将键均匀分布于所有的 32 位整数，Java 中的 String、Integer 等对象的 hashCode() 都能实现这一点。以下展示了自定义类型如何实现 hashCode()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String who;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date when;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> amount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hash = <span class="number">17</span>;</span><br><span class="line">        hash = <span class="number">31</span> * hash + who.hashCode();</span><br><span class="line">        hash = <span class="number">31</span> * hash + when.hashCode();</span><br><span class="line">        hash = <span class="number">31</span> * hash + ((Double) amount).hashCode();</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-基于拉链法的散列表"><a href="#4-2-基于拉链法的散列表" class="headerlink" title="4.2 基于拉链法的散列表"></a>4.2 基于拉链法的散列表</h3><p>拉链法使用链表来存储 hash 值相同的键，从而解决冲突。此时查找需要分两步，首先查找 Key 所在的链表，然后在链表中顺序查找。</p><p><br><div align="center"> <img src="/pics/540133af-aaaf-4208-8f7f-33cb89ac9621.png"> </div><br></p><p>对于 N 个键，M 条链表 (N&gt;M)，如果哈希函数能够满足均匀性的条件，每条链表的大小趋向于 N/M，因此未命中的查找和插入操作所需要的比较次数为 ~N/M。</p><h3 id="4-3-基于线性探测法的散列表"><a href="#4-3-基于线性探测法的散列表" class="headerlink" title="4.3 基于线性探测法的散列表"></a>4.3 基于线性探测法的散列表</h3><p>线性探测法使用空位来解决冲突，当冲突发生时，向前探测一个空位来存储冲突的键。使用线程探测法，数组的大小 M 应当大于键的个数 N（M&gt;N)。</p><p><br><div align="center"> <img src="/pics/2b3410f1-9559-4dd1-bc3d-e3e572247be2.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinearProbingHashST</span>&lt;<span class="title">Key</span>, <span class="title">Value</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> N;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> M = <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">private</span> Key[] keys;</span><br><span class="line">    <span class="keyword">private</span> Value[] vals;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinearProbingHashST</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinearProbingHashST</span><span class="params">(<span class="keyword">int</span> M)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.M = M;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        keys = (Key[]) <span class="keyword">new</span> Object[M];</span><br><span class="line">        vals = (Value[]) <span class="keyword">new</span> Object[M];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (key.hashCode() &amp; <span class="number">0x7fffffff</span>) % M;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-1-查找"><a href="#4-3-1-查找" class="headerlink" title="4.3.1 查找"></a>4.3.1 查找</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Value <span class="title">get</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = hash(key); keys[i] != <span class="keyword">null</span>; i = (i + <span class="number">1</span>) % M) &#123;</span><br><span class="line">        <span class="keyword">if</span> (keys[i].equals(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> vals[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-2-插入"><a href="#4-3-2-插入" class="headerlink" title="4.3.2 插入"></a>4.3.2 插入</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Key key, Value val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = hash(key); keys[i] != <span class="keyword">null</span>; i = (i + <span class="number">1</span>) % M) &#123;</span><br><span class="line">        <span class="keyword">if</span> (keys[i].equals(key)) &#123;</span><br><span class="line">            vals[i] = val;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    keys[i] = key;</span><br><span class="line">    vals[i] = val;</span><br><span class="line">    N++;</span><br><span class="line">    resize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-3-删除"><a href="#4-3-3-删除" class="headerlink" title="4.3.3 删除"></a>4.3.3 删除</h4><p>删除操作应当将右侧所有相邻的键值重新插入散列表中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!contains(key)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> i = hash(key);</span><br><span class="line">    <span class="keyword">while</span> (!key.equals(keys[i])) &#123;</span><br><span class="line">        i = (i + <span class="number">1</span>) % M;</span><br><span class="line">    &#125;</span><br><span class="line">    keys[i] = <span class="keyword">null</span>;</span><br><span class="line">    vals[i] = <span class="keyword">null</span>;</span><br><span class="line">    i = (i + <span class="number">1</span>) % M;</span><br><span class="line">    <span class="keyword">while</span> (keys[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Key keyToRedo = keys[i];</span><br><span class="line">        Value valToRedo = vals[i];</span><br><span class="line">        keys[i] = <span class="keyword">null</span>;</span><br><span class="line">        vals[i] = <span class="keyword">null</span>;</span><br><span class="line">        N--;</span><br><span class="line">        put(keyToRedo, valToRedo);</span><br><span class="line">        i = (i + <span class="number">1</span>) % M;</span><br><span class="line">    &#125;</span><br><span class="line">    N--;</span><br><span class="line">    resize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-4-调整数组大小"><a href="#4-3-4-调整数组大小" class="headerlink" title="4.3.4 调整数组大小"></a>4.3.4 调整数组大小</h4><p>线性探测法的成本取决于连续条目的长度，连续条目也叫聚簇。当聚簇很长时，在查找和插入时也需要进行很多次探测。</p><p>α = N/M，把 α 称为利用率。理论证明，当 α 小于 1/2 时探测的预计次数只在 1.5 到 2.5 之间。</p><p><br><div align="center"> <img src="/pics/0ddebc5c-7c24-46b1-98db-4fa5e54db16b.png"> </div><br></p><p>为了保证散列表的性能，应当调整数组的大小，使得 α 在 [1/4, 1/2] 之间。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (N &gt;= M / <span class="number">2</span>) resize(<span class="number">2</span> * M);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (N &lt;= M / <span class="number">8</span>) resize(M / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    LinearProbingHashST&lt;Key, Value&gt; t = <span class="keyword">new</span> LinearProbingHashST&lt;&gt;(cap);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (keys[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">            t.put(keys[i], vals[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    keys = t.keys;</span><br><span class="line">    vals = t.vals;</span><br><span class="line">    M = t.M;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然每次重新调整数组都需要重新把每个键值对插入到散列表，但是从摊还分析的角度来看，所需要的代价却是很小的。从下图可以看出，每次数组长度加倍后，累计平均值都会增加 1，因为表中每个键都需要重新计算散列值，但是随后平均值会下降。</p><p><br><div align="center"> <img src="/pics/01658047-0d86-4a7a-a8ca-7ea20fa1fdde.png"> </div><br></p><h2 id="5-应用-1"><a href="#5-应用-1" class="headerlink" title="5. 应用"></a>5. 应用</h2><h3 id="5-1-各种符号表实现的比较"><a href="#5-1-各种符号表实现的比较" class="headerlink" title="5.1 各种符号表实现的比较"></a>5.1 各种符号表实现的比较</h3><p><br><div align="center"> <img src="/pics/9ee83c8c-1165-476c-85a6-e6e434e5307a.jpg"> </div><br></p><p>应当优先考虑散列表，当需要有序性操作时使用红黑树。</p><h3 id="5-2-Java-的符号表实现"><a href="#5-2-Java-的符号表实现" class="headerlink" title="5.2 Java 的符号表实现"></a>5.2 Java 的符号表实现</h3><p>Java 的 java.util.TreeMap 和 java.util.HashMap 分别是基于红黑树和拉链法的散列表的符号表实现。</p><h3 id="5-3-集合类型"><a href="#5-3-集合类型" class="headerlink" title="5.3 集合类型"></a>5.3 集合类型</h3><p>除了符号表，集合类型也经常使用，它只有键没有值，可以用集合类型来存储一系列的键然后判断一个键是否在集合中。</p><h3 id="5-4-稀疏向量乘法"><a href="#5-4-稀疏向量乘法" class="headerlink" title="5.4 稀疏向量乘法"></a>5.4 稀疏向量乘法</h3><p>当向量为稀疏向量时，可以使用符号表来存储向量中的非 0 索引和值，使得乘法运算只需要对那些非 0 元素进行即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SparseVector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;Integer, Double&gt; hashMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SparseVector</span><span class="params">(<span class="keyword">double</span>[] vector)</span> </span>&#123;</span><br><span class="line">        hashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; vector.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vector[i] != <span class="number">0</span>) &#123;</span><br><span class="line">                hashMap.put(i, vector[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hashMap.getOrDefault(i, <span class="number">0.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">dot</span><span class="params">(SparseVector other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i : hashMap.keySet()) &#123;</span><br><span class="line">            sum += <span class="keyword">this</span>.get(i) * other.get(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#算法分析&quot;&gt;算法分析&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-函数转换&quot;&gt;1. 函数转换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-数学模型&quot;&gt;2. 数学模型&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-threesum&quot;&gt;3. ThreeSum&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-倍率实验&quot;&gt;4. 倍率实验&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-注意事项&quot;&gt;5. 注意事项&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#排序&quot;&gt;排序&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-初级排序算法&quot;&gt;1. 初级排序算法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#11-约定&quot;&gt;1.1 约定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-选择排序&quot;&gt;1.2 选择排序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-插入排序&quot;&gt;1.3 插入排序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-选择排序和插入排序的比较&quot;&gt;1.4 选择排序和插入排序的比较&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15-希尔排序&quot;&gt;1.5 希尔排序&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-归并排序&quot;&gt;2 归并排序&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#21-归并方法&quot;&gt;2.1 归并方法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-自顶向下归并排序&quot;&gt;2.2 自顶向下归并排序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-自底向上归并排序&quot;&gt;2.3 自底向上归并排序&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-快速排序&quot;&gt;3. 快速排序&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#31-基本算法&quot;&gt;3.1 基本算法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32-切分&quot;&gt;3.2 切分&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#33-性能分析&quot;&gt;3.3 性能分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#34-算法改进&quot;&gt;3.4 算法改进&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#341-切换到插入排序&quot;&gt;3.4.1 切换到插入排序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#342-三取样&quot;&gt;3.4.2 三取样&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#343-三向切分&quot;&gt;3.4.3 三向切分&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-优先队列&quot;&gt;4. 优先队列&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#41-堆&quot;&gt;4.1 堆&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-上浮和下沉&quot;&gt;4.2 上浮和下沉&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#43-插入元素&quot;&gt;4.3 插入元素&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#44-删除最大元素&quot;&gt;4.4 删除最大元素&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#45-堆排序&quot;&gt;4.5 堆排序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#46-分析&quot;&gt;4.6 分析&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-应用&quot;&gt;5. 应用&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#51-排序算法的比较&quot;&gt;5.1 排序算法的比较&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#52-java-的排序算法实现&quot;&gt;5.2 Java 的排序算法实现&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#53-基于切分的快速选择算法&quot;&gt;5.3 基于切分的快速选择算法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#查找&quot;&gt;查找&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-符号表&quot;&gt;1. 符号表&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#11-无序符号表&quot;&gt;1.1 无序符号表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-有序符号表&quot;&gt;1.2 有序符号表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-二分查找实现有序符号表&quot;&gt;1.3 二分查找实现有序符号表&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-二叉查找树&quot;&gt;2. 二叉查找树&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#21-get&quot;&gt;2.1 get()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-put&quot;&gt;2.2 put()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-分析&quot;&gt;2.3 分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#24-floor&quot;&gt;2.4 floor()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#25-rank&quot;&gt;2.5 rank()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#26-min&quot;&gt;2.6 min()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#27-deletemin&quot;&gt;2.7 deleteMin()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#28-delete&quot;&gt;2.8 delete()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#29-keys&quot;&gt;2.9 keys()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#210-性能分析&quot;&gt;2.10 性能分析&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-平衡查找树&quot;&gt;3. 平衡查找树&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#31-2-3-查找树&quot;&gt;3.1 2-3 查找树&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#311-插入操作&quot;&gt;3.1.1 插入操作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#312-性质&quot;&gt;3.1.2 性质&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32-红黑二叉查找树&quot;&gt;3.2 红黑二叉查找树&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#321-左旋转&quot;&gt;3.2.1 左旋转&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#322-右旋转&quot;&gt;3.2.2 右旋转&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#323-颜色转换&quot;&gt;3.2.3 颜色转换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#324-插入&quot;&gt;3.2.4 插入&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#325-删除最小键&quot;&gt;3.2.5 删除最小键&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#326-分析&quot;&gt;3.2.6 分析&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-散列表&quot;&gt;4. 散列表&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#41-散列函数&quot;&gt;4.1 散列函数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-基于拉链法的散列表&quot;&gt;4.2 基于拉链法的散列表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#43-基于线性探测法的散列表&quot;&gt;4.3 基于线性探测法的散列表&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#431-查找&quot;&gt;4.3.1 查找&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#432-插入&quot;&gt;4.3.2 插入&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#433-删除&quot;&gt;4.3.3 删除&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#434-调整数组大小&quot;&gt;4.3.4 调整数组大小&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-应用&quot;&gt;5. 应用&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#51-各种符号表实现的比较&quot;&gt;5.1 各种符号表实现的比较&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#52-java-的符号表实现&quot;&gt;5.2 Java 的符号表实现&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#53-集合类型&quot;&gt;5.3 集合类型&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#54-稀疏向量乘法&quot;&gt;5.4 稀疏向量乘法&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;算法分析&quot;&gt;&lt;a href=&quot;#算法分析&quot; class=&quot;headerlink&quot; title=&quot;算法分析&quot;&gt;&lt;/a&gt;算法分析&lt;/h1&gt;&lt;h2 id=&quot;1-函数转换&quot;&gt;&lt;a href=&quot;#1-函数转换&quot; class=&quot;headerlink&quot; title=&quot;1. 函数转换&quot;&gt;&lt;/a&gt;1. 函数转换&lt;/h2&gt;&lt;p&gt;指数函数可以转换为线性函数，从而在函数图像上显示的更直观。&lt;/p&gt;
&lt;p&gt;T(N)=aN&lt;sup&gt;3&lt;/sup&gt; 转换为 lg(T(N))=3lgN+lga&lt;/p&gt;
&lt;p&gt;&lt;br&gt;&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;/pics/5510045a-8f32-487f-a756-463e51a6dab0.png&quot;&gt; &lt;/div&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-数学模型&quot;&gt;&lt;a href=&quot;#2-数学模型&quot; class=&quot;headerlink&quot; title=&quot;2. 数学模型&quot;&gt;&lt;/a&gt;2. 数学模型&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;近似&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;使用 ~f(N) 来表示所有随着 N 的增大除以 f(N) 的结果趋近于 1 的函数 , 例如 N&lt;sup&gt;3&lt;/sup&gt;/6-N&lt;sup&gt;2&lt;/sup&gt;/2+N/3 ~ N&lt;sup&gt;3&lt;/sup&gt;/6。&lt;/p&gt;
    
    </summary>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>JVM</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/JVM.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/JVM.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T10:01:41.000Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#内存模型">内存模型</a><ul><li><a href="#1-程序计数器">1. 程序计数器</a></li><li><a href="#2-java-虚拟机栈">2. Java 虚拟机栈</a></li><li><a href="#3-本地方法栈">3. 本地方法栈</a></li><li><a href="#4-java-堆">4. Java 堆</a></li><li><a href="#5-方法区">5. 方法区</a></li><li><a href="#6-运行时常量池">6. 运行时常量池</a></li><li><a href="#7-直接内存">7. 直接内存</a></li></ul></li><li><a href="#垃圾收集">垃圾收集</a><ul><li><a href="#1-判断一个对象是否可回收">1. 判断一个对象是否可回收</a><ul><li><a href="#11-引用计数">1.1 引用计数</a></li><li><a href="#12-可达性">1.2 可达性</a></li><li><a href="#13-引用类型">1.3 引用类型</a><ul><li><a href="#131-强引用">1.3.1 强引用</a></li><li><a href="#132-软引用">1.3.2 软引用</a></li><li><a href="#133-弱引用">1.3.3 弱引用</a></li><li><a href="#134-虚引用">1.3.4 虚引用</a></li></ul></li><li><a href="#13-方法区的回收">1.3 方法区的回收</a></li><li><a href="#14-finalize">1.4 finalize()</a></li></ul></li><li><a href="#2-垃圾收集算法">2. 垃圾收集算法</a><ul><li><a href="#21-标记---清除算法">2.1 标记 - 清除算法</a></li><li><a href="#22-复制算法">2.2 复制算法</a></li><li><a href="#23-标记---整理算法">2.3 标记 - 整理算法</a></li><li><a href="#24-分代收集算法">2.4 分代收集算法</a></li></ul></li><li><a href="#3-垃圾收集器">3. 垃圾收集器</a><ul><li><a href="#31-serial-收集器">3.1 Serial 收集器</a></li><li><a href="#32-parnew-收集器">3.2 ParNew 收集器</a></li><li><a href="#33-parallel-scavenge-收集器">3.3 Parallel Scavenge 收集器</a></li><li><a href="#34-serial-old-收集器">3.4 Serial Old 收集器</a></li><li><a href="#35-parallel-old-收集器">3.5 Parallel Old 收集器</a></li><li><a href="#36-cms-收集器">3.6 CMS 收集器</a></li><li><a href="#37-g1-收集器">3.7 G1 收集器</a></li><li><a href="#38-七种垃圾收集器的比较">3.8 七种垃圾收集器的比较</a></li></ul></li><li><a href="#4-内存分配与回收策略">4. 内存分配与回收策略</a><ul><li><a href="#41-优先在-eden-分配">4.1 优先在 Eden 分配</a></li><li><a href="#42-大对象直接进入老年代">4.2 大对象直接进入老年代</a></li><li><a href="#43-长期存活的对象进入老年代">4.3 长期存活的对象进入老年代</a></li><li><a href="#44-动态对象年龄判定">4.4 动态对象年龄判定</a></li><li><a href="#45-空间分配担保">4.5 空间分配担保</a></li></ul></li><li><a href="#46-full-gc-的触发条件">4.6 Full GC 的触发条件</a><ul><li><a href="#461-调用-systemgc">4.6.1 调用 System.gc()</a></li><li><a href="#462-老年代空间不足">4.6.2 老年代空间不足</a></li><li><a href="#463-空间分配担保失败">4.6.3 空间分配担保失败</a></li><li><a href="#464-jdk-17-及以前的永久代空间不足">4.6.4 JDK 1.7 及以前的永久代空间不足</a></li><li><a href="#465-concurrent-mode-failure">4.6.5 Concurrent Mode Failure</a></li></ul></li></ul></li><li><a href="#类加载机制">类加载机制</a><ul><li><a href="#1-类的生命周期">1 类的生命周期</a></li><li><a href="#2-类初始化时机">2. 类初始化时机</a></li><li><a href="#3-类加载过程">3. 类加载过程</a><ul><li><a href="#31-加载">3.1 加载</a></li><li><a href="#32-验证">3.2 验证</a></li><li><a href="#33-准备">3.3 准备</a></li><li><a href="#34-解析">3.4 解析</a></li><li><a href="#35-初始化">3.5 初始化</a></li></ul></li><li><a href="#4-类加载器">4. 类加载器</a><ul><li><a href="#41-类与类加载器">4.1 类与类加载器</a></li><li><a href="#42-类加载器分类">4.2 类加载器分类</a></li><li><a href="#43-双亲委派模型">4.3 双亲委派模型</a></li></ul></li></ul></li><li><a href="#jvm-参数">JVM 参数</a><ul><li><a href="#gc-优化配置">GC 优化配置</a></li><li><a href="#gc-类型设置">GC 类型设置</a><!-- GFM-TOC --></li></ul></li></ul><h1 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h1><p><br><div align="center"> <img src="/pics/dc695f48-4189-4fc7-b950-ed25f6c80f82.jpg"> </div><br></p><p>注：白色区域为线程私有的，蓝色区域为线程共享的。</p><h2 id="1-程序计数器"><a href="#1-程序计数器" class="headerlink" title="1. 程序计数器"></a>1. 程序计数器</h2><p>记录正在执行的虚拟机字节码指令的地址（如果正在执行的是 Native 方法则为空）。</p><h2 id="2-Java-虚拟机栈"><a href="#2-Java-虚拟机栈" class="headerlink" title="2. Java 虚拟机栈"></a>2. Java 虚拟机栈</h2><p>每个 Java 方法在执行的同时会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在 Java 虚拟机栈中入栈和出栈的过程。</p><p>该区域可能抛出以下异常：</p><ol><li>当线程请求的栈深度超过最大值，会抛出 StackOverflowError 异常；</li><li>栈进行动态扩展时如果无法申请到足够内存，会抛出 OutOfMemoryError 异常。</li></ol><a id="more"></a><h2 id="3-本地方法栈"><a href="#3-本地方法栈" class="headerlink" title="3. 本地方法栈"></a>3. 本地方法栈</h2><p>与 Java 虚拟机栈类似，它们之间的区别只不过是本地方法栈为本地方法服务。</p><h2 id="4-Java-堆"><a href="#4-Java-堆" class="headerlink" title="4. Java 堆"></a>4. Java 堆</h2><p>所有对象实例都在这里分配内存。</p><p>这块区域是垃圾收集器管理的主要区域（”GC 堆 “）。现在收集器基本都是采用分代收集算法，Java 堆还可以分成：新生代和老年代（新生代还可以分成 Eden 空间、From Survivor 空间、To Survivor 空间等）。</p><p>不需要连续内存，可以通过 -Xmx 和 -Xms 来控制动态扩展内存大小，如果动态扩展失败会抛出 OutOfMemoryError 异常。</p><h2 id="5-方法区"><a href="#5-方法区" class="headerlink" title="5. 方法区"></a>5. 方法区</h2><p>用于存放已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。</p><p>和 Java 堆一样不需要连续的内存，并且可以动态扩展，动态扩展失败一样会抛出 OutOfMemoryError 异常。</p><p>对这块区域进行垃圾回收的主要目标是对常量池的回收和对类的卸载，但是一般比较难实现，HotSpot 虚拟机把它当成永久代来进行垃圾回收。</p><h2 id="6-运行时常量池"><a href="#6-运行时常量池" class="headerlink" title="6. 运行时常量池"></a>6. 运行时常量池</h2><p>运行时常量池是方法区的一部分。</p><p>类加载后，Class 文件中的常量池（用于存放编译期生成的各种字面量和符号引用）就会被放到这个区域。</p><p>在运行期间也可以用过 String 类的 intern() 方法将新的常量放入该区域。</p><h2 id="7-直接内存"><a href="#7-直接内存" class="headerlink" title="7. 直接内存"></a>7. 直接内存</h2><p>在 JDK 1.4 中新加入了 NIO 类，引入了一种基于通道（Channel）与缓冲区（Buffer）的 I/O 方式，它可以使用 Native 函数库直接分配堆外内存，然后通过一个存储在 Java 堆里的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在 Java 堆和 Native 堆中来回复制数据。</p><h1 id="垃圾收集"><a href="#垃圾收集" class="headerlink" title="垃圾收集"></a>垃圾收集</h1><p>程序计数器、虚拟机栈和本地方法栈这三个区域属于线程私有的，只存在于线程的生命周期内，线程结束之后也会消失，因此不需要对这三个区域进行垃圾回收。</p><p>垃圾回收主要是针对 Java 堆和方法区进行。</p><h2 id="1-判断一个对象是否可回收"><a href="#1-判断一个对象是否可回收" class="headerlink" title="1. 判断一个对象是否可回收"></a>1. 判断一个对象是否可回收</h2><h3 id="1-1-引用计数"><a href="#1-1-引用计数" class="headerlink" title="1.1 引用计数"></a>1.1 引用计数</h3><p>给对象添加一个引用计数器，当对象增加一个引用时计数器加 1，引用失效时计数器减 1。</p><p>引用计数为 0 的对象可被回收。</p><p>两个对象会出现循环引用问题，此时引用计数器永远不为 0，导致 GC 收集器无法回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objA.instance = objB;</span><br><span class="line">objB.instance = objA;</span><br></pre></td></tr></table></figure><h3 id="1-2-可达性"><a href="#1-2-可达性" class="headerlink" title="1.2 可达性"></a>1.2 可达性</h3><p>通过 GC Roots 作为起始点进行搜索，能够到达到的对象都是都是可用的，不可达的对象可被回收。</p><p>GC Roots 一般包含以下内容：</p><ol><li>虚拟机栈中引用的对象</li><li>方法区中类静态属性引用的对象</li><li>方法区中的常量引用的对象</li><li>本地方法栈中引用的对象</li></ol><h3 id="1-3-引用类型"><a href="#1-3-引用类型" class="headerlink" title="1.3 引用类型"></a>1.3 引用类型</h3><p>无论是通过引用计算算法判断对象的引用数量，还是通过可达性分析算法判断对象的引用链是否可达，判定独享是否存活都与“引用”有关。</p><h4 id="1-3-1-强引用"><a href="#1-3-1-强引用" class="headerlink" title="1.3.1 强引用"></a>1.3.1 强引用</h4><p>只要强引用存在，垃圾回收器永远不会回收调掉被引用的对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object obj = <span class="keyword">new</span> Object();</span><br></pre></td></tr></table></figure><h4 id="1-3-2-软引用"><a href="#1-3-2-软引用" class="headerlink" title="1.3.2 软引用"></a>1.3.2 软引用</h4><p>非必须引用，内存溢出之前进行回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">SoftReference&lt;Object&gt; sf = <span class="keyword">new</span> SoftReference&lt;Object&gt;(obj);</span><br><span class="line">obj = <span class="keyword">null</span>;</span><br><span class="line">sf.get();</span><br></pre></td></tr></table></figure><p>sf 是对 obj 的一个软引用，通过 sf.get() 方法可以取到这个对象，当然，当这个对象被标记为需要回收的对象时，则返回 null；</p><p>软引用主要用来实现类似缓存的功能，在内存足够的情况下直接通过软引用取值，无需从繁忙的真实来源查询数据，提升速度；当内存不足时，自动删除这部分缓存数据，从真正的来源查询这些数据。</p><h4 id="1-3-3-弱引用"><a href="#1-3-3-弱引用" class="headerlink" title="1.3.3 弱引用"></a>1.3.3 弱引用</h4><p>只能生存到下一次垃圾收集发生之前，当垃圾收集器工作时，无论当前内存是否足够，都会被回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">WeakReference&lt;Object&gt; wf = <span class="keyword">new</span> WeakReference&lt;Object&gt;(obj);</span><br><span class="line">obj = <span class="keyword">null</span>;</span><br><span class="line">wf.get();</span><br><span class="line">wf.isEnQueued();</span><br></pre></td></tr></table></figure><h4 id="1-3-4-虚引用"><a href="#1-3-4-虚引用" class="headerlink" title="1.3.4 虚引用"></a>1.3.4 虚引用</h4><p>又称为幽灵引用或者幻影引用，一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用取得一个对象实例。为一个对象设置虚引用关联的唯一目的就是能在这个对象被收集器回收时收到一个系统通知。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">PhantomReference&lt;Object&gt; pf = <span class="keyword">new</span> PhantomReference&lt;Object&gt;(obj);</span><br><span class="line">obj=<span class="keyword">null</span>;</span><br><span class="line">pf.get();</span><br><span class="line">pf.isEnQueued();</span><br></pre></td></tr></table></figure><h3 id="1-3-方法区的回收"><a href="#1-3-方法区的回收" class="headerlink" title="1.3 方法区的回收"></a>1.3 方法区的回收</h3><p>在方法区主要是对常量池的回收和对类的卸载。</p><p>常量池的回收和堆中对象回收类似。</p><p>类的卸载条件很多，需要满足以下三个条件，并且满足了也不一定会被卸载：</p><ol><li>该类所有的实例都已经被回收，也就是 Java 堆中不存在该类的任何实例。</li><li>加载该类的 ClassLoader 已经被回收。</li><li>该类对应的 java.lang.Class 对象没有在任何地方被引用，也就无法在任何地方通过反射访问该类方法。</li></ol><p>可以通过 -Xnoclassgc 参数来控制是否对类进行卸载。</p><p>在大量使用反射、动态代理、CGLib 等 ByteCode 框架、动态生成 JSP 以及 OSGo 这类频繁自定义 ClassLoader 的场景都需要虚拟机具备类卸载功能，以保证不会出现内存溢出。</p><h3 id="1-4-finalize"><a href="#1-4-finalize" class="headerlink" title="1.4 finalize()"></a>1.4 finalize()</h3><p>当一个对象可被回收时，如果该对象有必要执行 finalize() 方法，那么就有可能可能通过在该方法中让对象重新被引用，从而实现自救。</p><p>finalize() 类似 C++ 的析构函数，用来做关闭外部资源等工作。但是 try-finally 等方式可以做的更好，并且该方法运行代价高昂，不确定性大，无法保证各个对象的调用顺序，因此最好不要使用。</p><h2 id="2-垃圾收集算法"><a href="#2-垃圾收集算法" class="headerlink" title="2. 垃圾收集算法"></a>2. 垃圾收集算法</h2><h3 id="2-1-标记-清除算法"><a href="#2-1-标记-清除算法" class="headerlink" title="2.1 标记 - 清除算法"></a>2.1 标记 - 清除算法</h3><p><br><div align="center"> <img src="/pics/a4248c4b-6c1d-4fb8-a557-86da92d3a294.jpg"> </div><br></p><p>将需要回收的对象进行标记，然后清除。</p><p>不足：</p><ol><li>标记和清除过程效率都不高</li><li>会产生大量碎片</li></ol><p>之后的算法都是基于该算法进行改进。</p><h3 id="2-2-复制算法"><a href="#2-2-复制算法" class="headerlink" title="2.2 复制算法"></a>2.2 复制算法</h3><p><br><div align="center"> <img src="/pics/e6b733ad-606d-4028-b3e8-83c3a73a3797.jpg"> </div><br></p><p>将内存划分为大小相等的两块，每次只使用其中一块，当这一块内存用完了就将还存活的对象复制到另一块上面，然后再把使用过的内存空间进行一次清理。</p><p>主要不足是只使用了内存的一半。</p><p>现在的商业虚拟机都采用这种收集算法来回收新生代，但是并不是将内存划分为大小相等的两块，而是分为一块较大的 Eden 空间和两块较小的 Survior 空间，每次使用 Eden 空间和其中一块 Survivor。在回收时，将 Eden 和 Survivor 中还存活着的对象一次性复制到另一块 Survivor 空间上，最后清理 Eden 和 Survivor。HotSpot 虚拟机的 Eden 和 Survivor 的大小比例默认为 8:1，保证了内存的利用率达到 90 %。如果每次回收有多于 10% 的对象存活，那么一块 Survivor 空间就不够用了，需要依赖于老年代进行分配担保，也就是借用老年代的空间。</p><h3 id="2-3-标记-整理算法"><a href="#2-3-标记-整理算法" class="headerlink" title="2.3 标记 - 整理算法"></a>2.3 标记 - 整理算法</h3><p><br><div align="center"> <img src="/pics/902b83ab-8054-4bd2-898f-9a4a0fe52830.jpg"> </div><br></p><p>让所有存活的对象都向一段移动，然后直接清理掉端边界以外的内存。</p><h3 id="2-4-分代收集算法"><a href="#2-4-分代收集算法" class="headerlink" title="2.4 分代收集算法"></a>2.4 分代收集算法</h3><p>现在的商业虚拟机采用分代收集算法，它使用了前面介绍的几种收集算法，根据对象存活周期将内存划分为几块，不同块采用适当的收集算法。</p><p>一般将 Java 堆分为新生代和老年代。</p><ol><li>新生代使用：复制算法</li><li>老年代使用：标记 - 清理 或者 标记 - 整理 算法。</li></ol><h2 id="3-垃圾收集器"><a href="#3-垃圾收集器" class="headerlink" title="3. 垃圾收集器"></a>3. 垃圾收集器</h2><p><br><div align="center"> <img src="/pics/c625baa0-dde6-449e-93df-c3a67f2f430f.jpg"> </div><br></p><p>以上是 HotSpot 虚拟机中的 7 个垃圾收集器，连线表示垃圾收集器可以配合使用。</p><h3 id="3-1-Serial-收集器"><a href="#3-1-Serial-收集器" class="headerlink" title="3.1 Serial 收集器"></a>3.1 Serial 收集器</h3><p><br><div align="center"> <img src="/pics/22fda4ae-4dd5-489d-ab10-9ebfdad22ae0.jpg"> </div><br></p><p>它是单线程的收集器，不仅意味着只会使用一个线程进行垃圾收集工作，更重要的是它在进行垃圾收集时，必须暂停所有其他工作线程，往往造成过长的等待时间。</p><p>它的优点是简单高效，对于单个 CPU 环境来说，由于没有线程交互的开销，因此拥有最高的单线程收集效率。</p><p>在 Client 应用场景中，分配给虚拟机管理的内存一般来说不会很大，该收集器收集几十兆甚至一两百兆的新生代停顿时间可以控制在一百多毫秒以内，只要不是太频繁，这点停顿是可以接受的。</p><h3 id="3-2-ParNew-收集器"><a href="#3-2-ParNew-收集器" class="headerlink" title="3.2 ParNew 收集器"></a>3.2 ParNew 收集器</h3><p><br><div align="center"> <img src="/pics/81538cd5-1bcf-4e31-86e5-e198df1e013b.jpg"> </div><br></p><p>它是 Serial 收集器的多线程版本。</p><p>是 Server 模式下的虚拟机首选新生代收集器，除了性能原因外，主要是因为除了 Serial 收集器，只有它能与 CMS 收集器配合工作。</p><p>默认开始的线程数量与 CPU 数量相同，可以使用 -XX:ParallelGCThreads 参数来设置线程数。</p><h3 id="3-3-Parallel-Scavenge-收集器"><a href="#3-3-Parallel-Scavenge-收集器" class="headerlink" title="3.3 Parallel Scavenge 收集器"></a>3.3 Parallel Scavenge 收集器</h3><p>是并行的多线程收集器。</p><p>其它收集器关注点是尽可能缩短垃圾收集时用户线程的停顿时间，而它的目标是达到一个可控制的吞吐量，它被称为“吞吐量优先”收集器。这里的吞吐量指 CPU 用于运行用户代码的时间占总时间的比值。</p><p>停顿时间越短就越适合需要与用户交互的程序，良好的响应速度能提升用户体验。而高吞吐量则可以高效率地利用 CPU 时间，尽快完成程序的运算任务，主要适合在后台运算而不需要太多交互的任务。</p><p>提供了两个参数用于精确控制吞吐量，分别是控制最大垃圾收集停顿时间 -XX:MaxGCPauseMillis 参数以及直接设置吞吐量大小的 -XX:GCTimeRatio 参数（值为大于 0 且小于 100 的整数）。缩短停顿时间是以牺牲吞吐量和新生代空间来换取的：新生代空间变小，垃圾回收变得频繁，导致吞吐量下降。</p><p>还提供了一个参数 -XX:+UseAdaptiveSizePolicy，这是一个开关参数，打开参数后，就不需要手工指定新生代的大小（-Xmn）、Eden 和 Survivor 区的比例（-XX:SurvivorRatio）、晋升老年代对象年龄（-XX:PretenureSizeThreshold）等细节参数了，虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量，这种方式称为 GC 自适应的调节策略（GC Ergonomics）。自适应调节策略也是它与 ParNew 收集器的一个重要区别。</p><h3 id="3-4-Serial-Old-收集器"><a href="#3-4-Serial-Old-收集器" class="headerlink" title="3.4 Serial Old 收集器"></a>3.4 Serial Old 收集器</h3><p><br><div align="center"> <img src="/pics/08f32fd3-f736-4a67-81ca-295b2a7972f2.jpg"> </div><br></p><p>Serial Old 是 Serial 收集器的老年代版本，也是给 Client 模式下的虚拟机使用。如果用在 Server 模式下，它有两大用途：</p><ol><li>在 JDK 1.5 以及之前版本（Parallel Old 诞生以前）中与 Parallel Scavenge 收集器搭配使用。</li><li>作为 CMS 收集器的后备预案，在并发收集发生 Concurrent Mode Failure 时使用。</li></ol><h3 id="3-5-Parallel-Old-收集器"><a href="#3-5-Parallel-Old-收集器" class="headerlink" title="3.5 Parallel Old 收集器"></a>3.5 Parallel Old 收集器</h3><p><br><div align="center"> <img src="/pics/278fe431-af88-4a95-a895-9c3b80117de3.jpg"> </div><br></p><p>是 Parallel Scavenge 收集器的老年代版本。</p><p>在注重吞吐量以及 CPU 资源敏感的场合，都可以优先考虑 Parallel Scavenge 加 Parallel Old 收集器。</p><h3 id="3-6-CMS-收集器"><a href="#3-6-CMS-收集器" class="headerlink" title="3.6 CMS 收集器"></a>3.6 CMS 收集器</h3><p><br><div align="center"> <img src="/pics/62e77997-6957-4b68-8d12-bfd609bb2c68.jpg"> </div><br></p><p>CMS（Concurrent Mark Sweep），从 Mark Sweep 可以知道它是基于 标记 - 清除 算法实现的。</p><p>特点：并发收集、低停顿。</p><p>分为以下四个流程：</p><ol><li>初始标记：仅仅只是标记一下 GC Roots 能直接关联到的对象，速度很快，需要停顿。</li><li>并发标记：进行 GC Roots Tracing 的过程，它在整个回收过程中耗时最长，不需要停顿。</li><li>重新标记：为了修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，需要停顿。</li><li>并发清除：不需要停顿。</li></ol><p>在整个过程中耗时最长的并发标记和并发清除过程中，收集器线程都可以与用户线程一起工作，不需要进行停顿。</p><p>具有以下缺点：</p><ol><li><p>对 CPU 资源敏感。CMS 默认启动的回收线程数是 (CPU 数量 + 3) / 4，当 CPU 不足 4 个时，CMS 对用户程序的影响就可能变得很大，如果本来 CPU 负载就比较大，还要分出一半的运算能力去执行收集器线程，就可能导致用户程序的执行速度忽然降低了 50%，其实也让人无法接受。并且低停顿时间是以牺牲吞吐量为代价的，导致 CPU 利用率变低。</p></li><li><p>无法处理浮动垃圾。由于并发清理阶段用户线程还在运行着，伴随程序运行自然就还会有新的垃圾不断产生。这一部分垃圾出现在标记过程之后，CMS 无法在当次收集中处理掉它们，只好留到下一次 GC 时再清理掉，这一部分垃圾就被称为“浮动垃圾”。也是由于在垃圾收集阶段用户线程还需要运行，那也就还需要预留有足够的内存空间给用户线程使用，因此它不能像其他收集器那样等到老年代几乎完全被填满了再进行收集，需要预留一部分空间提供并发收集时的程序运作使用。可以使用 -XX:CMSInitiatingOccupancyFraction 的值来改变触发收集器工作的内存占用百分比，JDK 1.5 默认设置下该值为 68，也就是当老年代使用了 68% 的空间之后会触发收集器工作。如果该值设置的太高，导致浮动垃圾无法保存，那么就会出现 Concurrent Mode Failure，此时虚拟机将启动后备预案：临时启用 Serial Old 收集器来重新进行老年代的垃圾收集。</p></li><li><p>标记 - 清除算法导致的空间碎片，给大对象分配带来很大麻烦，往往出现老年代空间剩余，但无法找到足够大连续空间来分配当前对象，不得不提前出发一次 Full GC。</p></li></ol><h3 id="3-7-G1-收集器"><a href="#3-7-G1-收集器" class="headerlink" title="3.7 G1 收集器"></a>3.7 G1 收集器</h3><p><br><div align="center"> <img src="/pics/f99ee771-c56f-47fb-9148-c0036695b5fe.jpg"> </div><br></p><p>G1（Garbage-First）收集器是当今收集器技术发展最前沿的成果之一，它是一款面向服务端应用的垃圾收集器，HotSpot 开发团队赋予它的使命是（在比较长期的）未来可以替换掉 JDK 1.5 中发布的 CMS 收集器。</p><p>具备如下特点：</p><ul><li>并行与并发：能充分利用多 CPU 环境下的硬件优势，使用多个 CPU 来缩短停顿时间；</li><li>分代收集：分代概念依然得以保留，虽然它不需要其它收集器配合就能独立管理整个 GC 堆，但它能够采用不同方式去处理新创建的对象和已存活一段时间、熬过多次 GC 的旧对象来获取更好的收集效果。</li><li>空间整合：整体来看是基于“标记 - 整理”算法实现的收集器，从局部（两个 Region 之间）上来看是基于“复制”算法实现的，这意味着运行期间不会产生内存空间碎片。</li><li>可预测的停顿：这是它相对 CMS 的一大优势，降低停顿时间是 G1 和 CMS 共同的关注点，但 G1 除了降低停顿外，还能建立可预测的停顿时间模型，能让使用者明确指定在一个长度为 M 毫秒的时间片段内，消耗在 GC 上的时间不得超过 N 毫秒，这几乎已经是实时 Java（RTSJ）的垃圾收集器的特征了。</li></ul><p>在 G1 之前的其他收集器进行收集的范围都是整个新生代或者老生代，而 G1 不再是这样，Java 堆的内存布局与其他收集器有很大区别，将整个 Java 堆划分为多个大小相等的独立区域（Region）。虽然还保留新生代和老年代的概念，但新生代和老年代不再是物理隔离的了，而都是一部分 Region（不需要连续）的集合。</p><p>之所以能建立可预测的停顿时间模型，是因为它可以有计划地避免在整个 Java 堆中进行全区域的垃圾收集。它跟踪各个 Region 里面的垃圾堆积的价值大小（回收所获得的空间大小以及回收所需时间的经验值），在后台维护一个优先列表，每次根据允许的收集时间，优先回收价值最大的 Region（这也就是 Garbage-First 名称的来由）。这种使用 Region 划分内存空间以及有优先级的区域回收方式，保证了它在有限的时间内可以获取尽可能高的收集效率。</p><p>Region 不可能是孤立的，一个对象分配在某个 Region 中，可以与整个 Java 堆任意的对象发生引用关系。在做可达性分析确定对象是否存活的时候，需要扫描整个 Java 堆才能保证准确性，这显然是对 GC 效率的极大伤害。为了避免全堆扫描的发生，每个 Region 都维护了一个与之对应的 Remembered Set。虚拟机发现程序在对 Reference 类型的数据进行写操作时，会产生一个 Write Barrier 暂时中断写操作，检查 Reference 引用的对象是否处于不同的 Region 之中，如果是，便通过 CardTable 把相关引用信息记录到被引用对象所属的 Region 的 Remembered Set 之中。当进行内存回收时，在 GC 根节点的枚举范围中加入 Remembered Set 即可保证不对全堆扫描也不会有遗漏。</p><p>如果不计算维护 Remembered Set 的操作，G1 收集器的运作大致可划分为以下几个步骤：</p><ol><li>初始标记</li><li>并发标记</li><li>最终标记：为了修正在并发标记期间因用户程序继续运作而导致标记产生变动的那一部分标记记录，虚拟机将这段时间对象变化记录在线程的 Remembered Set Logs 里面，最终标记阶段需要把 Remembered Set Logs 的数据合并到 Remembered Set 中。这阶段需要停顿线程，但是可并行执行。</li><li>筛选回收：首先对各个 Region 中的回收价值和成本进行排序，根据用户所期望的 GC 停顿是时间来制定回收计划。此阶段其实也可以做到与用户程序一起并发执行，但是因为只回收一部分 Region，时间是用户可控制的，而且停顿用户线程将大幅度提高收集效率。</li></ol><h3 id="3-8-七种垃圾收集器的比较"><a href="#3-8-七种垃圾收集器的比较" class="headerlink" title="3.8 七种垃圾收集器的比较"></a>3.8 七种垃圾收集器的比较</h3><table><thead><tr><th>收集器</th><th>串行、并行 or 并发</th><th>新生代 / 老年代</th><th>算法</th><th>目标</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Serial</strong></td><td>串行</td><td>新生代</td><td>复制算法</td><td>响应速度优先</td><td>单 CPU 环境下的 Client 模式</td></tr><tr><td><strong>Serial Old</strong></td><td>串行</td><td>老年代</td><td>标记 - 整理</td><td>响应速度优先</td><td>单 CPU 环境下的 Client 模式、CMS 的后备预案</td></tr><tr><td><strong>ParNew</strong></td><td>并行</td><td>新生代</td><td>复制算法</td><td>响应速度优先</td><td>多 CPU 环境时在 Server 模式下与 CMS 配合</td></tr><tr><td><strong>Parallel Scavenge</strong></td><td>并行</td><td>新生代</td><td>复制算法</td><td>吞吐量优先</td><td>在后台运算而不需要太多交互的任务</td></tr><tr><td><strong>Parallel Old</strong></td><td>并行</td><td>老年代</td><td>标记 - 整理</td><td>吞吐量优先</td><td>在后台运算而不需要太多交互的任务</td></tr><tr><td><strong>CMS</strong></td><td>并发</td><td>老年代</td><td>标记 - 清除</td><td>响应速度优先</td><td>集中在互联网站或 B/S 系统服务端上的 Java 应用</td></tr><tr><td><strong>G1</strong></td><td>并发</td><td>both</td><td>标记 - 整理 + 复制算法</td><td>响应速度优先</td><td>面向服务端应用，将来替换 CMS</td></tr></tbody></table><h2 id="4-内存分配与回收策略"><a href="#4-内存分配与回收策略" class="headerlink" title="4. 内存分配与回收策略"></a>4. 内存分配与回收策略</h2><h3 id="4-1-优先在-Eden-分配"><a href="#4-1-优先在-Eden-分配" class="headerlink" title="4.1 优先在 Eden 分配"></a>4.1 优先在 Eden 分配</h3><p>大多数情况下，对象在新生代 Eden 区分配，当 Eden 区空间不够时，发起 Minor GC；</p><h3 id="4-2-大对象直接进入老年代"><a href="#4-2-大对象直接进入老年代" class="headerlink" title="4.2 大对象直接进入老年代"></a>4.2 大对象直接进入老年代</h3><p>提供 -XX:PretenureSizeThreshold 参数，大于此值的对象直接在老年代分配，避免在 Eden 区和 Survivor 区之间的大量内存复制；</p><h3 id="4-3-长期存活的对象进入老年代"><a href="#4-3-长期存活的对象进入老年代" class="headerlink" title="4.3 长期存活的对象进入老年代"></a>4.3 长期存活的对象进入老年代</h3><p>JVM 为对象定义年龄计数器，经过 Minor GC 依然存活且被 Survivor 区容纳的，移动到 Survivor 区，年龄加 1，每经历一次 Minor GC 不被清理则年龄加 1，增加到一定年龄则移动到老年区（默认 15 岁，通过 -XX:MaxTenuringThreshold 设置）；</p><h3 id="4-4-动态对象年龄判定"><a href="#4-4-动态对象年龄判定" class="headerlink" title="4.4 动态对象年龄判定"></a>4.4 动态对象年龄判定</h3><p>若 Survivor 区中同年龄所有对象大小总和大于 Survivor 空间一半，则年龄大于等于该年龄的对象可以直接进入老年代；</p><h3 id="4-5-空间分配担保"><a href="#4-5-空间分配担保" class="headerlink" title="4.5 空间分配担保"></a>4.5 空间分配担保</h3><p>在发生 Minor GC 之前，JVM 先检查老年代最大可用连续空间是否大于新生代所有对象总空间，成立的话 Minor GC 确认是安全的；否则继续检查老年代最大可用连续空间是否大于历次晋升到老年代对象的平均大小，大于的话进行 Minor GC，小于的话进行 Full GC。</p><h2 id="4-6-Full-GC-的触发条件"><a href="#4-6-Full-GC-的触发条件" class="headerlink" title="4.6 Full GC 的触发条件"></a>4.6 Full GC 的触发条件</h2><p>对于 Minor GC，其触发条件非常简单，当 Eden 区空间满时，就将触发一次 Minor GC。而 Full GC 则相对复杂，有以下条件：</p><h3 id="4-6-1-调用-System-gc"><a href="#4-6-1-调用-System-gc" class="headerlink" title="4.6.1 调用 System.gc()"></a>4.6.1 调用 System.gc()</h3><p>此方法的调用是建议 JVM 进行 Full GC，虽然只是建议而非一定，但很多情况下它会触发 Full GC，从而增加 Full GC 的频率，也即增加了间歇性停顿的次数。因此强烈建议能不使用此方法就不要使用，让虚拟机自己去管理它的内存，可通过 -XX:+ DisableExplicitGC 来禁止 RMI 调用 System.gc()。</p><h3 id="4-6-2-老年代空间不足"><a href="#4-6-2-老年代空间不足" class="headerlink" title="4.6.2 老年代空间不足"></a>4.6.2 老年代空间不足</h3><p>老年代空间不足的常见场景为前文所讲的大对象直接进入老年代、长期存活的对象进入老年代等，当执行 Full GC 后空间仍然不足，则抛出如下错误： Java.lang.OutOfMemoryError: Java heap space 为避免以上两种状况引起的 Full GC，调优时应尽量做到让对象在 Minor GC 阶段被回收、让对象在新生代多存活一段时间及不要创建过大的对象及数组。</p><h3 id="4-6-3-空间分配担保失败"><a href="#4-6-3-空间分配担保失败" class="headerlink" title="4.6.3 空间分配担保失败"></a>4.6.3 空间分配担保失败</h3><p>使用复制算法的 Minor GC 需要老年代的内存空间作担保，如果出现了 HandlePromotionFailure 担保失败，则会触发 Full GC。</p><h3 id="4-6-4-JDK-1-7-及以前的永久代空间不足"><a href="#4-6-4-JDK-1-7-及以前的永久代空间不足" class="headerlink" title="4.6.4 JDK 1.7 及以前的永久代空间不足"></a>4.6.4 JDK 1.7 及以前的永久代空间不足</h3><p>在 JDK 1.7 及以前，HotSpot 虚拟机中的方法区是用永久代实现的，永久代中存放的为一些 class 的信息、常量、静态变量等数据，当系统中要加载的类、反射的类和调用的方法较多时，Permanet Generation 可能会被占满，在未配置为采用 CMS GC 的情况下也会执行 Full GC。如果经过 Full GC 仍然回收不了，那么 JVM 会抛出如下错误信息：java.lang.OutOfMemoryError: PermGen space 为避免 PermGen 占满造成 Full GC 现象，可采用的方法为增大 PermGen 空间或转为使用 CMS GC。</p><p>在 JDK 1.8 中用元空间替换了永久代作为方法区的实现，元空间是本地内存，因此减少了一种 Full GC 触发的可能性。</p><h3 id="4-6-5-Concurrent-Mode-Failure"><a href="#4-6-5-Concurrent-Mode-Failure" class="headerlink" title="4.6.5 Concurrent Mode Failure"></a>4.6.5 Concurrent Mode Failure</h3><p>执行 CMS GC 的过程中同时有对象要放入老年代，而此时老年代空间不足（有时候“空间不足”是 CMS GC 时当前的浮动垃圾过多导致暂时性的空间不足触发 Full GC），便会报 Concurrent Mode Failure 错误，并触发 Full GC。</p><h1 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h1><p>类是在运行期间动态加载的。</p><h2 id="1-类的生命周期"><a href="#1-类的生命周期" class="headerlink" title="1 类的生命周期"></a>1 类的生命周期</h2><p><br><div align="center"> <img src="/pics/32b8374a-e822-4720-af0b-c0f485095ea2.jpg"> </div><br></p><p>包括以下 7 个阶段：</p><ul><li><strong>加载（Loading）</strong> </li><li><strong>验证（Verification）</strong> </li><li><strong>准备（Preparation）</strong> </li><li><strong>解析（Resolution）</strong> </li><li><strong>初始化（Initialization）</strong> </li><li>使用（Using）</li><li>卸载（Unloading）</li></ul><p>其中解析过程在某些情况下可以在初始化阶段之后再开始，这是为了支持 Java 的动态绑定。</p><h2 id="2-类初始化时机"><a href="#2-类初始化时机" class="headerlink" title="2. 类初始化时机"></a>2. 类初始化时机</h2><p>虚拟机规范中并没有强制约束何时进行加载，但是规范严格规定了有且只有下列五种情况必须对类进行初始化：( 加载、验证、准备都会随着发生 )</p><ol><li><p>遇到 new、getstatic、putstatic、invokestatic 这四条字节码指令时，如果类没有进行过初始化，则必须先触发其初始化。最常见的生成这 4 条指令的场景是：使用 new 关键字实例化对象的时候；读取或设置一个类的静态字段（被 final 修饰、已在编译器把结果放入常量池的静态字段除外）的时候；以及调用一个类的静态方法的时候。</p></li><li><p>使用 java.lang.reflect 包的方法对类进行反射调用的时候，如果类没有进行初始化，则需要先触发其初始化。</p></li><li><p>当初始化一个类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化。</p></li><li><p>当虚拟机启动时，用户需要指定一个要执行的主类（包含 main() 方法的那个类），虚拟机会先初始化这个主类；</p></li><li><p>当使用 jdk1.7 的动态语言支持时，如果一个 java.lang.invoke.MethodHandle 实例最后的解析结果为 REF_getStatic, REF_putStatic, REF_invokeStatic 的方法句柄，并且这个方法句柄所对应的类没有进行过初始化，则需要先触发其初始化；</p></li></ol><p>以上 5 种场景中的行为称为对一个类进行主动引用。除此之外，所有引用类的方式都不会触发初始化，称为被动引用。被动引用的常见例子包括：</p><p>1. 通过子类引用父类的静态字段，不会导致子类初始化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(SubClass.value); <span class="comment">// value 字段在 SuperClass 中定义</span></span><br></pre></td></tr></table></figure><p>2. 通过数组定义来引用类，不会触发此类的初始化。该过程会对数组类进行初始化，数组类是一个由虚拟机自动生成的、直接继承自 Object 的子类，其中包含了数组的属性和方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SuperClass[] sca = <span class="keyword">new</span> SuperClass[<span class="number">10</span>];</span><br></pre></td></tr></table></figure><p>3. 常量在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(ConstClass.HELLOWORLD);</span><br></pre></td></tr></table></figure><h2 id="3-类加载过程"><a href="#3-类加载过程" class="headerlink" title="3. 类加载过程"></a>3. 类加载过程</h2><p>包含了加载、验证、准备、解析和初始化这 5 个阶段。</p><h3 id="3-1-加载"><a href="#3-1-加载" class="headerlink" title="3.1 加载"></a>3.1 加载</h3><p>加载是类加载的一个阶段，注意不要混淆。</p><p>加载过程完成以下三件事：</p><ol><li>通过一个类的全限定名来获取定义此类的二进制字节流。</li><li>将这个字节流所代表的静态存储结构转化为方法区的运行时存储结构。</li><li>在内存中生成一个代表这个类的 Class 对象，作为方法区这个类的各种数据的访问入口。</li></ol><p>其中二进制字节流可以从以下方式中获取：</p><ul><li>从 ZIP 包读取，这很常见，最终成为日后 JAR、EAR、WAR 格式的基础。</li><li>从网络中获取，这种场景最典型的应用是 Applet。</li><li>运行时计算生成，这种场景使用得最多得就是动态代理技术，在 java.lang.reflect.Proxy 中，就是用了 ProxyGenerator.generateProxyClass 的代理类的二进制字节流。</li><li>由其他文件生成，典型场景是 JSP 应用，即由 JSP 文件生成对应的 Class 类。</li><li>从数据库读取，这种场景相对少见，例如有些中间件服务器（如 SAP Netweaver）可以选择把程序安装到数据库中来完成程序代码在集群间的分发。<br>…</li></ul><h3 id="3-2-验证"><a href="#3-2-验证" class="headerlink" title="3.2 验证"></a>3.2 验证</h3><p>确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。</p><p>主要有以下 4 个阶段：</p><ol><li>文件格式验证</li><li>元数据验证（对字节码描述的信息进行语义分析）</li><li>字节码验证（通过数据流和控制流分析，确保程序语义是合法、符合逻辑的，将对类的方法体进行校验分析）</li><li>符号引用验证</li></ol><h3 id="3-3-准备"><a href="#3-3-准备" class="headerlink" title="3.3 准备"></a>3.3 准备</h3><p>类变量是被 static 修饰的变量，准备阶段为类变量分配内存并设置初始值，使用的是方法区的内存。</p><p>实例变量不会在这阶段分配内存，它将会在对象实例化时随着对象一起分配在 Java 堆中。</p><p>初始值一般为 0 值，例如下面的类变量 value 被初始化为 0 而不是 123。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value = <span class="number">123</span>;</span><br></pre></td></tr></table></figure><p>如果类变量是常量，那么会按照表达式来进行初始化，而不是赋值为 0。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> value = <span class="number">123</span>;</span><br></pre></td></tr></table></figure><h3 id="3-4-解析"><a href="#3-4-解析" class="headerlink" title="3.4 解析"></a>3.4 解析</h3><p>将常量池的符号引用替换为直接引用的过程。</p><h3 id="3-5-初始化"><a href="#3-5-初始化" class="headerlink" title="3.5 初始化"></a>3.5 初始化</h3><p>初始化阶段即虚拟机执行类构造器 &lt;clinit&gt;() 方法的过程。</p><p>在准备阶段，类变量已经赋过一次系统要求的初始值，而在初始化阶段，根据程序员通过程序制定的主观计划去初始化类变量和其它资源。</p><p>&lt;clinit&gt;() 方法具有以下特点：</p><ul><li>是由编译器自动收集类中所有类变量的赋值动作和静态语句块（static{} 块）中的语句合并产生的，编译器收集的顺序由语句在源文件中出现的顺序决定。特别注意的是，静态语句块只能访问到定义在它之前的类变量，定义在它之后的类变量只能赋值，不能访问。例如以下代码：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i = <span class="number">0</span>;                <span class="comment">// 给变量赋值可以正常编译通过</span></span><br><span class="line">        System.out.print(i);  <span class="comment">// 这句编译器会提示“非法向前引用”</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>与类的构造函数（或者说实例构造器 &lt;init&gt;()）不同，不需要显式的调用父类的构造器。虚拟机会自动保证在子类的 &lt;clinit&gt;() 方法运行之前，父类的 &lt;clinit&gt;() 方法已经执行结束。因此虚拟机中第一个执行 &lt;clinit&gt;() 方法的类肯定为 java.lang.Object。</p></li><li><p>由于父类的 &lt;clinit&gt;() 方法先执行，也就意味着父类中定义的静态语句块要优于子类的变量赋值操作。例如以下代码：</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> A = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            A = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sub</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> B = A;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Sub.B);  <span class="comment">// 输出结果是父类中的静态变量值 A，也就是 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>&lt;clinit&gt;() 方法对于类或接口不是必须的，如果一个类中不包含静态语句块，也没有对类变量的赋值操作，编译器可以不为该类生成 &lt;clinit&gt;() 方法。</p></li><li><p>接口中不可以使用静态语句块，但仍然有类变量初始化的赋值操作，因此接口与类一样都会生成 &lt;clinit&gt;() 方法。但接口与类不同的是，执行接口的 &lt;clinit&gt;() 方法不需要先执行父接口的 &lt;clinit&gt;() 方法。只有当父接口中定义的变量使用时，父接口才会初始化。另外，接口的实现类在初始化时也一样不会执行接口的 &lt;clinit&gt;() 方法。</p></li><li><p>虚拟机会保证一个类的 &lt;clinit&gt;() 方法在多线程环境下被正确的加锁和同步，如果多个线程同时初始化一个类，只会有一个线程执行这个类的 &lt;clinit&gt;() 方法，其它线程都会阻塞等待，直到活动线程执行 &lt;clinit&gt;() 方法完毕。如果在一个类的 &lt;clinit&gt;() 方法中有耗时的操作，就可能造成多个进程阻塞，在实际过程中此种阻塞很隐蔽。</p></li></ul><h2 id="4-类加载器"><a href="#4-类加载器" class="headerlink" title="4. 类加载器"></a>4. 类加载器</h2><p>虚拟机设计团队把类加载阶段中的“通过一个类的全限定名来获取描述此类的二进制字节流 ( 即字节码 )”这个动作放到 Java 虚拟机外部去实现，以便让应用程序自己决定如何去获取所需要的类。实现这个动作的代码模块称为“类加载器”。</p><h3 id="4-1-类与类加载器"><a href="#4-1-类与类加载器" class="headerlink" title="4.1 类与类加载器"></a>4.1 类与类加载器</h3><p>对于任意一个类，都需要由加载它的类加载器和这个类本身一同确立其在 Java 虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。通俗而言：比较两个类是否“相等”（这里所指的“相等”，包括类的 Class 对象的 equals() 方法、isAssignableFrom() 方法、isInstance() 方法的返回结果，也包括使用 instanceof() 关键字对做对象所属关系判定等情况），只有在这两个类时由同一个类加载器加载的前提下才有意义，否则，即使这两个类来源于同一个 Class 文件，被同一个虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等。</p><h3 id="4-2-类加载器分类"><a href="#4-2-类加载器分类" class="headerlink" title="4.2 类加载器分类"></a>4.2 类加载器分类</h3><p>从 Java 虚拟机的角度来讲，只存在以下两种不同的类加载器：</p><p>一种是启动类加载器（Bootstrap ClassLoader），这个类加载器用 C++ 实现，是虚拟机自身的一部分；另一种就是所有其他类的加载器，这些类由 Java 实现，独立于虚拟机外部，并且全都继承自抽象类 java.lang.ClassLoader。</p><p>从 Java 开发人员的角度看，类加载器可以划分得更细致一些：</p><ul><li><p>启动类加载器（Bootstrap ClassLoader） 此类加载器负责将存放在 &lt;JAVA_HOME&gt;\lib 目录中的，或者被 -Xbootclasspath 参数所指定的路径中的，并且是虚拟机识别的（仅按照文件名识别，如 rt.jar，名字不符合的类库即使放在 lib 目录中也不会被加载）类库加载到虚拟机内存中。 启动类加载器无法被 Java 程序直接引用，用户在编写自定义类加载器时，如果需要把加载请求委派给引导类加载器，直接使用 null 代替即可。</p></li><li><p>扩展类加载器（Extension ClassLoader） 这个类加载器是由 ExtClassLoader（sun.misc.Launcher$ExtClassLoader）实现的。它负责将 &lt;Java_Home&gt;/lib/ext 或者被 java.ext.dir 系统变量所指定路径中的所有类库加载到内存中，开发者可以直接使用扩展类加载器。</p></li><li><p>应用程序类加载器（Application ClassLoader） 这个类加载器是由 AppClassLoader（sun.misc.Launcher$AppClassLoader）实现的。由于这个类加载器是 ClassLoader 中的 getSystemClassLoader() 方法的返回值，因此一般称为系统类加载器。它负责加载用户类路径（ClassPath）上所指定的类库，开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</p></li></ul><h3 id="4-3-双亲委派模型"><a href="#4-3-双亲委派模型" class="headerlink" title="4.3 双亲委派模型"></a>4.3 双亲委派模型</h3><p>应用程序都是由三种类加载器相互配合进行加载的，如果有必要，还可以加入自己定义的类加载器。下图展示的类加载器之间的层次关系，称为类加载器的双亲委派模型（Parents Delegation Model）。该模型要求除了顶层的启动类加载器外，其余的类加载器都应有自己的父类加载器，这里类加载器之间的父子关系一般通过组合（Composition）关系来实现，而不是通过继承（Inheritance）的关系实现。</p><p><br><div align="center"> <img src="/pics/2cdc3ce2-fa82-4c22-baaa-000c07d10473.jpg"> </div><br></p><p><strong>工作过程</strong> </p><p>如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载，而是把这个请求委派给父类加载器，每一个层次的加载器都是如此，依次递归，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，只有当父加载器反馈自己无法完成此加载请求（它搜索范围中没有找到所需类）时，子加载器才会尝试自己加载。</p><p><strong>好处</strong> </p><p>使用双亲委派模型来组织类加载器之间的关系，使得 Java 类随着它的类加载器一起具备了一种带有优先级的层次关系。例如类 java.lang.Object，它存放再 rt.jar 中，无论哪个类加载器要加载这个类，最终都是委派给处于模型最顶端的启动类加载器进行加载，因此 Object 类在程序的各种类加载器环境中都是同一个类。相反，如果没有双亲委派模型，由各个类加载器自行加载的话，如果用户编写了一个称为｀java.lang.Object 的类，并放在程序的 ClassPath 中，那系统中将会出现多个不同的 Object 类，程序将变得一片混乱。如果开发者尝试编写一个与 rt.jar 类库中已有类重名的 Java 类，将会发现可以正常编译，但是永远无法被加载运行。</p><p><strong>实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException&#123;</span><br><span class="line">    <span class="comment">//check the class has been loaded or not</span></span><br><span class="line">    Class c = findLoadedClass(name);</span><br><span class="line">    <span class="keyword">if</span>(c == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                c = findBootstrapClassOrNull(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">//if throws the exception , the father can not complete the load</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            c = findClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(resolve) &#123;</span><br><span class="line">        resolveClass(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="JVM-参数"><a href="#JVM-参数" class="headerlink" title="JVM 参数"></a>JVM 参数</h1><h2 id="GC-优化配置"><a href="#GC-优化配置" class="headerlink" title="GC 优化配置"></a>GC 优化配置</h2><table><thead><tr><th>配置</th><th>描述</th></tr></thead><tbody><tr><td>-Xms</td><td>初始化堆内存大小</td></tr><tr><td>-Xmx</td><td>堆内存最大值</td></tr><tr><td>-Xmn</td><td>新生代大小</td></tr><tr><td>-XX:PermSize</td><td>初始化永久代大小</td></tr><tr><td>-XX:MaxPermSize</td><td>永久代最大容量</td></tr></tbody></table><h2 id="GC-类型设置"><a href="#GC-类型设置" class="headerlink" title="GC 类型设置"></a>GC 类型设置</h2><table><thead><tr><th>配置</th><th>描述</th></tr></thead><tbody><tr><td>-XX:+UseSerialGC</td><td>串行垃圾回收器</td></tr><tr><td>-XX:+UseParallelGC</td><td>并行垃圾回收器</td></tr><tr><td>-XX:+UseConcMarkSweepGC</td><td>并发标记扫描垃圾回收器</td></tr><tr><td>-XX:ParallelCMSThreads=</td><td>并发标记扫描垃圾回收器 = 为使用的线程数量</td></tr><tr><td>-XX:+UseG1GC</td><td>G1 垃圾回收器</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xmx12m -Xms3m -Xmn1m -XX:PermSize=<span class="number">20</span>m -XX:MaxPermSize=<span class="number">20</span>m -XX:+UseSerialGC -jar java-application.jar</span><br></pre></td></tr></table></figure><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#内存模型&quot;&gt;内存模型&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-程序计数器&quot;&gt;1. 程序计数器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-java-虚拟机栈&quot;&gt;2. Java 虚拟机栈&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-本地方法栈&quot;&gt;3. 本地方法栈&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-java-堆&quot;&gt;4. Java 堆&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-方法区&quot;&gt;5. 方法区&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-运行时常量池&quot;&gt;6. 运行时常量池&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-直接内存&quot;&gt;7. 直接内存&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#垃圾收集&quot;&gt;垃圾收集&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-判断一个对象是否可回收&quot;&gt;1. 判断一个对象是否可回收&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#11-引用计数&quot;&gt;1.1 引用计数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-可达性&quot;&gt;1.2 可达性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-引用类型&quot;&gt;1.3 引用类型&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#131-强引用&quot;&gt;1.3.1 强引用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#132-软引用&quot;&gt;1.3.2 软引用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#133-弱引用&quot;&gt;1.3.3 弱引用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#134-虚引用&quot;&gt;1.3.4 虚引用&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-方法区的回收&quot;&gt;1.3 方法区的回收&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-finalize&quot;&gt;1.4 finalize()&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-垃圾收集算法&quot;&gt;2. 垃圾收集算法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#21-标记---清除算法&quot;&gt;2.1 标记 - 清除算法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-复制算法&quot;&gt;2.2 复制算法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-标记---整理算法&quot;&gt;2.3 标记 - 整理算法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#24-分代收集算法&quot;&gt;2.4 分代收集算法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-垃圾收集器&quot;&gt;3. 垃圾收集器&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#31-serial-收集器&quot;&gt;3.1 Serial 收集器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32-parnew-收集器&quot;&gt;3.2 ParNew 收集器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#33-parallel-scavenge-收集器&quot;&gt;3.3 Parallel Scavenge 收集器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#34-serial-old-收集器&quot;&gt;3.4 Serial Old 收集器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#35-parallel-old-收集器&quot;&gt;3.5 Parallel Old 收集器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#36-cms-收集器&quot;&gt;3.6 CMS 收集器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#37-g1-收集器&quot;&gt;3.7 G1 收集器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#38-七种垃圾收集器的比较&quot;&gt;3.8 七种垃圾收集器的比较&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-内存分配与回收策略&quot;&gt;4. 内存分配与回收策略&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#41-优先在-eden-分配&quot;&gt;4.1 优先在 Eden 分配&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-大对象直接进入老年代&quot;&gt;4.2 大对象直接进入老年代&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#43-长期存活的对象进入老年代&quot;&gt;4.3 长期存活的对象进入老年代&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#44-动态对象年龄判定&quot;&gt;4.4 动态对象年龄判定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#45-空间分配担保&quot;&gt;4.5 空间分配担保&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#46-full-gc-的触发条件&quot;&gt;4.6 Full GC 的触发条件&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#461-调用-systemgc&quot;&gt;4.6.1 调用 System.gc()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#462-老年代空间不足&quot;&gt;4.6.2 老年代空间不足&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#463-空间分配担保失败&quot;&gt;4.6.3 空间分配担保失败&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#464-jdk-17-及以前的永久代空间不足&quot;&gt;4.6.4 JDK 1.7 及以前的永久代空间不足&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#465-concurrent-mode-failure&quot;&gt;4.6.5 Concurrent Mode Failure&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#类加载机制&quot;&gt;类加载机制&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-类的生命周期&quot;&gt;1 类的生命周期&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-类初始化时机&quot;&gt;2. 类初始化时机&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-类加载过程&quot;&gt;3. 类加载过程&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#31-加载&quot;&gt;3.1 加载&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32-验证&quot;&gt;3.2 验证&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#33-准备&quot;&gt;3.3 准备&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#34-解析&quot;&gt;3.4 解析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#35-初始化&quot;&gt;3.5 初始化&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-类加载器&quot;&gt;4. 类加载器&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#41-类与类加载器&quot;&gt;4.1 类与类加载器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-类加载器分类&quot;&gt;4.2 类加载器分类&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#43-双亲委派模型&quot;&gt;4.3 双亲委派模型&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#jvm-参数&quot;&gt;JVM 参数&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#gc-优化配置&quot;&gt;GC 优化配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gc-类型设置&quot;&gt;GC 类型设置&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;内存模型&quot;&gt;&lt;a href=&quot;#内存模型&quot; class=&quot;headerlink&quot; title=&quot;内存模型&quot;&gt;&lt;/a&gt;内存模型&lt;/h1&gt;&lt;p&gt;&lt;br&gt;&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;/pics/dc695f48-4189-4fc7-b950-ed25f6c80f82.jpg&quot;&gt; &lt;/div&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;注：白色区域为线程私有的，蓝色区域为线程共享的。&lt;/p&gt;
&lt;h2 id=&quot;1-程序计数器&quot;&gt;&lt;a href=&quot;#1-程序计数器&quot; class=&quot;headerlink&quot; title=&quot;1. 程序计数器&quot;&gt;&lt;/a&gt;1. 程序计数器&lt;/h2&gt;&lt;p&gt;记录正在执行的虚拟机字节码指令的地址（如果正在执行的是 Native 方法则为空）。&lt;/p&gt;
&lt;h2 id=&quot;2-Java-虚拟机栈&quot;&gt;&lt;a href=&quot;#2-Java-虚拟机栈&quot; class=&quot;headerlink&quot; title=&quot;2. Java 虚拟机栈&quot;&gt;&lt;/a&gt;2. Java 虚拟机栈&lt;/h2&gt;&lt;p&gt;每个 Java 方法在执行的同时会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在 Java 虚拟机栈中入栈和出栈的过程。&lt;/p&gt;
&lt;p&gt;该区域可能抛出以下异常：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;当线程请求的栈深度超过最大值，会抛出 StackOverflowError 异常；&lt;/li&gt;
&lt;li&gt;栈进行动态扩展时如果无法申请到足够内存，会抛出 OutOfMemoryError 异常。&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>剑指 offer 题解</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E5%89%91%E6%8C%87%20offer%20%E9%A2%98%E8%A7%A3.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/剑指 offer 题解.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:34:38.363Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#第二章-面试需要的基础知识">第二章 面试需要的基础知识</a><ul><li><a href="#2-实现-singleton">2. 实现 Singleton</a></li><li><a href="#3-数组中重复的数字">3. 数组中重复的数字</a></li><li><a href="#4-二维数组中的查找">4. 二维数组中的查找</a></li><li><a href="#5-替换空格">5. 替换空格</a></li><li><a href="#6-从尾到头打印链表">6. 从尾到头打印链表</a></li><li><a href="#7-重建二叉树">7. 重建二叉树</a></li><li><a href="#8-二叉树的下一个结点">8. 二叉树的下一个结点</a></li><li><a href="#9-用两个栈实现队列">9. 用两个栈实现队列</a></li><li><a href="#101-斐波那契数列">10.1 斐波那契数列</a></li><li><a href="#102-跳台阶">10.2 跳台阶</a></li><li><a href="#103-变态跳台阶">10.3 变态跳台阶</a></li><li><a href="#104-矩形覆盖">10.4 矩形覆盖</a></li><li><a href="#11-旋转数组的最小数字">11. 旋转数组的最小数字</a></li><li><a href="#12-矩阵中的路径">12. 矩阵中的路径</a></li><li><a href="#13-机器人的运动范围">13. 机器人的运动范围</a></li><li><a href="#14-剪绳子">14. 剪绳子</a></li><li><a href="#15-二进制中-1-的个数">15. 二进制中 1 的个数</a></li></ul></li><li><a href="#第三章-高质量的代码">第三章 高质量的代码</a><ul><li><a href="#16-数值的整数次方">16. 数值的整数次方</a></li><li><a href="#17-打印从-1-到最大的-n-位数">17. 打印从 1 到最大的 n 位数</a></li><li><a href="#181-在-o1-时间内删除链表节点">18.1 在 O(1) 时间内删除链表节点</a></li><li><a href="#182-删除链表中重复的结点">18.2 删除链表中重复的结点</a></li><li><a href="#19-正则表达式匹配">19. 正则表达式匹配</a></li><li><a href="#20-表示数值的字符串">20. 表示数值的字符串</a></li><li><a href="#21-调整数组顺序使奇数位于偶数前面">21. 调整数组顺序使奇数位于偶数前面</a></li><li><a href="#22-链表中倒数第-k-个结点">22. 链表中倒数第 k 个结点</a></li><li><a href="#23-链表中环的入口结点">23. 链表中环的入口结点</a></li><li><a href="#24-反转链表">24. 反转链表</a></li><li><a href="#25-合并两个排序的链表">25. 合并两个排序的链表</a></li><li><a href="#26-树的子结构">26. 树的子结构</a></li></ul></li><li><a href="#第四章-解决面试题的思路">第四章 解决面试题的思路</a><ul><li><a href="#27-二叉树的镜像">27. 二叉树的镜像</a></li><li><a href="#281-对称的二叉树">28.1 对称的二叉树</a></li><li><a href="#282-平衡二叉树">28.2 平衡二叉树</a></li><li><a href="#29-顺时针打印矩阵">29. 顺时针打印矩阵</a></li><li><a href="#30-包含-min-函数的栈">30. 包含 min 函数的栈</a></li><li><a href="#31-栈的压入弹出序列">31. 栈的压入、弹出序列</a></li><li><a href="#321-从上往下打印二叉树">32.1 从上往下打印二叉树</a></li><li><a href="#323--把二叉树打印成多行">32.3  把二叉树打印成多行</a></li><li><a href="#323-按之字形顺序打印二叉树">32.3 按之字形顺序打印二叉树</a></li><li><a href="#33-二叉搜索树的后序遍历序列">33. 二叉搜索树的后序遍历序列</a></li><li><a href="#34-二叉树中和为某一值的路径">34. 二叉树中和为某一值的路径</a></li><li><a href="#35-复杂链表的复制">35. 复杂链表的复制</a></li><li><a href="#36-二叉搜索树与双向链表">36. 二叉搜索树与双向链表</a></li><li><a href="#37-序列化二叉树">37. 序列化二叉树</a></li><li><a href="#38-字符串的排列">38. 字符串的排列</a></li></ul></li><li><a href="#第五章-优化时间和空间效率">第五章 优化时间和空间效率</a><ul><li><a href="#39-数组中出现次数超过一半的数字">39. 数组中出现次数超过一半的数字</a></li><li><a href="#40-最小的-k-个数">40. 最小的 K 个数</a></li><li><a href="#411-数据流中的中位数">41.1 数据流中的中位数</a></li><li><a href="#412-字符流中第一个不重复的字符">41.2 字符流中第一个不重复的字符</a></li><li><a href="#42-连续子数组的最大和">42. 连续子数组的最大和</a></li><li><a href="#43-从-1-到-n-整数中-1-出现的次数">43. 从 1 到 n 整数中 1 出现的次数</a></li><li><a href="#44-数字序列中的某一位数字">44. 数字序列中的某一位数字</a></li><li><a href="#45-把数组排成最小的数">45. 把数组排成最小的数</a></li><li><a href="#46-把数字翻译成字符串">46. 把数字翻译成字符串</a></li><li><a href="#47-礼物的最大价值">47. 礼物的最大价值</a></li><li><a href="#48-最长不含重复字符的子字符串">48. 最长不含重复字符的子字符串</a></li><li><a href="#49-丑数">49. 丑数</a></li><li><a href="#50-第一个只出现一次的字符位置">50. 第一个只出现一次的字符位置</a></li><li><a href="#51-数组中的逆序对">51. 数组中的逆序对</a></li><li><a href="#52-两个链表的第一个公共结点">52. 两个链表的第一个公共结点</a></li></ul></li><li><a href="#第六章-面试中的各项能力">第六章 面试中的各项能力</a><ul><li><a href="#53-数字在排序数组中出现的次数">53 数字在排序数组中出现的次数</a></li><li><a href="#54-二叉搜索树的第-k-个结点">54. 二叉搜索树的第 k 个结点</a></li><li><a href="#55-二叉树的深度">55 二叉树的深度</a></li><li><a href="#56-数组中只出现一次的数字">56. 数组中只出现一次的数字</a></li><li><a href="#571-和为-s-的两个数字">57.1 和为 S 的两个数字</a></li><li><a href="#572-和为-s-的连续正数序列">57.2 和为 S 的连续正数序列</a></li><li><a href="#581-翻转单词顺序列">58.1 翻转单词顺序列</a></li><li><a href="#582-左旋转字符串">58.2 左旋转字符串</a></li><li><a href="#59-滑动窗口的最大值">59. 滑动窗口的最大值</a></li><li><a href="#60-n-个骰子的点数">60. n 个骰子的点数</a></li><li><a href="#61-扑克牌顺子">61. 扑克牌顺子</a></li><li><a href="#62-圆圈中最后剩下的数">62. 圆圈中最后剩下的数</a></li><li><a href="#63-股票的最大利润">63. 股票的最大利润</a></li><li><a href="#64-求-1+2+3++n">64. 求 1+2+3+…+n</a></li><li><a href="#65-不用加减乘除做加法">65. 不用加减乘除做加法</a></li><li><a href="#66-构建乘积数组">66. 构建乘积数组</a></li></ul></li><li><a href="#第七章-两个面试案例">第七章 两个面试案例</a><ul><li><a href="#67-把字符串转换成整数">67. 把字符串转换成整数</a></li><li><a href="#68-树中两个节点的最低公共祖先">68. 树中两个节点的最低公共祖先</a><!-- GFM-TOC --></li></ul></li></ul><h1 id="第二章-面试需要的基础知识"><a href="#第二章-面试需要的基础知识" class="headerlink" title="第二章 面试需要的基础知识"></a>第二章 面试需要的基础知识</h1><h2 id="2-实现-Singleton"><a href="#2-实现-Singleton" class="headerlink" title="2. 实现 Singleton"></a>2. 实现 Singleton</h2><p><a href="https://github.com/CyC2018/InterviewNotes/blob/master/notes/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.md#%E7%AC%AC-5-%E7%AB%A0-%E5%8D%95%E4%BB%B6%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener"> 单例模式 </a></p><h2 id="3-数组中重复的数字"><a href="#3-数组中重复的数字" class="headerlink" title="3. 数组中重复的数字"></a>3. 数组中重复的数字</h2><a id="more"></a><p><strong>题目描述</strong> </p><p>在一个长度为 n 的数组里的所有数字都在 0 到 n-1 的范围内。数组中某些数字是重复的，但不知道有几个数字是重复的。也不知道每个数字重复几次。请找出数组中任意一个重复的数字。例如，如果输入长度为 7 的数组 {2, 3, 1, 0, 2, 5, 3}，那么对应的输出是第一个重复的数字 2。</p><p><strong>解题思路</strong> </p><p>这种数组元素在 [0, n-1] 范围内的问题，可以将值为 i 的元素放到第 i 个位置上。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">duplicate</span><span class="params">(<span class="keyword">int</span>[] numbers, <span class="keyword">int</span> length, <span class="keyword">int</span>[] duplication)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(numbers == <span class="keyword">null</span> || length &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (numbers[i] != i &amp;&amp; numbers[i] != numbers[numbers[i]]) &#123;</span><br><span class="line">            swap(numbers, i, numbers[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (numbers[i] != i &amp;&amp; numbers[i] == numbers[numbers[i]]) &#123;</span><br><span class="line">            duplication[<span class="number">0</span>] = numbers[i];</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] numbers, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t = numbers[i];</span><br><span class="line">    numbers[i] = numbers[j];</span><br><span class="line">    numbers[j] = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-二维数组中的查找"><a href="#4-二维数组中的查找" class="headerlink" title="4. 二维数组中的查找"></a>4. 二维数组中的查找</h2><p><strong>题目描述</strong> </p><p>在一个二维数组中，每一行都按照从左到右递增的顺序排序，每一列都按照从上到下递增的顺序排序。请完成一个函数，输入这样的一个二维数组和一个整数，判断数组中是否含有该整数。</p><p><strong>解题思路</strong> </p><p>从右上角开始查找。因为矩阵中的一个数，它左边的数都比它来的小，下边的数都比它来的大。因此，从右上角开始查找，就可以根据 target 和当前元素的大小关系来改变行和列的下标，从而缩小查找区间。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">Find</span><span class="params">(<span class="keyword">int</span> target, <span class="keyword">int</span> [][] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array == <span class="keyword">null</span> || array.length == <span class="number">0</span> || array[<span class="number">0</span>].length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> m = array.length, n = array[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span> row = <span class="number">0</span>, col = n - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (row &lt; m &amp;&amp; col &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (target == array[row][col]) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (target &lt; array[row][col]) col--;</span><br><span class="line">        <span class="keyword">else</span> row++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-替换空格"><a href="#5-替换空格" class="headerlink" title="5. 替换空格"></a>5. 替换空格</h2><p><strong>题目描述</strong> </p><p>请实现一个函数，将一个字符串中的空格替换成“%20”。例如，当字符串为 We Are Happy. 则经过替换之后的字符串为 We%20Are%20Happy。</p><p><strong>题目要求</strong> </p><p>以 O(1) 的空间复杂度和 O(n) 的空间复杂度来求解。</p><p><strong>解题思路</strong> </p><p>从后向前改变字符串。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replaceSpace</span><span class="params">(StringBuffer str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = str.length();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.charAt(i) == <span class="string">' '</span>) str.append(<span class="string">"  "</span>); <span class="comment">// 尾部填充两个</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> idxOfOriginal = n - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> idxOfNew = str.length() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (idxOfOriginal &gt;= <span class="number">0</span> &amp;&amp; idxOfNew &gt; idxOfOriginal) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.charAt(idxOfOriginal) == <span class="string">' '</span>) &#123;</span><br><span class="line">            str.setCharAt(idxOfNew--, <span class="string">'0'</span>);</span><br><span class="line">            str.setCharAt(idxOfNew--, <span class="string">'2'</span>);</span><br><span class="line">            str.setCharAt(idxOfNew--, <span class="string">'%'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            str.setCharAt(idxOfNew--, str.charAt(idxOfOriginal));</span><br><span class="line">        &#125;</span><br><span class="line">        idxOfOriginal--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-从尾到头打印链表"><a href="#6-从尾到头打印链表" class="headerlink" title="6. 从尾到头打印链表"></a>6. 从尾到头打印链表</h2><p>正向遍历然后调用 Collections.reverse()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">printListFromTailToHead</span><span class="params">(ListNode listNode)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (listNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ret.add(listNode.val);</span><br><span class="line">        listNode = listNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    Collections.reverse(ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Stack</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">printListFromTailToHead</span><span class="params">(ListNode listNode)</span> </span>&#123;</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (listNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">        stack.add(listNode.val);</span><br><span class="line">        listNode = listNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        ret.add(stack.pop());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>递归</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">printListFromTailToHead</span><span class="params">(ListNode listNode)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(listNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ret.addAll(printListFromTailToHead(listNode.next));</span><br><span class="line">        ret.add(listNode.val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不使用库函数，并且不使用递归的迭代实现，利用链表的头插法为逆序的特性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">printListFromTailToHead</span><span class="params">(ListNode listNode)</span> </span>&#123;</span><br><span class="line">    ListNode head = <span class="keyword">new</span> ListNode(-<span class="number">1</span>); <span class="comment">// 头结点</span></span><br><span class="line">    ListNode cur = listNode;</span><br><span class="line">    <span class="keyword">while</span> (cur != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ListNode next = cur.next;</span><br><span class="line">        cur.next = head.next;</span><br><span class="line">        head.next = cur;</span><br><span class="line">        cur = next;</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    head = head.next;</span><br><span class="line">    <span class="keyword">while</span> (head != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ret.add(head.val);</span><br><span class="line">        head = head.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-重建二叉树"><a href="#7-重建二叉树" class="headerlink" title="7. 重建二叉树"></a>7. 重建二叉树</h2><p><strong>题目描述</strong> </p><p>根据二叉树的前序遍历和中序遍历的结果，重建出该二叉树。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">reConstructBinaryTree</span><span class="params">(<span class="keyword">int</span>[] pre, <span class="keyword">int</span>[] in)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> reConstructBinaryTree(pre, <span class="number">0</span>, pre.length - <span class="number">1</span>, in, <span class="number">0</span>, in.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">reConstructBinaryTree</span><span class="params">(<span class="keyword">int</span>[] pre, <span class="keyword">int</span> preL, <span class="keyword">int</span> preR, <span class="keyword">int</span>[] in, <span class="keyword">int</span> inL, <span class="keyword">int</span> inR)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (preL == preR) <span class="keyword">return</span> <span class="keyword">new</span> TreeNode(pre[preL]);</span><br><span class="line">    <span class="keyword">if</span> (preL &gt; preR || inL &gt; inR) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    TreeNode root = <span class="keyword">new</span> TreeNode(pre[preL]);</span><br><span class="line">    <span class="keyword">int</span> midIdx = inL;</span><br><span class="line">    <span class="keyword">while</span> (midIdx &lt;= inR &amp;&amp; in[midIdx] != root.val) midIdx++;</span><br><span class="line">    <span class="keyword">int</span> leftTreeSize = midIdx - inL;</span><br><span class="line">    root.left = reConstructBinaryTree(pre, preL + <span class="number">1</span>, preL + leftTreeSize, in, inL, inL + leftTreeSize - <span class="number">1</span>);</span><br><span class="line">    root.right = reConstructBinaryTree(pre, preL + leftTreeSize + <span class="number">1</span>, preR, in, inL + leftTreeSize + <span class="number">1</span>, inR);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8-二叉树的下一个结点"><a href="#8-二叉树的下一个结点" class="headerlink" title="8. 二叉树的下一个结点"></a>8. 二叉树的下一个结点</h2><p><strong>题目描述</strong> </p><p>给定一个二叉树和其中的一个结点，请找出中序遍历顺序的下一个结点并且返回。注意，树中的结点不仅包含左右子结点，同时包含指向父结点的指针。</p><p><strong>解题思路</strong> </p><ul><li>如果一个节点有右子树不为空，那么该节点的下一个节点是右子树的最左节点；</li><li>否则，向上找第一个左链接指向的树包含该节点的祖先节点。</li></ul><p><br><div align="center"> <img src="../pics/6fec7f56-a685-4232-b03e-c92a8dfba486.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeLinkNode <span class="title">GetNext</span><span class="params">(TreeLinkNode pNode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pNode == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (pNode.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pNode = pNode.right;</span><br><span class="line">        <span class="keyword">while</span> (pNode.left != <span class="keyword">null</span>) pNode = pNode.left;</span><br><span class="line">        <span class="keyword">return</span> pNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        TreeLinkNode parent = pNode.next;</span><br><span class="line">        <span class="keyword">while</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parent.left == pNode) <span class="keyword">return</span> parent;</span><br><span class="line">            pNode = pNode.next;</span><br><span class="line">            parent = pNode.next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-用两个栈实现队列"><a href="#9-用两个栈实现队列" class="headerlink" title="9. 用两个栈实现队列"></a>9. 用两个栈实现队列</h2><p><strong>解题思路</strong> </p><p>添加到栈中的序列顺序会被反转，如果进行两次反转，那么得到的序列依然是正向的。因此，添加的数据需要同时压入两个栈之后才能出栈，这样就能保证出栈的顺序为先进先出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Stack&lt;Integer&gt; stack1 = <span class="keyword">new</span> Stack&lt;Integer&gt;();</span><br><span class="line">Stack&lt;Integer&gt; stack2 = <span class="keyword">new</span> Stack&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> node)</span> </span>&#123;</span><br><span class="line">    stack1.push(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (stack2.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">while</span> (!stack1.isEmpty()) &#123;</span><br><span class="line">            stack2.push(stack1.pop());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stack2.pop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-1-斐波那契数列"><a href="#10-1-斐波那契数列" class="headerlink" title="10.1 斐波那契数列"></a>10.1 斐波那契数列</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] fib = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">40</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Solution</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    fib[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    fib[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; fib.length; i++) &#123;</span><br><span class="line">        fib[i] = fib[i - <span class="number">1</span>] + fib[i - <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Fibonacci</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fib[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-2-跳台阶"><a href="#10-2-跳台阶" class="headerlink" title="10.2 跳台阶"></a>10.2 跳台阶</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">JumpFloor</span><span class="params">(<span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[target];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    dp[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; dp.length; i++) &#123;</span><br><span class="line">        dp[i] = dp[i - <span class="number">1</span>] + dp[i - <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[target - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-3-变态跳台阶"><a href="#10-3-变态跳台阶" class="headerlink" title="10.3 变态跳台阶"></a>10.3 变态跳台阶</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">JumpFloorII</span><span class="params">(<span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[target];</span><br><span class="line">    Arrays.fill(dp, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; target; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">            dp[i] += dp[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[target - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="10-4-矩形覆盖"><a href="#10-4-矩形覆盖" class="headerlink" title="10.4 矩形覆盖"></a>10.4 矩形覆盖</h2><p><strong>题目描述</strong> </p><p>我们可以用 2*1 的小矩形横着或者竖着去覆盖更大的矩形。请问用 n 个 2*1 的小矩形无重叠地覆盖一个 2*n 的大矩形，总共有多少种方法？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">RectCover</span><span class="params">(<span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target &lt;= <span class="number">2</span>) <span class="keyword">return</span> target;</span><br><span class="line">    <span class="keyword">return</span> RectCover(target - <span class="number">1</span>) + RectCover(target - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="11-旋转数组的最小数字"><a href="#11-旋转数组的最小数字" class="headerlink" title="11. 旋转数组的最小数字"></a>11. 旋转数组的最小数字</h2><p><strong>题目描述</strong> </p><p>把一个数组最开始的若干个元素搬到数组的末尾，我们称之为数组的旋转。输入一个非递减排序的数组的一个旋转，输出旋转数组的最小元素。例如数组 {3, 4, 5, 1, 2} 为 {1, 2, 3, 4, 5} 的一个旋转，该数组的最小值为 1。NOTE：给出的所有元素都大于 0，若数组大小为 0，请返回 0。</p><p>O(N) 时间复杂度解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minNumberInRotateArray</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (array[i] &gt; array[i + <span class="number">1</span>]) <span class="keyword">return</span> array[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>O(lgN) 时间复杂度解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minNumberInRotateArray</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = array.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (array[l] &gt;= array[r]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r - l == <span class="number">1</span>) <span class="keyword">return</span> array[r];</span><br><span class="line">        mid = l + (r - l) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (array[mid] &gt;= array[l]) l = mid;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (array[mid] &lt;= array[r]) r = mid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> array[mid];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="12-矩阵中的路径"><a href="#12-矩阵中的路径" class="headerlink" title="12. 矩阵中的路径"></a>12. 矩阵中的路径</h2><p><strong>题目描述</strong> </p><p>请设计一个函数，用来判断在一个矩阵中是否存在一条包含某字符串所有字符的路径。路径可以从矩阵中的任意一个格子开始，每一步可以在矩阵中向左，向右，向上，向下移动一个格子。如果一条路径经过了矩阵中的某一个格子，则该路径不能再进入该格子。例如 a b c e s f c s a d e e 矩阵中包含一条字符串 “bcced” 的路径，但是矩阵中不包含 “abcb” 路径，因为字符串的第一个字符 b 占据了矩阵中的第一行第二个格子之后，路径不能再次进入该格子。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[][] next = &#123;&#123;<span class="number">0</span>, -<span class="number">1</span>&#125;, &#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> rows;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cols;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPath</span><span class="params">(<span class="keyword">char</span>[] matrix, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols, <span class="keyword">char</span>[] str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rows == <span class="number">0</span> || cols == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.rows = rows;</span><br><span class="line">    <span class="keyword">this</span>.cols = cols;</span><br><span class="line">    <span class="comment">// 一维数组重建二维矩阵</span></span><br><span class="line">    <span class="keyword">char</span>[][] newMatrix = <span class="keyword">new</span> <span class="keyword">char</span>[rows][cols];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, idx = <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            newMatrix[i][j] = matrix[idx++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (backtracking(newMatrix, str, <span class="keyword">new</span> <span class="keyword">boolean</span>[rows][cols], <span class="number">0</span>, i, j)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">backtracking</span><span class="params">(<span class="keyword">char</span>[][] matrix, <span class="keyword">char</span>[] str, <span class="keyword">boolean</span>[][] used, <span class="keyword">int</span> pathLen, <span class="keyword">int</span> curR, <span class="keyword">int</span> curC)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pathLen == str.length) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (curR &lt; <span class="number">0</span> || curR &gt;= rows || curC &lt; <span class="number">0</span> || curC &gt;= cols) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (matrix[curR][curC] != str[pathLen]) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (used[curR][curC]) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    used[curR][curC] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; next.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (backtracking(matrix, str, used, pathLen + <span class="number">1</span>, curR + next[i][<span class="number">0</span>], curC + next[i][<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    used[curR][curC] = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="13-机器人的运动范围"><a href="#13-机器人的运动范围" class="headerlink" title="13. 机器人的运动范围"></a>13. 机器人的运动范围</h2><p><strong>题目描述</strong> </p><p>地上有一个 m 行和 n 列的方格。一个机器人从坐标 (0, 0) 的格子开始移动，每一次只能向左右上下四个方向移动一格，但是不能进入行坐标和列坐标的数位之和大于 k 的格子。例如，当 k 为 18 时，机器人能够进入方格（35, 37），因为 3+5+3+7=18。但是，它不能进入方格（35, 38），因为 3+5+3+8=19。请问该机器人能够达到多少个格子？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[][] next = &#123;&#123;<span class="number">0</span>, -<span class="number">1</span>&#125;, &#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[][] digitSum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">movingCount</span><span class="params">(<span class="keyword">int</span> threshold, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols)</span> </span>&#123;</span><br><span class="line">    initDigitSum(rows, cols);</span><br><span class="line">    dfs(<span class="keyword">new</span> <span class="keyword">boolean</span>[rows][cols], threshold, rows, cols, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">boolean</span>[][] visited, <span class="keyword">int</span> threshold, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols, <span class="keyword">int</span> r, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span> || r &gt;= rows || c &lt; <span class="number">0</span> || c &gt;= cols) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (visited[r][c]) <span class="keyword">return</span>;</span><br><span class="line">    visited[r][c] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.digitSum[r][c] &gt; threshold) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">this</span>.cnt++;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.next.length; i++) &#123;</span><br><span class="line">        dfs(visited, threshold, rows, cols, r + next[i][<span class="number">0</span>], c + next[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDigitSum</span><span class="params">(<span class="keyword">int</span> rows, <span class="keyword">int</span> cols)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] digitSumOne = <span class="keyword">new</span> <span class="keyword">int</span>[Math.max(rows, cols)];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; digitSumOne.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = i;</span><br><span class="line">        <span class="keyword">while</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            digitSumOne[i] += n % <span class="number">10</span>;</span><br><span class="line">            n /= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.digitSum = <span class="keyword">new</span> <span class="keyword">int</span>[rows][cols];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.digitSum[i][j] = digitSumOne[i] + digitSumOne[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="14-剪绳子"><a href="#14-剪绳子" class="headerlink" title="14. 剪绳子"></a>14. 剪绳子</h2><p><strong>题目描述</strong> </p><p>把一根绳子剪成多段，并且使得每段的长度乘积最大。</p><p><strong>动态规划解法</strong> </p><p><a href="https://github.com/CyC2018/InterviewNotes/blob/master/notes/Leetcode%20%E9%A2%98%E8%A7%A3.md#%E5%88%86%E5%89%B2%E6%95%B4%E6%95%B0" target="_blank" rel="noopener"> 分割整数 </a></p><p><strong>贪心解法</strong> </p><p>尽可能多得剪长度为 3 的绳子，并且不允许有长度为 1 的绳子出现，如果出现了，就从已经切好长度为 3 的绳子中拿出一段与长度为 1 的绳子重新组合，把它们切成两段长度为 2 的绳子。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxProductAfterCuttin</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (length &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">3</span>) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> timesOf3 = length / <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> (length - timesOf3 * <span class="number">3</span> == <span class="number">1</span>) timesOf3--;</span><br><span class="line">    <span class="keyword">int</span> timesOf2 = (length - timesOf3 * <span class="number">3</span>) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) (Math.pow(<span class="number">3</span>, timesOf3)) * (<span class="keyword">int</span>) (Math.pow(<span class="number">2</span>, timesOf2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="15-二进制中-1-的个数"><a href="#15-二进制中-1-的个数" class="headerlink" title="15. 二进制中 1 的个数"></a>15. 二进制中 1 的个数</h2><p>使用库函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">NumberOf1</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.bitCount(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>O(lgM) 时间复杂度解法，其中 M 表示 1 的个数：</p><p>n&amp;(n-1) 该位运算是去除 n 的位级表示中最低的那一位。例如对于二进制表示 10110100，减去 1 得到 10110011，这两个数相与得到 10110000。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">NumberOf1</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">        cnt++;</span><br><span class="line">        n &amp;= (n - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="第三章-高质量的代码"><a href="#第三章-高质量的代码" class="headerlink" title="第三章 高质量的代码"></a>第三章 高质量的代码</h1><h2 id="16-数值的整数次方"><a href="#16-数值的整数次方" class="headerlink" title="16. 数值的整数次方"></a>16. 数值的整数次方</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">Power</span><span class="params">(<span class="keyword">double</span> base, <span class="keyword">int</span> exponent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (exponent == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (exponent == <span class="number">1</span>) <span class="keyword">return</span> base;</span><br><span class="line">    <span class="keyword">boolean</span> isNegative = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (exponent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        exponent = -exponent;</span><br><span class="line">        isNegative = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">double</span> pow = Power(base * base, exponent / <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (exponent % <span class="number">2</span> != <span class="number">0</span>) pow = pow * base;</span><br><span class="line">    <span class="keyword">return</span> isNegative ? <span class="number">1</span> / pow : pow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="17-打印从-1-到最大的-n-位数"><a href="#17-打印从-1-到最大的-n-位数" class="headerlink" title="17. 打印从 1 到最大的 n 位数"></a>17. 打印从 1 到最大的 n 位数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print1ToMaxOfNDigits</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">char</span>[] number = <span class="keyword">new</span> <span class="keyword">char</span>[n];</span><br><span class="line">    print1ToMaxOfNDigits(number, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">print1ToMaxOfNDigits</span><span class="params">(<span class="keyword">char</span>[] number, <span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (idx == number.length - <span class="number">1</span>) &#123;</span><br><span class="line">        printNumber(number);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        number[idx + <span class="number">1</span>] = (<span class="keyword">char</span>) (i + <span class="string">'0'</span>);</span><br><span class="line">        print1ToMaxOfNDigits(number, idx + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printNumber</span><span class="params">(<span class="keyword">char</span>[] number)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> isBeginWith0 = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c : number) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBeginWith0 &amp;&amp; c != <span class="string">'0'</span>) isBeginWith0 = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(!isBeginWith0) System.out.print(c);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="18-1-在-O-1-时间内删除链表节点"><a href="#18-1-在-O-1-时间内删除链表节点" class="headerlink" title="18.1 在 O(1) 时间内删除链表节点"></a>18.1 在 O(1) 时间内删除链表节点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">deleteNode</span><span class="params">(ListNode head, ListNode tobeDelete)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span> || head.next == <span class="keyword">null</span> || tobeDelete == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (tobeDelete.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 要删除的节点不是尾节点</span></span><br><span class="line">        ListNode next = tobeDelete.next;</span><br><span class="line">        tobeDelete.val = next.val;</span><br><span class="line">        tobeDelete.next = next.next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ListNode cur = head;</span><br><span class="line">        <span class="keyword">while</span> (cur.next != tobeDelete) cur = cur.next;</span><br><span class="line">        cur.next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="18-2-删除链表中重复的结点"><a href="#18-2-删除链表中重复的结点" class="headerlink" title="18.2 删除链表中重复的结点"></a>18.2 删除链表中重复的结点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">deleteDuplication</span><span class="params">(ListNode pHead)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pHead == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (pHead.next == <span class="keyword">null</span>) <span class="keyword">return</span> pHead;</span><br><span class="line">    <span class="keyword">if</span> (pHead.val == pHead.next.val) &#123;</span><br><span class="line">        ListNode next = pHead.next;</span><br><span class="line">        <span class="keyword">while</span> (next != <span class="keyword">null</span> &amp;&amp; pHead.val == next.val) &#123;</span><br><span class="line">            next = next.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> deleteDuplication(next);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pHead.next = deleteDuplication(pHead.next);</span><br><span class="line">        <span class="keyword">return</span> pHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="19-正则表达式匹配"><a href="#19-正则表达式匹配" class="headerlink" title="19. 正则表达式匹配"></a>19. 正则表达式匹配</h2><p><strong>题目描述</strong> </p><p>请实现一个函数用来匹配包括 ‘.’ 和 ‘*‘ 的正则表达式。模式中的字符 ‘.’ 表示任意一个字符，而 ‘*‘ 表示它前面的字符可以出现任意次（包含 0 次）。 在本题中，匹配是指字符串的所有字符匹配整个模式。例如，字符串 “aaa” 与模式 “a.a” 和 “ab*ac*a” 匹配，但是与 “aa.a” 和 “ab*a” 均不匹配</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(<span class="keyword">char</span>[] str, <span class="keyword">char</span>[] pattern)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = str.length, m = pattern.length;</span><br><span class="line">    <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[n + <span class="number">1</span>][m + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pattern[i - <span class="number">1</span>] == <span class="string">'*'</span>) dp[<span class="number">0</span>][i] = dp[<span class="number">0</span>][i - <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= m; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str[i - <span class="number">1</span>] == pattern[j - <span class="number">1</span>] || pattern[j - <span class="number">1</span>] == <span class="string">'.'</span>) dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (pattern[j - <span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pattern[j - <span class="number">2</span>] != str[i - <span class="number">1</span>] &amp;&amp; pattern[j - <span class="number">2</span>] != <span class="string">'.'</span>) dp[i][j] = dp[i][j - <span class="number">2</span>];</span><br><span class="line">                <span class="keyword">else</span> dp[i][j] = dp[i][j - <span class="number">1</span>] || dp[i][j - <span class="number">2</span>] || dp[i - <span class="number">1</span>][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n][m];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="20-表示数值的字符串"><a href="#20-表示数值的字符串" class="headerlink" title="20. 表示数值的字符串"></a>20. 表示数值的字符串</h2><p><strong>题目描述</strong> </p><p>请实现一个函数用来判断字符串是否表示数值（包括整数和小数）。例如，字符串 “+100”,”5e2”,”-123”,”3.1416” 和 “-1E-16” 都表示数值。 但是 “12e”,”1a3.14”,”1.2.3”,”+-5” 和 “12e+4.3” 都不是。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNumeric</span><span class="params">(<span class="keyword">char</span>[] str)</span> </span>&#123;</span><br><span class="line">    String string = String.valueOf(str);</span><br><span class="line">    <span class="keyword">return</span> string.matches(<span class="string">"[\\+-]?[0-9]*(\\.[0-9]*)?([eE][\\+-]?[0-9]+)?"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="21-调整数组顺序使奇数位于偶数前面"><a href="#21-调整数组顺序使奇数位于偶数前面" class="headerlink" title="21. 调整数组顺序使奇数位于偶数前面"></a>21. 调整数组顺序使奇数位于偶数前面</h2><p><strong>题目要求</strong> </p><p>保证奇数和奇数，偶数和偶数之间的相对位置不变，这和书本不太一样。</p><p>时间复杂度 : O(n<sup>2</sup>)<br>空间复杂度 : O(1)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reOrderArray</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = array.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (array[i] % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextOddIdx = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (nextOddIdx &lt; n &amp;&amp; array[nextOddIdx] % <span class="number">2</span> == <span class="number">0</span>) nextOddIdx++;</span><br><span class="line">            <span class="keyword">if</span> (nextOddIdx == n) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">int</span> nextOddVal = array[nextOddIdx];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = nextOddIdx; j &gt; i; j--) &#123;</span><br><span class="line">                array[j] = array[j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            array[i] = nextOddVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>时间复杂度 : O(n)<br>空间复杂度 : O(n)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reOrderArray</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> oddCnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : array) <span class="keyword">if</span> (num % <span class="number">2</span> == <span class="number">1</span>) oddCnt++;</span><br><span class="line">    <span class="keyword">int</span>[] copy = array.clone();</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = oddCnt;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : copy) &#123;</span><br><span class="line">        <span class="keyword">if</span> (num % <span class="number">2</span> == <span class="number">1</span>) array[i++] = num;</span><br><span class="line">        <span class="keyword">else</span> array[j++] = num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="22-链表中倒数第-k-个结点"><a href="#22-链表中倒数第-k-个结点" class="headerlink" title="22. 链表中倒数第 k 个结点"></a>22. 链表中倒数第 k 个结点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">FindKthToTail</span><span class="params">(ListNode head, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    ListNode fast, slow;</span><br><span class="line">    fast = slow = head;</span><br><span class="line">    <span class="keyword">while</span> (fast != <span class="keyword">null</span> &amp;&amp; k-- &gt; <span class="number">0</span>) fast = fast.next;</span><br><span class="line">    <span class="keyword">if</span> (k &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (fast != <span class="keyword">null</span>) &#123;</span><br><span class="line">        fast = fast.next;</span><br><span class="line">        slow = slow.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> slow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="23-链表中环的入口结点"><a href="#23-链表中环的入口结点" class="headerlink" title="23. 链表中环的入口结点"></a>23. 链表中环的入口结点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">EntryNodeOfLoop</span><span class="params">(ListNode pHead)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pHead == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    ListNode slow = pHead, fast = pHead;</span><br><span class="line">    <span class="keyword">while</span> (fast != <span class="keyword">null</span> &amp;&amp; fast.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">        fast = fast.next.next;</span><br><span class="line">        slow = slow.next;</span><br><span class="line">        <span class="keyword">if</span> (slow == fast) &#123;</span><br><span class="line">            fast = pHead;</span><br><span class="line">            <span class="keyword">while</span> (slow != fast) &#123;</span><br><span class="line">                slow = slow.next;</span><br><span class="line">                fast = fast.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> slow;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="24-反转链表"><a href="#24-反转链表" class="headerlink" title="24. 反转链表"></a>24. 反转链表</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">ReverseList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    ListNode newList = <span class="keyword">new</span> ListNode(-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (head != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ListNode next = head.next;</span><br><span class="line">        head.next = newList.next;</span><br><span class="line">        newList.next = head;</span><br><span class="line">        head = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newList.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="25-合并两个排序的链表"><a href="#25-合并两个排序的链表" class="headerlink" title="25. 合并两个排序的链表"></a>25. 合并两个排序的链表</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">Merge</span><span class="params">(ListNode list1, ListNode list2)</span> </span>&#123;</span><br><span class="line">    ListNode head = <span class="keyword">new</span> ListNode(-<span class="number">1</span>);</span><br><span class="line">    ListNode cur = head;</span><br><span class="line">    <span class="keyword">while</span> (list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (list1.val &lt; list2.val) &#123;</span><br><span class="line">            cur.next = list1;</span><br><span class="line">            list1 = list1.next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cur.next = list2;</span><br><span class="line">            list2 = list2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (list1 != <span class="keyword">null</span>) cur.next = list1;</span><br><span class="line">    <span class="keyword">if</span> (list2 != <span class="keyword">null</span>) cur.next = list2;</span><br><span class="line">    <span class="keyword">return</span> head.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="26-树的子结构"><a href="#26-树的子结构" class="headerlink" title="26. 树的子结构"></a>26. 树的子结构</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">HasSubtree</span><span class="params">(TreeNode root1, TreeNode root2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root1 == <span class="keyword">null</span> || root2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> isSubtree(root1, root2) || HasSubtree(root1.left, root2) || HasSubtree(root1.right, root2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSubtree</span><span class="params">(TreeNode root1, TreeNode root2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root1 == <span class="keyword">null</span> &amp;&amp; root2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (root1 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (root2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (root1.val != root2.val) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> isSubtree(root1.left, root2.left) &amp;&amp; isSubtree(root1.right, root2.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="第四章-解决面试题的思路"><a href="#第四章-解决面试题的思路" class="headerlink" title="第四章 解决面试题的思路"></a>第四章 解决面试题的思路</h1><h2 id="27-二叉树的镜像"><a href="#27-二叉树的镜像" class="headerlink" title="27. 二叉树的镜像"></a>27. 二叉树的镜像</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Mirror</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    TreeNode t = root.left;</span><br><span class="line">    root.left = root.right;</span><br><span class="line">    root.right = t;</span><br><span class="line">    Mirror(root.left);</span><br><span class="line">    Mirror(root.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="28-1-对称的二叉树"><a href="#28-1-对称的二叉树" class="headerlink" title="28.1 对称的二叉树"></a>28.1 对称的二叉树</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isSymmetrical</span><span class="params">(TreeNode pRoot)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pRoot == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> isSymmetrical(pRoot.left, pRoot.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isSymmetrical</span><span class="params">(TreeNode t1, TreeNode t2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (t1 == <span class="keyword">null</span> &amp;&amp; t2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (t1 == <span class="keyword">null</span> || t2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (t1.val != t2.val) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> isSymmetrical(t1.left, t2.right) &amp;&amp; isSymmetrical(t1.right, t2.left);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="28-2-平衡二叉树"><a href="#28-2-平衡二叉树" class="headerlink" title="28.2 平衡二叉树"></a>28.2 平衡二叉树</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isBalanced = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">IsBalanced_Solution</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    height(root);</span><br><span class="line">    <span class="keyword">return</span> isBalanced;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">height</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> left = height(root.left);</span><br><span class="line">    <span class="keyword">int</span> right = height(root.right);</span><br><span class="line">    <span class="keyword">if</span> (Math.abs(left - right) &gt; <span class="number">1</span>) isBalanced = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + Math.max(left, right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="29-顺时针打印矩阵"><a href="#29-顺时针打印矩阵" class="headerlink" title="29. 顺时针打印矩阵"></a>29. 顺时针打印矩阵</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">printMatrix</span><span class="params">(<span class="keyword">int</span>[][] matrix)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> r1 = <span class="number">0</span>, r2 = matrix.length - <span class="number">1</span>, c1 = <span class="number">0</span>, c2 = matrix[<span class="number">0</span>].length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (r1 &lt;= r2 &amp;&amp; c1 &lt;= c2) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = c1; i &lt;= c2; i++) ret.add(matrix[r1][i]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = r1 + <span class="number">1</span>; i &lt;= r2; i++) ret.add(matrix[i][c2]);</span><br><span class="line">        <span class="keyword">if</span> (r1 != r2) <span class="keyword">for</span> (<span class="keyword">int</span> i = c2 - <span class="number">1</span>; i &gt;= c1; i--) ret.add(matrix[r2][i]);</span><br><span class="line">        <span class="keyword">if</span> (c1 != c2) <span class="keyword">for</span> (<span class="keyword">int</span> i = r2 - <span class="number">1</span>; i &gt; r1; i--) ret.add(matrix[i][c1]);</span><br><span class="line">        r1++; r2--; c1++; c2--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="30-包含-min-函数的栈"><a href="#30-包含-min-函数的栈" class="headerlink" title="30. 包含 min 函数的栈"></a>30. 包含 min 函数的栈</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> Stack&lt;Integer&gt; minStack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> min = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> node)</span> </span>&#123;</span><br><span class="line">    stack.push(node);</span><br><span class="line">    <span class="keyword">if</span> (min &gt; node) min = node;</span><br><span class="line">    minStack.push(min);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stack.pop();</span><br><span class="line">    minStack.pop();</span><br><span class="line">    min = minStack.peek();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">top</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> stack.peek();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> minStack.peek();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="31-栈的压入、弹出序列"><a href="#31-栈的压入、弹出序列" class="headerlink" title="31. 栈的压入、弹出序列"></a>31. 栈的压入、弹出序列</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">IsPopOrder</span><span class="params">(<span class="keyword">int</span>[] pushA, <span class="keyword">int</span>[] popA)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = pushA.length;</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        stack.push(pushA[i]);</span><br><span class="line">        <span class="keyword">while</span> (j &lt; n &amp;&amp; stack.peek() == popA[j]) &#123;</span><br><span class="line">            stack.pop();</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stack.isEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="32-1-从上往下打印二叉树"><a href="#32-1-从上往下打印二叉树" class="headerlink" title="32.1 从上往下打印二叉树"></a>32.1 从上往下打印二叉树</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">PrintFromTopToBottom</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    queue.add(root);</span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">int</span> cnt = queue.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cnt; i++) &#123;</span><br><span class="line">            TreeNode t = queue.poll();</span><br><span class="line">            <span class="keyword">if</span> (t.left != <span class="keyword">null</span>) queue.add(t.left);</span><br><span class="line">            <span class="keyword">if</span> (t.right != <span class="keyword">null</span>) queue.add(t.right);</span><br><span class="line">            ret.add(t.val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="32-3-把二叉树打印成多行"><a href="#32-3-把二叉树打印成多行" class="headerlink" title="32.3  把二叉树打印成多行"></a>32.3  把二叉树打印成多行</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;ArrayList&lt;Integer&gt;&gt; Print(TreeNode pRoot) &#123;</span><br><span class="line">    ArrayList&lt;ArrayList&lt;Integer&gt;&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (pRoot == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    queue.add(pRoot);</span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">int</span> cnt = queue.size();</span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cnt; i++) &#123;</span><br><span class="line">            TreeNode node = queue.poll();</span><br><span class="line">            list.add(node.val);</span><br><span class="line">            <span class="keyword">if</span> (node.left != <span class="keyword">null</span>) queue.add(node.left);</span><br><span class="line">            <span class="keyword">if</span> (node.right != <span class="keyword">null</span>) queue.add(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">        ret.add(list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="32-3-按之字形顺序打印二叉树"><a href="#32-3-按之字形顺序打印二叉树" class="headerlink" title="32.3 按之字形顺序打印二叉树"></a>32.3 按之字形顺序打印二叉树</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; Print(TreeNode pRoot) &#123;</span><br><span class="line">    ArrayList&lt;ArrayList&lt;Integer&gt;&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (pRoot == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    queue.add(pRoot);</span><br><span class="line">    <span class="keyword">boolean</span> reverse = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">int</span> cnt = queue.size();</span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cnt; i++) &#123;</span><br><span class="line">            TreeNode node = queue.poll();</span><br><span class="line">            list.add(node.val);</span><br><span class="line">            <span class="keyword">if</span> (node.left != <span class="keyword">null</span>) queue.add(node.left);</span><br><span class="line">            <span class="keyword">if</span> (node.right != <span class="keyword">null</span>) queue.add(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (reverse) &#123;</span><br><span class="line">            Collections.reverse(list);</span><br><span class="line">            reverse = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reverse = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret.add(list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="33-二叉搜索树的后序遍历序列"><a href="#33-二叉搜索树的后序遍历序列" class="headerlink" title="33. 二叉搜索树的后序遍历序列"></a>33. 二叉搜索树的后序遍历序列</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">VerifySquenceOfBST</span><span class="params">(<span class="keyword">int</span>[] sequence)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sequence.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> verify(sequence, <span class="number">0</span>, sequence.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(<span class="keyword">int</span>[] sequence, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (end - start &lt;= <span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">int</span> rootVal = sequence[end];</span><br><span class="line">    <span class="keyword">int</span> cutIdx = start;</span><br><span class="line">    <span class="keyword">while</span> (cutIdx &lt; end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sequence[cutIdx] &gt; rootVal) <span class="keyword">break</span>;</span><br><span class="line">        cutIdx++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = cutIdx + <span class="number">1</span>; i &lt; end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sequence[i] &lt; rootVal) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> verify(sequence, start, cutIdx - <span class="number">1</span>) &amp;&amp; verify(sequence, cutIdx, end - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="34-二叉树中和为某一值的路径"><a href="#34-二叉树中和为某一值的路径" class="headerlink" title="34. 二叉树中和为某一值的路径"></a>34. 二叉树中和为某一值的路径</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; FindPath(TreeNode root, <span class="keyword">int</span> target) &#123;</span><br><span class="line">    dfs(root, target, <span class="number">0</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(TreeNode node, <span class="keyword">int</span> target, <span class="keyword">int</span> curSum, ArrayList&lt;Integer&gt; path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    curSum += node.val;</span><br><span class="line">    path.add(node.val);</span><br><span class="line">    <span class="keyword">if</span> (curSum == target &amp;&amp; node.left == <span class="keyword">null</span> &amp;&amp; node.right == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList(path));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dfs(node.left, target, curSum, path);</span><br><span class="line">        dfs(node.right, target, curSum, path);</span><br><span class="line">    &#125;</span><br><span class="line">    path.remove(path.size() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="35-复杂链表的复制"><a href="#35-复杂链表的复制" class="headerlink" title="35. 复杂链表的复制"></a>35. 复杂链表的复制</h2><p><strong>题目描述</strong> </p><p>输入一个复杂链表（每个节点中有节点值，以及两个指针，一个指向下一个节点，另一个特殊指针指向任意一个节点），返回结果为复制后复杂链表的 head。（注意，输出结果中请不要返回参数中的节点引用，否则判题程序会直接返回空）</p><p>第一步，在每个节点的后面插入复制的节点。</p><p><br><div align="center"> <img src="../pics/f8b12555-967b-423d-a84e-bc9eff104b8b.jpg"> </div><br></p><p>第二步，对复制节点的 random 链接进行赋值。</p><p><br><div align="center"> <img src="../pics/7b877a2a-8fd1-40d8-a34c-c445827300b8.jpg"> </div><br></p><p>第三步，拆分。</p><p><br><div align="center"> <img src="../pics/b2b6253c-c701-4b30-aff4-bc3c713542a7.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RandomListNode <span class="title">Clone</span><span class="params">(RandomListNode pHead)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pHead == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 插入新节点</span></span><br><span class="line">    RandomListNode cur = pHead;</span><br><span class="line">    <span class="keyword">while</span> (cur != <span class="keyword">null</span>) &#123;</span><br><span class="line">        RandomListNode node = <span class="keyword">new</span> RandomListNode(cur.label);</span><br><span class="line">        node.next = cur.next;</span><br><span class="line">        cur.next = node;</span><br><span class="line">        cur = node.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 建立 random 链接</span></span><br><span class="line">    cur = pHead;</span><br><span class="line">    <span class="keyword">while</span> (cur != <span class="keyword">null</span>) &#123;</span><br><span class="line">        RandomListNode clone = cur.next;</span><br><span class="line">        <span class="keyword">if</span> (cur.random != <span class="keyword">null</span>) &#123;</span><br><span class="line">            clone.random = cur.random.next;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = clone.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 拆分</span></span><br><span class="line">    RandomListNode pCloneHead = pHead.next;</span><br><span class="line">    cur = pHead;</span><br><span class="line">    <span class="keyword">while</span> (cur.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">        RandomListNode t = cur.next;</span><br><span class="line">        cur.next = t.next;</span><br><span class="line">        cur = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pCloneHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="36-二叉搜索树与双向链表"><a href="#36-二叉搜索树与双向链表" class="headerlink" title="36. 二叉搜索树与双向链表"></a>36. 二叉搜索树与双向链表</h2><p><strong>题目描述</strong> </p><p>输入一棵二叉搜索树，将该二叉搜索树转换成一个排序的双向链表。要求不能创建任何新的结点，只能调整树中结点指针的指向。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> TreeNode pre = <span class="keyword">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">Convert</span><span class="params">(TreeNode pRootOfTree)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pRootOfTree == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    inOrder(pRootOfTree);</span><br><span class="line">    <span class="keyword">while</span>(pRootOfTree.left != <span class="keyword">null</span>) pRootOfTree = pRootOfTree.left;</span><br><span class="line">    <span class="keyword">return</span> pRootOfTree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inOrder</span><span class="params">(TreeNode node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    inOrder(node.left);</span><br><span class="line">    node.left = pre;</span><br><span class="line">    <span class="keyword">if</span>(pre != <span class="keyword">null</span>) pre.right = node;</span><br><span class="line">    pre = node;</span><br><span class="line">    inOrder(node.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="37-序列化二叉树"><a href="#37-序列化二叉树" class="headerlink" title="37. 序列化二叉树"></a>37. 序列化二叉树</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String serizeString = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">String <span class="title">Serialize</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="string">"#"</span>;</span><br><span class="line">    <span class="keyword">return</span> root.val + <span class="string">" "</span> + Serialize(root.left) + <span class="string">" "</span></span><br><span class="line">        + Serialize(root.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TreeNode <span class="title">Deserialize</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.serizeString = str;</span><br><span class="line">    <span class="keyword">return</span> Deserialize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">Deserialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.serizeString.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> idx = <span class="keyword">this</span>.serizeString.indexOf(<span class="string">" "</span>);</span><br><span class="line">    <span class="keyword">if</span> (idx == -<span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    String sub = <span class="keyword">this</span>.serizeString.substring(<span class="number">0</span>, idx);</span><br><span class="line">    <span class="keyword">this</span>.serizeString = <span class="keyword">this</span>.serizeString.substring(idx + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (sub.equals(<span class="string">"#"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> val = Integer.valueOf(sub);</span><br><span class="line">    TreeNode t = <span class="keyword">new</span> TreeNode(val);</span><br><span class="line">    t.left = Deserialize();</span><br><span class="line">    t.right = Deserialize();</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="38-字符串的排列"><a href="#38-字符串的排列" class="headerlink" title="38. 字符串的排列"></a>38. 字符串的排列</h2><p><strong>题目描述</strong> </p><p>输入一个字符串 , 按字典序打印出该字符串中字符的所有排列。例如输入字符串 abc, 则打印出由字符 a, b, c 所能排列出来的所有字符串 abc, acb, bac, bca, cab 和 cba。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArrayList&lt;String&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;String&gt; <span class="title">Permutation</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">char</span>[] chars = str.toCharArray();</span><br><span class="line">    Arrays.sort(chars);</span><br><span class="line">    backtracking(chars, <span class="keyword">new</span> <span class="keyword">boolean</span>[chars.length], <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backtracking</span><span class="params">(<span class="keyword">char</span>[] chars, <span class="keyword">boolean</span>[] used, String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s.length() == chars.length) &#123;</span><br><span class="line">        ret.add(s);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (used[i]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; chars[i] == chars[i - <span class="number">1</span>] &amp;&amp; !used[i - <span class="number">1</span>]) <span class="keyword">continue</span>; <span class="comment">// 保证不重复</span></span><br><span class="line">        used[i] = <span class="keyword">true</span>;</span><br><span class="line">        backtracking(chars, used, s + chars[i]);</span><br><span class="line">        used[i] = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="第五章-优化时间和空间效率"><a href="#第五章-优化时间和空间效率" class="headerlink" title="第五章 优化时间和空间效率"></a>第五章 优化时间和空间效率</h1><h2 id="39-数组中出现次数超过一半的数字"><a href="#39-数组中出现次数超过一半的数字" class="headerlink" title="39. 数组中出现次数超过一半的数字"></a>39. 数组中出现次数超过一半的数字</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">MoreThanHalfNum_Solution</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">1</span>, num = array[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (array[i] == num) cnt++;</span><br><span class="line">        <span class="keyword">else</span> cnt--;</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="number">0</span>) &#123;</span><br><span class="line">            num = array[i];</span><br><span class="line">            cnt = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (num == array[i]) cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt &gt; array.length / <span class="number">2</span> ? num : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="40-最小的-K-个数"><a href="#40-最小的-K-个数" class="headerlink" title="40. 最小的 K 个数"></a>40. 最小的 K 个数</h2><p>构建大小为 k 的小顶堆。</p><p>时间复杂度：O(nlgk)<br>空间复杂度：O(k)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">GetLeastNumbers_Solution</span><span class="params">(<span class="keyword">int</span>[] input, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k &gt; input.length || k &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    PriorityQueue&lt;Integer&gt; pq = <span class="keyword">new</span> PriorityQueue&lt;&gt;((o1, o2) -&gt; o2 - o1);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : input) &#123;</span><br><span class="line">        pq.add(num);</span><br><span class="line">        <span class="keyword">if</span> (pq.size() &gt; k) &#123;</span><br><span class="line">            pq.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;(pq);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用快速选择</p><p>时间复杂度：O(n)<br>空间复杂度：O(1)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">GetLeastNumbers_Solution</span><span class="params">(<span class="keyword">int</span>[] input, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k &gt; input.length || k &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> kthSmallest = findKthSmallest(input, k - <span class="number">1</span>);</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : input) &#123;</span><br><span class="line">        <span class="keyword">if</span>(num &lt;= kthSmallest &amp;&amp; ret.size() &lt; k) ret.add(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findKthSmallest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> lo = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> hi = nums.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (lo &lt; hi) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = partition(nums, lo, hi);</span><br><span class="line">        <span class="keyword">if</span> (j &lt; k) &#123;</span><br><span class="line">            lo = j + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j &gt; k) &#123;</span><br><span class="line">            hi = j - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nums[k];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = lo;</span><br><span class="line">    <span class="keyword">int</span> j = hi + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; hi &amp;&amp; less(a[++i], a[lo])) ;</span><br><span class="line">        <span class="keyword">while</span> (j &gt; lo &amp;&amp; less(a[lo], a[--j])) ;</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= j) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        exch(a, i, j);</span><br><span class="line">    &#125;</span><br><span class="line">    exch(a, lo, j);</span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exch</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tmp = a[i];</span><br><span class="line">    a[i] = a[j];</span><br><span class="line">    a[j] = tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">less</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v &lt; w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="41-1-数据流中的中位数"><a href="#41-1-数据流中的中位数" class="headerlink" title="41.1 数据流中的中位数"></a>41.1 数据流中的中位数</h2><p><strong>题目描述</strong> </p><p>如何得到一个数据流中的中位数？如果从数据流中读出奇数个数值，那么中位数就是所有数值排序之后位于中间的数值。如果从数据流中读出偶数个数值，那么中位数就是所有数值排序之后中间两个数的平均值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PriorityQueue&lt;Integer&gt; maxHeap = <span class="keyword">new</span> PriorityQueue&lt;&gt;((o1, o2) -&gt; o2-o1); <span class="comment">// 实现左边部分</span></span><br><span class="line"><span class="keyword">private</span> PriorityQueue&lt;Integer&gt; minHeep = <span class="keyword">new</span> PriorityQueue&lt;&gt;(); <span class="comment">// 实现右边部分，右边部分所有元素大于左边部分</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(Integer num)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 插入要保证两个堆存于平衡状态</span></span><br><span class="line">    <span class="keyword">if</span>(cnt % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 为偶数的情况下插入到最小堆，先经过最大堆筛选，这样就能保证最大堆中的元素都小于最小堆中的元素</span></span><br><span class="line">        maxHeap.add(num);</span><br><span class="line">        minHeep.add(maxHeap.poll());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        minHeep.add(num);</span><br><span class="line">        maxHeap.add(minHeep.poll());</span><br><span class="line">    &#125;</span><br><span class="line">    cnt++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Double <span class="title">GetMedian</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(cnt % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (maxHeap.peek() + minHeep.peek()) / <span class="number">2.0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">double</span>) minHeep.peek();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="41-2-字符流中第一个不重复的字符"><a href="#41-2-字符流中第一个不重复的字符" class="headerlink" title="41.2 字符流中第一个不重复的字符"></a>41.2 字符流中第一个不重复的字符</h2><p><strong>题目描述</strong> </p><p>请实现一个函数用来找出字符流中第一个只出现一次的字符。例如，当从字符流中只读出前两个字符 “go” 时，第一个只出现一次的字符是 “g”。当从该字符流中读出前六个字符“google” 时，第一个只出现一次的字符是 “l”。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Insert one char from stringstream</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] cnts = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">private</span> Queue&lt;Character&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</span><br><span class="line">    cnts[ch]++;</span><br><span class="line">    queue.add(ch);</span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty() &amp;&amp; cnts[queue.peek()] &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        queue.poll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//return the first appearence once char in current stringstream</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">FirstAppearingOnce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (queue.isEmpty()) <span class="keyword">return</span> <span class="string">'#'</span>;</span><br><span class="line">    <span class="keyword">return</span> queue.peek();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="42-连续子数组的最大和"><a href="#42-连续子数组的最大和" class="headerlink" title="42. 连续子数组的最大和"></a>42. 连续子数组的最大和</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">FindGreatestSumOfSubArray</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(array.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = Integer.MIN_VALUE;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : array) &#123;</span><br><span class="line">        <span class="keyword">if</span>(sum &lt;= <span class="number">0</span>) sum = num;</span><br><span class="line">        <span class="keyword">else</span> sum += num;</span><br><span class="line">        ret = Math.max(ret, sum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="43-从-1-到-n-整数中-1-出现的次数"><a href="#43-从-1-到-n-整数中-1-出现的次数" class="headerlink" title="43. 从 1 到 n 整数中 1 出现的次数"></a>43. 从 1 到 n 整数中 1 出现的次数</h2><p>解题参考：<a href="https://leetcode.com/problems/number-of-digit-one/discuss/64381/4+-lines-O(log-n" target="_blank" rel="noopener">Leetcode : 233. Number of Digit One</a>-C++JavaPython)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">NumberOf1Between1AndN_Solution</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> m = <span class="number">1</span>; m &lt;= n; m *= <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> a = n / m, b = n % m;</span><br><span class="line">        cnt += (a + <span class="number">8</span>) / <span class="number">10</span> * m + (a % <span class="number">10</span> == <span class="number">1</span> ? b + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="44-数字序列中的某一位数字"><a href="#44-数字序列中的某一位数字" class="headerlink" title="44. 数字序列中的某一位数字"></a>44. 数字序列中的某一位数字</h2><p><strong>题目描述</strong> </p><p>数字以 0123456789101112131415… 的格式序列化到一个字符串中，求这个字符串的第 index 位。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">digitAtIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> digit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> amount = getAmountOfDigit(digit);</span><br><span class="line">        <span class="keyword">int</span> totalAmount = amount * digit;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; totalAmount) <span class="keyword">return</span> digitAtIndex(index, digit);</span><br><span class="line">        index -= totalAmount;</span><br><span class="line">        digit++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getAmountOfDigit</span><span class="params">(<span class="keyword">int</span> digit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (digit == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) Math.pow(<span class="number">10</span>, digit - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">digitAtIndex</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> digits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> number = beginNumber(digits) + index / digits;</span><br><span class="line">    <span class="keyword">int</span> remain = index % digits;</span><br><span class="line">    <span class="keyword">return</span> (number + <span class="string">""</span>).charAt(remain) - <span class="string">'0'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">beginNumber</span><span class="params">(<span class="keyword">int</span> digits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (digits == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) Math.pow(<span class="number">10</span>, digits - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Solution solution = <span class="keyword">new</span> Solution();</span><br><span class="line">    System.out.println(solution.digitAtIndex(<span class="number">1001</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="45-把数组排成最小的数"><a href="#45-把数组排成最小的数" class="headerlink" title="45. 把数组排成最小的数"></a>45. 把数组排成最小的数</h2><p><strong>题目描述</strong> </p><p>输入一个正整数数组，把数组里所有数字拼接起来排成一个数，打印能拼接出的所有数字中最小的一个。例如输入数组 {3，32，321}，则打印出这三个数字能排成的最小数字为 321323。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">PrintMinNumber</span><span class="params">(<span class="keyword">int</span>[] numbers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = numbers.length;</span><br><span class="line">    String[] nums = <span class="keyword">new</span> String[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) nums[i] = numbers[i] + <span class="string">""</span>;</span><br><span class="line">    Arrays.sort(nums, (s1, s2) -&gt; (s1 + s2).compareTo(s2 + s1));</span><br><span class="line">    String ret = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (String str : nums) ret += str;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="46-把数字翻译成字符串"><a href="#46-把数字翻译成字符串" class="headerlink" title="46. 把数字翻译成字符串"></a>46. 把数字翻译成字符串</h2><p><strong>题目描述</strong> </p><p>给定一个数字，按照如下规则翻译成字符串：0 翻译成“a”，1 翻译成“b”…25 翻译成“z”。一个数字有多种翻译可能，例如 12258 一共有 5 种，分别是 bccfi，bwfi，bczi，mcfi，mzi。实现一个函数，用来计算一个数字有多少种不同的翻译方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTranslationCount</span><span class="params">(String number)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = number.length();</span><br><span class="line">    <span class="keyword">int</span>[] counts = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    counts[n - <span class="number">1</span>] = counts[n] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        counts[i] = counts[i + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> converted = Integer.valueOf(number.substring(i, i + <span class="number">2</span>));</span><br><span class="line">        <span class="keyword">if</span> (converted &gt;= <span class="number">10</span> &amp;&amp; converted &lt;= <span class="number">25</span>) &#123;</span><br><span class="line">            counts[i] += counts[i + <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> counts[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="47-礼物的最大价值"><a href="#47-礼物的最大价值" class="headerlink" title="47. 礼物的最大价值"></a>47. 礼物的最大价值</h2><p><strong>题目描述</strong> </p><p>在一个 m * n 的棋盘的每一个格都放有一个礼物，每个礼物都有一定价值（大于 0）。从左上角开始拿礼物，每次向右或向下移动一格，直到右下角结束。给定一个棋盘，求拿到礼物的最大价值。例如，对于如下棋盘</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">1 </span>   <span class="number">10</span>   <span class="number">3</span>    <span class="number">8</span></span><br><span class="line"><span class="symbol">12 </span>  <span class="number">2</span>    <span class="number">9</span>    <span class="number">6</span></span><br><span class="line"><span class="symbol">5 </span>   <span class="number">7</span>    <span class="number">4</span>    <span class="number">11</span></span><br><span class="line"><span class="symbol">3 </span>   <span class="number">7</span>    <span class="number">16</span>   <span class="number">5</span></span><br></pre></td></tr></table></figure><p>礼物的最大价值为 1+12+5+7+7+16+5=53。</p><p><strong>解题思路</strong> </p><p>应该用动态规划求解，而不是深度优先搜索，深度优先搜索过于复杂，不是最优解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxValue</span><span class="params">(<span class="keyword">int</span>[][] values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (values == <span class="keyword">null</span> || values.length == <span class="number">0</span> || values[<span class="number">0</span>].length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> m = values.length;</span><br><span class="line">    <span class="keyword">int</span> n = values[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        dp[<span class="number">0</span>] += values[i][<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[j] = Math.max(dp[j], dp[j - <span class="number">1</span>]) + values[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="48-最长不含重复字符的子字符串"><a href="#48-最长不含重复字符的子字符串" class="headerlink" title="48. 最长不含重复字符的子字符串"></a>48. 最长不含重复字符的子字符串</h2><p><strong>题目描述</strong> </p><p>输入一个字符串（只包含 a~z 的字符），求其最长不含重复字符的子字符串的长度。例如对于 arabcacfr，最长不含重复字符的子字符串为 acfr，长度为 4。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestSubStringWithoutDuplication</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> curLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> maxLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>[] position = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = str.charAt(i) - <span class="string">'a'</span>;</span><br><span class="line">        <span class="keyword">int</span> preIndex = position[c];</span><br><span class="line">        <span class="keyword">if</span> (preIndex == -<span class="number">1</span> || i - preIndex &gt; curLen) curLen++;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            maxLen = Math.max(maxLen, curLen);</span><br><span class="line">            curLen = i - preIndex;</span><br><span class="line">        &#125;</span><br><span class="line">        position[c] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    maxLen = Math.max(maxLen, curLen);</span><br><span class="line">    <span class="keyword">return</span> maxLen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="49-丑数"><a href="#49-丑数" class="headerlink" title="49. 丑数"></a>49. 丑数</h2><p><strong>题目描述</strong> </p><p>把只包含因子 2、3 和 5 的数称作丑数（Ugly Number）。例如 6、8 都是丑数，但 14 不是，因为它包含因子 7。 习惯上我们把 1 当做是第一个丑数。求按从小到大的顺序的第 N 个丑数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetUglyNumber_Solution</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt;= <span class="number">6</span>) <span class="keyword">return</span> index;</span><br><span class="line">    <span class="keyword">int</span> i2 = <span class="number">0</span>, i3 = <span class="number">0</span>, i5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[index];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (cnt &lt; index) &#123;</span><br><span class="line">        <span class="keyword">int</span> n2 = dp[i2] * <span class="number">2</span>, n3 = dp[i3] * <span class="number">3</span>, n5 = dp[i5] * <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">int</span> tmp = Math.min(n2, Math.min(n3, n5));</span><br><span class="line">        dp[cnt++] = tmp;</span><br><span class="line">        <span class="keyword">if</span> (tmp == n2) i2++;</span><br><span class="line">        <span class="keyword">if</span> (tmp == n3) i3++;</span><br><span class="line">        <span class="keyword">if</span> (tmp == n5) i5++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[index - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="50-第一个只出现一次的字符位置"><a href="#50-第一个只出现一次的字符位置" class="headerlink" title="50. 第一个只出现一次的字符位置"></a>50. 第一个只出现一次的字符位置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">FirstNotRepeatingChar</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] cnts = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++) cnts[str.charAt(i)]++;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++) <span class="keyword">if</span> (cnts[str.charAt(i)] == <span class="number">1</span>) <span class="keyword">return</span> i;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="51-数组中的逆序对"><a href="#51-数组中的逆序对" class="headerlink" title="51. 数组中的逆序对"></a>51. 数组中的逆序对</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">InversePairs</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">    mergeSortUp2Down(array, <span class="number">0</span>, array.length - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) (cnt % <span class="number">1000000007</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeSortUp2Down</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (end - start &lt; <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = start + (end - start) / <span class="number">2</span>;</span><br><span class="line">    mergeSortUp2Down(a, start, mid);</span><br><span class="line">    mergeSortUp2Down(a, mid + <span class="number">1</span>, end);</span><br><span class="line">    merge(a, start, mid, end);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> start, <span class="keyword">int</span> mid, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] tmp = <span class="keyword">new</span> <span class="keyword">int</span>[end - start + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> i = start, j = mid + <span class="number">1</span>, k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= mid || j &lt;= end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &gt; mid) tmp[k] = a[j++];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (j &gt; end) tmp[k] = a[i++];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (a[i] &lt; a[j]) tmp[k] = a[i++];</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp[k] = a[j++];</span><br><span class="line">            <span class="keyword">this</span>.cnt += mid - i + <span class="number">1</span>; <span class="comment">// a[i] &gt; a[j] ，说明 a[i...mid] 都大于 a[j]</span></span><br><span class="line">        &#125;</span><br><span class="line">        k++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; tmp.length; k++) &#123;</span><br><span class="line">        a[start + k] = tmp[k];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="52-两个链表的第一个公共结点"><a href="#52-两个链表的第一个公共结点" class="headerlink" title="52. 两个链表的第一个公共结点"></a>52. 两个链表的第一个公共结点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">FindFirstCommonNode</span><span class="params">(ListNode pHead1, ListNode pHead2)</span> </span>&#123;</span><br><span class="line">    ListNode l1 = pHead1, l2 = pHead2;</span><br><span class="line">    <span class="keyword">while</span> (l1 != l2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (l1 == <span class="keyword">null</span>) l1 = pHead2;</span><br><span class="line">        <span class="keyword">else</span> l1 = l1.next;</span><br><span class="line">        <span class="keyword">if</span> (l2 == <span class="keyword">null</span>) l2 = pHead1;</span><br><span class="line">        <span class="keyword">else</span> l2 = l2.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="第六章-面试中的各项能力"><a href="#第六章-面试中的各项能力" class="headerlink" title="第六章 面试中的各项能力"></a>第六章 面试中的各项能力</h1><h2 id="53-数字在排序数组中出现的次数"><a href="#53-数字在排序数组中出现的次数" class="headerlink" title="53 数字在排序数组中出现的次数"></a>53 数字在排序数组中出现的次数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">GetNumberOfK</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, h = array.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt;= h) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + (h - l) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (array[m] &gt;= k) h = m - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> l = m + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; array.length &amp;&amp; array[l++] == k) cnt++;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="54-二叉搜索树的第-k-个结点"><a href="#54-二叉搜索树的第-k-个结点" class="headerlink" title="54. 二叉搜索树的第 k 个结点"></a>54. 二叉搜索树的第 k 个结点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TreeNode ret;</span><br><span class="line"><span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">TreeNode <span class="title">KthNode</span><span class="params">(TreeNode pRoot, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    inorder(pRoot, k);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inorder</span><span class="params">(TreeNode root, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (cnt &gt; k) <span class="keyword">return</span>;</span><br><span class="line">    inorder(root.left, k);</span><br><span class="line">    cnt++;</span><br><span class="line">    <span class="keyword">if</span> (cnt == k) ret = root;</span><br><span class="line">    inorder(root.right, k);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="55-二叉树的深度"><a href="#55-二叉树的深度" class="headerlink" title="55 二叉树的深度"></a>55 二叉树的深度</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">TreeDepth</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + Math.max(TreeDepth(root.left), TreeDepth(root.right));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="56-数组中只出现一次的数字"><a href="#56-数组中只出现一次的数字" class="headerlink" title="56. 数组中只出现一次的数字"></a>56. 数组中只出现一次的数字</h2><p><strong>题目描述</strong> </p><p>一个整型数组里除了两个数字之外，其他的数字都出现了两次，找出这两个数。</p><p><strong>解题思路</strong> </p><p>两个不相等的元素在位级表示上必定会有一位存在不同。</p><p>将数组的所有元素异或得到的结果为不存在重复的两个元素异或的结果。</p><p>diff &amp;= -diff 得到出 diff 最右侧不为 0 的位，也就是不存在重复的两个元素在位级表示上最右侧不同的那一位，利用这一位就可以将两个元素区分开来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FindNumsAppearOnce</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span> num1[], <span class="keyword">int</span> num2[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> diff = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : array) diff ^= num;</span><br><span class="line">    <span class="comment">// 得到最右一位</span></span><br><span class="line">    diff &amp;= -diff;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : array) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((num &amp; diff) == <span class="number">0</span>) num1[<span class="number">0</span>] ^= num;</span><br><span class="line">        <span class="keyword">else</span> num2[<span class="number">0</span>] ^= num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="57-1-和为-S-的两个数字"><a href="#57-1-和为-S-的两个数字" class="headerlink" title="57.1 和为 S 的两个数字"></a>57.1 和为 S 的两个数字</h2><p><strong>题目描述</strong> </p><p>输入一个递增排序的数组和一个数字 S，在数组中查找两个数，是的他们的和正好是 S，如果有多对数字的和等于 S，输出两个数的乘积最小的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">FindNumbersWithSum</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = array.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">        <span class="keyword">int</span> cur = array[i] + array[j];</span><br><span class="line">        <span class="keyword">if</span> (cur == sum) <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Integer&gt;(Arrays.asList(array[i], array[j]));</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cur &lt; sum) i++;</span><br><span class="line">        <span class="keyword">else</span> j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="57-2-和为-S-的连续正数序列"><a href="#57-2-和为-S-的连续正数序列" class="headerlink" title="57.2 和为 S 的连续正数序列"></a>57.2 和为 S 的连续正数序列</h2><p><strong>题目描述</strong> </p><p>和为 100 的连续序列有 18, 19, 20, 21, 22</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; FindContinuousSequence(<span class="keyword">int</span> sum) &#123;</span><br><span class="line">    ArrayList&lt;ArrayList&lt;Integer&gt;&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> start = <span class="number">1</span>, end = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = sum / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> curSum = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">while</span> (start &lt;= mid &amp;&amp; end &lt; sum) &#123;</span><br><span class="line">        <span class="keyword">if</span> (curSum &gt; sum) &#123;</span><br><span class="line">            curSum -= start;</span><br><span class="line">            start++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (curSum &lt; sum) &#123;</span><br><span class="line">            end++;</span><br><span class="line">            curSum += end;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">                list.add(i);</span><br><span class="line">            &#125;</span><br><span class="line">            ret.add(list);</span><br><span class="line">            curSum -= start;</span><br><span class="line">            start++;</span><br><span class="line">            end++;</span><br><span class="line">            curSum += end;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="58-1-翻转单词顺序列"><a href="#58-1-翻转单词顺序列" class="headerlink" title="58.1 翻转单词顺序列"></a>58.1 翻转单词顺序列</h2><p><strong>题目描述</strong> </p><p>输入：”I am a student.”</p><p>输出：”student. a am I”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">ReverseSentence</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str.length() == <span class="number">0</span>) <span class="keyword">return</span> str;</span><br><span class="line">    <span class="keyword">int</span> n = str.length();</span><br><span class="line">    <span class="keyword">char</span>[] chars = str.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> start = <span class="number">0</span>, end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (end &lt;= n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (end == n || chars[end] == <span class="string">' '</span>) &#123;</span><br><span class="line">            reverse(chars, start, end - <span class="number">1</span>);</span><br><span class="line">            start = end + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        end++;</span><br><span class="line">    &#125;</span><br><span class="line">    reverse(chars, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(chars);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">char</span>[] c, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (start &lt; end) &#123;</span><br><span class="line">        <span class="keyword">char</span> t = c[start];</span><br><span class="line">        c[start] = c[end];</span><br><span class="line">        c[end] = t;</span><br><span class="line">        start++;</span><br><span class="line">        end--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="58-2-左旋转字符串"><a href="#58-2-左旋转字符串" class="headerlink" title="58.2 左旋转字符串"></a>58.2 左旋转字符串</h2><p><strong>题目描述</strong> </p><p>对于一个给定的字符序列 S，请你把其循环左移 K 位后的序列输出。例如，字符序列 S=”abcXYZdef”, 要求输出循环左移 3 位后的结果，即“XYZdefabc”。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">LeftRotateString</span><span class="params">(String str, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">char</span>[] c = str.toCharArray();</span><br><span class="line">    reverse(c, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    reverse(c, n, c.length - <span class="number">1</span>);</span><br><span class="line">    reverse(c, <span class="number">0</span>, c.length - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">char</span>[] c, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">        <span class="keyword">char</span> t = c[i];</span><br><span class="line">        c[i] = c[j];</span><br><span class="line">        c[j] = t;</span><br><span class="line">        i++;</span><br><span class="line">        j--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="59-滑动窗口的最大值"><a href="#59-滑动窗口的最大值" class="headerlink" title="59. 滑动窗口的最大值"></a>59. 滑动窗口的最大值</h2><p><strong>题目描述</strong> </p><p>给定一个数组和滑动窗口的大小，找出所有滑动窗口里数值的最大值。例如，如果输入数组 {2, 3, 4, 2, 6, 2, 5, 1} 及滑动窗口的大小 3，那么一共存在 6 个滑动窗口，他们的最大值分别为 {4, 4, 6, 6, 6, 5}；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ArrayList&lt;Integer&gt; <span class="title">maxInWindows</span><span class="params">(<span class="keyword">int</span>[] num, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (size &gt; num.length || size &lt; <span class="number">1</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    PriorityQueue&lt;Integer&gt; heap = <span class="keyword">new</span> PriorityQueue&lt;Integer&gt;((o1, o2) -&gt; o2 - o1);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) heap.add(num[i]);</span><br><span class="line">    ret.add(heap.peek());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i + size - <span class="number">1</span> &lt; num.length; i++) &#123;</span><br><span class="line">        heap.remove(num[i - <span class="number">1</span>]);</span><br><span class="line">        heap.add(num[i + size - <span class="number">1</span>]);</span><br><span class="line">        ret.add(heap.peek());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="60-n-个骰子的点数"><a href="#60-n-个骰子的点数" class="headerlink" title="60. n 个骰子的点数"></a>60. n 个骰子的点数</h2><p><strong>题目描述</strong> </p><p>把 n 个骰子仍在地上，求点数和为 s 的概率。</p><p>最直观的动态规划解法，O(n<sup>2</sup>) 的空间复杂度。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> face = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">countProbability</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">1</span> || s &lt; n) <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">int</span> pointNum = face * n;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n][pointNum];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; face; i++) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; pointNum; j++) &#123; <span class="comment">// 使用 i 个骰子最小点数为 i</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= face; k++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j - k &lt; <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                dp[i][j] += dp[i - <span class="number">1</span>][j - k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> totalNum = (<span class="keyword">int</span>) Math.pow(<span class="number">6</span>, n);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">double</span>) dp[n - <span class="number">1</span>][s - <span class="number">1</span>] / totalNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用旋转数组将空间复杂度降低为 O(n)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> face = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">countProbability</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">1</span> || s &lt; n) <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">int</span> pointNum = face * n;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>][pointNum];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; face; i++) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; pointNum; j++) &#123; <span class="comment">// 使用 i 个骰子最小点数为 i</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= face; k++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j - k &lt; <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                dp[flag][j] += dp[<span class="number">1</span> - flag][j - k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> totalNum = (<span class="keyword">int</span>) Math.pow(<span class="number">6</span>, n);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">double</span>) dp[n - <span class="number">1</span>][s - <span class="number">1</span>] / totalNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="61-扑克牌顺子"><a href="#61-扑克牌顺子" class="headerlink" title="61. 扑克牌顺子"></a>61. 扑克牌顺子</h2><p><strong>题目描述</strong> </p><p>五张牌，其中大小鬼为癞子，牌面大小为 0。判断是否能组成顺子。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isContinuous</span><span class="params">(<span class="keyword">int</span>[] numbers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (numbers.length &lt; <span class="number">5</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    Arrays.sort(numbers);</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : numbers) <span class="keyword">if</span> (num == <span class="number">0</span>) cnt++;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = cnt; i &lt; numbers.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (numbers[i + <span class="number">1</span>] == numbers[i]) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> cut = numbers[i + <span class="number">1</span>] - numbers[i] - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (cut &gt; cnt) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        cnt -= cut;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="62-圆圈中最后剩下的数"><a href="#62-圆圈中最后剩下的数" class="headerlink" title="62. 圆圈中最后剩下的数"></a>62. 圆圈中最后剩下的数</h2><p><strong>题目描述</strong> </p><p>让小朋友们围成一个大圈。然后 , 他随机指定一个数 m, 让编号为 0 的小朋友开始报数。每次喊到 m-1 的那个小朋友要出列唱首歌 , 然后可以在礼品箱中任意的挑选礼物 , 并且不再回到圈中 , 从他的下一个小朋友开始 , 继续 0…m-1 报数 …. 这样下去 …. 直到剩下最后一个小朋友 , 可以不用表演。</p><p><strong>解题思路</strong> </p><p>约瑟夫环</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">LastRemaining_Solution</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> (LastRemaining_Solution(n - <span class="number">1</span>, m) + m) % n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="63-股票的最大利润"><a href="#63-股票的最大利润" class="headerlink" title="63. 股票的最大利润"></a>63. 股票的最大利润</h2><p><strong>题目描述</strong> </p><p>可以有一次买入和一次卖出，买入必须在前。求最大收益。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = prices.length;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> soFarMin = prices[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(soFarMin &gt; prices[i]) soFarMin = prices[i];</span><br><span class="line">        <span class="keyword">else</span> max = Math.max(max, prices[i] - soFarMin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="64-求-1-2-3-…-n"><a href="#64-求-1-2-3-…-n" class="headerlink" title="64. 求 1+2+3+…+n"></a>64. 求 1+2+3+…+n</h2><p><strong>题目描述</strong> </p><p>求 1+2+3+…+n，要求不能使用乘除法、for、while、if、else、switch、case 等关键字及条件判断语句（A?B:C）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Sum_Solution</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = n;</span><br><span class="line">    <span class="keyword">boolean</span> b = (n &gt; <span class="number">0</span>) &amp;&amp; ((sum += Sum_Solution(n - <span class="number">1</span>)) &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="65-不用加减乘除做加法"><a href="#65-不用加减乘除做加法" class="headerlink" title="65. 不用加减乘除做加法"></a>65. 不用加减乘除做加法</h2><p>a ^ b 表示没有考虑进位的情况下两数的和，(a &amp; b) &lt;&lt; 1 就是进位。递归会终止的原因是 (a &amp; b) &lt;&lt; 1 最右边会多一个 0，那么继续递归，进位最右边的 0 会慢慢增多，最后进位会变为 0，递归终止。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Add</span><span class="params">(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(num2 == <span class="number">0</span>) <span class="keyword">return</span> num1;</span><br><span class="line">    <span class="keyword">return</span> Add(num1 ^ num2, (num1 &amp; num2) &lt;&lt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="66-构建乘积数组"><a href="#66-构建乘积数组" class="headerlink" title="66. 构建乘积数组"></a>66. 构建乘积数组</h2><p><strong>题目描述</strong> </p><p>给定一个数组 A[0, 1,…, n-1], 请构建一个数组 B[0, 1,…, n-1], 其中 B 中的元素 B[i]=A[0]*A[1]*…*A[i-1]*A[i+1]*…*A[n-1]。不能使用除法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] multiply(<span class="keyword">int</span>[] A) &#123;</span><br><span class="line">    <span class="keyword">int</span> n = A.length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n][n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        dp[i][i] = A[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[i][j] = dp[i][j - <span class="number">1</span>] * A[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] B = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    Arrays.fill(B, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span>) B[i] *= dp[<span class="number">0</span>][i - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (i != n - <span class="number">1</span>) B[i] *= dp[i + <span class="number">1</span>][n - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> B;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="第七章-两个面试案例"><a href="#第七章-两个面试案例" class="headerlink" title="第七章 两个面试案例"></a>第七章 两个面试案例</h1><h2 id="67-把字符串转换成整数"><a href="#67-把字符串转换成整数" class="headerlink" title="67. 把字符串转换成整数"></a>67. 把字符串转换成整数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">StrToInt</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>[] chars = str.toCharArray();</span><br><span class="line">    <span class="keyword">boolean</span> isNegative = chars[<span class="number">0</span>] == <span class="string">'-'</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span> &amp;&amp; (chars[i] == <span class="string">'+'</span> || chars[i] == <span class="string">'-'</span>)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (chars[i] &lt; <span class="string">'0'</span> || chars[i] &gt; <span class="string">'9'</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        ret = ret * <span class="number">10</span> + (chars[i] - <span class="string">'0'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isNegative ? -ret : ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="68-树中两个节点的最低公共祖先"><a href="#68-树中两个节点的最低公共祖先" class="headerlink" title="68. 树中两个节点的最低公共祖先"></a>68. 树中两个节点的最低公共祖先</h2><p>树是二叉查找树的最低公共祖先问题：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode root, TreeNode p, TreeNode q)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root.val &gt; p.val &amp;&amp; root.val &gt; q.val) <span class="keyword">return</span> lowestCommonAncestor(root.left, p, q);</span><br><span class="line">    <span class="keyword">if</span>(root.val &lt; p.val &amp;&amp; root.val &lt; q.val) <span class="keyword">return</span> lowestCommonAncestor(root.right, p, q);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#第二章-面试需要的基础知识&quot;&gt;第二章 面试需要的基础知识&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#2-实现-singleton&quot;&gt;2. 实现 Singleton&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-数组中重复的数字&quot;&gt;3. 数组中重复的数字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-二维数组中的查找&quot;&gt;4. 二维数组中的查找&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-替换空格&quot;&gt;5. 替换空格&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-从尾到头打印链表&quot;&gt;6. 从尾到头打印链表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-重建二叉树&quot;&gt;7. 重建二叉树&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-二叉树的下一个结点&quot;&gt;8. 二叉树的下一个结点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-用两个栈实现队列&quot;&gt;9. 用两个栈实现队列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#101-斐波那契数列&quot;&gt;10.1 斐波那契数列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#102-跳台阶&quot;&gt;10.2 跳台阶&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#103-变态跳台阶&quot;&gt;10.3 变态跳台阶&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#104-矩形覆盖&quot;&gt;10.4 矩形覆盖&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-旋转数组的最小数字&quot;&gt;11. 旋转数组的最小数字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-矩阵中的路径&quot;&gt;12. 矩阵中的路径&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-机器人的运动范围&quot;&gt;13. 机器人的运动范围&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-剪绳子&quot;&gt;14. 剪绳子&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15-二进制中-1-的个数&quot;&gt;15. 二进制中 1 的个数&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第三章-高质量的代码&quot;&gt;第三章 高质量的代码&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#16-数值的整数次方&quot;&gt;16. 数值的整数次方&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#17-打印从-1-到最大的-n-位数&quot;&gt;17. 打印从 1 到最大的 n 位数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#181-在-o1-时间内删除链表节点&quot;&gt;18.1 在 O(1) 时间内删除链表节点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#182-删除链表中重复的结点&quot;&gt;18.2 删除链表中重复的结点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#19-正则表达式匹配&quot;&gt;19. 正则表达式匹配&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#20-表示数值的字符串&quot;&gt;20. 表示数值的字符串&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#21-调整数组顺序使奇数位于偶数前面&quot;&gt;21. 调整数组顺序使奇数位于偶数前面&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-链表中倒数第-k-个结点&quot;&gt;22. 链表中倒数第 k 个结点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-链表中环的入口结点&quot;&gt;23. 链表中环的入口结点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#24-反转链表&quot;&gt;24. 反转链表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#25-合并两个排序的链表&quot;&gt;25. 合并两个排序的链表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#26-树的子结构&quot;&gt;26. 树的子结构&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第四章-解决面试题的思路&quot;&gt;第四章 解决面试题的思路&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#27-二叉树的镜像&quot;&gt;27. 二叉树的镜像&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#281-对称的二叉树&quot;&gt;28.1 对称的二叉树&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#282-平衡二叉树&quot;&gt;28.2 平衡二叉树&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#29-顺时针打印矩阵&quot;&gt;29. 顺时针打印矩阵&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#30-包含-min-函数的栈&quot;&gt;30. 包含 min 函数的栈&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#31-栈的压入弹出序列&quot;&gt;31. 栈的压入、弹出序列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#321-从上往下打印二叉树&quot;&gt;32.1 从上往下打印二叉树&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#323--把二叉树打印成多行&quot;&gt;32.3  把二叉树打印成多行&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#323-按之字形顺序打印二叉树&quot;&gt;32.3 按之字形顺序打印二叉树&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#33-二叉搜索树的后序遍历序列&quot;&gt;33. 二叉搜索树的后序遍历序列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#34-二叉树中和为某一值的路径&quot;&gt;34. 二叉树中和为某一值的路径&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#35-复杂链表的复制&quot;&gt;35. 复杂链表的复制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#36-二叉搜索树与双向链表&quot;&gt;36. 二叉搜索树与双向链表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#37-序列化二叉树&quot;&gt;37. 序列化二叉树&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#38-字符串的排列&quot;&gt;38. 字符串的排列&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第五章-优化时间和空间效率&quot;&gt;第五章 优化时间和空间效率&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#39-数组中出现次数超过一半的数字&quot;&gt;39. 数组中出现次数超过一半的数字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#40-最小的-k-个数&quot;&gt;40. 最小的 K 个数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#411-数据流中的中位数&quot;&gt;41.1 数据流中的中位数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#412-字符流中第一个不重复的字符&quot;&gt;41.2 字符流中第一个不重复的字符&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-连续子数组的最大和&quot;&gt;42. 连续子数组的最大和&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#43-从-1-到-n-整数中-1-出现的次数&quot;&gt;43. 从 1 到 n 整数中 1 出现的次数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#44-数字序列中的某一位数字&quot;&gt;44. 数字序列中的某一位数字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#45-把数组排成最小的数&quot;&gt;45. 把数组排成最小的数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#46-把数字翻译成字符串&quot;&gt;46. 把数字翻译成字符串&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#47-礼物的最大价值&quot;&gt;47. 礼物的最大价值&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#48-最长不含重复字符的子字符串&quot;&gt;48. 最长不含重复字符的子字符串&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#49-丑数&quot;&gt;49. 丑数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#50-第一个只出现一次的字符位置&quot;&gt;50. 第一个只出现一次的字符位置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#51-数组中的逆序对&quot;&gt;51. 数组中的逆序对&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#52-两个链表的第一个公共结点&quot;&gt;52. 两个链表的第一个公共结点&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第六章-面试中的各项能力&quot;&gt;第六章 面试中的各项能力&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#53-数字在排序数组中出现的次数&quot;&gt;53 数字在排序数组中出现的次数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#54-二叉搜索树的第-k-个结点&quot;&gt;54. 二叉搜索树的第 k 个结点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#55-二叉树的深度&quot;&gt;55 二叉树的深度&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#56-数组中只出现一次的数字&quot;&gt;56. 数组中只出现一次的数字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#571-和为-s-的两个数字&quot;&gt;57.1 和为 S 的两个数字&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#572-和为-s-的连续正数序列&quot;&gt;57.2 和为 S 的连续正数序列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#581-翻转单词顺序列&quot;&gt;58.1 翻转单词顺序列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#582-左旋转字符串&quot;&gt;58.2 左旋转字符串&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#59-滑动窗口的最大值&quot;&gt;59. 滑动窗口的最大值&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#60-n-个骰子的点数&quot;&gt;60. n 个骰子的点数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#61-扑克牌顺子&quot;&gt;61. 扑克牌顺子&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#62-圆圈中最后剩下的数&quot;&gt;62. 圆圈中最后剩下的数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#63-股票的最大利润&quot;&gt;63. 股票的最大利润&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#64-求-1+2+3++n&quot;&gt;64. 求 1+2+3+…+n&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#65-不用加减乘除做加法&quot;&gt;65. 不用加减乘除做加法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#66-构建乘积数组&quot;&gt;66. 构建乘积数组&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第七章-两个面试案例&quot;&gt;第七章 两个面试案例&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#67-把字符串转换成整数&quot;&gt;67. 把字符串转换成整数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#68-树中两个节点的最低公共祖先&quot;&gt;68. 树中两个节点的最低公共祖先&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;第二章-面试需要的基础知识&quot;&gt;&lt;a href=&quot;#第二章-面试需要的基础知识&quot; class=&quot;headerlink&quot; title=&quot;第二章 面试需要的基础知识&quot;&gt;&lt;/a&gt;第二章 面试需要的基础知识&lt;/h1&gt;&lt;h2 id=&quot;2-实现-Singleton&quot;&gt;&lt;a href=&quot;#2-实现-Singleton&quot; class=&quot;headerlink&quot; title=&quot;2. 实现 Singleton&quot;&gt;&lt;/a&gt;2. 实现 Singleton&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/CyC2018/InterviewNotes/blob/master/notes/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.md#%E7%AC%AC-5-%E7%AB%A0-%E5%8D%95%E4%BB%B6%E6%A8%A1%E5%BC%8F&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt; 单例模式 &lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;3-数组中重复的数字&quot;&gt;&lt;a href=&quot;#3-数组中重复的数字&quot; class=&quot;headerlink&quot; title=&quot;3. 数组中重复的数字&quot;&gt;&lt;/a&gt;3. 数组中重复的数字&lt;/h2&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>面向对象思想</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%80%9D%E6%83%B3.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/面向对象思想.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T10:18:52.904Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#solid">S.O.L.I.D</a><ul><li><a href="#1-单一责任原则">1. 单一责任原则</a></li><li><a href="#2-开放封闭原则">2. 开放封闭原则</a></li><li><a href="#3-里氏替换原则">3. 里氏替换原则</a></li><li><a href="#4-接口分离原则">4. 接口分离原则</a></li><li><a href="#5-依赖倒置原则">5. 依赖倒置原则</a></li></ul></li><li><a href="#其他常见原则">其他常见原则</a><ul><li><a href="#1-迪米特法则">1. 迪米特法则</a></li><li><a href="#2-合成复用原则">2. 合成复用原则</a></li><li><a href="#3-共同封闭原则">3. 共同封闭原则</a></li><li><a href="#4-稳定抽象原则">4. 稳定抽象原则</a></li><li><a href="#5-稳定依赖原则">5. 稳定依赖原则</a></li></ul></li><li><a href="#封装继承多态">封装、继承、多态</a><ul><li><a href="#1-封装">1. 封装</a></li><li><a href="#2-继承">2. 继承</a></li><li><a href="#3-多态">3. 多态</a></li></ul></li><li><a href="#uml">UML</a><ul><li><a href="#1-类图">1. 类图</a></li><li><a href="#2-时序图">2. 时序图</a></li></ul></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="S-O-L-I-D"><a href="#S-O-L-I-D" class="headerlink" title="S.O.L.I.D"></a>S.O.L.I.D</h1><p>S.O.L.I.D 是面向对象设计和编程 (OOD&amp;OOP) 中几个重要编码原则 (Programming Priciple) 的首字母缩写。</p><table><thead><tr><th>简写</th><th>全拼</th><th>中文翻译</th></tr></thead><tbody><tr><td>SRP</td><td>The Single Responsibility Principle</td><td>单一责任原则</td></tr><tr><td>OCP</td><td>The Open Closed Principle</td><td>开放封闭原则</td></tr><tr><td>LSP</td><td>The Liskov Substitution Principle</td><td>里氏替换原则</td></tr><tr><td>ISP</td><td>The Interface Segregation Principle</td><td>接口分离原则</td></tr><tr><td>DIP</td><td>The Dependency Inversion Principle</td><td>依赖倒置原则</td></tr></tbody></table><h2 id="1-单一责任原则"><a href="#1-单一责任原则" class="headerlink" title="1. 单一责任原则"></a>1. 单一责任原则</h2><p>当需要修改某个类的时候原因有且只有一个。换句话说就是让一个类只做一种类型责任，当这个类需要承当其他类型的责任的时候，就需要分解这个类。</p><h2 id="2-开放封闭原则"><a href="#2-开放封闭原则" class="headerlink" title="2. 开放封闭原则"></a>2. 开放封闭原则</h2><p>软件实体应该是可扩展，而不可修改的。也就是说，对扩展是开放的，而对修改是封闭的。</p><h2 id="3-里氏替换原则"><a href="#3-里氏替换原则" class="headerlink" title="3. 里氏替换原则"></a>3. 里氏替换原则</h2><p>当一个子类的实例应该能够替换任何其超类的实例时，它们之间才具有 is-a 关系。</p><a id="more"></a><h2 id="4-接口分离原则"><a href="#4-接口分离原则" class="headerlink" title="4. 接口分离原则"></a>4. 接口分离原则</h2><p>不能强迫用户去依赖那些他们不使用的接口。换句话说，使用多个专门的接口比使用单一的总接口总要好。</p><h2 id="5-依赖倒置原则"><a href="#5-依赖倒置原则" class="headerlink" title="5. 依赖倒置原则"></a>5. 依赖倒置原则</h2><ol><li>高层模块不应该依赖于低层模块，二者都应该依赖于抽象</li><li>抽象不应该依赖于细节，细节应该依赖于抽象</li></ol><h1 id="其他常见原则"><a href="#其他常见原则" class="headerlink" title="其他常见原则"></a>其他常见原则</h1><p>除了上述的经典原则，在实际开发中还有下面这些常见的设计原则。</p><table><thead><tr><th>简写</th><th>全拼</th><th>中文翻译</th></tr></thead><tbody><tr><td>LoD</td><td>The Law of Demeter</td><td>迪米特法则</td></tr><tr><td>CRP</td><td>The Composite Reuse Principle</td><td>合成复用原则</td></tr><tr><td>CCP</td><td>The Common Closure Principle</td><td>共同封闭原则</td></tr><tr><td>SAP</td><td>The Stable Abstractions Principle</td><td>稳定抽象原则</td></tr><tr><td>SDP</td><td>The Stable Dependencies Principle</td><td>稳定依赖原则</td></tr></tbody></table><h2 id="1-迪米特法则"><a href="#1-迪米特法则" class="headerlink" title="1. 迪米特法则"></a>1. 迪米特法则</h2><p>迪米特法则又叫作最少知道原则（Least Knowledge Principle 简写LKP），就是说一个对象应当对其他对象有尽可能少的了解，不和陌生人说话。</p><h2 id="2-合成复用原则"><a href="#2-合成复用原则" class="headerlink" title="2. 合成复用原则"></a>2. 合成复用原则</h2><p>尽量使用对象组合，而不是继承来达到复用的目的。</p><h2 id="3-共同封闭原则"><a href="#3-共同封闭原则" class="headerlink" title="3. 共同封闭原则"></a>3. 共同封闭原则</h2><p>一起修改的类，应该组合在一起（同一个包里）。如果必须修改应用程序里的代码，我们希望所有的修改都发生在一个包里（修改关闭），而不是遍布在很多包里。</p><h2 id="4-稳定抽象原则"><a href="#4-稳定抽象原则" class="headerlink" title="4. 稳定抽象原则"></a>4. 稳定抽象原则</h2><p>最稳定的包应该是最抽象的包，不稳定的包应该是具体的包，即包的抽象程度跟它的稳定性成正比。</p><h2 id="5-稳定依赖原则"><a href="#5-稳定依赖原则" class="headerlink" title="5. 稳定依赖原则"></a>5. 稳定依赖原则</h2><p>包之间的依赖关系都应该是稳定方向依赖的，包要依赖的包要比自己更具有稳定性。</p><h1 id="封装、继承、多态"><a href="#封装、继承、多态" class="headerlink" title="封装、继承、多态"></a>封装、继承、多态</h1><p>封装、继承、多态是面向对象的三大特性。</p><h2 id="1-封装"><a href="#1-封装" class="headerlink" title="1. 封装"></a>1. 封装</h2><p>利用抽象数据类型将数据和基于数据的操作封装在一起，使其构成一个不可分割的独立实体，数据被保护在抽象数据类型的内部，尽可能地隐藏内部的细节，只保留一些对外接口使之与外部发生联系。用户是无需知道对象内部的细节，但可以通过该对象对外的提供的接口来访问该对象。</p><p>封装有三大好处：</p><ol><li>良好的封装能够减少耦合。</li><li>类内部的结构可以自由修改。</li><li>可以对成员进行更精确的控制。</li><li>隐藏信息，实现细节。</li></ol><p>以下 Person 类封装 name、gender、age 等属性，外界只能通过 get() 方法获取一个 Person 对象的 name 属性和 gender 属性，而无法获取 age 属性，但是 age 属性可以供 work() 方法使用。</p><p>注意到 gender 属性使用 int 数据类型进行存储，封装使得用户注意不到这种实现细节。并且在需要修改使用的数据类型时，也可以在不影响客户端代码的情况下进行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> gender;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gender == <span class="number">0</span> ? <span class="string">"man"</span> : <span class="string">"woman"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">18</span> &lt;= age &amp;&amp; age &lt;= <span class="number">50</span>) &#123;</span><br><span class="line">            System.out.println(name + <span class="string">" is working very hard!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(name + <span class="string">" can't work!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-继承"><a href="#2-继承" class="headerlink" title="2. 继承"></a>2. 继承</h2><p>继承实现了  <strong>is-a</strong>  关系，例如 Cat 和 Animal 就是一种 is-a 关系，因此可以将 Cat 继承自 Animal，从而获得 Animal 非 private 的属性和方法。</p><p>Cat 可以当做 Animal 来使用，也就是可以使用 Animal 引用 Cat 对象，这种子类转换为父类称为  <strong>向上转型</strong> 。</p><p>继承应该遵循里氏替换原则：当一个子类的实例应该能够替换任何其超类的实例时，它们之间才具有 is-a 关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Animal animal = <span class="keyword">new</span> Cat();</span><br></pre></td></tr></table></figure><h2 id="3-多态"><a href="#3-多态" class="headerlink" title="3. 多态"></a>3. 多态</h2><p>多态分为编译时多态和运行时多态。编译时多态主要指方法的重装，运行时多态指程序中定义的对象引用所指向的具体类型在运行期间才确定。</p><p>多态有三个条件：1. 继承；2. 覆盖父类方法；3. 向上转型。</p><p>下面的代码中，乐器类（Instrument）有两个子类：Wind 和 Percussion，它们都覆盖了 play() 方法，并且在 main() 方法中使用父类 Instrument 来引用 Wind 和 Percussion 对象。在 Instrument 引用调用 play() 方法时，会执行实际引用对象所在类的 play() 方法，而不是 Instrument 类的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Instrument</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Instument is playing..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Wind</span> <span class="keyword">extends</span> <span class="title">Instrument</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Wind is playing..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Percussion</span> <span class="keyword">extends</span> <span class="title">Instrument</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Percussion is playing..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Music</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;Instrument&gt; instruments = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        instruments.add(<span class="keyword">new</span> Wind());</span><br><span class="line">        instruments.add(<span class="keyword">new</span> Percussion());</span><br><span class="line">        <span class="keyword">for</span>(Instrument instrument : instruments) &#123;</span><br><span class="line">            instrument.play();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h1><h2 id="1-类图"><a href="#1-类图" class="headerlink" title="1. 类图"></a>1. 类图</h2><p><strong>1.1 继承相关</strong> </p><p>继承有两种形式 : 泛化（generalize）和实现（realize），表现为 is-a 关系。</p><p>① 泛化关系 (generalization)</p><p>从具体类中继承</p><p><br><div align="center"> <img src="/pics/29badd92-109f-4f29-abb9-9857f5973928.png"> </div><br></p><p>② 实现关系 (realize)</p><p>从抽象类或者接口中继承</p><p><br><div align="center"> <img src="/pics/4b16e1d3-3a60-472c-9756-2f31b1c48abe.png"> </div><br></p><p><strong>1.2 整体和部分</strong> </p><p>① 聚合关系 (aggregation)</p><p>表示整体由部分组成，但是整体和部分不是强依赖的，整体不存在了部分还是会存在。以下表示 B 由 A 组成：</p><p><br><div align="center"> <img src="/pics/34259bb8-ca3a-4872-8771-9e946782d9c3.png"> </div><br></p><p>② 组合关系 (composition)</p><p>和聚合不同，组合中整体和部分是强依赖的，整体不存在了部分也不存在了。比如公司和部门，公司没了部门就不存在了。但是公司和员工就属于聚合关系了，因为公司没了员工还在。</p><p><br><div align="center"> <img src="/pics/7dda050d-ac35-4f47-9f51-18f18ed6fa9a.png"> </div><br></p><p><strong>1.3 相互联系</strong> </p><p>① 关联关系 (association)</p><p>表示不同类对象之间有关联，这是一种静态关系，与运行过程的状态无关，在最开始就可以确定。因此也可以用 1 对 1、多对 1、多对多这种关联关系来表示。比如学生和学校就是一种关联关系，一个学校可以有很多学生，但是一个学生只属于一个学校，因此这是一种多对一的关系，在运行开始之前就可以确定。</p><p><br><div align="center"> <img src="/pics/4ccd294c-d6b2-421b-839e-d88336ff5fb7.png"> </div><br></p><p>② 依赖关系 (dependency)</p><p>和关联关系不同的是 , 依赖关系是在运行过程中起作用的。一般依赖作为类的构造器或者方法的参数传入。双向依赖时一种不好的设计。</p><p><br><div align="center"> <img src="/pics/47ca2614-509f-476e-98fc-50ec9f9d43c0.png"> </div><br></p><h2 id="2-时序图"><a href="#2-时序图" class="headerlink" title="2. 时序图"></a>2. 时序图</h2><p><a href="http://www.cnblogs.com/wolf-sun/p/UML-Sequence-diagram.html" target="_blank" rel="noopener">http://www.cnblogs.com/wolf-sun/p/UML-Sequence-diagram.html</a></p><p><strong>2.1 定义</strong> </p><p>时序图描述了对象之间传递消息的时间顺序，它用来表示用例的行为顺序。它的主要作用是通过对象间的交互来描述用例（注意是对象），从而寻找类的操作。</p><p><strong>2.2 赤壁之战时序图</strong> </p><p>从虚线从上往下表示时间的推进。</p><p><br><div align="center"> <img src="/pics/80c5aff8-fc46-4810-aeaa-215b5c60a003.png"> </div><br></p><p>可见，通过时序图可以知道每个类具有以下操作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">publc <span class="class"><span class="keyword">class</span> 刘备 </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> 应战 ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">publc <span class="class"><span class="keyword">class</span>  孔明 </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span>  拟定策略 ();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span>  联合孙权 ();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> 借东风火攻 ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> 关羽 </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  防守荊州 ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> 张飞 </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span>  防守荆州前线 ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> 孙权 </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span>  领兵相助 ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.3 活动图、时序图之间的关系</strong> </p><p>活动图示从用户的角度来描述用例；</p><p>时序图是从计算机的角度（对象间的交互）描述用例。</p><p><strong>2.4 类图与时序图的关系</strong> </p><p>类图描述系统的静态结构，时序图描述系统的动态行为。</p><p><strong>2.5 时序图的组成</strong> </p><p>① 对象</p><p>有三种表现形式</p><p><br><div align="center"> <img src="/pics/25b8adad-2ef6-4f30-9012-c306b4e49897.png"> </div><br></p><p>在画图时，应该遵循以下原则：</p><ol><li><p>把交互频繁的对象尽可能地靠拢。</p></li><li><p>把初始化整个交互活动的对象（有时是一个参与者）放置在最左边。</p></li></ol><p>② 生命线</p><p>生命线从对象的创建开始到对象销毁时终止</p><p><br><div align="center"> <img src="/pics/b7b0eac6-e7ea-4fb6-8bfb-95fec6f235e2.png"> </div><br></p><p>③ 消息</p><p>对象之间的交互式通过发送消息来实现的。</p><p>消息有 4 种类型：</p><p>1. 简单消息，不区分同步异步。</p><p><br><div align="center"> <img src="/pics/a13b62da-0fa8-4224-a615-4cadacc08871.png"> </div><br></p><p>2. 同步消息，发送消息之后需要暂停活动来等待回应。</p><p><br><div align="center"> <img src="/pics/33821037-dc40-4266-901c-e5b38e618426.png"> </div><br></p><p>3. 异步消息，发送消息之后不需要等待。</p><p><br><div align="center"> <img src="/pics/dec6c6cc-1b5f-44ed-b8fd-464fcf849dac.png"> </div><br></p><p>4. 返回消息，可选。</p><p>④ 激活</p><p>生命线上的方框表示激活状态，其它时间处于休眠状态。</p><p><br><div align="center"> <img src="/pics/6ab5de9b-1c1e-4118-b2c3-fb6c7ed7de6f.png"> </div><br></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>Java 编程思想</li><li><a href="http://www.cnblogs.com/shanyou/archive/2009/09/21/1570716.html" target="_blank" rel="noopener"> 面向对象设计的 SOLID 原则 </a></li><li><a href="http://design-patterns.readthedocs.io/zh_CN/latest/read_uml.html#generalization" target="_blank" rel="noopener"> 看懂 UML 类图和时序图 </a></li><li><a href="http://www.cnblogs.com/wolf-sun/p/UML-Sequence-diagram.html" target="_blank" rel="noopener">UML 系列——时序图（顺序图）sequence diagram</a></li><li><a href="http://blog.csdn.net/jianyuerensheng/article/details/51602015" target="_blank" rel="noopener"> 面向对象编程三大特性 —— 封装、继承、多态 </a></li></ul><hr><p>本文来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#solid&quot;&gt;S.O.L.I.D&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-单一责任原则&quot;&gt;1. 单一责任原则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-开放封闭原则&quot;&gt;2. 开放封闭原则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-里氏替换原则&quot;&gt;3. 里氏替换原则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-接口分离原则&quot;&gt;4. 接口分离原则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-依赖倒置原则&quot;&gt;5. 依赖倒置原则&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#其他常见原则&quot;&gt;其他常见原则&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-迪米特法则&quot;&gt;1. 迪米特法则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-合成复用原则&quot;&gt;2. 合成复用原则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-共同封闭原则&quot;&gt;3. 共同封闭原则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-稳定抽象原则&quot;&gt;4. 稳定抽象原则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-稳定依赖原则&quot;&gt;5. 稳定依赖原则&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#封装继承多态&quot;&gt;封装、继承、多态&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-封装&quot;&gt;1. 封装&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-继承&quot;&gt;2. 继承&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-多态&quot;&gt;3. 多态&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#uml&quot;&gt;UML&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-类图&quot;&gt;1. 类图&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-时序图&quot;&gt;2. 时序图&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;S-O-L-I-D&quot;&gt;&lt;a href=&quot;#S-O-L-I-D&quot; class=&quot;headerlink&quot; title=&quot;S.O.L.I.D&quot;&gt;&lt;/a&gt;S.O.L.I.D&lt;/h1&gt;&lt;p&gt;S.O.L.I.D 是面向对象设计和编程 (OOD&amp;amp;OOP) 中几个重要编码原则 (Programming Priciple) 的首字母缩写。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;简写&lt;/th&gt;
&lt;th&gt;全拼&lt;/th&gt;
&lt;th&gt;中文翻译&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;SRP&lt;/td&gt;
&lt;td&gt;The Single Responsibility Principle&lt;/td&gt;
&lt;td&gt;单一责任原则&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;OCP&lt;/td&gt;
&lt;td&gt;The Open Closed Principle&lt;/td&gt;
&lt;td&gt;开放封闭原则&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;LSP&lt;/td&gt;
&lt;td&gt;The Liskov Substitution Principle&lt;/td&gt;
&lt;td&gt;里氏替换原则&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ISP&lt;/td&gt;
&lt;td&gt;The Interface Segregation Principle&lt;/td&gt;
&lt;td&gt;接口分离原则&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DIP&lt;/td&gt;
&lt;td&gt;The Dependency Inversion Principle&lt;/td&gt;
&lt;td&gt;依赖倒置原则&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;1-单一责任原则&quot;&gt;&lt;a href=&quot;#1-单一责任原则&quot; class=&quot;headerlink&quot; title=&quot;1. 单一责任原则&quot;&gt;&lt;/a&gt;1. 单一责任原则&lt;/h2&gt;&lt;p&gt;当需要修改某个类的时候原因有且只有一个。换句话说就是让一个类只做一种类型责任，当这个类需要承当其他类型的责任的时候，就需要分解这个类。&lt;/p&gt;
&lt;h2 id=&quot;2-开放封闭原则&quot;&gt;&lt;a href=&quot;#2-开放封闭原则&quot; class=&quot;headerlink&quot; title=&quot;2. 开放封闭原则&quot;&gt;&lt;/a&gt;2. 开放封闭原则&lt;/h2&gt;&lt;p&gt;软件实体应该是可扩展，而不可修改的。也就是说，对扩展是开放的，而对修改是封闭的。&lt;/p&gt;
&lt;h2 id=&quot;3-里氏替换原则&quot;&gt;&lt;a href=&quot;#3-里氏替换原则&quot; class=&quot;headerlink&quot; title=&quot;3. 里氏替换原则&quot;&gt;&lt;/a&gt;3. 里氏替换原则&lt;/h2&gt;&lt;p&gt;当一个子类的实例应该能够替换任何其超类的实例时，它们之间才具有 is-a 关系。&lt;/p&gt;
    
    </summary>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>重构</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E9%87%8D%E6%9E%84.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/重构.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T10:13:18.407Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#第一个案例">第一个案例</a></li><li><a href="#重构原则">重构原则</a><ul><li><a href="#定义">定义</a></li><li><a href="#为何重构">为何重构</a></li><li><a href="#三次法则">三次法则</a></li><li><a href="#间接层与重构">间接层与重构</a></li><li><a href="#修改接口">修改接口</a></li><li><a href="#何时不该重构">何时不该重构</a></li><li><a href="#重构与设计">重构与设计</a></li><li><a href="#重构与性能">重构与性能</a></li></ul></li><li><a href="#代码的坏味道">代码的坏味道</a><ul><li><a href="#1-duplicated-code重复代码">1. Duplicated Code（重复代码）</a></li><li><a href="#2-long-method过长函数">2. Long Method（过长函数）</a></li><li><a href="#3-large-class过大的类">3. Large Class（过大的类）</a></li><li><a href="#4-long-parameter-list过长的参数列表">4. Long Parameter List（过长的参数列表）</a></li><li><a href="#5-divergent-change发散式变化">5. Divergent Change（发散式变化）</a></li><li><a href="#6-shotgun-surgery散弹式修改">6. Shotgun Surgery（散弹式修改）</a></li><li><a href="#7-feature-envy依恋情结">7. Feature Envy（依恋情结）</a></li><li><a href="#8-data-clumps数据泥团">8. Data Clumps（数据泥团）</a></li><li><a href="#9-primitive-obsession基本类型偏执">9. Primitive Obsession（基本类型偏执）</a></li><li><a href="#10-switch-statementsswitch-惊悚现身">10. Switch Statements（switch 惊悚现身）</a></li><li><a href="#11-parallel-inheritance-hierarchies平行继承体系">11. Parallel Inheritance Hierarchies（平行继承体系）</a></li><li><a href="#12-lazy-class冗余类">12. Lazy Class（冗余类）</a></li><li><a href="#13-speculative-generality夸夸其谈未来性">13. Speculative Generality（夸夸其谈未来性）</a></li><li><a href="#14-temporary-field令人迷惑的暂时字段">14. Temporary Field（令人迷惑的暂时字段）</a></li><li><a href="#15-message-chains过度耦合的消息链">15. Message Chains（过度耦合的消息链）</a></li><li><a href="#16-middle-man中间人">16. Middle Man（中间人）</a></li><li><a href="#17-inappropriate-intimacy狎昵关系">17. Inappropriate Intimacy（狎昵关系）</a></li><li><a href="#18-alernative-classes-with-different-interfaces异曲同工的类">18. Alernative Classes with Different Interfaces（异曲同工的类）</a></li><li><a href="#19-incomplete-library-class不完美的类库">19. Incomplete Library Class（不完美的类库）</a></li><li><a href="#20-data-class幼稚的数据类">20. Data Class（幼稚的数据类）</a></li><li><a href="#21-refused-bequest被拒绝的馈赠">21. Refused Bequest（被拒绝的馈赠）</a></li><li><a href="#22-comments过多的注释">22. Comments（过多的注释）</a></li></ul></li><li><a href="#构筑测试体系">构筑测试体系</a></li><li><a href="#重新组织函数">重新组织函数</a><ul><li><a href="#1-extract-method提炼函数">1. Extract Method（提炼函数）</a></li><li><a href="#2-inline-method内联函数">2. Inline Method（内联函数）</a></li><li><a href="#3-inline-temp内联临时变量">3. Inline Temp（内联临时变量）</a></li><li><a href="#4-replace-temp-with-query以查询取代临时变量">4. Replace Temp with Query（以查询取代临时变量）</a></li><li><a href="#5-introduce-explaining-variable引起解释变量">5. Introduce Explaining Variable（引起解释变量）</a></li><li><a href="#6-split-temporary-variable分解临时变量">6. Split Temporary Variable（分解临时变量）</a></li><li><a href="#7-remove-assigments-to-parameters移除对参数的赋值">7. Remove Assigments to Parameters（移除对参数的赋值）</a></li><li><a href="#8-replace-method-with-method-object以函数对象取代函数">8. Replace Method with Method Object（以函数对象取代函数）</a></li><li><a href="#9-subsititute-algorithn替换算法">9. Subsititute Algorithn（替换算法）</a></li></ul></li><li><a href="#在对象之间搬移特性">在对象之间搬移特性</a><ul><li><a href="#1-move-method搬移函数">1. Move Method（搬移函数）</a></li><li><a href="#2-move-field搬移字段">2. Move Field（搬移字段）</a></li><li><a href="#3-extract-class提炼类">3. Extract Class（提炼类）</a></li><li><a href="#4-inline-class将类内联化">4. Inline Class（将类内联化）</a></li><li><a href="#5-hide-delegate隐藏“委托关系”">5. Hide Delegate（隐藏“委托关系”）</a></li><li><a href="#6-remove-middle-man移除中间人">6. Remove Middle Man（移除中间人）</a></li><li><a href="#7-introduce-foreign-method引入外加函数">7. Introduce Foreign Method（引入外加函数）</a></li><li><a href="#8-introduce-local-extension引入本地扩展">8. Introduce Local Extension（引入本地扩展）</a></li></ul></li><li><a href="#重新组织数据">重新组织数据</a><ul><li><a href="#1-self-encapsulate-field自封装字段">1. Self Encapsulate Field（自封装字段）</a></li><li><a href="#2-replace-data-value-with-object以对象取代数据值">2. Replace Data Value with Object（以对象取代数据值）</a></li><li><a href="#3-change-value-to-reference将值对象改成引用对象">3. Change Value to Reference（将值对象改成引用对象）</a></li><li><a href="#4-change-reference-to-value将引用对象改为值对象">4. Change Reference to value（将引用对象改为值对象）</a></li><li><a href="#5-replace-array-with-object以对象取代数组">5. Replace Array with Object（以对象取代数组）</a></li><li><a href="#6-duplicate-observed-data赋值“被监视数据”">6. Duplicate Observed Data（赋值“被监视数据”）</a></li><li><a href="#7-change-unidirectional-association-to-bidirectional将单向关联改为双向关联">7. Change Unidirectional Association to Bidirectional（将单向关联改为双向关联）</a></li><li><a href="#8-change-bidirectional-association-to-unidirectional将双向关联改为单向关联">8. Change Bidirectional Association to Unidirectional（将双向关联改为单向关联）</a></li><li><a href="#9-replace-magic-number-with-symbolic-constant以字面常量取代魔法数">9. Replace Magic Number with Symbolic Constant（以字面常量取代魔法数）</a></li><li><a href="#10-encapsulate-field封装字段">10. Encapsulate Field（封装字段）</a></li><li><a href="#11-encapsulate-collection封装集合">11. Encapsulate Collection（封装集合）</a></li><li><a href="#12-replace-record-with-data-class以数据类取代记录">12. Replace Record with Data Class（以数据类取代记录）</a></li><li><a href="#13-replace-type-code-with-class以类取代类型码">13. Replace Type Code with Class（以类取代类型码）</a></li><li><a href="#14-replace-type-code-with-subcalsses以子类取代类型码">14. Replace Type Code with Subcalsses（以子类取代类型码）</a></li><li><a href="#15-replace-type-code-with-statestrategy-以-statestrategy-取代类型码">15. Replace Type Code with State/Strategy （以 State/Strategy 取代类型码）</a></li><li><a href="#16-replace-subclass-with-fields以字段取代子类">16. Replace Subclass with Fields（以字段取代子类）</a></li></ul></li><li><a href="#简化条件表达式">简化条件表达式</a><ul><li><a href="#1-decompose-conditional分解条件表达式">1. Decompose Conditional（分解条件表达式）</a></li><li><a href="#2-consolidate-conditional-expression合并条件表达式">2. Consolidate Conditional Expression（合并条件表达式）</a></li><li><a href="#3-consolidate-duplicate-conditional-fragments-合并重复的条件片段">3. Consolidate Duplicate Conditional Fragments （合并重复的条件片段）</a></li><li><a href="#4-remove-control-flag移除控制标记">4. Remove Control Flag（移除控制标记）</a></li><li><a href="#5-replace-nested-conditional-with-guard-clauses-以卫语句取代嵌套条件表达式">5. Replace Nested Conditional with Guard Clauses （以卫语句取代嵌套条件表达式）</a></li><li><a href="#6-replace-conditional-with-polymorphism-以多态取代条件表达式">6. Replace Conditional with Polymorphism （以多态取代条件表达式）</a></li><li><a href="#7-introduce-null-object引入null对象">7. Introduce Null Object（引入Null对象）</a></li><li><a href="#8-introduce-assertion引入断言">8. Introduce Assertion（引入断言）</a></li></ul></li><li><a href="#简化函数调用">简化函数调用</a><ul><li><a href="#1-rename-method函数改名">1. Rename Method（函数改名）</a></li><li><a href="#2-add-parameter添加参数">2. Add Parameter（添加参数）</a></li><li><a href="#3-remove-parameter移除参数">3. Remove Parameter（移除参数）</a></li><li><a href="#4-separate-query-from-modifier将查询函数和修改函数分离">4. Separate Query from Modifier（将查询函数和修改函数分离）</a></li><li><a href="#5-parameterize-method令函数携带参数">5. Parameterize Method（令函数携带参数）</a></li><li><a href="#6-replace-parameter-with-explicit-methods以明确函数取代参数">6. Replace Parameter with Explicit Methods（以明确函数取代参数）</a></li><li><a href="#7-preserve-whole-object保持对象完整">7. Preserve Whole Object（保持对象完整）</a></li><li><a href="#8-replace-parameter-with-methods以函数取代参数">8. Replace Parameter with Methods（以函数取代参数）</a></li><li><a href="#9-introduce-parameter-object引入参数对象">9. Introduce Parameter Object（引入参数对象）</a></li><li><a href="#10-remove-setting-method移除设值函数">10. Remove Setting Method（移除设值函数）</a></li><li><a href="#11-hide-method隐藏函数">11. Hide Method（隐藏函数）</a></li><li><a href="#12-replace-constructor-with-factory-method-以工厂函数取代构造函数">12. Replace Constructor with Factory Method （以工厂函数取代构造函数）</a></li><li><a href="#13-encapsulate-downcast封装向下转型">13. Encapsulate Downcast（封装向下转型）</a></li><li><a href="#14-replace-error-code-with-exception-以异常取代错误码">14. Replace Error Code with Exception （以异常取代错误码）</a></li><li><a href="#15-replace-exception-with-test以测试取代异常">15. Replace Exception with Test（以测试取代异常）</a></li></ul></li><li><a href="#处理概括关系">处理概括关系</a><ul><li><a href="#1-pull-up-field字段上移">1. Pull Up Field（字段上移）</a></li><li><a href="#2-pull-up-method函数上移">2. Pull Up Method（函数上移）</a></li><li><a href="#3-pull-up-constructor-body构造函数本体上移">3. Pull Up Constructor Body（构造函数本体上移）</a></li><li><a href="#4-push-down-method函数下移">4. Push Down Method（函数下移）</a></li><li><a href="#5-push-down-field字段下移">5. Push Down Field（字段下移）</a></li><li><a href="#6-extract-subclass提炼子类">6. Extract Subclass（提炼子类）</a></li><li><a href="#7-extract-superclass提炼超类">7. Extract Superclass（提炼超类）</a></li><li><a href="#8-extract-interface提炼接口">8. Extract Interface（提炼接口）</a></li><li><a href="#9-collapse-hierarchy折叠继承体系">9. Collapse Hierarchy（折叠继承体系）</a></li><li><a href="#10-form-template-method塑造模板函数">10. Form Template Method（塑造模板函数）</a></li><li><a href="#11-replace-inheritance-with-delegation-以委托取代继承">11. Replace Inheritance with Delegation （以委托取代继承）</a></li><li><a href="#12-replace-delegation-with-inheritance-以继承取代委托">12. Replace Delegation with Inheritance （以继承取代委托）</a><!-- GFM-TOC --></li></ul></li></ul><h1 id="第一个案例"><a href="#第一个案例" class="headerlink" title="第一个案例"></a>第一个案例</h1><p>如果你发现自己需要为程序添加一个特性，而代码结构使你无法很方便地达成目的，那就先重构这个程序。</p><p>在重构前，需要先构建好可靠的测试环境，确保安全地重构。</p><p>重构需要以微小的步伐修改程序，如果重构过程发生错误，很容易就能发现错误。</p><p><strong>案例分析</strong> </p><p>影片出租店应用程序，需要计算每位顾客的消费金额。</p><p>包括三个类：Movie、Rental 和 Customer，Rental 包含租赁的 Movie 以及天数。</p><a id="more"></a><p><br><div align="center"> <img src="/pics/25d6d3d4-4726-47b1-a9cb-3316d1ff5dd5.png"> </div><br></p><p>最开始的实现是把所有的计费代码都放在 Customer 类中。</p><p>可以发现，该代码没有使用 Customer 类中的任何信息，更多的是使用 Rental 类的信息，因此第一个可以重构的点就是把具体计费的代码移到 Rental 类中，然后 Customer 类的 getTotalCharge() 方法只需要调用 Rental 类中的计费方法即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span>...</span></span><br><span class="line"><span class="class"><span class="title">double</span> <span class="title">getTotalCharge</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (rentals.hasMoreElements()) &#123;</span><br><span class="line">    <span class="keyword">double</span> thisAmount = <span class="number">0</span>;</span><br><span class="line">    Rental each = (Rental) rentals.nextElement();</span><br><span class="line">    <span class="keyword">switch</span> (each.getMovie().getPriceCode()) &#123;</span><br><span class="line">        <span class="keyword">case</span> Movie.REGULAR:</span><br><span class="line">            thisAmount += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (each.getDaysRented() &gt; <span class="number">2</span>)</span><br><span class="line">                thisAmount += (each.getDaysRented() - <span class="number">2</span>) * <span class="number">1.5</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Movie.NEW_RELEASE:</span><br><span class="line">            thisAmount += each.getDaysRented() * <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Movie.CHILDRENS:</span><br><span class="line">            thisAmount += <span class="number">1.5</span>;</span><br><span class="line">            <span class="keyword">if</span> (each.getDaysRented() &gt; <span class="number">3</span>)</span><br><span class="line">                thisAmount += (each.getDaysRented() - <span class="number">3</span>) * <span class="number">1.5</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 switch 的准则是：只能在对象自己的数据上使用，而不能在另一个对象的数据基础上使用。解释如下：switch 使用的数据通常是一组相关的数据，例如上面的代码使用了 Movie 的多种类别数据。当这组类别的数据发生改变时，例如上面的代码中增加 Movie 的类别或者修改一种 Movie 类别的计费方法，就需要修改 switch 代码。如果允许违反了准则，就会有多个地方的 switch 使用了这部分的数据，那么需要打开所有的 switch 代码进行修改。</p><p>以下是继承 Movie 的多态解决方案，这种方案可以解决上述的 switch 问题，因为每种电影类别的计费方式都被放到了对应 Movie 子类中，当变化发生时，只需要去修改对应子类中的代码即可。</p><p><br><div align="center"> <img src="/pics/76b48b4c-8999-4967-893b-832602e73285.png"> </div><br></p><p>但是由于 Movie 可以在其生命周期内修改自己的类别，一个对象却不能在生命周期内修改自己所属的类，因此这种方案不可行。可以使用策略模式来解决这个问题（原书写的是使用状态模式，但是这里应该为策略模式，具体可以参考设计模式内容）。</p><p>下图中，Price 有多种实现，Movie 组合了一个 Price 对象，并且在运行时可以改变组合的 Price 对象，从而使得它的计费方式发生改变。</p><p><br><div align="center"> <img src="/pics/2a842a14-e4ab-4f37-83fa-f82c206fe426.png"> </div><br></p><p>重构后整体的类图和时序图如下：</p><p><br><div align="center"> <img src="/pics/9d549816-60b7-4899-9877-23b01503ab13.png"> </div><br></p><p><br><div align="center"> <img src="/pics/2c8a7a87-1bf1-4d66-9ba9-225a1add0a51.png"> </div><br></p><h1 id="重构原则"><a href="#重构原则" class="headerlink" title="重构原则"></a>重构原则</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>重构是对软件内部结构的一种调整，目的是在不改变软件可观察行为的前提下，提高其可理解性，降低其修改成本。</p><h2 id="为何重构"><a href="#为何重构" class="headerlink" title="为何重构"></a>为何重构</h2><ul><li>改进软件设计</li><li>使软件更容易理解</li><li>帮助找到 Bug</li><li>提高编程速度</li></ul><h2 id="三次法则"><a href="#三次法则" class="headerlink" title="三次法则"></a>三次法则</h2><p>第一次做某件事时只管去做；第二次做类似事情时可以去做；第三次再做类似的事，就应该重构。</p><h2 id="间接层与重构"><a href="#间接层与重构" class="headerlink" title="间接层与重构"></a>间接层与重构</h2><p>计算机科学中的很多问题可以通过增加一个间接层来解决，间接层具有以下价值：</p><ul><li>允许逻辑共享</li><li>分开解释意图和实现</li><li>隔离变化</li><li>封装条件逻辑。</li></ul><p>重构可以理解为在适当的位置插入间接层以及在不需要时移除间接层。</p><h2 id="修改接口"><a href="#修改接口" class="headerlink" title="修改接口"></a>修改接口</h2><p>如果重构手法改变了已发布的接口，就必须维护新旧两个接口。</p><p>可以保留旧接口，让旧接口去调用新接口，并且使用 Java 提供的 @deprecation 将旧接口标记为弃用。</p><p>可见修改接口特别麻烦，因此除非真有必要，否则不要发布接口，并且不要过早发布接口。</p><h2 id="何时不该重构"><a href="#何时不该重构" class="headerlink" title="何时不该重构"></a>何时不该重构</h2><p>当现有代码过于混乱时，应当重写而不是重构。</p><p>一个折中的办法是，将代码封装成一个个组件，然后对各个组件做重写或者重构的决定。</p><h2 id="重构与设计"><a href="#重构与设计" class="headerlink" title="重构与设计"></a>重构与设计</h2><p>软件开发无法预先设计，因为开发过程有很多变化发生，在最开始不可能都把所有情况考虑进去。</p><p>重构可以简化设计，重构在一个简单的设计上进行修修改改，当变化发生时，以一种灵活的方式去应对变化，进而带来更好的设计。</p><h2 id="重构与性能"><a href="#重构与性能" class="headerlink" title="重构与性能"></a>重构与性能</h2><p>为了软代码更容易理解，重构可能会导致性能减低。</p><p>在编写代码时，不用对性能过多关注，只有在最后性能优化阶段再考虑性能问题。</p><p>应当只关注关键代码的性能，因为只有一小部分的代码是关键代码。</p><h1 id="代码的坏味道"><a href="#代码的坏味道" class="headerlink" title="代码的坏味道"></a>代码的坏味道</h1><p>本章主要介绍一些不好的代码，也就是说这些代码应该被重构。</p><p>文中提到的具体重构原则可以先忽略。</p><h2 id="1-Duplicated-Code（重复代码）"><a href="#1-Duplicated-Code（重复代码）" class="headerlink" title="1. Duplicated Code（重复代码）"></a>1. Duplicated Code（重复代码）</h2><p>同一个类的两个函数有相同表达式，则用 Extract Method 提取出重复代码；</p><p>两个互为兄弟的子类含有相同的表达式，先使用 Extract Method，然后把提取出来的函数 Pull Up Method 推入超类。</p><p>如果只是部分相同，用 Extract Method 分离出相似部分和差异部分，然后使用 Form Template Method 这种模板方法设计模式。</p><p>如果两个毫不相关的类出现重复代码，则使用 Extract Class 方法将重复代码提取到一个独立类中。</p><h2 id="2-Long-Method（过长函数）"><a href="#2-Long-Method（过长函数）" class="headerlink" title="2. Long Method（过长函数）"></a>2. Long Method（过长函数）</h2><p>函数应该尽可能小，因为小函数具有解释能力、共享能力、选择能力。</p><p>分解长函数的原则：当需要用注释来说明一段代码时，就需要把这部分代码写入一个独立的函数中。</p><p>Extract Method 会把很多参数和临时变量都当做参数，可以用 Replace Temp with Query 消除临时变量，Introduce Parameter Object 和 Preserve Whole Object 可以将过长的参数列变得更简洁。</p><p>条件和循环语句往往也需要提取到新的函数中。</p><h2 id="3-Large-Class（过大的类）"><a href="#3-Large-Class（过大的类）" class="headerlink" title="3. Large Class（过大的类）"></a>3. Large Class（过大的类）</h2><p>应该尽可能让一个类只做一件事，而过大的类做了过多事情，需要使用 Extract Class 或 Extract Subclass。</p><p>先确定客户端如何使用该类，然后运用 Extract Interface 为每一种使用方式提取出一个接口。</p><h2 id="4-Long-Parameter-List（过长的参数列表）"><a href="#4-Long-Parameter-List（过长的参数列表）" class="headerlink" title="4. Long Parameter List（过长的参数列表）"></a>4. Long Parameter List（过长的参数列表）</h2><p>太长的参数列表往往会造成前后不一致，不易使用。</p><p>面向对象程序中，函数所需要的数据通常内在宿主类中找到。</p><h2 id="5-Divergent-Change（发散式变化）"><a href="#5-Divergent-Change（发散式变化）" class="headerlink" title="5. Divergent Change（发散式变化）"></a>5. Divergent Change（发散式变化）</h2><p>设计原则：一个类应该只有一个引起改变的原因。也就是说，针对某一外界变化所有相应的修改，都只应该发生在单一类中。</p><p>针对某种原因的变化，使用 Extract Class 将它提炼到一个类中。</p><h2 id="6-Shotgun-Surgery（散弹式修改）"><a href="#6-Shotgun-Surgery（散弹式修改）" class="headerlink" title="6. Shotgun Surgery（散弹式修改）"></a>6. Shotgun Surgery（散弹式修改）</h2><p>一个变化引起多个类修改；</p><p>使用 Move Method 和 Move Field 把所有需要修改的代码放到同一个类中。</p><h2 id="7-Feature-Envy（依恋情结）"><a href="#7-Feature-Envy（依恋情结）" class="headerlink" title="7. Feature Envy（依恋情结）"></a>7. Feature Envy（依恋情结）</h2><p>一个函数对某个类的兴趣高于对自己所处类的兴趣，通常是过多访问其它类的数据，</p><p>使用 Move Method 将它移到该去的地方，如果对多个类都有 Feature Envy，先用 Extract Method 提取出多个函数。</p><h2 id="8-Data-Clumps（数据泥团）"><a href="#8-Data-Clumps（数据泥团）" class="headerlink" title="8. Data Clumps（数据泥团）"></a>8. Data Clumps（数据泥团）</h2><p>有些数据经常一起出现，比如两个类具有相同的字段、许多函数有相同的参数，这些绑定在一起出现的数据应该拥有属于它们自己的对象。</p><p>使用 Extract Class 将它们放在一起。</p><h2 id="9-Primitive-Obsession（基本类型偏执）"><a href="#9-Primitive-Obsession（基本类型偏执）" class="headerlink" title="9. Primitive Obsession（基本类型偏执）"></a>9. Primitive Obsession（基本类型偏执）</h2><p>使用类往往比使用基本类型更好，使用 Replace Data Value with Object 将数据值替换为对象。</p><h2 id="10-Switch-Statements（switch-惊悚现身）"><a href="#10-Switch-Statements（switch-惊悚现身）" class="headerlink" title="10. Switch Statements（switch 惊悚现身）"></a>10. Switch Statements（switch 惊悚现身）</h2><p>具体参见第一章的案例。</p><h2 id="11-Parallel-Inheritance-Hierarchies（平行继承体系）"><a href="#11-Parallel-Inheritance-Hierarchies（平行继承体系）" class="headerlink" title="11. Parallel Inheritance Hierarchies（平行继承体系）"></a>11. Parallel Inheritance Hierarchies（平行继承体系）</h2><p>每当为某个类增加一个子类，必须也为另一个类相应增加一个子类。</p><p>这种结果会带来一些重复性，消除重复性的一般策略：让一个继承体系的实例引用另一个继承体系的实例。</p><h2 id="12-Lazy-Class（冗余类）"><a href="#12-Lazy-Class（冗余类）" class="headerlink" title="12. Lazy Class（冗余类）"></a>12. Lazy Class（冗余类）</h2><p>如果一个类没有做足够多的工作，就应该消失。</p><h2 id="13-Speculative-Generality（夸夸其谈未来性）"><a href="#13-Speculative-Generality（夸夸其谈未来性）" class="headerlink" title="13. Speculative Generality（夸夸其谈未来性）"></a>13. Speculative Generality（夸夸其谈未来性）</h2><p>有些内容是用来处理未来可能发生的变化，但是往往会造成系统难以理解和维护，并且预测未来可能发生的改变很可能和最开始的设想相反。因此，如果不是必要，就不要这么做。</p><h2 id="14-Temporary-Field（令人迷惑的暂时字段）"><a href="#14-Temporary-Field（令人迷惑的暂时字段）" class="headerlink" title="14. Temporary Field（令人迷惑的暂时字段）"></a>14. Temporary Field（令人迷惑的暂时字段）</h2><p>某个字段仅为某种特定情况而设，这样的代码不易理解，因为通常认为对象在所有时候都需要它的所有字段。</p><p>把这种字段和特定情况的处理操作使用 Extract Class 提炼到一个独立类中。</p><h2 id="15-Message-Chains（过度耦合的消息链）"><a href="#15-Message-Chains（过度耦合的消息链）" class="headerlink" title="15. Message Chains（过度耦合的消息链）"></a>15. Message Chains（过度耦合的消息链）</h2><p>一个对象请求另一个对象，然后再向后者请求另一个对象，然后…，这就是消息链。采用这种方式，意味着客户代码将与对象间的关系紧密耦合。</p><p>改用函数链，用函数委托另一个对象来处理。</p><h2 id="16-Middle-Man（中间人）"><a href="#16-Middle-Man（中间人）" class="headerlink" title="16. Middle Man（中间人）"></a>16. Middle Man（中间人）</h2><p>中间人负责处理委托给它的操作，如果一个类中有过多的函数都委托给其它类，那就是过度运用委托，应当 Remove Middle Man，直接与负责的对象打交道。</p><h2 id="17-Inappropriate-Intimacy（狎昵关系）"><a href="#17-Inappropriate-Intimacy（狎昵关系）" class="headerlink" title="17. Inappropriate Intimacy（狎昵关系）"></a>17. Inappropriate Intimacy（狎昵关系）</h2><p>两个类多于亲密，花费太多时间去探讨彼此的 private 成分。</p><h2 id="18-Alernative-Classes-with-Different-Interfaces（异曲同工的类）"><a href="#18-Alernative-Classes-with-Different-Interfaces（异曲同工的类）" class="headerlink" title="18. Alernative Classes with Different Interfaces（异曲同工的类）"></a>18. Alernative Classes with Different Interfaces（异曲同工的类）</h2><p>两个函数做同一件事，却有着不同的签名。</p><p>使用 Rename Method 根据它们的用途重新命名。</p><h2 id="19-Incomplete-Library-Class（不完美的类库）"><a href="#19-Incomplete-Library-Class（不完美的类库）" class="headerlink" title="19. Incomplete Library Class（不完美的类库）"></a>19. Incomplete Library Class（不完美的类库）</h2><p>类库的设计者不可能设计出完美的类库，当我们需要对类库进行一些修改时，可以使用以下两种方法：如果只是修改一两个函数，使用 Introduce Foreign Method；如果要添加一大堆额外行为，使用 Introduce Local Extension。</p><h2 id="20-Data-Class（幼稚的数据类）"><a href="#20-Data-Class（幼稚的数据类）" class="headerlink" title="20. Data Class（幼稚的数据类）"></a>20. Data Class（幼稚的数据类）</h2><p>它只拥有一些数据字段，以及用于访问这些字段的函数，除此之外一无长物。</p><p>找出字段使用的地方，然后把相应的操作移到 Data Class 中。</p><h2 id="21-Refused-Bequest（被拒绝的馈赠）"><a href="#21-Refused-Bequest（被拒绝的馈赠）" class="headerlink" title="21. Refused Bequest（被拒绝的馈赠）"></a>21. Refused Bequest（被拒绝的馈赠）</h2><p>子类不想继承超类的所有函数和数据。</p><p>为子类新建一个兄弟类，不需要的函数或数据使用 Push Down Method 和 Push Down Field 下推给那个兄弟。</p><h2 id="22-Comments（过多的注释）"><a href="#22-Comments（过多的注释）" class="headerlink" title="22. Comments（过多的注释）"></a>22. Comments（过多的注释）</h2><p>使用 Extract Method 提炼出需要注释的部分，然后用函数名来解释函数的行为。</p><h1 id="构筑测试体系"><a href="#构筑测试体系" class="headerlink" title="构筑测试体系"></a>构筑测试体系</h1><p>Java 可以使用 Junit 进行单元测试。</p><p>测试应该能够完全自动化，并能检查测试的结果。Junit 可以做到。</p><p>小步修改，频繁测试。</p><p>单元测试的对象是类的方法，而功能测是以客户的角度保证软件正常运行。</p><p>应当集中测试可能出错的边界条件。</p><h1 id="重新组织函数"><a href="#重新组织函数" class="headerlink" title="重新组织函数"></a>重新组织函数</h1><h2 id="1-Extract-Method（提炼函数）"><a href="#1-Extract-Method（提炼函数）" class="headerlink" title="1. Extract Method（提炼函数）"></a>1. Extract Method（提炼函数）</h2><p>将这段代码放进一个独立函数中，并让函数名称解释该函数的用途。</p><h2 id="2-Inline-Method（内联函数）"><a href="#2-Inline-Method（内联函数）" class="headerlink" title="2. Inline Method（内联函数）"></a>2. Inline Method（内联函数）</h2><p>一个函数的本体与名称同样清楚易懂。</p><p>在函数调用点插入函数本体，然后移除该函数。</p><h2 id="3-Inline-Temp（内联临时变量）"><a href="#3-Inline-Temp（内联临时变量）" class="headerlink" title="3. Inline Temp（内联临时变量）"></a>3. Inline Temp（内联临时变量）</h2><p>一个临时变量，只被简单表达式赋值一次，而它妨碍了其它重构手法。</p><p>将所有对该变量的引用替换为对它赋值的那个表达式自身。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> basePrice = anOrder.basePrice();</span><br><span class="line"><span class="keyword">return</span> basePrice &gt; <span class="number">1000</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> anOrder.basePrice() &gt; <span class="number">1000</span>;</span><br></pre></td></tr></table></figure><h2 id="4-Replace-Temp-with-Query（以查询取代临时变量）"><a href="#4-Replace-Temp-with-Query（以查询取代临时变量）" class="headerlink" title="4. Replace Temp with Query（以查询取代临时变量）"></a>4. Replace Temp with Query（以查询取代临时变量）</h2><p>以临时变量保存某一表达式的运算结果，将这个表达式提炼到一个独立函数中，将所有对临时变量的引用点替换为对新函数的调用。Replace Temp with Query 往往是 Extract Method 之前必不可少的一个步骤，因为局部变量会使代码难以提炼。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> basePrice = quantity * itemPrice;</span><br><span class="line"><span class="keyword">if</span>(basePrice &gt; <span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> basePrice * <span class="number">0.95</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> basePrice * <span class="number">0.98</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(basePrice() &gt; <span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> basePrice() * <span class="number">0.95</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> basePrice() * <span class="number">0.98</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">basePrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> quantity * itemPrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-Introduce-Explaining-Variable（引起解释变量）"><a href="#5-Introduce-Explaining-Variable（引起解释变量）" class="headerlink" title="5. Introduce Explaining Variable（引起解释变量）"></a>5. Introduce Explaining Variable（引起解释变量）</h2><p>将复杂表达式（或其中一部分）的结果放进一个临时变量，以此变量名称来解释表达式用途。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((platform.toUpperCase().indexOf(<span class="string">"MAC"</span>) &gt; -<span class="number">1</span>) &amp;&amp;</span><br><span class="line">  (browser.toUpperCase().indexOf(<span class="string">"IE"</span>) &gt; -<span class="number">1</span>) &amp;&amp;</span><br><span class="line">  wasInitialized() &amp;&amp; resize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> isMacOS = platform.toUpperCase().indexOf(<span class="string">"MAC"</span>) &gt; -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> isIEBrower = browser.toUpperCase().indexOf(<span class="string">"IE"</span>) &gt; -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> wasResized = resize &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isMacOS &amp;&amp; isIEBrower &amp;&amp; wasInitialized() &amp;&amp; wasResized) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-Split-Temporary-Variable（分解临时变量）"><a href="#6-Split-Temporary-Variable（分解临时变量）" class="headerlink" title="6. Split Temporary Variable（分解临时变量）"></a>6. Split Temporary Variable（分解临时变量）</h2><p>某个临时变量被赋值超过一次，它既不是循环变量，也不是用于收集计算结果。</p><p>针对每次赋值，创造一个独立、对应的临时变量，每个临时变量只承担一个责任。</p><h2 id="7-Remove-Assigments-to-Parameters（移除对参数的赋值）"><a href="#7-Remove-Assigments-to-Parameters（移除对参数的赋值）" class="headerlink" title="7. Remove Assigments to Parameters（移除对参数的赋值）"></a>7. Remove Assigments to Parameters（移除对参数的赋值）</h2><p>以一个临时变量取代对该参数的赋值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">discount</span> <span class="params">(<span class="keyword">int</span> inputVal, <span class="keyword">int</span> quentity, <span class="keyword">int</span> yearToDate)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (inputVal &gt; <span class="number">50</span>) inputVal -= <span class="number">2</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">discount</span> <span class="params">(<span class="keyword">int</span> inputVal, <span class="keyword">int</span> quentity, <span class="keyword">int</span> yearToDate)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = inputVal;</span><br><span class="line">    <span class="keyword">if</span> (inputVal &gt; <span class="number">50</span>) result -= <span class="number">2</span>;</span><br></pre></td></tr></table></figure><h2 id="8-Replace-Method-with-Method-Object（以函数对象取代函数）"><a href="#8-Replace-Method-with-Method-Object（以函数对象取代函数）" class="headerlink" title="8. Replace Method with Method Object（以函数对象取代函数）"></a>8. Replace Method with Method Object（以函数对象取代函数）</h2><p>当对一个大型函数采用 Extract Method 时，由于包含了局部变量使得很难进行该操作。</p><p>将这个函数放进一个单独对象中，如此一来局部变量就成了对象内的字段。然后可以在同一个对象中将这个大型函数分解为多个小型函数。</p><h2 id="9-Subsititute-Algorithn（替换算法）"><a href="#9-Subsititute-Algorithn（替换算法）" class="headerlink" title="9. Subsititute Algorithn（替换算法）"></a>9. Subsititute Algorithn（替换算法）</h2><h1 id="在对象之间搬移特性"><a href="#在对象之间搬移特性" class="headerlink" title="在对象之间搬移特性"></a>在对象之间搬移特性</h1><h2 id="1-Move-Method（搬移函数）"><a href="#1-Move-Method（搬移函数）" class="headerlink" title="1. Move Method（搬移函数）"></a>1. Move Method（搬移函数）</h2><p>类中的某个函数与另一个类进行更多交流：调用后者或者被后者调用。</p><p>将这个函数搬移到另一个类中。</p><h2 id="2-Move-Field（搬移字段）"><a href="#2-Move-Field（搬移字段）" class="headerlink" title="2. Move Field（搬移字段）"></a>2. Move Field（搬移字段）</h2><p>类中的某个字段被另一个类更多地用到，这里的用到是指调用取值设值函数，应当把该字段移到另一个类中。</p><h2 id="3-Extract-Class（提炼类）"><a href="#3-Extract-Class（提炼类）" class="headerlink" title="3. Extract Class（提炼类）"></a>3. Extract Class（提炼类）</h2><p>某个类做了应当由两个类做的事。</p><p>应当建立一个新类，将相关的字段和函数从旧类搬移到新类。</p><h2 id="4-Inline-Class（将类内联化）"><a href="#4-Inline-Class（将类内联化）" class="headerlink" title="4. Inline Class（将类内联化）"></a>4. Inline Class（将类内联化）</h2><p>与 Extract Class 相反。</p><h2 id="5-Hide-Delegate（隐藏“委托关系”）"><a href="#5-Hide-Delegate（隐藏“委托关系”）" class="headerlink" title="5. Hide Delegate（隐藏“委托关系”）"></a>5. Hide Delegate（隐藏“委托关系”）</h2><p>建立所需的函数，隐藏委托关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    Department department;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Department <span class="title">getDepartment</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> department;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Department</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Person manager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">getManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果客户希望知道某人的经理是谁，必须获得 Department 对象，这样就对客户揭露了 Department 的工作原理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person manager = john.getDepartment().getManager();</span><br></pre></td></tr></table></figure><p>通过为 Peron 建立一个函数来隐藏这种委托关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Person <span class="title">getManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> department.getManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-Remove-Middle-Man（移除中间人）"><a href="#6-Remove-Middle-Man（移除中间人）" class="headerlink" title="6. Remove Middle Man（移除中间人）"></a>6. Remove Middle Man（移除中间人）</h2><p>与 Hide Delegate 相反，本方法需要移除委托函数，让客户直接调用委托类。</p><p>Hide Delegate 有很大好处，但是它的代价是：每当客户要使用受托类的新特性时，就必须在服务器端添加一个简单的委托函数。随着受委托的特性越来越多，服务器类完全变成了一个“中间人”。</p><h2 id="7-Introduce-Foreign-Method（引入外加函数）"><a href="#7-Introduce-Foreign-Method（引入外加函数）" class="headerlink" title="7. Introduce Foreign Method（引入外加函数）"></a>7. Introduce Foreign Method（引入外加函数）</h2><p>需要为提供服务的类添加一个函数，但是无法修改这个类。</p><p>可以在客户类中建立一个函数，并以第一参数形式传入一个服务类的实例，让客户类组合服务器实例。</p><h2 id="8-Introduce-Local-Extension（引入本地扩展）"><a href="#8-Introduce-Local-Extension（引入本地扩展）" class="headerlink" title="8. Introduce Local Extension（引入本地扩展）"></a>8. Introduce Local Extension（引入本地扩展）</h2><p>和 Introduce Foreign Method 目的一样，但是 Introduce Local Extension 通过建立新的类来实现。有两种方式：子类或者包装类，子类就是通过继承实现，包装类就是通过组合实现。</p><h1 id="重新组织数据"><a href="#重新组织数据" class="headerlink" title="重新组织数据"></a>重新组织数据</h1><h2 id="1-Self-Encapsulate-Field（自封装字段）"><a href="#1-Self-Encapsulate-Field（自封装字段）" class="headerlink" title="1. Self Encapsulate Field（自封装字段）"></a>1. Self Encapsulate Field（自封装字段）</h2><p>为字段建立取值/设值函数，并用这些函数来访问字段。只有当子类想访问超类的一个字段，又想在子类中将对这个字段访问改为一个计算后的值，才使用这种方式，否则直接访问字段的方式简洁明了。</p><h2 id="2-Replace-Data-Value-with-Object（以对象取代数据值）"><a href="#2-Replace-Data-Value-with-Object（以对象取代数据值）" class="headerlink" title="2. Replace Data Value with Object（以对象取代数据值）"></a>2. Replace Data Value with Object（以对象取代数据值）</h2><p>在开发初期，往往会用简单的数据项表示简单的情况，但是随着开发的进行，一些简单数据项会具有一些特殊行为。比如一开始会把电话号码存成字符串，但是随后发现电话号码需要“格式化”、“抽取区号”之类的特殊行为。</p><h2 id="3-Change-Value-to-Reference（将值对象改成引用对象）"><a href="#3-Change-Value-to-Reference（将值对象改成引用对象）" class="headerlink" title="3. Change Value to Reference（将值对象改成引用对象）"></a>3. Change Value to Reference（将值对象改成引用对象）</h2><p>将彼此相等的实例替换为同一个对象。这就要用一个工厂来创建这种唯一对象，工厂类中需要保留一份已经创建对象的列表，当要创建一个对象时，先查找这份列表中是否已经存在该对象，如果存在，则返回列表中的这个对象；否则，新建一个对象，添加到列表中，并返回该对象。</p><h2 id="4-Change-Reference-to-value（将引用对象改为值对象）"><a href="#4-Change-Reference-to-value（将引用对象改为值对象）" class="headerlink" title="4. Change Reference to value（将引用对象改为值对象）"></a>4. Change Reference to value（将引用对象改为值对象）</h2><p>以 Change Value to Reference 相反。值对象有个非常重要的特性：它是不可变的，不可变表示如果要改变这个对象，必须用一个新的对象来替换旧对象，而不是修改旧对象。</p><p>需要为值对象实现 equals() 和 hashCode() 方法</p><h2 id="5-Replace-Array-with-Object（以对象取代数组）"><a href="#5-Replace-Array-with-Object（以对象取代数组）" class="headerlink" title="5. Replace Array with Object（以对象取代数组）"></a>5. Replace Array with Object（以对象取代数组）</h2><p>有一个数组，其中的元素各自代表不同的东西。</p><p>以对象替换数组，对于数组中的每个元素，以一个字段来表示，这样方便操作，也更容易理解。</p><h2 id="6-Duplicate-Observed-Data（赋值“被监视数据”）"><a href="#6-Duplicate-Observed-Data（赋值“被监视数据”）" class="headerlink" title="6. Duplicate Observed Data（赋值“被监视数据”）"></a>6. Duplicate Observed Data（赋值“被监视数据”）</h2><p>一些领域数据置身于 GUI 控件中，而领域函数需要访问这些数据。</p><p>将该数据赋值到一个领域对象中，建立一个 Oberver 模式，用以同步领域对象和 GUI 对象内的重复数据。</p><p><br><div align="center"> <img src="/pics/e024bd7e-fb4e-4239-9451-9a6227f50b00.jpg"> </div><br></p><h2 id="7-Change-Unidirectional-Association-to-Bidirectional（将单向关联改为双向关联）"><a href="#7-Change-Unidirectional-Association-to-Bidirectional（将单向关联改为双向关联）" class="headerlink" title="7. Change Unidirectional Association to Bidirectional（将单向关联改为双向关联）"></a>7. Change Unidirectional Association to Bidirectional（将单向关联改为双向关联）</h2><p>当两个类都需要对方的特性时，可以使用双向关联。</p><p>有两个类，分别为订单 Order 和客户 Customer，Order 引用了 Customer，Customer 也需要引用 Order 来查看其所有订单详情。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Customer customer;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomer</span><span class="params">(Customer customer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.customer != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">this</span>.customer.removeOrder(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.customer = customer;</span><br><span class="line">        <span class="keyword">this</span>.customer.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Curstomer</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;Order&gt; orders = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeOrder</span><span class="params">(Order order)</span></span>&#123;</span><br><span class="line">        orders.remove(order);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOrder</span><span class="params">(Order order)</span></span>&#123;</span><br><span class="line">        orders.add(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到，这里让 Curstomer 类来控制关联关系。有以下原则来决定哪个类来控制关联关系：如果某个对象是组成另一个对象的部件，那么由后者负责控制关联关系；如果是一对多关系，则由单一引用那一方来控制关联关系。</p><h2 id="8-Change-Bidirectional-Association-to-Unidirectional（将双向关联改为单向关联）"><a href="#8-Change-Bidirectional-Association-to-Unidirectional（将双向关联改为单向关联）" class="headerlink" title="8. Change Bidirectional Association to Unidirectional（将双向关联改为单向关联）"></a>8. Change Bidirectional Association to Unidirectional（将双向关联改为单向关联）</h2><p>和 Change Unidirectional Association to Bidirectiona 为反操作。</p><p>双向关联维护成本高，并且也不易于理解。大量的双向连接很容易造成“僵尸对象”：某个对象本身已经死亡了，却保留在系统中，因为它的引用还没有全部完全清除。</p><h2 id="9-Replace-Magic-Number-with-Symbolic-Constant（以字面常量取代魔法数）"><a href="#9-Replace-Magic-Number-with-Symbolic-Constant（以字面常量取代魔法数）" class="headerlink" title="9. Replace Magic Number with Symbolic Constant（以字面常量取代魔法数）"></a>9. Replace Magic Number with Symbolic Constant（以字面常量取代魔法数）</h2><p>创建一个常量，根据其意义为它命名，并将字面常量换位这个常量。</p><h2 id="10-Encapsulate-Field（封装字段）"><a href="#10-Encapsulate-Field（封装字段）" class="headerlink" title="10. Encapsulate Field（封装字段）"></a>10. Encapsulate Field（封装字段）</h2><p>public 字段应当改为 private，并提供相应的访问函数。</p><h2 id="11-Encapsulate-Collection（封装集合）"><a href="#11-Encapsulate-Collection（封装集合）" class="headerlink" title="11. Encapsulate Collection（封装集合）"></a>11. Encapsulate Collection（封装集合）</h2><p>函数返回集合的一个只读副本，并在这个类中提供添加/移除集合元素的函数。如果函数返回集合自身，会让用户得以修改集合内容而集合拥有者却一无所知。</p><h2 id="12-Replace-Record-with-Data-Class（以数据类取代记录）"><a href="#12-Replace-Record-with-Data-Class（以数据类取代记录）" class="headerlink" title="12. Replace Record with Data Class（以数据类取代记录）"></a>12. Replace Record with Data Class（以数据类取代记录）</h2><h2 id="13-Replace-Type-Code-with-Class（以类取代类型码）"><a href="#13-Replace-Type-Code-with-Class（以类取代类型码）" class="headerlink" title="13. Replace Type Code with Class（以类取代类型码）"></a>13. Replace Type Code with Class（以类取代类型码）</h2><p>类中有一个数值类型码，但它并不影响类的行为，就用一个新类替换该数值类型码。如果类型码出现在 switch 语句中，需要使用 Replace Conditional with Polymorphism 去掉 switch，首先必须运用 Replace Type Code with Subcalss 或 Replace Type Code with State/Strategy 去掉类型码。</p><p><br><div align="center"> <img src="/pics/27c2e0b3-8f95-453d-bedc-6398a8566ce9.jpg"> </div><br></p><h2 id="14-Replace-Type-Code-with-Subcalsses（以子类取代类型码）"><a href="#14-Replace-Type-Code-with-Subcalsses（以子类取代类型码）" class="headerlink" title="14. Replace Type Code with Subcalsses（以子类取代类型码）"></a>14. Replace Type Code with Subcalsses（以子类取代类型码）</h2><p>有一个不可变的类型码，它会影响类的行为，以子类取代这个类型码。</p><p><br><div align="center"> <img src="/pics/c41d3977-e0e7-4ee4-93e1-d84f1ae3e20e.jpg"> </div><br></p><h2 id="15-Replace-Type-Code-with-State-Strategy-（以-State-Strategy-取代类型码）"><a href="#15-Replace-Type-Code-with-State-Strategy-（以-State-Strategy-取代类型码）" class="headerlink" title="15. Replace Type Code with State/Strategy （以 State/Strategy 取代类型码）"></a>15. Replace Type Code with State/Strategy （以 State/Strategy 取代类型码）</h2><p>有一个可变的类型码，它会影响类的行为，以状态对象取代类型码。</p><p>和 Replace Type Code with Subcalsses 的区别是 Replace Type Code with State/Strategy 的类型码是动态可变的，前者通过继承的方式来实现，后者通过组合的方式来实现。因为类型码可变，如果通过继承的方式，一旦一个对象的类型码改变，那么就要改变用新的对象来取代旧对象，而客户端难以改变新的对象。但是通过组合的方式，改变引用的状态类是很容易的。</p><p><br><div align="center"> <img src="/pics/81fd1d6f-a3b2-4160-9a0a-1f7cb50ba440.jpg"> </div><br></p><h2 id="16-Replace-Subclass-with-Fields（以字段取代子类）"><a href="#16-Replace-Subclass-with-Fields（以字段取代子类）" class="headerlink" title="16. Replace Subclass with Fields（以字段取代子类）"></a>16. Replace Subclass with Fields（以字段取代子类）</h2><p>各个子类的唯一差别只在“返回常量数据”的函数上。</p><p><br><div align="center"> <img src="/pics/f2e0cee9-ecdc-4a96-853f-d9f6a1ad6ad1.jpg"> </div><br></p><h1 id="简化条件表达式"><a href="#简化条件表达式" class="headerlink" title="简化条件表达式"></a>简化条件表达式</h1><h2 id="1-Decompose-Conditional（分解条件表达式）"><a href="#1-Decompose-Conditional（分解条件表达式）" class="headerlink" title="1. Decompose Conditional（分解条件表达式）"></a>1. Decompose Conditional（分解条件表达式）</h2><p>对于一个复杂的条件语句，可以从 if、then、else 三个段落中分别提炼出独立函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(data.befor(SUMMER_START) || data.after(SUMMER_END))</span><br><span class="line">    charge = quantity * winterRate + winterServiceCharge;</span><br><span class="line"><span class="keyword">else</span> charge = quantity * summerRate;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(notSummer(date))</span><br><span class="line">    charge = winterCharge(quantity);</span><br><span class="line"><span class="keyword">else</span> charge = summerCharge(quantity);</span><br></pre></td></tr></table></figure><h2 id="2-Consolidate-Conditional-Expression（合并条件表达式）"><a href="#2-Consolidate-Conditional-Expression（合并条件表达式）" class="headerlink" title="2. Consolidate Conditional Expression（合并条件表达式）"></a>2. Consolidate Conditional Expression（合并条件表达式）</h2><p>有一系列条件测试，都得到相同结果。</p><p>将这些测试合并为一个条件表达式，并将这个条件表达式提炼成为一个独立函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">disabilityAmount</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (seniority &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (monthsDisabled &gt; <span class="number">12</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (isPartTime) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">disabilityAmount</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isNotEligibleForDisability()) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-Consolidate-Duplicate-Conditional-Fragments-（合并重复的条件片段）"><a href="#3-Consolidate-Duplicate-Conditional-Fragments-（合并重复的条件片段）" class="headerlink" title="3. Consolidate Duplicate Conditional Fragments （合并重复的条件片段）"></a>3. Consolidate Duplicate Conditional Fragments （合并重复的条件片段）</h2><p>在条件表达式的每个分支上有着相同的一段代码。</p><p>将这段重复代码搬移到条件表达式之外。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isSpecialDeal())&#123;</span><br><span class="line">    total = price * <span class="number">0.95</span>;</span><br><span class="line">    send();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    total = price * <span class="number">0.98</span>;</span><br><span class="line">    send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isSpecialDeal()) &#123;</span><br><span class="line">    total = price * <span class="number">0.95</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    total = price * <span class="number">0.98</span>;</span><br><span class="line">&#125;</span><br><span class="line">send();</span><br></pre></td></tr></table></figure><h2 id="4-Remove-Control-Flag（移除控制标记）"><a href="#4-Remove-Control-Flag（移除控制标记）" class="headerlink" title="4. Remove Control Flag（移除控制标记）"></a>4. Remove Control Flag（移除控制标记）</h2><p>在一系列布尔表达式中，某个变量带有“控制标记”的作用。</p><p>用 break语 句或 return 语句来取代控制标记。</p><h2 id="5-Replace-Nested-Conditional-with-Guard-Clauses-（以卫语句取代嵌套条件表达式）"><a href="#5-Replace-Nested-Conditional-with-Guard-Clauses-（以卫语句取代嵌套条件表达式）" class="headerlink" title="5. Replace Nested Conditional with Guard Clauses （以卫语句取代嵌套条件表达式）"></a>5. Replace Nested Conditional with Guard Clauses （以卫语句取代嵌套条件表达式）</h2><p>如果某个条件极其罕见，就应该单独检查该条件，并在该条件为真时立刻从函数中返回，这样的单独检查常常被称为“卫语句”（guard clauses）。</p><p>条件表达式通常有两种表现形式。第一种形式是：所有分支都属于正常行为。第二种形式则是：条件表达式提供的答案中只有一种是正常行为，其他都是不常见的情况，可以使用卫语句表现所有特殊情况。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">getPayAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> result;</span><br><span class="line">    <span class="keyword">if</span> (isDead) result = deadAmount();</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isSeparated) result = separatedAmount();</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRetired) result = retiredAmount();</span><br><span class="line">            <span class="keyword">else</span> result = normalPayAmount();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">getPayAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isDead) <span class="keyword">return</span> deadAmount();</span><br><span class="line">    <span class="keyword">if</span> (isSeparated) <span class="keyword">return</span> separatedAmount();</span><br><span class="line">    <span class="keyword">if</span> (isRetired) <span class="keyword">return</span> retiredAmount();</span><br><span class="line">    <span class="keyword">return</span> normalPayAmount();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="6-Replace-Conditional-with-Polymorphism-（以多态取代条件表达式）"><a href="#6-Replace-Conditional-with-Polymorphism-（以多态取代条件表达式）" class="headerlink" title="6. Replace Conditional with Polymorphism （以多态取代条件表达式）"></a>6. Replace Conditional with Polymorphism （以多态取代条件表达式）</h2><p>将这个条件表达式的每个分支放进一个子类内的覆写函数中，然后将原始函数声明为抽象函数。需要先使用 Replace Type Code with Subclass 或 Replace Type Code with State/Strategy 来建立继承结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">getSpeed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> EUROPEAN:</span><br><span class="line">            <span class="keyword">return</span> getBaseSpeed();</span><br><span class="line">        <span class="keyword">case</span> AFRICAN:</span><br><span class="line">            <span class="keyword">return</span> getBaseSpeed()- getLoadFactor()* numberOfCoconuts;</span><br><span class="line">        <span class="keyword">case</span> NORWEGIAN_BLUE:</span><br><span class="line">            <span class="keyword">return</span> isNailed ? <span class="number">0</span> : getBaseSpeed(voltage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Should be unreachable"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br><div align="center"> <img src="/pics/1c8432c8-2552-457f-b117-1da36c697221.jpg"> </div><br></p><h2 id="7-Introduce-Null-Object（引入Null对象）"><a href="#7-Introduce-Null-Object（引入Null对象）" class="headerlink" title="7. Introduce Null Object（引入Null对象）"></a>7. Introduce Null Object（引入Null对象）</h2><p>将 null 值替换为 null 对象。这样做的好处在于，不需要询问对象是否为空，直接调用就行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (customer == <span class="keyword">null</span>) plan = BillingPlan.basic();</span><br><span class="line"><span class="keyword">else</span> plan = customer.getPlan();</span><br></pre></td></tr></table></figure><h2 id="8-Introduce-Assertion（引入断言）"><a href="#8-Introduce-Assertion（引入断言）" class="headerlink" title="8. Introduce Assertion（引入断言）"></a>8. Introduce Assertion（引入断言）</h2><p>以断言明确表现某种假设。断言只能用于开发过程中，产品代码中不会有断言。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">getExpenseLimit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// should have either expense limit or a primary project</span></span><br><span class="line">    <span class="keyword">return</span> (expenseLimit != NULL_EXPENSE) ? expenseLimit :  primaryProject.getMemberExpenseLimit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">getExpenseLimit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Assert.isTrue (expenseLimit != NULL_EXPENSE || primaryProject != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> (expenseLimit != NULL_EXPENSE) ? expenseLimit :  primaryProject.getMemberExpenseLimit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="简化函数调用"><a href="#简化函数调用" class="headerlink" title="简化函数调用"></a>简化函数调用</h1><h2 id="1-Rename-Method（函数改名）"><a href="#1-Rename-Method（函数改名）" class="headerlink" title="1. Rename Method（函数改名）"></a>1. Rename Method（函数改名）</h2><p>使函数名能解释函数的用途。</p><h2 id="2-Add-Parameter（添加参数）"><a href="#2-Add-Parameter（添加参数）" class="headerlink" title="2. Add Parameter（添加参数）"></a>2. Add Parameter（添加参数）</h2><p>使函数不需要通过调用获得某个信息。</p><h2 id="3-Remove-Parameter（移除参数）"><a href="#3-Remove-Parameter（移除参数）" class="headerlink" title="3. Remove Parameter（移除参数）"></a>3. Remove Parameter（移除参数）</h2><p>与 Add Parameter 相反，改用调用的方式来获得某个信息。</p><h2 id="4-Separate-Query-from-Modifier（将查询函数和修改函数分离）"><a href="#4-Separate-Query-from-Modifier（将查询函数和修改函数分离）" class="headerlink" title="4. Separate Query from Modifier（将查询函数和修改函数分离）"></a>4. Separate Query from Modifier（将查询函数和修改函数分离）</h2><p>某个函数即返回对象状态值，又修改对象状态。</p><p>应当建立两个不同的函数，其中一个负责查询，另一个负责修改。任何有返回值的函数，都不应该有看得到的副作用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getTotalOutstandingAndSetReadyForSummaries();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getTotalOutstanding();</span><br><span class="line">setReadyForSummaries();</span><br></pre></td></tr></table></figure><h2 id="5-Parameterize-Method（令函数携带参数）"><a href="#5-Parameterize-Method（令函数携带参数）" class="headerlink" title="5. Parameterize Method（令函数携带参数）"></a>5. Parameterize Method（令函数携带参数）</h2><p>若干函数做了类似的工作，但在函数本体中却包含了不同的值。</p><p>建立单一函数，以参数表达那些不同的值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fivePercentRaise();</span><br><span class="line">tenPercentRaise();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raise(percentage);</span><br></pre></td></tr></table></figure><h2 id="6-Replace-Parameter-with-Explicit-Methods（以明确函数取代参数）"><a href="#6-Replace-Parameter-with-Explicit-Methods（以明确函数取代参数）" class="headerlink" title="6. Replace Parameter with Explicit Methods（以明确函数取代参数）"></a>6. Replace Parameter with Explicit Methods（以明确函数取代参数）</h2><p>有一个函数，完全取决于参数值而采取不同行为。</p><p>针对该参数的每一个可能值，建立一个独立函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String name, <span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name.equals(<span class="string">"height"</span>))&#123;</span><br><span class="line">        height = value;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (name.equals(<span class="string">"width"</span>))&#123;</span><br><span class="line">        width = value;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Assert.shouldNeverReachHere();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setHeight</span><span class="params">(<span class="keyword">int</span> arg)</span></span>&#123;</span><br><span class="line">    height = arg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setWidth</span><span class="params">(<span class="keyword">int</span> arg)</span></span>&#123;</span><br><span class="line">    width = arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7-Preserve-Whole-Object（保持对象完整）"><a href="#7-Preserve-Whole-Object（保持对象完整）" class="headerlink" title="7. Preserve Whole Object（保持对象完整）"></a>7. Preserve Whole Object（保持对象完整）</h2><p>从某个对象中取出若干值，将它们作为某一次函数调用时的参数。</p><p>改为传递整个对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> low = daysTempRange().getLow();</span><br><span class="line"><span class="keyword">int</span> high = daysTempRange().getHigh();</span><br><span class="line">withinPlan = plan.withinRange(low,high);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">withinPlan = plan.withinRange(daysTempRange());</span><br></pre></td></tr></table></figure><h2 id="8-Replace-Parameter-with-Methods（以函数取代参数）"><a href="#8-Replace-Parameter-with-Methods（以函数取代参数）" class="headerlink" title="8. Replace Parameter with Methods（以函数取代参数）"></a>8. Replace Parameter with Methods（以函数取代参数）</h2><p>对象调用某个函数，并将所得结果作为参数，传递给另一个函数。而接受该参数的函数本身也能够调用前一个函数。</p><p>让参数接收者去除该项参数，而是直接调用前一个函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> basePrice = _quantity * _itemPrice;</span><br><span class="line">discountLevel = getDiscountLevel();</span><br><span class="line"><span class="keyword">double</span> finalPrice = discountedPrice (basePrice, discountLevel);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> basePrice = _quantity * _itemPrice;</span><br><span class="line"><span class="keyword">double</span> finalPrice = discountedPrice (basePrice);</span><br></pre></td></tr></table></figure><h2 id="9-Introduce-Parameter-Object（引入参数对象）"><a href="#9-Introduce-Parameter-Object（引入参数对象）" class="headerlink" title="9. Introduce Parameter Object（引入参数对象）"></a>9. Introduce Parameter Object（引入参数对象）</h2><p>某些参数总是很自然地同时出现，这些参数就是 Data Clumps。</p><p>以一个对象取代这些参数。</p><p><br><div align="center"> <img src="/pics/08738dd0-ae8e-404a-ba78-a6b1b7d225b3.jpg"> </div><br></p><h2 id="10-Remove-Setting-Method（移除设值函数）"><a href="#10-Remove-Setting-Method（移除设值函数）" class="headerlink" title="10. Remove Setting Method（移除设值函数）"></a>10. Remove Setting Method（移除设值函数）</h2><p>类中的某个字段应该在对象创建时被设值，然后就不再改变。</p><p>去掉该字段的所有设值函数，并将该字段设为 final。</p><h2 id="11-Hide-Method（隐藏函数）"><a href="#11-Hide-Method（隐藏函数）" class="headerlink" title="11. Hide Method（隐藏函数）"></a>11. Hide Method（隐藏函数）</h2><p>有一个函数，从来没有被其他任何类用到。</p><p>将这个函数修改为 private。</p><h2 id="12-Replace-Constructor-with-Factory-Method-（以工厂函数取代构造函数）"><a href="#12-Replace-Constructor-with-Factory-Method-（以工厂函数取代构造函数）" class="headerlink" title="12. Replace Constructor with Factory Method （以工厂函数取代构造函数）"></a>12. Replace Constructor with Factory Method （以工厂函数取代构造函数）</h2><p>希望在创建对象时不仅仅是做简单的建构动作。</p><p>将构造函数替换为工厂函数。</p><h2 id="13-Encapsulate-Downcast（封装向下转型）"><a href="#13-Encapsulate-Downcast（封装向下转型）" class="headerlink" title="13. Encapsulate Downcast（封装向下转型）"></a>13. Encapsulate Downcast（封装向下转型）</h2><p>某个函数返回的对象，需要由函数调用者执行向下转型（downcast）。</p><p>将向下转型动作移到函数中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">lastReading</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> readings.lastElement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reading <span class="title">lastReading</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Reading)readings.lastElement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="14-Replace-Error-Code-with-Exception-（以异常取代错误码）"><a href="#14-Replace-Error-Code-with-Exception-（以异常取代错误码）" class="headerlink" title="14. Replace Error Code with Exception （以异常取代错误码）"></a>14. Replace Error Code with Exception （以异常取代错误码）</h2><p>某个函数返回一个特定的代码，用以表示某种错误情况。</p><p>改用异常，异常将普通程序和错误处理分开，使代码更容易理解。</p><h2 id="15-Replace-Exception-with-Test（以测试取代异常）"><a href="#15-Replace-Exception-with-Test（以测试取代异常）" class="headerlink" title="15. Replace Exception with Test（以测试取代异常）"></a>15. Replace Exception with Test（以测试取代异常）</h2><p>面对一个调用者可以预先检查的条件，你抛出了一个异常。</p><p>修改调用者，使它在调用函数之前先做检查。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">getValueForPeriod</span><span class="params">(<span class="keyword">int</span> periodNumber)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> values[periodNumber];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">getValueForPeriod</span><span class="params">(<span class="keyword">int</span> periodNumber)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (periodNumber &gt;= values.length) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> values[periodNumber];</span><br></pre></td></tr></table></figure><h1 id="处理概括关系"><a href="#处理概括关系" class="headerlink" title="处理概括关系"></a>处理概括关系</h1><h2 id="1-Pull-Up-Field（字段上移）"><a href="#1-Pull-Up-Field（字段上移）" class="headerlink" title="1. Pull Up Field（字段上移）"></a>1. Pull Up Field（字段上移）</h2><p>两个子类拥有相同的字段。</p><p>将该字段移至超类。</p><h2 id="2-Pull-Up-Method（函数上移）"><a href="#2-Pull-Up-Method（函数上移）" class="headerlink" title="2. Pull Up Method（函数上移）"></a>2. Pull Up Method（函数上移）</h2><p>有些函数，在各个子类中产生完全相同的结果。</p><p>将该函数移至超类。</p><h2 id="3-Pull-Up-Constructor-Body（构造函数本体上移）"><a href="#3-Pull-Up-Constructor-Body（构造函数本体上移）" class="headerlink" title="3. Pull Up Constructor Body（构造函数本体上移）"></a>3. Pull Up Constructor Body（构造函数本体上移）</h2><p>你在各个子类中拥有一些构造函数，它们的本体几乎完全一致。</p><p>在超类中新建一个构造函数，并在子类构造函数中调用它。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span> <span class="keyword">extends</span> <span class="title">Employee</span>...</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">Manager</span>(<span class="title">String</span> <span class="title">name</span>, <span class="title">String</span> <span class="title">id</span>, <span class="title">int</span> <span class="title">grade</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">    <span class="keyword">this</span>.grade = grade;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Manager</span><span class="params">(String name, String id, <span class="keyword">int</span> grade)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(name, id);</span><br><span class="line">    <span class="keyword">this</span>.grade = grade;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-Push-Down-Method（函数下移）"><a href="#4-Push-Down-Method（函数下移）" class="headerlink" title="4. Push Down Method（函数下移）"></a>4. Push Down Method（函数下移）</h2><p>超类中的某个函数只与部分子类有关。</p><p>将这个函数移到相关的那些子类去。</p><h2 id="5-Push-Down-Field（字段下移）"><a href="#5-Push-Down-Field（字段下移）" class="headerlink" title="5. Push Down Field（字段下移）"></a>5. Push Down Field（字段下移）</h2><p>超类中的某个字段只被部分子类用到。</p><p>将这个字段移到需要它的那些子类去。</p><h2 id="6-Extract-Subclass（提炼子类）"><a href="#6-Extract-Subclass（提炼子类）" class="headerlink" title="6. Extract Subclass（提炼子类）"></a>6. Extract Subclass（提炼子类）</h2><p>类中的某些特性只被某些实例用到。</p><p>新建一个子类，将上面所说的那一部分特性移到子类中。</p><h2 id="7-Extract-Superclass（提炼超类）"><a href="#7-Extract-Superclass（提炼超类）" class="headerlink" title="7. Extract Superclass（提炼超类）"></a>7. Extract Superclass（提炼超类）</h2><p>两个类有相似特性。</p><p>为这两个类建立一个超类，将相同特性移至超类。</p><h2 id="8-Extract-Interface（提炼接口）"><a href="#8-Extract-Interface（提炼接口）" class="headerlink" title="8. Extract Interface（提炼接口）"></a>8. Extract Interface（提炼接口）</h2><p>若干客户使用类接口中的同一子集，或者两个类的接口有部分相同。</p><p>将相同的子集提炼到一个独立接口中。</p><h2 id="9-Collapse-Hierarchy（折叠继承体系）"><a href="#9-Collapse-Hierarchy（折叠继承体系）" class="headerlink" title="9. Collapse Hierarchy（折叠继承体系）"></a>9. Collapse Hierarchy（折叠继承体系）</h2><p>超类和子类之间无太大区别。</p><p>将它们合为一体。</p><h2 id="10-Form-Template-Method（塑造模板函数）"><a href="#10-Form-Template-Method（塑造模板函数）" class="headerlink" title="10. Form Template Method（塑造模板函数）"></a>10. Form Template Method（塑造模板函数）</h2><p>你有一些子类，其中相应的某些函数以相同顺序执行类似的操作，但各个操作的细节上有所不同。</p><p>将这些操作分别放进独立函数中，并保持它们都有相同的签名，于是原函数也就变得相同了。然后将原函数上移至超类。(模板方法模式)</p><h2 id="11-Replace-Inheritance-with-Delegation-（以委托取代继承）"><a href="#11-Replace-Inheritance-with-Delegation-（以委托取代继承）" class="headerlink" title="11. Replace Inheritance with Delegation （以委托取代继承）"></a>11. Replace Inheritance with Delegation （以委托取代继承）</h2><p>某个子类只使用超类接口中的一部分，或是根本不需要继承而来的数据。</p><p>在子类中新建一个字段用以保存超类，调整子类函数，令它改而委托超类，然后去掉两者之间的继承关系。</p><h2 id="12-Replace-Delegation-with-Inheritance-（以继承取代委托）"><a href="#12-Replace-Delegation-with-Inheritance-（以继承取代委托）" class="headerlink" title="12. Replace Delegation with Inheritance （以继承取代委托）"></a>12. Replace Delegation with Inheritance （以继承取代委托）</h2><p>你在两个类之间使用委托关系，并经常为整个接口编写许多极简单的委托函数。</p><p>让委托类继承受托类。</p><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#第一个案例&quot;&gt;第一个案例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#重构原则&quot;&gt;重构原则&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#定义&quot;&gt;定义&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#为何重构&quot;&gt;为何重构&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#三次法则&quot;&gt;三次法则&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#间接层与重构&quot;&gt;间接层与重构&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#修改接口&quot;&gt;修改接口&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#何时不该重构&quot;&gt;何时不该重构&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#重构与设计&quot;&gt;重构与设计&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#重构与性能&quot;&gt;重构与性能&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#代码的坏味道&quot;&gt;代码的坏味道&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-duplicated-code重复代码&quot;&gt;1. Duplicated Code（重复代码）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-long-method过长函数&quot;&gt;2. Long Method（过长函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-large-class过大的类&quot;&gt;3. Large Class（过大的类）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-long-parameter-list过长的参数列表&quot;&gt;4. Long Parameter List（过长的参数列表）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-divergent-change发散式变化&quot;&gt;5. Divergent Change（发散式变化）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-shotgun-surgery散弹式修改&quot;&gt;6. Shotgun Surgery（散弹式修改）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-feature-envy依恋情结&quot;&gt;7. Feature Envy（依恋情结）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-data-clumps数据泥团&quot;&gt;8. Data Clumps（数据泥团）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-primitive-obsession基本类型偏执&quot;&gt;9. Primitive Obsession（基本类型偏执）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#10-switch-statementsswitch-惊悚现身&quot;&gt;10. Switch Statements（switch 惊悚现身）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-parallel-inheritance-hierarchies平行继承体系&quot;&gt;11. Parallel Inheritance Hierarchies（平行继承体系）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-lazy-class冗余类&quot;&gt;12. Lazy Class（冗余类）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-speculative-generality夸夸其谈未来性&quot;&gt;13. Speculative Generality（夸夸其谈未来性）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-temporary-field令人迷惑的暂时字段&quot;&gt;14. Temporary Field（令人迷惑的暂时字段）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15-message-chains过度耦合的消息链&quot;&gt;15. Message Chains（过度耦合的消息链）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#16-middle-man中间人&quot;&gt;16. Middle Man（中间人）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#17-inappropriate-intimacy狎昵关系&quot;&gt;17. Inappropriate Intimacy（狎昵关系）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#18-alernative-classes-with-different-interfaces异曲同工的类&quot;&gt;18. Alernative Classes with Different Interfaces（异曲同工的类）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#19-incomplete-library-class不完美的类库&quot;&gt;19. Incomplete Library Class（不完美的类库）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#20-data-class幼稚的数据类&quot;&gt;20. Data Class（幼稚的数据类）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#21-refused-bequest被拒绝的馈赠&quot;&gt;21. Refused Bequest（被拒绝的馈赠）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-comments过多的注释&quot;&gt;22. Comments（过多的注释）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#构筑测试体系&quot;&gt;构筑测试体系&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#重新组织函数&quot;&gt;重新组织函数&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-extract-method提炼函数&quot;&gt;1. Extract Method（提炼函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-inline-method内联函数&quot;&gt;2. Inline Method（内联函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-inline-temp内联临时变量&quot;&gt;3. Inline Temp（内联临时变量）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-replace-temp-with-query以查询取代临时变量&quot;&gt;4. Replace Temp with Query（以查询取代临时变量）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-introduce-explaining-variable引起解释变量&quot;&gt;5. Introduce Explaining Variable（引起解释变量）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-split-temporary-variable分解临时变量&quot;&gt;6. Split Temporary Variable（分解临时变量）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-remove-assigments-to-parameters移除对参数的赋值&quot;&gt;7. Remove Assigments to Parameters（移除对参数的赋值）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-replace-method-with-method-object以函数对象取代函数&quot;&gt;8. Replace Method with Method Object（以函数对象取代函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-subsititute-algorithn替换算法&quot;&gt;9. Subsititute Algorithn（替换算法）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#在对象之间搬移特性&quot;&gt;在对象之间搬移特性&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-move-method搬移函数&quot;&gt;1. Move Method（搬移函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-move-field搬移字段&quot;&gt;2. Move Field（搬移字段）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-extract-class提炼类&quot;&gt;3. Extract Class（提炼类）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-inline-class将类内联化&quot;&gt;4. Inline Class（将类内联化）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-hide-delegate隐藏“委托关系”&quot;&gt;5. Hide Delegate（隐藏“委托关系”）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-remove-middle-man移除中间人&quot;&gt;6. Remove Middle Man（移除中间人）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-introduce-foreign-method引入外加函数&quot;&gt;7. Introduce Foreign Method（引入外加函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-introduce-local-extension引入本地扩展&quot;&gt;8. Introduce Local Extension（引入本地扩展）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#重新组织数据&quot;&gt;重新组织数据&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-self-encapsulate-field自封装字段&quot;&gt;1. Self Encapsulate Field（自封装字段）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-replace-data-value-with-object以对象取代数据值&quot;&gt;2. Replace Data Value with Object（以对象取代数据值）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-change-value-to-reference将值对象改成引用对象&quot;&gt;3. Change Value to Reference（将值对象改成引用对象）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-change-reference-to-value将引用对象改为值对象&quot;&gt;4. Change Reference to value（将引用对象改为值对象）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-replace-array-with-object以对象取代数组&quot;&gt;5. Replace Array with Object（以对象取代数组）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-duplicate-observed-data赋值“被监视数据”&quot;&gt;6. Duplicate Observed Data（赋值“被监视数据”）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-change-unidirectional-association-to-bidirectional将单向关联改为双向关联&quot;&gt;7. Change Unidirectional Association to Bidirectional（将单向关联改为双向关联）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-change-bidirectional-association-to-unidirectional将双向关联改为单向关联&quot;&gt;8. Change Bidirectional Association to Unidirectional（将双向关联改为单向关联）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-replace-magic-number-with-symbolic-constant以字面常量取代魔法数&quot;&gt;9. Replace Magic Number with Symbolic Constant（以字面常量取代魔法数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#10-encapsulate-field封装字段&quot;&gt;10. Encapsulate Field（封装字段）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-encapsulate-collection封装集合&quot;&gt;11. Encapsulate Collection（封装集合）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-replace-record-with-data-class以数据类取代记录&quot;&gt;12. Replace Record with Data Class（以数据类取代记录）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-replace-type-code-with-class以类取代类型码&quot;&gt;13. Replace Type Code with Class（以类取代类型码）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-replace-type-code-with-subcalsses以子类取代类型码&quot;&gt;14. Replace Type Code with Subcalsses（以子类取代类型码）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15-replace-type-code-with-statestrategy-以-statestrategy-取代类型码&quot;&gt;15. Replace Type Code with State/Strategy （以 State/Strategy 取代类型码）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#16-replace-subclass-with-fields以字段取代子类&quot;&gt;16. Replace Subclass with Fields（以字段取代子类）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#简化条件表达式&quot;&gt;简化条件表达式&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-decompose-conditional分解条件表达式&quot;&gt;1. Decompose Conditional（分解条件表达式）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-consolidate-conditional-expression合并条件表达式&quot;&gt;2. Consolidate Conditional Expression（合并条件表达式）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-consolidate-duplicate-conditional-fragments-合并重复的条件片段&quot;&gt;3. Consolidate Duplicate Conditional Fragments （合并重复的条件片段）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-remove-control-flag移除控制标记&quot;&gt;4. Remove Control Flag（移除控制标记）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-replace-nested-conditional-with-guard-clauses-以卫语句取代嵌套条件表达式&quot;&gt;5. Replace Nested Conditional with Guard Clauses （以卫语句取代嵌套条件表达式）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-replace-conditional-with-polymorphism-以多态取代条件表达式&quot;&gt;6. Replace Conditional with Polymorphism （以多态取代条件表达式）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-introduce-null-object引入null对象&quot;&gt;7. Introduce Null Object（引入Null对象）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-introduce-assertion引入断言&quot;&gt;8. Introduce Assertion（引入断言）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#简化函数调用&quot;&gt;简化函数调用&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-rename-method函数改名&quot;&gt;1. Rename Method（函数改名）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-add-parameter添加参数&quot;&gt;2. Add Parameter（添加参数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-remove-parameter移除参数&quot;&gt;3. Remove Parameter（移除参数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-separate-query-from-modifier将查询函数和修改函数分离&quot;&gt;4. Separate Query from Modifier（将查询函数和修改函数分离）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-parameterize-method令函数携带参数&quot;&gt;5. Parameterize Method（令函数携带参数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-replace-parameter-with-explicit-methods以明确函数取代参数&quot;&gt;6. Replace Parameter with Explicit Methods（以明确函数取代参数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-preserve-whole-object保持对象完整&quot;&gt;7. Preserve Whole Object（保持对象完整）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-replace-parameter-with-methods以函数取代参数&quot;&gt;8. Replace Parameter with Methods（以函数取代参数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-introduce-parameter-object引入参数对象&quot;&gt;9. Introduce Parameter Object（引入参数对象）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#10-remove-setting-method移除设值函数&quot;&gt;10. Remove Setting Method（移除设值函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-hide-method隐藏函数&quot;&gt;11. Hide Method（隐藏函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-replace-constructor-with-factory-method-以工厂函数取代构造函数&quot;&gt;12. Replace Constructor with Factory Method （以工厂函数取代构造函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-encapsulate-downcast封装向下转型&quot;&gt;13. Encapsulate Downcast（封装向下转型）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-replace-error-code-with-exception-以异常取代错误码&quot;&gt;14. Replace Error Code with Exception （以异常取代错误码）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15-replace-exception-with-test以测试取代异常&quot;&gt;15. Replace Exception with Test（以测试取代异常）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#处理概括关系&quot;&gt;处理概括关系&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-pull-up-field字段上移&quot;&gt;1. Pull Up Field（字段上移）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-pull-up-method函数上移&quot;&gt;2. Pull Up Method（函数上移）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-pull-up-constructor-body构造函数本体上移&quot;&gt;3. Pull Up Constructor Body（构造函数本体上移）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-push-down-method函数下移&quot;&gt;4. Push Down Method（函数下移）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-push-down-field字段下移&quot;&gt;5. Push Down Field（字段下移）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-extract-subclass提炼子类&quot;&gt;6. Extract Subclass（提炼子类）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-extract-superclass提炼超类&quot;&gt;7. Extract Superclass（提炼超类）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-extract-interface提炼接口&quot;&gt;8. Extract Interface（提炼接口）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-collapse-hierarchy折叠继承体系&quot;&gt;9. Collapse Hierarchy（折叠继承体系）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#10-form-template-method塑造模板函数&quot;&gt;10. Form Template Method（塑造模板函数）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-replace-inheritance-with-delegation-以委托取代继承&quot;&gt;11. Replace Inheritance with Delegation （以委托取代继承）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-replace-delegation-with-inheritance-以继承取代委托&quot;&gt;12. Replace Delegation with Inheritance （以继承取代委托）&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;第一个案例&quot;&gt;&lt;a href=&quot;#第一个案例&quot; class=&quot;headerlink&quot; title=&quot;第一个案例&quot;&gt;&lt;/a&gt;第一个案例&lt;/h1&gt;&lt;p&gt;如果你发现自己需要为程序添加一个特性，而代码结构使你无法很方便地达成目的，那就先重构这个程序。&lt;/p&gt;
&lt;p&gt;在重构前，需要先构建好可靠的测试环境，确保安全地重构。&lt;/p&gt;
&lt;p&gt;重构需要以微小的步伐修改程序，如果重构过程发生错误，很容易就能发现错误。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;案例分析&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;影片出租店应用程序，需要计算每位顾客的消费金额。&lt;/p&gt;
&lt;p&gt;包括三个类：Movie、Rental 和 Customer，Rental 包含租赁的 Movie 以及天数。&lt;/p&gt;
    
    </summary>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>设计模式</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/设计模式.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:35:10.018Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#前言">前言</a></li><li><a href="#第一章-设计模式入门">第一章 设计模式入门</a></li><li><a href="#第二章-观察者模式">第二章 观察者模式</a></li><li><a href="#第三章-装饰模式">第三章 装饰模式</a></li><li><a href="#第四章-工厂模式">第四章 工厂模式</a><ul><li><a href="#1-简单工厂">1. 简单工厂</a></li><li><a href="#2--工厂方法模式">2.  工厂方法模式</a></li><li><a href="#3--抽象工厂模式">3.  抽象工厂模式</a></li></ul></li><li><a href="#第五章-单件模式">第五章 单件模式</a></li><li><a href="#第六章-命令模式">第六章 命令模式</a></li><li><a href="#第七章-适配器模式与外观模式">第七章 适配器模式与外观模式</a><ul><li><a href="#1-适配器模式">1. 适配器模式</a></li><li><a href="#2-外观模式">2. 外观模式</a></li></ul></li><li><a href="#第八章-模板方法模式">第八章 模板方法模式</a></li><li><a href="#第九章-迭代器和组合模式">第九章 迭代器和组合模式</a><ul><li><a href="#1-迭代器模式">1. 迭代器模式</a></li><li><a href="#2-java-内置的迭代器">2. Java 内置的迭代器</a></li><li><a href="#3-组合模式">3. 组合模式</a></li></ul></li><li><a href="#第十章-状态模式">第十章 状态模式</a></li><li><a href="#第十一章-代理模式">第十一章 代理模式</a></li><li><a href="#第十二章-复合模式">第十二章 复合模式</a><ul><li><a href="#mvc">MVC</a></li></ul></li><li><a href="#第十三章-与设计模式相处">第十三章 与设计模式相处</a></li><li><a href="#第十四章-剩下的模式">第十四章 剩下的模式</a><!-- GFM-TOC --></li></ul><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>文中涉及一些 UML 类图，为了更好地理解，可以先阅读 <a href="https://github.com/CyC2018/Interview-Notebook/blob/master/notes/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%80%9D%E6%83%B3.md#1-%E7%B1%BB%E5%9B%BE" target="_blank" rel="noopener">UML 类图</a>。</p><p>需要说明的一点是，文中的 UML 类图和规范的 UML 类图不大相同，其中组合关系使用以下箭头表示：</p><p><br><div align="center"> <img src="../pics/09e398d8-9c6e-48f6-b48b-8b4f9de61d1d.png"> </div><br></p><h1 id="第一章-设计模式入门"><a href="#第一章-设计模式入门" class="headerlink" title="第一章 设计模式入门"></a>第一章 设计模式入门</h1><p><strong>1. 设计模式概念</strong> </p><p>设计模式不是代码，而是解决问题的方案，学习现有的设计模式可以做到经验复用。</p><p>拥有设计模式词汇，在沟通时就能用更少的词汇来讨论，并且不需要了解底层细节。</p><p><strong>2. 问题描述</strong> </p><p>设计不同种类的鸭子拥有不同的叫声和飞行方式。</p><a id="more"></a><p><strong>3. 简单实现方案</strong> </p><p>使用继承的解决方案如下，这种方案代码无法复用，如果两个鸭子类拥有同样的飞行方式，就有两份重复的代码。</p><p><br><div align="center"> <img src="../pics/144d28a0-1dc5-4aba-8961-ced5bc88428a.jpg"> </div><br></p><p><strong>4. 设计原则</strong> </p><p><strong>封装变化</strong> 在这里变化的是鸭子叫和飞行的行为方式。</p><p><strong>针对接口编程，而不是针对实现编程</strong>  变量声明的类型为父类，而不是具体的某个子类。父类中的方法实现不在父类，而是在各个子类。程序在运行时可以动态改变变量所指向的子类类型。</p><p>运用这一原则，将叫和飞行的行为抽象出来，实现多种不同的叫和飞行的子类，让子类去实现具体的叫和飞行方式。</p><p><br><div align="center"> <img src="../pics/1c8ccf5c-7ecd-4b8a-b160-3f72a510ce26.png"> </div><br></p><p><strong>多用组合，少用继承</strong>  组合也就是 has-a 关系，通过组合，可以在运行时动态改变实现，只要通过改变父类对象具体指向哪个子类即可。而继承就不能做到这些，继承体系在创建类时就已经确定。</p><p>运用这一原则，在 Duck 类中组合 FlyBehavior 和 QuackBehavior 类，performQuack() 和 performFly() 方法委托给这两个类去处理。通过这种方式，一个 Duck 子类可以根据需要去实例化 FlyBehavior 和 QuackBehavior 的子类对象，并且也可以动态地进行改变。</p><p><br><div align="center"> <img src="../pics/29574e6f-295c-444e-83c7-b162e8a73a83.jpg"> </div><br></p><p><strong>5. 整体设计图</strong> </p><p><br><div align="center"> <img src="../pics/e13833c8-e215-462e-855c-1d362bb8d4a0.jpg"> </div><br></p><p><strong>6. 模式定义</strong> </p><p><strong>策略模式</strong>  ：定义了算法族，分别封装起来，让它们之间可以互相替换，此模式让算法的变化独立于使用算法的客户。</p><p><strong>7. 实现代码</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    FlyBehavior flyBehavior;</span><br><span class="line">    QuackBehavior quackBehavior;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Duck</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performFly</span><span class="params">()</span></span>&#123;</span><br><span class="line">        flyBehavior.fly();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlyBehavior</span><span class="params">(FlyBehavior fb)</span></span>&#123;</span><br><span class="line">        flyBehavior = fb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performQuack</span><span class="params">()</span></span>&#123;</span><br><span class="line">        quackBehavior.quack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setQuackBehavior</span><span class="params">(QuackBehavior qb)</span></span>&#123;</span><br><span class="line">        quackBehavior = qb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallarDuck</span> <span class="keyword">extends</span> <span class="title">Duck</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MallarDuck</span><span class="params">()</span></span>&#123;</span><br><span class="line">        flyBehavior = <span class="keyword">new</span> FlyWithWings();</span><br><span class="line">        quackBehavior = <span class="keyword">new</span> Quack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FlyBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyNoWay</span> <span class="keyword">implements</span> <span class="title">FlyBehavior</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"FlyBehavior.FlyNoWay"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyWithWings</span> <span class="keyword">implements</span> <span class="title">FlyBehavior</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"FlyBehavior.FlyWithWings"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">QuackBehavior</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quack</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"QuackBehavior.Quack"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MuteQuack</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"QuackBehavior.MuteQuack"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Squeak</span> <span class="keyword">implements</span> <span class="title">QuackBehavior</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"QuackBehavior.Squeak"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MiniDuckSimulator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Duck mallarDuck = <span class="keyword">new</span> MallarDuck();</span><br><span class="line">        mallarDuck.performQuack();</span><br><span class="line">        mallarDuck.performFly();</span><br><span class="line">        mallarDuck.setFlyBehavior(<span class="keyword">new</span> FlyNoWay());</span><br><span class="line">        mallarDuck.performFly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行结果<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QuackBehavior.Quack</span><br><span class="line">FlyBehavior.FlyWithWings</span><br><span class="line">FlyBehavior.FlyNoWay</span><br></pre></td></tr></table></figure></p><h1 id="第二章-观察者模式"><a href="#第二章-观察者模式" class="headerlink" title="第二章 观察者模式"></a>第二章 观察者模式</h1><p><strong>1. 模式定义</strong> </p><p>定义了对象之间的一对多依赖，当一个对象改变状态时，它的所有依赖者都会受到通知并自动更新。主题（Subject）是被观察的对象，而其所有依赖者（Observer）成为观察者。</p><p><br><div align="center"> <img src="../pics/26cb5e7e-6fa3-44ad-854e-fe24d1a5278c.jpg"> </div><br></p><p><strong>2. 模式类图</strong> </p><p>主题中具有注册和移除观察者，并通知所有注册者的功能，主题是通过维护一张观察者列表来实现这些操作的。</p><p>观察者拥有一个主题对象的引用，因为注册、移除还有数据都在主题当中，必须通过操作主题才能完成相应功能。</p><p><br><div align="center"> <img src="../pics/5c558190-fccd-4b5e-98ed-1896653fc97f.jpg"> </div><br></p><p><strong>3. 问题描述</strong> </p><p>天气数据布告板会在天气信息发生改变时更新其内容，布告板有多个，并且在将来会继续增加。</p><p><strong>4. 解决方案类图</strong> </p><p><br><div align="center"> <img src="../pics/760a5d63-d96d-4dd9-bf9a-c3d126b2f401.jpg"> </div><br></p><p><strong>5. 设计原则</strong> </p><p><strong>为交互对象之间的松耦合设计而努力</strong>  当两个对象之间松耦合，它们依然可以交互，但是不太清楚彼此的细节。由于松耦合的两个对象之间互相依赖程度很低，因此系统具有弹性，能够应对变化。</p><p><strong>6. 实现代码</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resisterObserver</span><span class="params">(Observer o)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer o)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObserver</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherData</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; observers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> pressure;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeatherData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        observers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resisterObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">        observers.add(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = observers.indexOf(o);</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            observers.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Observer o : observers) &#123;</span><br><span class="line">            o.update(temperature, humidity, pressure);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMeasurements</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">        <span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">        <span class="keyword">this</span>.pressure = pressure;</span><br><span class="line">        notifyObserver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CurrentConditionsDisplay</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Subject weatherData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CurrentConditionsDisplay</span><span class="params">(Subject weatherData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.weatherData = weatherData;</span><br><span class="line">        weatherData.resisterObserver(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"CurrentConditionsDisplay.update:"</span> + temp + <span class="string">" "</span> + humidity + <span class="string">" "</span> + pressure);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatisticsDisplay</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Subject weatherData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StatisticsDisplay</span><span class="params">(Subject weatherData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.weatherData = weatherData;</span><br><span class="line">        weatherData.resisterObserver(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"StatisticsDisplay.update:"</span> + temp + <span class="string">" "</span> + humidity + <span class="string">" "</span> + pressure);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherStation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        WeatherData weatherData = <span class="keyword">new</span> WeatherData();</span><br><span class="line">        CurrentConditionsDisplay currentConditionsDisplay = <span class="keyword">new</span> CurrentConditionsDisplay(weatherData);</span><br><span class="line">        StatisticsDisplay statisticsDisplay = <span class="keyword">new</span> StatisticsDisplay(weatherData);</span><br><span class="line"></span><br><span class="line">        weatherData.setMeasurements(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        weatherData.setMeasurements(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行结果<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CurrentConditionsDisplay.update:0.0 0.0 0.0</span><br><span class="line">StatisticsDisplay.update:0.0 0.0 0.0</span><br><span class="line">CurrentConditionsDisplay.update:1.0 1.0 1.0</span><br><span class="line">StatisticsDisplay.update:1.0 1.0 1.0</span><br></pre></td></tr></table></figure></p><h1 id="第三章-装饰模式"><a href="#第三章-装饰模式" class="headerlink" title="第三章 装饰模式"></a>第三章 装饰模式</h1><p><strong>1. 问题描述</strong> </p><p>设计不同种类的饮料，并且每种饮料可以动态添加新的材料，比如可以添加牛奶。计算一种饮料的价格。</p><p><strong>2. 模式定义</strong> </p><p>动态地将责任附加到对象上。在扩展功能上，装饰者提供了比继承更有弹性的替代方案。</p><p>下图中 DarkRoast 对象被 Mocha 包裹，Mocha 对象又被 Whip 包裹，并且他们都继承自相同父类，都有 cost() 方法，但是外层对象的 cost() 方法实现调用了内层对象的 cost() 方法。因此，如果要在 DarkRoast 上添加 Mocha，那么只需要用 Mocha 包裹 DarkRoast，如果还需要 Whip ，就用 Whip 包裹 Mocha，最后调用 cost() 方法能把三种对象的价格都包含进去。</p><p><br><div align="center"> <img src="../pics/41a4cb30-f393-4b3b-abe4-9941ccf8fa1f.jpg"> </div><br></p><p><strong>3. 模式类图</strong> </p><p>装饰者和具体组件都继承自组件类型，其中具体组件的方法实现不需要依赖于其它对象，而装饰者拥有一个组件类型对象，这样它可以装饰其它装饰者或者具体组件。所谓装饰，就是把这个装饰者套在被装饰的对象之外，从而动态扩展被装饰者的功能。装饰者的方法有一部分是自己的，这属于它的功能，然后调用被装饰者的方法实现，从而也保留了被装饰者的功能。可以看到，具体组件应当是装饰层次的最低层，因为只有具体组件有直接实现而不需要委托给其它对象去处理。</p><p><br><div align="center"> <img src="../pics/3dc454fb-efd4-4eb8-afde-785b2182caeb.jpg"> </div><br></p><p><strong>4. 问题解决方案的类图</strong> </p><p><br><div align="center"> <img src="../pics/9c997ac5-c8a7-44fe-bf45-2c10eb773e53.jpg"> </div><br></p><p><strong>5. 设计原则</strong> </p><p><strong>类应该对扩展开放，对修改关闭。</strong>  也就是添加新功能时不需要修改代码。在本章问题中该原则体现在，在饮料中添加新的材料，而不需要去修改饮料的代码。观察则模式也符合这个原则。不可能所有类都能实现这个原则，应当把该原则应用于设计中最有可能改变的地方。</p><p><strong>6. Java I/O 中的装饰者模式</strong> </p><p><br><div align="center"> <img src="../pics/2a40042a-03c8-4556-ad1f-72d89f8c555c.jpg"> </div><br></p><p><strong>7. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Beverage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HouseBlend</span> <span class="keyword">implements</span> <span class="title">Beverage</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DarkRoast</span> <span class="keyword">implements</span> <span class="title">Beverage</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CondimentDecorator</span> <span class="keyword">implements</span> <span class="title">Beverage</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Beverage beverage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mocha</span> <span class="keyword">extends</span> <span class="title">CondimentDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mocha</span><span class="params">(Beverage beverage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + beverage.cost();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Milk</span> <span class="keyword">extends</span> <span class="title">CondimentDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Milk</span><span class="params">(Beverage beverage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">cost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + beverage.cost();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartbuzzCoffee</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Beverage beverage = <span class="keyword">new</span> HouseBlend();</span><br><span class="line">        beverage = <span class="keyword">new</span> Mocha(beverage);</span><br><span class="line">        beverage = <span class="keyword">new</span> Milk(beverage);</span><br><span class="line">        System.out.println(beverage.cost());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3.0</span><br></pre></td></tr></table></figure><h1 id="第四章-工厂模式"><a href="#第四章-工厂模式" class="headerlink" title="第四章 工厂模式"></a>第四章 工厂模式</h1><h2 id="1-简单工厂"><a href="#1-简单工厂" class="headerlink" title="1. 简单工厂"></a>1. 简单工厂</h2><p><strong>1. 问题描述</strong> </p><p>有不同的 Pizza，根据不同的情况用不同的子类实例化一个 Pizza 对象。</p><p><strong>2. 定义</strong> </p><p>简单工厂不是设计模式，更像是一种编程习惯。在实例化一个超类的对象时，可以用它的所有子类来进行实例化，要根据具体需求来决定使用哪个子类。在这种情况下，把实例化的操作放到工厂来中，让工厂类来决定应该用哪个子类来实例化。这样做把客户对象和具体子类的实现解耦，客户对象不再需要知道有哪些子类以及实例化哪个子类。因为客户类往往有多个，如果不使用简单工厂，那么所有的客户类都要知道所有子类的细节，一旦子类发生改变，例如增加子类，那么所有的客户类都要发生改变。</p><p><br><div align="center"> <img src="../pics/c470eb9b-fb05-45c5-8bb7-1057dc3c16de.jpg"> </div><br></p><p><strong>3. 解决方案类图</strong> </p><p><br><div align="center"> <img src="../pics/dc3e704c-7c57-42b8-93ea-ddd068665964.jpg"> </div><br></p><p><strong>4. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheesePizza</span> <span class="keyword">implements</span> <span class="title">Pizza</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"CheesePizza"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreekPizza</span> <span class="keyword">implements</span> <span class="title">Pizza</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"GreekPizza"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimplePizzaFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pizza <span class="title">createPizza</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"cheese"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CheesePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"greek"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GreekPizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SimplePizzaFactory simplePizzaFactory = <span class="keyword">new</span> SimplePizzaFactory();</span><br><span class="line">        Pizza pizza = simplePizzaFactory.createPizza(<span class="string">"cheese"</span>);</span><br><span class="line">        pizza.make();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CheesePizza</span><br></pre></td></tr></table></figure><h2 id="2-工厂方法模式"><a href="#2-工厂方法模式" class="headerlink" title="2.  工厂方法模式"></a>2.  工厂方法模式</h2><p><strong>1. 问题描述</strong> </p><p>每个地区的 Pizza 店虽然种类相同，但是都有自己的风味，需要单独区分。例如，一个客户点了纽约的 cheese 种类的 Pizza 和在芝加哥点的相同种类的 Pizza 是不同的。</p><p><strong>2. 模式定义</strong> </p><p>定义了一个创建对象的接口，但由子类决定要实例化的类是哪一个。工厂方法让类把实例化推迟到子类。</p><p><strong>3. 模式类图</strong> </p><p>在简单工厂中，创建对象的是另一个类，而在工厂方法中，是由子类来创建对象。下图中，Creator 有一个 anOperation() 方法，这个方法需要用到一组产品类，这组产品类由每个子类来创建。</p><p>可以为每个子类创建单独的简单工厂来创建每一个产品类，但是把简单工厂中创建对象的代码放到子类中来可以减少类的数目，因为子类不算是产品类，因此完全可以这么做。</p><p><br><div align="center"> <img src="../pics/903093ec-acc8-4f9b-bf2c-b990b9a5390c.jpg"> </div><br></p><p><strong>4. 解决方案类图</strong> </p><p><br><div align="center"> <img src="../pics/664f8901-5dc7-4644-a072-dad88cc5133a.jpg"> </div><br></p><p><strong>5. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pizza <span class="title">orderPizza</span><span class="params">(String item)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NYStyleCheesePizza</span> <span class="keyword">implements</span> <span class="title">Pizza</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"NYStyleCheesePizza is making.."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NYStyleVeggiePizza</span> <span class="keyword">implements</span> <span class="title">Pizza</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"NYStyleVeggiePizza is making.."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChicagoStyleCheesePizza</span> <span class="keyword">implements</span> <span class="title">Pizza</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ChicagoStyleCheesePizza is making.."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChicagoStyleVeggiePizza</span> <span class="keyword">implements</span> <span class="title">Pizza</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">make</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ChicagoStyleVeggiePizza is making.."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NYPizzaStore</span> <span class="keyword">implements</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pizza <span class="title">orderPizza</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (item.equals(<span class="string">"cheese"</span>)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> NYStyleCheesePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.equals(<span class="string">"veggie"</span>)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> NYStyleVeggiePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line">        pizza.make();</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChicagoPizzaStore</span> <span class="keyword">implements</span> <span class="title">PizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pizza <span class="title">orderPizza</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">        Pizza pizza = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (item.equals(<span class="string">"cheese"</span>)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ChicagoStyleCheesePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.equals(<span class="string">"veggie"</span>)) &#123;</span><br><span class="line">            pizza = <span class="keyword">new</span> ChicagoStyleVeggiePizza();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line">        pizza.make();</span><br><span class="line">        <span class="keyword">return</span> pizza;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PizzaStore nyStore = <span class="keyword">new</span> NYPizzaStore();</span><br><span class="line">        nyStore.orderPizza(<span class="string">"cheese"</span>);</span><br><span class="line">        PizzaStore chicagoStore = <span class="keyword">new</span> ChicagoPizzaStore();</span><br><span class="line">        chicagoStore.orderPizza(<span class="string">"cheese"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NYStyleCheesePizza is making..</span><br><span class="line">ChicagoStyleCheesePizza is making..</span><br></pre></td></tr></table></figure><h2 id="3-抽象工厂模式"><a href="#3-抽象工厂模式" class="headerlink" title="3.  抽象工厂模式"></a>3.  抽象工厂模式</h2><p><strong>1. 设计原则</strong> </p><p><strong>依赖倒置原则</strong> ：要依赖抽象，不要依赖具体类。听起来像是针对接口编程，不针对实现编程，但是这个原则说明了：不能让高层组件依赖底层组件，而且，不管高层或底层组件，两者都应该依赖于抽象。例如，下图中 PizzaStore 属于高层组件，它依赖的是 Pizza 的抽象类，这样就可以不用关心 Pizza 的具体实现细节。</p><p><br><div align="center"> <img src="../pics/ddf72ca9-c0be-49d7-ab81-57a99a974c8e.jpg"> </div><br></p><p><strong>2. 模式定义</strong> </p><p>提供一个接口，用于创建相关或依赖对象的家族，而不需要明确指定具体类。</p><p><strong>3. 模式类图</strong> </p><p>抽象工厂模式创建的是对象家族，也就是很多对象而不是一个对象，并且这些对象是相关的，也就是说必须一起创建出来。而工厂模式只是用于创建一个对象，这和抽象工厂模式有很大不同。并且，抽象工厂模式也用到了工厂模式来创建单一对象，在类图左部，AbstractFactory 中的 CreateProductA 和 CreateProductB 方法都是让子类来实现，这两个方法单独来看就是在创建一个对象，这符合工厂模式的定义。至于创建对象的家族这一概念是在 Client 体现，Client 要通过 AbstractFactory 同时调用两个方法来创建出两个对象，在这里这两个对象就有很大的相关性，Client 需要这两个对象的协作才能完成任务。从高层次来看，抽象工厂使用了组合，即 Cilent 组合了 AbstractFactory ，而工厂模式使用了继承。</p><p><br><div align="center"> <img src="../pics/d301774f-e0d2-41f3-95f4-bfe39859b52e.jpg"> </div><br></p><p><strong>4. 解决方案类图</strong> </p><p><br><div align="center"> <img src="../pics/8785dabd-1285-4bd0-b3aa-b05cc060a24a.jpg"> </div><br></p><p><strong>5. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Dough</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doughType</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThickCrustDough</span> <span class="keyword">implements</span> <span class="title">Dough</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doughType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ThickCrustDough"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThinCrustDough</span> <span class="keyword">implements</span> <span class="title">Dough</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doughType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ThinCrustDough"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sauce</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sauceType</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MarinaraSauce</span> <span class="keyword">implements</span> <span class="title">Sauce</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sauceType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"MarinaraSauce"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlumTomatoSauce</span> <span class="keyword">implements</span> <span class="title">Sauce</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sauceType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PlumTomatoSauce"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PizzaIngredientFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dough <span class="title">createDough</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sauce <span class="title">createSauce</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NYPizzaIngredientFactory</span> <span class="keyword">implements</span> <span class="title">PizzaIngredientFactory</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dough <span class="title">createDough</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThickCrustDough();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sauce <span class="title">createSauce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MarinaraSauce();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChicagoPizzaIngredientFactory</span> <span class="keyword">implements</span> <span class="title">PizzaIngredientFactory</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dough <span class="title">createDough</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThinCrustDough();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Sauce <span class="title">createSauce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PlumTomatoSauce();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NYPizzaStore</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PizzaIngredientFactory ingredientFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NYPizzaStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ingredientFactory = <span class="keyword">new</span> NYPizzaIngredientFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePizza</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Dough dough = ingredientFactory.createDough();</span><br><span class="line">        Sauce sauce = ingredientFactory.createSauce();</span><br><span class="line">        System.out.println(dough.doughType());</span><br><span class="line">        System.out.println(sauce.sauceType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NYPizzaStoreTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NYPizzaStore nyPizzaStore = <span class="keyword">new</span> NYPizzaStore();</span><br><span class="line">        nyPizzaStore.makePizza();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ThickCrustDough</span><br><span class="line">MarinaraSauce</span><br></pre></td></tr></table></figure><h1 id="第五章-单件模式"><a href="#第五章-单件模式" class="headerlink" title="第五章 单件模式"></a>第五章 单件模式</h1><p><strong>1. 模式定义</strong> </p><p>确保一个类只有一个实例，并提供了一个全局访问点。</p><p><strong>2. 模式类图</strong> </p><p>使用一个私有构造器、一个私有静态变量以及一个公有静态函数来实现。私有构造函数保证了不能通过构造函数来创建对象实例，只能通过公有静态函数返回唯一的私有静态变量。</p><p><br><div align="center"> <img src="../pics/59aff6c1-8bc5-48e4-9e9c-082baeb2f274.jpg"> </div><br></p><p><strong>3. 懒汉式-线程不安全</strong> </p><p>以下实现中，私有静态变量被延迟化实例化，这样做的好处是，如果没有用到该类，那么就不会创建私有静态变量，从而节约资源。</p><p>这个实现在多线程环境下是不安全的，如果多个线程能够同时进入 if(uniqueInstance == null) 内的语句块，那么就会多次实例化 uniqueInstance 私有静态变量。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton uniqueInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getUniqueInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            uniqueInstance = <span class="keyword">new</span> Singleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. 懒汉式-线程安全</strong> </p><p>只需要对 getUniqueInstance() 方法加锁，那么在一个时间点只能有一个线程能够进入该方法，从而避免了对 uniqueInstance 进行多次实例化的问题。但是这样有一个问题，就是当一个线程进入该方法之后，其它线程视图进入该方法都必须等待，因此性能上有一定的损耗。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getUniqueInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        uniqueInstance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uniqueInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5. 饿汉式-线程安全</strong> </p><p>线程不安全问题主要是由于静态实例变量被初始化了多次，那么静态实例变量采用直接实例化就可以解决问题。但是直接初始化的方法也丢失了延迟初始化节约资源的优势。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Singleton uniqueInstance = <span class="keyword">new</span> Singleton();</span><br></pre></td></tr></table></figure><p><strong>6. 双重校验锁-线程安全</strong> </p><p>因为 uniqueInstance 只需要被初始化一次，之后就可以直接使用了。加锁操作只需要对初始化那部分的代码进行，也就是说，只有当 uniqueInstance 没有被初始化时，才需要进行加锁。</p><p>双重校验锁先判断 uniqueInstance 是否已经被初始化了，如果没有被初始化，那么才对初始化的语句进行加锁。如果只做一次判断，那么多个线程还是有可能同时进入实例化语句块的，因此需要仅此第二次的判断。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton uniqueInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getUniqueInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (uniqueInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    uniqueInstance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uniqueInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="第六章-命令模式"><a href="#第六章-命令模式" class="headerlink" title="第六章 命令模式"></a>第六章 命令模式</h1><p><strong>1. 问题描述</strong> </p><p>设计一个遥控器，它有很多按钮，每个按钮可以发起一个命令，让一个家电完成相应操作。</p><p>有非常多的家电，并且之后会增加家电。</p><p><br><div align="center"> <img src="../pics/7b8f0d8e-a4fa-4c9d-b9a0-3e6a11cb3e33.jpg"> </div><br></p><p><br><div align="center"> <img src="../pics/c3ca36b2-8459-4cf1-98b0-cc95a0e94f20.jpg"> </div><br></p><p><strong>2. 模式定义</strong> </p><p>将命令封装成对象，以便使用不同的命令来参数化其它对象。</p><p><strong>3. 解决方案类图</strong> </p><ul><li><p>RemoteControl 是遥控器，它可以为每个按钮设置命令对象，并且调用命令对象的 execute() 方法。</p></li><li><p>Command 就是命令对象，命令模式正式将各种命令封装成 Commad 对象来实现的。</p></li><li><p>Light 是命令真正的执行者。可以注意到 LightOnCommand 和 LightOffCommand 类组合了一个 Light 对象，通过组合的方法，就可以将 excute() 方法委托给 Light 对象来执行。</p></li><li><p>RemoteLoader 是客户端，注意它与 RemoteControl 的区别。因为 RemoteControl 不能主动地调用自身的方法，因此也就不能当成是客户端。客户端好比人，只有人才能去真正去使用遥控器。</p></li></ul><p><br><div align="center"> <img src="../pics/5ef94f62-98ce-464d-a646-842d9c72c8b8.jpg"> </div><br></p><p><strong>4. 模式类图</strong> </p><p><br><div align="center"> <img src="../pics/1e09d75f-6268-4425-acf8-8ecd1b4a0ef3.jpg"> </div><br></p><p><strong>5. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Light</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Light is on!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Light is off!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LightOnCommand</span> <span class="keyword">implements</span> <span class="title">Command</span></span>&#123;</span><br><span class="line">    Light light;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LightOnCommand</span><span class="params">(Light light)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.light = light;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        light.on();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遥控器类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleRemoteControl</span> </span>&#123;</span><br><span class="line">    Command slot;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleRemoteControl</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommand</span><span class="params">(Command command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.slot = command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buttonWasPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        slot.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SimpleRemoteControl remote = <span class="keyword">new</span> SimpleRemoteControl();</span><br><span class="line">        Light light = <span class="keyword">new</span> Light();</span><br><span class="line">        LightOnCommand lightOnCommand = <span class="keyword">new</span> LightOnCommand(light);</span><br><span class="line">        remote.setCommand(lightOnCommand);</span><br><span class="line">        remote.buttonWasPressed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Light is on!</span><br></pre></td></tr></table></figure><h1 id="第七章-适配器模式与外观模式"><a href="#第七章-适配器模式与外观模式" class="headerlink" title="第七章 适配器模式与外观模式"></a>第七章 适配器模式与外观模式</h1><h2 id="1-适配器模式"><a href="#1-适配器模式" class="headerlink" title="1. 适配器模式"></a>1. 适配器模式</h2><p><strong>1. 模式定义</strong> </p><p>将一个类的接口，转换为客户期望的另一个接口。适配器让原本不兼容的类可以合作无间。</p><p><br><div align="center"> <img src="../pics/8e8ba824-7a9e-4934-a212-e6a41dcc1602.jpg"> </div><br></p><p><strong>2. 模式类图</strong> </p><p>有两种适配器模式的实现，一种是对象方式，一种是类方式。对象方式是通过组合的方法，让适配器类（Adapter）拥有一个待适配的对象（Adaptee），从而把相应的处理委托给待适配的对象。类方式用到多重继承，Adapter 继承 Target 和 Adaptee，先把 Adapter 当成 Adaptee 类型然后实例化一个对象，再把它当成 Target 类型的，这样 Client 就可以把这个对象当成 Target 的对象来处理，同时拥有 Adaptee 的方法。</p><p><br><div align="center"> <img src="../pics/253bd869-ea48-4092-9aed-6906ccb2f3b0.jpg"> </div><br></p><p><br><div align="center"> <img src="../pics/a797959a-0ed5-475b-8d97-df157c672019.jpg"> </div><br></p><p><strong>3. 问题描述</strong> </p><p>鸭子（Duck）和火鸡（Turkey）拥有不同的叫声，Duck 调用的是 quack() 方法，而 Turkey 调用 gobble() 方法。</p><p>要求将 Turkey 的 gobble() 方法适配成 Duck 的 quack() 方法。</p><p><strong>4. 解决方案类图</strong> </p><p><br><div align="center"> <img src="../pics/1a511c76-bb6b-40ab-b8aa-39eeb619d673.jpg"> </div><br></p><p><strong>5. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Turkey</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WildTurkey</span> <span class="keyword">implements</span> <span class="title">Turkey</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gobble</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"gobble!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TurkeyAdapter</span> <span class="keyword">implements</span> <span class="title">Duck</span></span>&#123;</span><br><span class="line">    Turkey turkey;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TurkeyAdapter</span><span class="params">(Turkey turkey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.turkey = turkey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        turkey.gobble();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DuckTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Turkey turkey = <span class="keyword">new</span> WildTurkey();</span><br><span class="line">        Duck duck = <span class="keyword">new</span> TurkeyAdapter(turkey);</span><br><span class="line">        duck.quack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gobble!</span><br></pre></td></tr></table></figure><h2 id="2-外观模式"><a href="#2-外观模式" class="headerlink" title="2. 外观模式"></a>2. 外观模式</h2><p><strong>1. 模式定义</strong> </p><p>提供了一个统一的接口，用来访问子系统中的一群接口，从而让子系统更容易使用。</p><p><strong>2. 模式类图</strong> </p><p><br><div align="center"> <img src="../pics/78f2314e-2643-41df-8f3d-b7e28294094b.jpg"> </div><br></p><p><strong>3. 问题描述</strong> </p><p>家庭影院中有众多电器，当要进行观看电影时需要对很多电器进行操作。要求简化这些操作，使得家庭影院类只提供一个简化的接口，例如提供一个看电影相关的接口。</p><p><br><div align="center"> <img src="../pics/106f5585-b2e7-4718-be5d-3b322d1ef42a.jpg"> </div><br></p><p><strong>4. 解决方案类图</strong> </p><p><br><div align="center"> <img src="../pics/25387681-89f8-4365-a2fa-83b86449ee84.jpg"> </div><br></p><p><strong>5. 设计原则</strong> </p><p><strong>最少知识原则</strong> ：只和你的密友谈话。也就是应当使得客户对象所需要交互的对象尽可能少。</p><p><strong>6. 代码实现</strong> </p><p>过于简单，无实现。</p><h1 id="第八章-模板方法模式"><a href="#第八章-模板方法模式" class="headerlink" title="第八章 模板方法模式"></a>第八章 模板方法模式</h1><p><strong>1. 模式定义</strong> </p><p>在一个方法中定义一个算法的骨架，而将一些步骤延迟到子类中。</p><p>模板方法使得子类可以在不改变算法结构的情况下，重新定义算法中的某些步骤。</p><p><strong>2. 模式类图</strong> </p><p>模板方法 templateMethod() 定义了算法的骨架，确定了 primitiveOperation1() 和 primitiveOperation2() 方法执行的顺序，而 primitiveOperation1() 和 primitiveOperation2() 让子类去实现。</p><p><br><div align="center"> <img src="../pics/ed62f400-192c-4185-899b-187958201f0c.jpg"> </div><br></p><p><strong>3. 问题描述</strong> </p><p>冲咖啡和冲茶都有类似的流程，但是某些步骤会有点不一样，要求复用那些相同步骤的代码。</p><p><br><div align="center"> <img src="../pics/d8f873fc-00bc-41ee-a87c-c1b4c0172844.png"> </div><br></p><p><strong>4. 解决方案类图</strong> </p><p>其中 prepareRecipe() 方法就是模板方法，它确定了其它四个方法的具体执行步骤。其中 brew() 和 addCondiments() 方法在子类中实现。</p><p><br><div align="center"> <img src="../pics/aa20c123-b6b5-432a-83d3-45dc39172192.jpg"> </div><br></p><p><strong>5. 设计原则</strong> </p><p><strong>好莱坞原则</strong> ：别调用（打电话给）我们，我们会调用（打电话给）你。这一原则可以防止依赖腐败，即防止高层组件依赖低层组件，低层组件又依赖高层组件。该原则在模板方法的体现为，只有父类会调用子类，子类不会调用父类。</p><p><strong>6. 钩子</strong> </p><p>钩子（hock）：某些步骤在不同实现中可有可无，可以先定义一个什么都不做的方法，把它加到模板方法中，如果子类需要它就覆盖默认实现并加上自己的实现。</p><p><strong>7. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CaffeineBeverage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">prepareRecipe</span><span class="params">()</span></span>&#123;</span><br><span class="line">        boilWater();</span><br><span class="line">        brew();</span><br><span class="line">        pourInCup();</span><br><span class="line">        addCondiments();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">boilWater</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"boilWater"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pourInCup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"pourInCup"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Coffee</span> <span class="keyword">extends</span> <span class="title">CaffeineBeverage</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Coffee.brew"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Coffee.addCondiments"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tea</span> <span class="keyword">extends</span> <span class="title">CaffeineBeverage</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Tea.brew"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addCondiments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Tea.addCondiments"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaffeineBeverageTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CaffeineBeverage caffeineBeverage = <span class="keyword">new</span> Coffee();</span><br><span class="line">        caffeineBeverage.prepareRecipe();</span><br><span class="line">        System.out.println(<span class="string">"-----------"</span>);</span><br><span class="line">        caffeineBeverage = <span class="keyword">new</span> Tea();</span><br><span class="line">        caffeineBeverage.prepareRecipe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">boilWater</span><br><span class="line">Coffee.brew</span><br><span class="line">pourInCup</span><br><span class="line">Coffee.addCondiments</span><br><span class="line">-----------</span><br><span class="line">boilWater</span><br><span class="line">Tea.brew</span><br><span class="line">pourInCup</span><br><span class="line">Tea.addCondiments</span><br></pre></td></tr></table></figure><h1 id="第九章-迭代器和组合模式"><a href="#第九章-迭代器和组合模式" class="headerlink" title="第九章 迭代器和组合模式"></a>第九章 迭代器和组合模式</h1><h2 id="1-迭代器模式"><a href="#1-迭代器模式" class="headerlink" title="1. 迭代器模式"></a>1. 迭代器模式</h2><p><strong>1. 模式定义</strong> </p><p>提供顺序访问一个聚合对象中的各个元素的方法，而又不暴露聚合对象内部的表示。</p><p><strong>2. 模式类图</strong> </p><ul><li><p>Aggregate 是聚合类，其中 createIterator() 方法可以产生一个 Iterator 对象；</p></li><li><p>Iterator 主要定义了 hasNext() 和 next() 方法。</p></li><li><p>Client 需要拥有一个 Aggregate 对象，这是很明显的。为了迭代变量 Aggregate 对象，也需要拥有 Iterator 对象。</p></li></ul><p><br><div align="center"> <img src="../pics/439deca7-fed0-4c89-87e5-7088d10f1fdb.jpg"> </div><br></p><p><strong>3. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aggregate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] items;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Aggregate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        items = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">            items[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">createIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteIterator(items);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] items;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteIterator</span><span class="params">(<span class="keyword">int</span>[] items)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position &lt; items.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> items[position++];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Aggregate aggregate = <span class="keyword">new</span> Aggregate();</span><br><span class="line">        Iterator iterator = aggregate.createIterator();</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">            System.out.println(iterator.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td></tr></table></figure></p><h2 id="2-Java-内置的迭代器"><a href="#2-Java-内置的迭代器" class="headerlink" title="2. Java 内置的迭代器"></a>2. Java 内置的迭代器</h2><p><strong>1. 实现接口</strong> </p><p>在使用 Java 的迭代器实现时，需要让聚合对象去实现 Iterable 接口，该接口有一个 iterator() 方法会返回一个 Iterator 对象。</p><p>使用 Java 内置的迭代器实现，客户对象可以使用 foreach 循环来遍历聚合对象中的每个元素。</p><p>Java 中的集合类基本都实现了 Iterable 接口。</p><p><strong>2. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aggregate</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">Integer</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] items;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Aggregate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        items = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">            items[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;Integer&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteIterator(items);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] items;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteIterator</span><span class="params">(<span class="keyword">int</span>[] items)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position &lt; items.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> items[position++];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Aggregate aggregate = <span class="keyword">new</span> Aggregate();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> item : aggregate) &#123;</span><br><span class="line">            System.out.println(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-组合模式"><a href="#3-组合模式" class="headerlink" title="3. 组合模式"></a>3. 组合模式</h2><p><strong>1. 设计原则</strong> </p><p>一个类应该只有一个引起改变的原因。</p><p><strong>2. 模式定义</strong> </p><p>允许将对象组合成树形结构来表现“整体/部分”层次结构。</p><p>组合能让客户以一致的方式处理个别对象以及组合对象。</p><p><strong>3. 模式类图</strong> </p><p>组件（Component）类是组合类（Composite）和叶子类（Leaf）的父类，可以把组合类看成是树的中间节点。</p><p>组合类拥有一个组件对象，因此组合类的操作可以委托给组件对象去处理，而组件对象可以是另一个组合类或者叶子类。</p><p><br><div align="center"> <img src="../pics/f99c019e-7e91-4c2e-b94d-b031c402dcb5.jpg"> </div><br></p><p><strong>4. 代码实现</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Component</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addChild</span><span class="params">(Component component)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        print(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> level)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Leaf</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Leaf</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addChild</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(); <span class="comment">// 牺牲透明性换取单一职责原则，这样就不用考虑是叶子节点还是组合节点</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">            System.out.print(<span class="string">"--"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"left:"</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Composite</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Component&gt; childs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Composite</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        childs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addChild</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">        childs.add(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">            System.out.print(<span class="string">"--"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Composite:"</span> + name);</span><br><span class="line">        <span class="keyword">for</span> (Component component : childs) &#123;</span><br><span class="line">            component.print(level + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Composite root = <span class="keyword">new</span> Composite(<span class="string">"root"</span>);</span><br><span class="line">        Component node1 = <span class="keyword">new</span> Leaf(<span class="string">"1"</span>);</span><br><span class="line">        Component node2 = <span class="keyword">new</span> Composite(<span class="string">"2"</span>);</span><br><span class="line">        Component node3 = <span class="keyword">new</span> Leaf(<span class="string">"3"</span>);</span><br><span class="line">        root.addChild(node1);</span><br><span class="line">        root.addChild(node2);</span><br><span class="line">        root.addChild(node3);</span><br><span class="line">        Component node21 = <span class="keyword">new</span> Leaf(<span class="string">"21"</span>);</span><br><span class="line">        Component node22 = <span class="keyword">new</span> Composite(<span class="string">"22"</span>);</span><br><span class="line">        node2.addChild(node21);</span><br><span class="line">        node2.addChild(node22);</span><br><span class="line">        Component node221 = <span class="keyword">new</span> Leaf(<span class="string">"221"</span>);</span><br><span class="line">        node22.addChild(node221);</span><br><span class="line">        root.print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Composite:root</span><br><span class="line">--left:1</span><br><span class="line">--Composite:2</span><br><span class="line">----left:21</span><br><span class="line">----Composite:22</span><br><span class="line">------left:221</span><br><span class="line">--left:3</span><br></pre></td></tr></table></figure><h1 id="第十章-状态模式"><a href="#第十章-状态模式" class="headerlink" title="第十章 状态模式"></a>第十章 状态模式</h1><p><strong>1. 模式定义</strong> </p><p>允许对象在内部状态改变时改变它的行为，对象看起来好像修改了它所属的类。</p><p><strong>2. 模式类图</strong> </p><p>Context 的 request() 方法委托给 State 对象去处理。当 Context 组合的 State 对象发生改变时，它的行为也就发生了改变。</p><p><br><div align="center"> <img src="../pics/c28fd93a-0d55-4a19-810f-72652feee00d.jpg"> </div><br></p><p><strong>3. 与策略模式的比较</strong> </p><p>状态模式的类图和策略模式一样，并且都是能够动态改变对象的行为。</p><p>但是状态模式是通过状态转移来改变 Context 所组合的 State 对象，而策略模式是通过 Context 本身的决策来改变组合的 Strategy 对象。</p><p>所谓的状态转移，是指 Context 在运行过程中由于一些条件发生改变而使得 State 对象发生改变，主要必须要是在运行过程中。</p><p>状态模式主要是用来解决状态转移的问题，当状态发生庄毅了，那么 Context 对象就会改变它的行为；而策略模式主要是用来封装一组可以互相替代的算法族，并且可以根据需要动态地去替换 Context 需要使用哪个算法。</p><p><strong>4. 问题描述</strong> </p><p>糖果销售机有多种状态，每种状态下销售机有不同的行为，状态可以发生转移，使得销售机的行为也发生改变。</p><p><br><div align="center"> <img src="../pics/f7d880c9-740a-4a16-ac6d-be502281b4b2.jpg"> </div><br></p><p><strong>5. 直接解决方案</strong> </p><p>在糖果机的每个操作函数里面，判断当前的状态，根据不同的状态进行不同的处理，并且发生不同的状态转移。</p><p>这种解决方案在需要增加状态的时候，必须对每个操作的代码都进行修改。</p><p><br><div align="center"> <img src="../pics/62ebbb63-8fd7-4488-a866-76a9dc911662.png"> </div><br></p><p><strong>6 代码实现</strong> </p><p>糖果销售机即 Context。</p><p>下面的实现中每个 State 都组合了 Context 对象，这是因为状态转移的操作在 State 对象中，而状态转移过程又必须改变 Context 对象的 state 对象，因此 State 必须拥有 Context 对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投入25 分钱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退回25 分钱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转动曲柄</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发放糖果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HasQuarterState</span> <span class="keyword">implements</span> <span class="title">State</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HasQuarterState</span><span class="params">(GumballMachine gumballMachine)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You can't insert another quarter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Quarter returned"</span>);</span><br><span class="line">        gumballMachine.setState(gumballMachine.getNoQuarterState());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You turned..."</span>);</span><br><span class="line">        gumballMachine.setState(gumballMachine.getSoldState());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"No gumball dispensed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoQuarterState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NoQuarterState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You insert a quarter"</span>);</span><br><span class="line">        gumballMachine.setState(gumballMachine.getHasQuarterState());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You haven't insert a quarter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You turned, but there's no quarter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You need to pay first"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoldOutState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldOutState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You can't insert a quarter, the machine is sold out"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You can't eject, you haven't inserted a quarter yet"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"You turned, but there are no gumballs"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"No gumball dispensed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoldState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    GumballMachine gumballMachine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoldState</span><span class="params">(GumballMachine gumballMachine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gumballMachine = gumballMachine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Please wait, we're already giving you a gumball"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Sorry, you already turned the crank"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Turning twice doesn't get you another gumball!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispense</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        gumballMachine.releaseBall();</span><br><span class="line">        <span class="keyword">if</span>(gumballMachine.getCount()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            gumballMachine.setState(gumballMachine.getNoQuarterState());</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Oops, out of gumballs"</span>);</span><br><span class="line">            gumballMachine.setState(gumballMachine.getSoldOutState());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GumballMachine</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> State soldOutState;</span><br><span class="line">    <span class="keyword">private</span> State noQuarterState;</span><br><span class="line">    <span class="keyword">private</span> State hasQuarterState;</span><br><span class="line">    <span class="keyword">private</span> State soldState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> State state;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GumballMachine</span><span class="params">(<span class="keyword">int</span> numberGumballs)</span> </span>&#123;</span><br><span class="line">        count = numberGumballs;</span><br><span class="line">        soldOutState = <span class="keyword">new</span> SoldOutState(<span class="keyword">this</span>);</span><br><span class="line">        noQuarterState = <span class="keyword">new</span> NoQuarterState(<span class="keyword">this</span>);</span><br><span class="line">        hasQuarterState = <span class="keyword">new</span> HasQuarterState(<span class="keyword">this</span>);</span><br><span class="line">        soldState = <span class="keyword">new</span> SoldState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (numberGumballs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            state = noQuarterState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            state = soldOutState;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state.insertQuarter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ejectQuarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state.ejectQuarter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">turnCrank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state.turnCrank();</span><br><span class="line">        state.dispense();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseBall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"A gumball comes rolling out the slot..."</span>);</span><br><span class="line">        <span class="keyword">if</span> (count != <span class="number">0</span>) &#123;</span><br><span class="line">            count -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getSoldOutState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> soldOutState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getNoQuarterState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> noQuarterState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getHasQuarterState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hasQuarterState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getSoldState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> soldState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GumballMachineTestDrive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GumballMachine gumballMachine = <span class="keyword">new</span> GumballMachine(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line"></span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.ejectQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line"></span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">        gumballMachine.ejectQuarter();</span><br><span class="line"></span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">        gumballMachine.insertQuarter();</span><br><span class="line">        gumballMachine.turnCrank();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">You insert a quarter</span><br><span class="line">You turned...</span><br><span class="line">A gumball comes rolling out the slot...</span><br><span class="line">You insert a quarter</span><br><span class="line">Quarter returned</span><br><span class="line">You turned, but there's no quarter</span><br><span class="line">You need to pay first</span><br><span class="line">You insert a quarter</span><br><span class="line">You turned...</span><br><span class="line">A gumball comes rolling out the slot...</span><br><span class="line">You insert a quarter</span><br><span class="line">You turned...</span><br><span class="line">A gumball comes rolling out the slot...</span><br><span class="line">You haven't insert a quarter</span><br><span class="line">You insert a quarter</span><br><span class="line">You can't insert another quarter</span><br><span class="line">You turned...</span><br><span class="line">A gumball comes rolling out the slot...</span><br><span class="line">You insert a quarter</span><br><span class="line">You turned...</span><br><span class="line">A gumball comes rolling out the slot...</span><br><span class="line">Oops, out of gumballs</span><br><span class="line">You can't insert a quarter, the machine is sold out</span><br><span class="line">You turned, but there are no gumballs</span><br><span class="line">No gumball dispensed</span><br></pre></td></tr></table></figure></p><h1 id="第十一章-代理模式"><a href="#第十一章-代理模式" class="headerlink" title="第十一章 代理模式"></a>第十一章 代理模式</h1><h1 id="第十二章-复合模式"><a href="#第十二章-复合模式" class="headerlink" title="第十二章 复合模式"></a>第十二章 复合模式</h1><h2 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h2><p><strong>传统 MVC</strong> </p><p>视图使用组合模式，模型使用了观察者模式，控制器使用了策略模式。</p><p><br><div align="center"> <img src="../pics/4f67611d-492f-4958-9fa0-4948010e345f.jpg"> </div><br></p><p><strong>Web 中的 MVC</strong> </p><p>模式不再使用观察者模式。</p><p><br><div align="center"> <img src="../pics/1dd56e61-2970-4d27-97c2-6e81cee86978.jpg"> </div><br></p><h1 id="第十三章-与设计模式相处"><a href="#第十三章-与设计模式相处" class="headerlink" title="第十三章 与设计模式相处"></a>第十三章 与设计模式相处</h1><p>定义：在某  <strong>情境</strong>  下，针对某 <strong>问题</strong> 的某种 <strong>解决方案</strong>。</p><p>过度使用设计模式可能导致代码被过度工程化，应该总是用最简单的解决方案完成工作，并在真正需要模式的地方才使用它。</p><p>反模式：不好的解决方案来解决一个问题。主要作用是为了警告不要使用这些解决方案。</p><p>模式分类：</p><p><br><div align="center"> <img src="../pics/524a237c-ffd7-426f-99c2-929a6bf4c847.jpg"> </div><br></p><h1 id="第十四章-剩下的模式"><a href="#第十四章-剩下的模式" class="headerlink" title="第十四章 剩下的模式"></a>第十四章 剩下的模式</h1><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#前言&quot;&gt;前言&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第一章-设计模式入门&quot;&gt;第一章 设计模式入门&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第二章-观察者模式&quot;&gt;第二章 观察者模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第三章-装饰模式&quot;&gt;第三章 装饰模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第四章-工厂模式&quot;&gt;第四章 工厂模式&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-简单工厂&quot;&gt;1. 简单工厂&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2--工厂方法模式&quot;&gt;2.  工厂方法模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3--抽象工厂模式&quot;&gt;3.  抽象工厂模式&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第五章-单件模式&quot;&gt;第五章 单件模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第六章-命令模式&quot;&gt;第六章 命令模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第七章-适配器模式与外观模式&quot;&gt;第七章 适配器模式与外观模式&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-适配器模式&quot;&gt;1. 适配器模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-外观模式&quot;&gt;2. 外观模式&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第八章-模板方法模式&quot;&gt;第八章 模板方法模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第九章-迭代器和组合模式&quot;&gt;第九章 迭代器和组合模式&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-迭代器模式&quot;&gt;1. 迭代器模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-java-内置的迭代器&quot;&gt;2. Java 内置的迭代器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-组合模式&quot;&gt;3. 组合模式&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第十章-状态模式&quot;&gt;第十章 状态模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第十一章-代理模式&quot;&gt;第十一章 代理模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第十二章-复合模式&quot;&gt;第十二章 复合模式&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#mvc&quot;&gt;MVC&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第十三章-与设计模式相处&quot;&gt;第十三章 与设计模式相处&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第十四章-剩下的模式&quot;&gt;第十四章 剩下的模式&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;文中涉及一些 UML 类图，为了更好地理解，可以先阅读 &lt;a href=&quot;https://github.com/CyC2018/Interview-Notebook/blob/master/notes/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%80%9D%E6%83%B3.md#1-%E7%B1%BB%E5%9B%BE&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;UML 类图&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;需要说明的一点是，文中的 UML 类图和规范的 UML 类图不大相同，其中组合关系使用以下箭头表示：&lt;/p&gt;
&lt;p&gt;&lt;br&gt;&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;../pics/09e398d8-9c6e-48f6-b48b-8b4f9de61d1d.png&quot;&gt; &lt;/div&gt;&lt;br&gt;&lt;/p&gt;
&lt;h1 id=&quot;第一章-设计模式入门&quot;&gt;&lt;a href=&quot;#第一章-设计模式入门&quot; class=&quot;headerlink&quot; title=&quot;第一章 设计模式入门&quot;&gt;&lt;/a&gt;第一章 设计模式入门&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;1. 设计模式概念&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;设计模式不是代码，而是解决问题的方案，学习现有的设计模式可以做到经验复用。&lt;/p&gt;
&lt;p&gt;拥有设计模式词汇，在沟通时就能用更少的词汇来讨论，并且不需要了解底层细节。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. 问题描述&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;设计不同种类的鸭子拥有不同的叫声和飞行方式。&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>2016 校招真题题解</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/2016%20%E6%A0%A1%E6%8B%9B%E7%9C%9F%E9%A2%98%E9%A2%98%E8%A7%A3.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/2016 校招真题题解.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:19:54.984Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#前言">前言</a></li><li><a href="#1-小米-小米git">1. 小米-小米Git</a></li><li><a href="#2-小米-懂二进制">2. 小米-懂二进制</a></li><li><a href="#3-小米-中国牛市">3. 小米-中国牛市</a></li><li><a href="#4-微软-lucky-string">4. 微软-LUCKY STRING</a></li><li><a href="#5-微软-numeric-keypad">5. 微软-Numeric Keypad</a></li><li><a href="#6-微软-spring-outing">6. 微软-Spring Outing</a></li><li><a href="#7-微软-s-expression">7. 微软-S-expression</a></li><li><a href="#8-华为-最高分是多少">8. 华为-最高分是多少</a></li><li><a href="#9-华为-简单错误记录">9. 华为-简单错误记录</a></li><li><a href="#10-华为-扑克牌大小">10. 华为-扑克牌大小</a></li><li><a href="#11-去哪儿-二分查找">11. 去哪儿-二分查找</a></li><li><a href="#12-去哪儿-首个重复字符">12. 去哪儿-首个重复字符</a></li><li><a href="#13-去哪儿-寻找coder">13. 去哪儿-寻找Coder</a></li><li><a href="#14-美团-最大差值">14. 美团-最大差值</a></li><li><a href="#15-美团-棋子翻转">15. 美团-棋子翻转</a></li><li><a href="#16-美团-拜访">16. 美团-拜访</a></li><li><a href="#17-美团-直方图内最大矩形">17. 美团-直方图内最大矩形</a></li><li><a href="#18-美团-字符串计数">18. 美团-字符串计数</a></li><li><a href="#19-美团-平均年龄">19. 美团-平均年龄</a></li><li><a href="#20-百度-罪犯转移">20. 百度-罪犯转移</a></li><li><a href="#22-百度-裁减网格纸">22. 百度-裁减网格纸</a></li><li><a href="#23-百度-钓鱼比赛">23. 百度-钓鱼比赛</a></li><li><a href="#24-百度-蘑菇阵">24. 百度-蘑菇阵</a><!-- GFM-TOC --></li></ul><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>省略的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">while</span> (in.hasNext()) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="1-小米-小米Git"><a href="#1-小米-小米Git" class="headerlink" title="1. 小米-小米Git"></a>1. 小米-小米Git</h1><ul><li>重建多叉树</li><li>使用 LCA</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    List&lt;TreeNode&gt; childs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    TreeNode(<span class="keyword">int</span> id) &#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSplitNode</span><span class="params">(String[] matrix, <span class="keyword">int</span> indexA, <span class="keyword">int</span> indexB)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = matrix.length;</span><br><span class="line">    <span class="keyword">boolean</span>[][] linked = <span class="keyword">new</span> <span class="keyword">boolean</span>[n][n]; <span class="comment">// 重建邻接矩阵</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            linked[i][j] = matrix[i].charAt(j) == <span class="string">'1'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    TreeNode tree = constructTree(linked, <span class="number">0</span>);</span><br><span class="line">    TreeNode ancestor = LCA(tree, <span class="keyword">new</span> TreeNode(indexA), <span class="keyword">new</span> TreeNode(indexB));</span><br><span class="line">    <span class="keyword">return</span> ancestor.id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">constructTree</span><span class="params">(<span class="keyword">boolean</span>[][] linked, <span class="keyword">int</span> root)</span> </span>&#123;</span><br><span class="line">    TreeNode tree = <span class="keyword">new</span> TreeNode(root);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; linked[root].length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (linked[root][i]) &#123;</span><br><span class="line">            linked[i][root] = <span class="keyword">false</span>; <span class="comment">//  因为题目给的邻接矩阵是双向的，在这里需要把它转为单向的</span></span><br><span class="line">            tree.childs.add(constructTree(links, i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">LCA</span><span class="params">(TreeNode root, TreeNode p, TreeNode q)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || root.id == p.id || root.id == q.id) <span class="keyword">return</span> root;</span><br><span class="line">    TreeNode ancestor = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; root.childs.size(); i++) &#123;</span><br><span class="line">        TreeNode tmp = LCA(root.childs.get(i), p, q);</span><br><span class="line">        <span class="keyword">if</span> (tmp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ancestor = tmp;</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt == <span class="number">2</span> ? root : ancestor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="2-小米-懂二进制"><a href="#2-小米-懂二进制" class="headerlink" title="2. 小米-懂二进制"></a>2. 小米-懂二进制</h1><p>对两个数进行异或，结果的二进制表示为 1 的那一位就是两个数不同的位。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countBitDiff</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.bitCount(m ^ n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="3-小米-中国牛市"><a href="#3-小米-中国牛市" class="headerlink" title="3. 小米-中国牛市"></a>3. 小米-中国牛市</h1><p>背包问题，可以设一个大小为 2 的背包。</p><p>状态转移方程如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i, j] = max(dp[i, j-1], prices[j] - prices[jj] + dp[i-1, jj]) &#123; jj in range of [0, j-1] &#125; = max(dp[i, j-1], prices[j] + max(dp[i-1, jj] - prices[jj]))</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculateMax</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = prices.length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>][n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> localMax = dp[i - <span class="number">1</span>][<span class="number">0</span>] - prices[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[i][j] = Math.max(dp[i][j - <span class="number">1</span>], prices[j] + localMax);</span><br><span class="line">            localMax = Math.max(localMax, dp[i - <span class="number">1</span>][j] - prices[j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[<span class="number">2</span>][n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="4-微软-LUCKY-STRING"><a href="#4-微软-LUCKY-STRING" class="headerlink" title="4. 微软-LUCKY STRING"></a>4. 微软-LUCKY STRING</h1><ul><li>斐波那契数列可以预计算；</li><li>从头到尾遍历字符串的过程，每一轮循环都使用一个 Set 来保存从 i 到 j 出现的字符，并且 Set 保证了字符都不同，因此 Set 的大小就是不同字符的个数。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Integer&gt; fibSet = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">21</span>, <span class="number">34</span>, <span class="number">55</span>, <span class="number">89</span>));</span><br><span class="line">Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">String str = in.nextLine();</span><br><span class="line"><span class="keyword">int</span> n = str.length();</span><br><span class="line">Set&lt;String&gt; ret = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    Set&lt;Character&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">        set.add(str.charAt(j));</span><br><span class="line">        <span class="keyword">int</span> cnt = set.size();</span><br><span class="line">        <span class="keyword">if</span> (fibSet.contains(cnt)) &#123;</span><br><span class="line">            ret.add(str.substring(i, j + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">String[] arr = ret.toArray(<span class="keyword">new</span> String[ret.size()]);</span><br><span class="line">Arrays.sort(arr);</span><br><span class="line"><span class="keyword">for</span> (String s : arr) &#123;</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="5-微软-Numeric-Keypad"><a href="#5-微软-Numeric-Keypad" class="headerlink" title="5. 微软-Numeric Keypad"></a>5. 微软-Numeric Keypad</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[][] canReach = &#123;</span><br><span class="line">        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;, <span class="comment">// 0</span></span><br><span class="line">        &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;, <span class="comment">// 1</span></span><br><span class="line">        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>&#125;, <span class="comment">// 2</span></span><br><span class="line">        &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;, <span class="comment">// 3</span></span><br><span class="line">        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;, <span class="comment">// 4</span></span><br><span class="line">        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>&#125;, <span class="comment">// 5</span></span><br><span class="line">        &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;, <span class="comment">// 6</span></span><br><span class="line">        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;, <span class="comment">// 7</span></span><br><span class="line">        &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>&#125;, <span class="comment">// 8</span></span><br><span class="line">        &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;  <span class="comment">// 9</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLegal</span><span class="params">(<span class="keyword">char</span>[] chars, <span class="keyword">int</span> idx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= chars.length || idx &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">int</span> cur = chars[idx] - <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">int</span> next = chars[idx + <span class="number">1</span>] - <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">return</span> canReach[cur][next] == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">    <span class="keyword">int</span> T = Integer.valueOf(in.nextLine());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; T; i++) &#123;</span><br><span class="line">        String line = in.nextLine();</span><br><span class="line">        <span class="keyword">char</span>[] chars = line.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; chars.length - <span class="number">1</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (!isLegal(chars, j)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (--chars[j + <span class="number">1</span>] &lt; <span class="string">'0'</span>) &#123;</span><br><span class="line">                    chars[j--]--;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = j + <span class="number">2</span>; k &lt; chars.length; k++) &#123;</span><br><span class="line">                    chars[k] = <span class="string">'9'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(chars));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="6-微软-Spring-Outing"><a href="#6-微软-Spring-Outing" class="headerlink" title="6. 微软-Spring Outing"></a>6. 微软-Spring Outing</h1><p>下面以 N = 3，K = 4 来进行讨论。</p><p>初始时，令第 0 个地方成为待定地点，也就是呆在家里。</p><p>从第 4 个地点开始投票，每个人只需要比较第 4 个地方和第 0 个地方的优先级，里，如果超过半数的人选择了第 4 个地方，那么更新第 4 个地方成为待定地点。</p><p>从后往前不断重复以上步骤，不断更新待定地点，直到所有地方都已经投票。</p><p>上面的讨论中，先令第 0 个地点成为待定地点，是因为这样的话第 4 个地点就只需要和这个地点进行比较，而不用考虑其它情况。如果最开始先令第 1 个地点成为待定地点，那么在对第 2 个地点进行投票时，每个人不仅要考虑第 2 个地点与第 1 个地点的优先级，也要考虑与其后投票地点的优先级。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> N = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> K = in.nextInt();</span><br><span class="line"><span class="keyword">int</span>[][] votes = <span class="keyword">new</span> <span class="keyword">int</span>[N][K + <span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; K + <span class="number">1</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> place = in.nextInt();</span><br><span class="line">        votes[i][place] = j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> place = K; place &gt; <span class="number">0</span>; place--) &#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (votes[i][place] &lt; votes[i][ret]) &#123;</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cnt &gt; N / <span class="number">2</span>) &#123;</span><br><span class="line">        ret = place;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(ret == <span class="number">0</span> ? <span class="string">"otaku"</span> : ret);</span><br></pre></td></tr></table></figure><h1 id="7-微软-S-expression"><a href="#7-微软-S-expression" class="headerlink" title="7. 微软-S-expression"></a>7. 微软-S-expression</h1><h1 id="8-华为-最高分是多少"><a href="#8-华为-最高分是多少" class="headerlink" title="8. 华为-最高分是多少"></a>8. 华为-最高分是多少</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> N = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> M = in.nextInt();</span><br><span class="line"><span class="keyword">int</span>[] scores = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    scores[i] = in.nextInt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M; i++) &#123;</span><br><span class="line">    String str = in.next();</span><br><span class="line">    <span class="keyword">if</span> (str.equals(<span class="string">"U"</span>)) &#123;</span><br><span class="line">        <span class="keyword">int</span> id = in.nextInt() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> newScore = in.nextInt();</span><br><span class="line">        scores[id] = newScore;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> idBegin = in.nextInt() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> idEnd = in.nextInt() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (idBegin &gt; idEnd) &#123;</span><br><span class="line">            <span class="keyword">int</span> t = idBegin;</span><br><span class="line">            idBegin = idEnd;</span><br><span class="line">            idEnd = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = idBegin; j &lt;= idEnd; j++) &#123;</span><br><span class="line">            ret = Math.max(ret, scores[j]);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="9-华为-简单错误记录"><a href="#9-华为-简单错误记录" class="headerlink" title="9. 华为-简单错误记录"></a>9. 华为-简单错误记录</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, Integer&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">while</span> (in.hasNextLine()) &#123;</span><br><span class="line">    String s = in.nextLine();</span><br><span class="line">    String key = s.substring(s.lastIndexOf(<span class="string">'\\'</span>) + <span class="number">1</span>);</span><br><span class="line">    map.put(key, map.containsKey(key) ? map.get(key) + <span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">List&lt;Map.Entry&lt;String, Integer&gt;&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;(map.entrySet());</span><br><span class="line">Collections.sort(list, (o1, o2) -&gt; o2.getValue() - o1.getValue());</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span> &amp;&amp; i &lt; list.size(); i++) &#123;</span><br><span class="line">    String[] token = list.get(i).getKey().split(<span class="string">" "</span>);</span><br><span class="line">    String filename = token[<span class="number">0</span>];</span><br><span class="line">    String line = token[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (filename.length() &gt; <span class="number">16</span>) filename = filename.substring(filename.length() - <span class="number">16</span>);</span><br><span class="line">    System.out.println(filename + <span class="string">" "</span> + line + <span class="string">" "</span> + list.get(i).getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="10-华为-扑克牌大小"><a href="#10-华为-扑克牌大小" class="headerlink" title="10. 华为-扑克牌大小"></a>10. 华为-扑克牌大小</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        map.put(<span class="string">"3"</span>, <span class="number">0</span>);</span><br><span class="line">        map.put(<span class="string">"4"</span>, <span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"5"</span>, <span class="number">2</span>);</span><br><span class="line">        map.put(<span class="string">"6"</span>, <span class="number">3</span>);</span><br><span class="line">        map.put(<span class="string">"7"</span>, <span class="number">4</span>);</span><br><span class="line">        map.put(<span class="string">"8"</span>, <span class="number">5</span>);</span><br><span class="line">        map.put(<span class="string">"9"</span>, <span class="number">6</span>);</span><br><span class="line">        map.put(<span class="string">"10"</span>, <span class="number">7</span>);</span><br><span class="line">        map.put(<span class="string">"J"</span>, <span class="number">8</span>);</span><br><span class="line">        map.put(<span class="string">"Q"</span>, <span class="number">9</span>);</span><br><span class="line">        map.put(<span class="string">"K"</span>, <span class="number">10</span>);</span><br><span class="line">        map.put(<span class="string">"A"</span>, <span class="number">11</span>);</span><br><span class="line">        map.put(<span class="string">"2"</span>, <span class="number">12</span>);</span><br><span class="line">        map.put(<span class="string">"joker"</span>, <span class="number">13</span>);</span><br><span class="line">        map.put(<span class="string">"JOKER "</span>, <span class="number">14</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">play</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">        String[] token1 = s1.split(<span class="string">" "</span>);</span><br><span class="line">        String[] token2 = s2.split(<span class="string">" "</span>);</span><br><span class="line">        CardType type1 = computeCardType(token1);</span><br><span class="line">        CardType type2 = computeCardType(token2);</span><br><span class="line">        <span class="keyword">if</span> (type1 == CardType.DoubleJoker) <span class="keyword">return</span> s1;</span><br><span class="line">        <span class="keyword">if</span> (type2 == CardType.DoubleJoker) <span class="keyword">return</span> s2;</span><br><span class="line">        <span class="keyword">if</span> (type1 == CardType.Bomb &amp;&amp; type2 != CardType.Bomb) <span class="keyword">return</span> s1;</span><br><span class="line">        <span class="keyword">if</span> (type2 == CardType.Bomb &amp;&amp; type1 != CardType.Bomb) <span class="keyword">return</span> s2;</span><br><span class="line">        <span class="keyword">if</span> (type1 != type2 || token1.length != token2.length) <span class="keyword">return</span> <span class="string">"ERROR"</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; token1.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> val1 = map.get(token1[i]);</span><br><span class="line">            <span class="keyword">int</span> val2 = map.get(token2[i]);</span><br><span class="line">            <span class="keyword">if</span> (val1 != val2) <span class="keyword">return</span> val1 &gt; val2 ? s1 : s2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ERROR"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CardType <span class="title">computeCardType</span><span class="params">(String[] token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> hasjoker = <span class="keyword">false</span>, hasJOKER = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; token.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (token[i].equals(<span class="string">"joker"</span>)) hasjoker = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (token[i].equals(<span class="string">"JOKER"</span>)) hasJOKER = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasjoker &amp;&amp; hasJOKER) <span class="keyword">return</span> CardType.DoubleJoker;</span><br><span class="line">        <span class="keyword">int</span> maxContinueLen = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> curContinueLen = <span class="number">1</span>;</span><br><span class="line">        String curValue = token[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; token.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (token[i].equals(curValue)) curContinueLen++;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                curContinueLen = <span class="number">1</span>;</span><br><span class="line">                curValue = token[i];</span><br><span class="line">            &#125;</span><br><span class="line">            maxContinueLen = Math.max(maxContinueLen, curContinueLen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (maxContinueLen == <span class="number">4</span>) <span class="keyword">return</span> CardType.Bomb;</span><br><span class="line">        <span class="keyword">if</span> (maxContinueLen == <span class="number">3</span>) <span class="keyword">return</span> CardType.Triple;</span><br><span class="line">        <span class="keyword">if</span> (maxContinueLen == <span class="number">2</span>) <span class="keyword">return</span> CardType.Double;</span><br><span class="line">        <span class="keyword">boolean</span> isStraight = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; token.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (map.get(token[i]) - map.get(token[i - <span class="number">1</span>]) != <span class="number">1</span>) &#123;</span><br><span class="line">                isStraight = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isStraight &amp;&amp; token.length == <span class="number">5</span>) <span class="keyword">return</span> CardType.Straight;</span><br><span class="line">        <span class="keyword">return</span> CardType.Sigal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> CardType &#123;</span><br><span class="line">        DoubleJoker, Bomb, Sigal, Double, Triple, Straight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Main main = <span class="keyword">new</span> Main();</span><br><span class="line">        Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">while</span> (in.hasNextLine()) &#123;</span><br><span class="line">            String s = in.nextLine();</span><br><span class="line">            String[] token = s.split(<span class="string">"-"</span>);</span><br><span class="line">            System.out.println(main.play(token[<span class="number">0</span>], token[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="11-去哪儿-二分查找"><a href="#11-去哪儿-二分查找" class="headerlink" title="11. 去哪儿-二分查找"></a>11. 去哪儿-二分查找</h1><p>对于有重复元素的有序数组，二分查找需要注意以下要点：</p><ul><li>if (val &lt;= A[m]) h = m;</li><li>因为 h 的赋值为 m 而不是 m - 1，因此 while 循环的条件也就为 l &lt; h。（如果是 m - 1 循环条件为 l &lt;= h）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPos</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> n, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, h = n - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; h) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + (h - l) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (val &lt;= A[m]) h = m;</span><br><span class="line">        <span class="keyword">else</span> l = m + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> A[h] == val ? h : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="12-去哪儿-首个重复字符"><a href="#12-去哪儿-首个重复字符" class="headerlink" title="12. 去哪儿-首个重复字符"></a>12. 去哪儿-首个重复字符</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">findFirstRepeat</span><span class="params">(String A, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span>[] hasAppear = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">char</span> c = A.charAt(i);</span><br><span class="line">        <span class="keyword">if</span>(hasAppear[c]) <span class="keyword">return</span> c;</span><br><span class="line">        hasAppear[c] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">' '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="13-去哪儿-寻找Coder"><a href="#13-去哪儿-寻找Coder" class="headerlink" title="13. 去哪儿-寻找Coder"></a>13. 去哪儿-寻找Coder</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] findCoder(String[] A, <span class="keyword">int</span> n) &#123;</span><br><span class="line">    List&lt;Pair&lt;String, Integer&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String s : A) &#123;</span><br><span class="line">        <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">        String t = s.toLowerCase();</span><br><span class="line">        <span class="keyword">int</span> idx = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            idx = t.indexOf(<span class="string">"coder"</span>, idx + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (idx == -<span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cnt != <span class="number">0</span>) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> Pair&lt;&gt;(s, cnt));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Collections.sort(list, (o1, o2) -&gt; (o2.getValue() - o1.getValue()));</span><br><span class="line">    String[] ret = <span class="keyword">new</span> String[list.size()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">        ret[i] = list.get(i).getKey();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 牛客网无法导入 javafx.util.Pair，这里就自己实现一下 Pair 类</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>, <span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">    T t;</span><br><span class="line">    K k;</span><br><span class="line"></span><br><span class="line">    Pair(T t, K k) &#123;</span><br><span class="line">        <span class="keyword">this</span>.t = t;</span><br><span class="line">        <span class="keyword">this</span>.k = k;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">K <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="14-美团-最大差值"><a href="#14-美团-最大差值" class="headerlink" title="14. 美团-最大差值"></a>14. 美团-最大差值</h1><p>贪心策略。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDis</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> soFarMin = A[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(soFarMin &gt; A[i]) soFarMin = A[i];</span><br><span class="line">        <span class="keyword">else</span> max = Math.max(max, A[i]- soFarMin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="15-美团-棋子翻转"><a href="#15-美团-棋子翻转" class="headerlink" title="15. 美团-棋子翻转"></a>15. 美团-棋子翻转</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[][] flipChess(<span class="keyword">int</span>[][] A, <span class="keyword">int</span>[][] f) &#123;</span><br><span class="line">    <span class="keyword">int</span>[][] direction = &#123;&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span>[] ff : f) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>[] dd : direction) &#123;</span><br><span class="line">            <span class="keyword">int</span> r = ff[<span class="number">0</span>] + dd[<span class="number">0</span>] - <span class="number">1</span>, c = ff[<span class="number">1</span>] + dd[<span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span>(r &lt; <span class="number">0</span> || r &gt; <span class="number">3</span> || c &lt; <span class="number">0</span> || c &gt; <span class="number">3</span>) <span class="keyword">continue</span>;</span><br><span class="line">            A[r][c] ^= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> A;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="16-美团-拜访"><a href="#16-美团-拜访" class="headerlink" title="16. 美团-拜访"></a>16. 美团-拜访</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Set&lt;String&gt; paths;</span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; curPath;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countPath</span><span class="params">(<span class="keyword">int</span>[][] map, <span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">    paths = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    curPath = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (map[i][j] == <span class="number">1</span>) &#123;</span><br><span class="line">                map[i][j] = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">int</span>[][] leftRightDirection = &#123;&#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line">                <span class="keyword">int</span>[][] topDownDirection = &#123;&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;&#125;;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span>[] lr : leftRightDirection) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span>[] td : topDownDirection) &#123;</span><br><span class="line">                        <span class="keyword">int</span>[][] directions = &#123;lr, td&#125;;</span><br><span class="line">                        backtracking(map, n, m, i, j, directions);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> paths.size();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backtracking</span><span class="params">(<span class="keyword">int</span>[][] map, <span class="keyword">int</span> n, <span class="keyword">int</span> m, <span class="keyword">int</span> r, <span class="keyword">int</span> c, <span class="keyword">int</span>[][] directions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (map[r][c] == <span class="number">2</span>) &#123;</span><br><span class="line">        String path = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> num : curPath) &#123;</span><br><span class="line">            path += num;</span><br><span class="line">        &#125;</span><br><span class="line">        paths.add(path);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; directions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextR = r + directions[i][<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> nextC = c + directions[i][<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (nextR &lt; <span class="number">0</span> || nextR &gt;= n || nextC &lt; <span class="number">0</span> || nextC &gt;= m || map[nextR][nextC] == -<span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">        map[nextR][nextC] = map[nextR][nextC] == <span class="number">2</span> ? <span class="number">2</span> : -<span class="number">1</span>;</span><br><span class="line">        curPath.add(nextR);</span><br><span class="line">        curPath.add(nextC);</span><br><span class="line">        backtracking(map, n, m, nextR, nextC, directions);</span><br><span class="line">        curPath.remove(curPath.size() - <span class="number">1</span>);</span><br><span class="line">        curPath.remove(curPath.size() - <span class="number">1</span>);</span><br><span class="line">        map[nextR][nextC] = map[nextR][nextC] == <span class="number">2</span> ? <span class="number">2</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="17-美团-直方图内最大矩形"><a href="#17-美团-直方图内最大矩形" class="headerlink" title="17. 美团-直方图内最大矩形"></a>17. 美团-直方图内最大矩形</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countArea</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> min = A[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">            min = Math.min(min, A[j]);</span><br><span class="line">            max = Math.max(max, min * (j - i + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="18-美团-字符串计数"><a href="#18-美团-字符串计数" class="headerlink" title="18. 美团-字符串计数"></a>18. 美团-字符串计数</h1><p>字符串都是小写字符，可以把字符串当成是 26 进制。但是字典序的比较和普通的整数比较不同，是从左往右进行比较，例如 “ac” 和 “abc”，字典序的比较结果为 “ac” &gt; “abc”，如果按照整数方法比较，因为 “abc” 是三位数，显然更大。</p><p>由于两个字符串的长度可能不想等，在 s1 空白部分和 s2 对应部分进行比较时，应该把 s1 的空白部分看成是 ‘a’ 字符进行填充的。</p><p>还有一点要注意的是，s1 到 s2 长度为 len<sub>i</sub> 的字符串个数只比较前面 i 个字符。例如 ‘aaa’ 和 ‘bbb’ ，长度为 2 的个数为 ‘aa’ 到 ‘bb’ 的字符串个数，不需要考虑后面部分的字符。</p><p>在统计个数时，从 len1 开始一直遍历到最大合法长度，每次循环都统计长度为 i 的子字符串个数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">String s1 = in.next();</span><br><span class="line">String s2 = in.next();</span><br><span class="line"><span class="keyword">int</span> len1 = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> len2 = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> len = Math.min(s2.length(), len2);</span><br><span class="line"><span class="keyword">int</span>[] subtractArr = <span class="keyword">new</span> <span class="keyword">int</span>[len];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">char</span> c1 = i &lt; s1.length() ? s1.charAt(i) : <span class="string">'a'</span>;</span><br><span class="line">    <span class="keyword">char</span> c2 = s2.charAt(i);</span><br><span class="line">    subtractArr[i] = c2 - c1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = len1; i &lt;= len; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">        ret += subtractArr[j] * Math.pow(<span class="number">26</span>, i - j - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(ret - <span class="number">1</span>);</span><br></pre></td></tr></table></figure><h1 id="19-美团-平均年龄"><a href="#19-美团-平均年龄" class="headerlink" title="19. 美团-平均年龄"></a>19. 美团-平均年龄</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> W = in.nextInt();</span><br><span class="line"><span class="keyword">double</span> Y = in.nextDouble();</span><br><span class="line"><span class="keyword">double</span> x = in.nextDouble();</span><br><span class="line"><span class="keyword">int</span> N = in.nextInt();</span><br><span class="line"><span class="keyword">while</span> (N-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    Y++; <span class="comment">// 老员工每年年龄都要加 1</span></span><br><span class="line">    Y += (<span class="number">21</span> - Y) * x;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println((<span class="keyword">int</span>) Math.ceil(Y));</span><br></pre></td></tr></table></figure><h1 id="20-百度-罪犯转移"><a href="#20-百度-罪犯转移" class="headerlink" title="20. 百度-罪犯转移"></a>20. 百度-罪犯转移</h1><p>部分和问题，将每次求的部分和缓存起来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> n = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> t = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> c = in.nextInt();</span><br><span class="line"><span class="keyword">int</span>[] values = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    values[i] = in.nextInt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> totalValue = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>, e = c - <span class="number">1</span>; e &lt; n; s++, e++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; c; j++) totalValue += values[j];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        totalValue = totalValue - values[s - <span class="number">1</span>] + values[e];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (totalValue &lt;= t) cnt++;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(cnt);</span><br></pre></td></tr></table></figure><h1 id="22-百度-裁减网格纸"><a href="#22-百度-裁减网格纸" class="headerlink" title="22. 百度-裁减网格纸"></a>22. 百度-裁减网格纸</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> n = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> minX, minY, maxX, maxY;</span><br><span class="line">minX = minY = Integer.MAX_VALUE;</span><br><span class="line">maxX = maxY = Integer.MIN_VALUE;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> x = in.nextInt();</span><br><span class="line">    <span class="keyword">int</span> y = in.nextInt();</span><br><span class="line">    minX = Math.min(minX, x);</span><br><span class="line">    minY = Math.min(minY, y);</span><br><span class="line">    maxX = Math.max(maxX, x);</span><br><span class="line">    maxY = Math.max(maxY, y);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println((<span class="keyword">int</span>) Math.pow(Math.max(maxX - minX, maxY - minY), <span class="number">2</span>));</span><br></pre></td></tr></table></figure><h1 id="23-百度-钓鱼比赛"><a href="#23-百度-钓鱼比赛" class="headerlink" title="23. 百度-钓鱼比赛"></a>23. 百度-钓鱼比赛</h1><p>P ( 至少钓一条鱼 ) = 1 - P ( 一条也钓不到 )</p><p>坑：读取概率矩阵的时候，需要一行一行进行读取，而不能直接用 in.nextDouble()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Scanner in = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">    <span class="keyword">while</span> (in.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = in.nextInt();</span><br><span class="line">        <span class="keyword">int</span> m = in.nextInt();</span><br><span class="line">        <span class="keyword">int</span> x = in.nextInt();</span><br><span class="line">        <span class="keyword">int</span> y = in.nextInt();</span><br><span class="line">        <span class="keyword">int</span> t = in.nextInt();</span><br><span class="line">        in.nextLine(); <span class="comment">// 坑</span></span><br><span class="line">        <span class="keyword">double</span> pcc = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">double</span> sum = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            String[] token = in.nextLine().split(<span class="string">" "</span>); <span class="comment">// 坑</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= m; j++) &#123;</span><br><span class="line">                <span class="keyword">double</span> p = Double.parseDouble(token[j - <span class="number">1</span>]);</span><br><span class="line">                <span class="comment">//  double p = in.nextDouble();</span></span><br><span class="line">                sum += p;</span><br><span class="line">                <span class="keyword">if</span> (i == x &amp;&amp; j == y) &#123;</span><br><span class="line">                    pcc = p;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> pss = sum / (n * m);</span><br><span class="line">        pcc = computePOfIRT(pcc, t);</span><br><span class="line">        pss = computePOfIRT(pss, t);</span><br><span class="line">        System.out.println(pcc &gt; pss ? <span class="string">"cc"</span> : pss &gt; pcc ? <span class="string">"ss"</span> : <span class="string">"equal"</span>);</span><br><span class="line">        System.out.printf(<span class="string">"%.2f\n"</span>, Math.max(pcc, pss));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compute probability of independent repeated trials</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">computePOfIRT</span><span class="params">(<span class="keyword">double</span> p, <span class="keyword">int</span> t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - Math.pow((<span class="number">1</span> - p), t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="24-百度-蘑菇阵"><a href="#24-百度-蘑菇阵" class="headerlink" title="24. 百度-蘑菇阵"></a>24. 百度-蘑菇阵</h1><p>这题用回溯会超时，需要用 DP。</p><p>dp[i][j] 表示到达 (i,j) 位置不会触碰蘑菇的概率。对于 N*M 矩阵，如果 i == N || j == M，那么 (i,j) 只能有一个移动方向；其它情况下能有两个移动方向。</p><p>考虑以下矩阵，其中第 3 行和第 3 列只能往一个方向移动，而其它位置可以有两个方向移动。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> N = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> M = in.nextInt();</span><br><span class="line"><span class="keyword">int</span> K = in.nextInt();</span><br><span class="line"><span class="keyword">boolean</span>[][] mushroom = <span class="keyword">new</span> <span class="keyword">boolean</span>[N][M];</span><br><span class="line"><span class="keyword">while</span> (K-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> x = in.nextInt();</span><br><span class="line">    <span class="keyword">int</span> y = in.nextInt();</span><br><span class="line">    mushroom[x - <span class="number">1</span>][y - <span class="number">1</span>] = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">double</span>[][] dp = <span class="keyword">new</span> <span class="keyword">double</span>[N][M];</span><br><span class="line">dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mushroom[i][j]) dp[i][j] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">double</span> cur = dp[i][j];</span><br><span class="line">            <span class="keyword">if</span> (i == N - <span class="number">1</span> &amp;&amp; j == M - <span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (i == N - <span class="number">1</span>) dp[i][j + <span class="number">1</span>] += cur;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (j == M - <span class="number">1</span>) dp[i + <span class="number">1</span>][j] += cur;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i][j + <span class="number">1</span>] += cur / <span class="number">2</span>;</span><br><span class="line">                dp[i + <span class="number">1</span>][j] += cur / <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">System.out.printf(<span class="string">"%.2f\n"</span>, dp[N - <span class="number">1</span>][M - <span class="number">1</span>]);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#前言&quot;&gt;前言&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#1-小米-小米git&quot;&gt;1. 小米-小米Git&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-小米-懂二进制&quot;&gt;2. 小米-懂二进制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-小米-中国牛市&quot;&gt;3. 小米-中国牛市&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-微软-lucky-string&quot;&gt;4. 微软-LUCKY STRING&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-微软-numeric-keypad&quot;&gt;5. 微软-Numeric Keypad&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-微软-spring-outing&quot;&gt;6. 微软-Spring Outing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-微软-s-expression&quot;&gt;7. 微软-S-expression&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-华为-最高分是多少&quot;&gt;8. 华为-最高分是多少&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#9-华为-简单错误记录&quot;&gt;9. 华为-简单错误记录&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#10-华为-扑克牌大小&quot;&gt;10. 华为-扑克牌大小&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#11-去哪儿-二分查找&quot;&gt;11. 去哪儿-二分查找&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-去哪儿-首个重复字符&quot;&gt;12. 去哪儿-首个重复字符&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-去哪儿-寻找coder&quot;&gt;13. 去哪儿-寻找Coder&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-美团-最大差值&quot;&gt;14. 美团-最大差值&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#15-美团-棋子翻转&quot;&gt;15. 美团-棋子翻转&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#16-美团-拜访&quot;&gt;16. 美团-拜访&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#17-美团-直方图内最大矩形&quot;&gt;17. 美团-直方图内最大矩形&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#18-美团-字符串计数&quot;&gt;18. 美团-字符串计数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#19-美团-平均年龄&quot;&gt;19. 美团-平均年龄&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#20-百度-罪犯转移&quot;&gt;20. 百度-罪犯转移&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-百度-裁减网格纸&quot;&gt;22. 百度-裁减网格纸&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-百度-钓鱼比赛&quot;&gt;23. 百度-钓鱼比赛&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#24-百度-蘑菇阵&quot;&gt;24. 百度-蘑菇阵&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>计算机操作系统</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/计算机操作系统.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:34:51.944Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#第一章-概述">第一章 概述</a><ul><li><a href="#操作系统基本特征">操作系统基本特征</a><ul><li><a href="#1-并发">1. 并发</a></li><li><a href="#2-共享">2. 共享</a></li><li><a href="#3-虚拟">3. 虚拟</a></li><li><a href="#4-异步">4. 异步</a></li></ul></li><li><a href="#系统调用">系统调用</a></li><li><a href="#中断分类">中断分类</a><ul><li><a href="#1-外中断">1. 外中断</a></li><li><a href="#2-异常">2. 异常</a></li><li><a href="#3-陷入">3. 陷入</a></li></ul></li><li><a href="#大内核和微内核">大内核和微内核</a><ul><li><a href="#1-大内核">1. 大内核</a></li><li><a href="#2-微内核">2. 微内核</a></li></ul></li></ul></li><li><a href="#第二章-进程管理">第二章 进程管理</a><ul><li><a href="#进程与线程">进程与线程</a><ul><li><a href="#1-进程">1. 进程</a></li><li><a href="#2-线程">2. 线程</a></li><li><a href="#3-区别">3. 区别</a></li></ul></li><li><a href="#进程状态的切换">进程状态的切换</a></li><li><a href="#调度算法">调度算法</a><ul><li><a href="#1-批处理系统中的调度">1. 批处理系统中的调度</a><ul><li><a href="#11-先来先服务">1.1 先来先服务</a></li><li><a href="#12-短作业优先">1.2 短作业优先</a></li><li><a href="#13-最短剩余时间优先">1.3 最短剩余时间优先</a></li></ul></li><li><a href="#2-交互式系统中的调度">2. 交互式系统中的调度</a><ul><li><a href="#21-优先权优先">2.1 优先权优先</a></li><li><a href="#22-时间片轮转">2.2 时间片轮转</a></li><li><a href="#23-多级反馈队列">2.3 多级反馈队列</a></li><li><a href="#24-短进程优先">2.4 短进程优先</a></li></ul></li><li><a href="#3-实时系统中的调度">3. 实时系统中的调度</a></li></ul></li><li><a href="#进程同步">进程同步</a><ul><li><a href="#1-临界区">1. 临界区</a></li><li><a href="#2-同步与互斥">2. 同步与互斥</a></li><li><a href="#3-信号量">3. 信号量</a></li><li><a href="#4-管程">4. 管程</a></li></ul></li><li><a href="#进程通信">进程通信</a><ul><li><a href="#1-管道">1. 管道</a></li><li><a href="#2-信号量">2. 信号量</a></li><li><a href="#3-消息队列">3. 消息队列</a></li><li><a href="#4-信号">4. 信号</a></li><li><a href="#5-共享内存">5. 共享内存</a></li><li><a href="#6-套接字">6. 套接字</a></li></ul></li><li><a href="#经典同步问题">经典同步问题</a><ul><li><a href="#1-读者-写者问题">1. 读者-写者问题</a></li><li><a href="#2-哲学家进餐问题">2. 哲学家进餐问题</a></li></ul></li></ul></li><li><a href="#第三章-死锁">第三章 死锁</a><ul><li><a href="#死锁的条件">死锁的条件</a></li><li><a href="#死锁的处理方法">死锁的处理方法</a><ul><li><a href="#1-鸵鸟策略">1. 鸵鸟策略</a></li><li><a href="#2-死锁预防">2. 死锁预防</a><ul><li><a href="#21-破坏互斥条件">2.1 破坏互斥条件</a></li><li><a href="#22-破坏请求与保持条件">2.2 破坏请求与保持条件</a></li><li><a href="#23-破坏不可抢占条件">2.3 破坏不可抢占条件</a></li><li><a href="#24-破坏环路等待">2.4 破坏环路等待</a></li></ul></li><li><a href="#3-死锁避免">3. 死锁避免</a><ul><li><a href="#31-安全状态">3.1 安全状态</a></li><li><a href="#32-单个资源的银行家算法">3.2 单个资源的银行家算法</a></li><li><a href="#33-多个资源的银行家算法">3.3 多个资源的银行家算法</a></li></ul></li><li><a href="#4-死锁检测与死锁恢复">4. 死锁检测与死锁恢复</a><ul><li><a href="#41-死锁检测算法">4.1 死锁检测算法</a></li><li><a href="#42-死锁恢复">4.2 死锁恢复</a></li></ul></li></ul></li></ul></li><li><a href="#第四章-存储器管理">第四章 存储器管理</a><ul><li><a href="#虚拟内存">虚拟内存</a></li><li><a href="#分页与分段">分页与分段</a><ul><li><a href="#1-分页">1. 分页</a></li><li><a href="#2-分段">2. 分段</a></li><li><a href="#3-段页式">3. 段页式</a></li><li><a href="#4-分页与分段区别">4. 分页与分段区别</a></li></ul></li><li><a href="#页面置换算法">页面置换算法</a><ul><li><a href="#1-最佳optimal">1. 最佳（Optimal）</a></li><li><a href="#2-先进先出fifo">2. 先进先出（FIFO）</a></li><li><a href="#3-最近最久未使用lru,-least-recently-used">3. 最近最久未使用（LRU, Least Recently Used）</a></li><li><a href="#4-时钟clock">4. 时钟（Clock）</a></li></ul></li></ul></li><li><a href="#第五章-设备管理">第五章 设备管理</a><ul><li><a href="#磁盘调度算法">磁盘调度算法</a><ul><li><a href="#1-先来先服务fcfs,-first-come-first-serverd">1. 先来先服务（FCFS, First Come First Serverd）</a></li><li><a href="#2-最短寻道时间优先sstf,-shortest-seek-time-first">2. 最短寻道时间优先（SSTF, Shortest Seek Time First）</a></li><li><a href="#3-扫描算法scan">3. 扫描算法（SCAN）</a></li><li><a href="#4-循环扫描算法cscan">4. 循环扫描算法（CSCAN）</a></li></ul></li></ul></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="第一章-概述"><a href="#第一章-概述" class="headerlink" title="第一章 概述"></a>第一章 概述</h1><h2 id="操作系统基本特征"><a href="#操作系统基本特征" class="headerlink" title="操作系统基本特征"></a>操作系统基本特征</h2><h3 id="1-并发"><a href="#1-并发" class="headerlink" title="1. 并发"></a>1. 并发</h3><p>并发性是指宏观上在一段时间内能同时运行多个程序，而并行性则指同一时刻能运行多个指令。</p><p>并行需要硬件支持，如多流水线或者多处理器。</p><p>操作系统通过引入进程和线程，使得程序能够并发运行。</p><h3 id="2-共享"><a href="#2-共享" class="headerlink" title="2. 共享"></a>2. 共享</h3><p>共享是指系统中的资源可以供多个并发进程共同使用。</p><p>有两种共享方式：互斥共享和同时共享。</p><p>互斥共享的资源称为临界资源，例如打印机等，在同一时间只允许一个进程访问，否则会出现错误，需要用同步机制来实现对临界资源的访问。</p><a id="more"></a><h3 id="3-虚拟"><a href="#3-虚拟" class="headerlink" title="3. 虚拟"></a>3. 虚拟</h3><p>虚拟技术把一个物理实体转换为多个逻辑实体。主要有两种虚拟技术：时分复用技术和空分复用技术，例如多个进程能在同一个处理器上并发执行使用了时分复用技术，让每个进程轮流占有处理器，每次只执行一小个时间片并快速切换。</p><h3 id="4-异步"><a href="#4-异步" class="headerlink" title="4. 异步"></a>4. 异步</h3><p>异步是指进程不是一次性执行完毕，而是走走停停，以不可知的速度向前推进。</p><h2 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h2><p>如果一个进程在用户态需要用到操作系统的一些功能，就需要使用系统调用从而陷入内核，由操作系统代为完成。</p><p>可以由系统调用请求的功能有设备管理、文件管理、进程管理、进程通信、存储器管理等。</p><h2 id="中断分类"><a href="#中断分类" class="headerlink" title="中断分类"></a>中断分类</h2><h3 id="1-外中断"><a href="#1-外中断" class="headerlink" title="1. 外中断"></a>1. 外中断</h3><p>由 CPU 执行指令以外的事件引起，如 I/O 结束中断，表示设备输入/输出处理已经完成，处理器能够发送下一个输入/输出请求。此外还有时钟中断、控制台中断等。</p><h3 id="2-异常"><a href="#2-异常" class="headerlink" title="2. 异常"></a>2. 异常</h3><p>由 CPU 执行指令的内部事件引起，如非法操作码、地址越界、算术溢出等。</p><h3 id="3-陷入"><a href="#3-陷入" class="headerlink" title="3. 陷入"></a>3. 陷入</h3><p>在用户程序中使用系统调用。</p><h2 id="大内核和微内核"><a href="#大内核和微内核" class="headerlink" title="大内核和微内核"></a>大内核和微内核</h2><h3 id="1-大内核"><a href="#1-大内核" class="headerlink" title="1. 大内核"></a>1. 大内核</h3><p>大内核是将操作系统功能作为一个紧密结合的整体放到内核，由于各模块共享信息，因此有很高的性能。</p><h3 id="2-微内核"><a href="#2-微内核" class="headerlink" title="2. 微内核"></a>2. 微内核</h3><p>由于操作系统不断复杂，因此将一部分操作系统功能移出内核，从而降低内核的复杂性。移出的部分根据分层的原则划分成若干服务，相互独立。但是需要频繁地在用户态和核心态之间进行切换，会有一定的性能损失。</p><h1 id="第二章-进程管理"><a href="#第二章-进程管理" class="headerlink" title="第二章 进程管理"></a>第二章 进程管理</h1><h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><h3 id="1-进程"><a href="#1-进程" class="headerlink" title="1. 进程"></a>1. 进程</h3><p>进程是操作系统进行资源分配的基本单位。</p><p>进程控制块 (Process Control Block, PCB) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。</p><h3 id="2-线程"><a href="#2-线程" class="headerlink" title="2. 线程"></a>2. 线程</h3><p>一个进程中可以有多个线程，线程是独立调度的基本单位。同一个进程中的多个线程之间可以并发执行，它们共享进程资源。</p><h3 id="3-区别"><a href="#3-区别" class="headerlink" title="3. 区别"></a>3. 区别</h3><ul><li><p>拥有资源：进程是资源分配的基本单位，但是线程不拥有资源，线程可以访问隶属进程的资源。</p></li><li><p>调度：线程是独立调度的基本单位，在同一进程中，线程的切换不会引起进程切换，从一个进程内的线程切换到另一个进程中的线程时，会引起进程切换。</p></li><li><p>系统开销：由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、I/O 设备等，因此操作系统所付出的开销远大于创建或撤销线程时的开销。类似地，在进行进程切换时，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置。而线程切换时只需保存和设置少量寄存器内容，开销很小。</p></li><li><p>通信方面：进程间通信 (IPC) 需要进程同步和互斥手段的辅助，以保证数据的一致性，而线程间可以通过直接读/写同一进程中的数据段（如全局变量）来进行通信。</p></li></ul><p>举例：QQ 和浏览器是两个进程，浏览器进程里面有很多线程，例如 HTTP 请求线程、事件响应线程、渲染线程等等，线程的并发执行使得在浏览器中点击一个新链接从而发起 HTTP 请求时，浏览器还可以响应用户的其它事件。</p><h2 id="进程状态的切换"><a href="#进程状态的切换" class="headerlink" title="进程状态的切换"></a>进程状态的切换</h2><p><br><div align="center"> <img src="../pics/1706ce58-a081-4fed-9b36-c3c0d7e22b3a.jpg"> </div><br></p><p>阻塞状态是缺少需要的资源从而由运行状态转换而来，但是该资源不包括 CPU，缺少 CPU 会让进程从运行态转换为就绪态。</p><p>只有就绪态和运行态可以相互转换，其它的都是单向转换。就绪状态的进程通过调度算法从而获得 CPU 时间，转为运行状态；而运行状态的进程，在分配给它的 CPU 时间片用完之后就会转为就绪状态，等待下一次调度。</p><h2 id="调度算法"><a href="#调度算法" class="headerlink" title="调度算法"></a>调度算法</h2><p>需要针对不同环境来讨论调度算法。</p><h3 id="1-批处理系统中的调度"><a href="#1-批处理系统中的调度" class="headerlink" title="1. 批处理系统中的调度"></a>1. 批处理系统中的调度</h3><h4 id="1-1-先来先服务"><a href="#1-1-先来先服务" class="headerlink" title="1.1 先来先服务"></a>1.1 先来先服务</h4><p>first-come first-serverd（FCFS）。</p><p>调度最先进入就绪队列的作业。</p><p>有利于长作业，但不利于短作业，因为短作业必须一直等待前面的长作业执行完毕才能执行，而长作业又需要执行很长时间，造成了短作业等待时间过长。</p><h4 id="1-2-短作业优先"><a href="#1-2-短作业优先" class="headerlink" title="1.2 短作业优先"></a>1.2 短作业优先</h4><p>shortest job first（SJF）。</p><p>调度估计运行时间最短的作业。</p><p>长作业有可能会饿死，处于一直等待短作业执行完毕的状态。如果一直有短作业到来，那么长作业永远得不到调度。</p><h4 id="1-3-最短剩余时间优先"><a href="#1-3-最短剩余时间优先" class="headerlink" title="1.3 最短剩余时间优先"></a>1.3 最短剩余时间优先</h4><p>shortest remaining time next（SRTN）。</p><h3 id="2-交互式系统中的调度"><a href="#2-交互式系统中的调度" class="headerlink" title="2. 交互式系统中的调度"></a>2. 交互式系统中的调度</h3><h4 id="2-1-优先权优先"><a href="#2-1-优先权优先" class="headerlink" title="2.1 优先权优先"></a>2.1 优先权优先</h4><p>除了可以手动赋予优先权之外，还可以把响应比作为优先权，这种调度方式叫做高响应比优先调度算法。</p><p>响应比 = (等待时间 + 要求服务时间) / 要求服务时间 = 响应时间 / 要求服务时间</p><p>这种调度算法主要是为了解决 SJF 中长作业可能会饿死的问题，因为随着等待时间的增长，响应比也会越来越高。</p><h4 id="2-2-时间片轮转"><a href="#2-2-时间片轮转" class="headerlink" title="2.2 时间片轮转"></a>2.2 时间片轮转</h4><p>将所有就绪进程按 FCFS 的原则排成一个队列，每次调度时，把 CPU 分配给队首进程，该进程可以执行一个时间片。当时间片用完时，由计时器发出时钟中断，调度程序便停止该进程的执行，并将它送往就绪队列的末尾，同时继续把 CPU 分配给队首的进程。</p><p>时间片轮转算法的效率和时间片的大小有很大关系。因为每次进程切换都要保存进程的信息并且载入新进程的信息，如果时间片太小，进程切换太频繁，在进程切换上就会花过多时间。</p><h4 id="2-3-多级反馈队列"><a href="#2-3-多级反馈队列" class="headerlink" title="2.3 多级反馈队列"></a>2.3 多级反馈队列</h4><p><br><div align="center"> <img src="../pics/042cf928-3c8e-4815-ae9c-f2780202c68f.png"> </div><br></p><ol><li><p>设置多个就绪队列，并为各个队列赋予不同的优先级。第一个队列的优先级最高，第二个队列次之，其余各队列的优先权逐个降低。该算法赋予各个队列中进程执行时间片的大小也各不相同，在优先权越高的队列中，为每个进程所规定的执行时间片就越小。</p></li><li><p>当一个新进程进入内存后，首先将它放入第一队列的末尾，按 FCFS 原则排队等待调度。当轮到该进程执行时，如它能在该时间片内完成，便可准备撤离系统；如果它在一个时间片结束时尚未完成，调度程序便将该进程转入下一个队列的队尾。</p></li><li><p>仅当前 i -1 个队列均空时，才会调度第 i 个队列中的进程。</p></li></ol><p>优点：实时性好，同时适合运行短作业和长作业。</p><h4 id="2-4-短进程优先"><a href="#2-4-短进程优先" class="headerlink" title="2.4 短进程优先"></a>2.4 短进程优先</h4><h3 id="3-实时系统中的调度"><a href="#3-实时系统中的调度" class="headerlink" title="3. 实时系统中的调度"></a>3. 实时系统中的调度</h3><p>实时系统要一个服务请求在一个确定时间内得到响应。</p><p>分为硬实时和软实时，前者必须满足绝对的截止时间，后者可以容忍一定的超时。</p><h2 id="进程同步"><a href="#进程同步" class="headerlink" title="进程同步"></a>进程同步</h2><h3 id="1-临界区"><a href="#1-临界区" class="headerlink" title="1. 临界区"></a>1. 临界区</h3><p>对临界资源进行访问的那段代码称为临界区。</p><p>为了互斥访问临界资源，每个进程在进入临界区之前，需要先进行检查。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// entry section</span><br><span class="line">// critical section;</span><br><span class="line">// exit section</span><br></pre></td></tr></table></figure><h3 id="2-同步与互斥"><a href="#2-同步与互斥" class="headerlink" title="2. 同步与互斥"></a>2. 同步与互斥</h3><p>同步指多个进程按一定顺序执行；互斥指多个进程在同一时刻只有一个进程能进入临界区。</p><p>同步是在对临界区互斥访问的基础上，通过其它机制来实现有序访问的。</p><h3 id="3-信号量"><a href="#3-信号量" class="headerlink" title="3. 信号量"></a>3. 信号量</h3><p><strong>信号量（Semaphore）</strong>  是一个整型变量，可以对其执行 down 和 up 操作，也就是常见的 P 和 V 操作。</p><ul><li><strong>down</strong>  : 如果信号量大于 0 ，执行 -1 操作；如果信号量等于 0，将进程睡眠，等待信号量大于 0；</li><li><strong>up</strong> ：对信号量执行 +1 操作，并且唤醒睡眠的进程，让进程完成 down 操作。</li></ul><p>down 和 up 操作需要被设计成原语，不可分割，通常的做法是在执行这些操作的时候屏蔽中断。</p><p>如果信号量的取值只能为 0 或者 1，那么就成为了 <strong>互斥量（Mutex）</strong> ，0 表示临界区已经加锁，1 表示临界区解锁。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> semaphore;</span><br><span class="line">semaphore mutex = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    down(mutex);</span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line">    up(mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    down(mutex);</span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line">    up(mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>使用信号量实现生产者-消费者问题</strong> </p><p>使用一个互斥量 mutex 来对临界资源进行访问；empty 记录空缓冲区的数量，full 记录满缓冲区的数量。</p><p>注意，必须先执行 down 操作再用互斥量对临界区加锁，否则会出现死锁。因为如果都先对临界区加锁，然后再执行 down 操作，那么可能会出现这种情况：生产者对临界区加锁后，执行 down(empty) 操作，发现 empty = 0，此时生成者睡眠。消费者此时不能进入临界区，因为生产者对临界区加锁了，也就无法执行 up(empty) 操作，那么生产者和消费者就会一直等待下去。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 100</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> semaphore;</span><br><span class="line">semaphore mutex = <span class="number">1</span>;</span><br><span class="line">semaphore empty = N;</span><br><span class="line">semaphore full = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(TRUE)&#123;</span><br><span class="line">        <span class="keyword">int</span> item = produce_item;</span><br><span class="line">        down(empty);</span><br><span class="line">        down(mutex);</span><br><span class="line">        insert_item(item);</span><br><span class="line">        up(mutex);</span><br><span class="line">        up(full);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(TRUE)&#123;</span><br><span class="line">        down(full);</span><br><span class="line">        down(mutex);</span><br><span class="line">        <span class="keyword">int</span> item = remove_item(item);</span><br><span class="line">        up(mutex);</span><br><span class="line">        up(empty);</span><br><span class="line">        consume_item(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-管程"><a href="#4-管程" class="headerlink" title="4. 管程"></a>4. 管程</h3><p>使用信号量机制实现的生产者消费者问题需要客户端代码做很多控制，而管程把控制的代码独立出来，不仅不容易出错，也使得客户端代码调用更容易。</p><p>c 语言不支持管程，下面的示例代码使用了类 Pascal 语言来描述管程。示例代码中的管程提供了 insert() 和 remove() 方法，客户端代码通过调用这两个方法来解决生产者-消费者问题。</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">monitor ProducerConsumer</span><br><span class="line">    integer i;</span><br><span class="line">    condition c;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">procedure</span> <span class="title">insert</span><span class="params">()</span>;</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">procedure</span> <span class="title">remove</span><span class="params">()</span>;</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span> monitor;</span><br></pre></td></tr></table></figure><p>管程有一个重要特性：在一个时刻只能有一个进程使用管程。进程在无法继续执行的时候不能一直占用管程，否者其它进程永远不能使用管程。</p><p>管程引入了  <strong>条件变量</strong>  以及相关的操作：<strong>wait()</strong> 和 <strong>signal()</strong> 来实现同步操作。对条件变量执行 wait() 操作会导致调用进程阻塞，把管程让出来让另一个进程持有。signal() 操作用于唤醒被阻塞的进程。</p><p><strong>使用管程实现生成者-消费者问题</strong> </p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">monitor ProducerConsumer</span><br><span class="line">    condition full, empty;</span><br><span class="line">    integer count := <span class="number">0</span>;</span><br><span class="line">    condition c;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">procedure</span> <span class="title">insert</span><span class="params">(item: integer)</span>;</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> count = N <span class="keyword">then</span> wait(full);</span><br><span class="line">        insert_item(item);</span><br><span class="line">        count := count + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> count = <span class="number">1</span> ten signal(empty);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">remove</span>:</span> integer;</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> count = <span class="number">0</span> <span class="keyword">then</span> wait(empty);</span><br><span class="line">        remove = remove_item;</span><br><span class="line">        count := count - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> count = N -<span class="number">1</span> <span class="keyword">then</span> signal(full);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span> monitor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">producer</span></span></span><br><span class="line"><span class="function"><span class="title">begin</span></span></span><br><span class="line"><span class="function">    <span class="title">while</span> <span class="title">true</span> <span class="title">do</span></span></span><br><span class="line"><span class="function">    <span class="title">begin</span></span></span><br><span class="line"><span class="function">        <span class="title">item</span> = <span class="title">produce_item</span>;</span></span><br><span class="line">        ProducerConsumer.insert(item);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">consumer</span></span></span><br><span class="line"><span class="function"><span class="title">begin</span></span></span><br><span class="line"><span class="function">    <span class="title">while</span> <span class="title">true</span> <span class="title">do</span></span></span><br><span class="line"><span class="function">    <span class="title">begin</span></span></span><br><span class="line"><span class="function">        <span class="title">item</span> = <span class="title">ProducerConsumer</span>.<span class="title">remove</span>;</span></span><br><span class="line">        consume_item(item);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><h2 id="进程通信"><a href="#进程通信" class="headerlink" title="进程通信"></a>进程通信</h2><p>进程通信可以看成是不同进程间的线程通信，对于同一个进程内线程的通信方式，主要使用信号量、条件变量等同步机制。</p><h3 id="1-管道"><a href="#1-管道" class="headerlink" title="1. 管道"></a>1. 管道</h3><p>管道是单向的、先进先出的、无结构的、固定大小的字节流，它把一个进程的标准输出和另一个进程的标准输入连接在一起。写进程在管道的尾端写入数据，读进程在管道的首端读出数据。数据读出后将从管道中移走，其它读进程都不能再读到这些数据。</p><p>管道提供了简单的流控制机制，进程试图读空管道时，在有数据写入管道前，进程将一直阻塞。同样地，管道已经满时，进程再试图写管道，在其它进程从管道中移走数据之前，写进程将一直阻塞。</p><p>Linux 中管道是通过空文件来实现。</p><p>管道有三种：</p><ol><li>普通管道：有两个限制：一是只支持半双工通信方式，即只能单向传输；二是只能在父子进程之间使用；</li><li>流管道：去除第一个限制，支持双向传输；</li><li>命名管道：去除第二个限制，可以在不相关进程之间进行通信。</li></ol><h3 id="2-信号量"><a href="#2-信号量" class="headerlink" title="2. 信号量"></a>2. 信号量</h3><p>信号量是一个计数器，可以用来控制多个进程对共享资源的访问。它常作为一种锁机制，防止某进程正在访问共享资源时，其它进程也访问该资源。因此，主要作为进程间以及同一进程内不同线程之间的同步手段。</p><h3 id="3-消息队列"><a href="#3-消息队列" class="headerlink" title="3. 消息队列"></a>3. 消息队列</h3><p>消息队列克服了信号传递信息少、管道只能承载无格式字节流以及缓冲区大小受限等缺点。</p><h3 id="4-信号"><a href="#4-信号" class="headerlink" title="4. 信号"></a>4. 信号</h3><p>信号是一种比较复杂的通信方式，用于通知接收进程某个事件已经发生。</p><h3 id="5-共享内存"><a href="#5-共享内存" class="headerlink" title="5. 共享内存"></a>5. 共享内存</h3><p>共享内存就是映射一段能被其它进程所访问的内存，这段共享内存由一个进程创建，但多个进程都可以访问。共享内存是最快的 IPC 方式，它是针对其它 IPC 运行效率低而专门设计的。它往往与其它通信机制（如信号量）配合使用，来实现进程间的同步和通信。</p><h3 id="6-套接字"><a href="#6-套接字" class="headerlink" title="6. 套接字"></a>6. 套接字</h3><p>套接字也是一种进程间通信机制，与其它通信机制不同的是，它可用于不同机器间的进程通信。</p><h2 id="经典同步问题"><a href="#经典同步问题" class="headerlink" title="经典同步问题"></a>经典同步问题</h2><p>生产者和消费者问题前面已经讨论过。</p><h3 id="1-读者-写者问题"><a href="#1-读者-写者问题" class="headerlink" title="1. 读者-写者问题"></a>1. 读者-写者问题</h3><p>允许多个进程同时对数据进行读操作，但是不允许读和写以及写和写操作同时发生。</p><p>一个整型变量 count 记录在对数据进行读操作的进程数量，一个互斥量 count_mutex 用于对 count 加锁，一个互斥量 data_mutex 用于对读写的数据加锁。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> semaphore;</span><br><span class="line">semaphore count_mutex = <span class="number">1</span>;</span><br><span class="line">semaphore data_mutex = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(TRUE) &#123;</span><br><span class="line">        down(count_mutex);</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">if</span>(count == <span class="number">1</span>) down(data_mutex); <span class="comment">// 第一个读者需要对数据进行加锁，防止写进程访问</span></span><br><span class="line">        up(count_mutex);</span><br><span class="line">        read();</span><br><span class="line">        down(count_mutex);</span><br><span class="line">        count--;</span><br><span class="line">        <span class="keyword">if</span>(count == <span class="number">0</span>) up(data_mutex);</span><br><span class="line">        up(count_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(TRUE) &#123;</span><br><span class="line">        down(data_mutex);</span><br><span class="line">        write();</span><br><span class="line">        up(data_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-哲学家进餐问题"><a href="#2-哲学家进餐问题" class="headerlink" title="2. 哲学家进餐问题"></a>2. 哲学家进餐问题</h3><p><br><div align="center"> <img src="../pics/a9077f06-7584-4f2b-8c20-3a8e46928820.jpg"> </div><br></p><p>五个哲学家围着一张圆周，每个哲学家面前放着饭。哲学家的生活有两种交替活动：吃饭以及思考。当一个哲学家吃饭时，需要先一根一根拿起左右两边的筷子。</p><p>下面是一种错误的解法，考虑到如果每个哲学家同时拿起左手边的筷子，那么就无法拿起右手边的筷子，造成死锁。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEFT (i + N - 1) % N</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RIGHT (i + N) % N</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> semaphore;</span><br><span class="line">semaphore chopstick[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">philosopher</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(TURE)&#123;</span><br><span class="line">        think();</span><br><span class="line">        down(chopstick[LEFT[i]]);</span><br><span class="line">        down(chopstick[RIGHT[i]]);</span><br><span class="line">        eat();</span><br><span class="line">        up(chopstick[RIGHT[i]]);</span><br><span class="line">        up(chopstick[LEFT[i]]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了防止死锁的发生，可以加一点限制，只允许同时拿起左右两边的筷子，方法是引入一个互斥量，对拿起两个筷子的那段代码加锁。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">semaphore mutex = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">philosopher</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(TURE)&#123;</span><br><span class="line">        think();</span><br><span class="line">        down(mutex);</span><br><span class="line">        down(chopstick[LEFT[i]]);</span><br><span class="line">        down(chopstick[RIGHT[i]]);</span><br><span class="line">        up(mutex);</span><br><span class="line">        eat();</span><br><span class="line">        down(mutex);</span><br><span class="line">        up(chopstick[RIGHT[i]]);</span><br><span class="line">        up(chopstick[LEFT[i]]);</span><br><span class="line">        up(mutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="第三章-死锁"><a href="#第三章-死锁" class="headerlink" title="第三章 死锁"></a>第三章 死锁</h1><h2 id="死锁的条件"><a href="#死锁的条件" class="headerlink" title="死锁的条件"></a>死锁的条件</h2><p><br><div align="center"> <img src="../pics/c037c901-7eae-4e31-a1e4-9d41329e5c3e.png"> </div><br></p><ol><li>互斥</li><li>请求与保持</li><li>不可抢占</li><li>环路等待</li></ol><p>其中，请求与保持是指一个进程因请求资源而阻塞时，对已获得的资源保持不放。</p><h2 id="死锁的处理方法"><a href="#死锁的处理方法" class="headerlink" title="死锁的处理方法"></a>死锁的处理方法</h2><h3 id="1-鸵鸟策略"><a href="#1-鸵鸟策略" class="headerlink" title="1. 鸵鸟策略"></a>1. 鸵鸟策略</h3><p>把头埋在沙子里，假装根本没发生问题。</p><p>这种策略不可取。</p><h3 id="2-死锁预防"><a href="#2-死锁预防" class="headerlink" title="2. 死锁预防"></a>2. 死锁预防</h3><p>在程序运行之前预防发生死锁。</p><h4 id="2-1-破坏互斥条件"><a href="#2-1-破坏互斥条件" class="headerlink" title="2.1 破坏互斥条件"></a>2.1 破坏互斥条件</h4><p>例如假脱机打印机技术允许若干个进程同时输出，唯一真正请求物理打印机的进程是打印机守护进程。</p><h4 id="2-2-破坏请求与保持条件"><a href="#2-2-破坏请求与保持条件" class="headerlink" title="2.2 破坏请求与保持条件"></a>2.2 破坏请求与保持条件</h4><p>一种实现方式是规定所有进程在开始执行前请求所需要的全部资源。</p><h4 id="2-3-破坏不可抢占条件"><a href="#2-3-破坏不可抢占条件" class="headerlink" title="2.3 破坏不可抢占条件"></a>2.3 破坏不可抢占条件</h4><h4 id="2-4-破坏环路等待"><a href="#2-4-破坏环路等待" class="headerlink" title="2.4 破坏环路等待"></a>2.4 破坏环路等待</h4><p>给资源统一编号，进程只能按编号顺序来请求资源。</p><h3 id="3-死锁避免"><a href="#3-死锁避免" class="headerlink" title="3. 死锁避免"></a>3. 死锁避免</h3><p>在程序运行时避免发生死锁。</p><h4 id="3-1-安全状态"><a href="#3-1-安全状态" class="headerlink" title="3.1 安全状态"></a>3.1 安全状态</h4><p><br><div align="center"> <img src="../pics/ed523051-608f-4c3f-b343-383e2d194470.png"> </div><br></p><p>图 a 的第二列 has 表示已拥有的资源数，第三列 max 表示总共需要的资源数，free 表示还有可以使用的资源数。从图 a 开始出发，先让 B 拥有所需的所有资源，运行结束后释放 B，此时 free 变为 4；接着以同样的方式运行 C 和 A，使得所有进程都能成功运行，因此可以称图 a 所示的状态时安全的。</p><p>定义：如果没有死锁发生，并且即使所有进程突然请求对资源的最大需求，也仍然存在某种调度次序能够使得每一个进程运行完毕，则称该状态是安全的。</p><h4 id="3-2-单个资源的银行家算法"><a href="#3-2-单个资源的银行家算法" class="headerlink" title="3.2 单个资源的银行家算法"></a>3.2 单个资源的银行家算法</h4><p>一个小城镇的银行家，他向一群客户分别承诺了一定的贷款额度，算法要做的是判断对请求的满足是否会进入不安全状态，如果是，就拒绝请求；否则予以分配。</p><p><br><div align="center"> <img src="../pics/d160ec2e-cfe2-4640-bda7-62f53e58b8c0.png"> </div><br></p><p>上图 c 为不安全状态，因此算法会拒绝之前的请求，从而避免进入图 c 中的状态。</p><h4 id="3-3-多个资源的银行家算法"><a href="#3-3-多个资源的银行家算法" class="headerlink" title="3.3 多个资源的银行家算法"></a>3.3 多个资源的银行家算法</h4><p><br><div align="center"> <img src="../pics/62e0dd4f-44c3-43ee-bb6e-fedb9e068519.png"> </div><br></p><p>上图中有五个进程，四个资源。左边的图表示已经分配的资源，右边的图表示还需要分配的资源。最右边的 E、P 以及 A 分别表示：总资源、已分配资源以及可用资源，注意这三个为向量，而不是具体数值，例如 A=(1020)，表示 4 个资源分别还剩下 1/0/2/0。</p><p>检查一个状态是否安全的算法如下：</p><ul><li>查找右边的矩阵是否存在一行小于等于向量 A。如果不存在这样的行，那么系统将会发生死锁，状态是不安全的。</li><li>假若找到这样一行，将该进程标记为终止，并将其已分配资源加到 A 中。</li><li>重复以上两步，直到所有进程都标记为终止，则状态时安全的。</li></ul><h3 id="4-死锁检测与死锁恢复"><a href="#4-死锁检测与死锁恢复" class="headerlink" title="4. 死锁检测与死锁恢复"></a>4. 死锁检测与死锁恢复</h3><p>不试图阻止死锁，而是当检测到死锁发生时，采取措施进行恢复。</p><h4 id="4-1-死锁检测算法"><a href="#4-1-死锁检测算法" class="headerlink" title="4.1 死锁检测算法"></a>4.1 死锁检测算法</h4><p>死锁检测的基本思想是，如果一个进程所请求的资源能够被满足，那么就让它执行，释放它拥有的所有资源，然后让其它能满足条件的进程执行。</p><p><br><div align="center"> <img src="../pics/e1eda3d5-5ec8-4708-8e25-1a04c5e11f48.png"> </div><br></p><p>上图中，有三个进程四个资源，每个数据代表的含义如下：</p><ul><li>E 向量：资源总量</li><li>A 向量：资源剩余量</li><li>C 矩阵：每个进程所拥有的资源数量，每一行都代表一个进程拥有资源的数量</li><li>R 矩阵：每个进程请求的资源数量</li></ul><p>进程 P<sub>1</sub> 和 P<sub>2</sub> 所请求的资源都得不到满足，只有进程 P<sub>3</sub> 可以，让 P<sub>3</sub> 执行，之后释放 P<sub>3</sub> 拥有的资源，此时 A = (2 2 2 0)。P<sub>1</sub> 可以执行，执行后释放 P<sub>1</sub> 拥有的资源，A = (4 2 2 2) ，P<sub>2</sub> 也可以执行。所有进程都可以顺利执行，没有死锁。</p><p>算法总结如下：</p><p>每个进程最开始时都不被标记，执行过程有可能被标记。当算法结束时，任何没有被标记的进程都是死锁进程。</p><ol><li>寻找一个没有标记的进程 P<sub>i</sub>，它所请求的资源小于等于 A。</li><li>如果找到了这样一个进程，那么将 C 矩阵的第 i 行向量加到 A 中，标记该进程，并转回 1。</li><li>如果有没有这样一个进程，算法终止。</li></ol><h4 id="4-2-死锁恢复"><a href="#4-2-死锁恢复" class="headerlink" title="4.2 死锁恢复"></a>4.2 死锁恢复</h4><ul><li>利用抢占恢复</li><li>杀死进程</li></ul><h1 id="第四章-存储器管理"><a href="#第四章-存储器管理" class="headerlink" title="第四章 存储器管理"></a>第四章 存储器管理</h1><h2 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h2><p>每个程序拥有自己的地址空间，这个地址空间被分割成多个块，每一块称为一页。这些页被映射到物理内存，但不需要映射到连续的物理内存，也不需要所有页都必须在物理内存中。</p><p>当程序引用到一部分在物理内存中的地址空间时，由硬件执行必要的映射，将缺失的部分装入物理内存并重新执行失败的指令。</p><h2 id="分页与分段"><a href="#分页与分段" class="headerlink" title="分页与分段"></a>分页与分段</h2><h3 id="1-分页"><a href="#1-分页" class="headerlink" title="1. 分页"></a>1. 分页</h3><p>用户程序的地址空间被划分为若干固定大小的区域，称为“页”。相应地，内存空间分成若干个物理块，页和块的大小相等。可将用户程序的任一页放在内存的任一块中，实现了离散分配，由一个页表来维护它们之间的映射关系。</p><h3 id="2-分段"><a href="#2-分段" class="headerlink" title="2. 分段"></a>2. 分段</h3><p><br><div align="center"> <img src="../pics/22de0538-7c6e-4365-bd3b-8ce3c5900216.png"> </div><br></p><p>上图为一个编译器在编译过程中建立的多个表，有 4 个表是动态增长的，如果使用分页系统的一维地址空间，动态递增的特点会导致覆盖问题的出现。</p><p><br><div align="center"> <img src="../pics/e0900bb2-220a-43b7-9aa9-1d5cd55ff56e.png"> </div><br></p><p>分段的做法是把每个表分成段，一个段构成一个独立的地址空间。每个段的长度可以不同，并且可以动态增长。</p><p>每个段都需要程序员来划分。</p><h3 id="3-段页式"><a href="#3-段页式" class="headerlink" title="3. 段页式"></a>3. 段页式</h3><p>用分段方法来分配和管理虚拟存储器。程序的地址空间按逻辑单位分成基本独立的段，而每一段有自己的段名，再把每段分成固定大小的若干页。</p><p>用分页方法来分配和管理实存。即把整个主存分成与上述页大小相等的存储块，可装入作业的任何一页。</p><p>程序对内存的调入或调出是按页进行的，但它又可按段实现共享和保护。</p><h3 id="4-分页与分段区别"><a href="#4-分页与分段区别" class="headerlink" title="4. 分页与分段区别"></a>4. 分页与分段区别</h3><ul><li><p>对程序员的透明性：分页透明，但是分段需要程序员显示划分每个段。</p></li><li><p>地址空间的维度：分页是一维地址空间，分段是二维的。</p></li><li><p>大小是否可以改变：页的大小不可变，段的大小可以动态改变。</p></li><li><p>出现的原因：分页主要用于实现虚拟内存，从而获得更大的地址空间；分段主要是为了使程序和数据可以被划分为逻辑上独立的地址空间并且有助于共享和保护。</p></li></ul><h2 id="页面置换算法"><a href="#页面置换算法" class="headerlink" title="页面置换算法"></a>页面置换算法</h2><p>在程序运行过程中，若其所要访问的页面不在内存而需要把它们调入内存，但是内存已无空闲空间时，系统必须从内存中调出一个页面到磁盘对换区中，并且将程序所需要的页面调入内存中。页面置换算法的主要目标是使页面置换频率最低（也可以说缺页率最低）。</p><h3 id="1-最佳（Optimal）"><a href="#1-最佳（Optimal）" class="headerlink" title="1. 最佳（Optimal）"></a>1. 最佳（Optimal）</h3><p>所选择的被换出的页面将是最长时间内不再被访问，通常可以保证获得最低的缺页率。</p><p>是一种理论上的算法，因为无法知道一个页面多长时间会被再访问到。</p><p>举例：一个系统为某进程分配了三个物理块，并有如下页面引用序列：</p><p>7，0，1，2，0，3，0，4，2，3，0，3，2，1，2，0，1，7，0，1</p><p>进程运行时，先将 7,0,1 三个页面装入内存。当进程要访问页面 2 时，产生缺页中断，会将页面 7 换出，因为页面 7 再次被访问的时间最长。</p><h3 id="2-先进先出（FIFO）"><a href="#2-先进先出（FIFO）" class="headerlink" title="2. 先进先出（FIFO）"></a>2. 先进先出（FIFO）</h3><p>所选择换出的页面是最先进入的页面。</p><p>该算法会将那些经常被访问的页面也被换出，从而使缺页率升高。</p><h3 id="3-最近最久未使用（LRU-Least-Recently-Used）"><a href="#3-最近最久未使用（LRU-Least-Recently-Used）" class="headerlink" title="3. 最近最久未使用（LRU, Least Recently Used）"></a>3. 最近最久未使用（LRU, Least Recently Used）</h3><p>虽然无法知道将来要使用的页面情况，但是可以知道过去使用页面的情况。LRU 将最近最久未使用的页面换出。</p><p>可以用栈来实现该算法，栈中存储页面的页面号。当进程访问一个页面时，将该页面的页面号从栈移除，并将它压入栈顶。这样，最近被访问的页面的页面号总是在栈顶，而最近最久未使用的页面的页面号总是在栈底。</p><p>4，7，0，7，1，0，1，2，1，2，6</p><p><br><div align="center"> <img src="../pics/eb859228-c0f2-4bce-910d-d9f76929352b.png"> </div><br></p><h3 id="4-时钟（Clock）"><a href="#4-时钟（Clock）" class="headerlink" title="4. 时钟（Clock）"></a>4. 时钟（Clock）</h3><p>Clock 页面置换算法需要用到一个访问位，当一个页面被访问时，将访问为置为 1。</p><p>首先，将内存中的所有页面链接成一个循环队列，当缺页中断发生时，检查当前指针所指向页面的访问位，如果访问位为 0，就将该页面换出；否则将该页的访问位设置为 0，给该页面第二次的机会，移动指针继续检查。</p><h1 id="第五章-设备管理"><a href="#第五章-设备管理" class="headerlink" title="第五章 设备管理"></a>第五章 设备管理</h1><h2 id="磁盘调度算法"><a href="#磁盘调度算法" class="headerlink" title="磁盘调度算法"></a>磁盘调度算法</h2><p>当多个进程同时请求访问磁盘时，需要进行磁盘调度来控制对磁盘的访问。磁盘调度的主要目标是使磁盘的平均寻道时间最少。</p><h3 id="1-先来先服务（FCFS-First-Come-First-Serverd）"><a href="#1-先来先服务（FCFS-First-Come-First-Serverd）" class="headerlink" title="1. 先来先服务（FCFS, First Come First Serverd）"></a>1. 先来先服务（FCFS, First Come First Serverd）</h3><p>根据进程请求访问磁盘的先后次序来进行调度。优点是公平和简单，缺点也很明显，因为未对寻道做任何优化，使平均寻道时间可能较长。</p><h3 id="2-最短寻道时间优先（SSTF-Shortest-Seek-Time-First）"><a href="#2-最短寻道时间优先（SSTF-Shortest-Seek-Time-First）" class="headerlink" title="2. 最短寻道时间优先（SSTF, Shortest Seek Time First）"></a>2. 最短寻道时间优先（SSTF, Shortest Seek Time First）</h3><p>要求访问的磁道与当前磁头所在磁道距离最近的优先进行调度。这种算法并不能保证平均寻道时间最短，但是比 FCFS 好很多。</p><h3 id="3-扫描算法（SCAN）"><a href="#3-扫描算法（SCAN）" class="headerlink" title="3. 扫描算法（SCAN）"></a>3. 扫描算法（SCAN）</h3><p>SSTF 会出现进行饥饿现象。考虑以下情况，新进程请求访问的磁道与磁头所在磁道的距离总是比一个在等待的进程来的近，那么等待的进程会一直等待下去。</p><p>SCAN 算法在 SSTF 算法之上考虑了磁头的移动方向，要求所请求访问的磁道在磁头当前移动方向上才能够得到调度。因为考虑了移动方向，那么一个进程请求访问的磁道一定会得到调度。</p><p>当一个磁头自里向外移动时，移到最外侧会改变移动方向为自外向里，这种移动的规律类似于电梯的运行，因此又常称 SCAN 算法为电梯调度算法。</p><h3 id="4-循环扫描算法（CSCAN）"><a href="#4-循环扫描算法（CSCAN）" class="headerlink" title="4. 循环扫描算法（CSCAN）"></a>4. 循环扫描算法（CSCAN）</h3><p>CSCAN 对 SCAN 进行了改动，要求磁头始终沿着一个方向移动。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>Tanenbaum A S, Bos H. Modern operating systems[M]. Prentice Hall Press, 2014.</li><li>汤子瀛, 哲凤屏, 汤小丹. 计算机操作系统[M]. 西安电子科技大学出版社, 2001.</li><li>Bryant, R. E., &amp; O’Hallaron, D. R. (2004). 深入理解计算机系统.</li><li><a href="http://blog.csdn.net/yufaw/article/details/7409596" target="_blank" rel="noopener">进程间的几种通信方式</a></li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#第一章-概述&quot;&gt;第一章 概述&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#操作系统基本特征&quot;&gt;操作系统基本特征&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-并发&quot;&gt;1. 并发&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-共享&quot;&gt;2. 共享&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-虚拟&quot;&gt;3. 虚拟&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-异步&quot;&gt;4. 异步&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#系统调用&quot;&gt;系统调用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#中断分类&quot;&gt;中断分类&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-外中断&quot;&gt;1. 外中断&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-异常&quot;&gt;2. 异常&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-陷入&quot;&gt;3. 陷入&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#大内核和微内核&quot;&gt;大内核和微内核&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-大内核&quot;&gt;1. 大内核&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-微内核&quot;&gt;2. 微内核&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第二章-进程管理&quot;&gt;第二章 进程管理&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#进程与线程&quot;&gt;进程与线程&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-进程&quot;&gt;1. 进程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-线程&quot;&gt;2. 线程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-区别&quot;&gt;3. 区别&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#进程状态的切换&quot;&gt;进程状态的切换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#调度算法&quot;&gt;调度算法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-批处理系统中的调度&quot;&gt;1. 批处理系统中的调度&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#11-先来先服务&quot;&gt;1.1 先来先服务&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-短作业优先&quot;&gt;1.2 短作业优先&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-最短剩余时间优先&quot;&gt;1.3 最短剩余时间优先&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-交互式系统中的调度&quot;&gt;2. 交互式系统中的调度&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#21-优先权优先&quot;&gt;2.1 优先权优先&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-时间片轮转&quot;&gt;2.2 时间片轮转&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-多级反馈队列&quot;&gt;2.3 多级反馈队列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#24-短进程优先&quot;&gt;2.4 短进程优先&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-实时系统中的调度&quot;&gt;3. 实时系统中的调度&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#进程同步&quot;&gt;进程同步&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-临界区&quot;&gt;1. 临界区&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-同步与互斥&quot;&gt;2. 同步与互斥&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-信号量&quot;&gt;3. 信号量&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-管程&quot;&gt;4. 管程&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#进程通信&quot;&gt;进程通信&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-管道&quot;&gt;1. 管道&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-信号量&quot;&gt;2. 信号量&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-消息队列&quot;&gt;3. 消息队列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-信号&quot;&gt;4. 信号&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-共享内存&quot;&gt;5. 共享内存&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-套接字&quot;&gt;6. 套接字&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#经典同步问题&quot;&gt;经典同步问题&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-读者-写者问题&quot;&gt;1. 读者-写者问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-哲学家进餐问题&quot;&gt;2. 哲学家进餐问题&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第三章-死锁&quot;&gt;第三章 死锁&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#死锁的条件&quot;&gt;死锁的条件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#死锁的处理方法&quot;&gt;死锁的处理方法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-鸵鸟策略&quot;&gt;1. 鸵鸟策略&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-死锁预防&quot;&gt;2. 死锁预防&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#21-破坏互斥条件&quot;&gt;2.1 破坏互斥条件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-破坏请求与保持条件&quot;&gt;2.2 破坏请求与保持条件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-破坏不可抢占条件&quot;&gt;2.3 破坏不可抢占条件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#24-破坏环路等待&quot;&gt;2.4 破坏环路等待&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-死锁避免&quot;&gt;3. 死锁避免&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#31-安全状态&quot;&gt;3.1 安全状态&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32-单个资源的银行家算法&quot;&gt;3.2 单个资源的银行家算法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#33-多个资源的银行家算法&quot;&gt;3.3 多个资源的银行家算法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-死锁检测与死锁恢复&quot;&gt;4. 死锁检测与死锁恢复&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#41-死锁检测算法&quot;&gt;4.1 死锁检测算法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-死锁恢复&quot;&gt;4.2 死锁恢复&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第四章-存储器管理&quot;&gt;第四章 存储器管理&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#虚拟内存&quot;&gt;虚拟内存&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分页与分段&quot;&gt;分页与分段&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-分页&quot;&gt;1. 分页&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-分段&quot;&gt;2. 分段&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-段页式&quot;&gt;3. 段页式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-分页与分段区别&quot;&gt;4. 分页与分段区别&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#页面置换算法&quot;&gt;页面置换算法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-最佳optimal&quot;&gt;1. 最佳（Optimal）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-先进先出fifo&quot;&gt;2. 先进先出（FIFO）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-最近最久未使用lru,-least-recently-used&quot;&gt;3. 最近最久未使用（LRU, Least Recently Used）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-时钟clock&quot;&gt;4. 时钟（Clock）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第五章-设备管理&quot;&gt;第五章 设备管理&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#磁盘调度算法&quot;&gt;磁盘调度算法&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-先来先服务fcfs,-first-come-first-serverd&quot;&gt;1. 先来先服务（FCFS, First Come First Serverd）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-最短寻道时间优先sstf,-shortest-seek-time-first&quot;&gt;2. 最短寻道时间优先（SSTF, Shortest Seek Time First）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-扫描算法scan&quot;&gt;3. 扫描算法（SCAN）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-循环扫描算法cscan&quot;&gt;4. 循环扫描算法（CSCAN）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;第一章-概述&quot;&gt;&lt;a href=&quot;#第一章-概述&quot; class=&quot;headerlink&quot; title=&quot;第一章 概述&quot;&gt;&lt;/a&gt;第一章 概述&lt;/h1&gt;&lt;h2 id=&quot;操作系统基本特征&quot;&gt;&lt;a href=&quot;#操作系统基本特征&quot; class=&quot;headerlink&quot; title=&quot;操作系统基本特征&quot;&gt;&lt;/a&gt;操作系统基本特征&lt;/h2&gt;&lt;h3 id=&quot;1-并发&quot;&gt;&lt;a href=&quot;#1-并发&quot; class=&quot;headerlink&quot; title=&quot;1. 并发&quot;&gt;&lt;/a&gt;1. 并发&lt;/h3&gt;&lt;p&gt;并发性是指宏观上在一段时间内能同时运行多个程序，而并行性则指同一时刻能运行多个指令。&lt;/p&gt;
&lt;p&gt;并行需要硬件支持，如多流水线或者多处理器。&lt;/p&gt;
&lt;p&gt;操作系统通过引入进程和线程，使得程序能够并发运行。&lt;/p&gt;
&lt;h3 id=&quot;2-共享&quot;&gt;&lt;a href=&quot;#2-共享&quot; class=&quot;headerlink&quot; title=&quot;2. 共享&quot;&gt;&lt;/a&gt;2. 共享&lt;/h3&gt;&lt;p&gt;共享是指系统中的资源可以供多个并发进程共同使用。&lt;/p&gt;
&lt;p&gt;有两种共享方式：互斥共享和同时共享。&lt;/p&gt;
&lt;p&gt;互斥共享的资源称为临界资源，例如打印机等，在同一时间只允许一个进程访问，否则会出现错误，需要用同步机制来实现对临界资源的访问。&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>Java IO</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/Java%20IO.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/Java IO.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:32:46.730Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#概览">概览</a></li><li><a href="#磁盘操作">磁盘操作</a></li><li><a href="#字节操作">字节操作</a></li><li><a href="#字符操作">字符操作</a></li><li><a href="#对象操作">对象操作</a></li><li><a href="#网络操作">网络操作</a><ul><li><a href="#1-inetaddress">1. InetAddress</a></li><li><a href="#2-url">2. URL</a></li><li><a href="#3-sockets">3. Sockets</a></li><li><a href="#4-datagram">4. Datagram</a></li></ul></li><li><a href="#nio">NIO</a><ul><li><a href="#1-流与块">1. 流与块</a></li><li><a href="#2-通道与缓冲区">2. 通道与缓冲区</a><ul><li><a href="#21-通道">2.1 通道</a></li><li><a href="#22-缓冲区">2.2 缓冲区</a></li></ul></li><li><a href="#3-缓冲区状态变量">3. 缓冲区状态变量</a></li><li><a href="#4-读写文件实例">4. 读写文件实例</a></li><li><a href="#5-阻塞与非阻塞">5. 阻塞与非阻塞</a><ul><li><a href="#51-阻塞式-io">5.1 阻塞式 I/O</a></li><li><a href="#52-非阻塞式-io">5.2 非阻塞式 I/O</a></li></ul></li><li><a href="#6-套接字实例">6. 套接字实例</a><ul><li><a href="#61-serversocketchannel">6.1 ServerSocketChannel</a></li><li><a href="#62-selectors">6.2 Selectors</a></li><li><a href="#63-主循环">6.3 主循环</a></li><li><a href="#64-监听新连接">6.4 监听新连接</a></li><li><a href="#65-接受新的连接">6.5 接受新的连接</a></li><li><a href="#66-删除处理过的-selectionkey">6.6 删除处理过的 SelectionKey</a></li><li><a href="#67-传入的-io">6.7 传入的 I/O</a></li></ul></li></ul></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h1><p>Java 的 I/O 大概可以分成以下几类</p><ol><li>磁盘操作：File</li><li>字节操作：InputStream 和 OutputStream</li><li>字符操作：Reader 和 Writer</li><li>对象操作：Serializable</li><li>网络操作：Socket</li><li>非阻塞式 IO：NIO</li></ol><h1 id="磁盘操作"><a href="#磁盘操作" class="headerlink" title="磁盘操作"></a>磁盘操作</h1><p>File 类可以用于表示文件和目录，但是它只用于表示文件的信息，而不表示文件的内容。</p><a id="more"></a><h1 id="字节操作"><a href="#字节操作" class="headerlink" title="字节操作"></a>字节操作</h1><p><br><div align="center"> <img src="../pics/8143787f-12eb-46ea-9bc3-c66d22d35285.jpg"> </div><br></p><p>Java I/O 使用了装饰者模式来实现。以 InputStream 为例，InputStream 是抽象组件，FileInputStream 是 InputStream 的子类，属于具体组件，提供了字节流的输入操作。FilterInputStream 属于抽象装饰者，装饰者用于装饰组件，为组件提供额外的功能，例如 BufferedInputStream 为 FileInputStream 提供缓存的功能。实例化一个具有缓存功能的字节流对象时，只需要在 FileInputStream 对象上再套一层 BufferedInputStream 对象即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br></pre></td></tr></table></figure><p>DataInputStream 装饰者提供了对更多数据类型进行输入的操作，比如 int、double 等基本类型。</p><p>批量读入文件中的内容到字节数组中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">20</span>*<span class="number">1024</span>];</span><br><span class="line"><span class="keyword">int</span> bytes = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 最多读取 buf.length 个字节，返回的是实际读取的个数，返回 -1 的时候表示读到 eof，即文件尾</span></span><br><span class="line"><span class="keyword">while</span>((bytes = in.read(buf, <span class="number">0</span> , buf.length)) != -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="字符操作"><a href="#字符操作" class="headerlink" title="字符操作"></a>字符操作</h1><p>不管是磁盘还是网络传输，最小的存储单元都是字节，而不是字符，所以 I/O 操作的都是字节而不是字符。但是在程序中操作的数据通常是字符形式，因此需要提供对字符进行操作的方法。</p><p>InputStreamReader 实现从文本文件的字节流解码成字符流；OutputStreamWriter 实现字符流编码成为文本文件的字节流。它们都继承自 Reader 和 Writer。</p><p>编码就是把字符转换为字节，而解码是把字节重新组合成字符。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] bytes = str.getBytes(encoding);     <span class="comment">// 编码</span></span><br><span class="line">String str = <span class="keyword">new</span> String(bytes, encoding)； <span class="comment">// 解码</span></span><br></pre></td></tr></table></figure><p>GBK 编码中，中文占 2 个字节，英文占 1 个字节；UTF-8 编码中，中文占 3 个字节，英文占 1 个字节；Java 使用双字节编码 UTF-16be，中文和英文都占 2 个字节。</p><p>如果编码和解码过程使用不同的编码方式那么就出现了乱码。</p><h1 id="对象操作"><a href="#对象操作" class="headerlink" title="对象操作"></a>对象操作</h1><p>序列化就是将一个对象转换成字节序列，方便存储和传输。</p><p>序列化：ObjectOutputStream.writeObject()</p><p>反序列化：ObjectInputStream.readObject()</p><p>序列化的类需要实现 Serializable 接口，它只是一个标准，没有任何方法需要实现。</p><p>transient 关键字可以使一些属性不会被序列化。</p><p><strong>ArrayList 序列化和反序列化的实现</strong> ：ArrayList 中存储数据的数组是用 transient 修饰的，因为这个数组是动态扩展的，并不是所有的空间都被使用，因此就不需要所有的内容都被序列化。通过重写序列化和反序列化方法，使得可以只序列化数组中有内容的那部分数据。</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">Object</span>[] elementData;</span><br></pre></td></tr></table></figure><h1 id="网络操作"><a href="#网络操作" class="headerlink" title="网络操作"></a>网络操作</h1><p>Java 中的网络支持：</p><ol><li>InetAddress：用于表示网络上的硬件资源，即 IP 地址；</li><li>URL：统一资源定位符，通过 URL 可以直接读取或者写入网络上的数据；</li><li>Sockets：使用 TCP 协议实现网络通信；</li><li>Datagram：使用 UDP 协议实现网络通信。</li></ol><h2 id="1-InetAddress"><a href="#1-InetAddress" class="headerlink" title="1. InetAddress"></a>1. InetAddress</h2><p>没有公有构造函数，只能通过静态方法来创建实例，比如 InetAddress.getByName(String host)、InetAddress.getByAddress(byte[] addr)。</p><h2 id="2-URL"><a href="#2-URL" class="headerlink" title="2. URL"></a>2. URL</h2><p>可以直接从 URL 中读取字节流数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">URL url = <span class="keyword">new</span> URL(<span class="string">"http://www.baidu.com"</span>);</span><br><span class="line">InputStream is = url.openStream(); <span class="comment">// 字节流</span></span><br><span class="line">InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(is, <span class="string">"utf-8"</span>);                              <span class="comment">// 字符流</span></span><br><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(isr);</span><br><span class="line">String line = br.readLine();</span><br><span class="line"><span class="keyword">while</span> (line != <span class="keyword">null</span>) &#123;</span><br><span class="line">    System.out.println(line);</span><br><span class="line">    line = br.readLine();</span><br><span class="line">&#125;</span><br><span class="line">br.close();</span><br><span class="line">isr.close();</span><br><span class="line">is.close();</span><br></pre></td></tr></table></figure><h2 id="3-Sockets"><a href="#3-Sockets" class="headerlink" title="3. Sockets"></a>3. Sockets</h2><p>Socket 通信模型</p><p><br><div align="center"> <img src="../pics/fa4101d7-19ce-4a69-a84f-20bbe64320e5.jpg"> </div><br></p><ul><li>ServerSocket：服务器端类</li><li>Socket：客户端类</li></ul><p>服务器和客户端通过 InputStream 和 OutputStream 进行输入输出。</p><h2 id="4-Datagram"><a href="#4-Datagram" class="headerlink" title="4. Datagram"></a>4. Datagram</h2><ul><li>DatagramPacket：数据包类</li><li>DatagramSocket：通信类</li></ul><h1 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h1><p>NIO 将最耗时的 I/O 操作 ( 即填充和提取缓冲区 ) 转移回操作系统，因而 不需要程序员去控制就可以极大地提高运行速度。</p><h2 id="1-流与块"><a href="#1-流与块" class="headerlink" title="1. 流与块"></a>1. 流与块</h2><p>I/O 与 NIO 最重要的区别是数据打包和传输的方式。正如前面提到的，I/O 以流的方式处理数据，而 NIO 以块的方式处理数据。</p><p>面向流的 I/O 一次一个字节进行处理数据，一个输入流产生一个字节的数据，一个输出流消费一个字节的数据。为流式数据创建过滤器非常容易，链接几个过滤器，以便每个过滤器只负责单个复杂处理机制的一部分，这样也是相对简单的。不利的一面是，面向流的 I/O 通常相当慢。</p><p>一个面向块的 I/O 系统以块的形式处理数据，每一个操作都在一步中产生或者消费一个数据块。按块处理数据比按流处理数据要快得多。但是面向块的 I/O 缺少一些面向流的 I/O 所具有的优雅性和简单性。</p><p>I/O 包和 NIO 已经很好地集成了，java.io.* 已经以 NIO 为基础重新实现了，所以现在它可以利用 NIO 的一些特性。例如， java.io.* 包中的一些类包含以块的形式读写数据的方法，这使得即使在更面向流的系统中，处理速度也会更快。</p><h2 id="2-通道与缓冲区"><a href="#2-通道与缓冲区" class="headerlink" title="2. 通道与缓冲区"></a>2. 通道与缓冲区</h2><h3 id="2-1-通道"><a href="#2-1-通道" class="headerlink" title="2.1 通道"></a>2.1 通道</h3><p>通道 Channel 是对原 I/O 包中的流的模拟，可以通过它读取和写入数据。</p><p>通道与流的不同之处在于，流只能在一个方向上移动，(一个流必须是 InputStream 或者 OutputStream 的子类)， 而通道是双向的，可以用于读、写或者同时用于读写。</p><p>通道包括以下类型：</p><ul><li>FileChannel：从文件中读写数据；</li><li>DatagramChannel：通过 UDP 读写网络中数据；</li><li>SocketChannel：通过 TCP 读写网络中数据；</li><li>ServerSocketChannel：可以监听新进来的 TCP 连接，对每一个新进来的连接都会创建一个 SocketChannel。</li></ul><h3 id="2-2-缓冲区"><a href="#2-2-缓冲区" class="headerlink" title="2.2 缓冲区"></a>2.2 缓冲区</h3><p>发送给一个通道的所有对象都必须首先放到缓冲区中；同样地，从通道中读取的任何数据都要读到缓冲区中。也就是说，不会直接对通道进行读写数据，而是先经过缓冲区。</p><p>缓冲区实质上是一个数组，但它不仅仅是一个数组。缓冲区提供了对数据的结构化访问，而且还可以跟踪系统的读/写进程。</p><p>缓冲区包括以下类型：</p><ul><li>ByteBuffer</li><li>CharBuffer</li><li>ShortBuffer</li><li>IntBuffer</li><li>LongBuffer</li><li>FloatBuffer</li><li>DoubleBuffer</li></ul><h2 id="3-缓冲区状态变量"><a href="#3-缓冲区状态变量" class="headerlink" title="3. 缓冲区状态变量"></a>3. 缓冲区状态变量</h2><ul><li>capacity：最大容量；</li><li>position：当前已经读写的字节数；</li><li>limit：还可以读写的字节数。</li></ul><p>状态变量的改变过程：</p><p>1. 新建一个大小为 8 个字节的缓冲区，此时 position 为 0，而 limit == capacity == 9。capacity 变量不会改变，下面的讨论会忽略它。</p><p><br><div align="center"> <img src="../pics/1bea398f-17a7-4f67-a90b-9e2d243eaa9a.png"> </div><br></p><p>2. 从输入通道中读取 3 个字节数据写入缓冲区中，此时 position 移动设为 3，limit 保持不变。</p><p><br><div align="center"> <img src="../pics/4628274c-25b6-4053-97cf-d1239b44c43d.png"> </div><br></p><p>3. 在将缓冲区的数据写到输出通道之前，需要先调用 flip() 方法，这个方法将 limit 设置为当前 position，并将 position 设置为 0。</p><p><br><div align="center"> <img src="../pics/952e06bd-5a65-4cab-82e4-dd1536462f38.png"> </div><br></p><p>4. 从缓冲区中取 4 个字节到输出缓冲中，此时 position 设为 4。</p><p><br><div align="center"> <img src="../pics/b5bdcbe2-b958-4aef-9151-6ad963cb28b4.png"> </div><br></p><p>5. 最后需要调用 clear() 方法来清空缓冲区，此时 position 和 limit 都被设置为最初位置。</p><p><br><div align="center"> <img src="../pics/67bf5487-c45d-49b6-b9c0-a058d8c68902.png"> </div><br></p><h2 id="4-读写文件实例"><a href="#4-读写文件实例" class="headerlink" title="4. 读写文件实例"></a>4. 读写文件实例</h2><p>1. 为要读取的文件创建 FileInputStream，之后通过 FileInputStream 获取输入 FileChannel；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fin = <span class="keyword">new</span> FileInputStream(<span class="string">"readandshow.txt"</span>);</span><br><span class="line">FileChannel fic = fin.getChannel();</span><br></pre></td></tr></table></figure><p>2. 创建一个容量为 1024 的 Buffer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br></pre></td></tr></table></figure><p>3. 将数据从输入 FileChannel 写入到 Buffer 中，如果没有数据的话， read() 方法会返回 -1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> r = fcin.read(buffer);</span><br><span class="line"><span class="keyword">if</span> (r == -<span class="number">1</span>) &#123;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4. 为要写入的文件创建 FileOutputStream，之后通过 FileOutputStream 获取输出 FileChannel</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(<span class="string">"writesomebytes.txt"</span>);</span><br><span class="line">FileChannel foc = fout.getChannel();</span><br></pre></td></tr></table></figure><p>5. 调用 flip() 切换读写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer.flip();</span><br></pre></td></tr></table></figure><p>6. 把 Buffer 中的数据读取到输出 FileChannel 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foc.write(buffer);</span><br></pre></td></tr></table></figure><p>7. 最后调用 clear() 重置缓冲区</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer.clear();</span><br></pre></td></tr></table></figure><h2 id="5-阻塞与非阻塞"><a href="#5-阻塞与非阻塞" class="headerlink" title="5. 阻塞与非阻塞"></a>5. 阻塞与非阻塞</h2><p>应当注意，FileChannel 不能切换到非阻塞模式，套接字 Channel 可以。</p><h3 id="5-1-阻塞式-I-O"><a href="#5-1-阻塞式-I-O" class="headerlink" title="5.1 阻塞式 I/O"></a>5.1 阻塞式 I/O</h3><p>阻塞式 I/O 在调用 InputStream.read() 方法时会一直等到数据到来时（或超时）才会返回，在调用 ServerSocket.accept() 方法时，也会一直阻塞到有客户端连接才会返回，每个客户端连接过来后，服务端都会启动一个线程去处理该客户端的请求。</p><p><br><div align="center"> <img src="../pics/edc23f99-c46c-4200-b64e-07516828720d.jpg"> </div><br></p><h3 id="5-2-非阻塞式-I-O"><a href="#5-2-非阻塞式-I-O" class="headerlink" title="5.2 非阻塞式 I/O"></a>5.2 非阻塞式 I/O</h3><p>由一个专门的线程来处理所有的 I/O 事件，并负责分发。</p><p>事件驱动机制：事件到的时候触发，而不是同步的去监视事件。</p><p>线程通信：线程之间通过 wait()、notify() 等方式通信，保证每次上下文切换都是有意义的，减少无谓的线程切换。</p><p><br><div align="center"> <img src="../pics/7fcb2fb0-2cd9-4396-bc2d-282becf963c3.jpg"> </div><br></p><h2 id="6-套接字实例"><a href="#6-套接字实例" class="headerlink" title="6. 套接字实例"></a>6. 套接字实例</h2><h3 id="6-1-ServerSocketChannel"><a href="#6-1-ServerSocketChannel" class="headerlink" title="6.1 ServerSocketChannel"></a>6.1 ServerSocketChannel</h3><p>每一个端口都需要有一个 ServerSocketChannel 用来监听连接。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ServerSocketChannel ssc = ServerSocketChannel.open();</span><br><span class="line">ssc.configureBlocking(<span class="keyword">false</span>); <span class="comment">// 设置为非阻塞</span></span><br><span class="line"></span><br><span class="line">ServerSocket ss = ssc.socket();</span><br><span class="line">InetSocketAddress address = <span class="keyword">new</span> InetSocketAddress(ports[i]);</span><br><span class="line">ss.bind(address); <span class="comment">// 绑定端口号</span></span><br></pre></td></tr></table></figure><h3 id="6-2-Selectors"><a href="#6-2-Selectors" class="headerlink" title="6.2 Selectors"></a>6.2 Selectors</h3><p>异步 I/O 通过 Selector 注册对特定 I/O 事件的兴趣 ― 可读的数据的到达、新的套接字连接等等，在发生这样的事件时，系统将会发送通知。</p><p>创建 Selectors 之后，就可以对不同的通道对象调用 register() 方法。register() 的第一个参数总是这个 Selector。第二个参数是 OP_ACCEPT，这里它指定我们想要监听 accept 事件，也就是在新的连接建立时所发生的事件。</p><p>SelectionKey 代表这个通道在此 Selector 上的这个注册。当某个 Selector 通知您某个传入事件时，它是通过提供对应于该事件的 SelectionKey 来进行的。SelectionKey 还可以用于取消通道的注册。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Selector selector = Selector.open();</span><br><span class="line">SelectionKey key = ssc.register(selector, SelectionKey.OP_ACCEPT);</span><br></pre></td></tr></table></figure><h3 id="6-3-主循环"><a href="#6-3-主循环" class="headerlink" title="6.3 主循环"></a>6.3 主循环</h3><p>首先，我们调用 Selector 的 select() 方法。这个方法会阻塞，直到至少有一个已注册的事件发生。当一个或者更多的事件发生时， select() 方法将返回所发生的事件的数量。</p><p>接下来，我们调用 Selector 的 selectedKeys() 方法，它返回发生了事件的 SelectionKey 对象的一个 集合 。</p><p>我们通过迭代 SelectionKeys 并依次处理每个 SelectionKey 来处理事件。对于每一个 SelectionKey，您必须确定发生的是什么 I/O 事件，以及这个事件影响哪些 I/O 对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> num = selector.select();</span><br><span class="line"> </span><br><span class="line">Set selectedKeys = selector.selectedKeys();</span><br><span class="line">Iterator it = selectedKeys.iterator();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">     SelectionKey key = (SelectionKey)it.next();</span><br><span class="line">     <span class="comment">// ... deal with I/O event ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-监听新连接"><a href="#6-4-监听新连接" class="headerlink" title="6.4 监听新连接"></a>6.4 监听新连接</h3><p>程序执行到这里，我们仅注册了 ServerSocketChannel，并且仅注册它们“接收”事件。为确认这一点，我们对 SelectionKey 调用 readyOps() 方法，并检查发生了什么类型的事件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((key.readyOps() &amp; SelectionKey.OP_ACCEPT)</span><br><span class="line">     == SelectionKey.OP_ACCEPT) &#123;</span><br><span class="line">     <span class="comment">// Accept the new connection</span></span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以肯定地说， readOps() 方法告诉我们该事件是新的连接。</p><h3 id="6-5-接受新的连接"><a href="#6-5-接受新的连接" class="headerlink" title="6.5 接受新的连接"></a>6.5 接受新的连接</h3><p>因为我们知道这个服务器套接字上有一个传入连接在等待，所以可以安全地接受它；也就是说，不用担心 accept() 操作会阻塞：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ServerSocketChannel ssc = (ServerSocketChannel)key.channel();</span><br><span class="line">SocketChannel sc = ssc.accept();</span><br></pre></td></tr></table></figure><p>下一步是将新连接的 SocketChannel 配置为非阻塞的。而且由于接受这个连接的目的是为了读取来自套接字的数据，所以我们还必须将 SocketChannel 注册到 Selector上，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc.configureBlocking( <span class="keyword">false</span> );</span><br><span class="line">SelectionKey newKey = sc.register( selector, SelectionKey.OP_READ );</span><br></pre></td></tr></table></figure><p>注意我们使用 register() 的 OP_READ 参数，将 SocketChannel 注册用于 读取 而不是 接受 新连接。</p><h3 id="6-6-删除处理过的-SelectionKey"><a href="#6-6-删除处理过的-SelectionKey" class="headerlink" title="6.6 删除处理过的 SelectionKey"></a>6.6 删除处理过的 SelectionKey</h3><p>在处理 SelectionKey 之后，我们几乎可以返回主循环了。但是我们必须首先将处理过的 SelectionKey 从选定的键集合中删除。如果我们没有删除处理过的键，那么它仍然会在主集合中以一个激活的键出现，这会导致我们尝试再次处理它。我们调用迭代器的 remove() 方法来删除处理过的 SelectionKey：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">it.remove();</span><br></pre></td></tr></table></figure><p>现在我们可以返回主循环并接受从一个套接字中传入的数据(或者一个传入的 I/O 事件)了。</p><h3 id="6-7-传入的-I-O"><a href="#6-7-传入的-I-O" class="headerlink" title="6.7 传入的 I/O"></a>6.7 传入的 I/O</h3><p>当来自一个套接字的数据到达时，它会触发一个 I/O 事件。这会导致在主循环中调用 Selector.select()，并返回一个或者多个 I/O 事件。这一次， SelectionKey 将被标记为 OP_READ 事件，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((key.readyOps() &amp; SelectionKey.OP_READ)</span><br><span class="line">     == SelectionKey.OP_READ) &#123;</span><br><span class="line">     <span class="comment">// Read the data</span></span><br><span class="line">     SocketChannel sc = (SocketChannel)key.channel();</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>Eckel B, 埃克尔 , 昊鹏 , 等 . Java 编程思想 [M]. 机械工业出版社 , 2002.</li><li><a href="https://www.ibm.com/developerworks/cn/education/java/j-nio/j-nio.html" target="_blank" rel="noopener">IBM: NIO 入门</a></li><li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-javaio/index.html" target="_blank" rel="noopener"> 深入分析 Java I/O 的工作机制 </a></li><li><a href="http://blog.csdn.net/shimiso/article/details/24990499" target="_blank" rel="noopener">NIO 与传统 IO 的区别 </a></li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#概览&quot;&gt;概览&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#磁盘操作&quot;&gt;磁盘操作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#字节操作&quot;&gt;字节操作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#字符操作&quot;&gt;字符操作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#对象操作&quot;&gt;对象操作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#网络操作&quot;&gt;网络操作&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-inetaddress&quot;&gt;1. InetAddress&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-url&quot;&gt;2. URL&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-sockets&quot;&gt;3. Sockets&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-datagram&quot;&gt;4. Datagram&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#nio&quot;&gt;NIO&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-流与块&quot;&gt;1. 流与块&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-通道与缓冲区&quot;&gt;2. 通道与缓冲区&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#21-通道&quot;&gt;2.1 通道&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-缓冲区&quot;&gt;2.2 缓冲区&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-缓冲区状态变量&quot;&gt;3. 缓冲区状态变量&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-读写文件实例&quot;&gt;4. 读写文件实例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-阻塞与非阻塞&quot;&gt;5. 阻塞与非阻塞&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#51-阻塞式-io&quot;&gt;5.1 阻塞式 I/O&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#52-非阻塞式-io&quot;&gt;5.2 非阻塞式 I/O&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-套接字实例&quot;&gt;6. 套接字实例&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#61-serversocketchannel&quot;&gt;6.1 ServerSocketChannel&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#62-selectors&quot;&gt;6.2 Selectors&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#63-主循环&quot;&gt;6.3 主循环&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#64-监听新连接&quot;&gt;6.4 监听新连接&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#65-接受新的连接&quot;&gt;6.5 接受新的连接&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#66-删除处理过的-selectionkey&quot;&gt;6.6 删除处理过的 SelectionKey&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#67-传入的-io&quot;&gt;6.7 传入的 I/O&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;概览&quot;&gt;&lt;a href=&quot;#概览&quot; class=&quot;headerlink&quot; title=&quot;概览&quot;&gt;&lt;/a&gt;概览&lt;/h1&gt;&lt;p&gt;Java 的 I/O 大概可以分成以下几类&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;磁盘操作：File&lt;/li&gt;
&lt;li&gt;字节操作：InputStream 和 OutputStream&lt;/li&gt;
&lt;li&gt;字符操作：Reader 和 Writer&lt;/li&gt;
&lt;li&gt;对象操作：Serializable&lt;/li&gt;
&lt;li&gt;网络操作：Socket&lt;/li&gt;
&lt;li&gt;非阻塞式 IO：NIO&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;磁盘操作&quot;&gt;&lt;a href=&quot;#磁盘操作&quot; class=&quot;headerlink&quot; title=&quot;磁盘操作&quot;&gt;&lt;/a&gt;磁盘操作&lt;/h1&gt;&lt;p&gt;File 类可以用于表示文件和目录，但是它只用于表示文件的信息，而不表示文件的内容。&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>Leetcode 题解</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/Leetcode%20%E9%A2%98%E8%A7%A3.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/Leetcode 题解.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:33:39.631Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#算法思想">算法思想</a><ul><li><a href="#二分查找">二分查找</a></li><li><a href="#贪心思想">贪心思想</a></li><li><a href="#双指针">双指针</a></li><li><a href="#排序">排序</a><ul><li><a href="#快速选择">快速选择</a></li><li><a href="#堆排序">堆排序</a></li><li><a href="#桶排序">桶排序</a></li></ul></li><li><a href="#搜索">搜索</a><ul><li><a href="#bfs">BFS</a></li><li><a href="#dfs">DFS</a></li><li><a href="#backtracking">Backtracking</a></li></ul></li><li><a href="#分治">分治</a></li><li><a href="#动态规划">动态规划</a><ul><li><a href="#分割整数">分割整数</a></li><li><a href="#矩阵路径">矩阵路径</a></li><li><a href="#斐波那契数列">斐波那契数列</a></li><li><a href="#最长递增子序列">最长递增子序列</a></li><li><a href="#最长公共子系列">最长公共子系列</a></li><li><a href="#0-1-背包">0-1 背包</a></li><li><a href="#数组区间">数组区间</a></li><li><a href="#字符串编辑">字符串编辑</a></li><li><a href="#其它问题">其它问题</a></li></ul></li><li><a href="#数学">数学</a><ul><li><a href="#素数">素数</a></li><li><a href="#最大公约数">最大公约数</a></li><li><a href="#进制转换">进制转换</a></li><li><a href="#阶乘">阶乘</a></li><li><a href="#字符串加法减法">字符串加法减法</a></li><li><a href="#相遇问题">相遇问题</a></li><li><a href="#多数投票问题">多数投票问题</a></li><li><a href="#其它">其它</a></li></ul></li></ul></li><li><a href="#数据结构相关">数据结构相关</a><ul><li><a href="#栈和队列">栈和队列</a></li><li><a href="#哈希表">哈希表</a></li><li><a href="#字符串">字符串</a></li><li><a href="#数组与矩阵">数组与矩阵</a><ul><li><a href="#有序矩阵">有序矩阵</a></li></ul></li><li><a href="#链表">链表</a></li><li><a href="#树">树</a><ul><li><a href="#递归">递归</a></li><li><a href="#层次遍历">层次遍历</a></li><li><a href="#前中后序遍历">前中后序遍历</a></li><li><a href="#bst">BST</a></li><li><a href="#trie">Trie</a></li></ul></li><li><a href="#图">图</a></li><li><a href="#位运算">位运算</a></li></ul></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="算法思想"><a href="#算法思想" class="headerlink" title="算法思想"></a>算法思想</h1><h2 id="二分查找"><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h2><p>二分查找思想简单，但是在实现时有一些需要注意的细节：</p><ol><li><p>在计算 mid 时不能使用 mid = (l + h) / 2 这种方式，因为 l + h 可能会导致加法溢出，应该使用 mid = l + (h - l) / 2。</p></li><li><p>对 h 的赋值和循环条件有关，当循环条件为 l &lt;= h 时，h = mid - 1；当循环条件为 l &lt; h 时，h = mid。<br>解释如下：在循环条件为 l &lt;= h 时，如果 h = mid，会出现循环无法退出的情况，例如 l = 1，h = 1，此时 mid 也等于 1，如果此时继续执行 h = mid，那么就会无限循环；在循环条件为 l &lt; h，如果 h = mid - 1，会错误跳过查找的数，例如对于数组 [1,2,3]，要查找 1，最开始 l = 0，h = 2，mid = 1，判断 key &lt; arr[mid] 执行 h = mid - 1 = 0，此时循环退出，直接把查找的数跳过了。</p></li></ol><a id="more"></a><ol><li>l 的赋值一般都为 l = mid + 1。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span>[] arr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, h = arr.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt;= h) &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = l + (h - l) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (key == arr[mid]) <span class="keyword">return</span> mid;</span><br><span class="line">        <span class="keyword">if</span> (key &lt; arr[mid]) h = mid - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>求开方</strong> </p><p><a href="https://leetcode.com/problems/sqrtx/description/" target="_blank" rel="noopener">Leetcode : 69. Sqrt(x) (Easy)</a></p><p>一个数 x 的开方 sqrt 一定在 0 ~ x 之间，并且满足 sqrt == x / sqrt 。可以利用二分查找在 0 ~ x 之间查找 sqrt。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">mySqrt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt;= <span class="number">1</span>) <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">1</span>, h = x;</span><br><span class="line">    <span class="keyword">while</span>(l &lt;= h)&#123;</span><br><span class="line">        <span class="keyword">int</span> mid = l + (h - l) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> sqrt = x / mid;</span><br><span class="line">        <span class="keyword">if</span>(sqrt == mid) <span class="keyword">return</span> mid;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(sqrt &lt; mid) h = mid - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>摆硬币</strong> </p><p><a href="https://leetcode.com/problems/arranging-coins/description/" target="_blank" rel="noopener">Leetcode : 441. Arranging Coins (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">n = 8</span><br><span class="line"></span><br><span class="line">The coins can form the following rows:</span><br><span class="line">¤</span><br><span class="line">¤ ¤</span><br><span class="line">¤ ¤ ¤</span><br><span class="line">¤ ¤</span><br><span class="line"></span><br><span class="line">Because the 4th row is incomplete, we return 3.</span><br></pre></td></tr></table></figure><p>题目描述：第 i 行摆 i 个，统计能够摆的行数。</p><p>返回 h 而不是 l，因为摆的硬币最后一行不能算进去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">arrangeCoins</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, h = n;</span><br><span class="line">    <span class="keyword">while</span>(l &lt;= h)&#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + (h - l) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">long</span> x = m * (m + <span class="number">1L</span>) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(x == n) <span class="keyword">return</span> m;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(x &lt; n) l = m + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> h = m - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以不用二分查找，更直观的解法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">arrangeCoins</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> level = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        n -= level;</span><br><span class="line">        level++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n == <span class="number">0</span> ? level - <span class="number">1</span> : level - <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>有序数组的 Single Element</strong> </p><p><a href="https://leetcode.com/problems/single-element-in-a-sorted-array/description/" target="_blank" rel="noopener">Leetcode : 540. Single Element in a Sorted Array (Medium)</a></p><p>题目描述：一个有序数组只有一个数不出现两次，找出这个数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">singleNonDuplicate</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, h = nums.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(l &lt; h) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + (h - l) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(m % <span class="number">2</span> == <span class="number">1</span>) m--; <span class="comment">// 保证 l/h/m 都在偶数位，使得查找区间大小一直都是奇数</span></span><br><span class="line">        <span class="keyword">if</span>(nums[m] == nums[m + <span class="number">1</span>]) l = m + <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">else</span> h = m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nums[l];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="贪心思想"><a href="#贪心思想" class="headerlink" title="贪心思想"></a>贪心思想</h2><p>贪心思想保证每次操作都是局部最优的，并且最后得到的结果是全局最优的。</p><p><strong>分配饼干</strong> </p><p><a href="https://leetcode.com/problems/assign-cookies/description/" target="_blank" rel="noopener">Leetcode : 455. Assign Cookies (Easy)</a></p><p>题目描述：每个孩子都有一个满足度，每个饼干都有一个大小，只有饼干的大小大于一个孩子的满足度，该孩子才会获得满足。求解最多可以获得满足的孩子数量。</p><p>因为最小的孩子最容易得到满足，因此先满足最小孩子。给一个孩子的饼干应当尽量小又能满足该孩子，这样大饼干就能拿来给满足度比较大的孩子。</p><p>证明：假设在某次选择中，贪心策略选择给第 i 个孩子分配第 m 个饼干，并且第 i 个孩子满足度最小，第 m 个饼干为可以满足第 i 个孩子的最小饼干，利用贪心策略最终可以满足 k 个孩子。假设最优策略在这次选择中给 i 个孩子分配第 n 个饼干，并且这个饼干大于第 m 个饼干。我们发现使用第 m 个饼干去替代第 n 个饼干完全不影响后续的结果，因此不存在比贪心策略更优的策略，即贪心策略就是最优策略。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findContentChildren</span><span class="params">(<span class="keyword">int</span>[] g, <span class="keyword">int</span>[] s)</span> </span>&#123;</span><br><span class="line">    Arrays.sort(g);</span><br><span class="line">    Arrays.sort(s);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; g.length &amp;&amp; j &lt; s.length)&#123;</span><br><span class="line">        <span class="keyword">if</span>(g[i] &lt;= s[j]) i++;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>投飞镖刺破气球</strong> </p><p><a href="https://leetcode.com/problems/minimum-number-of-arrows-to-burst-balloons/description/" target="_blank" rel="noopener">Leetcode : 452. Minimum Number of Arrows to Burst Balloons (Medium)</a></p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line"><span class="comment">[<span class="comment">[10,16]</span>, <span class="comment">[2,8]</span>, <span class="comment">[1,6]</span>, <span class="comment">[7,12]</span>]</span></span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line">2</span><br></pre></td></tr></table></figure><p>题目描述：气球在一个水平数轴上摆放，可以重叠，飞镖垂直射向坐标轴，使得路径上的气球都会刺破。求解最小的投飞镖次数使所有气球都被刺破。</p><p>从左往右投飞镖，并且在每次投飞镖时满足以下条件：</p><ol><li>左边已经没有气球了；</li><li>本次投飞镖能够刺破最多的气球。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findMinArrowShots</span><span class="params">(<span class="keyword">int</span>[][] points)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(points.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    Arrays.sort(points,(a,b) -&gt; (a[<span class="number">1</span>] - b[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">int</span> curPos = points[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; points.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(points[i][<span class="number">0</span>] &lt;= curPos) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curPos = points[i][<span class="number">1</span>];</span><br><span class="line">        ret++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>股票的最大收益</strong> </p><p><a href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock-ii/description/" target="_blank" rel="noopener">Leetcode : 122. Best Time to Buy and Sell Stock II (Easy)</a></p><p>题目描述：一次交易包含买入和卖出，多个交易之间不能交叉进行。</p><p>对于 [a, b, c, d]，如果有 a &lt;= b &lt;= c &lt;= d ，那么最大收益为 d - a。而 d - a = (d - c) + (c - b) + (b - a) ，因此当访问到一个 prices[i] 且 prices[i] - prices[i-1] &gt; 0，那么就把 prices[i] - prices[i-1] 添加加到收益中，从而在局部最优的情况下也保证全局最优。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> profit = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; prices.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(prices[i] &gt; prices[i-<span class="number">1</span>]) profit += (prices[i] - prices[i-<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> profit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>种植花朵</strong> </p><p><a href="https://leetcode.com/problems/can-place-flowers/description/" target="_blank" rel="noopener">Leetcode : 605. Can Place Flowers (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: flowerbed = [1,0,0,0,1], n = 1</span><br><span class="line">Output: True</span><br></pre></td></tr></table></figure><p>题目描述：花朵之间至少需要一个单位的间隔。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canPlaceFlowers</span><span class="params">(<span class="keyword">int</span>[] flowerbed, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; flowerbed.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(flowerbed[i] == <span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">int</span> pre = i == <span class="number">0</span> ? <span class="number">0</span> : flowerbed[i - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> next = i == flowerbed.length - <span class="number">1</span> ? <span class="number">0</span> : flowerbed[i + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span>(pre == <span class="number">0</span> &amp;&amp; next == <span class="number">0</span>) &#123;</span><br><span class="line">            cnt++;</span><br><span class="line">            flowerbed[i] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt &gt;= n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>修改一个数成为非递减数组</strong> </p><p><a href="https://leetcode.com/problems/non-decreasing-array/description/" target="_blank" rel="noopener">Leetcode : 665. Non-decreasing Array (Easy)</a></p><p>题目描述：判断一个数组能不能只修改一个数就成为非递减数组。</p><p>在出现 nums[i] &lt; nums[i - 1] 时，需要考虑的是应该修改数组的哪个数，使得本次修改能使 i 之前的数组成为非递减数组，并且  <strong>不影响后续的操作</strong> 。优先考虑令 nums[i - 1] = nums[i]，因为如果修改 nums[i] = nums[i - 1] 的话，那么 nums[i] 这个数会变大，那么就有可能比 nums[i + 1] 大，从而影响了后续操作。还有一个比较特别的情况就是 nums[i] &lt; nums[i - 2]，只修改 nums[i - 1] = nums[i] 不能令数组成为非递减，只能通过修改 nums[i] = nums[i - 1] 才行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPossibility</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; nums.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[i] &lt; nums[i - <span class="number">1</span>])&#123;</span><br><span class="line">            cnt++;</span><br><span class="line">            <span class="keyword">if</span>(i - <span class="number">2</span> &gt;= <span class="number">0</span> &amp;&amp; nums[i - <span class="number">2</span>] &gt; nums[i]) nums[i] = nums[i-<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">else</span> nums[i - <span class="number">1</span>] = nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt &lt;= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>判断是否为子串</strong> </p><p><a href="https://leetcode.com/problems/is-subsequence/description/" target="_blank" rel="noopener">Leetcode : 392. Is Subsequence (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = "abc", t = "ahbgdc"</span><br><span class="line">Return true.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSubsequence</span><span class="params">(String s, String t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, pos = <span class="number">0</span>; i &lt; s.length(); i++, pos++) &#123;</span><br><span class="line">        pos = t.indexOf(s.charAt(i), pos);</span><br><span class="line">        <span class="keyword">if</span>(pos == -<span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>分隔字符串使同种字符出现在一起</strong> </p><p><a href="https://leetcode.com/problems/partition-labels/description/" target="_blank" rel="noopener">Leetcode : 763. Partition Labels (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input: S = <span class="string">"ababcbacadefegdehijhklij"</span></span><br><span class="line">Output: [<span class="number">9</span>,<span class="number">7</span>,<span class="number">8</span>]</span><br><span class="line">Explanation:</span><br><span class="line">The partition is <span class="string">"ababcbaca"</span>, <span class="string">"defegde"</span>, <span class="string">"hijhklij"</span>.</span><br><span class="line">This is a partition so that each letter appears in at most one part.</span><br><span class="line">A partition like <span class="string">"ababcbacadefegde"</span>, <span class="string">"hijhklij"</span> is incorrect, because it splits S into less parts.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">partitionLabels</span><span class="params">(String S)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span>[] lastIdxs = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; S.length(); i++) lastIdxs[S.charAt(i) - <span class="string">'a'</span>] = i;</span><br><span class="line">    <span class="keyword">int</span> startIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(startIdx &lt; S.length()) &#123;</span><br><span class="line">        <span class="keyword">int</span> endIdx = startIdx;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = startIdx; i &lt; S.length() &amp;&amp; i &lt;= endIdx; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> lastIdx = lastIdxs[S.charAt(i) - <span class="string">'a'</span>];</span><br><span class="line">            <span class="keyword">if</span>(lastIdx == i) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span>(lastIdx &gt; endIdx) endIdx = lastIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        ret.add(endIdx - startIdx + <span class="number">1</span>);</span><br><span class="line">        startIdx = endIdx + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>根据身高和序号重组队列</strong> </p><p><a href="https://leetcode.com/problems/queue-reconstruction-by-height/description/" target="_blank" rel="noopener">Leetcode : 406. Queue Reconstruction by Height(Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">[[7,0], [4,4], [7,1], [5,0], [6,1], [5,2]]</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line">[[5,0], [7,0], [5,2], [6,1], [4,4], [7,1]]</span><br></pre></td></tr></table></figure><p>题目描述：一个学生用两个分量 (h, k) 描述，h 表示身高，k 表示排在前面的有 k 个学生的身高比他高或者和他一样高。</p><p>为了在每次插入操作时不影响后续的操作，身高较高的学生应该先做插入操作，否则身高较小的学生原先正确插入第 k 个位置可能会变成第 k+1 个位置。</p><p>身高降序、k 值升序，然后按排好序的顺序插入队列的第 k 个位置中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[][] reconstructQueue(<span class="keyword">int</span>[][] people) &#123;</span><br><span class="line">    <span class="keyword">if</span>(people == <span class="keyword">null</span> || people.length == <span class="number">0</span> || people[<span class="number">0</span>].length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    Arrays.sort(people, <span class="keyword">new</span> Comparator&lt;<span class="keyword">int</span>[]&gt;() &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span>[] b)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(a[<span class="number">0</span>] == b[<span class="number">0</span>]) <span class="keyword">return</span> a[<span class="number">1</span>] - b[<span class="number">1</span>];</span><br><span class="line">           <span class="keyword">return</span> b[<span class="number">0</span>] - a[<span class="number">0</span>];</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> n = people.length;</span><br><span class="line">    List&lt;<span class="keyword">int</span>[]&gt; tmp = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        tmp.add(people[i][<span class="number">1</span>], <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;people[i][<span class="number">0</span>], people[i][<span class="number">1</span>]&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span>[][] ret = <span class="keyword">new</span> <span class="keyword">int</span>[n][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        ret[i][<span class="number">0</span>] = tmp.get(i)[<span class="number">0</span>];</span><br><span class="line">        ret[i][<span class="number">1</span>] = tmp.get(i)[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="双指针"><a href="#双指针" class="headerlink" title="双指针"></a>双指针</h2><p>双指针主要用于遍历数组，两个指针指向不同的元素，从而协同完成任务。</p><p><strong>从一个已经排序的数组中查找出两个数，使它们的和为 0</strong> </p><p><a href="https://leetcode.com/problems/two-sum-ii-input-array-is-sorted/description/" target="_blank" rel="noopener">Leetcode ：167. Two Sum II - Input array is sorted (Easy)</a></p><p>使用双指针，一个指针指向元素较小的值，一个指针指向元素较大的值。指向较小元素的指针从头向尾遍历，指向较大元素的指针从尾向头遍历。</p><p>如果两个指针指向元素的和 sum == target，那么得到要求的结果；如果 sum &gt; target，移动较大的元素，使 sum 变小一些；如果 sum &lt; target，移动较小的元素，使 sum 变大一些。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] twoSum(<span class="keyword">int</span>[] numbers, <span class="keyword">int</span> target) &#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = numbers.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; j) &#123;</span><br><span class="line">        <span class="keyword">int</span> sum = numbers[i] + numbers[j];</span><br><span class="line">        <span class="keyword">if</span> (sum == target) <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;i + <span class="number">1</span>, j + <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (sum &lt; target) i++;</span><br><span class="line">        <span class="keyword">else</span> j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>反转字符串中的元音字符</strong> </p><p><a href="https://leetcode.com/problems/reverse-vowels-of-a-string/description/" target="_blank" rel="noopener">Leetcode : 345. Reverse Vowels of a String (Easy)</a></p><p>使用双指针，指向待反转的两个元音字符，一个指针从头向尾遍历，一个指针从尾到头遍历。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HashSet&lt;Character&gt; vowels = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(<span class="string">'a'</span>,<span class="string">'e'</span>,<span class="string">'i'</span>,<span class="string">'o'</span>,<span class="string">'u'</span>,<span class="string">'A'</span>,<span class="string">'E'</span>,<span class="string">'I'</span>,<span class="string">'O'</span>,<span class="string">'U'</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">reverseVowels</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s.length() == <span class="number">0</span>) <span class="keyword">return</span> s;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = s.length() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span>[] result = <span class="keyword">new</span> <span class="keyword">char</span>[s.length()];</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= j)&#123;</span><br><span class="line">        <span class="keyword">char</span> ci = s.charAt(i);</span><br><span class="line">        <span class="keyword">char</span> cj = s.charAt(j);</span><br><span class="line">        <span class="keyword">if</span>(!vowels.contains(ci))&#123;</span><br><span class="line">            result[i] = ci;</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!vowels.contains(cj))&#123;</span><br><span class="line">            result[j] = cj;</span><br><span class="line">            j--;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            result[i] = cj;</span><br><span class="line">            result[j] = ci;</span><br><span class="line">            i++;</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>两数平方和</strong> </p><p><a href="https://leetcode.com/problems/sum-of-square-numbers/description/" target="_blank" rel="noopener">Leetcode : 633. Sum of Square Numbers (Easy)</a></p><p>题目描述：判断一个数是否为两个数的平方和，例如 5 = 1<sup>2</sup> + 2<sup>2</sup>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">judgeSquareSum</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> left = <span class="number">0</span>, right = (<span class="keyword">int</span>) Math.sqrt(c);</span><br><span class="line">    <span class="keyword">while</span>(left &lt;= right)&#123;</span><br><span class="line">        <span class="keyword">int</span> powSum = left * left + right * right;</span><br><span class="line">        <span class="keyword">if</span>(powSum == c) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(powSum &gt; c) right--;</span><br><span class="line">        <span class="keyword">else</span> left++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>回文字符串</strong> </p><p><a href="https://leetcode.com/problems/valid-palindrome-ii/description/" target="_blank" rel="noopener">Leetcode : 680. Valid Palindrome II (Easy)</a></p><p>题目描述：字符串可以删除一个字符，判断是否能构成回文字符串。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validPalindrome</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = s.length() -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j)&#123;</span><br><span class="line">        <span class="keyword">if</span>(s.charAt(i) != s.charAt(j))&#123;</span><br><span class="line">            <span class="keyword">return</span> isPalindrome(s, i, j - <span class="number">1</span>) || isPalindrome(s, i + <span class="number">1</span>, j);</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">        j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPalindrome</span><span class="params">(String s, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(l &lt; r)&#123;</span><br><span class="line">        <span class="keyword">if</span>(s.charAt(l) != s.charAt(r))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        l++;</span><br><span class="line">        r--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>归并两个有序数组</strong> </p><p><a href="https://leetcode.com/problems/merge-sorted-array/description/" target="_blank" rel="noopener">Leetcode : 88. Merge Sorted Array (Easy)</a></p><p>题目描述：把归并结果存到第一个数组上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span>[] nums1, <span class="keyword">int</span> m, <span class="keyword">int</span>[] nums2, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = m - <span class="number">1</span>, j = n - <span class="number">1</span>; <span class="comment">// 需要从尾开始遍历，否则在 nums1 上归并得到的值会覆盖还未进行归并比较的值</span></span><br><span class="line">    <span class="keyword">int</span> idx = m + n - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i &lt; <span class="number">0</span>) nums1[idx] = nums2[j--];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(j &lt; <span class="number">0</span>) nums1[idx] = nums1[i--];</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(nums1[i] &gt; nums2[j]) nums1[idx] = nums1[i--];</span><br><span class="line">        <span class="keyword">else</span> nums1[idx] = nums2[j--];</span><br><span class="line">        idx--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>判断链表是否存在环</strong> </p><p><a href="https://leetcode.com/problems/linked-list-cycle/description/" target="_blank" rel="noopener">Leetcode : 141. Linked List Cycle (Easy)</a></p><p>使用双指针，一个指针每次移动一个节点，一个指针每次移动两个节点，如果存在环，那么这两个指针一定会相遇。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasCycle</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    ListNode l1 = head, l2 = head.next;</span><br><span class="line">    <span class="keyword">while</span>(l1 != <span class="keyword">null</span> &amp;&amp; l2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(l1 == l2) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        l1 = l1.next;</span><br><span class="line">        <span class="keyword">if</span>(l2.next == <span class="keyword">null</span>) <span class="keyword">break</span>;</span><br><span class="line">        l2 = l2.next.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最长子序列</strong> </p><p><a href="https://leetcode.com/problems/longest-word-in-dictionary-through-deleting/description/" target="_blank" rel="noopener">Leetcode : 524. Longest Word in Dictionary through Deleting (Medium)</a></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">Input:</span></span><br><span class="line">s = <span class="string">"abpcplea"</span>, d = [<span class="string">"ale"</span>,<span class="string">"apple"</span>,<span class="string">"monkey"</span>,<span class="string">"plea"</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">Output:</span></span><br><span class="line"><span class="string">"apple"</span></span><br></pre></td></tr></table></figure><p>题目描述：可以删除 s 中的一些字符，使得它成为字符串列表 d 中的一个字符串。要求在 d 中找到满足条件的最长字符串。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findLongestWord</span><span class="params">(String s, List&lt;String&gt; d)</span> </span>&#123;</span><br><span class="line">    String ret = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (String str : d) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; s.length() &amp;&amp; j &lt; str.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.charAt(i) == str.charAt(j)) j++;</span><br><span class="line">            <span class="keyword">if</span> (j == str.length()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ret.length() &lt; str.length()</span><br><span class="line">                        || (ret.length() == str.length() &amp;&amp; ret.compareTo(str) &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">                    ret = str;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><h3 id="快速选择"><a href="#快速选择" class="headerlink" title="快速选择"></a>快速选择</h3><p>一般用于求解  <strong>Kth Element</strong>  问题，可以在 O(n) 时间复杂度，O(1) 空间复杂度完成求解工作。</p><p>与快速排序一样，快速选择一般需要先打乱数组，否则最坏情况下时间复杂度为 O(n<sup>2</sup>)。</p><h3 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h3><p>堆排序用于求解  <strong>TopK Elements</strong>  问题，通过维护一个大小为 K 的堆，堆中的元素就是 TopK Elements。当然它也可以用于求解 Kth Element 问题，因为最后出堆的那个元素就是 Kth Element。快速选择也可以求解 TopK Elements 问题，因为找到 Kth Element 之后，再遍历一次数组，所有小于等于  Kth Element 的元素都是 TopK Elements。可以看到，快速选择和堆排序都可以求解 Kth Element 和 TopK Elements 问题。</p><p><strong>Kth Element</strong> </p><p><a href="https://leetcode.com/problems/kth-largest-element-in-an-array/description/" target="_blank" rel="noopener">Leetocde : 215. Kth Largest Element in an Array (Medium)</a></p><p><strong>排序</strong> ：时间复杂度 O(nlgn)，空间复杂度 O(1) 解法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findKthLargest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> N = nums.length;</span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line">        <span class="keyword">return</span> nums[N - k];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>堆排序</strong> ：时间复杂度 O(nlgk)，空间复杂度 O(k)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findKthLargest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    PriorityQueue&lt;Integer&gt; pq = <span class="keyword">new</span> PriorityQueue&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> val : nums) &#123;</span><br><span class="line">        pq.offer(val);</span><br><span class="line">        <span class="keyword">if</span>(pq.size() &gt; k) &#123;</span><br><span class="line">            pq.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pq.peek();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>快速选择</strong> ：时间复杂度 O(n)，空间复杂度 O(1)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findKthLargest</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        k = nums.length - k;</span><br><span class="line">        <span class="keyword">int</span> lo = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> hi = nums.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (lo &lt; hi) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> j = partition(nums, lo, hi);</span><br><span class="line">            <span class="keyword">if</span>(j &lt; k) &#123;</span><br><span class="line">                lo = j + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (j &gt; k) &#123;</span><br><span class="line">                hi = j - <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nums[k];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = lo;</span><br><span class="line">        <span class="keyword">int</span> j = hi + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span>(i &lt; hi &amp;&amp; less(a[++i], a[lo]));</span><br><span class="line">            <span class="keyword">while</span>(j &gt; lo &amp;&amp; less(a[lo], a[--j]));</span><br><span class="line">            <span class="keyword">if</span>(i &gt;= j) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            exch(a, i, j);</span><br><span class="line">        &#125;</span><br><span class="line">        exch(a, lo, j);</span><br><span class="line">        <span class="keyword">return</span> j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exch</span><span class="params">(<span class="keyword">int</span>[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> tmp = a[i];</span><br><span class="line">        a[i] = a[j];</span><br><span class="line">        a[j] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">less</span><span class="params">(<span class="keyword">int</span> v, <span class="keyword">int</span> w)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> v &lt; w;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="桶排序"><a href="#桶排序" class="headerlink" title="桶排序"></a>桶排序</h3><p><strong>找出出现频率最多的 k 个数</strong> </p><p><a href="https://leetcode.com/problems/top-k-frequent-elements/description/" target="_blank" rel="noopener">Leetcode : 347. Top K Frequent Elements (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">topKFrequent</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Map&lt;Integer, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : nums) &#123;</span><br><span class="line">        map.put(num, map.getOrDefault(num, <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Integer&gt;[] bucket = <span class="keyword">new</span> List[nums.length + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> key : map.keySet()) &#123;</span><br><span class="line">        <span class="keyword">int</span> frequency = map.get(key);</span><br><span class="line">        <span class="keyword">if</span>(bucket[frequency] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bucket[frequency] = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        bucket[frequency].add(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = bucket.length - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; ret.size() &lt; k; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span>(bucket[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ret.addAll(bucket[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><p>深度优先搜索和广度优先搜索广泛运用于树和图中，但是它们的应用远远不止如此。</p><h3 id="BFS"><a href="#BFS" class="headerlink" title="BFS"></a>BFS</h3><p><br><div align="center"> <img src="../pics/4ff355cf-9a7f-4468-af43-e5b02038facc.jpg"> </div><br></p><p>广度优先搜索的搜索过程有点像一层一层地进行遍历：从节点 0 出发，遍历到 6、2、1 和 5 这四个新节点。</p><p>继续从 6 开始遍历，得到节点 4 ；从 2 开始遍历，没有下一个节点；从 1 开始遍历，没有下一个节点；从 5 开始遍历，得到 3 和 4 节点。这一轮总共得到两个新节点：4 和 3 。</p><p>反复从新节点出发进行上述的遍历操作。</p><p>可以看到，每一轮遍历的节点都与根节点路径长度相同。设 d<sub>i</sub> 表示第 i 个节点与根节点的路径长度，推导出一个结论：对于先遍历的节点 i 与后遍历的节点 j，有 d<sub>i</sub>&lt;=d<sub>j</sub>。利用这个结论，可以求解最短路径  <strong>最优解</strong>  问题：第一次遍历到目的节点，其所经过的路径为最短路径，如果继续遍历，之后再遍历到目的节点，所经过的路径就不是最短路径。</p><p>在程序实现 BFS 时需要考虑以下问题：</p><ul><li>队列：用来存储每一轮遍历的节点</li><li>标记：对于遍历过得节点，应该将它标记，防止重复遍历；</li></ul><p><strong>计算在网格中从原点到特定点的最短路径长度</strong> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[[1,1,0,1],</span><br><span class="line">[1,0,1,0],</span><br><span class="line">[1,1,1,1],</span><br><span class="line">[1,0,1,1]]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minPathLength</span><span class="params">(<span class="keyword">int</span>[][] grids, <span class="keyword">int</span> tr, <span class="keyword">int</span> tc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[][] next = &#123;&#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">int</span> m = grids.length, n = grids[<span class="number">0</span>].length;</span><br><span class="line">    Queue&lt;Position&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    queue.add(<span class="keyword">new</span> Position(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        Position pos = queue.poll();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            Position nextPos = <span class="keyword">new</span> Position(pos.r + next[i][<span class="number">0</span>], pos.c + next[i][<span class="number">1</span>], pos.length + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (nextPos.r &lt; <span class="number">0</span> || nextPos.r &gt;= m || nextPos.c &lt; <span class="number">0</span> || nextPos.c &gt;= n) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (grids[nextPos.r][nextPos.c] != <span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">            grids[nextPos.r][nextPos.c] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (nextPos.r == tr &amp;&amp; nextPos.c == tc) <span class="keyword">return</span> nextPos.length;</span><br><span class="line">            queue.add(nextPos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Position</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r, c, length;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Position</span><span class="params">(<span class="keyword">int</span> r, <span class="keyword">int</span> c, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.r = r;</span><br><span class="line">        <span class="keyword">this</span>.c = c;</span><br><span class="line">        <span class="keyword">this</span>.length = length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DFS"><a href="#DFS" class="headerlink" title="DFS"></a>DFS</h3><p><br><div align="center"> <img src="../pics/f7f7e3e5-7dd4-4173-9999-576b9e2ac0a2.png"> </div><br></p><p>广度优先搜索一层一层遍历，每一层遍历到的所有新节点，要用队列先存储起来以备下一层遍历的时候再遍历；而深度优先搜索在遍历到一个新节点时立马对新节点进行遍历：从节点 0 出发开始遍历，得到到新节点 6 时，立马对新节点 6 进行遍历，得到新节点 4；如此反复以这种方式遍历新节点，直到没有新节点了，此时返回。返回到根节点 0 的情况是，继续对根节点 0 进行遍历，得到新节点 2，然后继续以上步骤。</p><p>从一个节点出发，使用 DFS 对一个图进行遍历时，能够遍历到的节点都是从初始节点可达的，DFS 常用来求解这种  <strong>可达性</strong>  问题。</p><p>在程序实现 DFS 时需要考虑以下问题：</p><ul><li>栈：用栈来保存当前节点信息，当遍历新节点返回时能够继续遍历当前节点。也可以使用递归栈。</li><li>标记：和 BFS 一样同样需要对已经遍历过得节点进行标记。</li></ul><p><strong>查找最大的连通面积</strong> </p><p><a href="https://leetcode.com/problems/max-area-of-island/description/" target="_blank" rel="noopener">Leetcode : 695. Max Area of Island (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[0,0,1,0,0,0,0,1,0,0,0,0,0],</span><br><span class="line">[0,0,0,0,0,0,0,1,1,1,0,0,0],</span><br><span class="line">[0,1,1,0,1,0,0,0,0,0,0,0,0],</span><br><span class="line">[0,1,0,0,1,1,0,0,1,0,1,0,0],</span><br><span class="line">[0,1,0,0,1,1,0,0,1,1,1,0,0],</span><br><span class="line">[0,0,0,0,0,0,0,0,0,0,1,0,0],</span><br><span class="line">[0,0,0,0,0,0,0,1,1,1,0,0,0],</span><br><span class="line">[0,0,0,0,0,0,0,1,1,0,0,0,0]]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxAreaOfIsland</span><span class="params">(<span class="keyword">int</span>[][] grid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = grid.length, n = grid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(grid[i][j] == <span class="number">1</span>) max = Math.max(max, dfs(grid, i, j));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span>[][] grid, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = grid.length, n = grid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">if</span>(i &lt; <span class="number">0</span> || i &gt;= m || j &lt; <span class="number">0</span> || j &gt;= n) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(grid[i][j] == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    grid[i][j] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> dfs(grid, i + <span class="number">1</span>, j) + dfs(grid, i - <span class="number">1</span>, j) + dfs(grid, i, j + <span class="number">1</span>) + dfs(grid, i, j - <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>图的连通分量</strong> </p><p><a href="https://leetcode.com/problems/friend-circles/description/" target="_blank" rel="noopener">Leetcode : 547. Friend Circles (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">[[1,1,0],</span><br><span class="line"> [1,1,0],</span><br><span class="line"> [0,0,1]]</span><br><span class="line">Output: 2</span><br><span class="line">Explanation:The 0th and 1st students are direct friends, so they are in a friend circle.</span><br><span class="line">The 2nd student himself is in a friend circle. So return 2.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findCircleNum</span><span class="params">(<span class="keyword">int</span>[][] M)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = M.length;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span>[] hasFind = <span class="keyword">new</span> <span class="keyword">boolean</span>[n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!hasFind[i]) &#123;</span><br><span class="line">            dfs(M, i, hasFind);</span><br><span class="line">            ret++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span>[][] M, <span class="keyword">int</span> i, <span class="keyword">boolean</span>[] hasFind)</span> </span>&#123;</span><br><span class="line">    hasFind[i] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">int</span> n = M.length;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; n; k++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(M[i][k] == <span class="number">1</span> &amp;&amp; !hasFind[k]) &#123;</span><br><span class="line">            dfs(M, k, hasFind);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>矩阵中的连通区域数量</strong> </p><p><a href="https://leetcode.com/problems/number-of-islands/description/" target="_blank" rel="noopener">Leetcode : 200. Number of Islands (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11110</span><br><span class="line">11010</span><br><span class="line">11000</span><br><span class="line">00000</span><br><span class="line">Answer: 1</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m, n;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[][] direction = &#123;&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numIslands</span><span class="params">(<span class="keyword">char</span>[][] grid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (grid == <span class="keyword">null</span> || grid.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    m = grid.length;</span><br><span class="line">    n = grid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (grid[i][j] == <span class="string">'1'</span>) &#123;</span><br><span class="line">                dfs(grid, i, j);</span><br><span class="line">                ret++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">char</span>[][] grid, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= m || j &lt; <span class="number">0</span> || j &gt;= n || grid[i][j] == <span class="string">'0'</span>) <span class="keyword">return</span>;</span><br><span class="line">    grid[i][j] = <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; direction.length; k++) &#123;</span><br><span class="line">        dfs(grid, i + direction[k][<span class="number">0</span>], j + direction[k][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>输出二叉树中所有从根到叶子的路径</strong> </p><p><a href="https://leetcode.com/problems/binary-tree-paths/description/" target="_blank" rel="noopener">Leetcode : 257. Binary Tree Paths (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1</span><br><span class="line">/  \</span><br><span class="line">2    3</span><br><span class="line">\</span><br><span class="line">  5</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">["1-&gt;2-&gt;5", "1-&gt;3"]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">binaryTreePaths</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; ret = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    dfs(root, <span class="string">""</span>, ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(TreeNode root, String prefix, List&lt;String&gt; ret)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span>(root.left == <span class="keyword">null</span> &amp;&amp; root.right == <span class="keyword">null</span>)&#123;</span><br><span class="line">        ret.add(prefix + root.val);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    prefix += (root.val + <span class="string">"-&gt;"</span>);</span><br><span class="line">    dfs(root.left, prefix, ret);</span><br><span class="line">    dfs(root.right, prefix, ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>填充封闭区域</strong> </p><p><a href="https://leetcode.com/problems/surrounded-regions/description/" target="_blank" rel="noopener">Leetcode : 130. Surrounded Regions (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">For example,</span><br><span class="line">X X X X</span><br><span class="line">X O O X</span><br><span class="line">X X O X</span><br><span class="line">X O X X</span><br><span class="line"></span><br><span class="line">After running your function, the board should be:</span><br><span class="line">X X X X</span><br><span class="line">X X X X</span><br><span class="line">X X X X</span><br><span class="line">X O X X</span><br></pre></td></tr></table></figure><p>题目描述：使得被 ‘X’ 的 ‘O’ 转换为 ‘X’。</p><p>先填充最外侧，剩下的就是里侧了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[][] direction = &#123;&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m, n;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">solve</span><span class="params">(<span class="keyword">char</span>[][] board)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (board == <span class="keyword">null</span> || board.length == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    m = board.length;</span><br><span class="line">    n = board[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        dfs(board, i, <span class="number">0</span>);</span><br><span class="line">        dfs(board, i, n - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        dfs(board, <span class="number">0</span>, i);</span><br><span class="line">        dfs(board, m - <span class="number">1</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (board[i][j] == <span class="string">'T'</span>) board[i][j] = <span class="string">'O'</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (board[i][j] == <span class="string">'O'</span>) board[i][j] = <span class="string">'X'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">char</span>[][] board, <span class="keyword">int</span> r, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span> || r &gt;= m || c &lt; <span class="number">0</span> || c &gt;= n || board[r][c] != <span class="string">'O'</span>) <span class="keyword">return</span>;</span><br><span class="line">    board[r][c] = <span class="string">'T'</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; direction.length; i++) &#123;</span><br><span class="line">        dfs(board, r + direction[i][<span class="number">0</span>], c + direction[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>从两个方向都能到达的区域</strong> </p><p><a href="https://leetcode.com/problems/pacific-atlantic-water-flow/description/" target="_blank" rel="noopener">Leetcode : 417. Pacific Atlantic Water Flow (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Given the following 5x5 matrix:</span><br><span class="line"></span><br><span class="line">  Pacific ~   ~   ~   ~   ~ </span><br><span class="line">       ~  1   2   2   3  (5) *</span><br><span class="line">       ~  3   2   3  (4) (4) *</span><br><span class="line">       ~  2   4  (5)  3   1  *</span><br><span class="line">       ~ (6) (7)  1   4   5  *</span><br><span class="line">       ~ (5)  1   1   2   4  *</span><br><span class="line">          *   *   *   *   * Atlantic</span><br><span class="line"></span><br><span class="line">Return:</span><br><span class="line">[[0, 4], [1, 3], [1, 4], [2, 2], [3, 0], [3, 1], [4, 0]] (positions with parentheses in above matrix).</span><br></pre></td></tr></table></figure><p>题目描述：左边和上边是太平洋，右边和下边是大西洋，内部的数字代表海拔，海拔高的地方的水能够流到低的地方，求解水能够流到太平洋和大西洋的所有位置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m, n;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[][] matrix;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[][] direction = &#123;&#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;<span class="keyword">int</span>[]&gt; pacificAtlantic(<span class="keyword">int</span>[][] matrix) &#123;</span><br><span class="line">    List&lt;<span class="keyword">int</span>[]&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (matrix == <span class="keyword">null</span> || matrix.length == <span class="number">0</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="keyword">this</span>.m = matrix.length;</span><br><span class="line">    <span class="keyword">this</span>.n = matrix[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">this</span>.matrix = matrix;</span><br><span class="line">    <span class="keyword">boolean</span>[][] canReachP = <span class="keyword">new</span> <span class="keyword">boolean</span>[m][n];</span><br><span class="line">    <span class="keyword">boolean</span>[][] canReachA = <span class="keyword">new</span> <span class="keyword">boolean</span>[m][n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        dfs(i, <span class="number">0</span>, canReachP);</span><br><span class="line">        dfs(i, n - <span class="number">1</span>, canReachA);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        dfs(<span class="number">0</span>, i, canReachP);</span><br><span class="line">        dfs(m - <span class="number">1</span>, i, canReachA);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (canReachP[i][j] &amp;&amp; canReachA[i][j]) &#123;</span><br><span class="line">                ret.add(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;i, j&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> r, <span class="keyword">int</span> c, <span class="keyword">boolean</span>[][] canReach)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(canReach[r][c]) <span class="keyword">return</span>;</span><br><span class="line">    canReach[r][c] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; direction.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextR = direction[i][<span class="number">0</span>] + r;</span><br><span class="line">        <span class="keyword">int</span> nextC = direction[i][<span class="number">1</span>] + c;</span><br><span class="line">        <span class="keyword">if</span> (nextR &lt; <span class="number">0</span> || nextR &gt;= m || nextC &lt; <span class="number">0</span> || nextC &gt;= n</span><br><span class="line">                || matrix[r][c] &gt; matrix[nextR][nextC]) <span class="keyword">continue</span>;</span><br><span class="line">        dfs(nextR, nextC, canReach);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>N 皇后</strong> </p><p><a href="https://leetcode.com/problems/n-queens/description/" target="_blank" rel="noopener">Leetcode : 51. N-Queens (Hard)</a></p><p><br><div align="center"> <img src="../pics/1f080e53-4758-406c-bb5f-dbedf89b63ce.jpg"> </div><br></p><p>题目描述：在 n*n 的矩阵中摆放 n 个皇后，并且每个皇后不能在同一行，同一列，同一对角线上，要求解所有的 n 皇后解。</p><p>一行一行地摆放，在确定一行中的那个皇后应该摆在哪一列时，需要用三个标记数组来确定某一列是否合法，这三个标记数组分别为：列标记数组、45 度对角线标记数组和 135 度对角线标记数组。</p><p>45 度对角线标记数组的维度为 2*n - 1，通过下图可以明确 (r,c) 的位置所在的数组下标为 r + c。</p><p><br><div align="center"> <img src="../pics/85583359-1b45-45f2-9811-4f7bb9a64db7.jpg"> </div><br></p><p>135 度对角线标记数组的维度也是 2*n - 1，(r,c) 的位置所在的数组下标为 n - 1 - (r - c)。</p><p><br><div align="center"> <img src="../pics/9e80f75a-b12b-4344-80c8-1f9ccc2d5246.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;List&lt;String&gt;&gt; ret;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">char</span>[][] nQueens;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span>[] colUsed;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span>[] diagonals45Used;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span>[] diagonals135Used;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;List&lt;String&gt;&gt; solveNQueens(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    nQueens = <span class="keyword">new</span> <span class="keyword">char</span>[n][n];</span><br><span class="line">    Arrays.fill(nQueens, <span class="string">'.'</span>);</span><br><span class="line">    colUsed = <span class="keyword">new</span> <span class="keyword">boolean</span>[n];</span><br><span class="line">    diagonals45Used = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">2</span> * n - <span class="number">1</span>];</span><br><span class="line">    diagonals135Used = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">2</span> * n - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">this</span>.n = n;</span><br><span class="line">    backstracking(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backstracking</span><span class="params">(<span class="keyword">int</span> row)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (row == n) &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span>[] chars : nQueens) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> String(chars));</span><br><span class="line">        &#125;</span><br><span class="line">        ret.add(list);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> col = <span class="number">0</span>; col &lt; n; col++) &#123;</span><br><span class="line">        <span class="keyword">int</span> diagonals45Idx = row + col;</span><br><span class="line">        <span class="keyword">int</span> diagonals135Idx = n - <span class="number">1</span> - (row - col);</span><br><span class="line">        <span class="keyword">if</span> (colUsed[col] || diagonals45Used[diagonals45Idx] || diagonals135Used[diagonals135Idx]) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nQueens[row][col] = <span class="string">'Q'</span>;</span><br><span class="line">        colUsed[col] = diagonals45Used[diagonals45Idx] = diagonals135Used[diagonals135Idx] = <span class="keyword">true</span>;</span><br><span class="line">        backstracking(row + <span class="number">1</span>);</span><br><span class="line">        colUsed[col] = diagonals45Used[diagonals45Idx] = diagonals135Used[diagonals135Idx] = <span class="keyword">false</span>;</span><br><span class="line">        nQueens[row][col] = <span class="string">'.'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Backtracking"><a href="#Backtracking" class="headerlink" title="Backtracking"></a>Backtracking</h3><p>回溯是 DFS 的一种，它不是用在遍历图的节点上，而是用于求解  <strong>排列组合</strong>  问题，例如有 { ‘a’,’b’,’c’ } 三个字符，求解所有由这三个字符排列得到的字符串。</p><p>在程序实现时，回溯需要注意对元素进行标记的问题。使用递归实现的回溯，在访问一个新元素进入新的递归调用，此时需要将新元素标记为已经访问，这样才能在继续递归调用时不用重复访问该元素；但是在递归返回时，需要将该元素标记为未访问，因为只需要保证在一个递归链中不同时访问一个元素，而在不同的递归链是可以访问已经访问过但是不在当前递归链中的元素。</p><p><strong>数字键盘组合</strong> </p><p><a href="https://leetcode.com/problems/letter-combinations-of-a-phone-number/description/" target="_blank" rel="noopener">Leetcode : 17. Letter Combinations of a Phone Number (Medium)</a></p><p><br><div align="center"> <img src="../pics/a3f34241-bb80-4879-8ec9-dff2d81b514e.jpg"> </div><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input:Digit string "23"</span><br><span class="line">Output: ["ad", "ae", "af", "bd", "be", "bf", "cd", "ce", "cf"].</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] KEYS = &#123;<span class="string">""</span>, <span class="string">""</span>, <span class="string">"abc"</span>, <span class="string">"def"</span>, <span class="string">"ghi"</span>, <span class="string">"jkl"</span>, <span class="string">"mno"</span>, <span class="string">"pqrs"</span>, <span class="string">"tuv"</span>, <span class="string">"wxyz"</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">letterCombinations</span><span class="params">(String digits)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (digits != <span class="keyword">null</span> &amp;&amp; digits.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        combination(<span class="string">""</span>, digits, <span class="number">0</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combination</span><span class="params">(String prefix, String digits, <span class="keyword">int</span> offset, List&lt;String&gt; ret)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (offset == digits.length()) &#123;</span><br><span class="line">        ret.add(prefix);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String letters = KEYS[digits.charAt(offset) - <span class="string">'0'</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> c : letters.toCharArray()) &#123;</span><br><span class="line">        combination(prefix + c, digits, offset + <span class="number">1</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在矩阵中寻找字符串</strong> </p><p><a href="https://leetcode.com/problems/word-search/description/" target="_blank" rel="noopener">Leetcode : 79. Word Search (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">For example,</span><br><span class="line">Given board =</span><br><span class="line">[</span><br><span class="line">  ['A','B','C','E'],</span><br><span class="line">  ['S','F','C','S'],</span><br><span class="line">  ['A','D','E','E']</span><br><span class="line">]</span><br><span class="line">word = "ABCCED", -&gt; returns true,</span><br><span class="line">word = "SEE", -&gt; returns true,</span><br><span class="line">word = "ABCB", -&gt; returns false.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[][] shift = &#123;&#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span>[][] visited;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> m;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exist</span><span class="params">(<span class="keyword">char</span>[][] board, String word)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (word == <span class="keyword">null</span> || word.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (board == <span class="keyword">null</span> || board.length == <span class="number">0</span> || board[<span class="number">0</span>].length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    m = board.length;</span><br><span class="line">    n = board[<span class="number">0</span>].length;</span><br><span class="line">    visited = <span class="keyword">new</span> <span class="keyword">boolean</span>[m][n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dfs(board, word, <span class="number">0</span>, i, j)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dfs</span><span class="params">(<span class="keyword">char</span>[][] board, String word, <span class="keyword">int</span> start, <span class="keyword">int</span> r, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (start == word.length()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span> || r &gt;= m || c &lt; <span class="number">0</span> || c &gt;= n || board[r][c] != word.charAt(start) ||  visited[r][c] ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    visited[r][c] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shift.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextR = r + shift[i][<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> nextC = c + shift[i][<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (dfs(board, word, start + <span class="number">1</span>, nextR, nextC)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    visited[r][c] = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>IP 地址划分</strong> </p><p><a href="https://leetcode.com/problems/restore-ip-addresses/description/" target="_blank" rel="noopener">Leetcode : 93. Restore IP Addresses(Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Given "25525511135",</span><br><span class="line">return ["255.255.11.135", "255.255.111.35"].</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;String&gt; ret;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">restoreIpAddresses</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    doRestore(<span class="number">0</span>, <span class="string">""</span>, s);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRestore</span><span class="params">(<span class="keyword">int</span> k, String path, String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k == <span class="number">4</span> || s.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="number">4</span> &amp;&amp; s.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            ret.add(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length() &amp;&amp; i &lt;= <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; s.charAt(<span class="number">0</span>) == <span class="string">'0'</span>) <span class="keyword">break</span>;</span><br><span class="line">        String part = s.substring(<span class="number">0</span>, i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (Integer.valueOf(part) &lt;= <span class="number">255</span>) &#123;</span><br><span class="line">            doRestore(k + <span class="number">1</span>, path.length() != <span class="number">0</span> ? path + <span class="string">"."</span> + part : part, s.substring(i + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>排列</strong> </p><p><a href="https://leetcode.com/problems/permutations/description/" target="_blank" rel="noopener">Leetcode : 46. Permutations (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[1,2,3] have the following permutations:</span><br><span class="line">[</span><br><span class="line">  [1,2,3],</span><br><span class="line">  [1,3,2],</span><br><span class="line">  [2,1,3],</span><br><span class="line">  [2,3,1],</span><br><span class="line">  [3,1,2],</span><br><span class="line">  [3,2,1]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; permute(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Integer&gt; permuteList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">boolean</span>[] visited = <span class="keyword">new</span> <span class="keyword">boolean</span>[nums.length];</span><br><span class="line">    backtracking(permuteList, visited, nums, ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backtracking</span><span class="params">(List&lt;Integer&gt; permuteList, <span class="keyword">boolean</span>[] visited, <span class="keyword">int</span>[] nums, List&lt;List&lt;Integer&gt;&gt; ret)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(permuteList.size() == nums.length)&#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList(permuteList));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; visited.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(visited[i]) <span class="keyword">continue</span>;</span><br><span class="line">        visited[i] = <span class="keyword">true</span>;</span><br><span class="line">        permuteList.add(nums[i]);</span><br><span class="line">        backtracking(permuteList, visited, nums, ret);</span><br><span class="line">        permuteList.remove(permuteList.size() - <span class="number">1</span>);</span><br><span class="line">        visited[i] = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>含有相同元素求排列</strong> </p><p><a href="https://leetcode.com/problems/permutations-ii/description/" target="_blank" rel="noopener">Leetcode : 47. Permutations II (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[1,1,2] have the following unique permutations:</span><br><span class="line">[[1,1,2], [1,2,1], [2,1,1]]</span><br></pre></td></tr></table></figure><p>题目描述：数组元素可能含有相同的元素，进行排列时就有可能出先重复的排列，要求重复的排列只返回一个。</p><p>在实现上，和 Permutations 不同的是要先排序，然后在添加一个元素时，判断这个元素是否等于前一个元素，如果等于，并且前一个元素还未访问，那么就跳过这个元素。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; permuteUnique(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Integer&gt; permuteList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Arrays.sort(nums);</span><br><span class="line">    <span class="keyword">boolean</span>[] visited = <span class="keyword">new</span> <span class="keyword">boolean</span>[nums.length];</span><br><span class="line">    backtracking(permuteList, visited, nums, ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backtracking</span><span class="params">(List&lt;Integer&gt; permuteList, <span class="keyword">boolean</span>[] visited, <span class="keyword">int</span>[] nums, List&lt;List&lt;Integer&gt;&gt; ret)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permuteList.size() == nums.length) &#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList(permuteList));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; visited.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; nums[i] == nums[i - <span class="number">1</span>] &amp;&amp; !visited[i - <span class="number">1</span>]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (visited[i]) <span class="keyword">continue</span>;</span><br><span class="line">        visited[i] = <span class="keyword">true</span>;</span><br><span class="line">        permuteList.add(nums[i]);</span><br><span class="line">        backtracking(permuteList, visited, nums, ret);</span><br><span class="line">        permuteList.remove(permuteList.size() - <span class="number">1</span>);</span><br><span class="line">        visited[i] = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>组合</strong> </p><p><a href="https://leetcode.com/problems/combinations/description/" target="_blank" rel="noopener">Leetcode : 77. Combinations (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">If n = 4 and k = 2, a solution is:</span><br><span class="line">[</span><br><span class="line">  [2,4],</span><br><span class="line">  [3,4],</span><br><span class="line">  [2,3],</span><br><span class="line">  [1,2],</span><br><span class="line">  [1,3],</span><br><span class="line">  [1,4],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; combine(<span class="keyword">int</span> n, <span class="keyword">int</span> k) &#123;</span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Integer&gt; combineList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    backtracking(<span class="number">1</span>, n, k, combineList, ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backtracking</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> n, <span class="keyword">int</span> k, List&lt;Integer&gt; combineList, List&lt;List&lt;Integer&gt;&gt; ret)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(k == <span class="number">0</span>)&#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList(combineList)); <span class="comment">// 这里要重新构造一个 List</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = start; i &lt;= n - k + <span class="number">1</span>; i++)&#123; <span class="comment">// 剪枝</span></span><br><span class="line"></span><br><span class="line">        combineList.add(i);                        <span class="comment">// 把 i 标记为已访问</span></span><br><span class="line">        backtracking(i + <span class="number">1</span>, n, k - <span class="number">1</span>, combineList, ret);</span><br><span class="line">        combineList.remove(combineList.size() - <span class="number">1</span>); <span class="comment">// 把 i 标记为未访问</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>组合求和</strong> </p><p><a href="https://leetcode.com/problems/combination-sum/description/" target="_blank" rel="noopener">Leetcode : 39. Combination Sum (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">given candidate set [2, 3, 6, 7] and target 7,</span><br><span class="line">A solution set is:</span><br><span class="line">[[7],[2, 2, 3]]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;List&lt;Integer&gt;&gt; ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; combinationSum(<span class="keyword">int</span>[] candidates, <span class="keyword">int</span> target) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    doCombination(candidates, target, <span class="number">0</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doCombination</span><span class="params">(<span class="keyword">int</span>[] candidates, <span class="keyword">int</span> target, <span class="keyword">int</span> start, List&lt;Integer&gt; list)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="number">0</span>) &#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList&lt;&gt;(list));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; candidates.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (candidates[i] &lt;= target) &#123;</span><br><span class="line">            list.add(candidates[i]);</span><br><span class="line">            doCombination(candidates, target - candidates[i], i, list);</span><br><span class="line">            list.remove(list.size() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>含有相同元素的求组合求和</strong> </p><p><a href="https://leetcode.com/problems/combination-sum-ii/description/" target="_blank" rel="noopener">Leetcode : 40. Combination Sum II (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">For example, given candidate set [10, 1, 2, 7, 6, 1, 5] and target 8, </span><br><span class="line">A solution set is: </span><br><span class="line">[</span><br><span class="line">  [1, 7],</span><br><span class="line">  [1, 2, 5],</span><br><span class="line">  [2, 6],</span><br><span class="line">  [1, 1, 6]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;List&lt;Integer&gt;&gt; ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; combinationSum2(<span class="keyword">int</span>[] candidates, <span class="keyword">int</span> target) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Arrays.sort(candidates);</span><br><span class="line">    doCombination(candidates, target, <span class="number">0</span>, <span class="keyword">new</span> ArrayList&lt;&gt;(), <span class="keyword">new</span> <span class="keyword">boolean</span>[candidates.length]);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doCombination</span><span class="params">(<span class="keyword">int</span>[] candidates, <span class="keyword">int</span> target, <span class="keyword">int</span> start, List&lt;Integer&gt; list, <span class="keyword">boolean</span>[] visited)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="number">0</span>) &#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList&lt;&gt;(list));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; candidates.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; candidates[i] == candidates[i - <span class="number">1</span>] &amp;&amp; !visited[i - <span class="number">1</span>]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (candidates[i] &lt;= target) &#123;</span><br><span class="line">            list.add(candidates[i]);</span><br><span class="line">            visited[i] = <span class="keyword">true</span>;</span><br><span class="line">            doCombination(candidates, target - candidates[i], i + <span class="number">1</span>, list, visited);</span><br><span class="line">            visited[i] = <span class="keyword">false</span>;</span><br><span class="line">            list.remove(list.size() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>子集</strong> </p><p><a href="https://leetcode.com/problems/subsets/description/" target="_blank" rel="noopener">Leetcode : 78. Subsets (Medium)</a></p><p>题目描述：找出集合的所有子集，子集不能重复，[1, 2] 和 [2, 1] 这种子集算重复</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;List&lt;Integer&gt;&gt; ret;</span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; subsetList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; subsets(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    subsetList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= nums.length; i++) &#123;</span><br><span class="line">        backtracking(<span class="number">0</span>, i, nums);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backtracking</span><span class="params">(<span class="keyword">int</span> startIdx, <span class="keyword">int</span> size, <span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (subsetList.size() == size) &#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList(subsetList));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIdx; i &lt; nums.length; i++) &#123;</span><br><span class="line">        subsetList.add(nums[i]);</span><br><span class="line">        backtracking(i + <span class="number">1</span>, size, nums); <span class="comment">// startIdx 设为下一个元素，使 subset 中的元素都递增排序</span></span><br><span class="line">        subsetList.remove(subsetList.size() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>含有相同元素求子集</strong> </p><p><a href="https://leetcode.com/problems/subsets-ii/description/" target="_blank" rel="noopener">Leetcode : 90. Subsets II (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">For example,</span><br><span class="line">If nums = [1,2,2], a solution is:</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  [2],</span><br><span class="line">  [1],</span><br><span class="line">  [1,2,2],</span><br><span class="line">  [2,2],</span><br><span class="line">  [1,2],</span><br><span class="line">  []</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;List&lt;Integer&gt;&gt; ret;</span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; subsetList;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span>[] visited;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;List&lt;Integer&gt;&gt; subsetsWithDup(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    subsetList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    visited = <span class="keyword">new</span> <span class="keyword">boolean</span>[nums.length];</span><br><span class="line">    Arrays.sort(nums);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= nums.length; i++) &#123;</span><br><span class="line">        backtracking(<span class="number">0</span>, i, nums);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backtracking</span><span class="params">(<span class="keyword">int</span> startIdx, <span class="keyword">int</span> size, <span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (subsetList.size() == size) &#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList(subsetList));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIdx; i &lt; nums.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; nums[i] == nums[i - <span class="number">1</span>] &amp;&amp; !visited[i - <span class="number">1</span>]) <span class="keyword">continue</span>;</span><br><span class="line">        subsetList.add(nums[i]);</span><br><span class="line">        visited[i] = <span class="keyword">true</span>;</span><br><span class="line">        backtracking(i + <span class="number">1</span>, size, nums);</span><br><span class="line">        visited[i] = <span class="keyword">false</span>;</span><br><span class="line">        subsetList.remove(subsetList.size() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>分割字符串使得每部分都是回文数</strong> </p><p><a href="https://leetcode.com/problems/palindrome-partitioning/description/" target="_blank" rel="noopener">Leetcode : 131. Palindrome Partitioning (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;List&lt;String&gt;&gt; ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;List&lt;String&gt;&gt; partition(String s) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    doPartion(<span class="keyword">new</span> ArrayList&lt;&gt;(), s);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doPartion</span><span class="params">(List&lt;String&gt; list, String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        ret.add(<span class="keyword">new</span> ArrayList&lt;&gt;(list));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isPalindrome(s, <span class="number">0</span>, i)) &#123;</span><br><span class="line">            list.add(s.substring(<span class="number">0</span>, i + <span class="number">1</span>));</span><br><span class="line">            doPartion(list, s.substring(i + <span class="number">1</span>));</span><br><span class="line">            list.remove(list.size() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPalindrome</span><span class="params">(String s, <span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (begin &lt; end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.charAt(begin++) != s.charAt(end--)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数独</strong> </p><p><a href="https://leetcode.com/problems/sudoku-solver/description/" target="_blank" rel="noopener">Leetcode : 37. Sudoku Solver (Hard)</a></p><p><br><div align="center"> <img src="../pics/1ca52246-c443-48ae-b1f8-1cafc09ec75c.png"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span>[][] rowsUsed = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">9</span>][<span class="number">10</span>];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span>[][] colsUsed = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">9</span>][<span class="number">10</span>];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span>[][] cubesUsed = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">9</span>][<span class="number">10</span>];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">char</span>[][] board;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">solveSudoku</span><span class="params">(<span class="keyword">char</span>[][] board)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.board = board;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">9</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (board[i][j] == <span class="string">'.'</span>) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">int</span> num = board[i][j] - <span class="string">'0'</span>;</span><br><span class="line">            rowsUsed[i][num] = <span class="keyword">true</span>;</span><br><span class="line">            colsUsed[j][num] = <span class="keyword">true</span>;</span><br><span class="line">            cubesUsed[cubeNum(i, j)][num] = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">9</span>; j++) &#123;</span><br><span class="line">            backtracking(i, j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">backtracking</span><span class="params">(<span class="keyword">int</span> row, <span class="keyword">int</span> col)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (row &lt; <span class="number">9</span> &amp;&amp; board[row][col] != <span class="string">'.'</span>) &#123;</span><br><span class="line">        row = col == <span class="number">8</span> ? row + <span class="number">1</span> : row;</span><br><span class="line">        col = col == <span class="number">8</span> ? <span class="number">0</span> : col + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (row == <span class="number">9</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num = <span class="number">1</span>; num &lt;= <span class="number">9</span>; num++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rowsUsed[row][num] || colsUsed[col][num] || cubesUsed[cubeNum(row, col)][num]) <span class="keyword">continue</span>;</span><br><span class="line">        rowsUsed[row][num] = colsUsed[col][num] = cubesUsed[cubeNum(row, col)][num] = <span class="keyword">true</span>;</span><br><span class="line">        board[row][col] = (<span class="keyword">char</span>) (num + <span class="string">'0'</span>);</span><br><span class="line">        <span class="keyword">if</span> (backtracking(row, col)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        board[row][col] = <span class="string">'.'</span>;</span><br><span class="line">        rowsUsed[row][num] = colsUsed[col][num] = cubesUsed[cubeNum(row, col)][num] = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">cubeNum</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = i / <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> c = j / <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">return</span> r * <span class="number">3</span> + c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="分治"><a href="#分治" class="headerlink" title="分治"></a>分治</h2><p><strong>给表达式加括号</strong> </p><p><a href="https://leetcode.com/problems/different-ways-to-add-parentheses/description/" target="_blank" rel="noopener">Leetcode : 241. Different Ways to Add Parentheses (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input: "2-1-1".</span><br><span class="line"></span><br><span class="line">((2-1)-1) = 0</span><br><span class="line">(2-(1-1)) = 2</span><br><span class="line"></span><br><span class="line">Output : [0, 2]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">diffWaysToCompute</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = input.length();</span><br><span class="line">    List&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">char</span> c = input.charAt(i);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">'+'</span> || c == <span class="string">'-'</span> || c == <span class="string">'*'</span>) &#123;</span><br><span class="line">            List&lt;Integer&gt; left = diffWaysToCompute(input.substring(<span class="number">0</span>, i));</span><br><span class="line">            List&lt;Integer&gt; right = diffWaysToCompute(input.substring(i + <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l : left) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> r : right) &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'+'</span>: ret.add(l + r); <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'-'</span>: ret.add(l - r); <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'*'</span>: ret.add(l * r); <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ret.size() == <span class="number">0</span>) ret.add(Integer.valueOf(input));</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h2><p>递归和动态规划都是将原问题拆成多个子问题然后求解，他们之间最本质的区别是，动态规划保存了子问题的解。</p><h3 id="分割整数"><a href="#分割整数" class="headerlink" title="分割整数"></a>分割整数</h3><p><strong>分割整数的最大乘积</strong> </p><p><a href="https://leetcode.com/problems/integer-break/description/" target="_blank" rel="noopener">Leetcode : 343. Integer Break (Medim)</a></p><p>题目描述：For example, given n = 2, return 1 (2 = 1 + 1); given n = 10, return 36 (10 = 3 + 3 + 4).</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">integerBreak</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= i - <span class="number">1</span>; j++) &#123;</span><br><span class="line">            dp[i] = Math.max(dp[i], Math.max(j * dp[i - j], j * (i - j)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>按平方数来分割整数</strong> </p><p><a href="https://leetcode.com/problems/perfect-squares/description/" target="_blank" rel="noopener">Leetcode : 279. Perfect Squares(Medium)</a></p><p>题目描述：For example, given n = 12, return 3 because 12 = 4 + 4 + 4; given n = 13, return 2 because 13 = 4 + 9.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numSquares</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; squares = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 存储小于 n 的平方数</span></span><br><span class="line">    <span class="keyword">int</span> diff = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">while</span>(square &lt;= n) &#123;</span><br><span class="line">        squares.add(square);</span><br><span class="line">        square += diff;</span><br><span class="line">        diff += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> max = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> s : squares) &#123;</span><br><span class="line">            <span class="keyword">if</span>(s &gt; i) <span class="keyword">break</span>;</span><br><span class="line">            max = Math.min(max, dp[i - s] + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dp[i] = max;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>分割整数构成字母字符串</strong> </p><p><a href="https://leetcode.com/problems/decode-ways/description/" target="_blank" rel="noopener">Leetcode : 91. Decode Ways (Medium)</a></p><p>题目描述：Given encoded message “12”, it could be decoded as “AB” (1 2) or “L” (12).</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numDecodings</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s == <span class="keyword">null</span> || s.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = s.length();</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    dp[<span class="number">1</span>] = s.charAt(<span class="number">0</span>) == <span class="string">'0'</span> ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> one = Integer.valueOf(s.substring(i - <span class="number">1</span>, i));</span><br><span class="line">        <span class="keyword">if</span>(one != <span class="number">0</span>) dp[i] += dp[i - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span>(s.charAt(i - <span class="number">2</span>) == <span class="string">'0'</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">int</span> two = Integer.valueOf(s.substring(i - <span class="number">2</span>, i));</span><br><span class="line">        <span class="keyword">if</span>(two &lt;= <span class="number">26</span>) dp[i] += dp[i - <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="矩阵路径"><a href="#矩阵路径" class="headerlink" title="矩阵路径"></a>矩阵路径</h3><p><strong>矩阵的总路径数</strong> </p><p><a href="https://leetcode.com/problems/unique-paths/description/" target="_blank" rel="noopener">Leetcode : 62. Unique Paths (Medium)</a></p><p>题目描述：统计从矩阵左上角到右下角的路径总数，每次只能向左和向下移动。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">uniquePaths</span><span class="params">(<span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>) dp[j] = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(j != <span class="number">0</span>) dp[j] = dp[j] + dp[j - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>矩阵的最小路径和</strong> </p><p><a href="https://leetcode.com/problems/minimum-path-sum/description/" target="_blank" rel="noopener">Leetcode : 64. Minimum Path Sum (Medium)</a></p><p>题目描述：求从矩阵的左上角到右下角的最小路径和，每次只能向左和向下移动。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minPathSum</span><span class="params">(<span class="keyword">int</span>[][] grid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(grid.length == <span class="number">0</span> || grid[<span class="number">0</span>].length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> m = grid.length, n = grid[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(j == <span class="number">0</span>) dp[<span class="number">0</span>] = dp[<span class="number">0</span>] + grid[i][<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(i == <span class="number">0</span>) dp[j] = dp[j - <span class="number">1</span>] + grid[<span class="number">0</span>][j];</span><br><span class="line">            <span class="keyword">else</span> dp[j] = Math.min(dp[j - <span class="number">1</span>], dp[j]) + grid[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="斐波那契数列"><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h3><p><strong>爬楼梯</strong> </p><p><a href="https://leetcode.com/problems/climbing-stairs/description/" target="_blank" rel="noopener">Leetcode : 70. Climbing Stairs (Easy)</a></p><p>题目描述：有 N 阶楼梯，每次可以上一阶或者两阶，求有多少种上楼梯的方法。</p><p>定义一个数组 dp 存储上楼梯的方法数（为了方便讨论，数组下标从 1 开始），dp[i] 表示走到第 i 个楼梯的方法数目。第 i 个楼梯可以从第 i-1 和 i-2 个楼梯再走一步到达，走到第 i 个楼梯的方法数为走到第 i-1 和第 i-2 个楼梯的方法数之和。</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[i]=dp[i-1]+dp[i-2]"></div> <br></p><p>dp[N] 即为所求。</p><p>考虑到 dp[i] 只与 dp[i - 1] 和 dp[i - 2] 有关，因此可以只用两个变量来存储 dp[i - 1] 和 dp[i - 2] 即可，使得原来的 O(n) 空间复杂度优化为 O(1) 复杂度。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">climbStairs</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">2</span>) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 前一个楼梯、后一个楼梯</span></span><br><span class="line">    <span class="keyword">int</span> pre1 = <span class="number">2</span>, pre2 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> cur = pre1 + pre2;</span><br><span class="line">        pre2 = pre1;</span><br><span class="line">        pre1 = cur;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pre1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>母牛生产</strong> </p><p><a href="#">程序员代码面试指南-P181</a></p><p>题目描述：假设农场中成熟的母牛每年都会生 1 头小母牛，并且永远不会死。第一年有 1 只小母牛，从第二年开始，母牛开始生小母牛。每只小母牛 3 年之后成熟又可以生小母牛。给定整数 N，求 N 年后牛的数量。</p><p>第 i 年成熟的牛的数量为：</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[i]=dp[i-1]+dp[i-3]"></div> <br></p><p><strong>强盗抢劫</strong> </p><p><a href="https://leetcode.com/problems/house-robber/description/" target="_blank" rel="noopener">Leetcode : 198. House Robber (Easy)</a></p><p>题目描述：抢劫一排住户，但是不能抢邻近的住户，求最大抢劫量。</p><p>定义 dp 数组用来存储最大的抢劫量，其中 dp[i] 表示抢到第 i 个住户时的最大抢劫量。由于不能抢劫邻近住户，因此如果抢劫了第 i 个住户那么只能抢劫 i - 2 和 i - 3 的住户，所以</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[i]=max(dp[i-2],dp[i-3])+nums[i]"></div> <br></p><p>O(n) 空间复杂度实现方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">1</span>) <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">2</span>) <span class="keyword">return</span> Math.max(nums[<span class="number">0</span>], nums[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    dp[<span class="number">0</span>] = nums[<span class="number">0</span>];</span><br><span class="line">    dp[<span class="number">1</span>] = nums[<span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">2</span>] = nums[<span class="number">0</span>] + nums[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; n; i++)&#123;</span><br><span class="line">        dp[i] = Math.max(dp[i -<span class="number">2</span>], dp[i - <span class="number">3</span>]) + nums[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(dp[n - <span class="number">1</span>], dp[n - <span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>O(1) 空间复杂度实现方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">1</span>) <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">2</span>) <span class="keyword">return</span> Math.max(nums[<span class="number">0</span>], nums[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">int</span> pre3 = nums[<span class="number">0</span>], pre2 = nums[<span class="number">1</span>], pre1 = nums[<span class="number">2</span>] + nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; n; i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> cur = Math.max(pre2, pre3) + nums[i];</span><br><span class="line">        pre3 = pre2;</span><br><span class="line">        pre2 = pre1;</span><br><span class="line">        pre1 = cur;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(pre1, pre2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>强盗在环形街区抢劫</strong> </p><p><a href="https://leetcode.com/problems/house-robber-ii/description/" target="_blank" rel="noopener">Leetcode : 213. House Robber II (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">1</span>) <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> Math.max(rob(nums, <span class="number">0</span>, n - <span class="number">2</span>), rob(nums, <span class="number">1</span>, n - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> s, <span class="keyword">int</span> e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">if</span>(e - s == <span class="number">0</span>) <span class="keyword">return</span> nums[s];</span><br><span class="line">    <span class="keyword">if</span>(e - s == <span class="number">1</span>) <span class="keyword">return</span> Math.max(nums[s], nums[s + <span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    dp[s] = nums[s];</span><br><span class="line">    dp[s + <span class="number">1</span>] = nums[s + <span class="number">1</span>];</span><br><span class="line">    dp[s + <span class="number">2</span>] = nums[s] + nums[s + <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = s + <span class="number">3</span>; i &lt;= e; i++) &#123;</span><br><span class="line">        dp[i] = Math.max(dp[i - <span class="number">2</span>], dp[i - <span class="number">3</span>]) + nums[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(dp[e], dp[e - <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>信件错排</strong> </p><p>题目描述：有 N 个 信 和 信封，它们被打乱，求错误装信的方式数量。</p><p>定义一个数组 dp 存储错误方式数量，dp[i] 表示前 i 个信和信封的错误方式数量。假设第 i 个信装到第 j 个信封里面，而第 j 个信装到第 k 个信封里面。根据 i 和 k 是否相等，有两种情况：</p><p>① i==k，交换 i 和 k 的信后，它们的信和信封在正确的位置，但是其余 i-2 封信有 dp[i-2] 种错误装信的方式。由于 j 有 i-1 种取值，因此共有 (i-1)*dp[i-2] 种错误装信方式。</p><p>② i != k，交换 i 和 j 的信后，第 i 个信和信封在正确的位置，其余 i-1 封信有 dp[i-1] 种错误装信方式。由于 j 有 i-1 种取值，因此共有 (n-1)*dp[i-1] 种错误装信方式。</p><p>综上所述，错误装信数量方式数量为：</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[i]=(i-1)*dp[i-2]+(i-1)*dp[i-1]"></div> <br></p><p>dp[N] 即为所求。</p><p>和上楼梯问题一样，dp[i] 只与 dp[i-1] 和 dp[i-2] 有关，因此也可以只用两个变量来存储 dp[i-1] 和 dp[i-2]。</p><h3 id="最长递增子序列"><a href="#最长递增子序列" class="headerlink" title="最长递增子序列"></a>最长递增子序列</h3><p>已知一个序列 {S<sub>1</sub>, S<sub>2</sub>,…,S<sub>n</sub>} ，取出若干数组成新的序列 {S<sub>i1</sub>, S<sub>i2</sub>,…, S<sub>im</sub>}，其中 i1、i2 … im 保持递增，即新序列中各个数仍然保持原数列中的先后顺序，称新序列为原序列的一个 <strong>子序列</strong> 。</p><p>如果在子序列中，当下标 ix &gt; iy 时，S<sub>ix</sub> &gt; S<sub>iy</sub>，称子序列为原序列的一个 <strong>递增子序列</strong> 。</p><p>定义一个数组 dp 存储最长递增子序列的长度，dp[n] 表示以 S<sub>n</sub> 结尾的序列的最长递增子序列长度。对于一个递增子序列 {S<sub>i1</sub>, S<sub>i2</sub>,…,S<sub>im</sub>}，如果 im &lt; n 并且 S<sub>im</sub> &lt; S<sub>n</sub> ，此时 {S<sub>i1</sub>, S<sub>i2</sub>,…, S<sub>im</sub>, S<sub>n</sub>} 为一个递增子序列，递增子序列的长度增加 1。满足上述条件的递增子序列中，长度最长的那个递增子序列就是要找的，在长度最长的递增子序列上加上 S<sub>n</sub> 就构成了以 S<sub>n</sub> 为结尾的最长递增子序列。因此 dp[n] = max{ dp[i]+1 | S<sub>i</sub> &lt; S<sub>n</sub> &amp;&amp; i &lt; n} 。</p><p>因为在求 dp[n] 时可能无法找到一个满足条件的递增子序列，此时 {S<sub>n</sub>} 就构成了递增子序列，因此需要对前面的求解方程做修改，令 dp[n] 最小为 1，即：</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[n]=max\{1,dp[i]+1|S_i<S_n\&\&i<n\}"></div> <br></p><p>对于一个长度为 N 的序列，最长子序列并不一定会以 S<sub>N</sub> 为结尾，因此 dp[N] 不是序列的最长递增子序列的长度，需要遍历 dp 数组找出最大值才是所要的结果，即 max{ dp[i] | 1 &lt;= i &lt;= N} 即为所求。</p><p><strong>最长递增子序列</strong> </p><p><a href="https://leetcode.com/problems/longest-increasing-subsequence/description/" target="_blank" rel="noopener">Leetcode : 300. Longest Increasing Subsequence (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLIS</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i] &gt; nums[j]) max = Math.max(max, dp[j] + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dp[i] = max;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">        ret = Math.max(ret, dp[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上解法的时间复杂度为 O(n<sup>2</sup>) ，可以使用二分查找使得时间复杂度降低为 O(nlog<sub>n</sub>)。定义一个 tails 数组，其中 tails[i] 存储长度为 i + 1 的最长递增子序列的最后一个元素，例如对于数组 [4,5,6,3]，有</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">len = 1  :      [4], [5], [6], [3]  =&gt; tails[0] = 3</span><br><span class="line">len = 2  :      [4, 5], [5, 6]      =&gt; tails[1] = 5</span><br><span class="line">len = 3  :      [4, 5, 6]            =&gt; tails[2] = 6</span><br></pre></td></tr></table></figure><p>对于一个元素 x，如果它大于 tails 数组所有的值，那么把它添加到 tails 后面；如果 tails[i-1] &lt; x &lt;= tails[i]，那么更新 tails[i] = x 。</p><p>可以看出 tails 数组保持有序，因此在查找 S<sub>i</sub> 位于 tails 数组的位置时就可以使用二分查找。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLIS</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">int</span>[] tails = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> idx = binarySearch(tails, <span class="number">0</span>, size, nums[i]);</span><br><span class="line">        tails[idx] = nums[i];</span><br><span class="line">        <span class="keyword">if</span>(idx == size) size++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> sIdx, <span class="keyword">int</span> eIdx, <span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(sIdx &lt; eIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> mIdx = sIdx + (eIdx - sIdx) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(nums[mIdx] == key) <span class="keyword">return</span> mIdx;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(nums[mIdx] &gt; key) eIdx = mIdx;</span><br><span class="line">        <span class="keyword">else</span> sIdx = mIdx + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sIdx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最长摆动子序列</strong> </p><p><a href="https://leetcode.com/problems/wiggle-subsequence/description/" target="_blank" rel="noopener">Leetcode : 376. Wiggle Subsequence (Medium)</a></p><p>要求：使用 O(n) 时间复杂度求解。</p><p>使用两个状态 up 和 down。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">wiggleMaxLength</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = nums.length;</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> up = <span class="number">1</span>, down = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums[i] &gt; nums[i - <span class="number">1</span>]) up = down + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[i] &lt; nums[i - <span class="number">1</span>]) down = up + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(up, down);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="最长公共子系列"><a href="#最长公共子系列" class="headerlink" title="最长公共子系列"></a>最长公共子系列</h3><p>对于两个子序列 S1 和 S2，找出它们最长的公共子序列。</p><p>定义一个二维数组 dp 用来存储最长公共子序列的长度，其中 dp[i][j] 表示 S1 的前 i 个字符与 S2 的前 j 个字符最长公共子序列的长度。考虑 S1<sub>i</sub> 与 S2<sub>j</sub> 值是否相等，分为两种情况：</p><p>① 当 S1<sub>i</sub>==S2<sub>j</sub> 时，那么就能在 S1 的前 i-1 个字符与 S2 的前 j-1 个字符最长公共子序列的基础上再加上 S1<sub>i</sub> 这个值，最长公共子序列长度加 1 ，即 dp[i][j] = dp[i-1][j-1] + 1。</p><p>② 当 S1<sub>i</sub> != S2<sub>j</sub> 时，此时最长公共子序列为 S1 的前 i-1 个字符和 S2 的前 j 个字符最长公共子序列，与 S1 的前 i 个字符和 S2 的前 j-1 个字符最长公共子序列，它们的最大者，即 dp[i][j] = max{ dp[i-1][j], dp[i][j-1] }。</p><p>综上，最长公共子系列的状态转移方程为：</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[i][j]=\left\{\begin{array}{rcl}dp[i-1][j-1]&&{S1_i==S2_j}\\max(dp[i-1][j],dp[i][j-1])&&{S1_i<>S2_j}\end{array}\right."></div> <br></p><p>对于长度为 N 的序列 S<sub>1</sub> 和 长度为 M 的序列 S<sub>2</sub>，dp[N][M] 就是序列 S<sub>1</sub> 和序列 S<sub>2</sub> 的最长公共子序列长度。</p><p>与最长递增子序列相比，最长公共子序列有以下不同点：</p><p>① 针对的是两个序列，求它们的最长公共子序列。<br>② 在最长递增子序列中，dp[i] 表示以 S<sub>i</sub> 为结尾的最长递增子序列长度，子序列必须包含 S<sub>i</sub> ；在最长公共子序列中，dp[i][j] 表示 S1 中前 i 个字符与 S2 中前 j 个字符的最长公共子序列长度，不一定包含 S1<sub>i</sub> 和 S2<sub>j</sub> 。<br>③ 由于 2 ，在求最终解时，最长公共子序列中 dp[N][M] 就是最终解，而最长递增子序列中 dp[N] 不是最终解，因为以 S<sub>N</sub> 为结尾的最长递增子序列不一定是整个序列最长递增子序列，需要遍历一遍 dp 数组找到最大者。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLCS</span><span class="params">(<span class="keyword">int</span>[] nums1, <span class="keyword">int</span>[] nums2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n1 = nums1.length, n2 = nums2.length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n1 + <span class="number">1</span>][n2 + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n1; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n2; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums1[i - <span class="number">1</span>] == nums2[j - <span class="number">1</span>]) dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span> dp[i][j] = Math.max(dp[i - <span class="number">1</span>][j], dp[i][j - <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n1][n2];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="0-1-背包"><a href="#0-1-背包" class="headerlink" title="0-1 背包"></a>0-1 背包</h3><p>有一个容量为 N 的背包，要用这个背包装下物品的价值最大，这些物品有两个属性：体积 w 和价值 v。</p><p>定义一个二维数组 dp 存储最大价值，其中 dp[i][j] 表示体积不超过 j 的情况下，前 i 件物品能达到的最大价值。设第 i 件物品体积为 w，价值为 v，根据第 i 件物品是否添加到背包中，可以分两种情况讨论：</p><p>① 第 i 件物品没添加到背包，总体积不超过 j 的前 i 件物品的最大价值就是总体积不超过 j 的前 i-1 件物品的最大价值，dp[i][j] = dp[i-1][j]。<br>② 第 i 件物品添加到背包中，dp[i][j] = dp[i-1][j-w] + v。</p><p>第 i 件物品可添加也可以不添加，取决于哪种情况下最大价值更大。</p><p>综上，0-1 背包的状态转移方程为：</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[i][j]=max(dp[i-1][j],dp[i-1][j-w]+v)"></div> <br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">knapsack</span><span class="params">(<span class="keyword">int</span> W, <span class="keyword">int</span> N, <span class="keyword">int</span>[] weights, <span class="keyword">int</span>[] values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[N][W];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = W - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        dp[<span class="number">0</span>][i] = i &gt; weights[<span class="number">0</span>] ? values[<span class="number">0</span>] : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = W - <span class="number">1</span>; j &gt;= weights[i]; j--) &#123;</span><br><span class="line">            dp[i][j] = Math.max(dp[i - <span class="number">1</span>][j], dp[i - <span class="number">1</span>][j - weights[i]] + values[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = weights[i - <span class="number">1</span>] - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            dp[i][j] = dp[i - <span class="number">1</span>][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[N - <span class="number">1</span>][W - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>空间优化</strong> </p><p>在程序实现时可以对 0-1 背包做优化。观察状态转移方程可以知道，前 i 件物品的状态仅由前 i-1 件物品的状态有关，因此可以将 dp 定义为一维数组，其中 dp[j] 既可以表示 dp[i-1][j] 也可以表示 dp[i][j]。此时，</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?dp[j]=max(dp[j],dp[j-w]+v)"></div> <br></p><p>因为 dp[j-w] 表示 dp[i-1][j-w]，因此不能先求 dp[i][j-w] 防止将 dp[i-1][j-w] 覆盖。也就是说要先计算 dp[i][j] 再计算 dp[i][j-w]，在程序实现时需要按倒序来循环求解。</p><p><strong>无法使用贪心算法的解释</strong> </p><p>0-1 背包问题无法使用贪心算法来求解，也就是说不能按照先添加性价比最高的物品来达到最优，这是因为这种方式可能造成背包空间的浪费，从而无法达到最优。考虑下面的物品和一个容量为 5 的背包，如果先添加物品 0 再添加物品 1，那么只能存放的价值为 16，浪费了大小为 2 的空间。最优的方式是存放物品 1 和物品 2，价值为 22.</p><table><thead><tr><th>id</th><th>w</th><th>v</th><th>v/w</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>6</td><td>6</td></tr><tr><td>1</td><td>2</td><td>10</td><td>5</td></tr><tr><td>2</td><td>3</td><td>12</td><td>4</td></tr></tbody></table><p><strong>变种</strong> </p><p>完全背包：物品可以无限个，可以转换为 0-1 背包，令每种物品的体积和价值变为 1/2/4… 倍数，把它们都当成一个新物品，然后一种物品只能添加一次。</p><p>多重背包：物品数量有限制，同样可以转换为 0-1 背包。</p><p>多维费用背包：物品不仅有重量，还有体积，同时考虑这两种限制。</p><p>其它：物品之间相互约束或者依赖。</p><p><strong>划分数组为和相等的两部分</strong> </p><p><a href="https://leetcode.com/problems/partition-equal-subset-sum/description/" target="_blank" rel="noopener">Leetcode : 416. Partition Equal Subset Sum (Medium)</a></p><p>可以看成一个背包大小为 sum/2 的 0-1 背包问题，但是也有不同的地方，这里没有价值属性，并且背包必须被填满。</p><p>以下实现使用了空间优化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canPartition</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : nums) &#123;</span><br><span class="line">        sum += num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sum % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> W = sum / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">boolean</span>[] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[W + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= W; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[<span class="number">0</span>] == i) dp[i] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = W; j &gt;= nums[i]; j--) &#123;</span><br><span class="line">            dp[j] = dp[j] || dp[j - nums[i]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[W];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>字符串按单词列表分割</strong> </p><p><a href="https://leetcode.com/problems/word-break/description/" target="_blank" rel="noopener">Leetcode : 139. Word Break (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = "leetcode",</span><br><span class="line">dict = ["leet", "code"].</span><br><span class="line">Return true because "leetcode" can be segmented as "leet code".</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">wordBreak</span><span class="params">(String s, List&lt;String&gt; wordDict)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = s.length();</span><br><span class="line">    <span class="keyword">boolean</span>[] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[n + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String word : wordDict) &#123;</span><br><span class="line">            <span class="keyword">if</span> (word.length() &lt;= i</span><br><span class="line">                    &amp;&amp; word.equals(s.substring(i - word.length(), i))) &#123;</span><br><span class="line">                dp[i] = dp[i] || dp[i - word.length()];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>改变一组数的正负号使得它们的和为一给定数</strong> </p><p><a href="https://leetcode.com/problems/target-sum/description/" target="_blank" rel="noopener">Leetcode : 494. Target Sum (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Input: nums is [1, 1, 1, 1, 1], S is 3. </span><br><span class="line">Output: 5</span><br><span class="line">Explanation: </span><br><span class="line"></span><br><span class="line">-1+1+1+1+1 = 3</span><br><span class="line">+1-1+1+1+1 = 3</span><br><span class="line">+1+1-1+1+1 = 3</span><br><span class="line">+1+1+1-1+1 = 3</span><br><span class="line">+1+1+1+1-1 = 3</span><br><span class="line"></span><br><span class="line">There are 5 ways to assign symbols to make the sum of nums be target 3.</span><br></pre></td></tr></table></figure><p>该问题可以转换为 subset sum 问题，从而使用 0-1 背包的方法来求解。可以将这组数看成两部分，P 和 N，其中 P 使用正号，N 使用负号，有以下推导：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                  sum(P) - sum(N) = target</span><br><span class="line">sum(P) + sum(N) + sum(P) - sum(N) = target + sum(P) + sum(N)</span><br><span class="line">                       2 * sum(P) = target + sum(nums)</span><br></pre></td></tr></table></figure><p>因此只要找到一个子集，令它们都取正号，并且和等于 (target + sum(nums))/2，就证明存在解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findTargetSumWays</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> S)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> num : nums) &#123;</span><br><span class="line">        sum += num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sum &lt; S || (sum + S) % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> subsetSum(nums, (sum + S) &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">subsetSum</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> targetSum)</span> </span>&#123;</span><br><span class="line">    Arrays.sort(nums);</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[targetSum + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> num = nums[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = targetSum; j &gt;= num; j--) &#123;</span><br><span class="line">            dp[j] = dp[j] + dp[j - num];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[targetSum];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>01字符构成最多的字符串</strong> </p><p><a href="https://leetcode.com/problems/ones-and-zeroes/description/" target="_blank" rel="noopener">Leetcode : 474. Ones and Zeroes (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input: Array = &#123;"10", "0001", "111001", "1", "0"&#125;, m = 5, n = 3</span><br><span class="line">Output: 4</span><br><span class="line"></span><br><span class="line">Explanation: This are totally 4 strings can be formed by the using of 5 0s and 3 1s, which are “10,”0001”,”1”,”0”</span><br></pre></td></tr></table></figure><p>这是一个多维费用的 0-1 背包问题，有两个背包大小，0 的数量和 1 的数量。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findMaxForm</span><span class="params">(String[] strs, <span class="keyword">int</span> m, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strs == <span class="keyword">null</span> || strs.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> l = strs.length;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[m + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">        String s = strs[i];</span><br><span class="line">        <span class="keyword">int</span> ones = <span class="number">0</span>, zeros = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : s.toCharArray()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">'0'</span>) zeros++;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">'1'</span>) ones++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = m; j &gt;= zeros; j--) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = n; k &gt;= ones; k--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (zeros &lt;= j &amp;&amp; ones &lt;= k) &#123;</span><br><span class="line">                    dp[j][k] = Math.max(dp[j][k], dp[j - zeros][k - ones] + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[m][n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>找零钱</strong> </p><p><a href="https://leetcode.com/problems/coin-change/description/" target="_blank" rel="noopener">Leetcode : 322. Coin Change (Medium)</a></p><p>题目描述：给一些面额的硬币，要求用这些硬币来组成给定面额的钱数，并且使得硬币数量最少。硬币可以重复使用。</p><p>这是一个完全背包问题，完全背包问题和 0-1背包问题在实现上唯一的不同是，第二层循环是从 0 开始的，而不是从尾部开始。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">coinChange</span><span class="params">(<span class="keyword">int</span>[] coins, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[amount + <span class="number">1</span>];</span><br><span class="line">    Arrays.fill(dp, amount + <span class="number">1</span>);</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= amount; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coins.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (coins[j] &lt;= i) &#123;</span><br><span class="line">                dp[i] = Math.min(dp[i], dp[i - coins[j]] + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[amount] &gt; amount ? -<span class="number">1</span> : dp[amount];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>组合总和</strong> </p><p><a href="https://leetcode.com/problems/combination-sum-iv/description/" target="_blank" rel="noopener">Leetcode : 377. Combination Sum IV (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nums = [1, 2, 3]</span><br><span class="line">target = 4</span><br><span class="line"></span><br><span class="line">The possible combination ways are:</span><br><span class="line">(1, 1, 1, 1)</span><br><span class="line">(1, 1, 2)</span><br><span class="line">(1, 2, 1)</span><br><span class="line">(1, 3)</span><br><span class="line">(2, 1, 1)</span><br><span class="line">(2, 2)</span><br><span class="line">(3, 1)</span><br><span class="line"></span><br><span class="line">Note that different sequences are counted as different combinations.</span><br><span class="line"></span><br><span class="line">Therefore the output is 7.</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">combinationSum4</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[target + <span class="number">1</span>];</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= target; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; nums.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[j] &lt;= i) &#123;</span><br><span class="line">                dp[i] += dp[i - nums[j]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[target];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>只能进行两次的股票交易</strong> </p><p><a href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock-iii/description/" target="_blank" rel="noopener">Leetcode : 123. Best Time to Buy and Sell Stock III (Hard)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> firstBuy = Integer.MIN_VALUE, firstSell = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> secondBuy = Integer.MIN_VALUE, secondSell = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> curPrice : prices) &#123;</span><br><span class="line">        <span class="keyword">if</span> (firstBuy &lt; -curPrice) firstBuy = -curPrice;</span><br><span class="line">        <span class="keyword">if</span> (firstSell &lt; firstBuy + curPrice) firstSell = firstBuy + curPrice;</span><br><span class="line">        <span class="keyword">if</span> (secondBuy &lt; firstSell - curPrice) secondBuy = firstSell - curPrice;</span><br><span class="line">        <span class="keyword">if</span> (secondSell &lt; secondBuy + curPrice) secondSell = secondBuy + curPrice;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> secondSell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>只能进行 k 次的股票交易</strong> </p><p><a href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock-iv/description/" target="_blank" rel="noopener">Leetcode : 188. Best Time to Buy and Sell Stock IV (Hard)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i, j] = max(dp[i, j-1], prices[j] - prices[jj] + dp[i-1, jj]) &#123; jj in range of [0, j-1] &#125; = max(dp[i, j-1], prices[j] + max(dp[i-1, jj] - prices[jj]))</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = prices.length;</span><br><span class="line">    <span class="keyword">if</span> (k &gt;= n/<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> maxPro = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (prices[i] &gt; prices[i-<span class="number">1</span>])</span><br><span class="line">                maxPro += prices[i] - prices[i-<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxPro;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[k + <span class="number">1</span>][n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= k; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> localMax = dp[i - <span class="number">1</span>][<span class="number">0</span>] - prices[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            dp[i][j] = Math.max(dp[i][j - <span class="number">1</span>], prices[j] + localMax);</span><br><span class="line">            localMax = Math.max(localMax, dp[i - <span class="number">1</span>][j] - prices[j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[k][n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数组区间"><a href="#数组区间" class="headerlink" title="数组区间"></a>数组区间</h3><p><strong>数组区间和</strong> </p><p><a href="https://leetcode.com/problems/range-sum-query-immutable/description/" target="_blank" rel="noopener">Leetcode : 303. Range Sum Query - Immutable (Easy)</a></p><p>求区间 i ~ j 的和，可以转换为 sum[j] - sum[i-1]，其中 sum[i] 为 0 ~ j 的和。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NumArray</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span>[] nums;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NumArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; nums.length; i++)</span><br><span class="line">            nums[i] += nums[i - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">this</span>.nums = nums;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sumRange</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i == <span class="number">0</span> ? nums[j] : nums[j] - nums[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>子数组最大的和</strong> </p><p><a href="https://leetcode.com/problems/maximum-subarray/description/" target="_blank" rel="noopener">Leetcode : 53. Maximum Subarray (Easy)</a></p><p>令 sum[i] 为以 num[i] 为结尾的子数组最大的和，可以由 sum[i-1] 得到 sum[i] 的值，如果 sum[i-1] 小于 0，那么以 num[i] 为结尾的子数组不能包含前面的内容，因为加上前面的部分，那么和一定会比 num[i] 还小。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">int</span>[] sum = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    sum[<span class="number">0</span>] = nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> max = sum[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++)&#123;</span><br><span class="line">        sum[i] = (sum[i-<span class="number">1</span>] &gt; <span class="number">0</span> ? sum[i-<span class="number">1</span>] : <span class="number">0</span>) + nums[i];</span><br><span class="line">        max = Math.max(max, sum[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>空间复杂度可以优化成 O(1) 空间复杂度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> max = nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> oldsum = nums[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        oldsum = (oldsum &gt; <span class="number">0</span> ? oldsum: <span class="number">0</span>) + nums[i];</span><br><span class="line">        max = Math.max(max, oldsum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数组中等差递增子区间的个数</strong> </p><p><a href="https://leetcode.com/problems/arithmetic-slices/description/" target="_blank" rel="noopener">Leetcode : 413. Arithmetic Slices (Medium)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A = [1, 2, 3, 4]</span><br><span class="line"></span><br><span class="line">return: 3, for 3 arithmetic slices in A: [1, 2, 3], [2, 3, 4] and [1, 2, 3, 4] itself.</span><br></pre></td></tr></table></figure><p>对于 (1,2,3,4)，它有三种组成递增子区间的方式，而对于 (1,2,3,4,5)，它组成递增子区间的方式除了 (1,2,3,4) 的三种外还多了一种，即 (1,2,3,4,5)，因此 dp[i] = dp[i - 1] + 1。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numberOfArithmeticSlices</span><span class="params">(<span class="keyword">int</span>[] A)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = A.length;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(A[i] - A[i - <span class="number">1</span>] == A[i - <span class="number">1</span>] - A[i - <span class="number">2</span>]) &#123;</span><br><span class="line">            dp[i] = dp[i - <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> cnt : dp) &#123;</span><br><span class="line">        ret += cnt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="字符串编辑"><a href="#字符串编辑" class="headerlink" title="字符串编辑"></a>字符串编辑</h3><p><strong>删除两个字符串的字符使它们相等</strong> </p><p><a href="https://leetcode.com/problems/delete-operation-for-two-strings/description/" target="_blank" rel="noopener">Leetcode : 583. Delete Operation for Two Strings (Medium)</a></p><p>可以转换为求两个字符串的最长公共子序列问题。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minDistance</span><span class="params">(String word1, String word2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = word1.length(), n = word2.length();</span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[m + <span class="number">1</span>][n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= m; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span> || j == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            dp[i][j] = word1.charAt(i - <span class="number">1</span>) == word2.charAt(j - <span class="number">1</span>) ? dp[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">                    : Math.max(dp[i][j - <span class="number">1</span>], dp[i - <span class="number">1</span>][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m + n - <span class="number">2</span> * dp[m][n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>修改一个字符串称为另一个字符串</strong>  // TODO</p><p><a href="https://leetcode.com/problems/edit-distance/description/" target="_blank" rel="noopener">Leetcode : 72. Edit Distance (Hard)</a></p><h3 id="其它问题"><a href="#其它问题" class="headerlink" title="其它问题"></a>其它问题</h3><p><strong>需要冷却期的股票交易</strong> </p><p><a href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock-with-cooldown/description/" target="_blank" rel="noopener">Leetcode : 309. Best Time to Buy and Sell Stock with Cooldown(Medium)</a></p><p>题目描述：交易之后需要有一天的冷却时间。</p><p><br><div align="center"> <img src="../pics/ac9b31ec-cef1-4880-a875-fc4571ca10e1.png"> </div><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s0[i] = max(s0[i - 1], s2[i - 1]); // Stay at s0, or rest from s2</span><br><span class="line">s1[i] = max(s1[i - 1], s0[i - 1] - prices[i]); // Stay at s1, or buy from s0</span><br><span class="line">s2[i] = s1[i - 1] + prices[i]; // Only one way from s1</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (prices == <span class="keyword">null</span> || prices.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = prices.length;</span><br><span class="line">    <span class="keyword">int</span>[] s0 = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">int</span>[] s1 = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">int</span>[] s2 = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    s0[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    s1[<span class="number">0</span>] = -prices[<span class="number">0</span>];</span><br><span class="line">    s2[<span class="number">0</span>] = Integer.MIN_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        s0[i] = Math.max(s0[i - <span class="number">1</span>], s2[i - <span class="number">1</span>]);</span><br><span class="line">        s1[i] = Math.max(s1[i - <span class="number">1</span>], s0[i - <span class="number">1</span>] - prices[i]);</span><br><span class="line">        s2[i] = Math.max(s2[i - <span class="number">1</span>], s1[i - <span class="number">1</span>] + prices[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(s0[n - <span class="number">1</span>], s2[n - <span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>统计从 0 ~ n 每个数的二进制表示中 1 的个数</strong> </p><p><a href="https://leetcode.com/problems/counting-bits/description/" target="_blank" rel="noopener">Leetcode : 338. Counting Bits (Medium)</a></p><p>对于数字 6(110)，它可以看成是数字 2(10) 前面加上一个 1 ，因此 dp[i] = dp[i&amp;(i-1)] + 1;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] countBits(<span class="keyword">int</span> num) &#123;</span><br><span class="line">    <span class="keyword">int</span>[] ret = <span class="keyword">new</span> <span class="keyword">int</span>[num + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= num; i++)&#123;</span><br><span class="line">        ret[i] = ret[i&amp;(i-<span class="number">1</span>)] + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>一组整数对能够构成的最长链</strong> </p><p><a href="https://leetcode.com/problems/maximum-length-of-pair-chain/description/" target="_blank" rel="noopener">Leetcode : 646. Maximum Length of Pair Chain (Medium)</a></p><p>对于 (a, b) 和 (c, d) ，如果 b &lt; c，则它们可以构成一条链。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findLongestChain</span><span class="params">(<span class="keyword">int</span>[][] pairs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pairs == <span class="keyword">null</span> || pairs.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Arrays.sort(pairs, (a, b) -&gt; (a[<span class="number">0</span>] - b[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">int</span> n = pairs.length;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    Arrays.fill(dp, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(pairs[i][<span class="number">0</span>] &gt; pairs[j][<span class="number">1</span>])&#123;</span><br><span class="line">                dp[i] = Math.max(dp[i], dp[j] + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : dp) &#123;</span><br><span class="line">        ret = Math.max(ret, num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>买入和售出股票最大的收益</strong> </p><p><a href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock/description/" target="_blank" rel="noopener">Leetcode : 121. Best Time to Buy and Sell Stock (Easy)</a></p><p>只进行一次交易。</p><p>只要记录前面的最小价格，将这个最小价格作为买入价格，然后将当前的价格作为售出价格，查看这个价格是否是当前的最大价格。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProfit</span><span class="params">(<span class="keyword">int</span>[] prices)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = prices.length;</span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> soFarMin = prices[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(soFarMin &gt; prices[i]) soFarMin = prices[i];</span><br><span class="line">        <span class="keyword">else</span> max = Math.max(max, prices[i] - soFarMin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>复制粘贴字符</strong> </p><p><a href="https://leetcode.com/problems/2-keys-keyboard/description/" target="_blank" rel="noopener">Leetcode : 650. 2 Keys Keyboard (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minSteps</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        dp[i] = i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % j == <span class="number">0</span>) &#123;</span><br><span class="line">                dp[i] = dp[j] + dp[i / j];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minSteps</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= Math.sqrt(n); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (n % i == <span class="number">0</span>) <span class="keyword">return</span> i + minSteps(n / i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="数学"><a href="#数学" class="headerlink" title="数学"></a>数学</h2><h3 id="素数"><a href="#素数" class="headerlink" title="素数"></a>素数</h3><p><strong>素数分解</strong> </p><p>每一个数都可以分解成素数的乘积，例如 84 = 2<sup>2</sup> * 3<sup>1</sup> * 5<sup>0</sup> * 7<sup>1</sup> * 11<sup>0</sup> * 13<sup>0</sup> * 17<sup>0</sup> * …</p><p><strong>整除</strong> </p><p>令 x = 2<sup>m0</sup> * 3<sup>m1</sup> * 5<sup>m2</sup> * 7<sup>m3</sup> * 11<sup>m4</sup> * …<br>令 y = 2<sup>n0</sup> * 3<sup>n1</sup> * 5<sup>n2</sup> * 7<sup>n3</sup> * 11<sup>n4</sup> * …</p><p>如果 x 整除 y（y mod x == 0），则对于所有 i，mi &lt;= ni。</p><p>x 和 y 的  <strong>最大公约数</strong>  为：gcd(x,y) =  2<sup>min(m0,n0)</sup> * 3<sup>min(m1,n1)</sup> * 5<sup>min(m2,n2)</sup> * …</p><p>x 和 y 的  <strong>最小公倍数</strong>  为：lcm(x,y) =  2<sup>max(m0,n0)</sup> * 3<sup>max(m1,n1)</sup> * 5<sup>max(m2,n2)</sup> * …</p><p><strong>生成素数序列</strong> </p><p><a href="https://leetcode.com/problems/count-primes/description/" target="_blank" rel="noopener">Leetcode : 204. Count Primes (Easy)</a></p><p>埃拉托斯特尼筛法在每次找到一个素数时，将能被素数整除的数排除掉。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countPrimes</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span>[] notPrimes = <span class="keyword">new</span> <span class="keyword">boolean</span>[n + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(notPrimes[i]) <span class="keyword">continue</span>;</span><br><span class="line">        cnt++;</span><br><span class="line">        <span class="comment">// 从 i * i 开始，因为如果 k &lt; i，那么 k * i 在之前就已经被去除过了</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">long</span> j = (<span class="keyword">long</span>) i * i; j &lt; n; j += i)&#123;</span><br><span class="line">            notPrimes[(<span class="keyword">int</span>) j] = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="最大公约数"><a href="#最大公约数" class="headerlink" title="最大公约数"></a>最大公约数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcd</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="number">0</span>) <span class="keyword">return</span> a;</span><br><span class="line">    <span class="keyword">return</span> gcd(b, a % b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最大公倍数为两数的乘积除以最大公约数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lcm</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b / gcd(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于最大公约数问题，因为需要计算 a % b ，而这个操作是比较耗时的，可以使用 <a href=""> 编程之美：2.7</a> 的方法，利用减法和移位操作来替换它。</p><p>对于 a 和 b 的最大公约数 f(a, b)，有：</p><p>1. 如果 a 和 b 均为偶数，f(a, b) = 2*f(a/2, b/2);<br>2. 如果 a 是偶数 b 是奇数，f(a, b) = f(a/2, b);<br>3. 如果 b 是偶数 a 是奇数，f(a, b) = f(a, b/2);<br>4. 如果 a 和 b 均为奇数，f(a, b) = f(a, a-b);</p><p>乘 2 和除 2 都可以转换为移位操作。</p><h3 id="进制转换"><a href="#进制转换" class="headerlink" title="进制转换"></a>进制转换</h3><p>Java 中 static String toString(int num, int radix) 可以将一个整数装换为 redix 进制表示的字符串。</p><p><strong>7 进制</strong> </p><p><a href="https://leetcode.com/problems/base-7/description/" target="_blank" rel="noopener">Leetcode : 504. Base 7 (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">convertToBase7</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (num &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'-'</span> + convertToBase7(-num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (num &lt; <span class="number">7</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> num + <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> convertToBase7(num / <span class="number">7</span>) + num % <span class="number">7</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>16 进制</strong> </p><p><a href="https://leetcode.com/problems/convert-a-number-to-hexadecimal/description/" target="_blank" rel="noopener">Leetcode : 405. Convert a Number to Hexadecimal (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toHex</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] map = &#123;<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span>(num == <span class="number">0</span>) <span class="keyword">return</span> <span class="string">"0"</span>;</span><br><span class="line">    String ret = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">while</span>(num != <span class="number">0</span>)&#123;</span><br><span class="line">        ret = map[(num &amp; <span class="number">0b1111</span>)] + ret;</span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="阶乘"><a href="#阶乘" class="headerlink" title="阶乘"></a>阶乘</h3><p><strong>统计阶乘尾部有多少个 0</strong> </p><p><a href="https://leetcode.com/problems/factorial-trailing-zeroes/description/" target="_blank" rel="noopener">Leetcode : 172. Factorial Trailing Zeroes (Easy)</a></p><p>尾部的 0 由 2 * 5 得来，2 的数量明显多于 5 的数量，因此只要统计有多少个 5 即可。</p><p>对于一个数 N，它所包含 5 的个数为：N/5 + N/5<sup>2</sup> + N/5<sup>3</sup> + …，其中 N/5 表示不大于 N 的数中 5 的倍数贡献一个 5，N/5<sup>2</sup> 表示不大于 N 的数中 5<sup>2</sup> 的倍数再贡献一个 5 …。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">trailingZeroes</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n == <span class="number">0</span> ? <span class="number">0</span> : n / <span class="number">5</span> + trailingZeroes(n / <span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果统计的是 N! 的二进制表示中最低位 1 的位置，只要统计有多少个 2 即可，该题目出自 <a href="#"> 编程之美：2.2</a> 。和求解有多少个 5 一样，2 的个数为 N/2 + N/2<sup>2</sup> + N/2<sup>3</sup> + …</p><h3 id="字符串加法减法"><a href="#字符串加法减法" class="headerlink" title="字符串加法减法"></a>字符串加法减法</h3><p><strong>二进制加法</strong> </p><p><a href="https://leetcode.com/problems/add-binary/description/" target="_blank" rel="noopener">Leetcode : 67. Add Binary (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">addBinary</span><span class="params">(String a, String b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = a.length() - <span class="number">1</span>, j = b.length() - <span class="number">1</span>, carry = <span class="number">0</span>;</span><br><span class="line">    String str = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i &gt;= <span class="number">0</span> &amp;&amp; a.charAt(i--) == <span class="string">'1'</span>) carry++;</span><br><span class="line">        <span class="keyword">if</span>(j &gt;= <span class="number">0</span> &amp;&amp; b.charAt(j--) == <span class="string">'1'</span>) carry++;</span><br><span class="line">        str = (carry % <span class="number">2</span>) + str;</span><br><span class="line">        carry /= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(carry == <span class="number">1</span>) str = <span class="string">"1"</span> + str;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>字符串加法</strong> </p><p><a href="https://leetcode.com/problems/add-strings/description/" target="_blank" rel="noopener">Leetcode : 415. Add Strings (Easy)</a></p><p>题目描述：字符串的值为非负整数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">addStrings</span><span class="params">(String num1, String num2)</span> </span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = num1.length() - <span class="number">1</span>, j = num2.length() - <span class="number">1</span>; i &gt;= <span class="number">0</span> || j &gt;= <span class="number">0</span> || carry == <span class="number">1</span>; i--, j--)&#123;</span><br><span class="line">        <span class="keyword">int</span> x = i &lt; <span class="number">0</span> ? <span class="number">0</span> : num1.charAt(i) - <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">int</span> y = j &lt; <span class="number">0</span> ? <span class="number">0</span> : num2.charAt(j) - <span class="string">'0'</span>;</span><br><span class="line">        sb.append((x + y + carry) % <span class="number">10</span>);</span><br><span class="line">        carry = (x + y + carry) / <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.reverse().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="相遇问题"><a href="#相遇问题" class="headerlink" title="相遇问题"></a>相遇问题</h3><p><strong>改变数组元素使所有的数组元素都相等</strong> </p><p><a href="https://leetcode.com/problems/minimum-moves-to-equal-array-elements-ii/description/" target="_blank" rel="noopener">Leetcode : 462. Minimum Moves to Equal Array Elements II (Medium)</a></p><p>题目描述：每次可以对一个数组元素加一或者减一，求最小的改变次数。</p><p>这是个典型的相遇问题，移动距离最小的方式是所有元素都移动到中位数。理由如下：</p><p>设 m 为中位数。a 和 b 是 m 两边的两个元素，且 b &gt; a。要使 a 和 b 相等，它们总共移动的次数为 b - a，这个值等于 (b - m) + (m - a)，也就是把这两个数移动到中位数的移动次数。</p><p>设数组长度为 N，则可以找到 N/2 对 a 和 b 的组合，使它们都移动到 m 的位置。</p><p><strong>解法 1</strong> </p><p>先排序，时间复杂度：O(NlgN)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minMoves2</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    Arrays.sort(nums);</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, h = nums.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(l &lt;= h) &#123;</span><br><span class="line">        ret += nums[h] - nums[l];</span><br><span class="line">        l++;</span><br><span class="line">        h--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>解法 2</strong> </p><p>使用快速排序找到中位数，时间复杂度 O(N)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minMoves2</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">int</span> median = quickSelect(nums, <span class="number">0</span>, n - <span class="number">1</span>, n / <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : nums) ret += Math.abs(num - median);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">quickSelect</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> start, <span class="keyword">int</span> end, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = start, r = end, privot = nums[(l + r) / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">while</span>(l &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">while</span>(nums[l] &lt; privot) l++;</span><br><span class="line">        <span class="keyword">while</span>(nums[r] &gt; privot) r--;</span><br><span class="line">        <span class="keyword">if</span>(l &gt;= r) <span class="keyword">break</span>;</span><br><span class="line">        swap(nums, l, r);</span><br><span class="line">        l++; r--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> left = l - start + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(left &gt; k) <span class="keyword">return</span> quickSelect(nums, start, l - <span class="number">1</span>, k);</span><br><span class="line">    <span class="keyword">if</span>(left == k &amp;&amp; l == r) <span class="keyword">return</span> nums[l];</span><br><span class="line">    <span class="keyword">int</span> right = r - start + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> quickSelect(nums, r + <span class="number">1</span>, end, k - right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tmp = nums[i]; nums[i] = nums[j]; nums[j] = tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="多数投票问题"><a href="#多数投票问题" class="headerlink" title="多数投票问题"></a>多数投票问题</h3><p><strong>数组中出现次数多于 n / 2 的元素</strong> </p><p><a href="https://leetcode.com/problems/majority-element/description/" target="_blank" rel="noopener">Leetcode : 169. Majority Element (Easy)</a></p><p>先对数组排序，最中间那个数出现次数一定多于 n / 2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">majorityElement</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    Arrays.sort(nums);</span><br><span class="line">    <span class="keyword">return</span> nums[nums.length / <span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以利用 Boyer-Moore Majority Vote Algorithm 来解决这个问题，使得时间复杂度为 O(n)。可以这么理解该算法：使用 cnt 来统计一个元素出现的次数，当遍历到的元素和统计元素不想等时，令 cnt–。如果前面查找了 i 个元素，且 cnt == 0 ，说明前 i 个元素没有 majority，或者有 majority，但是出现的次数少于 i / 2 ，因为如果多于 i / 2 的话 cnt 就一定不会为 0 。此时剩下的 n - i 个元素中，majority 的数目多于 (n - i) / 2，因此继续查找就能找出 majority。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">majorityElement</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>, majority = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(cnt == <span class="number">0</span>) &#123;</span><br><span class="line">            majority = nums[i];</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(majority == nums[i]) cnt++;</span><br><span class="line">        <span class="keyword">else</span> cnt--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> majority;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p><strong>平方数</strong> </p><p><a href="https://leetcode.com/problems/valid-perfect-square/description/" target="_blank" rel="noopener">Leetcode : 367. Valid Perfect Square (Easy)</a></p><p>平方序列：1,4,9,16,..<br>间隔：3,5,7,…</p><p>间隔为等差数列，使用这个特性可以得到从 1 开始的平方序列。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPerfectSquare</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> subNum = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        num -= subNum;</span><br><span class="line">        subNum += <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> num == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3 的 n 次方</strong> </p><p><a href="https://leetcode.com/problems/power-of-three/description/" target="_blank" rel="noopener">Leetcode : 326. Power of Three (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerOfThree</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n &gt; <span class="number">0</span> &amp;&amp; (<span class="number">1162261467</span> % n == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>找出数组中的乘积最大的三个数</strong> </p><p><a href="https://leetcode.com/problems/maximum-product-of-three-numbers/description/" target="_blank" rel="noopener">Leetcode : 628. Maximum Product of Three Numbers (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maximumProduct</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> max1 = Integer.MIN_VALUE, max2 = Integer.MIN_VALUE, max3 = Integer.MIN_VALUE, min1 = Integer.MAX_VALUE, min2 = Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> n : nums) &#123;</span><br><span class="line">        <span class="keyword">if</span> (n &gt; max1) &#123;</span><br><span class="line">            max3 = max2;</span><br><span class="line">            max2 = max1;</span><br><span class="line">            max1 = n;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n &gt; max2) &#123;</span><br><span class="line">            max3 = max2;</span><br><span class="line">            max2 = n;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n &gt; max3) &#123;</span><br><span class="line">            max3 = n;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (n &lt; min1) &#123;</span><br><span class="line">            min2 = min1;</span><br><span class="line">            min1 = n;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; min2) &#123;</span><br><span class="line">            min2 = n;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Math.max(max1*max2*max3, max1*min1*min2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>乘积数组</strong> </p><p><a href="https://leetcode.com/problems/product-of-array-except-self/description/" target="_blank" rel="noopener">Leetcode : 238. Product of Array Except Self (Medium)</a></p><p>题目描述：给定一个数组，创建一个新数组，新数组的每个元素为原始数组中除了该位置上的元素之外所有元素的乘积。</p><p>题目要求：时间复杂度为 O(n)，并且不能使用除法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] productExceptSelf(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">int</span>[] ret = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    ret[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        ret[i] = ret[i - <span class="number">1</span>] * nums[i - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> right = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        ret[i] *= right;</span><br><span class="line">        right *= nums[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="数据结构相关"><a href="#数据结构相关" class="headerlink" title="数据结构相关"></a>数据结构相关</h1><h2 id="栈和队列"><a href="#栈和队列" class="headerlink" title="栈和队列"></a>栈和队列</h2><p><strong>用栈实现队列</strong> </p><p>一个栈实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">MyQueue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Stack&lt;Integer&gt; st = <span class="keyword">new</span> Stack();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        Stack&lt;Integer&gt; temp = <span class="keyword">new</span> Stack();</span><br><span class="line">        <span class="keyword">while</span>(!st.isEmpty())&#123;</span><br><span class="line">            temp.push(st.pop());</span><br><span class="line">        &#125;</span><br><span class="line">        st.push(x);</span><br><span class="line">        <span class="keyword">while</span>(!temp.isEmpty())&#123;</span><br><span class="line">            st.push(temp.pop());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> st.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> st.peek();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> st.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两个栈实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">MyQueue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Stack&lt;Integer&gt; in = <span class="keyword">new</span> Stack();</span><br><span class="line">    <span class="keyword">private</span> Stack&lt;Integer&gt; out = <span class="keyword">new</span> Stack();</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        in.push(x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        in2out();</span><br><span class="line">        <span class="keyword">return</span> out.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        in2out();</span><br><span class="line">        <span class="keyword">return</span> out.peek();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">in2out</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(out.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">while</span>(!in.isEmpty())&#123;</span><br><span class="line">                out.push(in.pop());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> in.isEmpty() &amp;&amp; out.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>用队列实现栈</strong> </p><p><a href="https://leetcode.com/problems/implement-stack-using-queues/description/" target="_blank" rel="noopener">Leetcode : 225. Implement Stack using Queues (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyStack</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Queue&lt;Integer&gt; queue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        queue.add(x);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; queue.size(); i++)&#123; <span class="comment">// 翻转</span></span><br><span class="line">            queue.add(queue.remove());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> queue.remove();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">top</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> queue.peek();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> queue.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最小值栈</strong> </p><p><a href="https://leetcode.com/problems/min-stack/description/" target="_blank" rel="noopener">Leetcode : 155. Min Stack (Easy)</a></p><p>用两个栈实现，一个存储数据，一个存储最小值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinStack</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Stack&lt;Integer&gt; dataStack;</span><br><span class="line">    <span class="keyword">private</span> Stack&lt;Integer&gt; minStack;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> min;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MinStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dataStack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">        minStack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">        min = Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        dataStack.add(x);</span><br><span class="line">        <span class="keyword">if</span>(x &lt; min) &#123;</span><br><span class="line">            min = x;</span><br><span class="line">        &#125;</span><br><span class="line">        minStack.add(min);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        dataStack.pop();</span><br><span class="line">        minStack.pop();</span><br><span class="line">        <span class="keyword">if</span>(!minStack.isEmpty()) &#123;</span><br><span class="line">            min = minStack.peek();</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            min = Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">top</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataStack.peek();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> min;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于实现最小值队列问题，可以先将队列使用栈来实现，然后就将问题转换为最小值栈，这个问题出现在 编程之美：3.7。</p><p><strong>用栈实现括号匹配</strong> </p><p><a href="https://leetcode.com/problems/valid-parentheses/description/" target="_blank" rel="noopener">Leetcode : 20. Valid Parentheses (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"()[]&#123;&#125;"</span><br><span class="line"></span><br><span class="line">Output : true</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    Stack&lt;Character&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++)&#123;</span><br><span class="line">        <span class="keyword">char</span> c = s.charAt(i);</span><br><span class="line">        <span class="keyword">if</span>(c == <span class="string">'('</span> || c == <span class="string">'&#123;'</span> || c == <span class="string">'['</span>) stack.push(c);</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(stack.isEmpty()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">char</span> cStack = stack.pop();</span><br><span class="line">            <span class="keyword">if</span>(c == <span class="string">')'</span> &amp;&amp; cStack != <span class="string">'('</span> ||</span><br><span class="line">              c == <span class="string">']'</span> &amp;&amp; cStack != <span class="string">'['</span> ||</span><br><span class="line">              c == <span class="string">'&#125;'</span> &amp;&amp; cStack != <span class="string">'&#123;'</span> ) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stack.isEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数组中比当前元素大的下一个数组元素的距离</strong> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: [73, 74, 75, 71, 69, 72, 76, 73]</span><br><span class="line">Output: [1, 1, 4, 2, 1, 1, 0, 0]</span><br></pre></td></tr></table></figure><p><a href="https://leetcode.com/problems/daily-temperatures/description/" target="_blank" rel="noopener">Leetcode : 739. Daily Temperatures (Medium)</a></p><p>使用栈来存储还未计算的元素。可以保证从栈顶向下元素递增，否则上面有一个比下面某个元素大的元素进入栈中，下面那个元素已经找到比它大的元素，因此会出栈。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] dailyTemperatures(<span class="keyword">int</span>[] temperatures) &#123;</span><br><span class="line">    <span class="keyword">int</span> n = temperatures.length;</span><br><span class="line">    <span class="keyword">int</span>[] ret = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span>(!stack.isEmpty() &amp;&amp; temperatures[i] &gt; temperatures[stack.peek()]) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = stack.pop();</span><br><span class="line">            ret[idx] = i - idx;</span><br><span class="line">        &#125;</span><br><span class="line">        stack.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数组中下一个比当前数大的数</strong> </p><p><a href="https://leetcode.com/problems/next-greater-element-i/description/" target="_blank" rel="noopener">Leetcode : 496. Next Greater Element I (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: nums1 = [4,1,2], nums2 = [1,3,4,2].</span><br><span class="line">Output: [-1,3,-1]</span><br></pre></td></tr></table></figure><p>在遍历数组时用 Stack 把数组中的数存起来，如果当前遍历的数比栈顶元素来的大，说明栈顶元素的下一个比它大的数就是当前元素。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] nextGreaterElement(<span class="keyword">int</span>[] nums1, <span class="keyword">int</span>[] nums2) &#123;</span><br><span class="line">    Map&lt;Integer, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : nums2)&#123;</span><br><span class="line">        <span class="keyword">while</span>(!stack.isEmpty() &amp;&amp; num &gt; stack.peek())&#123;</span><br><span class="line">            map.put(stack.pop(), num);</span><br><span class="line">        &#125;</span><br><span class="line">        stack.add(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span>[] ret = <span class="keyword">new</span> <span class="keyword">int</span>[nums1.length];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums1.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(map.containsKey(nums1[i])) ret[i] = map.get(nums1[i]);</span><br><span class="line">        <span class="keyword">else</span> ret[i] = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>循环数组中下一个比当前元素大的数</strong> </p><p><a href="https://leetcode.com/problems/next-greater-element-ii/description/" target="_blank" rel="noopener">Leetcode : 503. Next Greater Element II (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] nextGreaterElements(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length, next[] = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    Arrays.fill(next, -<span class="number">1</span>);</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n * <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> num = nums[i % n];</span><br><span class="line">        <span class="keyword">while</span> (!stack.isEmpty() &amp;&amp; nums[stack.peek()] &lt; num)</span><br><span class="line">            next[stack.pop()] = num;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; n) stack.push(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h2><p>利用 Hash Table 可以快速查找一个元素是否存在等问题，但是需要一定的空间来存储。在优先考虑时间复杂度的情况下，可以利用 Hash Table 这种空间换取时间的做法。</p><p>Java 中的  <strong>HashSet</strong>  用于存储一个集合，并以 O(1) 的时间复杂度查找元素是否在集合中。</p><p>如果元素有穷，并且范围不大，那么可以用一个布尔数组来存储一个元素是否存在，例如对于只有小写字符的元素，就可以用一个长度为 26 的布尔数组来存储一个字符集合，使得空间复杂度降低为 O(1)。</p><p>Java 中的  <strong>HashMap</strong>  主要用于映射关系，从而把两个元素联系起来。</p><p>在对一个内容进行压缩或者其它转换时，利用 HashMap 可以把原始内容和转换后的内容联系起来。例如在一个简化 url 的系统中（<a href="https://leetcode.com/problems/encode-and-decode-tinyurl/description/" target="_blank" rel="noopener">Leetcdoe : 535. Encode and Decode TinyURL (Medium)</a>），利用 HashMap 就可以存储精简后的 url 到原始 url 的映射，使得不仅可以显示简化的 url，也可以根据简化的 url 得到原始 url 从而定位到正确的资源。</p><p>HashMap 也可以用来对元素进行计数统计，此时键为元素，值为计数。和 HashSet 类似，如果元素有穷并且范围不大，可以用整型数组来进行统计。</p><p><strong>数组中的两个数和为给定值</strong> </p><p><a href="https://leetcode.com/problems/two-sum/description/" target="_blank" rel="noopener">Leetcode : 1. Two Sum (Easy)</a></p><p>可以先对数组进行排序，然后使用双指针方法或者二分查找方法。这样做的时间复杂度为 O(nlg<sub>n</sub>)，空间复杂度为 O(1)。</p><p>用 HashMap 存储数组元素和索引的映射，在访问到 nums[i] 时，判断 HashMap 中是否存在 target - nums[i] ，如果存在说明 target - nums[i] 所在的索引和 i 就是要找的两个数。该方法的时间复杂度为 O(n)，空间复杂度为 O(n)，使用空间来换取时间。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] twoSum(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target) &#123;</span><br><span class="line">    HashMap&lt;Integer, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(map.containsKey(target - nums[i])) <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;map.get(target - nums[i]), i&#125;;</span><br><span class="line">        <span class="keyword">else</span> map.put(nums[i], i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最长和谐序列</strong> </p><p>和谐序列中最大数和最小数只差正好为 1</p><p><a href="https://leetcode.com/problems/longest-harmonious-subsequence/description/" target="_blank" rel="noopener">Leetcode : 594. Longest Harmonious Subsequence (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findLHS</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    Map&lt;Long, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> num : nums) &#123;</span><br><span class="line">        map.put(num, map.getOrDefault(num, <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> key : map.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(key + <span class="number">1</span>)) &#123;</span><br><span class="line">            result = Math.max(result, map.get(key + <span class="number">1</span>) + map.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p><strong>两个字符串的包含的字符是否完全相同</strong> </p><p><a href="https://leetcode.com/problems/valid-anagram/description/" target="_blank" rel="noopener">Leetcode : 242. Valid Anagram (Easy)</a></p><p>字符串只包含小写字符，总共有 26 个小写字符。可以用 Hash Table 来映射字符与出现次数，因为键值范围很小，因此可以用数组来进行映射。</p><p>使用长度为 26 的整型数组对字符串出现的字符进行统计，比较两个字符串出现的字符数量是否相同。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAnagram</span><span class="params">(String s, String t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] cnts = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">26</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i  = <span class="number">0</span>; i &lt; s.length(); i++) cnts[s.charAt(i) - <span class="string">'a'</span>] ++;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i  = <span class="number">0</span>; i &lt; t.length(); i++) cnts[t.charAt(i) - <span class="string">'a'</span>] --;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i  = <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) <span class="keyword">if</span>(cnts[i] != <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>字符串同构</strong> </p><p><a href="https://leetcode.com/problems/isomorphic-strings/description/" target="_blank" rel="noopener">Leetcode : 205. Isomorphic Strings (Easy)</a></p><p>例如 “egg” 和 “add” 就属于同构字符串。</p><p>记录一个字符上次出现的位置，如果两个字符串中某个字符上次出现的位置一样，那么就属于同构。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIsomorphic</span><span class="params">(String s, String t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] m1 = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">int</span>[] m2 = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(m1[s.charAt(i)] != m2[t.charAt(i)]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        m1[s.charAt(i)] = i + <span class="number">1</span>;</span><br><span class="line">        m2[t.charAt(i)] = i + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>计算一组字符集合可以组成的回文字符串的最大长度</strong> </p><p><a href="https://leetcode.com/problems/longest-palindrome/description/" target="_blank" rel="noopener">Leetcode : 409. Longest Palindrome</a></p><p>使用长度为 128 的整型数组来统计每个字符出现的个数，每个字符有偶数个可以用来构成回文字符串。因为回文字符串最中间的那个字符可以单独出现，所以如果有单独的字符就把它放到最中间。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestPalindrome</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] cnts = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">128</span>]; <span class="comment">// ascii 码总共 128 个</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">char</span> c : s.toCharArray()) cnts[c]++;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> cnt : cnts)  ret += (cnt / <span class="number">2</span>) * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; s.length()) ret ++; <span class="comment">// 这个条件下 s 中一定有单个未使用的字符存在，可以把这个字符放到回文的最中间</span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>判断一个整数是否是回文数</strong> </p><p><a href="https://leetcode.com/problems/palindrome-number/description/" target="_blank" rel="noopener">Leetcode : 9. Palindrome Number (Easy)</a></p><p>要求不能使用额外空间，也就不能将整数转换为字符串进行判断。</p><p>将整数分成左右两部分，右边那部分需要转置，然后判断这两部分是否相等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPalindrome</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(x &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(x % <span class="number">10</span> == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> right = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(x &gt; right)&#123;</span><br><span class="line">        right = right * <span class="number">10</span> + x % <span class="number">10</span>;</span><br><span class="line">        x /= <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x == right || x == right / <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>回文子字符串</strong> </p><p><a href="https://leetcode.com/problems/palindromic-substrings/description/" target="_blank" rel="noopener">Leetcode : 647. Palindromic Substrings (Medium)</a></p><p>解决方案是从字符串的某一位开始，尝试着去扩展子字符串。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countSubstrings</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">        extendSubstrings(s, i, i);    <span class="comment">// 奇数长度</span></span><br><span class="line">        extendSubstrings(s, i, i + <span class="number">1</span>); <span class="comment">// 偶数长度</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">extendSubstrings</span><span class="params">(String s, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(start &gt;= <span class="number">0</span> &amp;&amp; end &lt; s.length() &amp;&amp; s.charAt(start) == s.charAt(end)) &#123;</span><br><span class="line">        start--;</span><br><span class="line">        end++;</span><br><span class="line">        cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>统计二进制字符串中连续 1 和 连续 0 数量相同的子字符串个数</strong> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input: "00110011"</span><br><span class="line">Output: 6</span><br><span class="line">Explanation: There are 6 substrings that have equal number of consecutive 1's and 0's: "0011", "01", "1100", "10", "0011", and "01".</span><br></pre></td></tr></table></figure><p><a href="https://leetcode.com/problems/count-binary-substrings/description/" target="_blank" rel="noopener">Leetcode : 696. Count Binary Substrings (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countBinarySubstrings</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> preLen = <span class="number">0</span>, curLen = <span class="number">1</span>, ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; s.length(); i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(s.charAt(i) == s.charAt(i-<span class="number">1</span>)) curLen++;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            preLen = curLen;</span><br><span class="line">            curLen = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(preLen &gt;= curLen) ret++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>字符串循环移位包含</strong> </p><p><a href="#"> 编程之美：3.1</a></p><p>给定两个字符串 s1 和 s2 ，要求判定 s2 是否能够被 s1 做循环移位得到的字符串包含。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s1 = AABCD, s2 = CDAA</span><br><span class="line">Return : true</span><br></pre></td></tr></table></figure><p>s1 进行循环移位的结果是 s1s1 的子字符串，因此只要判断 s2 是否是 s1s1 的子字符串即可。</p><p><strong>字符串循环移位</strong> </p><p><a href="#"> 编程之美：2.17</a></p><p>将字符串向右循环移动 k 位。</p><p>例如 abcd123 向右移动 3 位 得到 123abcd</p><p>将 abcd123 中的 abcd 和 123 单独逆序，得到 dcba321，然后对整个字符串进行逆序，得到123abcd。</p><p><strong>字符串中单词的翻转</strong> </p><p><a href="#">程序员代码面试指南</a></p><p>例如将 “I am a student” 翻转成 “student a am I”</p><p>将每个单词逆序，然后将整个字符串逆序。</p><h2 id="数组与矩阵"><a href="#数组与矩阵" class="headerlink" title="数组与矩阵"></a>数组与矩阵</h2><p><strong>把数组中的 0 移到末尾</strong> </p><p><a href="https://leetcode.com/problems/move-zeroes/description/" target="_blank" rel="noopener">Leetcode : 283. Move Zeroes (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">moveZeroes</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[i] != <span class="number">0</span>) nums[idx++] = nums[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(idx &lt; n)&#123;</span><br><span class="line">        nums[idx++] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>一个数组元素在 [1, n] 之间，其中一个数被替换为另一个数，找出丢失的数和重复的数</strong> </p><p><a href="https://leetcode.com/problems/set-mismatch/description/" target="_blank" rel="noopener">Leetcode : 645. Set Mismatch (Easy)</a></p><p>最直接的方法是先对数组进行排序，这种方法时间复杂度为 O(nlog<sub>n</sub>)，本题可以以 O(n) 的时间复杂度、O(1) 空间复杂度来求解。</p><p>主要思想是让通过交换数组元素，使得数组上的元素在正确的位置上。</p><p>遍历数组，如果第 i 位上的元素不是 i + 1 ，那么就交换第 i 位 和 nums[i] - 1 位上的元素，使得 num[i] - 1 的元素为 nums[i] ，也就是该位的元素是正确的。交换操作需要循环进行，因为一次交换没办法使得第 i 位上的元素是正确的。但是要交换的两个元素可能就是重复元素，那么循环就可能永远进行下去，终止循环的方法是加上 nums[i] != nums[nums[i] - 1 条件。</p><p>类似题目：</p><ul><li><a href="https://leetcode.com/problems/find-all-numbers-disappeared-in-an-array/description/" target="_blank" rel="noopener">Leetcode :448. Find All Numbers Disappeared in an Array (Easy)</a>，寻找所有丢失的元素</li><li><a href="https://leetcode.com/problems/find-all-duplicates-in-an-array/description/" target="_blank" rel="noopener">Leetcode : 442. Find All Duplicates in an Array (Medium)</a>，寻找所有重复的元素。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] findErrorNums(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++)&#123;</span><br><span class="line">        <span class="keyword">while</span>(nums[i] != i + <span class="number">1</span> &amp;&amp; nums[i] != nums[nums[i] - <span class="number">1</span>]) swap(nums, i, nums[i] - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i + <span class="number">1</span> != nums[i]) <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;nums[i], i + <span class="number">1</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tmp = nums[i];</span><br><span class="line">    nums[i] = nums[j];</span><br><span class="line">    nums[j] = tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>找出数组中重复的数，数组值在 [0, n-1] 之间</strong> </p><p><a href="https://leetcode.com/problems/find-the-duplicate-number/description/" target="_blank" rel="noopener">Leetcode : 287. Find the Duplicate Number (Medium)</a></p><p>二分查找解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findDuplicate</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">int</span> l = <span class="number">1</span>, h = nums.length - <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">while</span> (l &lt;= h) &#123;</span><br><span class="line">         <span class="keyword">int</span> mid = l + (h - l) / <span class="number">2</span>;</span><br><span class="line">         <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">             <span class="keyword">if</span> (nums[i] &lt;= mid) cnt++;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (cnt &gt; mid) h = mid - <span class="number">1</span>;</span><br><span class="line">         <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>双指针解法，类似于有环链表中找出环的入口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findDuplicate</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> slow = nums[<span class="number">0</span>], fast = nums[nums[<span class="number">0</span>]];</span><br><span class="line">      <span class="keyword">while</span> (slow != fast) &#123;</span><br><span class="line">          slow = nums[slow];</span><br><span class="line">          fast = nums[nums[fast]];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      fast = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (slow != fast) &#123;</span><br><span class="line">          slow = nums[slow];</span><br><span class="line">          fast = nums[fast];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> slow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="有序矩阵"><a href="#有序矩阵" class="headerlink" title="有序矩阵"></a>有序矩阵</h3><p>有序矩阵指的是行和列分别有序的矩阵。</p><p>一般可以利用有序性使用二分查找方法。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">   [ 1,  5,  9],</span><br><span class="line">   [10, 11, 13],</span><br><span class="line">   [12, 13, 15]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>有序矩阵查找</strong> </p><p><a href="https://leetcode.com/problems/search-a-2d-matrix-ii/description/" target="_blank" rel="noopener">Leetocde : 240. Search a 2D Matrix II (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">searchMatrix</span><span class="params">(<span class="keyword">int</span>[][] matrix, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (matrix == <span class="keyword">null</span> || matrix.length == <span class="number">0</span> || matrix[<span class="number">0</span>].length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> m = matrix.length, n = matrix[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span> row = <span class="number">0</span>, col = n - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (row &lt; m &amp;&amp; col &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (target == matrix[row][col]) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (target &lt; matrix[row][col]) col--;</span><br><span class="line">        <span class="keyword">else</span> row++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>有序矩阵的 Kth Element</strong> </p><p><a href="https://leetcode.com/problems/kth-smallest-element-in-a-sorted-matrix/description/" target="_blank" rel="noopener">Leetcode : 378. Kth Smallest Element in a Sorted Matrix ((Medium))</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">matrix = [</span><br><span class="line">  [ 1,  5,  9],</span><br><span class="line">  [10, 11, 13],</span><br><span class="line">  [12, 13, 15]</span><br><span class="line">],</span><br><span class="line">k = 8,</span><br><span class="line"></span><br><span class="line">return 13.</span><br></pre></td></tr></table></figure><p>解题参考：<a href="https://leetcode.com/problems/kth-smallest-element-in-a-sorted-matrix/discuss/85173" target="_blank" rel="noopener">Share my thoughts and Clean Java Code</a></p><p>二分查找解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">kthSmallest</span><span class="params">(<span class="keyword">int</span>[][] matrix, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = matrix.length, n = matrix[<span class="number">0</span>].length;</span><br><span class="line">    <span class="keyword">int</span> lo = matrix[<span class="number">0</span>][<span class="number">0</span>], hi = matrix[m - <span class="number">1</span>][n - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span>(lo &lt;= hi) &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = lo + (hi - lo) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n &amp;&amp; matrix[i][j] &lt;= mid; j++) &#123;</span><br><span class="line">                cnt++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(cnt &lt; k) lo = mid + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> hi = mid - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>堆解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">kthSmallest</span><span class="params">(<span class="keyword">int</span>[][] matrix, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = matrix.length, n = matrix[<span class="number">0</span>].length;</span><br><span class="line">    PriorityQueue&lt;Tuple&gt; pq = <span class="keyword">new</span> PriorityQueue&lt;Tuple&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) pq.offer(<span class="keyword">new</span> Tuple(<span class="number">0</span>, j, matrix[<span class="number">0</span>][j]));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k - <span class="number">1</span>; i++) &#123; <span class="comment">// 小根堆，去掉 k - 1 个堆顶元素，此时堆顶元素就是第 k 的数</span></span><br><span class="line">        Tuple t = pq.poll();</span><br><span class="line">        <span class="keyword">if</span>(t.x == m - <span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">        pq.offer(<span class="keyword">new</span> Tuple(t.x + <span class="number">1</span>, t.y, matrix[t.x + <span class="number">1</span>][t.y]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pq.poll().val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tuple</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Tuple</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x, y, val;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tuple</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x; <span class="keyword">this</span>.y = y; <span class="keyword">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Tuple that)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.val - that.val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h2><p><strong>判断两个链表的交点</strong> </p><p><a href="https://leetcode.com/problems/intersection-of-two-linked-lists/description/" target="_blank" rel="noopener">Leetcode : 160. Intersection of Two Linked Lists</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A:          a1 → a2</span><br><span class="line">                  ↘</span><br><span class="line">                    c1 → c2 → c3</span><br><span class="line">                  ↗</span><br><span class="line">B:    b1 → b2 → b3</span><br></pre></td></tr></table></figure><p>要求：时间复杂度为 O(n) 空间复杂度为 O(1)</p><p>设 A 的长度为 a + c，B 的长度为 b + c，其中 c 为尾部公共部分长度，可知 a + c + b = b + c + a。</p><p>当访问 A 链表的指针访问到链表尾部时，令它从链表 B 的头部开始访问链表 B；同样地，当访问 B 链表的指针访问到链表尾部时，令它从链表 A 的头部开始访问链表 A。这样就能控制访问 A 和 B 两个链表的指针能同时访问到交点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">getIntersectionNode</span><span class="params">(ListNode headA, ListNode headB)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(headA == <span class="keyword">null</span> || headB == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    ListNode l1 = headA, l2 = headB;</span><br><span class="line">    <span class="keyword">while</span>(l1 != l2)&#123;</span><br><span class="line">        l1 = (l1 == <span class="keyword">null</span>) ? headB : l1.next;</span><br><span class="line">        l2 = (l2 == <span class="keyword">null</span>) ? headA : l2.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果只是判断是否存在交点，那么就是另一个问题，即 编程之美：3.6 的问题。有两种解法：把第一个链表的结尾连接到第二个链表的开头，看第二个链表是否存在环；或者直接比较第一个链表最后一个节点和第二个链表最后一个节点是否相同。</p><p><strong>链表反转</strong> </p><p><a href="https://leetcode.com/problems/reverse-linked-list/description/" target="_blank" rel="noopener">Leetcode : 206. Reverse Linked List</a></p><p>头插法能够按逆序构建链表。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">reverseList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    ListNode newHead = <span class="keyword">null</span>; <span class="comment">// 设为 null ，作为新链表的结尾</span></span><br><span class="line">    <span class="keyword">while</span>(head != <span class="keyword">null</span>)&#123;</span><br><span class="line">        ListNode nextNode = head.next;</span><br><span class="line">        head.next = newHead;</span><br><span class="line">        newHead = head;</span><br><span class="line">        head = nextNode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>归并两个有序的链表</strong> </p><p><a href="https://leetcode.com/problems/merge-two-sorted-lists/description/" target="_blank" rel="noopener">Leetcode : 21. Merge Two Sorted Lists</a></p><p>链表和树一样，可以用递归方式来定义：链表是空节点，或者有一个值和一个指向下一个链表的指针，因此很多链表问题可以用递归来处理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l1 == <span class="keyword">null</span>) <span class="keyword">return</span> l2;</span><br><span class="line">    <span class="keyword">if</span>(l2 == <span class="keyword">null</span>) <span class="keyword">return</span> l1;</span><br><span class="line">    ListNode newHead = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(l1.val &lt; l2.val)&#123;</span><br><span class="line">        newHead = l1;</span><br><span class="line">        newHead.next = mergeTwoLists(l1.next, l2);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        newHead = l2;</span><br><span class="line">        newHead.next = mergeTwoLists(l1, l2.next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>从有序链表中删除重复节点</strong> </p><p><a href="https://leetcode.com/problems/remove-duplicates-from-sorted-list/description/" target="_blank" rel="noopener">Leetcode : 83. Remove Duplicates from Sorted List (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">deleteDuplicates</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head == <span class="keyword">null</span> || head.next == <span class="keyword">null</span>) <span class="keyword">return</span> head;</span><br><span class="line">    head.next = deleteDuplicates(head.next);</span><br><span class="line">    <span class="keyword">return</span> head.next != <span class="keyword">null</span> &amp;&amp; head.val == head.next.val ? head.next : head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>回文链表</strong> </p><p><a href="https://leetcode.com/problems/palindrome-linked-list/description/" target="_blank" rel="noopener">Leetcode : 234. Palindrome Linked List (Easy)</a></p><p>切成两半，把后半段反转，然后比较两半是否相等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPalindrome</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head == <span class="keyword">null</span> || head.next == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    ListNode slow = head, fast = head.next;</span><br><span class="line">    <span class="keyword">while</span>(fast != <span class="keyword">null</span> &amp;&amp; fast.next != <span class="keyword">null</span>)&#123;</span><br><span class="line">        slow = slow.next;</span><br><span class="line">        fast = fast.next.next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fast != <span class="keyword">null</span>)&#123;  <span class="comment">// 偶数节点，让 slow 指向下一个节点</span></span><br><span class="line">        slow = slow.next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cut(head, slow); <span class="comment">// 切成两个链表</span></span><br><span class="line">    ListNode l1 = head, l2 = slow;</span><br><span class="line">    l2 = reverse(l2);</span><br><span class="line">    <span class="keyword">return</span> isEqual(l1, l2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">(ListNode head, ListNode cutNode)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>( head.next != cutNode ) head = head.next;</span><br><span class="line">    head.next = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ListNode <span class="title">reverse</span><span class="params">(ListNode head)</span></span>&#123;</span><br><span class="line">    ListNode newHead = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span>(head != <span class="keyword">null</span>)&#123;</span><br><span class="line">        ListNode nextNode = head.next;</span><br><span class="line">        head.next = newHead;</span><br><span class="line">        newHead = head;</span><br><span class="line">        head = nextNode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newHead;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isEqual</span><span class="params">(ListNode l1, ListNode l2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(l1 != <span class="keyword">null</span> &amp;&amp; l2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(l1.val != l2.val) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        l1 = l1.next;</span><br><span class="line">        l2 = l2.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>从链表中删除节点</strong> </p><p><a href="">编程之美：3.4</a></p><p><br><div align="center"> <img src="../pics/2c968ec5-0967-49ce-ac06-f8f5c9ab33bc.jpg"> </div><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">B.val = C.val;</span><br><span class="line">B.next = C.next;</span><br></pre></td></tr></table></figure><p><strong>链表元素按奇偶聚集</strong> </p><p><a href="https://leetcode.com/problems/odd-even-linked-list/description/" target="_blank" rel="noopener">Leetcode : 328. Odd Even Linked List (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">oddEvenList</span><span class="params">(ListNode head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    ListNode odd = head, even = head.next, evenHead = even;</span><br><span class="line">    <span class="keyword">while</span> (even != <span class="keyword">null</span> &amp;&amp; even.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">        odd.next = odd.next.next;</span><br><span class="line">        odd = odd.next;</span><br><span class="line">        even.next = even.next.next;</span><br><span class="line">        even = even.next;</span><br><span class="line">    &#125;</span><br><span class="line">    odd.next = evenHead;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="树"><a href="#树" class="headerlink" title="树"></a>树</h2><h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><p>一棵树要么是空树，要么有两个指针，每个指针指向一棵树。树是一种递归结构，很多树的问题可以使用递归来处理。</p><p><strong>树的高度</strong> </p><p><a href="https://leetcode.com/problems/maximum-depth-of-binary-tree/description/" target="_blank" rel="noopener">Leetcode : 104. Maximum Depth of Binary Tree (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxDepth</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> Math.max(maxDepth(root.left), maxDepth(root.right)) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>翻转树</strong> </p><p><a href="https://leetcode.com/problems/invert-binary-tree/description/" target="_blank" rel="noopener">Leetcode : 226. Invert Binary Tree (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">invertTree</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    TreeNode left = root.left; <span class="comment">// 后面的操作会改变 left 指针，因此先保存下来</span></span><br><span class="line">    root.left = invertTree(root.right);</span><br><span class="line">    root.right = invertTree(left);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>归并两棵树</strong> </p><p><a href="https://leetcode.com/problems/merge-two-binary-trees/description/" target="_blank" rel="noopener">Leetcode : 617. Merge Two Binary Trees (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">mergeTrees</span><span class="params">(TreeNode t1, TreeNode t2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(t1 == <span class="keyword">null</span> &amp;&amp; t2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(t1 == <span class="keyword">null</span>) <span class="keyword">return</span> t2;</span><br><span class="line">    <span class="keyword">if</span>(t2 == <span class="keyword">null</span>) <span class="keyword">return</span> t1;</span><br><span class="line">    TreeNode root = <span class="keyword">new</span> TreeNode(t1.val + t2.val);</span><br><span class="line">    root.left = mergeTrees(t1.left, t2.left);</span><br><span class="line">    root.right = mergeTrees(t1.right, t2.right);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>判断路径和是否等于一个数</strong> </p><p><a href="https://leetcode.com/problems/path-sum/description/" target="_blank" rel="noopener">Leetcdoe : 112. Path Sum (Easy)</a></p><p>题目描述：路径和定义为从 root 到 leaf 的所有节点的和</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPathSum</span><span class="params">(TreeNode root, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(root.left == <span class="keyword">null</span> &amp;&amp; root.right == <span class="keyword">null</span> &amp;&amp; root.val == sum) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> hasPathSum(root.left, sum - root.val) || hasPathSum(root.right, sum - root.val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>统计路径和等于一个数的路径数量</strong> </p><p><a href="https://leetcode.com/problems/path-sum-iii/description/" target="_blank" rel="noopener">Leetcode : 437. Path Sum III (Easy)</a></p><p>题目描述：路径不一定以 root 开头并以 leaf 结尾，但是必须连续</p><p>pathSumStartWithRoot() 方法统计以某个节点开头的路径个数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pathSum</span><span class="params">(TreeNode root, <span class="keyword">int</span> sum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = pathSumStartWithRoot(root, sum) + pathSum(root.left, sum) + pathSum(root.right, sum);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">pathSumStartWithRoot</span><span class="params">(TreeNode root, <span class="keyword">int</span> sum)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(root.val == sum) ret++;</span><br><span class="line">    ret += pathSumStartWithRoot(root.left, sum - root.val) + pathSumStartWithRoot(root.right, sum - root.val);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>树的对称</strong> </p><p><a href="https://leetcode.com/problems/symmetric-tree/description/" target="_blank" rel="noopener">Leetcode : 101. Symmetric Tree (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSymmetric</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> isSymmetric(root.left, root.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSymmetric</span><span class="params">(TreeNode t1, TreeNode t2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(t1 == <span class="keyword">null</span> &amp;&amp; t2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(t1 == <span class="keyword">null</span> || t2 == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(t1.val != t2.val) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> isSymmetric(t1.left, t2.right) &amp;&amp; isSymmetric(t1.right, t2.left);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>平衡树</strong> </p><p><a href="https://leetcode.com/problems/balanced-binary-tree/description/" target="_blank" rel="noopener">Leetcode : 110. Balanced Binary Tree (Easy)</a></p><p>题目描述：左右子树高度差是否都小于等于 1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBalanced</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    maxDepth(root);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxDepth</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> l = maxDepth(root.left);</span><br><span class="line">    <span class="keyword">int</span> r = maxDepth(root.right);</span><br><span class="line">    <span class="keyword">if</span> (Math.abs(l - r) &gt; <span class="number">1</span>) result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + Math.max(l, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最小路径</strong> </p><p><a href="https://leetcode.com/problems/minimum-depth-of-binary-tree/description/" target="_blank" rel="noopener">Leetcode : 111. Minimum Depth of Binary Tree (Easy)</a></p><p>题目描述：树的根节点到叶子节点的最小长度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minDepth</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> left = minDepth(root.left);</span><br><span class="line">    <span class="keyword">int</span> right = minDepth(root.right);</span><br><span class="line">    <span class="keyword">if</span>(left == <span class="number">0</span> || right == <span class="number">0</span>) <span class="keyword">return</span> left + right + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> Math.min(left, right) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>统计左叶子节点的和</strong> </p><p><a href="https://leetcode.com/problems/sum-of-left-leaves/description/" target="_blank" rel="noopener">Leetcode : 404. Sum of Left Leaves (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sumOfLeftLeaves</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(isLeaf(root.left)) <span class="keyword">return</span> root.left.val +  sumOfLeftLeaves(root.right);</span><br><span class="line">    <span class="keyword">return</span> sumOfLeftLeaves(root.left) + sumOfLeftLeaves(root.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLeaf</span><span class="params">(TreeNode node)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> node.left == <span class="keyword">null</span> &amp;&amp; node.right == <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>修剪一棵树</strong> </p><p><a href="https://leetcode.com/problems/trim-a-binary-search-tree/description/" target="_blank" rel="noopener">Leetcode : 669. Trim a Binary Search Tree (Easy)</a></p><p>题目描述：只保留值在 L ~ R 之间的节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">trimBST</span><span class="params">(TreeNode root, <span class="keyword">int</span> L, <span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(root.val &gt; R) <span class="keyword">return</span> trimBST(root.left, L, R);</span><br><span class="line">    <span class="keyword">if</span>(root.val &lt; L) <span class="keyword">return</span> trimBST(root.right, L, R);</span><br><span class="line">    root.left = trimBST(root.left, L, R);</span><br><span class="line">    root.right = trimBST(root.right, L, R);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>子树</strong> </p><p><a href="https://leetcode.com/problems/subtree-of-another-tree/description/" target="_blank" rel="noopener">Leetcode : 572. Subtree of Another Tree (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSubtree</span><span class="params">(TreeNode s, TreeNode t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s == <span class="keyword">null</span> &amp;&amp; t == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(s == <span class="keyword">null</span> || t == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(s.val == t.val &amp;&amp; isSame(s, t)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> isSubtree(s.left, t) || isSubtree(s.right, t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSame</span><span class="params">(TreeNode s, TreeNode t)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(s == <span class="keyword">null</span> &amp;&amp; t == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(s == <span class="keyword">null</span> || t == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(s.val != t.val) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> isSame(s.left, t.left) &amp;&amp; isSame(s.right, t.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>从有序数组中构造二叉查找树</strong> </p><p><a href="https://leetcode.com/problems/convert-sorted-array-to-binary-search-tree/description/" target="_blank" rel="noopener">Leetcode : 108. Convert Sorted Array to Binary Search Tree (Easy)</a></p><p>二叉查找树（BST）：根节点大于等于左子树所有节点，小于等于右子树所有节点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">sortedArrayToBST</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> toBST(nums, <span class="number">0</span>, nums.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TreeNode <span class="title">toBST</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> sIdx, <span class="keyword">int</span> eIdx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(sIdx &gt; eIdx) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> mIdx = (sIdx + eIdx) / <span class="number">2</span>;</span><br><span class="line">    TreeNode root = <span class="keyword">new</span> TreeNode(nums[mIdx]);</span><br><span class="line">    root.left =  toBST(nums, sIdx, mIdx - <span class="number">1</span>);</span><br><span class="line">    root.right = toBST(nums, mIdx + <span class="number">1</span>, eIdx);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>两节点的最长路径</strong> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">          1</span><br><span class="line">        / \</span><br><span class="line">        2  3</span><br><span class="line">      / \</span><br><span class="line">      4  5</span><br><span class="line"></span><br><span class="line">Return 3, which is the length of the path [4,2,1,3] or [5,2,1,3].</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">diameterOfBinaryTree</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    depth(root);</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">depth</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> leftDepth = depth(root.left);</span><br><span class="line">    <span class="keyword">int</span> rightDepth = depth(root.right);</span><br><span class="line">    max = Math.max(max, leftDepth + rightDepth);</span><br><span class="line">    <span class="keyword">return</span> Math.max(leftDepth, rightDepth) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>找出二叉树中第二小的节点</strong> </p><p><a href="https://leetcode.com/problems/second-minimum-node-in-a-binary-tree/description/" target="_blank" rel="noopener">Leetcode : 671. Second Minimum Node In a Binary Tree (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Input:</span><br><span class="line">    2</span><br><span class="line">  / \</span><br><span class="line">  2  5</span><br><span class="line">    / \</span><br><span class="line">    5  7</span><br><span class="line"></span><br><span class="line">Output: 5</span><br></pre></td></tr></table></figure><p>一个节点要么具有 0 个或 2 个子节点，如果有子节点，那么根节点是最小的节点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findSecondMinimumValue</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(root.left == <span class="keyword">null</span> &amp;&amp; root.right == <span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> leftVal = root.left.val;</span><br><span class="line">    <span class="keyword">int</span> rightVal = root.right.val;</span><br><span class="line">    <span class="keyword">if</span>(leftVal == root.val) leftVal = findSecondMinimumValue(root.left);</span><br><span class="line">    <span class="keyword">if</span>(rightVal == root.val) rightVal = findSecondMinimumValue(root.right);</span><br><span class="line">    <span class="keyword">if</span>(leftVal != -<span class="number">1</span> &amp;&amp; rightVal != -<span class="number">1</span>) <span class="keyword">return</span> Math.min(leftVal, rightVal);</span><br><span class="line">    <span class="keyword">if</span>(leftVal != -<span class="number">1</span>) <span class="keyword">return</span> leftVal;</span><br><span class="line">    <span class="keyword">return</span> rightVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>寻找两个节点的最近公共祖先</strong> </p><p><a href="https://leetcode.com/problems/lowest-common-ancestor-of-a-binary-search-tree/description/" target="_blank" rel="noopener">Leetcode : 235. Lowest Common Ancestor of a Binary Search Tree (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode root, TreeNode p, TreeNode q)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root.val &gt; p.val &amp;&amp; root.val &gt; q.val) <span class="keyword">return</span> lowestCommonAncestor(root.left, p, q);</span><br><span class="line">    <span class="keyword">if</span>(root.val &lt; p.val &amp;&amp; root.val &lt; q.val) <span class="keyword">return</span> lowestCommonAncestor(root.right, p, q);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最近公共祖先</strong> </p><p><a href="https://leetcode.com/problems/lowest-common-ancestor-of-a-binary-tree/description/" target="_blank" rel="noopener">Leetcode : 236. Lowest Common Ancestor of a Binary Tree (Medium) </a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode root, TreeNode p, TreeNode q)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || root == p || root == q) <span class="keyword">return</span> root;</span><br><span class="line">    TreeNode left = lowestCommonAncestor(root.left, p, q);</span><br><span class="line">    TreeNode right = lowestCommonAncestor(root.right, p, q);</span><br><span class="line">    <span class="keyword">return</span> left == <span class="keyword">null</span> ? right : right == <span class="keyword">null</span> ? left : root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>最大相同节点值的路径长度</strong> </p><p><a href="https://pomotodo.com/app/" target="_blank" rel="noopener">Leetcode : 687. Longest Univalue Path (Easy)</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">              1</span><br><span class="line">            / \</span><br><span class="line">            4  5</span><br><span class="line">          / \  \</span><br><span class="line">          4  4  5</span><br><span class="line"></span><br><span class="line">Output : 2</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> path = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestUnivaluePath</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    dfs(root);</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dfs</span><span class="params">(TreeNode root)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> left = dfs(root.left);</span><br><span class="line">    <span class="keyword">int</span> right = dfs(root.right);</span><br><span class="line">    <span class="keyword">int</span> leftPath = root.left != <span class="keyword">null</span> &amp;&amp; root.left.val == root.val ? left + <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> rightPath = root.right != <span class="keyword">null</span> &amp;&amp; root.right.val == root.val ? right + <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    path = Math.max(path, leftPath + rightPath);</span><br><span class="line">    <span class="keyword">return</span> Math.max(leftPath, rightPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>间隔遍历</strong> </p><p><a href="https://leetcode.com/problems/house-robber-iii/description/" target="_blank" rel="noopener">Leetcode : 337. House Robber III (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rob</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> val1 = root.val;</span><br><span class="line">    <span class="keyword">if</span> (root.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">        val1 += rob(root.left.left) + rob(root.left.right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (root.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">        val1 += rob(root.right.left) + rob(root.right.right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> val2 = rob(root.left) + rob(root.right);</span><br><span class="line">    <span class="keyword">return</span> Math.max(val1, val2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="层次遍历"><a href="#层次遍历" class="headerlink" title="层次遍历"></a>层次遍历</h3><p>使用 BFS，不需要使用两个队列来分别存储当前层的节点和下一层的节点， 因为在开始遍历一层的节点时，当前队列中的节点数就是当前层的节点数，只要控制遍历这么多节点数，就能保证这次遍历的都是当前层的节点。</p><p><strong>计算一棵树每层节点的平均数</strong> </p><p><a href="https://leetcode.com/problems/average-of-levels-in-binary-tree/description/" target="_blank" rel="noopener">637. Average of Levels in Binary Tree (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Double&gt; <span class="title">averageOfLevels</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    List&lt;Double&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line">    <span class="keyword">while</span>(!queue.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">int</span> cnt = queue.size();</span><br><span class="line">        <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cnt; i++)&#123;</span><br><span class="line">            TreeNode node = queue.poll();</span><br><span class="line">            sum += node.val;</span><br><span class="line">            <span class="keyword">if</span>(node.left != <span class="keyword">null</span>) queue.add(node.left);</span><br><span class="line">            <span class="keyword">if</span>(node.right != <span class="keyword">null</span>) queue.add(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">        ret.add(sum / cnt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>得到左下角的节点</strong> </p><p><a href="https://leetcode.com/problems/find-bottom-left-tree-value/description/" target="_blank" rel="noopener">Leetcode : 513. Find Bottom Left Tree Value (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findBottomLeftValue</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line">    <span class="keyword">while</span>(!queue.isEmpty())&#123;</span><br><span class="line">        root = queue.poll();</span><br><span class="line">        <span class="keyword">if</span>(root.right != <span class="keyword">null</span>) queue.add(root.right);</span><br><span class="line">        <span class="keyword">if</span>(root.left != <span class="keyword">null</span>) queue.add(root.left);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root.val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="前中后序遍历"><a href="#前中后序遍历" class="headerlink" title="前中后序遍历"></a>前中后序遍历</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   1</span><br><span class="line">  / \</span><br><span class="line">  2  3</span><br><span class="line"> / \  \</span><br><span class="line">4  5  6</span><br></pre></td></tr></table></figure><p>层次遍历顺序：[1 2 3 4 5 6]<br>前序遍历顺序：[1 2 4 5 3 6]<br>中序遍历顺序：[4 2 5 1 3 6]<br>后序遍历顺序：[4 5 2 6 3 1]</p><p>层次遍历使用 BFS 实现，利用的就是 BFS 一层一层遍历的特性；而前序、中序、后序遍历利用了 DFS 实现。</p><p>前序、中序、后序遍只是在对节点访问的顺序有一点不同，其它都相同。</p><p>① 前序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(TreeNode root)</span></span>&#123;</span><br><span class="line">    visit(root);</span><br><span class="line">    dfs(root.left);</span><br><span class="line">    dfs(root.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>② 中序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(TreeNode root)</span></span>&#123;</span><br><span class="line">    dfs(root.left);</span><br><span class="line">    visit(root);</span><br><span class="line">    dfs(root.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>③ 后序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(TreeNode root)</span></span>&#123;</span><br><span class="line">    dfs(root.left);</span><br><span class="line">    dfs(root.right);</span><br><span class="line">    visit(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>非递归实现二叉树的前序遍历</strong> </p><p><a href="https://leetcode.com/problems/binary-tree-preorder-traversal/description/" target="_blank" rel="noopener">Leetcode : 144. Binary Tree Preorder Traversal (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">preorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    stack.push(root);</span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        TreeNode node = stack.pop();</span><br><span class="line">        ret.add(node.val);</span><br><span class="line">        <span class="keyword">if</span> (node.right != <span class="keyword">null</span>) stack.push(node.right);</span><br><span class="line">        <span class="keyword">if</span> (node.left != <span class="keyword">null</span>) stack.push(node.left); <span class="comment">// 先添加右子树再添加左子树，这样是为了让左子树在栈顶</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>非递归实现二叉树的后续遍历</strong> </p><p><a href="https://leetcode.com/problems/binary-tree-postorder-traversal/description/" target="_blank" rel="noopener">Leetcode : ### 145. Binary Tree Postorder Traversal (Medium)</a></p><p>前序遍历为 root -&gt; left -&gt; right，后序遍历为 left -&gt; right -&gt; root，可以修改前序遍历成为 root -&gt; right -&gt; left，那么这个顺序就和后序遍历正好相反。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">postorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> ret;</span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    stack.push(root);</span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        TreeNode node = stack.pop();</span><br><span class="line">        ret.add(node.val);</span><br><span class="line">        <span class="keyword">if</span> (node.left != <span class="keyword">null</span>) stack.push(node.left);</span><br><span class="line">        <span class="keyword">if</span> (node.right != <span class="keyword">null</span>) stack.push(node.right);</span><br><span class="line">    &#125;</span><br><span class="line">    Collections.reverse(ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>非递归实现二叉树的中序遍历</strong> </p><p><a href="https://leetcode.com/problems/binary-tree-inorder-traversal/description/" target="_blank" rel="noopener">Leetcode : 94. Binary Tree Inorder Traversal (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">inorderTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; ret = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;();</span><br><span class="line">    TreeNode cur = root;</span><br><span class="line">    <span class="keyword">while</span>(cur != <span class="keyword">null</span> || !stack.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">while</span>(cur != <span class="keyword">null</span>) &#123; <span class="comment">// 模拟递归栈的不断深入</span></span><br><span class="line">            stack.add(cur);</span><br><span class="line">            cur = cur.left;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode node = stack.pop();</span><br><span class="line">        ret.add(node.val);</span><br><span class="line">        cur = node.right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>使用中序遍历和前序遍历序列重建二叉树</strong>  //TODO</p><h3 id="BST"><a href="#BST" class="headerlink" title="BST"></a>BST</h3><p>主要利用 BST 中序遍历有序的特点。</p><p><strong>在 BST 中寻找两个节点，使它们的和为一个给定值。</strong> </p><p><a href="https://leetcode.com/problems/two-sum-iv-input-is-a-bst/description/" target="_blank" rel="noopener">653. Two Sum IV - Input is a BST</a></p><p>使用中序遍历得到有序数组之后，再利用双指针对数组进行查找。</p><p>应该注意到，这一题不能用分别在左右子树两部分来处理这种思想，因为两个待求的节点可能分别在左右子树中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">findTarget</span><span class="params">(TreeNode root, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; nums = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    inOrder(root, nums);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = nums.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j)&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = nums.get(i) + nums.get(j);</span><br><span class="line">        <span class="keyword">if</span>(sum == k) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(sum &lt; k) i++;</span><br><span class="line">        <span class="keyword">else</span> j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inOrder</span><span class="params">(TreeNode root, List&lt;Integer&gt; nums)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    inOrder(root.left, nums);</span><br><span class="line">    nums.add(root.val);</span><br><span class="line">    inOrder(root.right, nums);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在 BST 中查找最小的两个节点之差的绝对值</strong> </p><p><a href="https://leetcode.com/problems/minimum-absolute-difference-in-bst/description/" target="_blank" rel="noopener">Leetcode : 530. Minimum Absolute Difference in BST (Easy)</a></p><p>利用 BST 的中序遍历为有序的性质，计算中序遍历中临近的两个节点之差的绝对值，取最小值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> minDiff = Integer.MAX_VALUE;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> preVal = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMinimumDifference</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    inorder(root);</span><br><span class="line">    <span class="keyword">return</span> minDiff;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inorder</span><span class="params">(TreeNode node)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    inorder(node.left);</span><br><span class="line">    <span class="keyword">if</span>(preVal != -<span class="number">1</span>) minDiff = Math.min(minDiff, Math.abs(node.val - preVal));</span><br><span class="line">    preVal = node.val;</span><br><span class="line">    inorder(node.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>把 BST 每个节点的值都加上比它大的节点的值</strong> </p><p><a href="https://leetcode.com/problems/convert-bst-to-greater-tree/description/" target="_blank" rel="noopener">Leetcode : Convert BST to Greater Tree (Easy)</a></p><p>先遍历右子树。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> TreeNode <span class="title">convertBST</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    traver(root);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">traver</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (root.right != <span class="keyword">null</span>) &#123;</span><br><span class="line">        traver(root.right);</span><br><span class="line">    &#125;</span><br><span class="line">    sum += root.val;</span><br><span class="line">    root.val = sum;</span><br><span class="line">    <span class="keyword">if</span> (root.left != <span class="keyword">null</span>) &#123;</span><br><span class="line">        traver(root.left);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>寻找 BST 中出现次数最多的节点</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cnt = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> maxCnt = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> TreeNode preNode = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; list;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] findMode(TreeNode root) &#123;</span><br><span class="line">    list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    inorder(root);</span><br><span class="line">    <span class="keyword">int</span>[] ret = <span class="keyword">new</span> <span class="keyword">int</span>[list.size()];</span><br><span class="line">    <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : list)&#123;</span><br><span class="line">        ret[idx++] = num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inorder</span><span class="params">(TreeNode node)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    inorder(node.left);</span><br><span class="line">    <span class="keyword">if</span>(preNode != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preNode.val == node.val) cnt++;</span><br><span class="line">        <span class="keyword">else</span> cnt = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cnt &gt; maxCnt)&#123;</span><br><span class="line">        maxCnt = cnt;</span><br><span class="line">        list.clear();</span><br><span class="line">        list.add(node.val);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(cnt == maxCnt)&#123;</span><br><span class="line">        list.add(node.val);</span><br><span class="line">    &#125;</span><br><span class="line">    preNode = node;</span><br><span class="line">    inorder(node.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>寻找 BST 的第 k 个元素</strong> </p><p><a href="https://leetcode.com/problems/kth-smallest-element-in-a-bst/description/" target="_blank" rel="noopener">Leetcode : 230. Kth Smallest Element in a BST (Medium)</a></p><p>递归解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">kthSmallest</span><span class="params">(TreeNode root, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftCnt = count(root.left);</span><br><span class="line">    <span class="keyword">if</span>(leftCnt == k - <span class="number">1</span>) <span class="keyword">return</span> root.val;</span><br><span class="line">    <span class="keyword">if</span>(leftCnt &gt; k - <span class="number">1</span>) <span class="keyword">return</span> kthSmallest(root.left, k);</span><br><span class="line">    <span class="keyword">return</span> kthSmallest(root.right, k - leftCnt - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">(TreeNode node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + count(node.left) + count(node.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>中序遍历解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">kthSmallest</span><span class="params">(TreeNode root, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    inorder(root, k);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inorder</span><span class="params">(TreeNode node, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    inorder(node.left, k);</span><br><span class="line">    cnt++;</span><br><span class="line">    <span class="keyword">if</span>(cnt == k) &#123;</span><br><span class="line">        val = node.val;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inorder(node.right, k);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Trie"><a href="#Trie" class="headerlink" title="Trie"></a>Trie</h3><p><br><div align="center"> <img src="../pics/5c638d59-d4ae-4ba4-ad44-80bdc30f38dd.jpg"> </div><br></p><p>Trie，又称前缀树或字典树，用于判断字符串是否存在或者是否具有某种字符串前缀。</p><p><strong>实现一个 Trie</strong> </p><p><a href="https://leetcode.com/problems/implement-trie-prefix-tree/description/" target="_blank" rel="noopener">Leetcode : 208. Implement Trie (Prefix Tree) (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trie</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</span><br><span class="line">        Node[] childs = <span class="keyword">new</span> Node[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">boolean</span> isLeaf;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Node root = <span class="keyword">new</span> Node();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Initialize your data structure here. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Trie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Inserts a word into the trie. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> idx = word.charAt(<span class="number">0</span>) - <span class="string">'a'</span>;</span><br><span class="line">        insert(word, root);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String word, Node node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> idx = word.charAt(<span class="number">0</span>) - <span class="string">'a'</span>;</span><br><span class="line">        <span class="keyword">if</span>(node.childs[idx] == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node.childs[idx] = <span class="keyword">new</span> Node();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(word.length() == <span class="number">1</span>) node.childs[idx].isLeaf = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">else</span> insert(word.substring(<span class="number">1</span>), node.childs[idx]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Returns if the word is in the trie. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">search</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> search(word, root); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">search</span><span class="params">(String word, Node node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> idx = word.charAt(<span class="number">0</span>) - <span class="string">'a'</span>;</span><br><span class="line">        <span class="keyword">if</span>(node.childs[idx] == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(word.length() == <span class="number">1</span>) <span class="keyword">return</span> node.childs[idx].isLeaf;</span><br><span class="line">        <span class="keyword">return</span> search(word.substring(<span class="number">1</span>), node.childs[idx]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Returns if there is any word in the trie that starts with the given prefix. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startsWith</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startWith(prefix, root);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startWith</span><span class="params">(String prefix, Node node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(prefix.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">int</span> idx = prefix.charAt(<span class="number">0</span>) - <span class="string">'a'</span>;</span><br><span class="line">        <span class="keyword">return</span> startWith(prefix.substring(<span class="number">1</span>), node.childs[idx]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>实现一个 Trie，用来求前缀和</strong> </p><p><a href="https://leetcode.com/problems/map-sum-pairs/description/" target="_blank" rel="noopener">Leetcode : 677. Map Sum Pairs (Medium)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapSum</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Trie</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val;</span><br><span class="line">        Map&lt;Character, Trie&gt; childs;</span><br><span class="line">        <span class="keyword">boolean</span> isWord;</span><br><span class="line">        </span><br><span class="line">        Trie() &#123;</span><br><span class="line">            childs = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Trie root;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="keyword">new</span> Trie();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String key, <span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        Trie cur = root;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">char</span> c : key.toCharArray()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!cur.childs.containsKey(c)) &#123;</span><br><span class="line">                Trie next = <span class="keyword">new</span> Trie();</span><br><span class="line">                cur.childs.put(c, next);</span><br><span class="line">            &#125;</span><br><span class="line">            cur = cur.childs.get(c);</span><br><span class="line">        &#125;</span><br><span class="line">        cur.val = val;</span><br><span class="line">        cur.isWord = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sum</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">        Trie cur = root;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">char</span> c : prefix.toCharArray()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!cur.childs.containsKey(c)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            cur = cur.childs.get(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dfs(cur);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dfs</span><span class="params">(Trie cur)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(cur.isWord) &#123;</span><br><span class="line">            sum += cur.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(Trie next : cur.childs.values()) &#123;</span><br><span class="line">            sum += dfs(next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="图"><a href="#图" class="headerlink" title="图"></a>图</h2><h2 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h2><p><strong>1. 基本原理</strong> </p><p>0s 表示 一串 0 ，1s 表示一串 1。</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">x</span> ^ <span class="number">0</span>s = <span class="keyword">x</span>      <span class="keyword">x</span> &amp; <span class="number">0</span>s = <span class="number">0</span>      <span class="keyword">x</span> | <span class="number">0</span>s = <span class="keyword">x</span></span><br><span class="line"><span class="keyword">x</span> ^ <span class="number">1</span>s = ~<span class="keyword">x</span>     <span class="keyword">x</span> &amp; <span class="number">1</span>s = <span class="keyword">x</span>      <span class="keyword">x</span> | <span class="number">1</span>s = <span class="number">1</span>s</span><br><span class="line"><span class="keyword">x</span> ^ <span class="keyword">x</span> = <span class="number">0</span>       <span class="keyword">x</span> &amp; <span class="keyword">x</span> = <span class="keyword">x</span>       <span class="keyword">x</span> | <span class="keyword">x</span> = <span class="keyword">x</span></span><br></pre></td></tr></table></figure><p>① 利用 x ^ 1s = ~x 的特点，可以将位级表示翻转；利用 x ^ x = 0 的特点，可以将三个数中重复的两个数去除，只留下另一个数；<br>② 利用 x &amp; 0s = 0 和 x &amp; 1s = x 的特点，可以实现掩码操作。一个数 num 与 mask ：00111100 进行位与操作，只保留 num 中与 mask 的 1 部分相对应的位；<br>③ 利用 x | 0s = x 和 x | 1s = 1s 的特点，可以实现设置操作。一个数 num 与 mask：00111100 进行位或操作，将 num 中与 mask 的 1 部分相对应的位都设置为 1 。</p><p>>> n 为算术右移，相当于除以 2<sup>n</sup>；<br>>>> n 为无符号右移，左边会补上 0。<br>&lt;&lt; n 为算术左移，相当于乘以 2<sup>n</sup>。</p><p>n&amp;(n-1) 该位运算是去除 n 的位级表示中最低的那一位。例如对于二进制表示 10110 <strong>100</strong> ，减去 1 得到 10110<strong>011</strong>，这两个数相与得到 10110<strong>000</strong>。</p><p>n-n&amp;(~n+1) 概运算是去除 n 的位级表示中最高的那一位。</p><p>n&amp;(-n) 该运算得到 n 的位级表示中最低的那一位。-n 得到 n 的反码加 1，对于二进制表示 10110 <strong>100</strong> ，-n 得到 01001<strong>100</strong>，相与得到 00000<strong>100</strong></p><p><strong>2. mask 计算</strong> </p><p>要获取 111111111，将 0 取反即可，~0。</p><p>要得到只有第 i 位为 1 的 mask，将 1 向左移动 i 位即可，1&lt;&lt;i 。例如 1&lt;&lt;5 得到只有第 5 位为 1 的 mask ：00010000。</p><p>要得到 1 到 i 位为 1 的 mask，1&lt;&lt;(i+1)-1 即可，例如将 1&lt;&lt;(4+1)-1 = 00010000-1 = 00001111。</p><p>要得到 1 到 i 位为 0 的 mask，只需将 1 到 i 位为 1 的 mask 取反，即 ~(1&lt;&lt;(i+1)-1)。</p><p><strong>3. 位操作举例</strong> </p><p>① 获取第 i 位</p><p>num &amp; 00010000 != 0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(num &amp; (<span class="number">1</span> &lt;&lt; i)) != <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>② 将第 i 位设置为 1</p><p>num | 00010000</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num | (<span class="number">1</span> &lt;&lt; i);</span><br></pre></td></tr></table></figure><p>③ 将第 i 位清除为 0</p><p>num &amp; 11101111</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num &amp; (~(<span class="number">1</span> &lt;&lt; i))</span><br></pre></td></tr></table></figure><p>④ 将最高位到第 i 位清除为 0</p><p>num &amp; 00001111</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num &amp; ((<span class="number">1</span> &lt;&lt; i) - <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>⑤ 将第 0 位到第 i 位清除为 0</p><p>num &amp; 11110000</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num &amp; (~((<span class="number">1</span> &lt;&lt; (i+<span class="number">1</span>)) - <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>⑥ 将第 i 位设置为 0 或者 1</p><p>先将第 i 位清零，然后将 v 左移 i 位，执行“位或”运算。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(num &amp; (<span class="number">1</span> &lt;&lt; i)) | (v &lt;&lt; i);</span><br></pre></td></tr></table></figure><p><strong>4. Java 中的位操作</strong> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static int Integer.bitCount()            // 统计 1 的数量</span><br><span class="line">static int Integer.highestOneBit()       // 获得最高位</span><br><span class="line">static String toBinaryString(int i)      // 转换位二进制表示的字符串</span><br></pre></td></tr></table></figure><p><strong>统计两个数的二进制表示有多少位不同</strong> </p><p><a href="https://leetcode.com/problems/hamming-distance/" target="_blank" rel="noopener">Leetcode : 461. Hamming Distance (Easy)</a></p><p>对两个数进行异或操作，不同的那一位结果为 1 ，统计有多少个 1 即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hammingDistance</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> z = x ^ y;</span><br><span class="line">    <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(z != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>((z &amp; <span class="number">1</span>) == <span class="number">1</span>) cnt++;</span><br><span class="line">        z = z &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以使用 Integer.bitcount() 来统计 1 个的个数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hammingDistance</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.bitCount(x ^ y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>翻转一个数的比特位</strong> </p><p><a href="https://leetcode.com/problems/reverse-bits/description/" target="_blank" rel="noopener">Leetcode : 190. Reverse Bits (Easy)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reverseBits</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)&#123;</span><br><span class="line">        ret &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        ret |= (n &amp; <span class="number">1</span>);</span><br><span class="line">        n &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>不用额外变量交换两个整数</strong> </p><p><a href="#">程序员代码面试指南 ：P317</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = a ^ b;</span><br><span class="line">b = a ^ b;</span><br><span class="line">a = a ^ b;</span><br></pre></td></tr></table></figure><p>将 c = a ^ b，那么 b ^ c = b ^ b ^ a = a，a ^ c = a ^ a ^ b = b。</p><p><strong>判断一个数是不是 4 的 n 次方</strong> </p><p><a href="https://leetcode.com/problems/power-of-four/" target="_blank" rel="noopener">Leetcode : 342. Power of Four (Easy)</a></p><p>该数二进制表示有且只有一个奇数位为 1 ，其余的都为 0 ，例如 16 ： 10000。可以每次把 1 向左移动 2 位，就能构造出这种数字，然后比较构造出来的数与要判断的数是否相同。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerOfFour</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i == num) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        i = i &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以用 Java 的 Integer.toString() 方法将该数转换为 4 进制形式的字符串，然后判断字符串是否以 1 开头。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerOfFour</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.toString(num, <span class="number">4</span>).matches(<span class="string">"10*"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>判断一个数是不是 2 的 n 次方</strong> </p><p><a href="https://leetcode.com/problems/power-of-two/description/" target="_blank" rel="noopener">Leetcode : 231. Power of Two (Easy)</a></p><p>同样可以用 Power of Four 的方法，但是 2 的 n 次方更特殊，它的二进制表示只有一个 1 存在。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerOfTwo</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n &gt; <span class="number">0</span> &amp;&amp; Integer.bitCount(n) == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用 1000 &amp; 0111 == 0 这种性质，得到以下解法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerOfTwo</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n &gt; <span class="number">0</span> &amp;&amp; (n &amp; (n - <span class="number">1</span>)) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数组中唯一一个不重复的元素</strong> </p><p><a href="https://leetcode.com/problems/single-number/description/" target="_blank" rel="noopener">Leetcode : 136. Single Number (Easy)</a></p><p>两个相同的数异或的结果为 0，对所有数进行异或操作，最后的结果就是单独出现的那个数。</p><p>类似的有：<a href="https://leetcode.com/problems/find-the-difference/description/" target="_blank" rel="noopener">Leetcode : 389. Find the Difference (Easy)</a>，两个字符串仅有一个字符不相同，使用异或操作可以以 O(1) 的空间复杂度来求解，而不需要使用 HashSet。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">singleNumber</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n : nums) ret = ret ^ n;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数组中不重复的两个元素</strong> </p><p><a href="https://leetcode.com/problems/single-number-iii/description/" target="_blank" rel="noopener">Leetcode : 260. Single Number III (Medium)</a></p><p>两个不相等的元素在位级表示上必定会有一位存在不同。</p><p>将数组的所有元素异或得到的结果为不存在重复的两个元素异或的结果。</p><p>diff &amp;= -diff 得到出 diff 最右侧不为 0 的位，也就是不存在重复的两个元素在位级表示上最右侧不同的那一位，利用这一位就可以将两个元素区分开来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] singleNumber(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">    <span class="keyword">int</span> diff = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : nums) diff ^= num;</span><br><span class="line">    <span class="comment">// 得到最右一位</span></span><br><span class="line">    diff &amp;= -diff;</span><br><span class="line">    <span class="keyword">int</span>[] ret = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> num : nums) &#123;</span><br><span class="line">        <span class="keyword">if</span>((num &amp; diff) == <span class="number">0</span>) ret[<span class="number">0</span>] ^= num;</span><br><span class="line">        <span class="keyword">else</span> ret[<span class="number">1</span>] ^= num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>判断一个数的位级表示是否不会出现连续的 0 和 1</strong> </p><p><a href="https://leetcode.com/problems/binary-number-with-alternating-bits/description/" target="_blank" rel="noopener">Leetcode : 693. Binary Number with Alternating Bits (Easy)</a></p><p>对于 10101 这种位级表示的数，把它向右移动 1 位得到 1010 ，这两个数每个位都不同，因此异或得到的结果为 11111。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasAlternatingBits</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = (n ^ (n &gt;&gt; <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> (a &amp; (a + <span class="number">1</span>)) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>求一个数的补码</strong> </p><p><a href="https://leetcode.com/problems/number-complement/description/" target="_blank" rel="noopener">Leetcode : 476. Number Complement (Easy)</a></p><p>不考虑二进制表示中的首 0 部分</p><p>对于 00000101，要求补码可以将它与 00000111 进行异或操作。那么问题就转换为求掩码 00000111。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findComplement</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(num == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> mask = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">while</span>((num &amp; mask) == <span class="number">0</span>) mask &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    mask = (mask &lt;&lt; <span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> num ^ mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以利用 Java 的 Integer.highestOneBit() 方法来获得含有首 1 的数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findComplement</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(num == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> mask = Integer.highestOneBit(num);</span><br><span class="line">    mask = (mask &lt;&lt; <span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> num ^ mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于 10000000 这样的数要扩展成 11111111，可以利用以下方法：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mask |= mask &gt;&gt; 1    11000000</span><br><span class="line">mask |= mask &gt;&gt; 2    11110000</span><br><span class="line">mask |= mask &gt;&gt; 4    11111111</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findComplement</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mask = num;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (mask ^ num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>实现整数的加法</strong> </p><p><a href="https://leetcode.com/problems/sum-of-two-integers/description/" target="_blank" rel="noopener">Leetcode : 371. Sum of Two Integers (Easy)</a></p><p>a ^ b 表示没有考虑进位的情况下两数的和，(a &amp; b) &lt;&lt; 1 就是进位。递归会终止的原因是 (a &amp; b) &lt;&lt; 1 最右边会多一个 0，那么继续递归，进位最右边的 0 会慢慢增多，最后进位会变为 0，递归终止。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> b == <span class="number">0</span> ? a : getSum((a ^ b), (a &amp; b) &lt;&lt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>字符串数组最大乘积</strong> </p><p><a href="https://leetcode.com/problems/maximum-product-of-word-lengths/description/" target="_blank" rel="noopener">Leetcode : 318. Maximum Product of Word Lengths (Medium)</a></p><p>题目描述：字符串数组的字符串只含有小写字符。求解字符串数组中两个字符串长度的最大乘积，要求这两个字符串不能含有相同字符。</p><p>解题思路：本题主要问题是判断两个字符串是否含相同字符，由于字符串只含有小写字符，总共 26 位，因此可以用一个 32 位的整数来存储每个字符是否出现过。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxProduct</span><span class="params">(String[] words)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = words.length;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>[] val = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : words[i].toCharArray()) &#123;</span><br><span class="line">            val[i] |= <span class="number">1</span> &lt;&lt; (c - <span class="string">'a'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((val[i] &amp; val[j]) == <span class="number">0</span>) &#123;</span><br><span class="line">                ret = Math.max(ret, words[i].length() * words[j].length());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://leetcode.com/problemset/algorithms/?status=Todo" target="_blank" rel="noopener">Leetcode</a></li><li>Weiss M A, 冯舜玺. 数据结构与算法分析——C 语言描述[J]. 2004.</li><li>Sedgewick R. Algorithms[M]. Pearson Education India, 1988.</li><li>何海涛, 软件工程师. 剑指 Offer: 名企面试官精讲典型编程题[M]. 电子工业出版社, 2014.</li><li>《编程之美》小组. 编程之美[M]. 电子工业出版社, 2008.</li><li>左程云. 程序员代码面试指南[M]. 电子工业出版社, 2015.</li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#算法思想&quot;&gt;算法思想&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#二分查找&quot;&gt;二分查找&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#贪心思想&quot;&gt;贪心思想&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#双指针&quot;&gt;双指针&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#排序&quot;&gt;排序&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#快速选择&quot;&gt;快速选择&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#堆排序&quot;&gt;堆排序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#桶排序&quot;&gt;桶排序&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#搜索&quot;&gt;搜索&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#bfs&quot;&gt;BFS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#dfs&quot;&gt;DFS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#backtracking&quot;&gt;Backtracking&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分治&quot;&gt;分治&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#动态规划&quot;&gt;动态规划&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#分割整数&quot;&gt;分割整数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#矩阵路径&quot;&gt;矩阵路径&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#斐波那契数列&quot;&gt;斐波那契数列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#最长递增子序列&quot;&gt;最长递增子序列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#最长公共子系列&quot;&gt;最长公共子系列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#0-1-背包&quot;&gt;0-1 背包&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#数组区间&quot;&gt;数组区间&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#字符串编辑&quot;&gt;字符串编辑&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#其它问题&quot;&gt;其它问题&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#数学&quot;&gt;数学&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#素数&quot;&gt;素数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#最大公约数&quot;&gt;最大公约数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#进制转换&quot;&gt;进制转换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#阶乘&quot;&gt;阶乘&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#字符串加法减法&quot;&gt;字符串加法减法&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#相遇问题&quot;&gt;相遇问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#多数投票问题&quot;&gt;多数投票问题&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#其它&quot;&gt;其它&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#数据结构相关&quot;&gt;数据结构相关&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#栈和队列&quot;&gt;栈和队列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#哈希表&quot;&gt;哈希表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#字符串&quot;&gt;字符串&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#数组与矩阵&quot;&gt;数组与矩阵&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#有序矩阵&quot;&gt;有序矩阵&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#链表&quot;&gt;链表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#树&quot;&gt;树&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#递归&quot;&gt;递归&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#层次遍历&quot;&gt;层次遍历&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#前中后序遍历&quot;&gt;前中后序遍历&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bst&quot;&gt;BST&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#trie&quot;&gt;Trie&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#图&quot;&gt;图&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#位运算&quot;&gt;位运算&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;算法思想&quot;&gt;&lt;a href=&quot;#算法思想&quot; class=&quot;headerlink&quot; title=&quot;算法思想&quot;&gt;&lt;/a&gt;算法思想&lt;/h1&gt;&lt;h2 id=&quot;二分查找&quot;&gt;&lt;a href=&quot;#二分查找&quot; class=&quot;headerlink&quot; title=&quot;二分查找&quot;&gt;&lt;/a&gt;二分查找&lt;/h2&gt;&lt;p&gt;二分查找思想简单，但是在实现时有一些需要注意的细节：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;在计算 mid 时不能使用 mid = (l + h) / 2 这种方式，因为 l + h 可能会导致加法溢出，应该使用 mid = l + (h - l) / 2。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;对 h 的赋值和循环条件有关，当循环条件为 l &amp;lt;= h 时，h = mid - 1；当循环条件为 l &amp;lt; h 时，h = mid。&lt;br&gt;解释如下：在循环条件为 l &amp;lt;= h 时，如果 h = mid，会出现循环无法退出的情况，例如 l = 1，h = 1，此时 mid 也等于 1，如果此时继续执行 h = mid，那么就会无限循环；在循环条件为 l &amp;lt; h，如果 h = mid - 1，会错误跳过查找的数，例如对于数组 [1,2,3]，要查找 1，最开始 l = 0，h = 2，mid = 1，判断 key &amp;lt; arr[mid] 执行 h = mid - 1 = 0，此时循环退出，直接把查找的数跳过了。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>Java 容器</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/Java%20%E5%AE%B9%E5%99%A8.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/Java 容器.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T10:08:53.000Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#概览">概览</a><ul><li><a href="#1-list">1. List</a></li><li><a href="#2-set">2. Set</a></li><li><a href="#3-queue">3. Queue</a></li><li><a href="#4-map">4. Map</a></li><li><a href="#5-java-1011-容器">5. Java 1.0/1.1 容器</a></li></ul></li><li><a href="#容器中的设计模式">容器中的设计模式</a><ul><li><a href="#1-迭代器模式">1. 迭代器模式</a></li><li><a href="#2-适配器模式">2. 适配器模式</a></li></ul></li><li><a href="#散列">散列</a></li><li><a href="#源码分析">源码分析</a><ul><li><a href="#1-arralist">1. ArraList</a></li><li><a href="#2-vector-与-stack">2. Vector 与 Stack</a></li><li><a href="#3-linkedlist">3. LinkedList</a></li><li><a href="#4-treemap">4. TreeMap</a></li><li><a href="#5-hashmap">5. HashMap</a></li><li><a href="#6-linkedhashmap">6. LinkedHashMap</a></li><li><a href="#7-concurrenthashmap">7. ConcurrentHashMap</a></li></ul></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h1><p><br><div align="center"> <img src="/pics/ebf03f56-f957-4435-9f8f-0f605661484d.jpg"> </div><br></p><p>容器主要包括 Collection 和 Map 两种，Collection 又包含了 List、Set 以及 Queue。</p><h2 id="1-List"><a href="#1-List" class="headerlink" title="1. List"></a>1. List</h2><ul><li><p>ArrayList：基于动态数组实现，支持随机访问；</p></li><li><p>LinkedList：基于双向循环链表实现，只能顺序访问，但是可以快速地在链表中间插入和删除元素。不仅如此，LinkedList 还可以用作栈、队列和双端队列。</p></li></ul><a id="more"></a><h2 id="2-Set"><a href="#2-Set" class="headerlink" title="2. Set"></a>2. Set</h2><ul><li><p>HashSet：基于 Hash 实现，支持快速查找，但是失去有序性；</p></li><li><p>TreeSet：基于红黑树实现，保持有序，但是查找效率不如 HashSet；</p></li><li><p>LinkedHashSet：具有 HashSet 的查找效率，且内部使用链表维护元素的插入顺序，因此具有有序性。</p></li></ul><h2 id="3-Queue"><a href="#3-Queue" class="headerlink" title="3. Queue"></a>3. Queue</h2><p>只有两个实现：LinkedList 和 PriorityQueue，其中 LinkedList 支持双向队列，PriorityQueue 是基于堆结构实现。</p><h2 id="4-Map"><a href="#4-Map" class="headerlink" title="4. Map"></a>4. Map</h2><ul><li><p>HashMap：基于 Hash 实现</p></li><li><p>LinkedHashMap：使用链表来维护元素的顺序，顺序为插入顺序或者最近最少使用（LRU）顺序</p></li><li><p>TreeMap：基于红黑树实现</p></li><li><p>ConcurrentHashMap：线程安全 Map，不涉及类似于 HashTable 的同步加锁</p></li></ul><h2 id="5-Java-1-0-1-1-容器"><a href="#5-Java-1-0-1-1-容器" class="headerlink" title="5. Java 1.0/1.1 容器"></a>5. Java 1.0/1.1 容器</h2><p>对于旧的容器，我们决不应该使用它们，只需要对它们进行了解。</p><ul><li><p>Vector：和 ArrayList 类似，但它是线程安全的</p></li><li><p>HashTable：和 HashMap 类似，但它是线程安全的</p></li></ul><h1 id="容器中的设计模式"><a href="#容器中的设计模式" class="headerlink" title="容器中的设计模式"></a>容器中的设计模式</h1><h2 id="1-迭代器模式"><a href="#1-迭代器模式" class="headerlink" title="1. 迭代器模式"></a>1. 迭代器模式</h2><p>从概览图可以看到，每个集合类都有一个 Iterator 对象，可以通过这个迭代器对象来遍历集合中的元素。</p><p><a href="https://github.com/CyC2018/InterviewNotes/blob/master/notes/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.md#92-java-%E5%86%85%E7%BD%AE%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8" target="_blank" rel="noopener">Java 中的迭代器模式 </a></p><h2 id="2-适配器模式"><a href="#2-适配器模式" class="headerlink" title="2. 适配器模式"></a>2. 适配器模式</h2><p>java.util.Arrays#asList() 可以把数组类型转换为 List 类型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">list = Arrays.asList(arr);</span><br></pre></td></tr></table></figure><h1 id="散列"><a href="#散列" class="headerlink" title="散列"></a>散列</h1><p>使用 hasCode() 来返回散列值，使用的是对象的地址。</p><p>而 equals() 是用来判断两个对象是否相等的，相等的两个对象散列值一定要相同，但是散列值相同的两个对象不一定相等。</p><p>相等必须满足以下五个性质：</p><ol><li>自反性</li><li>对称性</li><li>传递性</li><li>一致性（多次调用 x.equals(y)，结果不变）</li><li>对任何不是 null 的对象 x 调用 x.equals(nul) 结果都为 false</li></ol><h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>建议先阅读 <a href="https://github.com/CyC2018/InterviewNotes/blob/master/notes/%E7%AE%97%E6%B3%95.md#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E6%9F%A5%E6%89%BE" target="_blank" rel="noopener"> 算法 - 查找 </a> 部分，对集合类源码的理解有很大帮助。</p><p>源码下载：<a href="http://download.java.net/openjdk/jdk7" target="_blank" rel="noopener">OpenJDK 1.7</a></p><h2 id="1-ArraList"><a href="#1-ArraList" class="headerlink" title="1. ArraList"></a>1. ArraList</h2><p><a href="https://github.com/CyC2018/JDK-Source-Code/tree/master/src/ArrayList.java" target="_blank" rel="noopener">ArraList.java</a></p><p>实现了 RandomAccess 接口，因此支持随机访问，这是理所当然的，因为 ArrayList 是基于数组实现的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure><p>基于数组实现，保存元素的数组使用 transient 修饰，这是因为该数组不一定所有位置都占满元素，因此也就没必要全部都进行序列化。需要重写 writeObject() 和 readObject()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Object[] elementData;</span><br></pre></td></tr></table></figure><p>数组的默认大小为 10</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+ initialCapacity);</span><br><span class="line">    <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>删除元素时调用 System.arraycopy() 对元素进行复制，因此删除操作成本很高，最好在创建时就指定大概的容量大小，减少复制操作的执行次数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index, numMoved);</span><br><span class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// Let gc do its work</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加元素时使用 ensureCapacity() 方法来保证容量足够，如果不够时，需要进行扩容，使得新容量为旧容量的 1.5 倍。</p><p>modCount 用来记录 ArrayList 发生变化的次数，因为每次在进行 add() 和 addAll() 时都需要调用 ensureCapacity()，因此直接在 ensureCapacity() 中对 modCount 进行修改。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ensureCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &gt; <span class="number">0</span>)</span><br><span class="line">        ensureCapacityInternal(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">        Integer.MAX_VALUE :</span><br><span class="line">        MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在进行序列化或者迭代等操作时，需要比较操作前后 modCount 是否改变，如果改变了需要抛出 ConcurrentModificationException。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException</span>&#123;</span><br><span class="line">    <span class="comment">// Write out element count, and any hidden stuff</span></span><br><span class="line">    <span class="keyword">int</span> expectedModCount = modCount;</span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out array length</span></span><br><span class="line">    s.writeInt(elementData.length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++)</span><br><span class="line">        s.writeObject(elementData[i]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (modCount != expectedModCount) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>和 Vector 的区别</strong> </p><ol><li>Vector 和 ArrayList 几乎是完全相同的，唯一的区别在于 Vector 是同步的，因此开销就比 ArrayList 要大，访问要慢。最好使用 ArrayList 而不是 Vector，因为同步完全可以由程序员自己来控制；</li><li>Vector 每次扩容请求其大小的 2 倍空间，而 ArrayList 是 1.5 倍。</li></ol><p>为了使用线程安全的 ArrayList，可以使用 Collections.synchronizedList(new ArrayList&lt;&gt;()); 返回一个线程安全的 ArrayList，也可以使用 concurrent 并发包下的 CopyOnWriteArrayList 类；</p><p><strong>和 LinkedList 的区别</strong> </p><ol><li>ArrayList 基于动态数组实现，LinkedList 基于双向循环链表实现；</li><li>ArrayList 支持随机访问，LinkedList 不支持；</li><li>LinkedList 在任意位置添加删除元素更快。</li></ol><h2 id="2-Vector-与-Stack"><a href="#2-Vector-与-Stack" class="headerlink" title="2. Vector 与 Stack"></a>2. Vector 与 Stack</h2><p><a href="https://github.com/CyC2018/JDK-Source-Code/tree/master/src/Vector.java" target="_blank" rel="noopener">Vector.java</a></p><h2 id="3-LinkedList"><a href="#3-LinkedList" class="headerlink" title="3. LinkedList"></a>3. LinkedList</h2><p><a href="https://github.com/CyC2018/JDK-Source-Code/tree/master/src/LinkedList.java" target="_blank" rel="noopener">LinkedList.java</a></p><h2 id="4-TreeMap"><a href="#4-TreeMap" class="headerlink" title="4. TreeMap"></a>4. TreeMap</h2><p><a href="https://github.com/CyC2018/JDK-Source-Code/tree/master/src/TreeMap.java" target="_blank" rel="noopener">TreeMap.java</a></p><h2 id="5-HashMap"><a href="#5-HashMap" class="headerlink" title="5. HashMap"></a>5. HashMap</h2><p><a href="https://github.com/CyC2018/JDK-Source-Code/tree/master/src/HashMap.java" target="_blank" rel="noopener">HashMap.java</a></p><p>使用拉链法来解决冲突。</p><p>默认容量 capacity 为 16，需要注意的是容量必须保证为 2 的次方。容量就是 Entry[] table 数组的长度，size 是数组的实际使用量。</p><p>threshold 规定了一个 size 的临界值，size 必须小于 threshold，如果大于等于，就必须进行扩容操作。</p><p>threshold = capacity * load_factor，其中 load_factor 为 table 数组能够使用的比例，load_factor 过大会导致聚簇的出现，从而影响查询和插入的效率，详见算法笔记。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> Entry[] table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> threshold;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;</span><br></pre></td></tr></table></figure><p>从下面的添加元素代码中可以看出，当需要扩容时，令 capacity 为原来的两倍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    <span class="keyword">if</span> (size++ &gt;= threshold)</span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Entry 用来表示一个键值对元素，其中的 next 指针在序列化时会使用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get() 操作需要分成两种情况，key 为 null 和 不为 null，从中可以看出 HashMap 允许插入 null 作为键。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> getForNullKey();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[indexFor(hash, table.length)]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</span><br><span class="line">            <span class="keyword">return</span> e.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>put() 操作也需要根据 key 是否为 null 做不同的处理，需要注意的是如果本来没有 key 为 null 的键值对，新插入一个 key 为 null 的键值对时默认是放在数组的 0 位置，这是因为 null 不能计算 hash 值，也就无法知道应该放在哪个链表上。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> V <span class="title">putForNullKey</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(<span class="number">0</span>, <span class="keyword">null</span>, value, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-LinkedHashMap"><a href="#6-LinkedHashMap" class="headerlink" title="6. LinkedHashMap"></a>6. LinkedHashMap</h2><p><a href="https://github.com/CyC2018/JDK-Source-Code/tree/master/src/HashMap.java" target="_blank" rel="noopener">LinkedHashMap.java</a></p><h2 id="7-ConcurrentHashMap"><a href="#7-ConcurrentHashMap" class="headerlink" title="7. ConcurrentHashMap"></a>7. ConcurrentHashMap</h2><p><a href="https://github.com/CyC2018/JDK-Source-Code/tree/master/src/HashMap.java" target="_blank" rel="noopener">ConcurrentHashMap.java</a></p><p><a href="https://www.ibm.com/developerworks/cn/java/java-lo-concurrenthashmap/" target="_blank" rel="noopener"> 探索 ConcurrentHashMap 高并发性的实现机制 </a></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>Java 编程思想</li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#概览&quot;&gt;概览&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-list&quot;&gt;1. List&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-set&quot;&gt;2. Set&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-queue&quot;&gt;3. Queue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-map&quot;&gt;4. Map&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-java-1011-容器&quot;&gt;5. Java 1.0/1.1 容器&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#容器中的设计模式&quot;&gt;容器中的设计模式&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-迭代器模式&quot;&gt;1. 迭代器模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-适配器模式&quot;&gt;2. 适配器模式&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#散列&quot;&gt;散列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#源码分析&quot;&gt;源码分析&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-arralist&quot;&gt;1. ArraList&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-vector-与-stack&quot;&gt;2. Vector 与 Stack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-linkedlist&quot;&gt;3. LinkedList&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-treemap&quot;&gt;4. TreeMap&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-hashmap&quot;&gt;5. HashMap&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-linkedhashmap&quot;&gt;6. LinkedHashMap&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-concurrenthashmap&quot;&gt;7. ConcurrentHashMap&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;概览&quot;&gt;&lt;a href=&quot;#概览&quot; class=&quot;headerlink&quot; title=&quot;概览&quot;&gt;&lt;/a&gt;概览&lt;/h1&gt;&lt;p&gt;&lt;br&gt;&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;/pics/ebf03f56-f957-4435-9f8f-0f605661484d.jpg&quot;&gt; &lt;/div&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;容器主要包括 Collection 和 Map 两种，Collection 又包含了 List、Set 以及 Queue。&lt;/p&gt;
&lt;h2 id=&quot;1-List&quot;&gt;&lt;a href=&quot;#1-List&quot; class=&quot;headerlink&quot; title=&quot;1. List&quot;&gt;&lt;/a&gt;1. List&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ArrayList：基于动态数组实现，支持随机访问；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;LinkedList：基于双向循环链表实现，只能顺序访问，但是可以快速地在链表中间插入和删除元素。不仅如此，LinkedList 还可以用作栈、队列和双端队列。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>Java 并发</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/Java%20%E5%B9%B6%E5%8F%91.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/Java 并发.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:33:12.384Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#使用线程">使用线程</a><ul><li><a href="#1-实现-runnable-接口">1. 实现 Runnable 接口</a></li><li><a href="#2-实现-callable-接口">2. 实现 Callable 接口</a></li><li><a href="#3-继承-tread-类">3. 继承 Tread 类</a></li><li><a href="#4-实现接口-vs-继承-thread">4. 实现接口 vs 继承 Thread</a></li></ul></li><li><a href="#executor">Executor</a></li><li><a href="#基础线程机制">基础线程机制</a><ul><li><a href="#1-sleep">1. sleep()</a></li><li><a href="#2-yield">2. yield()</a></li><li><a href="#3-join">3. join()</a></li><li><a href="#4-deamon">4. deamon</a></li></ul></li><li><a href="#线程之间的协作">线程之间的协作</a><ul><li><a href="#1-线程通信">1. 线程通信</a></li><li><a href="#2-线程同步">2. 线程同步</a><ul><li><a href="#21-synchronized">2.1 synchronized</a></li><li><a href="#22-lock">2.2 Lock</a></li><li><a href="#23-blockingqueue">2.3 BlockingQueue</a></li></ul></li></ul></li><li><a href="#线程状态">线程状态</a></li><li><a href="#结束线程">结束线程</a><ul><li><a href="#1-阻塞">1. 阻塞</a></li><li><a href="#2-中断">2. 中断</a></li></ul></li><li><a href="#原子性">原子性</a></li><li><a href="#volatile">volatile</a><ul><li><a href="#1-内存可见性">1. 内存可见性</a></li><li><a href="#2-禁止指令重排">2. 禁止指令重排</a></li></ul></li><li><a href="#多线程开发良好的实践">多线程开发良好的实践</a></li><li><a href="#未完待续">未完待续</a></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="使用线程"><a href="#使用线程" class="headerlink" title="使用线程"></a>使用线程</h1><p>有三种使用线程的方法：</p><ol><li>实现 Runnable 接口；</li><li>实现 Callable 接口；</li><li>继承 Tread 类；</li></ol><p>实现 Runnable 和 Callable 接口的类只能当做一个可以在线程中运行的任务，不是真正意义上的线程，因此最后还需要通过 Thread 来调用。可以说任务是通过线程驱动从而执行的。</p><h2 id="1-实现-Runnable-接口"><a href="#1-实现-Runnable-接口" class="headerlink" title="1. 实现 Runnable 接口"></a>1. 实现 Runnable 接口</h2><p>需要实现 run() 方法</p><p>通过 Thread 调用 start() 方法来启动线程</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MyRunnable instance = <span class="keyword">new</span> MyRunnable();</span><br><span class="line">        Tread thread = <span class="keyword">new</span> Thread(instance);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-实现-Callable-接口"><a href="#2-实现-Callable-接口" class="headerlink" title="2. 实现 Callable 接口"></a>2. 实现 Callable 接口</h2><p>与 Runnable 相比，Callable 可以有返回值，返回值通过 FutureTask 进行封装。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="class"><span class="keyword">class</span>  <span class="title">MyCallable</span>  <span class="keyword">implements</span>  <span class="title">Callable</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">static</span>  <span class="keyword">void</span>  <span class="title">main</span><span class="params">(String[]  args)</span> </span>&#123;</span><br><span class="line">        MyCallable mc = <span class="keyword">new</span> MyCallable();</span><br><span class="line">        FutureTask&lt;Integer&gt; ft = <span class="keyword">new</span> FutureTask&lt;&gt;(mc);</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(ft);</span><br><span class="line">        thread.start();</span><br><span class="line">        System.out.println(ft.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-继承-Tread-类"><a href="#3-继承-Tread-类" class="headerlink" title="3. 继承 Tread 类"></a>3. 继承 Tread 类</h2><p>同样也是需要实现 run() 方法，并且最后也是调用 start() 方法来启动线程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">static</span>  <span class="keyword">void</span>  <span class="title">main</span><span class="params">(String[]  args)</span> </span>&#123;</span><br><span class="line">        MyThread mt = <span class="keyword">new</span> MyThread();</span><br><span class="line">        mt.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-实现接口-vs-继承-Thread"><a href="#4-实现接口-vs-继承-Thread" class="headerlink" title="4. 实现接口 vs 继承 Thread"></a>4. 实现接口 vs 继承 Thread</h2><p>实现接口会更好一些，因为：</p><ol><li>Java 不支持多重继承，因此继承了 Thread 类就无法继承其它类，但是可以实现多个接口。</li><li>类可能只要求可执行即可，继承整个 Thread 类开销会过大。</li></ol><h1 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h1><p>Executor 管理多个异步任务的执行，而无需程序员显示地管理线程的生命周期。</p><p>主要有三种 Excutor：</p><ol><li>CachedTreadPool：一个任务创建一个线程；</li><li>FixedThreadPool：所有任务只能使用固定大小的线程；</li><li>SingleThreadExecutor：相当于大小为 1 的 FixedThreadPool。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    exec.execute(<span class="keyword">new</span> MyRunnable());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="基础线程机制"><a href="#基础线程机制" class="headerlink" title="基础线程机制"></a>基础线程机制</h1><h2 id="1-sleep"><a href="#1-sleep" class="headerlink" title="1. sleep()"></a>1. sleep()</h2><p><strong>Thread.sleep(millisec)</strong>  方法会休眠当前正在执行的线程，millisec 单位为毫秒。也可以使用 TimeUnit.TILLISECONDS.sleep(millisec)。</p><p>sleep() 可能会抛出 InterruptedException。因为异常不能跨线程传播回 main() 中，因此必须在本地进行处理。线程中抛出的其它异常也同样需要在本地进行处理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">        System.err.println(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-yield"><a href="#2-yield" class="headerlink" title="2. yield()"></a>2. yield()</h2><p>对静态方法  <strong>Thread.yield()</strong>  的调用声明了当前线程已经完成了生命周期中最重要的部分，可以切换给其它线程来执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    Thread.yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-join"><a href="#3-join" class="headerlink" title="3. join()"></a>3. join()</h2><p>在线程中调用另一个线程的  <strong>join()</strong>  方法，会将当前线程挂起，直到目标线程结束。</p><p>可以加一个超时参数。</p><h2 id="4-deamon"><a href="#4-deamon" class="headerlink" title="4. deamon"></a>4. deamon</h2><p>后台线程（ <strong>deamon</strong> ）是程序运行时在后台提供服务的线程，并不属于程序中不可或缺的部分。</p><p>当所有非后台线程结束时，程序也就终止，同时会杀死所有后台线程。</p><p>main() 属于非后台线程。</p><p>使用 setDaemon() 方法将一个线程设置为后台线程。</p><h1 id="线程之间的协作"><a href="#线程之间的协作" class="headerlink" title="线程之间的协作"></a>线程之间的协作</h1><ul><li><strong>线程通信</strong> ：保证线程以一定的顺序执行；</li><li><strong>线程同步</strong> ：保证线程对临界资源的互斥访问。</li></ul><p>线程通信往往是基于线程同步的基础上完成的，因此很多线程通信问题也是线程同步问题。</p><h2 id="1-线程通信"><a href="#1-线程通信" class="headerlink" title="1. 线程通信"></a>1. 线程通信</h2><p><strong>wait()、notify() 和 notifyAll()</strong>  三者实现了线程之间的通信。</p><p>wait() 会在等待时将线程挂起，而不是忙等待，并且只有在 notify() 或者 notifyAll() 到达时才唤醒。</p><p>sleep() 和 yield() 并没有释放锁，但是 wait() 会释放锁。实际上，只有在同步控制方法或同步控制块里才能调用 wait() 、notify() 和 notifyAll()。</p><p>这几个方法属于基类的一部分，而不属于 Thread。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(flag == <span class="keyword">false</span>) &#123;</span><br><span class="line">        wait();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    flag = <span class="keyword">true</span>;</span><br><span class="line">    notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>wait() 和 sleep() 的区别</strong> </p><ol><li>wait() 是 Object 类的方法，而 sleep() 是 Thread 的静态方法；</li><li>wait() 会放弃锁，而 sleep() 不会。</li></ol><h2 id="2-线程同步"><a href="#2-线程同步" class="headerlink" title="2. 线程同步"></a>2. 线程同步</h2><p>给定一个进程内的所有线程，都共享同一存储空间，这样有好处又有坏处。这些线程就可以共享数据，非常有用。不过，在两个线程同时修改某一资源时，这也会造成一些问题。Java 提供了同步机制，以控制对共享资源的互斥访问。</p><h3 id="2-1-synchronized"><a href="#2-1-synchronized" class="headerlink" title="2.1 synchronized"></a>2.1 synchronized</h3><p><strong>同步一个方法</strong> </p><p>使多个线程不能同时访问该方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>同步一个代码块</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-Lock"><a href="#2-2-Lock" class="headerlink" title="2.2 Lock"></a>2.2 Lock</h3><p>若要实现更细粒度的控制，我们可以使用锁（lock）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Lock lock;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-BlockingQueue"><a href="#2-3-BlockingQueue" class="headerlink" title="2.3 BlockingQueue"></a>2.3 BlockingQueue</h3><p>java.util.concurrent.BlockingQueue 接口有以下阻塞队列的实现：</p><ul><li><strong>FIFO 队列</strong> ：LinkedBlockingQueue、ArrayListBlockingQueue（固定长度）</li><li><strong>优先级队列</strong> ：PriorityBlockingQueue</li></ul><p>提供了阻塞的 take() 和 put() 方法：如果队列为空 take() 将一直阻塞到队列中有内容，如果队列为满  put() 将阻塞到队列有空闲位置。它们响应中断，当收到中断请求的时候会抛出 InterruptedException，从而提前结束阻塞状态。</p><p><strong>使用 BlockingQueue 实现生产者消费者问题</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者</span></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;String&gt; queue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;String&gt; queue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" is making product..."</span>);</span><br><span class="line">        String product = <span class="string">"made by "</span> + Thread.currentThread().getName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            queue.put(product);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者</span></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;String&gt; queue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;String&gt; queue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String  product = queue.take();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" is consuming product "</span> + product + <span class="string">"..."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(queue), <span class="string">"Producer"</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// 只有两个 Product，因此只能消费两个，其它三个消费者被阻塞</span></span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Producer(queue), <span class="string">"Consumer"</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(queue), <span class="string">"Producer"</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 运行结果</span><br><span class="line">Consumer0 is making product...</span><br><span class="line">Producer0 is consuming product made by Consumer0...</span><br><span class="line">Consumer1 is making product...</span><br><span class="line">Producer1 is consuming product made by Consumer1...</span><br><span class="line">Consumer2 is making product...</span><br><span class="line">Consumer3 is making product...</span><br><span class="line">Consumer4 is making product...</span><br><span class="line">Producer2 is consuming product made by Consumer2...</span><br><span class="line">Producer3 is consuming product made by Consumer3...</span><br><span class="line">Producer4 is consuming product made by Consumer4...</span><br></pre></td></tr></table></figure><h1 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h1><p>JDK 从 1.5 开始在 Thread 类中增添了 State 枚举，包含以下六种状态：</p><ol><li><strong>NEW</strong> （新建）</li><li><strong>RUNNABLE</strong> （当线程正在运行或者已经就绪正等待 CPU 时间片）</li><li><strong>BLOCKED</strong> （阻塞，线程在等待获取对象同步锁）</li><li><strong>Waiting</strong> （调用不带超时的 wait() 或 join()）</li><li><strong>TIMED_WAITING</strong> （调用 sleep()、带超时的 wait() 或者 join()）</li><li><strong>TERMINATED</strong> （死亡）</li></ol><p><br><div align="center"> <img src="../pics/19f2c9ef-6739-4a95-8e9d-aa3f7654e028.jpg"> </div><br></p><h1 id="结束线程"><a href="#结束线程" class="headerlink" title="结束线程"></a>结束线程</h1><h2 id="1-阻塞"><a href="#1-阻塞" class="headerlink" title="1. 阻塞"></a>1. 阻塞</h2><p>一个线程进入阻塞状态可能有以下原因：</p><ol><li>调用 Thread.sleep() 方法进入休眠状态；</li><li>通过 wait() 使线程挂起，直到线程得到 notify() 或 notifyAll() 消息（或者 java.util.concurrent 类库中等价的 signal() 或 signalAll() 消息；</li><li>等待某个 I/O 的完成；</li><li>试图在某个对象上调用其同步控制方法，但是对象锁不可用，因为另一个线程已经获得了这个锁。</li></ol><h2 id="2-中断"><a href="#2-中断" class="headerlink" title="2. 中断"></a>2. 中断</h2><p>使用中断机制即可终止阻塞的线程。</p><p>使用  <strong>interrupt()</strong>  方法来中断某个线程，它会设置线程的中断状态。Object.wait(), Thread.join() 和 Thread.sleep() 三种方法在收到中断请求的时候会清除中断状态，并抛出 InterruptedException。</p><p>应当捕获这个 InterruptedException 异常，从而做一些清理资源的操作。</p><p><strong>不可中断的阻塞</strong> </p><p>不能中断 I/O 阻塞和 synchronized 锁阻塞。</p><p><strong>Executor 的中断操作</strong> </p><p>Executor 避免对 Thread 对象的直接操作，但是使用 interrupt() 方法必须持有 Thread 对象。Executor 使用 shutdownNow() 方法来中断所有它里面的所有线程，shutdownNow() 方法会发送 interrupt() 调用给所有线程。</p><p>如果只想中断一个线程，那么使用 Executor 的 submit() 而不是 executor() 来启动线程，就可以持有线程的上下文。submit() 将返回一个泛型 Futrue，可以在它之上调用 cancel()，如果将 true 传递给 cancel()，那么它将会发送 interrupt() 调用给特定的线程。</p><p><strong>检查中断</strong> </p><p>通过中断的方法来终止线程，需要线程进入阻塞状态才能终止。如果编写的 run() 方法循环条件为 true，但是该线程不发生阻塞，那么线程就永远无法终止。</p><p>interrupt() 方法会设置中断状态，可以通过 interrupted() 方法来检查中断状，从而判断一个线程是否已经被中断。</p><p>interrupted() 方法在检查完中断状态之后会清除中断状态，这样做是为了确保一次中断操作只会产生一次影响。</p><h1 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h1><p>对于除 long 和 double 之外的基本类型变量的读写，可以看成是具有原子性的，以不可分割的步骤操作内存。</p><p>JVM 将 64 位变量（long 和 double）的读写当做两个分离的 32 位操作来执行，在两个操作之间可能会发生上下文切换，因此不具有原子性。可以使用  <strong>volatile</strong>  关键字来定义 long 和 double 变量，从而获得原子性。</p><p><strong>AtomicInteger、AtomicLong、AtomicReference</strong>  等特殊的原子性变量类提供了下面形式的原子性条件更新语句，使得比较和更新这两个操作能够不可分割地执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(expectedValue, updateValue)</span></span>;</span><br></pre></td></tr></table></figure><p>AtomicInteger 使用举例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AtomicInteger ai = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ai.addAndGet(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>原子性具有很多复杂问题，应当尽量使用同步而不是原子性。</p><h1 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h1><p>保证了内存可见性和禁止指令重排，没法保证原子性。</p><h2 id="1-内存可见性"><a href="#1-内存可见性" class="headerlink" title="1. 内存可见性"></a>1. 内存可见性</h2><p>普通共享变量被修改之后，什么时候被写入主存是不确定的。</p><p>volatile 关键字会保证每次修改共享变量之后该值会立即更新到内存中，并且在读取时会从内存中读取值。</p><p>synchronized 和 Lock 也能够保证内存可见性。它们能保证同一时刻只有一个线程获取锁然后执行同步代码，并且在释放锁之前会将对变量的修改刷新到主存当中。不过只有对共享变量的 set() 和 get() 方法都加上 synchronized 才能保证可见性，如果只有 set() 方法加了 synchronized，那么 get() 方法并不能保证会从内存中读取最新的数据。</p><h2 id="2-禁止指令重排"><a href="#2-禁止指令重排" class="headerlink" title="2. 禁止指令重排"></a>2. 禁止指令重排</h2><p>在 Java 内存模型中，允许编译器和处理器对指令进行重排序，重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。</p><p>volatile 关键字通过添加内存屏障的方式来进制指令重排，即重排序时不能把后面的指令放到内存屏障之前。</p><p>可以通过 synchronized 和 Lock 来保证有序性，它们保证每个时刻只有一个线程执行同步代码，相当于是让线程顺序执行同步代码，自然就保证了有序性。</p><h1 id="多线程开发良好的实践"><a href="#多线程开发良好的实践" class="headerlink" title="多线程开发良好的实践"></a>多线程开发良好的实践</h1><ul><li>给线程命名；</li><li>最小化同步范围；</li><li>优先使用 volatile；</li><li>尽可能使用更高层次的并发工具而非 wait 和 notify() 来实现线程通信，如 BlockingQueue, Semeaphore；</li><li>多用并发容器，少用同步容器，并发容器壁同步容器的可扩展性更好。</li><li>考虑使用线程池</li><li>最低限度的使用同步和锁，缩小临界区。因此相对于同步方法，同步块会更好。</li></ul><h1 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h1><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>Java 编程思想</li><li><a href="http://www.importnew.com/12773.html" target="_blank" rel="noopener">Java 线程面试题 Top 50</a></li><li><a href="https://www.jianshu.com/p/e0c8d3dced8a" target="_blank" rel="noopener">Java 面试专题 - 多线程 &amp; 并发编程 </a></li><li><a href="https://github.com/francistao/LearningNotes/blob/master/Part2/JavaConcurrent/%E5%8F%AF%E9%87%8D%E5%85%A5%E5%86%85%E7%BD%AE%E9%94%81.md" target="_blank" rel="noopener">可重入内置锁</a></li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#使用线程&quot;&gt;使用线程&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-实现-runnable-接口&quot;&gt;1. 实现 Runnable 接口&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-实现-callable-接口&quot;&gt;2. 实现 Callable 接口&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-继承-tread-类&quot;&gt;3. 继承 Tread 类&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-实现接口-vs-继承-thread&quot;&gt;4. 实现接口 vs 继承 Thread&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#executor&quot;&gt;Executor&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#基础线程机制&quot;&gt;基础线程机制&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-sleep&quot;&gt;1. sleep()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-yield&quot;&gt;2. yield()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-join&quot;&gt;3. join()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-deamon&quot;&gt;4. deamon&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#线程之间的协作&quot;&gt;线程之间的协作&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-线程通信&quot;&gt;1. 线程通信&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-线程同步&quot;&gt;2. 线程同步&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#21-synchronized&quot;&gt;2.1 synchronized&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#22-lock&quot;&gt;2.2 Lock&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#23-blockingqueue&quot;&gt;2.3 BlockingQueue&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#线程状态&quot;&gt;线程状态&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#结束线程&quot;&gt;结束线程&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-阻塞&quot;&gt;1. 阻塞&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-中断&quot;&gt;2. 中断&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#原子性&quot;&gt;原子性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#volatile&quot;&gt;volatile&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-内存可见性&quot;&gt;1. 内存可见性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-禁止指令重排&quot;&gt;2. 禁止指令重排&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#多线程开发良好的实践&quot;&gt;多线程开发良好的实践&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#未完待续&quot;&gt;未完待续&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;使用线程&quot;&gt;&lt;a href=&quot;#使用线程&quot; class=&quot;headerlink&quot; title=&quot;使用线程&quot;&gt;&lt;/a&gt;使用线程&lt;/h1&gt;&lt;p&gt;有三种使用线程的方法：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;实现 Runnable 接口；&lt;/li&gt;
&lt;li&gt;实现 Callable 接口；&lt;/li&gt;
&lt;li&gt;继承 Tread 类；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;实现 Runnable 和 Callable 接口的类只能当做一个可以在线程中运行的任务，不是真正意义上的线程，因此最后还需要通过 Thread 来调用。可以说任务是通过线程驱动从而执行的。&lt;/p&gt;
&lt;h2 id=&quot;1-实现-Runnable-接口&quot;&gt;&lt;a href=&quot;#1-实现-Runnable-接口&quot; class=&quot;headerlink&quot; title=&quot;1. 实现 Runnable 接口&quot;&gt;&lt;/a&gt;1. 实现 Runnable 接口&lt;/h2&gt;&lt;p&gt;需要实现 run() 方法&lt;/p&gt;
&lt;p&gt;通过 Thread 调用 start() 方法来启动线程&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>Linux</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/Linux.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/Linux.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:33:48.301Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#常用操作以及概念">常用操作以及概念</a><ul><li><a href="#求助">求助</a></li><li><a href="#关机">关机</a></li><li><a href="#查看进程">查看进程</a></li><li><a href="#查看端口">查看端口</a></li><li><a href="#path">PATH</a></li><li><a href="#运行等级">运行等级</a></li><li><a href="#sudo">sudo</a></li><li><a href="#gnu">GNU</a></li><li><a href="#包管理工具">包管理工具</a></li><li><a href="#常见发行版本">常见发行版本</a></li></ul></li><li><a href="#分区">分区</a><ul><li><a href="#磁盘的文件名">磁盘的文件名</a></li><li><a href="#分区表">分区表</a><ul><li><a href="#1-mbr">1. MBR</a></li><li><a href="#2-gpt">2. GPT</a></li></ul></li><li><a href="#开机检测程序">开机检测程序</a><ul><li><a href="#1-bios">1. BIOS</a></li><li><a href="#2-uefi">2. UEFI</a></li></ul></li><li><a href="#挂载">挂载</a></li></ul></li><li><a href="#文件权限与目录配置">文件权限与目录配置</a><ul><li><a href="#文件权限概念">文件权限概念</a></li><li><a href="#文件属性以及权限的修改">文件属性以及权限的修改</a><ul><li><a href="#1-修改文件所属群组">1. 修改文件所属群组</a></li><li><a href="#2-修改文件拥有者">2. 修改文件拥有者</a></li><li><a href="#3-修改权限">3. 修改权限</a></li></ul></li><li><a href="#目录的权限">目录的权限</a></li><li><a href="#文件默认权限">文件默认权限</a></li><li><a href="#目录配置">目录配置</a></li></ul></li><li><a href="#文件与目录">文件与目录</a><ul><li><a href="#文件时间">文件时间</a></li><li><a href="#文件与目录的基本操作">文件与目录的基本操作</a><ul><li><a href="#1-ls">1. ls</a></li><li><a href="#2-cp">2. cp</a></li><li><a href="#3-rm">3. rm</a></li><li><a href="#4-mv">4. mv</a></li></ul></li><li><a href="#获取文件内容">获取文件内容</a><ul><li><a href="#1-cat">1. cat</a></li><li><a href="#2-tac">2. tac</a></li><li><a href="#3-more">3. more</a></li><li><a href="#4-less">4. less</a></li><li><a href="#5-head">5. head</a></li><li><a href="#6-tail">6. tail</a></li><li><a href="#7-od">7. od</a></li><li><a href="#8-touch">8. touch</a></li></ul></li><li><a href="#指令与文件搜索">指令与文件搜索</a><ul><li><a href="#1-which">1. which</a></li><li><a href="#2-whereis">2. whereis</a></li><li><a href="#3-locate">3. locate</a></li><li><a href="#4-find">4. find</a><ul><li><a href="#41-与时间有关的选项">4.1 与时间有关的选项</a></li><li><a href="#42-与文件拥有者和所属群组有关的选项">4.2 与文件拥有者和所属群组有关的选项</a></li><li><a href="#43-与文件权限和名称有关的选项">4.3 与文件权限和名称有关的选项</a></li></ul></li></ul></li></ul></li><li><a href="#磁盘与文件系统">磁盘与文件系统</a><ul><li><a href="#文件系统的组成">文件系统的组成</a></li><li><a href="#inode">inode</a></li><li><a href="#目录的-inode-与-block">目录的 inode 与 block</a></li><li><a href="#实体链接与符号链接">实体链接与符号链接</a><ul><li><a href="#1-实体链接">1. 实体链接</a></li><li><a href="#2-符号链接">2. 符号链接</a></li></ul></li></ul></li><li><a href="#压缩与打包">压缩与打包</a><ul><li><a href="#压缩">压缩</a><ul><li><a href="#1-gzip">1. gzip</a></li><li><a href="#2-bzip2">2. bzip2</a></li><li><a href="#3-xz">3. xz</a></li></ul></li><li><a href="#打包">打包</a></li></ul></li><li><a href="#bash">Bash</a><ul><li><a href="#bash-特性">Bash 特性</a></li><li><a href="#变量操作">变量操作</a></li><li><a href="#指令搜索顺序">指令搜索顺序</a></li><li><a href="#数据流重定向">数据流重定向</a></li><li><a href="#管线指令">管线指令</a><ul><li><a href="#1-提取指令cut">1. 提取指令：cut</a></li><li><a href="#2-排序命令sortuniq">2. 排序命令：sort、uniq</a></li><li><a href="#3-双向输出重定向tee">3. 双向输出重定向：tee</a></li><li><a href="#4-字符转换指令trcolexpandjoinpaste">4. 字符转换指令：tr、col、expand、join、paste</a></li><li><a href="#5-分区指令split">5. 分区指令：split</a></li></ul></li></ul></li><li><a href="#正规表示法与文件格式化处理">正规表示法与文件格式化处理</a><ul><li><a href="#grep">grep</a></li><li><a href="#printf">printf</a></li><li><a href="#awk">awk</a></li></ul></li><li><a href="#vim-三个模式">vim 三个模式</a></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="常用操作以及概念"><a href="#常用操作以及概念" class="headerlink" title="常用操作以及概念"></a>常用操作以及概念</h1><h2 id="求助"><a href="#求助" class="headerlink" title="求助"></a>求助</h2><p><strong>1. –help</strong> </p><p>指令的基本用法与选项介绍。</p><p><strong>2. man</strong> </p><p>man 是 manual 的缩写，将指令的具体信息显示出来。</p><p>当执行 man date 时，有 DATE(1) 出现，其中的数字代表指令的类型，常用的数字及其类型如下：</p><table><thead><tr><th>代号</th><th>类型</th></tr></thead><tbody><tr><td>1</td><td>用户在 shell 环境中可以操作的指令或者可执行文件</td></tr><tr><td>5</td><td>配置文件</td></tr><tr><td>8</td><td>系统管理员可以使用的管理指令</td></tr></tbody></table><a id="more"></a><p><strong>3. info</strong> </p><p>info 与 man 类似，但是 info 将文档分成一个个页面，每个页面可以进行跳转。</p><h2 id="关机"><a href="#关机" class="headerlink" title="关机"></a>关机</h2><p><strong>1. sync</strong> </p><p>为了加快对磁盘上文件的读写速度，位于内存中的文件数据不会立即同步到磁盘上，因此关机之前需要先进行 sync 同步操作。</p><p><strong>2. shutdown</strong> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># /sbin/shutdown [-krhc] [时间] [警告讯息]</span><br><span class="line">-k ： 不会关机，只是发送警告讯息，通知所有在线的用户</span><br><span class="line">-r ： 将系统的服务停掉后就重新启动</span><br><span class="line">-h ： 将系统的服务停掉后就立即关机</span><br><span class="line">-c ： 取消已经在进行的 shutdown 指令内容</span><br></pre></td></tr></table></figure><p><strong>3. 其它关机指令</strong> </p><p>reboot、halt、poweroff。</p><h2 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep threadx</span><br></pre></td></tr></table></figure><h2 id="查看端口"><a href="#查看端口" class="headerlink" title="查看端口"></a>查看端口</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -anp | grep 80</span><br></pre></td></tr></table></figure><h2 id="PATH"><a href="#PATH" class="headerlink" title="PATH"></a>PATH</h2><p>可以在环境变量 PATH 中声明可执行文件的路径，路径之间用 : 分隔。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/home/dmtsai/.local/bin:/home/dmtsai/bin</span><br></pre></td></tr></table></figure><h2 id="运行等级"><a href="#运行等级" class="headerlink" title="运行等级"></a>运行等级</h2><ul><li>0：关机模式</li><li>1：单用户模式（可用于破解root密码）</li><li>2：无网络支持的多用户模式</li><li>3：有网络支持的多用户模式（文本模式，工作中最常用的模式）</li><li>4：保留，未使用</li><li>5：有网络支持的 X-windows 多用户模式（桌面）</li><li>6：重新引导系统，即重启</li></ul><h2 id="sudo"><a href="#sudo" class="headerlink" title="sudo"></a>sudo</h2><p>使用 sudo 允许一般用户使用 root 可执行的命令，只有在 /etc/sudoers 配置文件中添加的用户才能使用该指令。</p><h2 id="GNU"><a href="#GNU" class="headerlink" title="GNU"></a>GNU</h2><p>GNU 计划，又译为革奴计划，它的目标是创建一套完全自由的操作系统，称为 GNU，其内容软件完全以 GPL 方式发布。其中 GPL 全称为 GNU 通用公共许可协议，包含了以下内容：</p><ul><li>以任何目的运行此程序的自由；</li><li>再复制的自由；</li><li>改进此程序，并公开发布改进的自由。</li></ul><h2 id="包管理工具"><a href="#包管理工具" class="headerlink" title="包管理工具"></a>包管理工具</h2><p>RPM 和 DPKG 为最常见的两类软件包管理工具。RPM 全称为 Redhat Package Manager，最早由 Red Hat 公司制定实施，随后被 GNU 开源操作系统接受并成为很多 Linux 系统 (RHEL) 的既定软件标准。与 RPM 进行竞争的是基于 Debian 操作系统 (UBUNTU) 的 DEB 软件包管理工具－ DPKG，全称为 Debian Package，功能方面与 RPM 相似。</p><p>YUM 基于 RPM 包管理工具，具有依赖管理功能，并具有软件升级的功能。</p><h2 id="常见发行版本"><a href="#常见发行版本" class="headerlink" title="常见发行版本"></a>常见发行版本</h2><p>Linux 发行版是 Linux 内核及各种应用软件的集成版本。</p><table><thead><tr><th>基于的包管理工具</th><th>商业发行版</th><th>社区发行版</th></tr></thead><tbody><tr><td>DPKG</td><td>Ubuntu</td><td>Debian</td></tr><tr><td>RPM</td><td>Red Hat</td><td>Fedora / CentOS</td></tr></tbody></table><h1 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h1><h2 id="磁盘的文件名"><a href="#磁盘的文件名" class="headerlink" title="磁盘的文件名"></a>磁盘的文件名</h2><p>Linux 中每个硬件都被当做一个文件。</p><p>常见磁盘的文件名：</p><ul><li>SCSI/SATA/USB 磁盘：/dev/sd[a-p]</li><li>IDE 磁盘：/dev/hd[a-d]</li></ul><p>其中文件名后面的序号的确定与磁盘插入的顺序有关，而与磁盘所插入的插槽位置无关。</p><h2 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h2><p>磁盘分区表主要有两种格式，一种是限制较多的 MBR 分区表，一种是较新且限制较少的 GPT 分区表。</p><h3 id="1-MBR"><a href="#1-MBR" class="headerlink" title="1. MBR"></a>1. MBR</h3><p>MBR 中，第一个扇区最重要，里面有：主要开机记录（Master boot record, MBR）及分区表（partition table），其中 MBR 占 446 bytes，partition table 占 64 bytes。</p><p>分区表只有 64 bytes，最多只能存储 4 个分区，这 4 个分区为主分区（Primary）和扩展分区（Extended）。其中扩展分区只有一个，它将其它空间用来记录分区表，可以记录更多的分区，因此通过扩展分区可以分出更多区分，这些分区称为逻辑分区。</p><p>Linux 也把分区当成文件，分区文件的命名方式为：磁盘文件名+编号，例如 /dev/sda1。注意，逻辑分区的编号从 5 开始。</p><h3 id="2-GPT"><a href="#2-GPT" class="headerlink" title="2. GPT"></a>2. GPT</h3><p>不同的磁盘有不同的扇区大小，例如 512 bytes 和最新磁盘的 4k。GPT 为了兼容所有磁盘，在定义扇区上使用逻辑区块地址（Logical Block Address, LBA）。</p><p>GPT 第 1 个区块记录了 MBR，紧接着是 33 个区块记录分区信息，并把最后的 33 个区块用于对分区信息进行备份。</p><p>GPT 没有扩展分区概念，都是主分区，最多可以分 128 个分区。</p><p><br><div align="center"> <img src="../pics/a5c25452-6fa5-49e7-9322-823077442775.jpg"> </div><br></p><h2 id="开机检测程序"><a href="#开机检测程序" class="headerlink" title="开机检测程序"></a>开机检测程序</h2><h3 id="1-BIOS"><a href="#1-BIOS" class="headerlink" title="1. BIOS"></a>1. BIOS</h3><p>BIOS 是开机的时候计算机执行的第一个程序，这个程序知道可以开机的磁盘，并读取磁盘第一个扇区的 MBR，由 MBR 执行其中的开机管理程序，这个开机管理程序的会加载操作系统的核心文件。</p><p>MBR 中的开机管理程序提供以下功能：选单、载入核心文件以及转交其它开机管理程序。转交这个功能可以用来实现了多重引导，只需要将另一个操作系统的开机管理程序安装在其它分区的启动扇区上，在启动 MBR 中的开机管理程序时，就可以选择启动当前的操作系统或者转交给其它开机管理程序从而启动另一个操作系统。</p><p><br><div align="center"> <img src="../pics/f900f266-a323-42b2-bc43-218fdb8811a8.jpg"> </div><br></p><p>安装多重引导，最好先安装 Windows 再安装 Linux。因为安装 Windows 时会覆盖掉 MBR，而 Linux 可以选择将开机管理程序安装在 MBR 或者其它分区的启动扇区，并且可以设置开机管理程序的选单。</p><h3 id="2-UEFI"><a href="#2-UEFI" class="headerlink" title="2. UEFI"></a>2. UEFI</h3><p>UEFI 相比于 BIOS 来说功能更为全面，也更为安全。</p><h2 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h2><p>挂载利用目录作为分区的进入点，也就是说，进入目录之后就可以读取分区的数据。</p><p><br><div align="center"> <img src="../pics/249f3bb1-feee-4805-a259-a72699d638ca.jpg"> </div><br></p><h1 id="文件权限与目录配置"><a href="#文件权限与目录配置" class="headerlink" title="文件权限与目录配置"></a>文件权限与目录配置</h1><h2 id="文件权限概念"><a href="#文件权限概念" class="headerlink" title="文件权限概念"></a>文件权限概念</h2><p>把用户分为三种：文件拥有者、群组以及其它人，对不同的用户有不同的文件权限。</p><p>使用 ls 查看一个文件时，会显示一个文件的信息，例如 drwxr-xr-x. 3 root root 17 May 6 00:14 .config，对这个信息的解释如下：</p><ul><li>drwxr-xr-x：文件类型以及权限，第 1 位为文件类型字段，后 9 位为文件权限字段。</li><li>3：链接数；</li><li>root：文件拥有者；</li><li>root：所属群组；</li><li>17：文件大小；</li><li>May 6 00:14：文件最后被修改的时间；</li><li>.config：文件名。</li></ul><p>常见的文件类型及其含义有：</p><ul><li>d：目录；</li><li>-：文件；</li><li>l：链接文件；</li></ul><p>9 位的文件权限字段中，每 3 个为一组，共 3 组，每一组分别代表对文件拥有者、所属群组以及其它人的文件权限。一组权限中的 3 位分别为 r、w、x 权限，表示可读、可写、可执行。</p><h2 id="文件属性以及权限的修改"><a href="#文件属性以及权限的修改" class="headerlink" title="文件属性以及权限的修改"></a>文件属性以及权限的修改</h2><h3 id="1-修改文件所属群组"><a href="#1-修改文件所属群组" class="headerlink" title="1. 修改文件所属群组"></a>1. 修改文件所属群组</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chgrp [-R] groupname dirname/filename</span><br><span class="line">-R：递归修改</span><br></pre></td></tr></table></figure><h3 id="2-修改文件拥有者"><a href="#2-修改文件拥有者" class="headerlink" title="2. 修改文件拥有者"></a>2. 修改文件拥有者</h3><p>不仅可以修改文件拥有者，也可以修改文件所属群组。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chown [-R] 用户名:群组名 dirname/filename</span><br></pre></td></tr></table></figure><h3 id="3-修改权限"><a href="#3-修改权限" class="headerlink" title="3. 修改权限"></a>3. 修改权限</h3><p>可以将一组权限用数字来表示，此时一组权限的 3 个位当做二进制数字的位，从左到右每个位的权值为 4、2、1，即每个权限对应的数字权值为 r：4、w：2、x：1。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod [-R] xyz dirname/filename</span><br></pre></td></tr></table></figure><p>范例：将 .bashrc 文件的权限修改为 -rwxr-xr–。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod 754 .bashrc</span><br></pre></td></tr></table></figure><p>也可以使用符号来设定权限。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># chmod [ugoa]  [+-=] [rwx] dirname/filename</span><br><span class="line">- u：拥有者</span><br><span class="line">- g：所属群组</span><br><span class="line">- o：其他人</span><br><span class="line">- a：所有人</span><br><span class="line">- +：添加权限</span><br><span class="line">- -：移除权限</span><br><span class="line">- =：设定权限</span><br></pre></td></tr></table></figure><p>范例：为 .bashrc 文件的所有用户添加写权限。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod a+w .bashrc</span><br></pre></td></tr></table></figure><h2 id="目录的权限"><a href="#目录的权限" class="headerlink" title="目录的权限"></a>目录的权限</h2><p>文件名不是存储在一个文件的内容中，而是存储在一个文件所在的目录中。因此，拥有文件的 w 权限并不能对文件名进行修改。</p><p>目录存储文件列表，一个目录的权限也就是对其文件列表的权限。因此，目录的 r 权限表示可以读取文件列表；w 权限表示可以修改文件列表，具体来说，就是添加删除文件，对文件名进行修改；x 权限可以让该目录成为工作目录，x 权限是 r 和 w 权限的基础，如果不能使一个目录成为工作目录，也就没办法读取文件列表以及对文件列表进行修改了。</p><h2 id="文件默认权限"><a href="#文件默认权限" class="headerlink" title="文件默认权限"></a>文件默认权限</h2><p>文件默认权限：文件默认没有可执行权限，因此为 666，也就是 -rw-rw-rw- 。<br>目录默认权限：目录必须要能够进入，也就是必须拥有可执行权限，因此为 777 ，也就是 drwxrwxrwx。</p><p>可以通过 umask 设置或者查看文件的默认权限，通常以掩码的形式来表示，例如 002 表示其它用户的权限去除了一个 2 的权限，也就是写权限，因此建立新文件时默认的权限为 -rw-rw-r– 。</p><h2 id="目录配置"><a href="#目录配置" class="headerlink" title="目录配置"></a>目录配置</h2><p>为了使不同 Linux 发行版本的目录结构保持一致性，Filesystem Hierarchy Standard (FHS) 规定了 Linux 的目录结构。最基础的三个目录如下：</p><ul><li>/ (root, 根目录)</li><li>/usr (unix software resource)：所有系统默认软件都会安装到这个目录；</li><li>/var (variable)：存放系统或程序运行过程中的数据文件。</li></ul><p>完整的目录树如下：</p><p><br><div align="center"> <img src="../pics/27ace615-558f-4dfb-8ad4-7ac769c10118.jpg"> </div><br></p><h1 id="文件与目录"><a href="#文件与目录" class="headerlink" title="文件与目录"></a>文件与目录</h1><h2 id="文件时间"><a href="#文件时间" class="headerlink" title="文件时间"></a>文件时间</h2><ol><li>modification time (mtime)：文件的内容更新就会更新；</li><li>status time (ctime)：文件的状态（权限、属性）更新就会更新；</li><li>access time (atime)：读取文件时就会更新。</li></ol><h2 id="文件与目录的基本操作"><a href="#文件与目录的基本操作" class="headerlink" title="文件与目录的基本操作"></a>文件与目录的基本操作</h2><h3 id="1-ls"><a href="#1-ls" class="headerlink" title="1. ls"></a>1. ls</h3><p>列出文件或者目录的信息，目录的信息就是其中包含的文件。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ls [-aAdfFhilnrRSt] file|dir</span><br><span class="line">-a ：列出全部的文件</span><br><span class="line">-d ：仅列出目录本身</span><br><span class="line">-l ：以长数据串行列出，包含文件的属性与权限等等数据</span><br></pre></td></tr></table></figure><h3 id="2-cp"><a href="#2-cp" class="headerlink" title="2. cp"></a>2. cp</h3><p>复制操作。</p><p>如果源文件有两个以上，则目的文件一定要是目录才行。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cp [-adfilprsu] source destination</span><br><span class="line">-a ：相当于 -dr --preserve=all 的意思，至于 dr 请参考下列说明</span><br><span class="line">-d ：若来源文件为链接文件，则复制链接文件属性而非文件本身</span><br><span class="line">-i ：若目标文件已经存在时，在覆盖前会先询问</span><br><span class="line">-p ：连同文件的属性一起复制过去</span><br><span class="line">-r ：递归持续复制</span><br><span class="line">-u ：destination 比 source 旧才更新 destination，或 destination 不存在的情况下才复制</span><br><span class="line">--preserve=all ：除了 -p 的权限相关参数外，还加入 SELinux 的属性, links, xattr 等也复制了</span><br></pre></td></tr></table></figure><h3 id="3-rm"><a href="#3-rm" class="headerlink" title="3. rm"></a>3. rm</h3><p>移除操作。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># rm [-fir] 文件或目录</span><br><span class="line">-r ：递归删除</span><br></pre></td></tr></table></figure><h3 id="4-mv"><a href="#4-mv" class="headerlink" title="4. mv"></a>4. mv</h3><p>移动操作。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mv [-fiu] source destination</span><br><span class="line"># mv [options] source1 source2 source3 .... directory</span><br><span class="line">-f ： force 强制的意思，如果目标文件已经存在，不会询问而直接覆盖</span><br></pre></td></tr></table></figure><h2 id="获取文件内容"><a href="#获取文件内容" class="headerlink" title="获取文件内容"></a>获取文件内容</h2><h3 id="1-cat"><a href="#1-cat" class="headerlink" title="1. cat"></a>1. cat</h3><p>取得文件内容。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat [-AbEnTv] filename</span><br><span class="line">-n ：打印出行号，连同空白行也会有行号，-b 不会</span><br></pre></td></tr></table></figure><h3 id="2-tac"><a href="#2-tac" class="headerlink" title="2. tac"></a>2. tac</h3><p>是 cat 的反向操作，从最后一行开始打印。</p><h3 id="3-more"><a href="#3-more" class="headerlink" title="3. more"></a>3. more</h3><p>可以一页一页查看文件内容，和文本编辑器类似。</p><h3 id="4-less"><a href="#4-less" class="headerlink" title="4. less"></a>4. less</h3><p>和 more 类似。</p><h3 id="5-head"><a href="#5-head" class="headerlink" title="5. head"></a>5. head</h3><p>可以取得文件前几行。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># head [-n number] filename</span><br><span class="line">-n ：后面接数字，代表显示几行的意思</span><br></pre></td></tr></table></figure><h3 id="6-tail"><a href="#6-tail" class="headerlink" title="6. tail"></a>6. tail</h3><p>是 head 的反向操作，只是取得是后几行。</p><h3 id="7-od"><a href="#7-od" class="headerlink" title="7. od"></a>7. od</h3><p>可以以字符或者十六进制的形式显示二进制文件。</p><h3 id="8-touch"><a href="#8-touch" class="headerlink" title="8. touch"></a>8. touch</h3><p>修改文件时间或者建立新文件。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># touch [-acdmt] filename</span><br><span class="line">-a ： 更新 atime</span><br><span class="line">-c ： 更新 ctime，若该文件不存在则不建立新文件</span><br><span class="line">-m ： 更新 mtime</span><br><span class="line">-d ： 后面可以接欲更新的日期而不用当前的日期，也可以使用 --date="日期或时间"</span><br><span class="line">-t ：后面可以接欲更新的时间而不用当前的时间，格式为[YYYYMMDDhhmm]</span><br></pre></td></tr></table></figure><h2 id="指令与文件搜索"><a href="#指令与文件搜索" class="headerlink" title="指令与文件搜索"></a>指令与文件搜索</h2><h3 id="1-which"><a href="#1-which" class="headerlink" title="1. which"></a>1. which</h3><p>指令搜索。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># which [-a] command</span><br><span class="line">-a ：将所有指令列出，而不是只列第一个</span><br></pre></td></tr></table></figure><h3 id="2-whereis"><a href="#2-whereis" class="headerlink" title="2. whereis"></a>2. whereis</h3><p>whereis 搜索文件的速度比较快，因为它只搜索几个特定的目录。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># whereis [-bmsu] dirname/filename</span><br></pre></td></tr></table></figure><h3 id="3-locate"><a href="#3-locate" class="headerlink" title="3. locate"></a>3. locate</h3><p>locate 可以用关键字或者正则表达式进行搜索。</p><p>locate 使用 /var/lib/mlocate/ 这个数据库来进行搜索，它存储在内存中，并且每天更新一次，所以无法用 locate 搜索新建的文件。可以使用 updatedb 来立即更新数据库。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># locate [-ir] keyword</span><br><span class="line">-r：接正则表达式</span><br></pre></td></tr></table></figure><h3 id="4-find"><a href="#4-find" class="headerlink" title="4. find"></a>4. find</h3><p>find 可以使用文件的属性和权限进行搜索。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># find filename [option]</span><br></pre></td></tr></table></figure><h4 id="4-1-与时间有关的选项"><a href="#4-1-与时间有关的选项" class="headerlink" title="4.1 与时间有关的选项"></a>4.1 与时间有关的选项</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-mtime  n ：列出在 n 天前的那一天修改过内容的文件</span><br><span class="line">-mtime +n ：列出在 n 天之前(不含 n 天本身)修改过内容的文件</span><br><span class="line">-mtime -n ：列出在 n 天之内(含 n 天本身)修改过内容的文件</span><br><span class="line">-newer file ： 列出比 file 更新的文件</span><br></pre></td></tr></table></figure><p>+4、4 和 -4 的指示的时间范围如下：</p><p><br><div align="center"> <img src="../pics/658fc5e7-79c0-4247-9445-d69bf194c539.png"> </div><br></p><h4 id="4-2-与文件拥有者和所属群组有关的选项"><a href="#4-2-与文件拥有者和所属群组有关的选项" class="headerlink" title="4.2 与文件拥有者和所属群组有关的选项"></a>4.2 与文件拥有者和所属群组有关的选项</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-uid n</span><br><span class="line">-gid n</span><br><span class="line">-user name</span><br><span class="line">-group name</span><br><span class="line">-nouser ：搜索拥有者不存在 /etc/passwd 的文件</span><br><span class="line">-nogroup：搜索所属群组不存在于 /etc/group 的文件</span><br></pre></td></tr></table></figure><h4 id="4-3-与文件权限和名称有关的选项"><a href="#4-3-与文件权限和名称有关的选项" class="headerlink" title="4.3 与文件权限和名称有关的选项"></a>4.3 与文件权限和名称有关的选项</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-name filename</span><br><span class="line">-size [+-]SIZE：搜寻比 SIZE 还要大(+)或小(-)的文件。这个 SIZE 的规格有：c: 代表 byte，k: 代表 1024bytes。所以，要找比 50KB 还要大的文件，就是 -size +50k</span><br><span class="line">-type TYPE</span><br><span class="line">-perm mode  ：搜索权限等于 mode 的文件</span><br><span class="line">-perm -mode ：搜索权限包含 mode 的文件</span><br><span class="line">-perm /mode ：搜索权限包含任一 mode 的文件</span><br></pre></td></tr></table></figure><h1 id="磁盘与文件系统"><a href="#磁盘与文件系统" class="headerlink" title="磁盘与文件系统"></a>磁盘与文件系统</h1><h2 id="文件系统的组成"><a href="#文件系统的组成" class="headerlink" title="文件系统的组成"></a>文件系统的组成</h2><p>对分区进行格式化是为了在分区上建立文件系统。一个分区通常只能格式化为一个文件系统，但是磁盘阵列等技术可以将一个分区格式化为多个文件系统，因此只有文件系统能被挂载，而分区不能被挂载。</p><p>文件系统有以下三个结构：</p><ol><li>superblock：记录文件系统的整体信息，包括 inode 和 block 的总量、使用量、剩余量，以及文件系统的格式与相关信息等；</li><li>inode：一个文件占用一个 inode，记录文件的属性，同时记录此文件的内容所在的 block 号码；</li><li>block：记录文件的内容，文件太大时，会占用多个 block。</li></ol><p>当要读取一个文件的内容时，先在 inode 中去查找文件内容所在的所有 block，然后把所有 block 的内容读出来。</p><p>磁盘碎片是指一个文件内容所在的 block 过于分散。</p><p>Ext2 文件系统使用了上述的文件结构，并在此之上加入了 block 群组的概念，也就是将一个文件系统划分为多个 block 群组，方便管理。</p><p><br><div align="center"> <img src="../pics/1974a836-aa6b-4fb8-bce1-6eb11969284a.jpg"> </div><br></p><h2 id="inode"><a href="#inode" class="headerlink" title="inode"></a>inode</h2><p>Ext2 文件系统支持的 block 大小有 1k、2k 和 4k 三种，不同的 block 大小限制了单一文件的大小。而每个 inode 大小是固定为 128 bytes。</p><p>inode 中记录了文件内容所在的 block，但是每个 block 非常小，一个大文件随便都需要几十万的 block，而一个 inode 大小有限，无法直接引用这么多 block。因此引入了间接、双间接、三间接引用。间接引用是指，让 inode 记录的引用 block 块当成 inode 用来记录引用信息。</p><p><br><div align="center"> <img src="../pics/89091427-7b2b-4923-aff6-44681319a8aa.jpg"> </div><br></p><p>inode 具体包含以下信息：</p><ul><li>该文件的存取模式(read/write/excute)；</li><li>该文件的拥有者与群组(owner/group)；</li><li>该文件的容量；</li><li>该文件建立或状态改变的时间(ctime)；</li><li>最近一次的读取时间(atime)；</li><li>最近修改的时间(mtime)；</li><li>定义文件特性的旗标(flag)，如 SetUID…；</li><li>该文件真正内容的指向 (pointer)。</li></ul><h2 id="目录的-inode-与-block"><a href="#目录的-inode-与-block" class="headerlink" title="目录的 inode 与 block"></a>目录的 inode 与 block</h2><p>建立一个目录时，会分配一个 inode 与至少一个 block。block 记录的内容是目录下所有文件的 inode 编号以及文件名。可以看出文件的 inode 本身不记录文件名，文件名记录在目录中，因此新增文件、删除文件、更改文件名这些操作与目录的 w 权限有关。</p><h2 id="实体链接与符号链接"><a href="#实体链接与符号链接" class="headerlink" title="实体链接与符号链接"></a>实体链接与符号链接</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ln [-sf] source_filename dist_filename</span><br><span class="line">-s ：默认是 hard link，加 -s 为 symbolic link</span><br><span class="line">-f ：如果目标文件存在时，先删除目标文件</span><br></pre></td></tr></table></figure><h3 id="1-实体链接"><a href="#1-实体链接" class="headerlink" title="1. 实体链接"></a>1. 实体链接</h3><p>hard link 只是在某个目录下新增一个条目，使得新增的条目链接到文件的 inode 上。删除任意一个条目，文件还是存在，只要引用数量不为 0。</p><p>有以下限制：不能跨越 File System；不能对目录进行链接。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ln /etc/crontab .</span><br><span class="line"># ll -i /etc/crontab crontab</span><br><span class="line">34474855 -rw-r--r--. 2 root root 451 Jun 10 2014 crontab</span><br><span class="line">34474855 -rw-r--r--. 2 root root 451 Jun 10 2014 /etc/crontab</span><br></pre></td></tr></table></figure><h3 id="2-符号链接"><a href="#2-符号链接" class="headerlink" title="2. 符号链接"></a>2. 符号链接</h3><p>symbolic link 可以理解为 Windows 的快捷方式，通过建立一个独立的文件，这个文件的数据的读取指向链接的那个文件。当源文件被删除了，链接文件就打不开了。</p><p>symbolic link 可以为目录建立链接。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ll -i /etc/crontab /root/crontab2</span><br><span class="line">34474855 -rw-r--r--. 2 root root 451 Jun 10 2014 /etc/crontab</span><br><span class="line">53745909 lrwxrwxrwx. 1 root root 12 Jun 23 22:31 /root/crontab2 -&gt; /etc/crontab</span><br></pre></td></tr></table></figure><h1 id="压缩与打包"><a href="#压缩与打包" class="headerlink" title="压缩与打包"></a>压缩与打包</h1><h2 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h2><p>Linux 底下有很多压缩文件的扩展名，常见的如下：</p><table><thead><tr><th>扩展名</th><th>压缩程序</th></tr></thead><tbody><tr><td>*.Z</td><td>compress</td></tr><tr><td>*.zip</td><td>zip</td></tr><tr><td>*.gz</td><td>gzip</td></tr><tr><td>*.bz2</td><td>bzip2</td></tr><tr><td>*.xz</td><td>xz</td></tr><tr><td>*.tar</td><td>tar 程序打包的数据，没有经过压缩</td></tr><tr><td>*.tar.gz</td><td>tar 程序打包的文件，经过 gzip 的压缩</td></tr><tr><td>*.tar.bz2</td><td>tar 程序打包的文件，经过 bzip2 的压缩</td></tr><tr><td>*.tar.xz</td><td>tar 程序打包的文件，经过 xz 的压缩</td></tr></tbody></table><h3 id="1-gzip"><a href="#1-gzip" class="headerlink" title="1. gzip"></a>1. gzip</h3><p>gzip 是 Linux 使用最广的压缩指令，可以解开 compress、zip 与 gzip 所压缩的文件。</p><p>经过 gzip 压缩过，源文件就不存在了。</p><p>有 9 个不同的压缩等级可以使用。</p><p>可以使用 zcat、zmore、zless 来读取压缩文件的内容。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ gzip [-cdtv#] filename</span><br><span class="line">-c ：将压缩的数据输出到屏幕上</span><br><span class="line">-d ：解压缩</span><br><span class="line">-t ：检验压缩文件是否出错</span><br><span class="line">-v ：显示压缩比等信息</span><br><span class="line">-# ： # 为数字的意思，代表压缩等级，数字越大压缩比越高，默认为6</span><br></pre></td></tr></table></figure><h3 id="2-bzip2"><a href="#2-bzip2" class="headerlink" title="2. bzip2"></a>2. bzip2</h3><p>提供比 gzip 更高的压缩比。</p><p>查看命令：bzcat、bzmore、bzless、bzgrep。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bzip2 [-cdkzv#] filename</span><br><span class="line">-k ：保留源文件</span><br></pre></td></tr></table></figure><h3 id="3-xz"><a href="#3-xz" class="headerlink" title="3. xz"></a>3. xz</h3><p>提供比 bzip2 更佳的压缩比。</p><p>可以看到，gzip、bzip2、xz 的压缩比不断优化。不过要注意，压缩比越高，压缩的时间也越长。</p><p>查看命令：xzcat、xzmore、xzless、xzgrep。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xz [-dtlkc#] filename</span><br></pre></td></tr></table></figure><h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>压缩指令只能对一个文件进行压缩，而打包能够将多个文件打包成一个大文件。tar 不仅可以用于打包，也可以使用 gip、bzip2、xz 将打包文件进行压缩。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tar [-z|-j|-J] [cv] [-f 新建的tar文件] filename...  ==打包压缩</span><br><span class="line">$ tar [-z|-j|-J] [tv] [-f 已有的tar文件]              ==查看</span><br><span class="line">$ tar [-z|-j|-J] [xv] [-f 已有的tar文件] [-C 目录]    ==解压缩</span><br><span class="line">-z ：使用zip；</span><br><span class="line">-j ：使用bzip2；</span><br><span class="line">-J ：使用xz；</span><br><span class="line">-c ：新建打包文件；</span><br><span class="line">-t ：查看打包文件里面有哪些文件；</span><br><span class="line">-x ：解打包或解压缩的功能；</span><br><span class="line">-v ：在压缩/解压缩的过程中，显示正在处理的文件名；</span><br><span class="line">-f : filename：要处理的文件；</span><br><span class="line">-C 目录 ： 在特定目录解压缩。</span><br></pre></td></tr></table></figure><table><thead><tr><th>使用方式</th><th>命令</th></tr></thead><tbody><tr><td>打包压缩</td><td>tar -jcv -f filename.tar.bz2 要被压缩的文件或目录名称</td></tr><tr><td>查 看</td><td>tar -jtv -f filename.tar.bz2</td></tr><tr><td>解压缩</td><td>tar -jxv -f filename.tar.bz2 -C 要解压缩的目录</td></tr></tbody></table><h1 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h1><p>可以通过 Shell 请求内核提供服务，Bash 正是 Shell 的一种。</p><h2 id="Bash-特性"><a href="#Bash-特性" class="headerlink" title="Bash 特性"></a>Bash 特性</h2><p><strong>1. 命令历史</strong> </p><p>记录使用过的命令。本次登录所执行的命令都会暂时存放到内存中， ~/.bash_history 文件中记录的是前一次登录所执行过的命令。</p><p><strong>2. 命令与文件补全</strong> </p><p>快捷键：tab</p><p><strong>3. 命名别名</strong> </p><p>例如 lm 是 ls -al 的别名。</p><p><strong>4. shell scripts</strong> </p><p><strong>5. 通配符</strong> </p><p>例如 ls -l /usr/bin/X* 列出 /usr/bin 下面所有以 X 开头的文件。</p><h2 id="变量操作"><a href="#变量操作" class="headerlink" title="变量操作"></a>变量操作</h2><ul><li>对一个变量赋值直接使用 = ；</li><li>对变量取用需要在变量前加上 \$ ，也可以用 \${} 的形式；</li><li>输出变量使用 echo 命令。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ var=abc</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$var</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var&#125;</span></span><br></pre></td></tr></table></figure><p>变量内容如果有空格，需要使用双引号或者单引号。双引号内的特殊字符可以保留原本特性，例如var=”lang is \$LANG”，则 var 的值为 lang is zh_TW.UTF-8；而单引号内的特殊字符就是特殊字符本身，例如 var=’lang is \$LANG’，则 var 的值为 lang is \$LANG。</p><p>可以使用 `指令` 或者 \$(指令) 的方式将指令的执行结果赋值给变量。例如 version=\$(uname -r)，则 version 的值为 3.10.0-229.el7.x86_64。</p><p>可以使用 export 命令将自定义变量转成环境变量，环境变量可以在子程序中使用，所谓子程序就是由当前 Bash 而产生的子 Bash。</p><p>Bash 的变量可以声明为数组和整数数字。注意数字类型没有浮点数。如果不进行声明，默认是字符串类型。变量的声明使用 declare 命令：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ declare [-aixr] variable</span><br><span class="line">-a ： 定义为数组类型</span><br><span class="line">-i ： 定义为整数类型</span><br><span class="line">-x ： 定义为环境变量</span><br><span class="line">-r ： 定义为readonly类型</span><br></pre></td></tr></table></figure><p>使用 [ ] 来对数组进行操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ array[1]=a</span><br><span class="line">$ array[2]=b</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;array[1]&#125;</span></span><br></pre></td></tr></table></figure><h2 id="指令搜索顺序"><a href="#指令搜索顺序" class="headerlink" title="指令搜索顺序"></a>指令搜索顺序</h2><ol><li>以绝对或相对路径来执行指令，例如 /bin/ls 或者 ./ls ；</li><li>由别名找到该指令来执行；</li><li>由 Bash 内建的指令来执行；</li><li>按 \$PATH 变量指定的搜索路径的顺序找到第一个指令来执行。</li></ol><h2 id="数据流重定向"><a href="#数据流重定向" class="headerlink" title="数据流重定向"></a>数据流重定向</h2><p>重定向就是使用文件代替标准输入、标准输出和标准错误输出。</p><ol><li>标准输入(stdin) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;：代码为 0 ，使用 &lt; 或 &lt;&lt; ；</li><li>标准输出(stdout)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;：代码为 1 ，使用 &gt; 或 &gt;&gt; ；</li><li>标准错误输出(stderr)：代码为 2 ，使用 2&gt; 或 2&gt;&gt; ；</li></ol><p>其中，有一个箭头的表示以覆盖的方式重定向，而有两个箭头的表示以追加的方式重定向。</p><p>可以将不需要的标准输出以及标准错误输出重定向到 /dev/null，相当于扔进垃圾箱。</p><p>如果需要将标准输出以及标准错误输出同时重定向到一个文件，需要将某个输出转换为另一个输出，例如 2&gt;&amp;1 表示将标准错误输出转换为标准输出。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find /home -name .bashrc &gt; list 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h2 id="管线指令"><a href="#管线指令" class="headerlink" title="管线指令"></a>管线指令</h2><p>管线是将一个命令的标准输出作为另一个命令的标准输入，在数据需要经过多个步骤的处理之后才能得到我们想要的格式时就可以使用管线。在命令之间使用 | 分隔各个管线命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls -al /etc | less</span><br></pre></td></tr></table></figure><h3 id="1-提取指令：cut"><a href="#1-提取指令：cut" class="headerlink" title="1. 提取指令：cut"></a>1. 提取指令：cut</h3><p>提取过程一行一行地进行。</p><p>cut 对数据进行切分，取出想要的部分。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cut</span><br><span class="line">-d ：分隔符</span><br><span class="line">-f ：经过 -d 分隔后，使用 -f n 取出第 n 个区间</span><br><span class="line">-c ：以字符为单位取出区间</span><br></pre></td></tr></table></figure><p>范例 1：last 将显示的登入者的信息，要求仅显示用户名。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ last</span><br><span class="line">root pts/1 192.168.201.101 Sat Feb 7 12:35 still logged in</span><br><span class="line">root pts/1 192.168.201.101 Fri Feb 6 12:13 - 18:46 (06:33)</span><br><span class="line">root pts/1 192.168.201.254 Thu Feb 5 22:37 - 23:53 (01:16)</span><br><span class="line"></span><br><span class="line">$ last | cut -d ' ' -f 1</span><br></pre></td></tr></table></figure><p>范例 2：将 export 输出的讯息，取得第 12 字符以后的所有字符串。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ export</span><br><span class="line">declare -x HISTCONTROL="ignoredups"</span><br><span class="line">declare -x HISTSIZE="1000"</span><br><span class="line">declare -x HOME="/home/dmtsai"</span><br><span class="line">declare -x HOSTNAME="study.centos.vbird"</span><br><span class="line">.....(其他省略).....</span><br><span class="line"></span><br><span class="line">$ export | cut -c 12</span><br></pre></td></tr></table></figure><h3 id="2-排序命令：sort、uniq"><a href="#2-排序命令：sort、uniq" class="headerlink" title="2. 排序命令：sort、uniq"></a>2. 排序命令：sort、uniq</h3><p><strong>sort</strong>  进行排序。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sort [-fbMnrtuk] [file or stdin]</span><br><span class="line">-f ：忽略大小写</span><br><span class="line">-b ：忽略最前面的空格</span><br><span class="line">-M ：以月份的名字来排序，例如 JAN，DEC</span><br><span class="line">-n ：使用数字</span><br><span class="line">-r ：反向排序</span><br><span class="line">-u ：相当于 unique，重复的内容只出现一次</span><br><span class="line">-t ：分隔符，默认为 tab</span><br><span class="line">-k ：指定排序的区间</span><br></pre></td></tr></table></figure><p>范例：/etc/passwd 内容是以 : 来分隔的，以第三栏来排序。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/passwd | sort -t ':' -k 3</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">dmtsai:x:1000:1000:dmtsai:/home/dmtsai:/bin/bash</span><br><span class="line">alex:x:1001:1002::/home/alex:/bin/bash</span><br><span class="line">arod:x:1002:1003::/home/arod:/bin/bash</span><br></pre></td></tr></table></figure><p><strong>uniq</strong>  可以将重复的数据只取一个。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ uniq [-ic]</span><br><span class="line">-i ：忽略大小写</span><br><span class="line">-c ：进行计数</span><br></pre></td></tr></table></figure><p>范例：取得每个人的登录总次数</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ last | cut -d ' ' -f 1 | sort | uniq -c</span><br><span class="line">1</span><br><span class="line">6 (unknown</span><br><span class="line">47 dmtsai</span><br><span class="line">4 reboot</span><br><span class="line">7 root</span><br><span class="line">1 wtmp</span><br></pre></td></tr></table></figure><h3 id="3-双向输出重定向：tee"><a href="#3-双向输出重定向：tee" class="headerlink" title="3. 双向输出重定向：tee"></a>3. 双向输出重定向：tee</h3><p>输出重定向会将输出内容重定向到文件中，而  <strong>tee</strong>  不仅能够完成这个功能，还能保留屏幕上的输出。也就是说，使用 tee 指令，一个输出会同时传送到文件和屏幕上。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tee [-a] file</span><br></pre></td></tr></table></figure><h3 id="4-字符转换指令：tr、col、expand、join、paste"><a href="#4-字符转换指令：tr、col、expand、join、paste" class="headerlink" title="4. 字符转换指令：tr、col、expand、join、paste"></a>4. 字符转换指令：tr、col、expand、join、paste</h3><p>  <strong>tr</strong>  用来删除一行中的字符，或者对字符进行替换。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tr [-ds] SET1 ...</span><br><span class="line">-d ： 删除行中 SET1 这个字符串</span><br></pre></td></tr></table></figure><p>范例，将 last 输出的信息所有小写转换为大写。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ last | tr '[a-z]' '[A-Z]'</span><br></pre></td></tr></table></figure><p>  <strong>col</strong>  将 tab 字符转为空格字符。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ col [-xb]</span><br><span class="line">-x ： 将 tab 键转换成对等的空格键</span><br></pre></td></tr></table></figure><p><strong>expand</strong>  将 tab 转换一定数量的空格，默认是 8 个。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ expand [-t] file</span><br><span class="line">-t ：tab 转为空格的数量</span><br></pre></td></tr></table></figure><p><strong>join</strong>  将有相同数据的那一行合并在一起。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ join [-ti12] file1 file2</span><br><span class="line">-t ：分隔符，默认为空格</span><br><span class="line">-i ：忽略大小写的差异</span><br><span class="line">-1 ：第一个文件所用的比较字段</span><br><span class="line">-2 ：第二个文件所用的比较字段</span><br></pre></td></tr></table></figure><p><strong>paste</strong>  直接将两行粘贴在一起。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ paste [-d] file1 file2</span><br><span class="line">-d ：分隔符，默认为 tab</span><br></pre></td></tr></table></figure><h3 id="5-分区指令：split"><a href="#5-分区指令：split" class="headerlink" title="5. 分区指令：split"></a>5. 分区指令：split</h3><p><strong>split</strong>  将一个文件划分成多个文件。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ split [-bl] file PREFIX</span><br><span class="line">-b ：以大小来进行分区，可加单位，例如 b, k, m 等</span><br><span class="line">-l ：以行数来进行分区。</span><br><span class="line">- PREFIX ：分区文件的前导名称</span><br></pre></td></tr></table></figure><h1 id="正规表示法与文件格式化处理"><a href="#正规表示法与文件格式化处理" class="headerlink" title="正规表示法与文件格式化处理"></a>正规表示法与文件格式化处理</h1><h2 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h2><p>使用正则表示式把匹配的行提取出来。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ grep [-acinv] [--color=auto] 搜寻字符串 filename</span><br><span class="line">-a ： 将 binary 文件以 text 文件的方式进行搜寻</span><br><span class="line">-c ： 计算找到个数</span><br><span class="line">-i ： 忽略大小写</span><br><span class="line">-n ： 输出行号</span><br><span class="line">-v ： 反向选择，亦即显示出没有 搜寻字符串 内容的那一行</span><br><span class="line">--color=auto ：找到的关键字加颜色显示</span><br></pre></td></tr></table></figure><p>范例：把含有 the 字符串的行提取出来（注意默认会有 –color=auto 选项，因此以下内容在 Linux 中有颜色显示 the 字符串）</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ grep -n 'the' regular_express.txt</span><br><span class="line">8:I can't finish the test.</span><br><span class="line">12:the symbol '*' is represented as start.</span><br><span class="line">15:You are the best is mean you are the no. 1.</span><br><span class="line">16:The world Happy is the same with "glad".</span><br><span class="line">18:google is the best tools for search keyword</span><br></pre></td></tr></table></figure><p>因为 { 与 } 的符号在 shell 是有特殊意义的，因此必须要使用使用转义字符进行转义。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grep -n 'go\&#123;2,5\&#125;g' regular_express.txt</span><br></pre></td></tr></table></figure><h2 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h2><p>用于格式化输出。</p><p>它不属于管道命令，在给 printf 传数据时需要使用 $( ) 形式。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ printf '%10s %5i %5i %5i %8.2f \n' $(cat printf.txt)</span><br><span class="line">    DmTsai    80    60    92    77.33</span><br><span class="line">     VBird    75    55    80    70.00</span><br><span class="line">       Ken    60    90    70    73.33</span><br></pre></td></tr></table></figure><h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ awk '条件类型1&#123;动作1&#125; 条件类型2&#123;动作2&#125; ...' filename</span><br></pre></td></tr></table></figure><p>awk 每次处理一行，处理的最小单位是字段，每个字段的命名方式为：\$n，n 为字段号，从 1 开始，\$0 表示一整行。</p><p>范例 1：取出登录用户的用户名和 ip</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ last -n 5</span><br><span class="line">dmtsai pts/0 192.168.1.100 Tue Jul 14 17:32 still logged in</span><br><span class="line">dmtsai pts/0 192.168.1.100 Thu Jul 9 23:36 - 02:58 (03:22)</span><br><span class="line">dmtsai pts/0 192.168.1.100 Thu Jul 9 17:23 - 23:36 (06:12)</span><br><span class="line">dmtsai pts/0 192.168.1.100 Thu Jul 9 08:02 - 08:17 (00:14)</span><br><span class="line">dmtsai tty1 Fri May 29 11:55 - 12:11 (00:15)</span><br><span class="line"></span><br><span class="line">$ last -n 5 | awk '&#123;print $1 "\t" $3&#125;</span><br></pre></td></tr></table></figure><p>awk 变量：</p><table><thead><tr><th>变量名称</th><th>代表意义</th></tr></thead><tbody><tr><td>NF</td><td>每一行拥有的字段总数</td></tr><tr><td>NR</td><td>目前所处理的是第几行数据</td></tr><tr><td>FS</td><td>目前的分隔字符，默认是空格键</td></tr></tbody></table><p>范例 2：输出正在处理的行号，并显示每一行有多少字段</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ last -n 5 | awk '&#123;print $1 "\t lines: " NR "\t columns: " NF&#125;'</span><br><span class="line">dmtsai lines: 1 columns: 10</span><br><span class="line">dmtsai lines: 2 columns: 10</span><br><span class="line">dmtsai lines: 3 columns: 10</span><br><span class="line">dmtsai lines: 4 columns: 10</span><br><span class="line">dmtsai lines: 5 columns: 9</span><br></pre></td></tr></table></figure><p>可以使用大于等于逻辑，其中等于使用 ==。</p><p>范例 3：/etc/passwd 文件第三个字段为 UID，对 UID 小于 10 的数据进行处理。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/passwd | awk &apos;BEGIN &#123;FS=&quot;:&quot;&#125; $3 &lt; 10 &#123;print $1 &quot;\t &quot; $3&#125;&apos;</span><br><span class="line">root 0</span><br><span class="line">bin 1</span><br><span class="line">daemon 2</span><br></pre></td></tr></table></figure><h1 id="vim-三个模式"><a href="#vim-三个模式" class="headerlink" title="vim 三个模式"></a>vim 三个模式</h1><p><br><div align="center"> <img src="../pics/341c632a-1fc1-4068-9b9f-bf7ef68ebb4c.jpg"> </div><br></p><p>在指令列模式下，有以下命令用于离开或者存储文件。</p><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>:w</td><td>写入磁盘</td></tr><tr><td>:w!</td><td>当文件为只读时，强制写入磁盘。到底能不能写入，与用户对该文件的权限有关</td></tr><tr><td>:q</td><td>离开</td></tr><tr><td>:q!</td><td>强制离开不保存</td></tr><tr><td>:wq</td><td>写入磁盘后离开</td></tr><tr><td>:wq!</td><td>强制写入磁盘后离开</td></tr></tbody></table><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>鸟哥. 鸟 哥 的 Linux 私 房 菜 基 础 篇 第 三 版[J]. 2009.</li><li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-rpmdpkg/index.html" target="_blank" rel="noopener">Linux 平台上的软件包管理</a></li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#常用操作以及概念&quot;&gt;常用操作以及概念&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#求助&quot;&gt;求助&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#关机&quot;&gt;关机&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#查看进程&quot;&gt;查看进程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#查看端口&quot;&gt;查看端口&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#path&quot;&gt;PATH&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#运行等级&quot;&gt;运行等级&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#sudo&quot;&gt;sudo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#gnu&quot;&gt;GNU&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#包管理工具&quot;&gt;包管理工具&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#常见发行版本&quot;&gt;常见发行版本&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分区&quot;&gt;分区&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#磁盘的文件名&quot;&gt;磁盘的文件名&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分区表&quot;&gt;分区表&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-mbr&quot;&gt;1. MBR&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-gpt&quot;&gt;2. GPT&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#开机检测程序&quot;&gt;开机检测程序&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-bios&quot;&gt;1. BIOS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-uefi&quot;&gt;2. UEFI&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#挂载&quot;&gt;挂载&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#文件权限与目录配置&quot;&gt;文件权限与目录配置&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#文件权限概念&quot;&gt;文件权限概念&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#文件属性以及权限的修改&quot;&gt;文件属性以及权限的修改&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-修改文件所属群组&quot;&gt;1. 修改文件所属群组&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-修改文件拥有者&quot;&gt;2. 修改文件拥有者&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-修改权限&quot;&gt;3. 修改权限&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#目录的权限&quot;&gt;目录的权限&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#文件默认权限&quot;&gt;文件默认权限&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#目录配置&quot;&gt;目录配置&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#文件与目录&quot;&gt;文件与目录&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#文件时间&quot;&gt;文件时间&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#文件与目录的基本操作&quot;&gt;文件与目录的基本操作&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-ls&quot;&gt;1. ls&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-cp&quot;&gt;2. cp&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-rm&quot;&gt;3. rm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-mv&quot;&gt;4. mv&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#获取文件内容&quot;&gt;获取文件内容&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-cat&quot;&gt;1. cat&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-tac&quot;&gt;2. tac&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-more&quot;&gt;3. more&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-less&quot;&gt;4. less&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-head&quot;&gt;5. head&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#6-tail&quot;&gt;6. tail&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#7-od&quot;&gt;7. od&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#8-touch&quot;&gt;8. touch&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#指令与文件搜索&quot;&gt;指令与文件搜索&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-which&quot;&gt;1. which&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-whereis&quot;&gt;2. whereis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-locate&quot;&gt;3. locate&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-find&quot;&gt;4. find&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#41-与时间有关的选项&quot;&gt;4.1 与时间有关的选项&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-与文件拥有者和所属群组有关的选项&quot;&gt;4.2 与文件拥有者和所属群组有关的选项&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#43-与文件权限和名称有关的选项&quot;&gt;4.3 与文件权限和名称有关的选项&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#磁盘与文件系统&quot;&gt;磁盘与文件系统&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#文件系统的组成&quot;&gt;文件系统的组成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#inode&quot;&gt;inode&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#目录的-inode-与-block&quot;&gt;目录的 inode 与 block&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#实体链接与符号链接&quot;&gt;实体链接与符号链接&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-实体链接&quot;&gt;1. 实体链接&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-符号链接&quot;&gt;2. 符号链接&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#压缩与打包&quot;&gt;压缩与打包&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#压缩&quot;&gt;压缩&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-gzip&quot;&gt;1. gzip&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-bzip2&quot;&gt;2. bzip2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-xz&quot;&gt;3. xz&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#打包&quot;&gt;打包&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#bash&quot;&gt;Bash&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#bash-特性&quot;&gt;Bash 特性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#变量操作&quot;&gt;变量操作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#指令搜索顺序&quot;&gt;指令搜索顺序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#数据流重定向&quot;&gt;数据流重定向&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#管线指令&quot;&gt;管线指令&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-提取指令cut&quot;&gt;1. 提取指令：cut&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-排序命令sortuniq&quot;&gt;2. 排序命令：sort、uniq&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-双向输出重定向tee&quot;&gt;3. 双向输出重定向：tee&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-字符转换指令trcolexpandjoinpaste&quot;&gt;4. 字符转换指令：tr、col、expand、join、paste&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#5-分区指令split&quot;&gt;5. 分区指令：split&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#正规表示法与文件格式化处理&quot;&gt;正规表示法与文件格式化处理&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#grep&quot;&gt;grep&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#printf&quot;&gt;printf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#awk&quot;&gt;awk&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#vim-三个模式&quot;&gt;vim 三个模式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;常用操作以及概念&quot;&gt;&lt;a href=&quot;#常用操作以及概念&quot; class=&quot;headerlink&quot; title=&quot;常用操作以及概念&quot;&gt;&lt;/a&gt;常用操作以及概念&lt;/h1&gt;&lt;h2 id=&quot;求助&quot;&gt;&lt;a href=&quot;#求助&quot; class=&quot;headerlink&quot; title=&quot;求助&quot;&gt;&lt;/a&gt;求助&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;1. –help&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;指令的基本用法与选项介绍。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. man&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;man 是 manual 的缩写，将指令的具体信息显示出来。&lt;/p&gt;
&lt;p&gt;当执行 man date 时，有 DATE(1) 出现，其中的数字代表指令的类型，常用的数字及其类型如下：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;代号&lt;/th&gt;
&lt;th&gt;类型&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;用户在 shell 环境中可以操作的指令或者可执行文件&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;配置文件&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;系统管理员可以使用的管理指令&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>MySQL</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/MySQL.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/MySQL.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:33:56.415Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#存储引擎">存储引擎</a><ul><li><a href="#1-innodb">1. InnoDB</a></li><li><a href="#2-myisam">2. MyISAM</a></li><li><a href="#3-innodb-与-myisam-的比较">3. InnoDB 与 MyISAM 的比较</a></li></ul></li><li><a href="#数据类型">数据类型</a><ul><li><a href="#1-整型">1. 整型</a></li><li><a href="#2-浮点数">2. 浮点数</a></li><li><a href="#3-字符串">3. 字符串</a></li><li><a href="#4-时间和日期">4. 时间和日期</a></li></ul></li><li><a href="#索引">索引</a><ul><li><a href="#1-索引分类">1. 索引分类</a><ul><li><a href="#11-b-tree-索引">1.1 B-Tree 索引</a></li><li><a href="#12-哈希索引">1.2 哈希索引</a></li><li><a href="#13-空间索引r-tree">1.3. 空间索引（R-Tree）</a></li><li><a href="#14-全文索引">1.4 全文索引</a></li></ul></li><li><a href="#2-索引的优点">2. 索引的优点</a></li><li><a href="#3-索引优化">3. 索引优化</a><ul><li><a href="#31-独立的列">3.1 独立的列</a></li><li><a href="#32-前缀索引">3.2 前缀索引</a></li><li><a href="#33-多列索引">3.3 多列索引</a></li><li><a href="#34-索引列的顺序">3.4 索引列的顺序</a></li><li><a href="#35-聚簇索引">3.5 聚簇索引</a></li><li><a href="#36-覆盖索引">3.6 覆盖索引</a></li></ul></li><li><a href="#4-b-tree-和-b+tree-原理">4. B-Tree 和 B+Tree 原理</a><ul><li><a href="#4-1-b-tree">4. 1 B-Tree</a></li><li><a href="#42-b+tree">4.2 B+Tree</a></li><li><a href="#43-带有顺序访问指针的-b+tree">4.3 带有顺序访问指针的 B+Tree</a></li><li><a href="#44-为什么使用-b-tree-和-b+tree">4.4 为什么使用 B-Tree 和 B+Tree</a></li></ul></li></ul></li><li><a href="#查询性能优化">查询性能优化</a><ul><li><a href="#1-explain">1. Explain</a></li><li><a href="#2-减少返回的列">2. 减少返回的列</a></li><li><a href="#3-减少返回的行">3. 减少返回的行</a></li><li><a href="#4-拆分大的-delete-或-insert-语句">4. 拆分大的 DELETE 或 INSERT 语句</a></li></ul></li><li><a href="#分库与分表">分库与分表</a></li><li><a href="#故障转移和故障恢复">故障转移和故障恢复</a><ul><li><a href="#1-故障转移">1. 故障转移</a></li><li><a href="#2-故障恢复">2. 故障恢复</a></li></ul></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h1><h2 id="1-InnoDB"><a href="#1-InnoDB" class="headerlink" title="1. InnoDB"></a>1. InnoDB</h2><p>InnoDB 是 MySQL 默认的事务型存储引擎，只有在需要 InnoDB 不支持的特性时，才考虑使用其它存储引擎。</p><p>采用 MVCC 来支持高并发，并且实现了四个标准的隔离级别，默认级别是可重复读。</p><p>表是基于聚簇索引建立的，它对主键的查询性能有很高的提升。</p><p>内部做了很多优化，包括从磁盘读取数据时采用的可预测性读、能够自动在内存中创建哈希索引以加速读操作的自适应哈希索引、能够加速插入操作的插入缓冲区等。</p><p>通过一些机制和工具支持真正的热备份。</p><a id="more"></a><h2 id="2-MyISAM"><a href="#2-MyISAM" class="headerlink" title="2. MyISAM"></a>2. MyISAM</h2><p>MyISAM 提供了大量的特性，包括全文索引、压缩、空间函数（GIS）等。但 MyISAM 不支持事务和行级锁，而且崩溃后无法安全恢复。</p><p>只能对整张表加锁，而不是针对行。</p><p>可以手工或者自动执行检查和修复操作，但是和事务恢复以及崩溃恢复不同，可能导致一些数据丢失，而且修复操作是非常慢的。</p><p>可以包含动态或者静态的行。</p><p>如果指定了 DELAY_KEY_WRITE 选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。</p><p>如果表在创建并导入数据以后，不会再进行修改操作，那么这样的表适合采用 MyISAM 压缩表。</p><p>对于只读数据，或者表比较小、可以容忍修复操作，则依然可以继续使用 MyISAM。</p><p>MyISAM 设计简单，数据以紧密格式存储，所以在某些场景下性能很好。</p><h2 id="3-InnoDB-与-MyISAM-的比较"><a href="#3-InnoDB-与-MyISAM-的比较" class="headerlink" title="3. InnoDB 与 MyISAM 的比较"></a>3. InnoDB 与 MyISAM 的比较</h2><p><strong>事务</strong> </p><p>InnoDB 是事务型的。</p><p><strong>备份</strong> </p><p>InnoDB 支持在线热备份。</p><p><strong>崩溃恢复</strong> </p><p>MyISAM 崩溃后发生损坏的概率比 InnoDB 高很多，而且恢复的速度也更慢。</p><p><strong>并发</strong> </p><p>MyISAM 只支持表级锁，而 InnoDB 还支持行级锁。</p><p><strong>其它特性</strong> </p><p>MyISAM 支持全文索引，地理空间索引。</p><h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><h2 id="1-整型"><a href="#1-整型" class="headerlink" title="1. 整型"></a>1. 整型</h2><p>TINYINT, SMALLINT, MEDIUMINT, INT, BIGINT 分别使用 8, 16, 24, 32, 64 位存储空间，一般情况下越小的列越好。</p><p>INT(11) 中的数字只是规定了交互工具显示字符的个数，对于存储和计算来说是没有意义的。</p><h2 id="2-浮点数"><a href="#2-浮点数" class="headerlink" title="2. 浮点数"></a>2. 浮点数</h2><p>FLOAT 和 DOUBLE 为浮点类型，DECIMAL 为高精度小数类型。CPU 原生支持浮点运算，但是不支持 DECIMAl 类型的计算，因此 DECIMAL 的计算比浮点类型需要更高的代价。</p><p>FLOAT、DOUBLE 和 DECIMAL 都可以指定列宽，例如 DECIMAL(18, 9) 表示总共 18 位，取 9 位存储小数部分，剩下 9 位存储整数部分。</p><h2 id="3-字符串"><a href="#3-字符串" class="headerlink" title="3. 字符串"></a>3. 字符串</h2><p>主要有 CHAR 和 VARCHAR 两种类型，一种是定长的，一种是变长的。</p><p>VARCHAR 这种变长类型能够节省空间，因为只需要存储必要的内容。但是在执行 UPDATE 时可能会使行变得比原来长，当超出一个页所能容纳的大小时，就要执行额外的操作。MyISAM 会将行拆成不同的片段存储，而 InnoDB 则需要分裂页来使行放进页内。</p><p>VARCHAR 会保留字符串末尾的空格，而 CHAR 会删除。</p><h2 id="4-时间和日期"><a href="#4-时间和日期" class="headerlink" title="4. 时间和日期"></a>4. 时间和日期</h2><p>MySQL 提供了两种相似的日期时间类型：DATATIME 和 TIMESTAMP。</p><p><strong>DATATIME</strong> </p><p>能够保存从 1001 年到 9999 年的日期和时间，精度为秒，使用 8 字节的存储空间。</p><p>它与时区无关。</p><p>默认情况下，MySQL 以一种可排序的、无歧义的格式显示 DATATIME 值，例如“2008-01-16 22:37:08”，这是 ANSI 标准定义的日期和时间表示方法。</p><p><strong>TIMESTAMP</strong> </p><p>和 UNIX 时间戳相同，保存从 1970 年 1 月 1 日午夜（格林威治时间）以来的秒数，使用 4 个字节，只能表示从 1970 年 到 2038 年。</p><p>它和时区有关。</p><p>MySQL 提供了 FROM_UNIXTIME() 函数把 UNIX 时间戳转换为日期，并提供了 UNIX_TIMESTAMP() 函数把日期转换为 UNIX 时间戳。</p><p>默认情况下，如果插入时没有指定 TIMESTAMP 列的值，会将这个值设置为当前时间。</p><p>应该尽量使用 TIMESTAMP，因为它比 DATETIME 空间效率更高。</p><h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>索引是在存储引擎层实现的，而不是在服务器层实现的，所以不同存储引擎具有不同的索引类型和实现。</p><p>索引能够轻易将查询性能提升几个数量级。</p><p>对于非常小的表、大部分情况下简单的全表扫描比建立索引更高效。对于中到大型的表，索引就非常有效。但是对于特大型的表，建立和使用索引的代价将会随之增长。这种情况下，需要用到一种技术可以直接区分出需要查询的一组数据，而不是一条记录一条记录地匹配，例如可以使用分区技术。</p><h2 id="1-索引分类"><a href="#1-索引分类" class="headerlink" title="1. 索引分类"></a>1. 索引分类</h2><h3 id="1-1-B-Tree-索引"><a href="#1-1-B-Tree-索引" class="headerlink" title="1.1 B-Tree 索引"></a>1.1 B-Tree 索引</h3><p>B-Tree 索引是大多数 MySQL 存储引擎的默认索引类型。</p><p>因为不再需要进行全表扫描，只需要对树进行搜索即可，因此查找速度快很多。</p><p>可以指定多个列作为索引列，多个索引列共同组成键。B-Tree 索引适用于全键值、键值范围和键前缀查找，其中键前缀查找只适用于最左前缀查找。</p><p>除了用于查找，还可以用于排序和分组。</p><p>如果不是按照索引列的顺序进行查找，则无法使用索引。</p><h3 id="1-2-哈希索引"><a href="#1-2-哈希索引" class="headerlink" title="1.2 哈希索引"></a>1.2 哈希索引</h3><p>基于哈希表实现，优点是查找非常快。</p><p>在 MySQL 中只有 Memory 引擎显式支持哈希索引。</p><p>InnoDB 引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用的非常频繁时，会在 B-Tree 索引之上再创建一个哈希索引，这样就让 B-Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。</p><p>限制：哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值来避免读取行。不过，访问内存中的行的速度很快，所以大部分情况下这一点对性能影响并不明显；无法用于分组与排序；只支持精确查找，无法用于部分查找和范围查找；如果哈希冲突很多，查找速度会变得很慢。</p><h3 id="1-3-空间索引（R-Tree）"><a href="#1-3-空间索引（R-Tree）" class="headerlink" title="1.3. 空间索引（R-Tree）"></a>1.3. 空间索引（R-Tree）</h3><p>MyISAM 存储引擎支持空间索引，可以用于地理数据存储。</p><p>空间索引会从所有维度来索引数据，可以有效地使用任意维度来进行组合查询。</p><h3 id="1-4-全文索引"><a href="#1-4-全文索引" class="headerlink" title="1.4 全文索引"></a>1.4 全文索引</h3><p>MyISAM 存储引擎支持全文索引，用于查找文本中的关键词，而不是直接比较索引中的值。</p><p>使用 MATCH AGAINST，而不是普通的 WHERE。</p><h2 id="2-索引的优点"><a href="#2-索引的优点" class="headerlink" title="2. 索引的优点"></a>2. 索引的优点</h2><ul><li><p>大大减少了服务器需要扫描的数据量；</p></li><li><p>帮助服务器避免进行排序和创建临时表；</p></li><li><p>将随机 I/O 变为顺序 I/O。</p></li></ul><h2 id="3-索引优化"><a href="#3-索引优化" class="headerlink" title="3. 索引优化"></a>3. 索引优化</h2><h3 id="3-1-独立的列"><a href="#3-1-独立的列" class="headerlink" title="3.1 独立的列"></a>3.1 独立的列</h3><p>在进行查询时，索引列不能是表达式的一部分，也不能是函数的参数，否则无法使用索引。</p><p>例如下面的查询不能使用 actor_id 列的索引：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> sakila.actor <span class="keyword">WHERE</span> actor_id + <span class="number">1</span> = <span class="number">5</span>;</span><br></pre></td></tr></table></figure><h3 id="3-2-前缀索引"><a href="#3-2-前缀索引" class="headerlink" title="3.2 前缀索引"></a>3.2 前缀索引</h3><p>对于 BLOB、TEXT 和 VARCHAR 类型的列，必须使用前缀索引，只索引开始的部分字符。</p><p>对于前缀长度的选取需要根据  <strong>索引选择性</strong>  来确定：不重复的索引值和记录总数的比值。选择性越高，查询效率也越高。最大值为 1 ，此时每个记录都有唯一的索引与其对应。</p><h3 id="3-3-多列索引"><a href="#3-3-多列索引" class="headerlink" title="3.3 多列索引"></a>3.3 多列索引</h3><p>在需要使用多个列作为条件进行查询时，使用多列索引比使用多个单列索引性能更好。例如下面的语句中，最好把 actor_id 和 file_id 设置为多列索引。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> file_id, actor_ <span class="keyword">id</span> <span class="keyword">FROM</span> sakila.film_actor</span><br><span class="line"><span class="keyword">WhERE</span> actor_id = <span class="number">1</span> <span class="keyword">OR</span> film_id = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="3-4-索引列的顺序"><a href="#3-4-索引列的顺序" class="headerlink" title="3.4 索引列的顺序"></a>3.4 索引列的顺序</h3><p>让选择性最强的索引列放在前面，例如下面显示的结果中 customer_id 的选择性比 staff_id 更高，因此最好把 customer_id 列放在多列索引的前面。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> staff_id)/<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> staff_id_selectivity,</span><br><span class="line"><span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> customer_id)/<span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> customer_id_selectivity,</span><br><span class="line"><span class="keyword">COUNT</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> payment;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   staff_id_selectivity: 0.0001</span><br><span class="line">customer_id_selectivity: 0.0373</span><br><span class="line">               COUNT(*): 16049</span><br></pre></td></tr></table></figure><h3 id="3-5-聚簇索引"><a href="#3-5-聚簇索引" class="headerlink" title="3.5 聚簇索引"></a>3.5 聚簇索引</h3><p><br><div align="center"> <img src="../pics/b9e9ae8c-e216-4c01-b267-a50dbeb98fa4.jpg"> </div><br></p><p>聚簇索引并不是一种索引类型，而是一种数据存储方式。</p><p>术语“聚簇”表示数据行和相邻的键值紧密地存储在一起，InnoDB 的聚簇索引的数据行存放在 B-Tree 的叶子页中。</p><p>因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引。</p><p><strong>优点</strong> </p><ol><li>可以把相关数据保存在一起，减少 I/O 操作；</li><li>因为数据保存在 B-Tree 中，因此数据访问更快。</li></ol><p><strong>缺点</strong> </p><ol><li>聚簇索引最大限度提高了 I/O 密集型应用的性能，但是如果数据全部放在内存，就没必要用聚簇索引。</li><li>插入速度严重依赖于插入顺序，按主键的顺序插入是最快的。</li><li>更新操作代价很高，因为每个被更新的行都会移动到新的位置。</li><li>当插入到某个已满的页中，存储引擎会将该页分裂成两个页面来容纳该行，页分裂会导致表占用更多的磁盘空间。</li><li>如果行比较稀疏，或者由于页分裂导致数据存储不连续时，聚簇索引可能导致全表扫描速度变慢。</li></ol><h3 id="3-6-覆盖索引"><a href="#3-6-覆盖索引" class="headerlink" title="3.6 覆盖索引"></a>3.6 覆盖索引</h3><p>索引包含所有需要查询的字段的值。</p><h2 id="4-B-Tree-和-B-Tree-原理"><a href="#4-B-Tree-和-B-Tree-原理" class="headerlink" title="4. B-Tree 和 B+Tree 原理"></a>4. B-Tree 和 B+Tree 原理</h2><h3 id="4-1-B-Tree"><a href="#4-1-B-Tree" class="headerlink" title="4. 1 B-Tree"></a>4. 1 B-Tree</h3><p><br><div align="center"> <img src="../pics/5ed71283-a070-4b21-85ae-f2cbfd6ba6e1.jpg"> </div><br></p><p>为了描述 B-Tree，首先定义一条数据记录为一个二元组 [key, data]，key 为记录的键，data 为数据记录除 key 外的数据。</p><p>B-Tree 是满足下列条件的数据结构：</p><ul><li>所有叶节点具有相同的深度，也就是说 B-Tree 是平衡的；</li><li>一个节点中的 key 从左到右非递减排列；</li><li>如果某个指针的左右相邻 key 分别是 key<sub>i</sub> 和 key<sub>i+1</sub>，且不为 null，则该指针指向节点的所有 key 大于 key<sub>i</sub> 且小于 key<sub>i+1</sub>。</li></ul><p>在 B-Tree 中按 key 检索数据的算法非常直观：首先从根节点进行二分查找，如果找到则返回对应节点的 data，否则对相应区间的指针指向的节点递归进行查找，直到找到节点或找到 null 指针，前者查找成功，后者查找失败。</p><p>由于插入删除新的数据记录会破坏 B-Tree 的性质，因此在插入删除时，需要对树进行一个分裂、合并、转移等操作以保持 B-Tree 性质。</p><h3 id="4-2-B-Tree"><a href="#4-2-B-Tree" class="headerlink" title="4.2 B+Tree"></a>4.2 B+Tree</h3><p><br><div align="center"> <img src="../pics/63cd5b50-d6d8-4df6-8912-ef4a1dd5ba13.jpg"> </div><br></p><p>与 B-Tree 相比，B+Tree 有以下不同点：</p><ul><li>每个节点的指针上限为 2d 而不是 2d+1；</li><li>内节点不存储 data，只存储 key，叶子节点不存储指针。</li></ul><h3 id="4-3-带有顺序访问指针的-B-Tree"><a href="#4-3-带有顺序访问指针的-B-Tree" class="headerlink" title="4.3 带有顺序访问指针的 B+Tree"></a>4.3 带有顺序访问指针的 B+Tree</h3><p><br><div align="center"> <img src="../pics/1ee5f0a5-b8df-43b9-95ab-c516c54ec797.jpg"> </div><br></p><p>一般在数据库系统或文件系统中使用的 B+Tree 结构都在经典 B+Tree 基础上进行了优化，在叶子节点增加了顺序访问指针，做这个优化的目的是为了提高区间访问的性能。</p><h3 id="4-4-为什么使用-B-Tree-和-B-Tree"><a href="#4-4-为什么使用-B-Tree-和-B-Tree" class="headerlink" title="4.4 为什么使用 B-Tree 和 B+Tree"></a>4.4 为什么使用 B-Tree 和 B+Tree</h3><p>红黑树等数据结构也可以用来实现索引，但是文件系统及数据库系统普遍采用 B-/+Tree 作为索引结构。</p><p>页是计算机管理存储器的逻辑块，硬件及操作系统往往将主存和磁盘存储区分割为连续的大小相等的块，每个存储块称为一页（在许多操作系统中，页得大小通常为 4k），主存和磁盘以页为单位交换数据。</p><p>一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。为了减少磁盘 I/O，磁盘往往不是严格按需读取，而是每次都会预读。这样做的理论依据是计算机科学中著名的局部性原理：当一个数据被用到时，其附近的数据也通常会马上被使用。数据库系统的设计者巧妙利用了磁盘预读原理，将一个节点的大小设为等于一个页，这样每个节点只需要一次 I/O 就可以完全载入。B-Tree 中一次检索最多需要 h-1 次 I/O（根节点常驻内存），渐进复杂度为 O(h)=O(logdN)。一般实际应用中，出度 d 是非常大的数字，通常超过 100，因此 h 非常小（通常不超过 3）。而红黑树这种结构，h 明显要深的多。并且于逻辑上很近的节点（父子）物理上可能很远，无法利用局部性，效率明显比 B-Tree 差很多。</p><p>B+Tree 更适合外存索引，原因和内节点出度 d 有关。由于 B+Tree 内节点去掉了 data 域，因此可以拥有更大的出度，拥有更好的性能。</p><h1 id="查询性能优化"><a href="#查询性能优化" class="headerlink" title="查询性能优化"></a>查询性能优化</h1><h2 id="1-Explain"><a href="#1-Explain" class="headerlink" title="1. Explain"></a>1. Explain</h2><p>用来分析 SQL 语句，分析结果中比较重要的字段有：</p><ul><li><p>select_type : 查询类型，有简单查询、联合查询和子查询</p></li><li><p>key : 使用的索引</p></li><li><p>rows : 扫描的行数</p></li></ul><h2 id="2-减少返回的列"><a href="#2-减少返回的列" class="headerlink" title="2. 减少返回的列"></a>2. 减少返回的列</h2><p>慢查询主要是因为访问了过多数据，除了访问过多行之外，也包括访问过多列。</p><p>最好不要使用 SELECT * 语句，要根据需要选择查询的列。</p><h2 id="3-减少返回的行"><a href="#3-减少返回的行" class="headerlink" title="3. 减少返回的行"></a>3. 减少返回的行</h2><p>最好使用 LIMIT 语句来取出想要的那些行。</p><p>还可以建立索引来减少条件语句的全表扫描。例如对于下面的语句，不适用索引的情况下需要进行全表扫描，而使用索引只需要扫描几行记录即可，使用 Explain 语句可以通过观察 rows 字段来看出这种差异。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sakila.film_actor <span class="keyword">WHERE</span> film_id = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h2 id="4-拆分大的-DELETE-或-INSERT-语句"><a href="#4-拆分大的-DELETE-或-INSERT-语句" class="headerlink" title="4. 拆分大的 DELETE 或 INSERT 语句"></a>4. 拆分大的 DELETE 或 INSERT 语句</h2><p>如果一次性执行的话，可能一次锁住很多数据、占满整个事务日志、耗尽系统资源、阻塞很多小的但重要的查询。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELEFT FROM messages WHERE <span class="keyword">create</span> &lt; <span class="keyword">DATE_SUB</span>(<span class="keyword">NOW</span>(), <span class="built_in">INTERVAL</span> <span class="number">3</span> <span class="keyword">MONTH</span>);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rows_affected = 0</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    rows_affected = do_query(</span><br><span class="line">    <span class="string">"DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000"</span>)</span><br><span class="line">&#125; <span class="keyword">while</span> rows_affected &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure><h1 id="分库与分表"><a href="#分库与分表" class="headerlink" title="分库与分表"></a>分库与分表</h1><p><strong>1. 分表与分区的不同</strong> </p><p>分表，就是讲一张表分成多个小表，这些小表拥有不同的表名；而分区是将一张表的数据分为多个区块，这些区块可以存储在同一个磁盘上，也可以存储在不同的磁盘上，这种方式下表仍然只有一个。</p><p><strong>2. 使用分库与分表的原因</strong> </p><p>随着时间和业务的发展，数据库中的表会越来越多，并且表中的数据量也会越来越大，那么读写操作的开销也会随着增大。</p><p><strong>3. 垂直切分</strong> </p><p>将表按功能模块、关系密切程度划分出来，部署到不同的库上。例如，我们会建立商品数据库 payDB、用户数据库 userDB 等，分别用来存储项目与商品有关的表和与用户有关的表。</p><p><strong>4. 水平切分</strong> </p><p>把表中的数据按照某种规则存储到多个结构相同的表中，例如按 id 的散列值、性别等进行划分，</p><p><strong>5. 垂直切分与水平切分的选择</strong> </p><p>如果数据库中的表太多，并且项目各项业务逻辑清晰，那么垂直切分是首选。</p><p>如果数据库的表不多，但是单表的数据量很大，应该选择水平切分。</p><p><strong>6. 水平切分的实现方式</strong> </p><p>最简单的是使用 merge 存储引擎。</p><p><strong>7. 分库与分表存在的问题</strong> </p><p>(1) 事务问题</p><p>在执行分库分表之后，由于数据存储到了不同的库上，数据库事务管理出现了困难。如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价；如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。</p><p>(2) 跨库跨表连接问题</p><p>在执行了分库分表之后，难以避免会将原本逻辑关联性很强的数据划分到不同的表、不同的库上。这时，表的连接操作将受到限制，我们无法连接位于不同分库的表，也无法连接分表粒度不同的表，导致原本只需要一次查询就能够完成的业务需要进行多次才能完成。</p><h1 id="故障转移和故障恢复"><a href="#故障转移和故障恢复" class="headerlink" title="故障转移和故障恢复"></a>故障转移和故障恢复</h1><p>故障转移也叫做切换，当主库出现故障时就切换到备库，使备库成为主库。故障恢复顾名思义就是从故障中恢复过来，并且保证数据的正确性。</p><h2 id="1-故障转移"><a href="#1-故障转移" class="headerlink" title="1. 故障转移"></a>1. 故障转移</h2><p><strong>1.1 提升备库或切换角色</strong> </p><p>提升一台备库为主库，或者在一个主-主复制结构中调整主动和被动角色。</p><p><strong>1.2 虚拟 IP 地址和 IP 托管</strong> </p><p>为 MySQL 实例指定一个逻辑 IP 地址，当 MySQL 实例失效时，可以将 IP 地址转移到另一台 MySQL 服务器上。</p><p><strong>1.3 中间件解决方案</strong> </p><p>通过代理，可以路由流量到可以使用的服务器上。</p><p><br><div align="center"> <img src="../pics/fabd5fa0-b75e-48d0-9e2c-31471945ceb9.jpg"> </div><br></p><p><strong>1.4 在应用中处理故障转移</strong> </p><p>将故障转移整合到应用中可能导致应用变得太过笨拙。</p><h2 id="2-故障恢复"><a href="#2-故障恢复" class="headerlink" title="2. 故障恢复"></a>2. 故障恢复</h2><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>高性能 MySQL</li><li><a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html" target="_blank" rel="noopener">MySQL 索引背后的数据结构及算法原理 </a></li><li><a href="http://www.runoob.com/w3cnote/mysql-index.html" target="_blank" rel="noopener">MySQL 索引优化全攻略 </a></li><li><a href="https://www.jfox.info/20-tiao-mysql-xing-nen-you-hua-de-zui-jia-jing-yan.html" target="_blank" rel="noopener">20+ 条 MySQL 性能优化的最佳经验 </a></li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#存储引擎&quot;&gt;存储引擎&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-innodb&quot;&gt;1. InnoDB&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-myisam&quot;&gt;2. MyISAM&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-innodb-与-myisam-的比较&quot;&gt;3. InnoDB 与 MyISAM 的比较&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#数据类型&quot;&gt;数据类型&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-整型&quot;&gt;1. 整型&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-浮点数&quot;&gt;2. 浮点数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-字符串&quot;&gt;3. 字符串&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-时间和日期&quot;&gt;4. 时间和日期&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#索引&quot;&gt;索引&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-索引分类&quot;&gt;1. 索引分类&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#11-b-tree-索引&quot;&gt;1.1 B-Tree 索引&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#12-哈希索引&quot;&gt;1.2 哈希索引&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#13-空间索引r-tree&quot;&gt;1.3. 空间索引（R-Tree）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#14-全文索引&quot;&gt;1.4 全文索引&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-索引的优点&quot;&gt;2. 索引的优点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-索引优化&quot;&gt;3. 索引优化&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#31-独立的列&quot;&gt;3.1 独立的列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#32-前缀索引&quot;&gt;3.2 前缀索引&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#33-多列索引&quot;&gt;3.3 多列索引&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#34-索引列的顺序&quot;&gt;3.4 索引列的顺序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#35-聚簇索引&quot;&gt;3.5 聚簇索引&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#36-覆盖索引&quot;&gt;3.6 覆盖索引&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-b-tree-和-b+tree-原理&quot;&gt;4. B-Tree 和 B+Tree 原理&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#4-1-b-tree&quot;&gt;4. 1 B-Tree&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#42-b+tree&quot;&gt;4.2 B+Tree&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#43-带有顺序访问指针的-b+tree&quot;&gt;4.3 带有顺序访问指针的 B+Tree&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#44-为什么使用-b-tree-和-b+tree&quot;&gt;4.4 为什么使用 B-Tree 和 B+Tree&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#查询性能优化&quot;&gt;查询性能优化&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-explain&quot;&gt;1. Explain&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-减少返回的列&quot;&gt;2. 减少返回的列&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-减少返回的行&quot;&gt;3. 减少返回的行&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-拆分大的-delete-或-insert-语句&quot;&gt;4. 拆分大的 DELETE 或 INSERT 语句&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分库与分表&quot;&gt;分库与分表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#故障转移和故障恢复&quot;&gt;故障转移和故障恢复&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-故障转移&quot;&gt;1. 故障转移&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-故障恢复&quot;&gt;2. 故障恢复&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;存储引擎&quot;&gt;&lt;a href=&quot;#存储引擎&quot; class=&quot;headerlink&quot; title=&quot;存储引擎&quot;&gt;&lt;/a&gt;存储引擎&lt;/h1&gt;&lt;h2 id=&quot;1-InnoDB&quot;&gt;&lt;a href=&quot;#1-InnoDB&quot; class=&quot;headerlink&quot; title=&quot;1. InnoDB&quot;&gt;&lt;/a&gt;1. InnoDB&lt;/h2&gt;&lt;p&gt;InnoDB 是 MySQL 默认的事务型存储引擎，只有在需要 InnoDB 不支持的特性时，才考虑使用其它存储引擎。&lt;/p&gt;
&lt;p&gt;采用 MVCC 来支持高并发，并且实现了四个标准的隔离级别，默认级别是可重复读。&lt;/p&gt;
&lt;p&gt;表是基于聚簇索引建立的，它对主键的查询性能有很高的提升。&lt;/p&gt;
&lt;p&gt;内部做了很多优化，包括从磁盘读取数据时采用的可预测性读、能够自动在内存中创建哈希索引以加速读操作的自适应哈希索引、能够加速插入操作的插入缓冲区等。&lt;/p&gt;
&lt;p&gt;通过一些机制和工具支持真正的热备份。&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>代码风格规范</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E8%A7%84%E8%8C%83.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/代码风格规范.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:34:25.308Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Google-Java-Style-Guide"><a href="#Google-Java-Style-Guide" class="headerlink" title="Google Java Style Guide"></a>Google Java Style Guide</h1><ul><li><a href="http://www.hawstein.com/posts/google-java-style.html" target="_blank" rel="noopener">http://www.hawstein.com/posts/google-java-style.html</a></li><li><a href="http://google.github.io/styleguide/javaguide.html" target="_blank" rel="noopener">http://google.github.io/styleguide/javaguide.html</a></li></ul><a id="more"></a><h1 id="Google-C-Style-Guide"><a href="#Google-C-Style-Guide" class="headerlink" title="Google C++ Style Guide"></a>Google C++ Style Guide</h1><ul><li><a href="http://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/contents/" target="_blank" rel="noopener">http://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/contents/</a></li><li><a href="http://google.github.io/styleguide/cppguide.html" target="_blank" rel="noopener">http://google.github.io/styleguide/cppguide.html</a></li></ul><h1 id="Google-Python-Style-Guide"><a href="#Google-Python-Style-Guide" class="headerlink" title="Google Python Style Guide"></a>Google Python Style Guide</h1><ul><li><a href="http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/contents/" target="_blank" rel="noopener">http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/contents/</a></li><li><a href="http://google.github.io/styleguide/pyguide.html" target="_blank" rel="noopener">http://google.github.io/styleguide/pyguide.html</a></li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Google-Java-Style-Guide&quot;&gt;&lt;a href=&quot;#Google-Java-Style-Guide&quot; class=&quot;headerlink&quot; title=&quot;Google Java Style Guide&quot;&gt;&lt;/a&gt;Google Java Style Guide&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.hawstein.com/posts/google-java-style.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://www.hawstein.com/posts/google-java-style.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://google.github.io/styleguide/javaguide.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://google.github.io/styleguide/javaguide.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>SQL语法</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/SQL%20%E8%AF%AD%E6%B3%95.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/SQL 语法.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:34:11.442Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#基础">基础</a></li><li><a href="#创建表">创建表</a></li><li><a href="#插入">插入</a></li><li><a href="#更新">更新</a></li><li><a href="#删除">删除</a></li><li><a href="#修改表">修改表</a></li><li><a href="#查询">查询</a></li><li><a href="#排序">排序</a></li><li><a href="#过滤">过滤</a></li><li><a href="#通配符">通配符</a></li><li><a href="#计算字段">计算字段</a></li><li><a href="#函数">函数</a><ul><li><a href="#文本处理">文本处理</a></li><li><a href="#日期和时间处理">日期和时间处理</a></li><li><a href="#数值处理">数值处理</a></li><li><a href="#汇总">汇总</a></li></ul></li><li><a href="#分组">分组</a></li><li><a href="#子查询">子查询</a></li><li><a href="#连接">连接</a><ul><li><a href="#内连接">内连接</a></li><li><a href="#自连接">自连接</a></li><li><a href="#自然连接">自然连接</a></li><li><a href="#外连接">外连接</a></li></ul></li><li><a href="#组合查询">组合查询</a></li><li><a href="#视图">视图</a></li><li><a href="#存储过程">存储过程</a></li><li><a href="#游标">游标</a></li><li><a href="#触发器">触发器</a></li><li><a href="#事务处理">事务处理</a></li><li><a href="#字符集">字符集</a></li><li><a href="#权限管理">权限管理</a><!-- GFM-TOC --></li></ul><h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><p>模式定义了数据如何存储、存储什么样的数据以及数据如何分解等信息，数据库和表都有模式。</p><p>主键的值不允许修改，也不允许复用（不能使用已经删除的主键值赋给新数据行的主键）。</p><p>SQL（Structured Query Language)，标准 SQL 由 ANSI 标准委员会管理，从而称为 ANSI SQL。各个 DBMS 都有自己的实现，如 PL/SQL、Transact-SQL 等。</p><p>SQL 语句不区分大小写，但是数据库表名、列名和值是否区分依赖于具体的 DBMS 以及配置。</p><p>SQL 支持以下三种注释：</p><a id="more"></a><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 注释</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable; <span class="comment">-- 注释</span></span><br><span class="line"><span class="comment">/* 注释1</span></span><br><span class="line"><span class="comment">   注释2 */</span></span><br></pre></td></tr></table></figure><h1 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mytable (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  col1 <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">  col2 <span class="built_in">VARCHAR</span>(<span class="number">45</span>) <span class="literal">NULL</span>,</span><br><span class="line">  col3 <span class="built_in">DATE</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>));</span><br></pre></td></tr></table></figure><h1 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h1><p><strong>普通插入</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mytable(col1, col2)</span><br><span class="line"><span class="keyword">VALUES</span>(val1, val2);</span><br></pre></td></tr></table></figure><p><strong>插入检索出来的数据</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mytable1(col1, col2)</span><br><span class="line"><span class="keyword">SELECT</span> col1, col2</span><br><span class="line"><span class="keyword">FROM</span> mytable2;</span><br></pre></td></tr></table></figure><p><strong>将一个表的内容复制到一个新表</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> newtable <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure><h1 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> mytable</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">col</span> = val</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h1 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p><strong>TRUNCATE TABLE</strong>  可以清空表，也就是删除所有行。</p><p>使用更新和删除操作时一定要用 WHERE 子句，不然会把整张表的数据都破坏。可以先用 SELECT 语句进行测试，防止错误删除。</p><h1 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h1><p><strong>添加列</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">col</span> <span class="built_in">CHAR</span>(<span class="number">20</span>);</span><br></pre></td></tr></table></figure><p><strong>删除列</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> <span class="keyword">col</span>;</span><br></pre></td></tr></table></figure><p><strong>删除表</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> mytable;</span><br></pre></td></tr></table></figure><h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><p><strong>DISTINCT</strong> </p><p>相同值只会出现一次。它作用于所有列，也就是说所有列的值都相同才算相同。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> col1, col2</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure><p><strong>LIMIT</strong> </p><p>限制返回的行数。可以有两个参数，第一个参数为起始行，从 0 开始；第二个参数为返回的总行数。</p><p>返回前 5 行：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">0</span>, <span class="number">5</span>;</span><br></pre></td></tr></table></figure><p>返回第 3 ~ 5 行：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">2</span>, <span class="number">3</span>;</span><br></pre></td></tr></table></figure><h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><ul><li><strong>ASC</strong> ：升序（默认）</li><li><strong>DESC</strong> ：降序</li></ul><p>可以按多个列进行排序，并且为每个列指定不同的排序方式：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> col1 <span class="keyword">DESC</span>, col2 <span class="keyword">ASC</span>;</span><br></pre></td></tr></table></figure><h1 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h1><p>不进行过滤的数据非常大，导致通过网络传输了很多多余的数据，从而浪费了网络带宽。因此尽量使用 SQL 语句来过滤不必要的数据，而不是传输所有的数据到客户端中然后由客户端进行过滤。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><p>下表显示了 WHERE 子句可用的操作符</p><table><thead><tr><th>操作符</th><th>说明</th></tr></thead><tbody><tr><td>= &lt;  &gt;</td><td>等于 小于 大于</td></tr><tr><td>&lt;&gt; !=</td><td>不等于</td></tr><tr><td>&lt;= !&gt;</td><td>小于等于</td></tr><tr><td>&gt;= !&lt;</td><td>大于等于</td></tr><tr><td>BETWEEN</td><td>在两个值之间</td></tr><tr><td>IS NULL</td><td>为NULL值</td></tr></tbody></table><p>应该注意到，NULL 与 0 、空字符串都不同。</p><p><strong>AND OR</strong>  用于连接多个过滤条件。优先处理 AND，因此当一个过滤表达式涉及到多个 AND 和 OR 时，应当使用 () 来决定优先级。</p><p><strong>IN</strong>  操作符用于匹配一组值，其后也可以接一个 SELECT 子句，从而匹配子查询得到的一组值。</p><p><strong>NOT</strong>  操作符用于否定一个条件。</p><h1 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h1><p>通配符也是用在过滤语句中，但它只能用于文本字段。</p><ul><li><p><strong>%</strong>  匹配 &gt;=0 个任意字符，类似于 *；</p></li><li><p><strong>_</strong>  匹配 ==1 个任意字符，类似于 .；</p></li><li><p><strong>[ ]</strong>  可以匹配集合内的字符，例如 [ab] 将匹配字符 a 或者 b。用脱字符 ^ 可以对其进行否定，也就是不匹配集合内的字符。</p></li></ul><p>使用 Like 来进行通配符匹配。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> <span class="keyword">LIKE</span> <span class="string">'[^AB]%'</span> <span class="comment">-- 不以 A 和 B 开头的任意文本</span></span><br></pre></td></tr></table></figure><p>不要滥用通配符，通配符位于开头处匹配会非常慢。</p><h1 id="计算字段"><a href="#计算字段" class="headerlink" title="计算字段"></a>计算字段</h1><p>在数据库服务器上完成数据的转换和格式化的工作往往比客户端上快得多，并且转换和格式化后的数据量更少的话可以减少网络通信量。</p><p>计算字段通常需要使用  <strong>AS</strong>  来取别名，否则输出的时候字段名为计算表达式。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col1*col2 <span class="keyword">AS</span> <span class="keyword">alias</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br></pre></td></tr></table></figure><p><strong>Concat()</strong>  用于连接两个字段。许多数据库会使用空格把一个值填充为列宽，因此连接的结果会出现一些不必要的空格，使用 <strong>TRIM()</strong> 可以去除首尾空格。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Concat</span>(<span class="keyword">TRIM</span>(col1), <span class="string">' ('</span>, <span class="keyword">TRIM</span>(col2), <span class="string">')'</span>)</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br></pre></td></tr></table></figure><h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>各个 DBMS 的函数都是不相同的，因此不可移植。</p><h2 id="文本处理"><a href="#文本处理" class="headerlink" title="文本处理"></a>文本处理</h2><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>LEFT() RIGHT()</td><td>左边或者右边的字符</td></tr><tr><td>LOWER() UPPER()</td><td>转换为小写或者大写</td></tr><tr><td>LTRIM() RTIM()</td><td>去除左边或者右边的空格</td></tr><tr><td>LENGTH()</td><td>长度</td></tr><tr><td>SUNDEX()</td><td>转换为语音值</td></tr></tbody></table><p>其中， <strong>SOUNDEX()</strong>  是将一个字符串转换为描述其语音表示的字母数字模式的算法，它是根据发音而不是字母比较。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">SOUNDEX</span>(col1) = <span class="keyword">SOUNDEX</span>(<span class="string">'apple'</span>)</span><br></pre></td></tr></table></figure><h2 id="日期和时间处理"><a href="#日期和时间处理" class="headerlink" title="日期和时间处理"></a>日期和时间处理</h2><ul><li>日期格式：YYYY-MM-DD</li><li>时间格式：HH:MM:SS</li></ul><table><thead><tr><th>函 数</th><th>说 明</th></tr></thead><tbody><tr><td>AddDate()</td><td>增加一个日期（天、周等）</td></tr><tr><td>AddTime()</td><td>增加一个时间（时、分等）</td></tr><tr><td>CurDate()</td><td>返回当前日期</td></tr><tr><td>CurTime()</td><td>返回当前时间</td></tr><tr><td>Date()</td><td>返回日期时间的日期部分</td></tr><tr><td>DateDiff()</td><td>计算两个日期之差</td></tr><tr><td>Date_Add()</td><td>高度灵活的日期运算函数</td></tr><tr><td>Date_Format()</td><td>返回一个格式化的日期或时间串</td></tr><tr><td>Day()</td><td>返回一个日期的天数部分</td></tr><tr><td>DayOfWeek()</td><td>对于一个日期，返回对应的星期几</td></tr><tr><td>Hour()</td><td>返回一个时间的小时部分</td></tr><tr><td>Minute()</td><td>返回一个时间的分钟部分</td></tr><tr><td>Month()</td><td>返回一个日期的月份部分</td></tr><tr><td>Now()</td><td>返回当前日期和时间</td></tr><tr><td>Second()</td><td>返回一个时间的秒部分</td></tr><tr><td>Time()</td><td>返回一个日期时间的时间部分</td></tr><tr><td>Year()</td><td>返回一个日期的年份部分</td></tr></tbody></table><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT NOW();</span><br><span class="line">        -&gt; '2017-06-28 14:01:52'</span><br></pre></td></tr></table></figure><h2 id="数值处理"><a href="#数值处理" class="headerlink" title="数值处理"></a>数值处理</h2><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>SIN()</td><td>正弦</td></tr><tr><td>COS()</td><td>余弦</td></tr><tr><td>TAN()</td><td>正切</td></tr><tr><td>ABS()</td><td>绝对值</td></tr><tr><td>SQRT()</td><td>平方根</td></tr><tr><td>MOD()</td><td>余数</td></tr><tr><td>EXP()</td><td>指数</td></tr><tr><td>PI()</td><td>圆周率</td></tr><tr><td>RAND()</td><td>随机数</td></tr></tbody></table><h2 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h2><table><thead><tr><th>函 数</th><th>说 明</th></tr></thead><tbody><tr><td>AVG()</td><td>返回某列的平均值</td></tr><tr><td>COUNT()</td><td>返回某列的行数</td></tr><tr><td>MAX()</td><td>返回某列的最大值</td></tr><tr><td>MIN()</td><td>返回某列的最小值</td></tr><tr><td>SUM()</td><td>返回某列值之和</td></tr></tbody></table><p>AVG() 会忽略 NULL 行。</p><p>使用 DISTINCT 可以汇总函数值汇总不同的值。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">AVG</span>(<span class="keyword">DISTINCT</span> col1) <span class="keyword">AS</span> avg_col</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br></pre></td></tr></table></figure><h1 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h1><p>分组就是把具有相同的数据值的行放在同一组中。</p><p>可以对同一分组数据使用汇总函数进行处理，例如求分组数据的平均值等。</p><p>指定的分组字段除了能让数组按该字段进行分组，也可以按该字段进行排序，例如按 col 字段排序并分组数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span>, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">col</span>;</span><br></pre></td></tr></table></figure><p>WHERE 过滤行，HAVING 过滤分组。行过滤应当先与分组过滤；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span>, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> &gt; <span class="number">2</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">HAVING</span> <span class="keyword">COUNT</span>(*) &gt;= <span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>GROUP BY 的排序结果为分组字段，而 ORDER BY 也可以以聚集字段来进行排序。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span>, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> <span class="keyword">num</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">num</span>;</span><br></pre></td></tr></table></figure><p>分组规定：</p><ol><li>GROUP BY 子句出现在 WHERE 子句之后，ORDER BY 子句之前；</li><li>除了汇总计算语句的字段外，SELECT 语句中的每一字段都必须在 GROUP BY 子句中给出；</li><li>NULL 的行会单独分为一组；</li><li>大多数 SQL 实现不支持 GROUP BY 列具有可变长度的数据类型。</li></ol><h1 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h1><p>子查询中只能返回一个字段的数据。</p><p>可以将子查询的结果作为 WHRER 语句的过滤条件：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable1</span><br><span class="line"><span class="keyword">WHERE</span> col1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> col2</span><br><span class="line">                 <span class="keyword">FROM</span> mytable2);</span><br></pre></td></tr></table></figure><p>下面的语句可以检索出客户的订单数量，子查询语句会对第一个查询检索出的每个客户执行一次：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_name, (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*)</span><br><span class="line">                   <span class="keyword">FROM</span> Orders</span><br><span class="line">                   <span class="keyword">WHERE</span> Orders.cust_id = Customers.cust_id)</span><br><span class="line">                   <span class="keyword">AS</span> orders_num</span><br><span class="line"><span class="keyword">FROM</span> Customers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> cust_name;</span><br></pre></td></tr></table></figure><h1 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h1><p>连接用于连接多个表，使用 JOIN 关键字，并且条件语句使用 ON 而不是 Where。</p><p>连接可以替换子查询，并且比子查询的效率一般会更快。</p><p>可以用 AS 给列名、计算字段和表名取别名，给表名取别名是为了简化 SQL 语句以及连接相同表。</p><h2 id="内连接"><a href="#内连接" class="headerlink" title="内连接"></a>内连接</h2><p>内连接又称等值连接，使用 INNER JOIN 关键字。</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a, b, c</span><br><span class="line"><span class="keyword">from</span> A <span class="keyword">inner</span> <span class="keyword">join</span> B</span><br><span class="line"><span class="keyword">on</span> A.<span class="keyword">key</span> = B.<span class="keyword">key</span></span><br></pre></td></tr></table></figure><p>可以不明确使用 INNER JOIN，而使用普通查询并在 WHERE 中将两个表中要连接的列用等值方法连接起来。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select <span class="selector-tag">a</span>, <span class="selector-tag">b</span>, c</span><br><span class="line">from A, B</span><br><span class="line">where A<span class="selector-class">.key</span> = B.key</span><br></pre></td></tr></table></figure><p>在没有条件语句的情况下返回笛卡尔积。</p><h2 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h2><p>自连接可以看成内连接的一种，只是连接的表是自身而已。</p><p>一张员工表，包含员工姓名和员工所属部门，要找出与 Jim 处在同一部门的所有员工姓名。</p><p><strong>子查询版本</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span> employee</span><br><span class="line"><span class="keyword">where</span> department = (</span><br><span class="line">      <span class="keyword">select</span> department</span><br><span class="line">      <span class="keyword">from</span> employee</span><br><span class="line">      <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">"Jim"</span>);</span><br></pre></td></tr></table></figure><p><strong>自连接版本</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span> employee <span class="keyword">as</span> e1, employee <span class="keyword">as</span> e2</span><br><span class="line"><span class="keyword">where</span> e1.department = e2.department</span><br><span class="line">      <span class="keyword">and</span> e1.name = <span class="string">"Jim"</span>;</span><br></pre></td></tr></table></figure><p>连接一般比子查询的效率高。</p><h2 id="自然连接"><a href="#自然连接" class="headerlink" title="自然连接"></a>自然连接</h2><p>自然连接是把同名列通过等值测试连接起来的，同名列可以有多个。</p><p>内连接和自然连接的区别：内连接提供连接的列，而自然连接自动连接所有同名列。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> employee <span class="keyword">natural</span> <span class="keyword">join</span> department;</span><br></pre></td></tr></table></figure><h2 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h2><p>外连接保留了没有关联的那些行。分为左外连接，右外连接以及全外连接，左外连接就是保留左表没有关联的行。</p><p>检索所有顾客的订单信息，包括还没有订单信息的顾客。</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Customers.cust_id, Orders.order_num</span><br><span class="line">   <span class="keyword">from</span> Customers <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> Orders</span><br><span class="line">   <span class="keyword">on</span> Customers.cust_id = Orders.curt_id;</span><br></pre></td></tr></table></figure><p>如果需要统计顾客的订单数，使用聚集函数。</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Customers.cust_id,</span><br><span class="line">       <span class="built_in">COUNT</span>(Orders.order_num) <span class="keyword">as</span> num_ord</span><br><span class="line"><span class="keyword">from</span> Customers <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> Orders</span><br><span class="line"><span class="keyword">on</span> Customers.cust_id = Orders.curt_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> Customers.cust_id;</span><br></pre></td></tr></table></figure><h1 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h1><p>使用  <strong>UNION</strong>  来组合两个查询，如果第一个查询返回 M 行，第二个查询返回 N 行，那么组合查询的结果为 M+N 行。</p><p>每个查询必须包含相同的列、表达式或者聚集函数。</p><p>默认会去除相同行，如果需要保留相同行，使用 UNION ALL。</p><p>只能包含一个 ORDER BY 子句，并且必须位于语句的最后。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">col</span> =<span class="number">2</span>;</span><br></pre></td></tr></table></figure><h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><p>视图是虚拟的表，本身不包含数据，也就不能对其进行索引操作。对视图的操作和对普通表的操作一样。</p><p>视图具有如下好处：</p><ol><li>简化复杂的 SQL 操作，比如复杂的联结；</li><li>只使用实际表的一部分数据；</li><li>通过只给用户访问视图的权限，保证数据的安全性；</li><li>更改数据格式和表示。</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> myview <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Concat</span>(col1, col2) <span class="keyword">AS</span> concat_col, col3*col4 <span class="keyword">AS</span> count_col</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col5 = val;</span><br></pre></td></tr></table></figure><h1 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h1><p>存储过程可以看成是对一系列 SQL 操作的批处理；</p><p><strong>使用存储过程的好处</strong> </p><ol><li>代码封装，保证了一定的安全性；</li><li>代码复用；</li><li>由于是预先编译，因此具有很高的性能。</li></ol><p><strong>创建存储过程</strong> </p><p>命令行中创建存储过程需要自定义分隔符，因为命令行是以 ; 为结束符，而存储过程中也包含了分号，因此会错误把这部分分号当成是结束符，造成语法错误。</p><p>包含 in、out 和 inout 三种参数。</p><p>给变量赋值都需要用 select into 语句。</p><p>每次只能给一个变量赋值，不支持集合的操作。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">delimiter //</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> myprocedure( <span class="keyword">out</span> ret <span class="built_in">int</span> )</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">declare</span> y <span class="built_in">int</span>;</span><br><span class="line">        <span class="keyword">select</span> <span class="keyword">sum</span>(col1)</span><br><span class="line">        <span class="keyword">from</span> mytable</span><br><span class="line">        <span class="keyword">into</span> y;</span><br><span class="line">        <span class="keyword">select</span> y*y <span class="keyword">into</span> ret;</span><br><span class="line">    <span class="keyword">end</span> //</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> myprocedure(@ret);</span><br><span class="line"><span class="keyword">select</span> @ret;</span><br></pre></td></tr></table></figure><h1 id="游标"><a href="#游标" class="headerlink" title="游标"></a>游标</h1><p>在存储过程中使用游标可以对一个结果集进行移动遍历。</p><p>游标主要用于交互式应用，其中用户需要对数据集中的任意行进行浏览和修改。</p><p><strong>使用游标的四个步骤：</strong> </p><ol><li>声明游标，这个过程没有实际检索出数据；</li><li>打开游标；</li><li>取出数据；</li><li>关闭游标；</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">delimiter //</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> myprocedure(<span class="keyword">out</span> ret <span class="built_in">int</span>)</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">declare</span> done <span class="built_in">boolean</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">declare</span> mycursor <span class="keyword">cursor</span> <span class="keyword">for</span></span><br><span class="line">        <span class="keyword">select</span> col1 <span class="keyword">from</span> mytable;</span><br><span class="line">        # 定义了一个continue handler，当 sqlstate '02000' 这个条件出现时，会执行 set done = 1</span><br><span class="line">        <span class="keyword">declare</span> continue <span class="keyword">handler</span> <span class="keyword">for</span> <span class="keyword">sqlstate</span> <span class="string">'02000'</span> <span class="keyword">set</span> done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        open mycursor;</span><br><span class="line"></span><br><span class="line">        repeat</span><br><span class="line">            fetch mycursor into ret;</span><br><span class="line">            <span class="keyword">select</span> ret;</span><br><span class="line">        until done <span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line"></span><br><span class="line">        close mycursor;</span><br><span class="line">    <span class="keyword">end</span> //</span><br><span class="line"> delimiter ;</span><br></pre></td></tr></table></figure><h1 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h1><p>触发器会在某个表执行以下语句时而自动执行：DELETE、INSERT、UPDATE</p><p>触发器必须指定在语句执行之前还是之后自动执行，之前执行使用 BEFORE 关键字，之后执行使用 AFTER 关键字。BEFORE 用于数据验证和净化。</p><p>INSERT 触发器包含一个名为 NEW 的虚拟表。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> mytrigger <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> mytable</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">SELECT</span> NEW.col;</span><br></pre></td></tr></table></figure><p>DELETE 触发器包含一个名为 OLD 的虚拟表，并且是只读的。</p><p>UPDATE 触发器包含一个名为 NEW 和一个名为 OLD 的虚拟表，其中 NEW 是可以被修改地，而 OLD 是只读的。</p><p>可以使用触发器来进行审计跟踪，把修改记录到另外一张表中。</p><p>MySQL 不允许在触发器中使用 CALL 语句 ，也就是不能调用存储过程。</p><h1 id="事务处理"><a href="#事务处理" class="headerlink" title="事务处理"></a>事务处理</h1><p><strong>基本术语</strong> </p><ol><li>事务（transaction）指一组 SQL 语句；</li><li>回退（rollback）指撤销指定 SQL 语句的过程；</li><li>提交（commit）指将未存储的 SQL 语句结果写入数据库表；</li><li>保留点（savepoint）指事务处理中设置的临时占位符（placeholder），你可以对它发布回退（与回退整个事务处理不同）。</li></ol><p>不能回退 SELECT 语句，回退 SELECT 语句也没意义；也不能回退 CRETE 和 DROP 语句。</p><p>MySQL 的事务提交默认是隐式提交，也就是每执行一条语句就把这条语句当成一个事务然后进行提交。当出现 START TRANSACTION 语句时，会关闭隐式提交；当 COMMIT 或 ROLLBACK 语句执行后，事务会自动关闭，重新恢复隐式提交。</p><p>通过设置 autocommit 为 0 可以取消自动提交，直到 autocommit 被设置为 1 才会提交；autocommit 标记是针对每个连接而不是针对服务器的。</p><p>如果没有设置保留点，ROLLBACK 会回退到 START TRANSACTION 语句处；如果设置了保留点，并且在 ROLLBACK 中指定该保留点，则会回退到该保留点。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line">// ...</span><br><span class="line"><span class="keyword">SAVEPOINT</span> delete1</span><br><span class="line">// ...</span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> delete1</span><br><span class="line">// ...</span><br><span class="line"><span class="keyword">COMMIT</span></span><br></pre></td></tr></table></figure><h1 id="字符集"><a href="#字符集" class="headerlink" title="字符集"></a>字符集</h1><p><strong>基本术语</strong> </p><ol><li>字符集为字母和符号的集合；</li><li>编码为某个字符集成员的内部表示；</li><li>校对字符指定如何比较，主要用于排序和分组。</li></ol><p>除了给表指定字符集和校对外，也可以给列指定：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line">(<span class="keyword">col</span> <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> latin <span class="keyword">COLLATE</span> latin1_general_ci )</span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> hebrew <span class="keyword">COLLATE</span> hebrew_general_ci;</span><br></pre></td></tr></table></figure><p>可以在排序、分组时指定校对：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">col</span> <span class="keyword">COLLATE</span> latin1_general_ci;</span><br></pre></td></tr></table></figure><h1 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h1><p>MySQL 的账户信息保存在 mysql 这个数据库中。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> mysql;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span> <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><p><strong>创建账户</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> myuser <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'mypassword'</span>;</span><br></pre></td></tr></table></figure><p>新创建的账户没有任何权限。</p><p><strong>修改账户名</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RENAME</span> myuser <span class="keyword">TO</span> newuser;</span><br></pre></td></tr></table></figure><p><strong>删除账户</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> myuser;</span><br></pre></td></tr></table></figure><p><strong>查看权限</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GRANTS</span> <span class="keyword">FOR</span> myuser;</span><br></pre></td></tr></table></figure><p><strong>授予权限</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span> <span class="keyword">ON</span> mydatabase.* <span class="keyword">TO</span> myuser;</span><br></pre></td></tr></table></figure><p><br><div align="center"> <img src="../pics/c73aa08e-a987-43c9-92be-adea4a884c25.png"> </div><br></p><p>账户用 username@host 的形式定义，username@% 使用的是默认主机名。</p><p><strong>删除权限</strong> </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span> <span class="keyword">ON</span> mydatabase.* <span class="keyword">FROM</span> myuser;</span><br></pre></td></tr></table></figure><p>GRANT 和 REVOKE 可在几个层次上控制访问权限：</p><ul><li>整个服务器，使用 GRANT ALL 和 REVOKE ALL；</li><li>整个数据库，使用 ON database.*；</li><li>特定的表，使用 ON database.table；</li><li>特定的列；</li><li>特定的存储过程。</li></ul><p><strong>更改密码</strong> </p><p>必须使用 Password() 函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> PASSWROD <span class="keyword">FOR</span> myuser = <span class="keyword">Password</span>(<span class="string">'newpassword'</span>);</span><br></pre></td></tr></table></figure><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#基础&quot;&gt;基础&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#创建表&quot;&gt;创建表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#插入&quot;&gt;插入&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#更新&quot;&gt;更新&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#删除&quot;&gt;删除&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#修改表&quot;&gt;修改表&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#查询&quot;&gt;查询&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#排序&quot;&gt;排序&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#过滤&quot;&gt;过滤&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#通配符&quot;&gt;通配符&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#计算字段&quot;&gt;计算字段&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#函数&quot;&gt;函数&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#文本处理&quot;&gt;文本处理&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#日期和时间处理&quot;&gt;日期和时间处理&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#数值处理&quot;&gt;数值处理&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#汇总&quot;&gt;汇总&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分组&quot;&gt;分组&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#子查询&quot;&gt;子查询&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#连接&quot;&gt;连接&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#内连接&quot;&gt;内连接&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#自连接&quot;&gt;自连接&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#自然连接&quot;&gt;自然连接&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#外连接&quot;&gt;外连接&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#组合查询&quot;&gt;组合查询&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#视图&quot;&gt;视图&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#存储过程&quot;&gt;存储过程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#游标&quot;&gt;游标&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#触发器&quot;&gt;触发器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#事务处理&quot;&gt;事务处理&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#字符集&quot;&gt;字符集&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#权限管理&quot;&gt;权限管理&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;基础&quot;&gt;&lt;a href=&quot;#基础&quot; class=&quot;headerlink&quot; title=&quot;基础&quot;&gt;&lt;/a&gt;基础&lt;/h1&gt;&lt;p&gt;模式定义了数据如何存储、存储什么样的数据以及数据如何分解等信息，数据库和表都有模式。&lt;/p&gt;
&lt;p&gt;主键的值不允许修改，也不允许复用（不能使用已经删除的主键值赋给新数据行的主键）。&lt;/p&gt;
&lt;p&gt;SQL（Structured Query Language)，标准 SQL 由 ANSI 标准委员会管理，从而称为 ANSI SQL。各个 DBMS 都有自己的实现，如 PL/SQL、Transact-SQL 等。&lt;/p&gt;
&lt;p&gt;SQL 语句不区分大小写，但是数据库表名、列名和值是否区分依赖于具体的 DBMS 以及配置。&lt;/p&gt;
&lt;p&gt;SQL 支持以下三种注释：&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>代码可读性</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E4%BB%A3%E7%A0%81%E5%8F%AF%E8%AF%BB%E6%80%A7.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/代码可读性.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:34:20.434Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#可读性的重要性">可读性的重要性</a></li><li><a href="#用名字表达代码含义">用名字表达代码含义</a></li><li><a href="#名字不能带来歧义">名字不能带来歧义</a></li><li><a href="#良好的代码风格">良好的代码风格</a></li><li><a href="#编写注释">编写注释</a></li><li><a href="#如何编写注释">如何编写注释</a></li><li><a href="#提高控制流的可读性">提高控制流的可读性</a></li><li><a href="#拆分长表达式">拆分长表达式</a></li><li><a href="#变量与可读性">变量与可读性</a></li><li><a href="#抽取函数">抽取函数</a></li><li><a href="#一次只做一件事">一次只做一件事</a></li><li><a href="#用自然语言表述代码">用自然语言表述代码</a></li><li><a href="#减少代码量">减少代码量</a><!-- GFM-TOC --></li></ul><h1 id="可读性的重要性"><a href="#可读性的重要性" class="headerlink" title="可读性的重要性"></a>可读性的重要性</h1><p>编程有很大一部分时间是在阅读代码，不仅要阅读自己的代码，而且要阅读别人的代码。因此，可读性良好的代码能够大大提高编程效率。</p><p>可读性良好的代码往往会让代码架构更好，因为程序员更愿意去修改这部分代码，而且也更容易修改。</p><p>只有在核心领域为了效率才可以放弃可读性，否则可读性是第一位。</p><a id="more"></a><h1 id="用名字表达代码含义"><a href="#用名字表达代码含义" class="headerlink" title="用名字表达代码含义"></a>用名字表达代码含义</h1><p>一些比较有表达力的单词：</p><table><thead><tr><th>单词</th><th>可替代单词</th></tr></thead><tbody><tr><td>send</td><td>deliver、dispatch、announce、distribute、route</td></tr><tr><td>find</td><td>search、extract、locate、recover</td></tr><tr><td>start</td><td>launch、create、begin、open</td></tr><tr><td>make</td><td>create、set up、build、generate、compose、add、new</td></tr></tbody></table><p>使用 i、j、k 作为循环迭代器的名字过于简单，user_i、member_i 这种名字会更有表达力。因为循环层次越多，代码越难理解，有表达力的迭代器名字可读性会更高</p><p>为名字添加形容词等信息能让名字更具有表达力，但是名字也会变长。名字长短的准则是：作用域越大，名字越长。因此只有在短作用域才能使用一些简单名字。</p><h1 id="名字不能带来歧义"><a href="#名字不能带来歧义" class="headerlink" title="名字不能带来歧义"></a>名字不能带来歧义</h1><p>起完名字要思考一下别人会对这个名字有何解读，会不会误解了原本想表达的含义。</p><p>用 min、max 表示数量范围；用 first、last 表示访问空间的包含范围，begin、end 表示访问空间的排除范围，即 end 不包含尾部。</p><p><br><div align="center"> <img src="../pics/05907ab4-42c5-4b5e-9388-6617f6c97bea.jpg"> </div><br></p><p>布尔相关的命名加上 is、can、should、has 等前缀。</p><h1 id="良好的代码风格"><a href="#良好的代码风格" class="headerlink" title="良好的代码风格"></a>良好的代码风格</h1><p>适当的空行和缩进。</p><p>排列整齐的注释：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;   <span class="comment">// 注释</span></span><br><span class="line"><span class="keyword">int</span> b = <span class="number">11</span>;  <span class="comment">// 注释</span></span><br><span class="line"><span class="keyword">int</span> c = <span class="number">111</span>; <span class="comment">// 注释</span></span><br></pre></td></tr></table></figure><p>语句顺序不能随意，比如与 html 表单相关联的变量的赋值应该和表单在 html 中的顺序一致；</p><p>把相关的代码按块组织起来放在一起。</p><h1 id="编写注释"><a href="#编写注释" class="headerlink" title="编写注释"></a>编写注释</h1><p>阅读代码首先会注意到注释，如果注释没太大作用，那么就会浪费代码阅读的时间。那些能直接看出含义的代码不需要写注释，特别是并不需要为每个方法都加上注释，比如那些简单的 getter 和 setter 方法，为这些方法写注释反而让代码可读性更差。</p><p>不能因为有注释就随便起个名字，而是争取起个好名字而不写注释。</p><p>可以用注释来记录采用当前解决办法的思考过程，从而让读者更容易理解代码。</p><p>注释用来提醒一些特殊情况。</p><p>用 TODO 等做标记：</p><table><thead><tr><th>标记</th><th>用法</th></tr></thead><tbody><tr><td>TODO</td><td>待做</td></tr><tr><td>FIXME</td><td>待修复</td></tr><tr><td>HACH</td><td>粗糙的解决方案</td></tr><tr><td>XXX</td><td>危险！这里有重要的问题</td></tr></tbody></table><h1 id="如何编写注释"><a href="#如何编写注释" class="headerlink" title="如何编写注释"></a>如何编写注释</h1><p>尽量简洁明了：</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// The first <span class="built_in">String</span> <span class="keyword">is</span> student<span class="symbol">'s</span> name</span><br><span class="line">// The Second <span class="built_in">Integer</span> <span class="keyword">is</span> student<span class="symbol">'s</span> score</span><br><span class="line"><span class="keyword">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; scoreMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Student' name -&gt; Student's score</span></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; scoreMap = <span class="literal">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure><p>添加测试用例来说明：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">// Example: add(1, 2), return 3</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在很复杂的函数调用中对每个参数标上名字：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">int a</span> = 1;</span><br><span class="line"><span class="attribute">int b</span> = 2;</span><br><span class="line"><span class="attribute">int num</span> = add(\* x = *\ a, \* y = *\ b);</span><br></pre></td></tr></table></figure><p>使用专业名词来缩短概念上的解释，比如用设计模式名来说明代码。</p><h1 id="提高控制流的可读性"><a href="#提高控制流的可读性" class="headerlink" title="提高控制流的可读性"></a>提高控制流的可读性</h1><p>条件表达式中，左侧是变量，右侧是常数。比如下面第一个语句正确：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span><span class="params">(len &lt; <span class="number">10</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(<span class="number">10</span> &gt; len)</span></span></span><br></pre></td></tr></table></figure><p>if / else 条件语句，逻辑的处理顺序为：① 正逻辑；② 关键逻辑；③ 简单逻辑。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span><span class="params">(a == b)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 正逻辑</span></span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 反逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>只有在逻辑简单的情况下使用 ? : 三目运算符来使代码更紧凑，否则应该拆分成 if / else；</p><p>do / while 的条件放在后面，不够简单明了，并且会有一些迷惑的地方，最好使用 while 来代替。</p><p>如果只有一个 goto 目标，那么 goto 尚且还能接受，但是过于复杂的 goto 会让代码可读性特别差，应该避免使用 goto。</p><p>在嵌套的循环中，用一些 return 语句往往能减少嵌套的层数。</p><h1 id="拆分长表达式"><a href="#拆分长表达式" class="headerlink" title="拆分长表达式"></a>拆分长表达式</h1><p>长表达式的可读性很差，可以引入一些解释变量从而拆分表达式：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">line</span>.<span class="built_in">split</span>(<span class="string">':'</span>)[<span class="number">0</span>].strip() == <span class="string">"root"</span>:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username = <span class="built_in">line</span>.<span class="built_in">split</span>(<span class="string">':'</span>)[<span class="number">0</span>].strip()</span><br><span class="line"><span class="keyword">if</span> username == <span class="string">"root"</span>:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>使用摩根定理简化一些逻辑表达式：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span><span class="comment">(!a &amp;&amp; !b)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span><span class="comment">(a || b)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="变量与可读性"><a href="#变量与可读性" class="headerlink" title="变量与可读性"></a>变量与可读性</h1><p><strong>去除控制流变量</strong> 。在循环中通过使用 break 或者 return 可以减少控制流变量的使用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">boolean <span class="keyword">done</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">while</span>(/* condition */ &amp;&amp; !<span class="keyword">done</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(...) &#123;</span><br><span class="line">        <span class="keyword">done</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="comment">/* condition */</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(...) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>减小变量作用域</strong> 。作用域越小，越容易定位到变量所有使用的地方。</p><p>JavaScript 可以用闭包减小作用域。以下代码中 submit_form 是函数变量，submitted 变量控制函数不会被提交两次。第一个实现中 submitted 是全局变量，第二个实现把 submitted 放到匿名函数中，从而限制了起作用域范围。</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">submitted = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> submit_form = <span class="function"><span class="keyword">function</span><span class="params">(form_name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(submitted) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    submitted = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> submit_form = (<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> submitted = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(form_name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(submitted) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        submitted = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;());  <span class="comment">// () 使得外层匿名函数立即执行</span></span><br></pre></td></tr></table></figure><p>JavaScript 中没有用 var 声明的变量都是全局变量，而全局变量很容易造成迷惑，因此应当总是用 var 来声明变量。</p><p>变量定义的位置应当离它使用的位置最近。</p><p><strong>实例解析</strong> </p><p>在一个网页中有以下文本输入字段：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;input<span class="built_in"> type </span>= <span class="string">"text"</span> id = <span class="string">"input1"</span> value = <span class="string">"a"</span>&gt;</span><br><span class="line">&lt;input<span class="built_in"> type </span>= <span class="string">"text"</span> id = <span class="string">"input2"</span> value = <span class="string">"b"</span>&gt;</span><br><span class="line">&lt;input<span class="built_in"> type </span>= <span class="string">"text"</span> id = <span class="string">"input3"</span> value = <span class="string">""</span>&gt;</span><br><span class="line">&lt;input<span class="built_in"> type </span>= <span class="string">"text"</span> id = <span class="string">"input4"</span> value = <span class="string">"d"</span>&gt;</span><br></pre></td></tr></table></figure><p>现在要接受一个字符串并把它放到第一个空的 input 字段中，初始实现如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> setFirstEmptyInput = <span class="function"><span class="keyword">function</span></span>(<span class="keyword">new</span><span class="type">_alue</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> found = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> elem = document.getElementById(<span class="string">'input'</span> + i);</span><br><span class="line">    <span class="keyword">while</span>(elem != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(elem.value === <span class="string">''</span>) &#123;</span><br><span class="line">            found = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">        elem = document.getElementById(<span class="string">'input'</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(found) elem.value = <span class="keyword">new</span><span class="type">_value</span>;</span><br><span class="line">    <span class="keyword">return</span> elem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上实现有以下问题：</p><ul><li>found 可以去除；</li><li>elem 作用域过大；</li><li>可以用 for 循环代替 while 循环；</li></ul><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> setFirstEmptyInput = <span class="function"><span class="keyword">function</span></span>(<span class="keyword">new</span><span class="type">_value</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>; <span class="literal">true</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> elem = document.getElementById(<span class="string">'input'</span> + i);</span><br><span class="line">        <span class="keyword">if</span>(elem === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(elem.value === <span class="string">''</span>) &#123;</span><br><span class="line">            elem.value = <span class="keyword">new</span><span class="type">_value</span>;</span><br><span class="line">            <span class="keyword">return</span> elem;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="抽取函数"><a href="#抽取函数" class="headerlink" title="抽取函数"></a>抽取函数</h1><p>工程学就是把大问题拆分成小问题再把这些问题的解决方案放回一起。</p><p>首先应该明确一个函数的高层次目标，然后对于不是直接为了这个目标工作的代码，抽取出来放到独立的函数中。</p><p>介绍性的代码：</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> findClostElement(<span class="built_in">int</span>[] arr) &#123;</span><br><span class="line">    <span class="built_in">int</span> clostIdx;</span><br><span class="line">    <span class="built_in">int</span> clostDist = Interger.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">        <span class="built_in">int</span> x = ...;</span><br><span class="line">        <span class="built_in">int</span> y = ...;</span><br><span class="line">        <span class="built_in">int</span> z = ...;</span><br><span class="line">        <span class="built_in">int</span> value = x * y * z;</span><br><span class="line">        <span class="built_in">int</span> <span class="built_in">dist</span> = Math.<span class="built_in">sqrt</span>(Math.<span class="built_in">pow</span>(value, <span class="number">2</span>), Math.<span class="built_in">pow</span>(arr[i], <span class="number">2</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">dist</span> &lt; clostDist) &#123;</span><br><span class="line">            clostIdx = i;</span><br><span class="line">            clostDist = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clostIdx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上代码中循环部分主要计算距离，这部分不属于代码高层次目标，高层次目标是寻找最小距离的值，因此可以把这部分代替提取到独立的函数中。这样做也带来一个额外的好处有：可以单独进行测试、可以快速找到程序错误并修改。</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public int findClostElement(int[] arr) &#123;</span><br><span class="line">    int <span class="keyword">clostIdx;</span></span><br><span class="line"><span class="keyword"> </span>   int <span class="keyword">clostDist </span>= Interger.MAX_VALUE<span class="comment">;</span></span><br><span class="line">    for(int i = <span class="number">0</span><span class="comment">; i &lt; arr.length; i++) &#123;</span></span><br><span class="line">        int <span class="keyword">dist </span>= computDist(arr, i)<span class="comment">;</span></span><br><span class="line">        if(<span class="keyword">dist </span>&lt; <span class="keyword">clostDist) </span>&#123;</span><br><span class="line">            <span class="keyword">clostIdx </span>= i<span class="comment">;</span></span><br><span class="line">            <span class="keyword">clostDist </span>= value<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="keyword">clostIdx;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure><p>并不是函数抽取的越多越好，如果抽取过多，在阅读代码的时候可能需要不断跳来跳去。只有在当前函数不需要去了解某一块代码细节而能够表达其内容时，把这块代码抽取成子函数才是好的。</p><p>函数抽取也用于减小代码的冗余。</p><h1 id="一次只做一件事"><a href="#一次只做一件事" class="headerlink" title="一次只做一件事"></a>一次只做一件事</h1><p>只做一件事的代码很容易让人知道其要做的事；</p><p>基本流程：列出代码所做的所有任务；把每个任务拆分到不同的函数，或者不同的段落。</p><h1 id="用自然语言表述代码"><a href="#用自然语言表述代码" class="headerlink" title="用自然语言表述代码"></a>用自然语言表述代码</h1><p>先用自然语言书写代码逻辑，也就是伪代码，然后再写代码，这样代码逻辑会更清晰。</p><h1 id="减少代码量"><a href="#减少代码量" class="headerlink" title="减少代码量"></a>减少代码量</h1><p>不要过度设计，编码过程会有很多变化，过度设计的内容到最后往往是无用的。</p><p>多用标准库实现。</p><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#可读性的重要性&quot;&gt;可读性的重要性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#用名字表达代码含义&quot;&gt;用名字表达代码含义&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#名字不能带来歧义&quot;&gt;名字不能带来歧义&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#良好的代码风格&quot;&gt;良好的代码风格&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#编写注释&quot;&gt;编写注释&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#如何编写注释&quot;&gt;如何编写注释&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#提高控制流的可读性&quot;&gt;提高控制流的可读性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#拆分长表达式&quot;&gt;拆分长表达式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#变量与可读性&quot;&gt;变量与可读性&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#抽取函数&quot;&gt;抽取函数&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#一次只做一件事&quot;&gt;一次只做一件事&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#用自然语言表述代码&quot;&gt;用自然语言表述代码&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#减少代码量&quot;&gt;减少代码量&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;可读性的重要性&quot;&gt;&lt;a href=&quot;#可读性的重要性&quot; class=&quot;headerlink&quot; title=&quot;可读性的重要性&quot;&gt;&lt;/a&gt;可读性的重要性&lt;/h1&gt;&lt;p&gt;编程有很大一部分时间是在阅读代码，不仅要阅读自己的代码，而且要阅读别人的代码。因此，可读性良好的代码能够大大提高编程效率。&lt;/p&gt;
&lt;p&gt;可读性良好的代码往往会让代码架构更好，因为程序员更愿意去修改这部分代码，而且也更容易修改。&lt;/p&gt;
&lt;p&gt;只有在核心领域为了效率才可以放弃可读性，否则可读性是第一位。&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>计算机网络</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/计算机网络.html</id>
    <published>2018-03-11T03:58:00.000Z</published>
    <updated>2018-03-11T04:35:00.599Z</updated>
    
    <content type="html"><![CDATA[<!-- GFM-TOC --><ul><li><a href="#第一章-概述">第一章 概述</a><ul><li><a href="#网络的网络">网络的网络</a></li><li><a href="#isp">ISP</a></li><li><a href="#互联网的组成">互联网的组成</a></li><li><a href="#主机之间的通信方式">主机之间的通信方式</a></li><li><a href="#电路交换与分组交换">电路交换与分组交换</a><ul><li><a href="#1-电路交换">1. 电路交换</a></li><li><a href="#2-报文交换">2. 报文交换</a></li><li><a href="#3-分组交换">3. 分组交换</a></li></ul></li><li><a href="#时延">时延</a><ul><li><a href="#1-发送时延">1. 发送时延</a></li><li><a href="#2-传播时延">2. 传播时延</a></li><li><a href="#3-处理时延">3. 处理时延</a></li><li><a href="#4-排队时延">4. 排队时延</a></li></ul></li><li><a href="#计算机网络体系结构">计算机网络体系结构*</a><ul><li><a href="#1-七层协议">1. 七层协议</a></li><li><a href="#2-五层协议">2. 五层协议</a></li><li><a href="#3-数据在各层之间的传递过程">3. 数据在各层之间的传递过程</a></li><li><a href="#4-tcpip-体系结构">4. TCP/IP 体系结构</a></li></ul></li></ul></li><li><a href="#第二章-物理层">第二章 物理层</a><ul><li><a href="#通信方式">通信方式</a></li><li><a href="#带通调制">带通调制</a></li><li><a href="#信道复用技术">信道复用技术</a><ul><li><a href="#1-频分复用时分复用">1. 频分复用、时分复用</a></li><li><a href="#2-统计时分复用">2. 统计时分复用</a></li><li><a href="#3-波分复用">3. 波分复用</a></li><li><a href="#4-码分复用">4. 码分复用</a></li></ul></li></ul></li><li><a href="#第三章-数据链路层">第三章 数据链路层</a><ul><li><a href="#三个基本问题">三个基本问题</a><ul><li><a href="#1-封装成帧">1. 封装成帧</a></li><li><a href="#2-透明传输">2. 透明传输</a></li><li><a href="#3-差错检测">3. 差错检测</a></li></ul></li><li><a href="#点对点信道---ppp-协议">点对点信道 - PPP 协议</a></li><li><a href="#局域网的拓扑">局域网的拓扑</a></li><li><a href="#广播信道---csmacd-协议">广播信道 - CSMA/CD 协议*</a></li><li><a href="#集线器">集线器</a></li><li><a href="#mac-层">MAC 层*</a></li><li><a href="#虚拟局域网">虚拟局域网</a></li></ul></li><li><a href="#第四章-网络层">第四章 网络层*</a><ul><li><a href="#网际协议-ip-概述">网际协议 IP 概述</a></li><li><a href="#ip-数据报格式">IP 数据报格式</a></li><li><a href="#ip-地址编址">IP 地址编址</a><ul><li><a href="#1-分类">1. 分类</a></li><li><a href="#2-子网划分">2. 子网划分</a></li><li><a href="#3-无分类">3. 无分类</a></li></ul></li><li><a href="#ip-地址和-mac-地址">IP 地址和 MAC 地址</a></li><li><a href="#地址解析协议-arp">地址解析协议 ARP</a></li><li><a href="#路由器的结构">路由器的结构</a></li><li><a href="#交换机与路由器的区别">交换机与路由器的区别</a></li><li><a href="#路由器分组转发流程">路由器分组转发流程</a></li><li><a href="#路由选择协议">路由选择协议</a><ul><li><a href="#1-内部网关协议-rip">1. 内部网关协议 RIP</a></li><li><a href="#2-内部网关协议-ospf">2. 内部网关协议 OSPF</a></li><li><a href="#3-外部网关协议-bgp">3. 外部网关协议 BGP</a></li></ul></li><li><a href="#网际控制报文协议-icmp">网际控制报文协议 ICMP</a></li><li><a href="#分组网间探测-ping">分组网间探测 PING</a></li><li><a href="#ip-多播">IP 多播</a></li><li><a href="#虚拟专用网-vpn">虚拟专用网 VPN</a></li><li><a href="#网络地址转换-nat">网络地址转换 NAT</a></li></ul></li><li><a href="#第五章-运输层">第五章 运输层*</a><ul><li><a href="#udp-和-tcp-的特点">UDP 和 TCP 的特点</a></li><li><a href="#udp-首部格式">UDP 首部格式</a></li><li><a href="#tcp-首部格式">TCP 首部格式</a></li><li><a href="#tcp-的三次握手">TCP 的三次握手</a></li><li><a href="#tcp-的四次挥手">TCP 的四次挥手</a></li><li><a href="#tcp-滑动窗口">TCP 滑动窗口</a></li><li><a href="#tcp-可靠传输">TCP 可靠传输</a></li><li><a href="#tcp-流量控制">TCP 流量控制</a></li><li><a href="#tcp-拥塞控制">TCP 拥塞控制</a><ul><li><a href="#慢开始与拥塞避免">慢开始与拥塞避免</a></li><li><a href="#快重传与快恢复">快重传与快恢复</a></li></ul></li></ul></li><li><a href="#第六章-应用层">第六章 应用层*</a><ul><li><a href="#域名系统-dns">域名系统 DNS</a><ul><li><a href="#1-层次结构">1. 层次结构</a></li><li><a href="#2-解析过程">2. 解析过程</a></li></ul></li><li><a href="#文件传输协议-ftp">文件传输协议 FTP</a></li><li><a href="#远程终端协议-telnet">远程终端协议 TELNET</a></li><li><a href="#万维网-www">万维网 WWW</a></li><li><a href="#电子邮件协议">电子邮件协议</a><ul><li><a href="#pop3">POP3</a></li><li><a href="#imap">IMAP</a></li><li><a href="#smtp">SMTP</a></li></ul></li><li><a href="#动态主机配置协议-dhcp">动态主机配置协议 DHCP</a></li><li><a href="#点对点传输-p2p">点对点传输 P2P</a></li><li><a href="#web-页面请求过程">Web 页面请求过程</a></li><li><a href="#常用端口">常用端口</a></li></ul></li><li><a href="#参考资料">参考资料</a><!-- GFM-TOC --></li></ul><h1 id="第一章-概述"><a href="#第一章-概述" class="headerlink" title="第一章 概述"></a>第一章 概述</h1><h2 id="网络的网络"><a href="#网络的网络" class="headerlink" title="网络的网络"></a>网络的网络</h2><p>网络把主机连接起来，而互联网是把多种不同的网络连接起来，因此互联网是网络的网络。</p><p><br><div align="center"> <img src="../pics/f1fb826b-ecf4-4ddb-91f0-2bafecf08869.jpg"> </div><br></p><h2 id="ISP"><a href="#ISP" class="headerlink" title="ISP"></a>ISP</h2><p>互联网服务提供商 ISP 可以从互联网管理机构获得许多 IP 地址，同时拥有通信线路以及路由器等联网设备，个人或机构向 ISP 缴纳一定的费用就可以接入互联网。</p><p>目前的互联网是一种多层次 ISP 结构，ISP 根据覆盖面积的大小分为主干 ISP、地区 ISP 和本地 ISP。</p><p>互联网交换点 IXP 允许两个 ISP 直接相连而不用经过第三个 ISP。</p><a id="more"></a><p><br><div align="center"> <img src="../pics/0f8c0a60-d4c6-47f4-978d-1a5c393fedac.jpg"> </div><br></p><h2 id="互联网的组成"><a href="#互联网的组成" class="headerlink" title="互联网的组成"></a>互联网的组成</h2><ol><li>边缘部分：所有连接在互联网上的主机，用户可以直接使用；</li><li>核心部分：由大量的网络和连接这些网络的路由器组成，为边缘部分的主机提供服务。</li></ol><p><br><div align="center"> <img src="../pics/8ab40d6d-bd7c-47d3-afe8-6a8bc9f5d04c.jpg"> </div><br></p><h2 id="主机之间的通信方式"><a href="#主机之间的通信方式" class="headerlink" title="主机之间的通信方式"></a>主机之间的通信方式</h2><p><strong>1. 客户-服务器（C/S）</strong> </p><p>客户是服务的请求方，服务器是服务的提供方。</p><p><strong>2. 对等（P2P）</strong> </p><p>不区分客户和服务器。</p><h2 id="电路交换与分组交换"><a href="#电路交换与分组交换" class="headerlink" title="电路交换与分组交换"></a>电路交换与分组交换</h2><p><br><div align="center"> <img src="../pics/c50d230c-8b89-4644-8f62-8708d03aac5b.jpg"> </div><br></p><h3 id="1-电路交换"><a href="#1-电路交换" class="headerlink" title="1. 电路交换"></a>1. 电路交换</h3><p>电路交换用于电话通信系统，两个用户要通信之前需要建立一条专用的物理链路，并且在整个通信过程中始终占用该链路。由于通信的过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低，往往不到 10%。</p><h3 id="2-报文交换"><a href="#2-报文交换" class="headerlink" title="2. 报文交换"></a>2. 报文交换</h3><p>报文交换用于邮局通信系统，邮局接收到一份报文之后，先存储下来，然后把相同目的地的报文一起转发到下一个目的地，这个过程就是存储转发过程。</p><h3 id="3-分组交换"><a href="#3-分组交换" class="headerlink" title="3. 分组交换"></a>3. 分组交换</h3><p>分组交换也使用了存储转发，但是转发的是分组而不是报文。把整块数据称为一个报文，由于一个报文可能很长，需要先进行切分，来满足分组能处理的大小。在每个切分的数据前面加上首部之后就成为了分组，首部包含了目的地址和源地址等控制信息。</p><p><br><div align="center"> <img src="../pics/2366c2ad-5859-4d4e-805f-7e2b88061cd8.jpg"> </div><br></p><p>存储转发允许在一条传输线路上传送多个主机的分组，因此两个用户之间的通信不需要占用端到端的线路资源。</p><p>相比于报文交换，由于分组比报文更小，因此分组交换的存储转发速度更加快速。</p><h2 id="时延"><a href="#时延" class="headerlink" title="时延"></a>时延</h2><p>总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延</p><p><br><div align="center"> <img src="../pics/ceee91c2-da26-4169-94c3-e4608b46b9ac.png"> </div><br></p><h3 id="1-发送时延"><a href="#1-发送时延" class="headerlink" title="1. 发送时延"></a>1. 发送时延</h3><p>主机或路由器发送数据帧所需要的时间。</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?delay=\frac{l(bit)}{v(bit/s)}"></div> <br></p><p>其中 l 表示数据帧的长度，v 表示发送速率。</p><h3 id="2-传播时延"><a href="#2-传播时延" class="headerlink" title="2. 传播时延"></a>2. 传播时延</h3><p>电磁波在信道中传播一定的距离需要花费的时间，电磁波传播速度接近光速。</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?delay=\frac{l(m)}{v(m/s)}"></div> <br></p><p>其中 l 表示信道长度，v 表示电磁波在信道上的传播速率。</p><h3 id="3-处理时延"><a href="#3-处理时延" class="headerlink" title="3. 处理时延"></a>3. 处理时延</h3><p>主机或路由器收到分组时进行处理所需要的时间，例如分析首部，从分组中提取数据部分等。</p><h3 id="4-排队时延"><a href="#4-排队时延" class="headerlink" title="4. 排队时延"></a>4. 排队时延</h3><p>分组在路由器的输入队列和输出队列中排队等待的时间，取决于网络当前的通信量。</p><h2 id="计算机网络体系结构"><a href="#计算机网络体系结构" class="headerlink" title="计算机网络体系结构*"></a>计算机网络体系结构*</h2><p><br><div align="center"> <img src="../pics/1005dc9d-9049-4b06-9524-6171e56ebd8c.png"> </div><br></p><h3 id="1-七层协议"><a href="#1-七层协议" class="headerlink" title="1. 七层协议"></a>1. 七层协议</h3><p>如图 a 所示，其中表示层和会话层用途如下：</p><ol><li>表示层：信息的语法、语义以及它们的关联，如加密解密、转换翻译、压缩解压缩；</li><li>会话层：不同机器上的用户之间建立及管理会话。</li></ol><h3 id="2-五层协议"><a href="#2-五层协议" class="headerlink" title="2. 五层协议"></a>2. 五层协议</h3><ol><li><p>应用层：为特定应用程序提供数据传输服务，例如 HTTP、DNS 等。数据单位为报文。</p></li><li><p>运输层：提供的是进程间的通用数据传输服务。由于应用层协议很多，定义通用的运输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。</p></li><li><p>网络层：为主机之间提供服务，而不是像运输层协议那样是为主机中的进程提供服务。网络层把运输层传递下来的报文段或者用户数据报封装成分组来进行传输。</p></li><li><p>数据链路层：网络层针对的还是主机之间，而主机之间可以有很多链路，链路层协议就是为相邻结点之间提供服务。数据链路层把网络层传来的分组封装成帧。</p></li><li><p>物理层：考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使物理层上的数据链路层感觉不到这些差异。</p></li></ol><h3 id="3-数据在各层之间的传递过程"><a href="#3-数据在各层之间的传递过程" class="headerlink" title="3. 数据在各层之间的传递过程"></a>3. 数据在各层之间的传递过程</h3><p>在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。</p><p>路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要运输层和应用层。</p><p><br><div align="center"> <img src="../pics/ac106e7e-489a-4082-abd9-dabebe48394c.jpg"> </div><br></p><h3 id="4-TCP-IP-体系结构"><a href="#4-TCP-IP-体系结构" class="headerlink" title="4. TCP/IP 体系结构"></a>4. TCP/IP 体系结构</h3><p>它只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。</p><p>现在的 TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。</p><p><br><div align="center"> <img src="../pics/37b74a34-251c-45f8-88a4-614ec953f7e9.png"> </div><br></p><p>TCP/IP 协议族是一种沙漏形状，中间小两边大，IP 协议在其中占用举足轻重的地位。</p><p><br><div align="center"> <img src="../pics/93cbce0c-c37d-429c-815b-861976a46bd8.png"> </div><br></p><h1 id="第二章-物理层"><a href="#第二章-物理层" class="headerlink" title="第二章 物理层"></a>第二章 物理层</h1><h2 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h2><ol><li>单向通信，又称为单工通信；</li><li>双向交替通信，又称为半双工通信；</li><li>双向同时通信，又称为全双工通信。</li></ol><h2 id="带通调制"><a href="#带通调制" class="headerlink" title="带通调制"></a>带通调制</h2><p>模拟信号是连续的信号，数字信号是离散的信号。带通调制把数字信号转换为模拟信号。</p><p><br><div align="center"> <img src="../pics/d2c55c84-aa1f-43c1-bd97-457bcb7816b3.png"> </div><br></p><h2 id="信道复用技术"><a href="#信道复用技术" class="headerlink" title="信道复用技术"></a>信道复用技术</h2><h3 id="1-频分复用、时分复用"><a href="#1-频分复用、时分复用" class="headerlink" title="1. 频分复用、时分复用"></a>1. 频分复用、时分复用</h3><p>频分复用的所有用户在相同的时间占用不同的频率带宽资源；时分复用的所有用户在不同的时间占用相同的频率带宽资源。</p><p>使用这两种方式进行通信，在通信的过程中用户会一直占用一部分信道资源。但是由于计算机数据的突发性质，没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高。</p><p><br><div align="center"> <img src="../pics/543d47a1-f0dd-414f-b23c-0c142c814854.png"> </div><br></p><h3 id="2-统计时分复用"><a href="#2-统计时分复用" class="headerlink" title="2. 统计时分复用"></a>2. 统计时分复用</h3><p>是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。</p><p><br><div align="center"> <img src="../pics/29058e09-bb72-4040-a73d-4c497895e9ce.jpg"> </div><br></p><h3 id="3-波分复用"><a href="#3-波分复用" class="headerlink" title="3. 波分复用"></a>3. 波分复用</h3><p>光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。</p><p><br><div align="center"> <img src="../pics/78534153-88d1-4f83-a6e0-59064dbdc43a.png"> </div><br></p><h3 id="4-码分复用"><a href="#4-码分复用" class="headerlink" title="4. 码分复用"></a>4. 码分复用</h3><p>为每个用户分配 m bit 的码片，并且所有的码片正交，对于任意两个码片 <img src="https://latex.codecogs.com/gif.latex?\vec{S}"> 和 <img src="https://latex.codecogs.com/gif.latex?\vec{T}"> 有</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?\vec{S}\cdot\vec{T}=0"></div> <br></p><p>为了方便，取 m=8，设码片 <img src="https://latex.codecogs.com/gif.latex?\vec{S}"> 为 00011011。在拥有该码片的用户发送比特 1 时就发送该码片，发送比特 0 时就发送该码片的反码 11100100。</p><p>在计算时将 00011011 记作 (-1 -1 -1 +1 +1 -1 +1 +1)，可以得到</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?\frac{1}{m}\vec{S}\cdot\vec{S}=1"></div> <br></p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?\frac{1}{m}\vec{S}\cdot\vec{S'}=-1"></div> <br></p><p>其中 <img src="https://latex.codecogs.com/gif.latex?\vec{S'}"> 为 <img src="https://latex.codecogs.com/gif.latex?\vec{S}"> 的反码。</p><p>利用上面的式子我们知道，当接收端使用码片 <img src="https://latex.codecogs.com/gif.latex?\vec{S}"> 对接收到的数据进行内积运算时，结果为 0 的是其它用户发送的数据，结果为 1 的是用户发送的比特 1，结果为 -1 的是用户发送的比特 0。</p><p>码分复用需要发送的数据量为原先的 m 倍。</p><p><br><div align="center"> <img src="../pics/0042edad-8e3b-4279-bd93-6906fcd1b640.jpg"> </div><br></p><h1 id="第三章-数据链路层"><a href="#第三章-数据链路层" class="headerlink" title="第三章 数据链路层"></a>第三章 数据链路层</h1><h2 id="三个基本问题"><a href="#三个基本问题" class="headerlink" title="三个基本问题"></a>三个基本问题</h2><h3 id="1-封装成帧"><a href="#1-封装成帧" class="headerlink" title="1. 封装成帧"></a>1. 封装成帧</h3><p>将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。</p><p><br><div align="center"> <img src="../pics/3402d1c0-7020-4249-9a7f-12ea2ea6adf7.jpg"> </div><br></p><h3 id="2-透明传输"><a href="#2-透明传输" class="headerlink" title="2. 透明传输"></a>2. 透明传输</h3><p>透明表示一个实际存在的事物看起来好像不存在一样。</p><p>帧中有首部和尾部，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。需要在数据中出现首部尾部相同的内容前面插入转义字符，如果需要传输的内容正好就是转义字符，那么就在转义字符前面再加个转义字符，在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。</p><p><br><div align="center"> <img src="../pics/4146e14b-56b9-433c-8e3d-74b1b325399c.jpg"> </div><br></p><h3 id="3-差错检测"><a href="#3-差错检测" class="headerlink" title="3. 差错检测"></a>3. 差错检测</h3><p>目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。</p><h2 id="点对点信道-PPP-协议"><a href="#点对点信道-PPP-协议" class="headerlink" title="点对点信道 - PPP 协议"></a>点对点信道 - PPP 协议</h2><p>互联网用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP 协议就是用户计算机和 ISP 进行通信时所使用的数据链路层协议。</p><p><br><div align="center"> <img src="../pics/8393f520-d824-44ea-a5f3-1c1a73d735fb.jpg"> </div><br></p><p>在 PPP 的帧中</p><ul><li>F 字段为帧的定界符</li><li>A 和 C 字段暂时没有意义</li><li>FCS 字段是使用 CRC 的检验序列</li><li>信息部分的长度不超过 1500</li></ul><p><br><div align="center"> <img src="../pics/0f39c274-b79c-4e83-8c7c-94fc2747832d.jpg"> </div><br></p><h2 id="局域网的拓扑"><a href="#局域网的拓扑" class="headerlink" title="局域网的拓扑"></a>局域网的拓扑</h2><p><br><div align="center"> <img src="../pics/8b15e36f-69b4-46b6-a07c-7234ac7c7927.jpg"> </div><br></p><h2 id="广播信道-CSMA-CD-协议"><a href="#广播信道-CSMA-CD-协议" class="headerlink" title="广播信道 - CSMA/CD 协议*"></a>广播信道 - CSMA/CD 协议*</h2><p>在广播信道上，同一时间只能允许一台计算机发送数据。</p><p>CSMA/CD 表示载波监听多点接入 / 碰撞检测。</p><ul><li><strong>多点接入</strong> ：说明这是总线型网络，许多计算机以多点的方式连接到总线上。</li><li><strong>载波监听</strong> ：每个站都必须不停地检听信道。在发送前，如果检听信道正在使用，就必须等待。</li><li><strong>碰撞检测</strong> ：在发送中，如果检听到信道已有其它站正在发送数据，就表示发生了碰撞。虽然每一个站在发送数据之前都已经检听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。</li></ul><p><br><div align="center"> <img src="../pics/f9ed4da5-0032-41e6-991a-36d995ec28fd.png"> </div><br></p><p>记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称 2τ 为  <strong>争用期</strong> 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。</p><p>当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用  <strong>截断二进制指数退避算法</strong>  来确定，从离散的整数集合 {0, 1, .., (2<sup>k</sup>-1)} 中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间。</p><h2 id="集线器"><a href="#集线器" class="headerlink" title="集线器"></a>集线器</h2><p>从表面上看，使用集线器的局域网在物理上是一个星型网。但是集线器使用电子器件来模拟实际缆线的工作，逻辑上仍是一个总线网，整个系统仍像一个传统以太网那样运行。</p><p><br><div align="center"> <img src="../pics/3294ff06-f942-425e-aecc-ca04e45566d4.png"> </div><br></p><p><br><div align="center"> <img src="../pics/b56ef52e-3d0f-4cdd-97dc-eaed893444a5.jpg"> </div><br></p><h2 id="MAC-层"><a href="#MAC-层" class="headerlink" title="MAC 层*"></a>MAC 层*</h2><p>MAC 地址是 6 字节（48 位）的地址，用于唯一表示网络适配器（网卡），一台主机拥有多少个适配器就有多少个 MAC 地址，例如笔记本电脑普遍存在无线网络适配器和有线网络适配器。</p><p><br><div align="center"> <img src="../pics/50d38e84-238f-4081-8876-14ef6d7938b5.jpg"> </div><br></p><ul><li><strong>类型</strong> ：标记上层使用的协议；</li><li><strong>数据</strong> ：长度在 46-1500 之间，如果太小则需要填充；</li><li><strong>FCS</strong> ：帧检验序列，使用的是 CRC 检验方法；</li><li><strong>前同步码</strong> ：只是为了计算 FCS 临时加入的，计算结束之后会丢弃。</li></ul><h2 id="虚拟局域网"><a href="#虚拟局域网" class="headerlink" title="虚拟局域网"></a>虚拟局域网</h2><p>虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息，例如下图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。</p><p><br><div align="center"> <img src="../pics/a74b70ac-323a-4b31-b4d5-90569b8a944b.png"> </div><br></p><h1 id="第四章-网络层"><a href="#第四章-网络层" class="headerlink" title="第四章 网络层*"></a>第四章 网络层*</h1><h2 id="网际协议-IP-概述"><a href="#网际协议-IP-概述" class="headerlink" title="网际协议 IP 概述"></a>网际协议 IP 概述</h2><p>因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。</p><p>使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。</p><p><br><div align="center"> <img src="../pics/fe3d224c-8ffd-40f9-85b1-86ffe1393f6c.jpg"> </div><br></p><p>与 IP 协议配套使用的还有三个协议：</p><ol><li>地址解析协议 ARP（Address Resolution Protocol）</li><li>网际控制报文协议 ICMP（Internet Control Message Protocol）</li><li>网际组管理协议 IGMP（Internet Group Management Protocol）</li></ol><p><br><div align="center"> <img src="../pics/163cf8b4-5f30-46c9-af00-316a71b3c890.jpg"> </div><br></p><h2 id="IP-数据报格式"><a href="#IP-数据报格式" class="headerlink" title="IP 数据报格式"></a>IP 数据报格式</h2><p><br><div align="center"> <img src="../pics/8681db55-0873-434b-aa98-83d07e8392ae.jpg"> </div><br></p><ul><li><p><strong>版本</strong>  : 有 4（IPv4）和 6（IPv6）两个值；</p></li><li><p><strong>首部长度</strong>  : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为首部固定长度为 20 字节，因此该值最小为 5。如果可选部分的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。</p></li><li><p><strong>区分服务</strong>  : 用来获得更好的服务，一般情况下不使用。</p></li><li><p><strong>总长度</strong>  : 包括首部长度和数据部分长度。</p></li><li><p><strong>标识</strong>  : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。</p></li><li><p><strong>片偏移</strong>  : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。</p></li></ul><p><br><div align="center"> <img src="../pics/45c86855-9b18-4cf4-a9a7-f8b6eb78d133.png"> </div><br></p><ul><li><p><strong>生存时间</strong>  ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。</p></li><li><p><strong>协议</strong> ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。</p></li><li><p><strong>首部检验和</strong> ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。</p></li></ul><h2 id="IP-地址编址"><a href="#IP-地址编址" class="headerlink" title="IP 地址编址"></a>IP 地址编址</h2><p>IP 地址的编址方式经历了三个历史阶段：</p><ol><li>分类；</li><li>子网划分；</li><li>无分类。</li></ol><h3 id="1-分类"><a href="#1-分类" class="headerlink" title="1. 分类"></a>1. 分类</h3><p>由两部分组成，网络号和主机号，其中不同类别具有不同的网络号长度，并且是固定的。</p><p>IP 地址 ::= {&lt; 网络号 &gt;, &lt; 主机号 &gt;}</p><p><br><div align="center"> <img src="../pics/2ddd6132-60be-4a72-9daa-3d9756191f4a.png"> </div><br></p><h3 id="2-子网划分"><a href="#2-子网划分" class="headerlink" title="2. 子网划分"></a>2. 子网划分</h3><p>通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。注意，外部网络看不到子网的存在。</p><p>IP 地址 ::= {&lt; 网络号 &gt;, &lt; 子网号 &gt;, &lt; 主机号 &gt;}</p><p>要使用子网，必须配置子网掩码。一个 B 类地址的默认子网掩码为 255.255.0.0，如果 B 类地址的子网占两个比特，那么子网掩码为 11111111 11111111 11000000 000000，也就是 255.255.192.0。</p><h3 id="3-无分类"><a href="#3-无分类" class="headerlink" title="3. 无分类"></a>3. 无分类</h3><p>无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。</p><p>IP 地址 ::= {&lt; 网络前缀号 &gt;, &lt; 主机号 &gt;}</p><p>CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。</p><p>CIDR 的地址掩码可以继续称为子网掩码，子网掩码首 1 长度为网络前缀的长度。</p><p>一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为  <strong>构成超网</strong> 。</p><p>在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。</p><h2 id="IP-地址和-MAC-地址"><a href="#IP-地址和-MAC-地址" class="headerlink" title="IP 地址和 MAC 地址"></a>IP 地址和 MAC 地址</h2><p>网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变。</p><p><br><div align="center"> <img src="../pics/86b71296-0d1e-4a63-bcd9-54955b6b781b.jpg"> </div><br></p><h2 id="地址解析协议-ARP"><a href="#地址解析协议-ARP" class="headerlink" title="地址解析协议 ARP"></a>地址解析协议 ARP</h2><p>实现由 IP 地址得到 MAC 地址。</p><p>每个主机都有一个 ARP 高速缓存，存放映射表。如果一个 IP 地址到 MAC 地址的映射不在该表中，主机通过广播的方式发送 ARP 请求分组，匹配 IP 地址的主机会发送 ARP 响应分组告知其 MAC 地址。</p><p><br><div align="center"> <img src="../pics/8bc6fc2c-d198-4759-b06c-18d94d851e97.png"> </div><br></p><h2 id="路由器的结构"><a href="#路由器的结构" class="headerlink" title="路由器的结构"></a>路由器的结构</h2><p>路由器从功能上可以划分为两大部分：路由选择和分组转发。</p><p>分组转发部分由三部分组成：交换结构、一组输入端口和一组输出端口。</p><p><br><div align="center"> <img src="../pics/3a676c54-b559-4466-9b21-eb10f1e25879.jpg"> </div><br></p><p>交换结构的交换网络有以下三种实现方式：</p><p><br><div align="center"> <img src="../pics/7f82fd18-7f16-4125-ada6-bb6b795b4fda.png"> </div><br></p><h2 id="交换机与路由器的区别"><a href="#交换机与路由器的区别" class="headerlink" title="交换机与路由器的区别"></a>交换机与路由器的区别</h2><ul><li>交换机工作于数据链路层，能识别 MAC 地址，根据 MAC 地址转发链路层数据帧。具有自学机制来维护 IP 地址与 MAC 地址的映射。</li><li>路由器位于网络层，能识别 IP 地址并根据 IP 地址转发分组。维护着路由表，根据路由表选择最佳路线。</li></ul><h2 id="路由器分组转发流程"><a href="#路由器分组转发流程" class="headerlink" title="路由器分组转发流程"></a>路由器分组转发流程</h2><ol><li>从数据报的首部提取目的主机的 IP 地址 D，得到目的网络地址 N。（路由表项是网络号而不是 IP 地址，这样做大大减少了路由表条目数量）</li><li>若 N 就是与此路由器直接相连的某个网络地址，则进行直接交付；</li><li>若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器；</li><li>若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器；</li><li>若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；</li><li>报告转发分组出错。</li></ol><p><br><div align="center"> <img src="../pics/8d211911-0e62-4190-ab00-d8610adec4a0.jpg"> </div><br></p><h2 id="路由选择协议"><a href="#路由选择协议" class="headerlink" title="路由选择协议"></a>路由选择协议</h2><p>互联网使用的路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。</p><p>互联网可以划分为许多较小的自治系统 AS，一个 AS 可以使用一种和别的 AS 不同的路由选择协议。</p><p>可以把路由选择协议划分为两大类：</p><ol><li>内部网关协议 IGP（Interior Gateway Protocol）：在 AS 内部使用，如 RIP 和 OSPF。</li><li>外部网关协议 EGP（External Gateway Protocol）：在 AS 之间使用，如 BGP。</li></ol><p><br><div align="center"> <img src="../pics/e0be6970-5b0e-44a2-bc71-df4d61c42b8f.jpg"> </div><br></p><h3 id="1-内部网关协议-RIP"><a href="#1-内部网关协议-RIP" class="headerlink" title="1. 内部网关协议 RIP"></a>1. 内部网关协议 RIP</h3><p>RIP 是一种分布式的基于距离向量的路由选择协议。距离是指跳数，直接相连的路由器跳数为 1，跳数最多为 15，超过 15 表示不可达。</p><p>RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。</p><p>距离向量算法：</p><ol><li>对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；</li><li>对修改后的 RIP 报文中的每一个项目，进行以下步骤：<ul><li>若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；</li><li>否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。</li></ul></li><li>若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。</li></ol><p>RIP 协议实现简单，开销小，但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器。</p><h3 id="2-内部网关协议-OSPF"><a href="#2-内部网关协议-OSPF" class="headerlink" title="2. 内部网关协议 OSPF"></a>2. 内部网关协议 OSPF</h3><p>开放最短路径优先 OSPF，是为了克服 RIP 的缺点而开发出来的。</p><p>开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了 Dijkstra 提出的最短路径算法 SPF。</p><p>OSPF 具有以下特点：</p><ul><li>向本自治系统中的所有路由器发送信息，这种方法是洪泛法。</li><li>发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。</li><li>只有当链路状态发生变化时，路由器才会发送信息。</li></ul><p>所有路由器都具有全网的拓扑结构图，并且是一致的。相比于 RIP，OSPF 的更新过程收敛的很快。</p><h3 id="3-外部网关协议-BGP"><a href="#3-外部网关协议-BGP" class="headerlink" title="3. 外部网关协议 BGP"></a>3. 外部网关协议 BGP</h3><p>AS 之间的路由选择很困难，主要是互联网规模很大。并且各个 AS 内部使用不同的路由选择协议，就无法准确定义路径的度量。并且 AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。</p><p>BGP 只能寻找一条比较好的路由，而不是最佳路由。它采用路径向量路由选择协议。</p><p>每个 AS 都必须配置 BGP 发言人，通过在两个相邻 BGP 发言人之间建立 TCP 连接来交换路由信息。</p><p><br><div align="center"> <img src="../pics/eb6271de-22c9-4f4b-8b31-eab1f560efac.png"> </div><br></p><h2 id="网际控制报文协议-ICMP"><a href="#网际控制报文协议-ICMP" class="headerlink" title="网际控制报文协议 ICMP"></a>网际控制报文协议 ICMP</h2><p>ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。它封装在 IP 数据报中，但是不属于高层协议。</p><p><br><div align="center"> <img src="../pics/9b5e0fa0-9274-4219-a3a9-84fbb509c735.jpg"> </div><br></p><p>ICMP 报文分为差错报告报文和询问报文。</p><p><br><div align="center"> <img src="../pics/6e11b122-95ce-4869-bf7d-3b0d7591707e.jpg"> </div><br></p><h2 id="分组网间探测-PING"><a href="#分组网间探测-PING" class="headerlink" title="分组网间探测 PING"></a>分组网间探测 PING</h2><p>PING 是 ICMP 的一个重要应用，主要用来测试两台主机之间的连通性。</p><p>PING 的过程：</p><ol><li>PING 同一个网段的主机：查找目的主机的 MAC 地址，然后直接交付。如果无法查找到 MAC 地址，就要进行一次 ARP 请求。</li><li>PING 不同网段的主机：发送到网关让其进行转发。同样要发送到网关也需要通过查找网关的 MAC 地址，根据 MAC 地址进行转发。</li></ol><h2 id="IP-多播"><a href="#IP-多播" class="headerlink" title="IP 多播"></a>IP 多播</h2><p>在一对多的通信中，多播不需要将分组复制多份，从而大大节约网络资源。</p><p><br><div align="center"> <img src="../pics/c77b6a18-dfac-42a2-ac89-7e99481275dc.jpg"> </div><br></p><h2 id="虚拟专用网-VPN"><a href="#虚拟专用网-VPN" class="headerlink" title="虚拟专用网 VPN"></a>虚拟专用网 VPN</h2><p>由于 IP 地址的紧缺，一个机构能申请到的 IP 地址数往往远小于本机构所拥有的主机数。并且一个机构并不需要把所有的主机接入到外部的互联网中，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。</p><p>有三个专用地址块：</p><ol><li>10.0.0.0 ~ 10.255.255.255</li><li>172.16.0.0 ~ 172.31.255.255</li><li>192.168.0.0 ~ 192.168.255.255</li></ol><p>VPN 使用公用的互联网作为本机构各专用网之间的通信载体。专用指机构内的主机只与本机构内的其它主机通信；虚拟指“好像是”，而实际上并不是，它有经过公用的互联网。</p><p>下图中，场所 A 和 B 的通信部经过互联网，如果场所 A 的主机 X 要和另一个场所 B 的主机 Y 通信，IP 数据报的源地址是 10.1.0.1，目的地址是 10.2.0.3。数据报先发送到与互联网相连的路由器 R1，R1 对内部数据进行加密，然后重新加上数据报的首部，源地址是路由器 R1 的全球地址 125.1.2.3，目的地址是路由器 R2 的全球地址 194.4.5.6。路由器 R2 收到数据报后将数据部分进行解密，恢复原来的数据报，此时目的地址为 10.2.0.3，就交付给 Y。</p><p><br><div align="center"> <img src="../pics/bf4ed077-d481-4db7-9e7a-85d841a5a8c3.jpg"> </div><br></p><h2 id="网络地址转换-NAT"><a href="#网络地址转换-NAT" class="headerlink" title="网络地址转换 NAT"></a>网络地址转换 NAT</h2><p>专用网内部的主机使用本地 IP 地址又想和互联网上的主机通信时，可以使用 NAT 来将本地 IP 转换为全球 IP。</p><p>在以前，NAT 将本地 IP 和全球 IP 一一对应，这种方式下拥有 n 个全球 IP 地址的专用网内最多只可以同时有 n 台主机接入互联网。为了更有效地利用全球 IP 地址，现在常用的 NAT 转换表把运输层的端口号也用上了，使得多个专用网内部的主机共用一个全球 IP 地址。使用端口号的 NAT 也叫做网络地址与端口转换 NAPT。</p><p><br><div align="center"> <img src="../pics/0f31bc7a-d60b-48a6-8e3f-597708369e52.png"> </div><br></p><h1 id="第五章-运输层"><a href="#第五章-运输层" class="headerlink" title="第五章 运输层*"></a>第五章 运输层*</h1><p>网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。</p><p>运输层提供了应用进程间的逻辑通信。运输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看见的好像在两个运输层实体之间有一条端到端的逻辑通信信道。</p><h2 id="UDP-和-TCP-的特点"><a href="#UDP-和-TCP-的特点" class="headerlink" title="UDP 和 TCP 的特点"></a>UDP 和 TCP 的特点</h2><ul><li><p>用户数据包协议 UDP（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部）。</p></li><li><p>传输控制协议 TCP（Transmission Control Protocol） 是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块）</p></li></ul><h2 id="UDP-首部格式"><a href="#UDP-首部格式" class="headerlink" title="UDP 首部格式"></a>UDP 首部格式</h2><p><br><div align="center"> <img src="../pics/bd6c05f3-02ee-4c8a-b374-40c87154a898.jpg"> </div><br></p><p>首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和而临时添加的。</p><h2 id="TCP-首部格式"><a href="#TCP-首部格式" class="headerlink" title="TCP 首部格式"></a>TCP 首部格式</h2><p><br><div align="center"> <img src="../pics/21a00b02-c0a6-4bcd-9af0-5ec6bb66e34c.jpg"> </div><br></p><ul><li><p><strong>序号</strong>  ：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。</p></li><li><p><strong>确认号</strong>  ：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。</p></li><li><p><strong>数据偏移</strong>  ：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。</p></li><li><p><strong>确认 ACK</strong>  ：当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。</p></li><li><p><strong>同步 SYN</strong>  ：在连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。</p></li><li><p><strong>终止 FIN</strong>  ：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放运输连接。</p></li><li><p><strong>窗口</strong>  ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。</p></li></ul><h2 id="TCP-的三次握手"><a href="#TCP-的三次握手" class="headerlink" title="TCP 的三次握手"></a>TCP 的三次握手</h2><p><br><div align="center"> <img src="../pics/086871db-5871-460f-97b7-126cd738bb0e.jpg"> </div><br></p><p>假设 A 为客户端，B 为服务器端。</p><ol><li>首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。</li><li>A 向 B 发送连接请求报文段，SYN=1，ACK=0，选择一个初始的序号 x。</li><li>B 收到连接请求报文段，如果同意建立连接，则向 A 发送连接确认报文段，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。</li><li>A 收到 B 的连接确认报文段后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。</li><li>B 收到 A 的确认后，连接建立。</li></ol><h2 id="TCP-的四次挥手"><a href="#TCP-的四次挥手" class="headerlink" title="TCP 的四次挥手"></a>TCP 的四次挥手</h2><p><br><div align="center"> <img src="../pics/78f65456-666b-4044-b4ee-f7692dbbc0d3.jpg"> </div><br></p><p>以下描述不讨论序号和确认号，因为序号和确认号的规则比较简单。并且不讨论 ACK，因为 ACK 在连接建立之后都为 1。</p><ol><li>A 发送连接释放报文段，FIN=1；</li><li>B 收到之后发出确认，此时 TCP 属于半关闭状态，B 能向 A 发送数据但是 A 不能向 B 发送数据；</li><li>当 B 要不再需要连接时，发送连接释放请求报文段，FIN=1；</li><li>A 收到后发出确认，此时连接释放。</li></ol><p><strong>TIME_WAIT</strong> </p><p>客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间。这么做有两个理由：</p><ol><li>确保最后一个确认报文段能够到达。如果 B 没收到 A 发送来的确认报文段，那么就会重新发送连接释放请求报文段，A 等待一段时间就是为了处理这种情况的发生。</li><li>可能存在“已失效的连接请求报文段”，为了防止这种报文段出现在本次连接之外，需要等待一段时间。</li></ol><h2 id="TCP-滑动窗口"><a href="#TCP-滑动窗口" class="headerlink" title="TCP 滑动窗口"></a>TCP 滑动窗口</h2><p><br><div align="center"> <img src="../pics/223fc26e-2fd6-484c-bcb7-443cac134f15.jpg"> </div><br></p><p>窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。</p><p>发送窗口内的字节都允许被发送，接收窗口内的字节都允许被接收。如果发送窗口左部的字节已经发送并且收到了确认，那么就将发送窗口向右滑动一定距离，直到左部第一个字节不是已发送并且已确认的状态；接收窗口的滑动类似，接收窗口左部字节已经发送确认并交付主机，就向右滑动接收窗口。</p><p>接收窗口只会对窗口内最后一个按序到达的字节进行确认，例如接收窗口已经收到的字节为 {31, 32, 34, 35}，其中 {31, 32} 按序到达，而 {34, 35} 就不是，因此只对字节 32 进行确认。发送方得到一个字节的确认之后，就知道这个字节之前的所有字节都已经被接收。</p><h2 id="TCP-可靠传输"><a href="#TCP-可靠传输" class="headerlink" title="TCP 可靠传输"></a>TCP 可靠传输</h2><p>TCP 使用超时重传来实现可靠传输：如果一个已经发送的报文段在超时时间内没有收到确认，那么就重传这个报文段。</p><p>一个报文段从发送再到接收到确认所经过的时间称为往返时间 RTT，加权平均往返时间 RTTs 计算如下：</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?RTTs=(1-a)*(RTTs)+a*RTT"></div> <br></p><p>超时时间 RTO 应该略大于 RRTs，TCP 使用的超时时间计算如下：</p><p><div align="center"><img src="https://latex.codecogs.com/gif.latex?RTO=RTTs+4*RTT_d"></div> <br></p><p>其中 RTT<sub>d</sub> 为偏差，它与新的 RRT 和 RRTs 有关。</p><h2 id="TCP-流量控制"><a href="#TCP-流量控制" class="headerlink" title="TCP 流量控制"></a>TCP 流量控制</h2><p>流量控制是为了控制发送方发送速率，保证接收方来得及接收。</p><p>接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。例如将窗口字段设置为 0，则发送方不能发送数据。</p><h2 id="TCP-拥塞控制"><a href="#TCP-拥塞控制" class="headerlink" title="TCP 拥塞控制"></a>TCP 拥塞控制</h2><p>如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。因此当出现拥塞时，应当控制发送方的速率。这一点和流量控制很像，但是出发点不同。流量控制是为了让接收方能来得及接受，而拥塞控制是为了降低整个网络的拥塞程度。</p><p><br><div align="center"> <img src="../pics/a69af9bb-b5ad-4896-862d-697e5ee4feb1.png"> </div><br></p><p>TCP 主要通过四种算法来进行拥塞控制：慢开始、拥塞避免、快重传、快恢复。发送方需要维护有一个叫做拥塞窗口（cwnd）的状态变量。注意拥塞窗口与发送方窗口的区别，拥塞窗口只是一个状态变量，实际决定发送方能发送多少数据的是发送方窗口。</p><p>为了便于讨论，做如下假设：</p><ol><li>接收方有足够大的接收缓存，因此不会发生流量控制；</li><li>虽然 TCP 的窗口基于字节，但是这里设窗口的大小单位为报文段。</li></ol><p><br><div align="center"> <img src="../pics/346244ff-98c1-4f12-9a87-d0832e8c04cf.jpg"> </div><br></p><h3 id="慢开始与拥塞避免"><a href="#慢开始与拥塞避免" class="headerlink" title="慢开始与拥塞避免"></a>慢开始与拥塞避免</h3><p>发送的最初执行慢开始，令 cwnd=1，发送方只能发送 1 个报文段；当收到确认后，将 cwnd 加倍，因此之后发送方能够发送的报文段为：2、4、8 …</p><p>注意到慢开始每个轮次都将 cwnd 加倍，这样会让 cwnd 增长速度非常快，从而使得发送方发送的速度增长速度过快，网络拥塞的可能也就更高。设置一个慢开始门限 ssthresh，当 cwnd &gt;= ssthresh 时，进入拥塞避免，每个轮次只将 cwnd 加 1。</p><p>如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始。</p><h3 id="快重传与快恢复"><a href="#快重传与快恢复" class="headerlink" title="快重传与快恢复"></a>快重传与快恢复</h3><p>在接收方，要求每次接收到报文段都应该发送对已收到有序报文段的确认，例如已经接收到 M<sub>1</sub> 和 M<sub>2</sub>，此时收到 M<sub>4</sub>，应当发送对 M<sub>2</sub> 的确认。</p><p>在发送方，如果收到三个重复确认，那么可以确认下一个报文段丢失，例如收到三个 M<sub>2</sub> ，则 M<sub>3</sub> 丢失。此时执行快重传，立即重传下一个报文段。</p><p>在这种情况下，只是丢失个别报文段，而不是网络拥塞，因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免。</p><p><br><div align="center"> <img src="../pics/b18d679b-c8e2-4564-88ee-7600090e46da.jpg"> </div><br></p><h1 id="第六章-应用层"><a href="#第六章-应用层" class="headerlink" title="第六章 应用层*"></a>第六章 应用层*</h1><h2 id="域名系统-DNS"><a href="#域名系统-DNS" class="headerlink" title="域名系统 DNS"></a>域名系统 DNS</h2><p>把主机名解析为 IP 地址。</p><p>被设计成分布式系统。</p><h3 id="1-层次结构"><a href="#1-层次结构" class="headerlink" title="1. 层次结构"></a>1. 层次结构</h3><p>一个域名由多个层次构成，从上层到下层分别为顶级域名、二级域名、三级域名以及四级域名。所有域名可以画成一颗域名树。</p><p><br><div align="center"> <img src="../pics/c2117f61-1177-4768-bf33-cf4f950d911c.png"> </div><br></p><p><br><div align="center"> <img src="../pics/a4b162e5-db2a-4a27-b213-1fe481c5a06a.png"> </div><br></p><p>域名服务器可以分为以下四类：</p><ol><li>根域名服务器：解析顶级域名；</li><li>顶级域名服务器：解析二级域名；</li><li>权限域名服务器：解析区内的域名；</li><li>本地域名服务器：也称为默认域名服务器。可以在其中配置高速缓存。</li></ol><p>区和域的概念不同，可以在一个域中划分多个区。图 b 在域 abc.com 中划分了两个区：abc.com 和 y.abc.com</p><p><br><div align="center"> <img src="../pics/fc0c6b2d-68c7-4de8-aaaa-97355a4f0472.jpg"> </div><br></p><p>因此就需要两个权限域名服务器：</p><p><br><div align="center"> <img src="../pics/8b335d94-c1ca-42e1-ad48-bb179d28a4f1.jpg"> </div><br></p><h3 id="2-解析过程"><a href="#2-解析过程" class="headerlink" title="2. 解析过程"></a>2. 解析过程</h3><p>主机向本地域名服务器解析的过程采用递归，而本地域名服务器向其它域名服务器解析可以使用递归和迭代两种方式。</p><p>迭代的方式下，本地域名服务器向一个域名服务器解析请求解析之后，结果返回到本地域名服务器，然后本地域名服务器继续向其它域名服务器请求解析；而递归地方式下，结果不是直接返回的，而是继续向前请求解析，最后的结果才会返回。</p><p><br><div align="center"> <img src="../pics/6bc61bb8-3b1c-4dc8-ac25-cef925ace0eb.jpg"> </div><br></p><h2 id="文件传输协议-FTP"><a href="#文件传输协议-FTP" class="headerlink" title="文件传输协议 FTP"></a>文件传输协议 FTP</h2><p>FTP 在运输层使用 TCP，并且需要建立两个并行的 TCP 连接：控制连接和数据连接。控制连接在整个会话期间一直保持打开，而数据连接在数据传送完毕之后就关闭。控制连接使用端口号 21，数据连接使用端口号 20。</p><p><br><div align="center"> <img src="../pics/58633775-8584-4a01-ad3f-eee4d9a466e1.jpg"> </div><br></p><h2 id="远程终端协议-TELNET"><a href="#远程终端协议-TELNET" class="headerlink" title="远程终端协议 TELNET"></a>远程终端协议 TELNET</h2><p>TELNET 用于登录到远程主机上，并且远程主机上的输出也会返回。</p><p>TELNET 可以适应许多计算机和操作系统的差异，例如不同操作系统系统的换行符定义。</p><h2 id="万维网-WWW"><a href="#万维网-WWW" class="headerlink" title="万维网 WWW"></a>万维网 WWW</h2><p><a href="https://github.com/CyC2018/InterviewNotes/blob/master/notes/HTTP.md" target="_blank" rel="noopener">HTTP</a></p><h2 id="电子邮件协议"><a href="#电子邮件协议" class="headerlink" title="电子邮件协议"></a>电子邮件协议</h2><p>一个电子邮件系统由三部分组成：用户代理、邮件服务器以及邮件发送协议和读取协议。其中发送协议常用 SMTP，读取协议常用 POP3 和 IMAP。</p><p><br><div align="center"> <img src="../pics/de1e46d2-748f-4da3-a29e-7de7bc840366.jpg"> </div><br></p><h3 id="POP3"><a href="#POP3" class="headerlink" title="POP3"></a>POP3</h3><p>POP3 的特点是只要用户从服务器上读取了邮件，就把该邮件删除。</p><h3 id="IMAP"><a href="#IMAP" class="headerlink" title="IMAP"></a>IMAP</h3><p>IMAP 协议中客户端和服务器上的邮件保持同步，如果不去手动删除邮件，那么服务器上的邮件也不会被删除。IMAP 这种做法可以让用户随时随地去访问服务器上的邮件。IMAP 协议也支持创建自定义的文件夹。</p><h3 id="SMTP"><a href="#SMTP" class="headerlink" title="SMTP"></a>SMTP</h3><p>SMTP 只能发送 ASCII 码，而互联网邮件扩充 MIME 可以发送二进制文件。MIME 并没有改动或者取代 SMTP，而是增加邮件主题的结构，定义了非 ASCII 码的编码规则。</p><p><br><div align="center"> <img src="../pics/ed5522bb-3a60-481c-8654-43e7195a48fe.png"> </div><br></p><h2 id="动态主机配置协议-DHCP"><a href="#动态主机配置协议-DHCP" class="headerlink" title="动态主机配置协议 DHCP"></a>动态主机配置协议 DHCP</h2><p>DHCP 提供了即插即用的连网方式，用户不再需要去手动配置 IP 地址等信息。</p><p>DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、默认路由器 IP 地址、域名服务器的 IP 地址。</p><p>工作方式如下：需要 IP 地址的主机广播发送 DHCP 发现报文（将目的地址置为全 1，即 255.255.255.255:67，源地址设置为全 0，即 0.0.0.0:68），DHCP 服务器收到发现报文之后，则在 IP 地址池中取一个地址，发送 DHCP 提供报文给该主机。</p><h2 id="点对点传输-P2P"><a href="#点对点传输-P2P" class="headerlink" title="点对点传输 P2P"></a>点对点传输 P2P</h2><p>把某个文件分发的所有对等集合称为一个洪流。文件的数据单元称为文件块，它的大小是固定的。一个新的对等方加入某个洪流，一开始并没有文件块，但是能够从其它对等方中逐渐地下载到一些文件块，与此同时，它也为别的对等方上传一些文件块。</p><p>每个洪流都有一个基础设施，称为追踪器。当一个对等方加入洪流时，必须向追踪器登记，并周期性地通知追踪器它仍在洪流中。可以在任何时间加入和退出某个洪流。</p><p>一个新的对等方加入洪流时，追踪器会随机从洪流中选择若干个对等方，并让新对等方与这些对等方建立连接，把这些对等方称为相邻对等方。接收和发送文件块都是在相邻对等方中进行。</p><p>当一个对等方需要很多文件块时，通过使用最稀有优先的策略来取得文件块，也就是一个文件块在相邻对等方中副本最少，那么就优先请求这个文件块。</p><p>当很多对等方向同一个对等方请求文件块时，该对等方优先选择以最高速率向其发送文件块的对等方。</p><p>P2P 是一个分布式系统，任何时候都有对等方加入或者退出。使用分布式散列表 DHT，可以查找洪流中的资源和 IP 地址映射。</p><h2 id="Web-页面请求过程"><a href="#Web-页面请求过程" class="headerlink" title="Web 页面请求过程"></a>Web 页面请求过程</h2><ol><li><p>向 DNS 服务器发送 DNS 查询报文来解析域名。</p></li><li><p>开始进行 HTTP 会话，需要先建立 TCP 连接。</p></li><li><p>在运输层的传输过程中，HTTP 报文被封装进 TCP 中。HTTP 请求报文使用端口号 80，因为服务器监听的是 80 端口。连接建立之后，服务器会随机分配一个端口号给特定的客户端，之后的 TCP 传输都是用这个分配的端口号。</p></li><li><p>在网络层的传输过程中，TCP 报文段会被封装进 IP 分组中，IP 分组经过路由选择，最后到达目的地。</p></li><li><p>在链路层，IP 分组会被封装进 MAC 帧中，IP 地址解析成 MAC 地址需要使用 ARP。</p></li><li><p>客户端发送 HTTP 请求报文，请求获取页面。</p></li><li><p>服务器发送 HTTP 相应报文，客户端从而获取该页面。</p></li><li><p>浏览器得到页面内容之后，解析并渲染，向用户展示页面。</p></li></ol><h2 id="常用端口"><a href="#常用端口" class="headerlink" title="常用端口"></a>常用端口</h2><table><thead><tr><th>应用层协议</th><th>端口号</th><th>运输层协议</th></tr></thead><tbody><tr><td>DNS</td><td>53</td><td>UDP</td></tr><tr><td>FTP</td><td>控制连接 21，数据连接 20</td><td>TCP</td></tr><tr><td>TELNET</td><td>23</td><td>TCP</td></tr><tr><td>DHCP</td><td>67 68</td><td>UDP</td></tr><tr><td>HTTP</td><td>80</td><td>TCP</td></tr><tr><td>SMTP</td><td>25</td><td>TCP</td></tr><tr><td>POP3</td><td>110</td><td>TCP</td></tr><tr><td>IMAP</td><td>143</td><td>TCP</td></tr></tbody></table><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li>计算机网络 第七版</li><li>计算机网络 自顶向下方法</li></ul><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- GFM-TOC --&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#第一章-概述&quot;&gt;第一章 概述&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#网络的网络&quot;&gt;网络的网络&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#isp&quot;&gt;ISP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#互联网的组成&quot;&gt;互联网的组成&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#主机之间的通信方式&quot;&gt;主机之间的通信方式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#电路交换与分组交换&quot;&gt;电路交换与分组交换&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-电路交换&quot;&gt;1. 电路交换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-报文交换&quot;&gt;2. 报文交换&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-分组交换&quot;&gt;3. 分组交换&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#时延&quot;&gt;时延&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-发送时延&quot;&gt;1. 发送时延&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-传播时延&quot;&gt;2. 传播时延&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-处理时延&quot;&gt;3. 处理时延&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-排队时延&quot;&gt;4. 排队时延&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#计算机网络体系结构&quot;&gt;计算机网络体系结构*&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-七层协议&quot;&gt;1. 七层协议&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-五层协议&quot;&gt;2. 五层协议&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-数据在各层之间的传递过程&quot;&gt;3. 数据在各层之间的传递过程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-tcpip-体系结构&quot;&gt;4. TCP/IP 体系结构&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第二章-物理层&quot;&gt;第二章 物理层&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#通信方式&quot;&gt;通信方式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#带通调制&quot;&gt;带通调制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#信道复用技术&quot;&gt;信道复用技术&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-频分复用时分复用&quot;&gt;1. 频分复用、时分复用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-统计时分复用&quot;&gt;2. 统计时分复用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-波分复用&quot;&gt;3. 波分复用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#4-码分复用&quot;&gt;4. 码分复用&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第三章-数据链路层&quot;&gt;第三章 数据链路层&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#三个基本问题&quot;&gt;三个基本问题&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-封装成帧&quot;&gt;1. 封装成帧&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-透明传输&quot;&gt;2. 透明传输&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-差错检测&quot;&gt;3. 差错检测&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#点对点信道---ppp-协议&quot;&gt;点对点信道 - PPP 协议&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#局域网的拓扑&quot;&gt;局域网的拓扑&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#广播信道---csmacd-协议&quot;&gt;广播信道 - CSMA/CD 协议*&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#集线器&quot;&gt;集线器&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#mac-层&quot;&gt;MAC 层*&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#虚拟局域网&quot;&gt;虚拟局域网&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第四章-网络层&quot;&gt;第四章 网络层*&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#网际协议-ip-概述&quot;&gt;网际协议 IP 概述&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ip-数据报格式&quot;&gt;IP 数据报格式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ip-地址编址&quot;&gt;IP 地址编址&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-分类&quot;&gt;1. 分类&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-子网划分&quot;&gt;2. 子网划分&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-无分类&quot;&gt;3. 无分类&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ip-地址和-mac-地址&quot;&gt;IP 地址和 MAC 地址&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#地址解析协议-arp&quot;&gt;地址解析协议 ARP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#路由器的结构&quot;&gt;路由器的结构&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#交换机与路由器的区别&quot;&gt;交换机与路由器的区别&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#路由器分组转发流程&quot;&gt;路由器分组转发流程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#路由选择协议&quot;&gt;路由选择协议&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-内部网关协议-rip&quot;&gt;1. 内部网关协议 RIP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-内部网关协议-ospf&quot;&gt;2. 内部网关协议 OSPF&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#3-外部网关协议-bgp&quot;&gt;3. 外部网关协议 BGP&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#网际控制报文协议-icmp&quot;&gt;网际控制报文协议 ICMP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#分组网间探测-ping&quot;&gt;分组网间探测 PING&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#ip-多播&quot;&gt;IP 多播&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#虚拟专用网-vpn&quot;&gt;虚拟专用网 VPN&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#网络地址转换-nat&quot;&gt;网络地址转换 NAT&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第五章-运输层&quot;&gt;第五章 运输层*&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#udp-和-tcp-的特点&quot;&gt;UDP 和 TCP 的特点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#udp-首部格式&quot;&gt;UDP 首部格式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#tcp-首部格式&quot;&gt;TCP 首部格式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#tcp-的三次握手&quot;&gt;TCP 的三次握手&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#tcp-的四次挥手&quot;&gt;TCP 的四次挥手&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#tcp-滑动窗口&quot;&gt;TCP 滑动窗口&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#tcp-可靠传输&quot;&gt;TCP 可靠传输&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#tcp-流量控制&quot;&gt;TCP 流量控制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#tcp-拥塞控制&quot;&gt;TCP 拥塞控制&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#慢开始与拥塞避免&quot;&gt;慢开始与拥塞避免&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#快重传与快恢复&quot;&gt;快重传与快恢复&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#第六章-应用层&quot;&gt;第六章 应用层*&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#域名系统-dns&quot;&gt;域名系统 DNS&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#1-层次结构&quot;&gt;1. 层次结构&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#2-解析过程&quot;&gt;2. 解析过程&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#文件传输协议-ftp&quot;&gt;文件传输协议 FTP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#远程终端协议-telnet&quot;&gt;远程终端协议 TELNET&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#万维网-www&quot;&gt;万维网 WWW&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#电子邮件协议&quot;&gt;电子邮件协议&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#pop3&quot;&gt;POP3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#imap&quot;&gt;IMAP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#smtp&quot;&gt;SMTP&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#动态主机配置协议-dhcp&quot;&gt;动态主机配置协议 DHCP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#点对点传输-p2p&quot;&gt;点对点传输 P2P&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#web-页面请求过程&quot;&gt;Web 页面请求过程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#常用端口&quot;&gt;常用端口&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#参考资料&quot;&gt;参考资料&lt;/a&gt;&lt;!-- GFM-TOC --&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;第一章-概述&quot;&gt;&lt;a href=&quot;#第一章-概述&quot; class=&quot;headerlink&quot; title=&quot;第一章 概述&quot;&gt;&lt;/a&gt;第一章 概述&lt;/h1&gt;&lt;h2 id=&quot;网络的网络&quot;&gt;&lt;a href=&quot;#网络的网络&quot; class=&quot;headerlink&quot; title=&quot;网络的网络&quot;&gt;&lt;/a&gt;网络的网络&lt;/h2&gt;&lt;p&gt;网络把主机连接起来，而互联网是把多种不同的网络连接起来，因此互联网是网络的网络。&lt;/p&gt;
&lt;p&gt;&lt;br&gt;&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;../pics/f1fb826b-ecf4-4ddb-91f0-2bafecf08869.jpg&quot;&gt; &lt;/div&gt;&lt;br&gt;&lt;/p&gt;
&lt;h2 id=&quot;ISP&quot;&gt;&lt;a href=&quot;#ISP&quot; class=&quot;headerlink&quot; title=&quot;ISP&quot;&gt;&lt;/a&gt;ISP&lt;/h2&gt;&lt;p&gt;互联网服务提供商 ISP 可以从互联网管理机构获得许多 IP 地址，同时拥有通信线路以及路由器等联网设备，个人或机构向 ISP 缴纳一定的费用就可以接入互联网。&lt;/p&gt;
&lt;p&gt;目前的互联网是一种多层次 ISP 结构，ISP 根据覆盖面积的大小分为主干 ISP、地区 ISP 和本地 ISP。&lt;/p&gt;
&lt;p&gt;互联网交换点 IXP 允许两个 ISP 直接相连而不用经过第三个 ISP。&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>interview</title>
    <link href="https://jiangshaobo.cn/20180311/Interview/README.html"/>
    <id>https://jiangshaobo.cn/20180311/Interview/README.html</id>
    <published>2018-03-11T03:18:00.000Z</published>
    <updated>2018-03-11T04:32:12.945Z</updated>
    
    <content type="html"><![CDATA[<!-- <br><div align="center">     <img src="https://github.com/CyC2018/InterviewNotes/blob/master/pics/handbook.png" alt="" width="225"/>    <img src="https://img.shields.io/badge/update-today-blue.svg"/> <img src="https://img.shields.io/badge/gitbook-making-yellow.svg"/></div><br> --><!-- <img src="https://github.com/CyC2018/InterviewNotes/blob/master/pics/handbook.png" alt="" width="225"/> --><!-- ![](https://img.shields.io/badge/update-today-blue.svg) ![](https://img.shields.io/badge/gitbook-making-yellow.svg) --><!-- ![](https://img.shields.io/badge/gitbook-making-green.svg) ![](https://img.shields.io/badge/update-today-blue.svg)  --><p><img src="https://img.shields.io/badge/update-today-blue.svg" alt=""> <img src="https://img.shields.io/badge/gitbook-making-lightgrey.svg" alt=""> </p><h2 id="网络-cloud"><a href="#网络-cloud" class="headerlink" title="网络 :cloud:"></a>网络 :cloud:</h2><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/计算机网络.md" target="_blank" rel="noopener">计算机网络</a></p></blockquote><p>整理自《计算机网络 第七版》，重点内容会在标题后面加 *。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/HTTP.md" target="_blank" rel="noopener">HTTP</a></p></blockquote><p>整理自《图解 HTTP》</p><h2 id="操作系统-computer"><a href="#操作系统-computer" class="headerlink" title="操作系统 :computer:"></a>操作系统 :computer:</h2><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/计算机操作系统.md" target="_blank" rel="noopener">计算机操作系统</a></p></blockquote><p>整理自《现代操作系统》和《计算机操作系统》</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/Linux.md" target="_blank" rel="noopener">Linux</a></p></blockquote><p>整理自《鸟哥的 Linux 私房菜》</p><a id="more"></a><h2 id="数据结构与算法-pencil2"><a href="#数据结构与算法-pencil2" class="headerlink" title="数据结构与算法 :pencil2:"></a>数据结构与算法 :pencil2:</h2><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/算法.md" target="_blank" rel="noopener">算法</a></p></blockquote><p>整理自《算法 第四版》，主要整理了面试常问的排序和查找算法。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/剑指%20offer%20题解.md" target="_blank" rel="noopener">剑指 Offer 题解</a></p></blockquote><p>《剑指 Offer 第二版》的最优解，在牛客网在线编程中出现的题目都已 AC。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/Leetcode%20题解.md" target="_blank" rel="noopener">Leetcode 题解</a></p></blockquote><p>对题目做了一个分类，并对每种题型的解题思路做了总结。已经整理了 300+ 的题目，基本涵盖所有经典题目。</p><h2 id="面向对象-couple"><a href="#面向对象-couple" class="headerlink" title="面向对象 :couple:"></a>面向对象 :couple:</h2><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/设计模式.md" target="_blank" rel="noopener">设计模式</a></p></blockquote><p>整理自《Head First 设计模式》</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/面向对象思想.md" target="_blank" rel="noopener">面向对象思想</a></p></blockquote><p>一些面向对象思想和原则。</p><h2 id="数据库-floppy-disk"><a href="#数据库-floppy-disk" class="headerlink" title="数据库 :floppy_disk:"></a>数据库 :floppy_disk:</h2><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/SQL%20语法.md" target="_blank" rel="noopener">SQL 语法</a></p></blockquote><p>整理自《SQL 必知必会》</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/MySQL.md" target="_blank" rel="noopener">MySQL</a></p></blockquote><p>整理自《高性能 MySQL》，整理了一些重点内容。</p><h2 id="Java-coffee"><a href="#Java-coffee" class="headerlink" title="Java :coffee:"></a>Java :coffee:</h2><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/JVM.md" target="_blank" rel="noopener">JVM</a></p></blockquote><p>整理自《深入理解 Java 虚拟机》，主要整理了内存模型、垃圾回收以及类加载机制。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/Java%20并发.md" target="_blank" rel="noopener">Java 并发</a></p></blockquote><p>只整理了一些比较基础的概念，之后会继续添加更多内容。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/Java%20容器.md" target="_blank" rel="noopener">Java 容器</a></p></blockquote><p>容器的一些总结，包含容器源码的分析。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/Java%20IO.md" target="_blank" rel="noopener">Java IO</a></p></blockquote><p>File、InputStream OutputStream、Reader Writer、Serializable、Socket、NIO</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/Java%20基础.md" target="_blank" rel="noopener">Java 基础</a></p></blockquote><p>整理了一些常见考点。</p><h2 id="编码实践-hammer"><a href="#编码实践-hammer" class="headerlink" title="编码实践 :hammer:"></a>编码实践 :hammer:</h2><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/重构.md" target="_blank" rel="noopener">重构</a></p></blockquote><p>重构是对软件内部结构的一种调整，目的是在不改变软件可观察行为的前提下，提高其可理解性，降低其修改成本。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/代码可读性.md" target="_blank" rel="noopener">代码可读性</a></p></blockquote><p>编程有很大一部分时间是在阅读代码，可读性良好的代码能够大大提高编程效率。</p><blockquote><p><a href="https://github.com/CyC2018/InnterviewNotes/blob/master/notes/代码风格规范.md" target="_blank" rel="noopener">代码风格规范</a></p></blockquote><p>Google 开源项目的代码风格规范。</p><h2 id="资料下载-arrow-down"><a href="#资料下载-arrow-down" class="headerlink" title="资料下载 :arrow_down:"></a>资料下载 :arrow_down:</h2><blockquote><p><a href="https://pan.baidu.com/s/1o9oD1s2#list/path=%2F" target="_blank" rel="noopener">百度网盘</a></p></blockquote><p>一些 PDF 书籍</p><h2 id="后记-memo"><a href="#后记-memo" class="headerlink" title="后记 :memo:"></a>后记 :memo:</h2><p>网上有很多相关的资料，但是这些资料都比较零散。本仓库的笔记是从经典的书籍和材料中整理而来，在整理出重点的同时会尽可能保证知识的系统性，因此比较适合作为应对面试的学习资料。</p><p>笔记内容按照 <a href="http://mazhuang.org/wiki/chinese-copywriting-guidelines/#%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%9C%B0%E9%81%93%E7%9A%84%E7%BC%A9%E5%86%99" target="_blank" rel="noopener">中文文案排版指北</a> 进行排版，以保证内容的可读性。这里提供了本人实现的 Markdown 排版工具的下载：<a href="https://github.com/CyC2018/Markdown-Typesetting" target="_blank" rel="noopener">Markdown-Typesetting</a>。</p><p>由于 Github 使用的 GFM 不支持 MathJax 公式，也不支持 TOC 标记，为了把本地的 Markdown 文档转换为 GFM 支持的格式，需要替换 MathJax 公式为 CodeCogs 的云服务和重新生成 TOC 目录。并且为了让图片显示效果更好，笔记内容基本使用了 &lt;center&gt; 标记来让图片居中显示，但是 GFM 却不支持 &lt;center&gt; 标记，因此也需要进行一定的转换。这里提供了本人实现的 GFM 文档转换工具的下载：<a href="https://github.com/CyC2018/GFM-Converter" target="_blank" rel="noopener">GFM-Converter</a>。</p><p>因为大部分内容是一个字一个字打上去的，难免会有一些笔误，如果发现，可以直接在相应的文档上编辑修改。</p><p>想要发表反馈意见的话，可以到 <a href="https://www.nowcoder.com/discuss/66985" target="_blank" rel="noopener">原贴</a> 的评论区进行留言。</p><hr><p>本来来自 <a href="https://github.com/CyC2018/Interview-Notebook/" target="_blank" rel="noopener">Interview-Notebook</a></p><p><a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png"></a></p><p>本作品采用 <a rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a> 进行许可。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- &lt;br&gt;
&lt;div align=&quot;center&quot;&gt; 
    &lt;img src=&quot;https://github.com/CyC2018/InterviewNotes/blob/master/pics/handbook.png&quot; alt=&quot;&quot; width=&quot;225&quot;/&gt;
    &lt;img src=&quot;https://img.shields.io/badge/update-today-blue.svg&quot;/&gt; &lt;img src=&quot;https://img.shields.io/badge/gitbook-making-yellow.svg&quot;/&gt;
&lt;/div&gt;
&lt;br&gt; --&gt;
&lt;!-- &lt;img src=&quot;https://github.com/CyC2018/InterviewNotes/blob/master/pics/handbook.png&quot; alt=&quot;&quot; width=&quot;225&quot;/&gt; --&gt;
&lt;!-- ![](https://img.shields.io/badge/update-today-blue.svg) ![](https://img.shields.io/badge/gitbook-making-yellow.svg) --&gt;
&lt;!-- ![](https://img.shields.io/badge/gitbook-making-green.svg) ![](https://img.shields.io/badge/update-today-blue.svg)  --&gt;
&lt;p&gt;&lt;img src=&quot;https://img.shields.io/badge/update-today-blue.svg&quot; alt=&quot;&quot;&gt; &lt;img src=&quot;https://img.shields.io/badge/gitbook-making-lightgrey.svg&quot; alt=&quot;&quot;&gt; &lt;/p&gt;
&lt;h2 id=&quot;网络-cloud&quot;&gt;&lt;a href=&quot;#网络-cloud&quot; class=&quot;headerlink&quot; title=&quot;网络 :cloud:&quot;&gt;&lt;/a&gt;网络 :cloud:&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/CyC2018/InnterviewNotes/blob/master/notes/计算机网络.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;计算机网络&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;整理自《计算机网络 第七版》，重点内容会在标题后面加 *。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/CyC2018/InnterviewNotes/blob/master/notes/HTTP.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;HTTP&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;整理自《图解 HTTP》&lt;/p&gt;
&lt;h2 id=&quot;操作系统-computer&quot;&gt;&lt;a href=&quot;#操作系统-computer&quot; class=&quot;headerlink&quot; title=&quot;操作系统 :computer:&quot;&gt;&lt;/a&gt;操作系统 :computer:&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/CyC2018/InnterviewNotes/blob/master/notes/计算机操作系统.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;计算机操作系统&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;整理自《现代操作系统》和《计算机操作系统》&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/CyC2018/InnterviewNotes/blob/master/notes/Linux.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Linux&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;整理自《鸟哥的 Linux 私房菜》&lt;/p&gt;
    
    </summary>
    
      <category term="interview" scheme="https://jiangshaobo.cn/categories/interview/"/>
    
    
      <category term="interview" scheme="https://jiangshaobo.cn/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>springboot应用war包部署tomcat</title>
    <link href="https://jiangshaobo.cn/20180301/springboot%E5%BA%94%E7%94%A8war%E5%8C%85%E9%83%A8%E7%BD%B2tomcat.html"/>
    <id>https://jiangshaobo.cn/20180301/springboot应用war包部署tomcat.html</id>
    <published>2018-03-01T15:46:57.000Z</published>
    <updated>2018-03-01T16:00:24.326Z</updated>
    
    <content type="html"><![CDATA[<p>又要使用springboot，又得用tomcat部署。<br>还不如只用传统的。<br>springboot默认打包成jar包。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn <span class="class"><span class="keyword">package</span></span></span><br></pre></td></tr></table></figure></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[INFO]</span> <span class="meta">---</span> <span class="attr">maven-jar-plugin:2.6:jar</span> <span class="string">(default-jar)</span> <span class="string">@</span> <span class="string">xpay</span> <span class="meta">---</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="string">Building</span> <span class="attr">jar:</span> <span class="string">/media/abel/Dev/java_src/springbootdemo/target/springbootdemo-1.0-SNAPSHOT.jar</span></span><br><span class="line"><span class="string">[INFO]</span> </span><br><span class="line"><span class="string">[INFO]</span> <span class="meta">---</span> <span class="attr">spring-boot-maven-plugin:1.5.9.RELEASE:repackage</span> <span class="string">(default)</span> <span class="string">@</span> <span class="string">xpay</span> <span class="meta">---</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="bullet">------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="string">BUILD</span> <span class="string">SUCCESS</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="bullet">------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="string">Total</span> <span class="attr">time:</span> <span class="number">4.679</span> <span class="string">s</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="string">Finished</span> <span class="attr">at:</span> <span class="number">2018</span><span class="bullet">-03</span><span class="bullet">-01</span><span class="attr">T23:27:10+08:00</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="string">Final</span> <span class="attr">Memory:</span> <span class="number">28</span><span class="string">M/343M</span></span><br><span class="line"><span class="string">[INFO]</span> <span class="bullet">------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>开始尝试直接打包成war包，发现路径什么的不对，在tomcat无法运行。<br>springboot使用外部tomcat需要如下：</p><p>1.更改pom.xml打包成war。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.jiangshaobo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springbootdemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2、添加maven的war打包插件如下：并且给war包起一个名字，tomcat部署后的访问路径会需要，如：http:localhost:8080/myweb/<em>**</em></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span>       </span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>       </span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>       </span><br><span class="line">   <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>       </span><br><span class="line">    <span class="tag">&lt;<span class="name">warSourceExcludes</span>&gt;</span>src/main/resources/**<span class="tag">&lt;/<span class="name">warSourceExcludes</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">warName</span>&gt;</span>myweb<span class="tag">&lt;/<span class="name">warName</span>&gt;</span>       </span><br><span class="line">   <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>       </span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3、排除org.springframework.boot依赖中的tomcat内置容器，这是很重要的一步<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>4、添加对servlet API的依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;又要使用springboot，又得用tomcat部署。&lt;br&gt;还不如只用传统的。&lt;br&gt;springboot默认打包成jar包。&lt;br&gt;&lt;figure class=&quot;highlight actionscript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mvn &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;maven-jar-plugin:2.6:jar&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;(default-jar)&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;@&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;xpay&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Building&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;jar:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/media/abel/Dev/java_src/springbootdemo/target/springbootdemo-1.0-SNAPSHOT.jar&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;spring-boot-maven-plugin:1.5.9.RELEASE:repackage&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;(default)&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;@&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;xpay&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;bullet&quot;&gt;------------------------------------------------------------------------&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;BUILD&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;SUCCESS&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;bullet&quot;&gt;------------------------------------------------------------------------&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Total&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;time:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;4.679&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Finished&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;at:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2018&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-03&lt;/span&gt;&lt;span class=&quot;bullet&quot;&gt;-01&lt;/span&gt;&lt;span class=&quot;attr&quot;&gt;T23:27:10+08:00&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;Final&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;Memory:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;28&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;M/343M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;[INFO]&lt;/span&gt; &lt;span class=&quot;bullet&quot;&gt;------------------------------------------------------------------------&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="springboot" scheme="https://jiangshaobo.cn/tags/springboot/"/>
    
  </entry>
  
  <entry>
    <title>express基础教程</title>
    <link href="https://jiangshaobo.cn/20180223/express%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B.html"/>
    <id>https://jiangshaobo.cn/20180223/express基础教程.html</id>
    <published>2018-02-23T08:39:24.000Z</published>
    <updated>2018-02-23T09:15:26.732Z</updated>
    
    <content type="html"><![CDATA[<h5 id="express官网"><a href="#express官网" class="headerlink" title="express官网"></a>express官网</h5><p><a href="http://expressjs.com/" target="_blank" rel="noopener">http://expressjs.com/</a><br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install <span class="built_in">express</span> --<span class="built_in">save</span></span><br></pre></td></tr></table></figure></p><p>全局安装<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> express -g</span><br></pre></td></tr></table></figure></p><p>github地址<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/expressjs/</span>express</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>官方demo<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'Hello World'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure></p><p>用npm初始化一个项目。<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">npm</span> init</span><br></pre></td></tr></table></figure></p><p>安装express<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install <span class="built_in">express</span> --<span class="built_in">save</span></span><br></pre></td></tr></table></figure></p><p>新建server.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.send(<span class="string">'1111'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'listen 3000'</span>);</span><br></pre></td></tr></table></figure></p><p>安装nodemon<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="selector-tag">i</span> nodemon -g</span><br></pre></td></tr></table></figure></p><p>运行<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodemon <span class="keyword">server</span></span><br></pre></td></tr></table></figure></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nodemon server</span><br><span class="line">[nodemon] 1.14.12</span><br><span class="line">[nodemon] <span class="keyword">to</span> restart at any time, enter `rs`</span><br><span class="line">[nodemon] watching: *.*</span><br><span class="line">[nodemon] starting `node server.js`</span><br><span class="line">listen 3000</span><br></pre></td></tr></table></figure><p>访问<code>localhost:3000</code>可以看到页面显示1111</p><p>express官方API<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>expressjs.com<span class="regexp">/en/</span><span class="number">4</span>x<span class="regexp">/api.html</span></span><br></pre></td></tr></table></figure></p><p>查看右侧菜单栏，点击Request查看<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/user/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(req, res)</span> </span>&#123;</span><br><span class="line">  res.send(<span class="string">'user '</span> + req.params.id);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>或者<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/user/:id'</span>, <span class="function"><span class="keyword">function</span><span class="params">(request, response)</span> </span>&#123;</span><br><span class="line">  response.send(<span class="string">'user '</span> + request.params.id);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>访问<code>http://localhost:3000/user/1</code>页面显示<code>user 1</code></p>]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;express官网&quot;&gt;&lt;a href=&quot;#express官网&quot; class=&quot;headerlink&quot; title=&quot;express官网&quot;&gt;&lt;/a&gt;express官网&lt;/h5&gt;&lt;p&gt;&lt;a href=&quot;http://expressjs.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://expressjs.com/&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight maxima&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm install &lt;span class=&quot;built_in&quot;&gt;express&lt;/span&gt; --&lt;span class=&quot;built_in&quot;&gt;save&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;全局安装&lt;br&gt;&lt;figure class=&quot;highlight cmake&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;npm &lt;span class=&quot;keyword&quot;&gt;install&lt;/span&gt; express -g&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;github地址&lt;br&gt;&lt;figure class=&quot;highlight awk&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;https:&lt;span class=&quot;regexp&quot;&gt;//gi&lt;/span&gt;thub.com&lt;span class=&quot;regexp&quot;&gt;/expressjs/&lt;/span&gt;express&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="express" scheme="https://jiangshaobo.cn/tags/express/"/>
    
  </entry>
  
  <entry>
    <title>Kafka运行环境的搭建</title>
    <link href="https://jiangshaobo.cn/20180208/Kafka%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA.html"/>
    <id>https://jiangshaobo.cn/20180208/Kafka运行环境的搭建.html</id>
    <published>2018-02-08T08:52:05.000Z</published>
    <updated>2018-02-12T12:57:20.166Z</updated>
    
    <content type="html"><![CDATA[<h5 id="准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。"><a href="#准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。" class="headerlink" title="准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。"></a>准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。</h5><p>Java环境还是比较容易配置的，目前系统是Win10.</p><p>先到官网下载JDK，这里下载的是JDK 1.8，下载后双击运行安装，选择路径。</p><p>桌面此电脑右键选择属性，打开高级系统设置，点击环境变量，在系统变量中新增变量名JAVA_HOME，变量值为 JDK 1.8 安装路径，也就是刚刚安装的路径。由于默认安装在 Program Files目录下，目录名之间有空格，有可能在运行某些应用时因JDK安装路径有空格而报错，这个有点坑。<br><a id="more"></a><br>再新增变量名 CLASSPATH，变量值为<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.;%JAVA_HOME%\<span class="class"><span class="keyword">lib</span>\<span class="title">dt</span>.<span class="title">jar</span>;</span>%JAVA_HOME%\<span class="class"><span class="keyword">lib</span>\<span class="title">tools</span>.<span class="title">jar</span></span></span><br></pre></td></tr></table></figure></p><p>最后的结果如下：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">系统变量JAVA_HOME<span class="symbol">C:</span>\Program Files\Java\jdk1.<span class="number">8.0_131</span></span><br><span class="line">用户变量CLASSPATH.;%JAVA_HOME%\<span class="class"><span class="keyword">lib</span>\<span class="title">dt</span>.<span class="title">jar</span>;</span>%JAVA_HOME%\<span class="class"><span class="keyword">lib</span>\<span class="title">tools</span>.<span class="title">jar</span></span></span><br><span class="line">新增PATH变量     PATH   %JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;</span><br></pre></td></tr></table></figure></p><p>设置好了后，重新打开一个终端，运行<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">version</span></span><br></pre></td></tr></table></figure></p><p>显示类似下面结果，说明JDK环境搭建成功。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java version <span class="string">"1.8.0_131"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_131-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit<span class="built_in"> Server </span>VM (build 25.131-b11, mixed mode)</span><br></pre></td></tr></table></figure></p><p>类似的有maven环境，tomcat环境，Java开发必备，当然也可以Docker。</p><p>还有Git环境。</p><p>第1步：创建SSH Key。在用户主目录下，看看有没有.ssh目录，如果有，再看看这个目录下有没有id_rsa和id_rsa.pub这两个文件，如果已经有了，可直接跳到下一步。如果没有，打开Shell（Windows下打开Git Bash），创建SSH Key：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ssh-keygen</span> <span class="selector-tag">-t</span> <span class="selector-tag">rsa</span> <span class="selector-tag">-C</span> "<span class="selector-tag">youremail</span>@<span class="keyword">example</span>.<span class="keyword">com</span>"</span><br></pre></td></tr></table></figure><p>你需要把邮件地址<a href="mailto:youremail@example.com" target="_blank" rel="noopener">youremail@example.com</a>换成你自己的邮件地址，然后一路回车，使用默认值即可，由于这个Key也不是用于军事目的，所以也无需设置密码。</p><p>如果一切顺利的话，可以在用户主目录里找到.ssh目录，里面有id_rsa和id_rsa.pub两个文件，这两个就是SSH Key的秘钥对，id_rsa是私钥，不能泄露出去，id_rsa.pub是公钥，可以放心地告诉任何人。</p>]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。&quot;&gt;&lt;a href=&quot;#准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。&quot; class=&quot;headerlink&quot; title=&quot;准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。&quot;&gt;&lt;/a&gt;准备学习下Kafka神器，Kafka是用Scala语言开发的，首先需要安装JDK环境。&lt;/h5&gt;&lt;p&gt;Java环境还是比较容易配置的，目前系统是Win10.&lt;/p&gt;
&lt;p&gt;先到官网下载JDK，这里下载的是JDK 1.8，下载后双击运行安装，选择路径。&lt;/p&gt;
&lt;p&gt;桌面此电脑右键选择属性，打开高级系统设置，点击环境变量，在系统变量中新增变量名JAVA_HOME，变量值为 JDK 1.8 安装路径，也就是刚刚安装的路径。由于默认安装在 Program Files目录下，目录名之间有空格，有可能在运行某些应用时因JDK安装路径有空格而报错，这个有点坑。&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hello World Hexo 命令笔记</title>
    <link href="https://jiangshaobo.cn/20180204/hello-world.html"/>
    <id>https://jiangshaobo.cn/20180204/hello-world.html</id>
    <published>2018-02-04T14:22:00.585Z</published>
    <updated>2018-02-04T14:22:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><a id="more"></a><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p><h4 id="Hexo简写"><a href="#Hexo简写" class="headerlink" title="Hexo简写"></a>Hexo简写</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hexo n <span class="string">"我的博客"</span> == hexo new <span class="string">"我的博客"</span> #新建文章</span><br><span class="line">hexo p == hexo publish</span><br><span class="line">hexo g == hexo generate#生成</span><br><span class="line">hexo s == hexo<span class="built_in"> server </span>#启动服务预览</span><br><span class="line">hexo d == hexo deploy#部署</span><br></pre></td></tr></table></figure><h4 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hexo<span class="built_in"> server </span>#Hexo 会监视文件变动并自动更新，您无须重启服务器。</span><br><span class="line">hexo<span class="built_in"> server </span>-s #静态模式</span><br><span class="line">hexo<span class="built_in"> server </span>-p 5000 #更改端口</span><br><span class="line">hexo<span class="built_in"> server </span>-i 192.168.1.1 #自定义 IP</span><br><span class="line"></span><br><span class="line">hexo clean #清除缓存 网页正常情况下可以忽略此条命令</span><br><span class="line">hexo g #生成静态网页</span><br><span class="line">hexo d #开始部署</span><br></pre></td></tr></table></figure><h4 id="监视文件变动"><a href="#监视文件变动" class="headerlink" title="监视文件变动"></a>监视文件变动</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">generate</span> #使用 Hexo 生成静态文件快速而且简单</span><br><span class="line">hexo <span class="keyword">generate</span> --watch #监视文件变动</span><br></pre></td></tr></table></figure><h4 id="完成后部署"><a href="#完成后部署" class="headerlink" title="完成后部署"></a>完成后部署</h4><p>两个命令的作用是相同的<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo generate --deploy</span><br><span class="line">hexo deploy --generate</span><br><span class="line">hexo deploy -g</span><br><span class="line">hexo<span class="built_in"> server </span>-g</span><br></pre></td></tr></table></figure></p><h4 id="草稿"><a href="#草稿" class="headerlink" title="草稿"></a>草稿</h4><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo publish <span class="string">[layout]</span> &lt;title&gt;</span><br></pre></td></tr></table></figure><h4 id="模版"><a href="#模版" class="headerlink" title="模版"></a>模版</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="string">"postName"</span> <span class="meta">#新建文章</span></span><br><span class="line">hexo <span class="keyword">new</span> page <span class="string">"pageName"</span> <span class="meta">#新建页面</span></span><br><span class="line">hexo generate <span class="meta">#生成静态页面至public目录</span></span><br><span class="line">hexo <span class="keyword">server</span> <span class="meta">#开启预览访问端口（默认端口4000，'ctrl + c'关闭server）</span></span><br><span class="line">hexo deploy <span class="meta">#将.deploy目录部署到GitHub</span></span><br><span class="line"></span><br><span class="line">hexo <span class="keyword">new</span> [layout] &lt;title&gt;</span><br><span class="line">hexo <span class="keyword">new</span> photo <span class="string">"My Gallery"</span></span><br><span class="line">hexo <span class="keyword">new</span> <span class="string">"Hello World"</span> --lang tw</span><br></pre></td></tr></table></figure><h4 id="变量-描述"><a href="#变量-描述" class="headerlink" title="变量    描述"></a>变量    描述</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">layout布局</span><br><span class="line">title标题</span><br><span class="line">date文件建立日期</span><br><span class="line">title: 使用Hexo搭建个人博客</span><br><span class="line">layout: post</span><br><span class="line">date: 2018<span class="string">-01</span><span class="string">-14</span> 23:18:00</span><br><span class="line">comments: true</span><br><span class="line">categories: Blog</span><br><span class="line"><span class="keyword">tags:</span> [Hexo]</span><br><span class="line">keywords: Hexo, Blog</span><br><span class="line">description: 生命在于折腾，又把博客折腾到Hexo了。给Hexo点赞。</span><br><span class="line">模版（Scaffold）</span><br><span class="line">hexo new photo "My Gallery"</span><br></pre></td></tr></table></figure><p>变量    描述<br>layout    布局<br>title    标题<br>date    文件建立日期<br>设置文章摘要<br>以上是文章摘要 <!--more--> 以下是余下全文<br>写作<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo new<span class="built_in"> page </span>&lt;title&gt;</span><br><span class="line">hexo new post &lt;title&gt;</span><br></pre></td></tr></table></figure></p><p>变量    描述<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:title</span>标题</span><br><span class="line"><span class="symbol">:year</span>建立的年份（<span class="number">4</span> 位数）</span><br><span class="line"><span class="symbol">:month</span>建立的月份（<span class="number">2</span> 位数）</span><br><span class="line"><span class="symbol">:i_month</span>建立的月份（去掉开头的零）</span><br><span class="line"><span class="symbol">:day</span>建立的日期（<span class="number">2</span> 位数）</span><br><span class="line"><span class="symbol">:i_day</span>建立的日期（去掉开头的零）</span><br><span class="line">推送到服务器上</span><br><span class="line">hexo n <span class="comment">#写文章</span></span><br><span class="line">hexo g <span class="comment">#生成</span></span><br><span class="line">hexo d <span class="comment">#部署 #可与hexo g合并为 hexo d -g</span></span><br></pre></td></tr></table></figure></p><p>报错<br>1.找不到git部署<br>ERROR Deployer not found: git<br>解决方法<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> hexo-deployer-git <span class="comment">--save</span></span><br></pre></td></tr></table></figure></p><p>3.部署类型设置git<br>hexo 3.0 部署类型不再是github，_config.yml 中修改<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># Deployment</span></span><br><span class="line"><span class="meta">## Docs: http:<span class="comment">//hexo.io/docs/deployment.html</span></span></span><br><span class="line"><span class="symbol">deploy:</span></span><br><span class="line"><span class="symbol">  type:</span> git</span><br><span class="line"><span class="symbol">  repository:</span> git@***.github.com:***<span class="comment">/***.github.io.git</span></span><br><span class="line"><span class="comment">  branch: master</span></span><br></pre></td></tr></table></figure></p><ol><li><p>xcodebuild<br>xcode-select: error: tool ‘xcodebuild’ requires Xcode, but active developer directory ‘/Library/Developer/CommandLineTools’ is a command line tools instance</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> bcrypt</span><br></pre></td></tr></table></figure></li><li><p>RSS不显示<br>安装RSS插件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> hexo-generator-feed <span class="comment">--save</span></span><br></pre></td></tr></table></figure></li></ol><p>开启RSS功能</p><p>编辑hexo/_config.yml，添加如下代码：</p><p>rss: /atom.xml #rss地址  默认即可</p><h5 id="添加站点地图"><a href="#添加站点地图" class="headerlink" title="添加站点地图"></a>添加站点地图</h5><p>站点地图是一种文件，您可以通过该文件列出您网站上的网页，从而将您网站内容的组织架构告知Google和其他搜索引擎。Googlebot等搜索引擎网页抓取工具会读取此文件，以便更加智能地抓取您的网站</p><h5 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h5><p>打开hexo目录下的dos命令行，分别安装百度和google插件<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> hexo-generator-sitemap <span class="comment">--save</span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-baidu-sitemap <span class="comment">--save</span></span><br></pre></td></tr></table></figure></p><h5 id="在博客目录的-config-yml中添加如下代码"><a href="#在博客目录的-config-yml中添加如下代码" class="headerlink" title="在博客目录的_config.yml中添加如下代码"></a>在博客目录的_config.yml中添加如下代码</h5><h5 id="自动生成sitemap"><a href="#自动生成sitemap" class="headerlink" title="自动生成sitemap"></a>自动生成sitemap</h5><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">sitemap:</span></span><br><span class="line"><span class="symbol">path:</span> sitemap.xml</span><br><span class="line"><span class="symbol">baidusitemap:</span></span><br><span class="line"><span class="symbol">path:</span> baidusitemap.xml</span><br></pre></td></tr></table></figure><h5 id="编译你的博客"><a href="#编译你的博客" class="headerlink" title="编译你的博客"></a>编译你的博客</h5>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;Quick-Start&quot;&gt;&lt;a href=&quot;#Quick-Start&quot; class=&quot;headerlink&quot; title=&quot;Quick Start&quot;&gt;&lt;/a&gt;Quick Start&lt;/h2&gt;&lt;h3 id=&quot;Create-a-new-post&quot;&gt;&lt;a href=&quot;#Create-a-new-post&quot; class=&quot;headerlink&quot; title=&quot;Create a new post&quot;&gt;&lt;/a&gt;Create a new post&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hexo new &lt;span class=&quot;string&quot;&gt;&quot;My New Post&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;More info: &lt;a href=&quot;https://hexo.io/docs/writing.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Writing&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;Run-server&quot;&gt;&lt;a href=&quot;#Run-server&quot; class=&quot;headerlink&quot; title=&quot;Run server&quot;&gt;&lt;/a&gt;Run server&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hexo server&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;More info: &lt;a href=&quot;https://hexo.io/docs/server.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Server&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="hexo" scheme="https://jiangshaobo.cn/tags/hexo/"/>
    
      <category term="hexo g" scheme="https://jiangshaobo.cn/tags/hexo-g/"/>
    
      <category term="hexo d" scheme="https://jiangshaobo.cn/tags/hexo-d/"/>
    
      <category term="hexo s" scheme="https://jiangshaobo.cn/tags/hexo-s/"/>
    
      <category term="hexo p" scheme="https://jiangshaobo.cn/tags/hexo-p/"/>
    
      <category term="hexo n" scheme="https://jiangshaobo.cn/tags/hexo-n/"/>
    
  </entry>
  
  <entry>
    <title>如何安装 Ruby</title>
    <link href="https://jiangshaobo.cn/20180204/%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85-Ruby.html"/>
    <id>https://jiangshaobo.cn/20180204/如何安装-Ruby.html</id>
    <published>2018-02-04T13:59:29.000Z</published>
    <updated>2018-02-04T14:22:38.568Z</updated>
    
    <content type="html"><![CDATA[<p>安装 Ruby<br>可以使用多种工具安装 Ruby。本页介绍如何使用主流的包管理系统和第三方工具管理和安装 Ruby，以及如何通过源码编译安装。</p><p>选择安装方式<br>安装 Ruby 的方式有多种：</p><p>如果使用的是类 UNIX 操作系统，使用系统的包管理器是最简单的安装方式。但是，包管理器中的 Ruby 版本通常都不是最新的。<br>安装工具能够安装指定的一个或多个 Ruby 版本。有针对 Windows 的安装包。<br>管理工具能帮助你在系统中安装的多个 Ruby 版本之间切换。<br>最后，也可以通过源码编译安装 Ruby。<br>下面概述针对不同需求和不同平台的安装方式。</p><a id="more"></a><p>包管理系统<br>Debian, Ubuntu<br>CentOS, Fedora, RHEL<br>Gentoo<br>Arch Linux<br>OS X<br>Solaris, OpenIndiana<br>其他发行版<br>安装工具<br>ruby-build<br>ruby-install<br>RubyInstaller (Windows)<br>RailsInstaller 和 Ruby Stack<br>管理工具<br>chruby<br>rbenv<br>RVM<br>uru<br>通过源码编译安装<br>包管理系统<br>如果不能自己编译 Ruby，也不想使用第三方工具，可以使用系统中的包管理器安装 Ruby。</p><p>许多 Ruby 社区的成员强烈建议，应该使用第三方工具来安装 Ruby，不要用系统的包管理器。详细的优缺点超出了本页的讨论范畴，基本原因是大多数系统包管理器里的 Ruby 版本比较老。如果想使用最新的 Ruby 版本，要确保包的名称正确，或者使用后面列出的工具。</p><p>apt（Debian 或 Ubuntu）<br>Debian GNU/Linux 和 Ubuntu 使用 apt 包管理器。用法如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-<span class="builtin-name">get</span> install ruby-full</span><br></pre></td></tr></table></figure></p><p>撰写本文时，在 Debian 和 Ubuntu 下，ruby-full 包提供的是老旧的 Ruby 2.3.1。</p><p>yum（CentOS、Fedora 或 RHEL）<br>CentOS、Fedora 和 RHEL 使用 yum 包管理器。用法如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install ruby</span></span><br></pre></td></tr></table></figure><p>安装的 Ruby 版本通常是发行版发行日能打包的最新版。</p><p>portage（Gentoo）<br>Gentoo 使用 portage 包管理器。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo emerge dev-lang/ruby</span></span><br></pre></td></tr></table></figure></p><p>一般来说，这将安装 1.9 和 2.0 版本，不过还有更多版本可供安装。如果想安装指定的版本，要在 make.conf 文件中设置 RUBY_TARGETS。详见 Gentoo Ruby Project 网站。</p><p>pacman（Arch Linux）<br>Arch Linux 使用 pacman 包管理器。要安装 Ruby，只需要执行下述命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo pacman -S ruby</span></span><br></pre></td></tr></table></figure></p><p>这将安装最新的 Ruby 稳定版。</p><p>Homebrew（OS X）<br>OS X El Capitan、Yosemite 和 Mavericks 内置了 Ruby 2.0。OS X Mountain Lion、Lion 和 Snow Leopard 内置了 Ruby 1.8.7。</p><p>许多 OS X 用户使用 Homebrew 作为包管理器。用 Homebrew 能够非常简单地获取到最新版的 Ruby：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">brew </span><span class="keyword">install </span>ruby</span><br></pre></td></tr></table></figure></p><p>这将安装最新版的 Ruby。</p><p>Solaris 和 OpenIndiana<br>Sunfreeware 上的 Solaris 8 到 10 内置了 Ruby 1.8.7，Blastwave 同样如此。Ruby 1.9.2p0 在 Sunfreeware 上也有，但是这一版已经过时。</p><p>若想在 OpenIndiana 上安装 Ruby，要使用 Image Packaging System (IPS) 客户端。这将直接从 OpenSolaris 代码库安装 Ruby 1.9 和 RubyGems：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pkg install runtime/ruby-18</span></span><br></pre></td></tr></table></figure></p><p>然而，第三方工具或许是获取最新版 Ruby 更好的方法。</p><p>其它发行版<br>在其它操作系统中，可以使用包管理器在包仓库中搜索 Ruby，或许使用第三方工具是更好的选择。</p><p>安装工具<br>如果系统或者包管理器提供的 Ruby 版本已经过时，可以使用第三方安装工具来安装更新的版本。其中许多工具允许在同一个系统中安装多个 Ruby 版本，相关的工具能帮你在不同的版本之间切换。如果打算用 RVM 作为版本管理工具，不需要其它的安装工具，它自己就具有这些功能。</p><p>ruby-build<br>ruby-build 是 rbenv 的一个插件，能在任意目录中编译和安装不同版本的 Ruby。ruby-build 也可以不依赖 rbenv 而单独使用。支持的平台有 OS X、Linux 和其它类 UNIX 操作系统。</p><p>ruby-install<br>ruby-install 能在任意目录中编译和安装不同版本的 Ruby。还有个兄弟工具，chruby，可以用来切换不同的 Ruby 版本。支持的平台有 OS X、Linux 和其它类 UNIX 操作系统。</p><p>RubyInstaller<br>如果使用 Windows，有个不错的项目能帮你安装 Ruby：RubyInstaller。它能帮你在 Windows 中安装所需的所有 Ruby 开发环境。</p><p>下载、运行，即可!</p><p>RailsInstaller 和 Ruby Stack<br>如果是为了使用 Ruby on Rails 而安装 Ruby，可以使用下列安装工具：</p><p>RailsInstaller，使用的是 RubyInstaller，但包括了其它能够帮助 Rails 开发的工具。支持 OS X 和 Windows。<br>Bitnami Ruby Stack，提供了完整的 Rails 开发环境。支持 OS X、Linux、Windows、虚拟机和云镜像。<br>管理工具<br>许多 Ruby 程序员使用 Ruby 管理工具管理不同版本的 Ruby。这些管理工具有很多额外的优点，但没有官方支持。不过，这些工具背后的社群都乐于助人。</p><p>chruby<br>chruby 用于在不同的 Ruby 版本之间切换。chruby 能够管理用 ruby-install 或者通过源码编译安装的 Ruby。</p><p>rbenv<br>rbenv 用于管理系统中安装的多个 Ruby 版本。它不能直接安装 Ruby，但有个流行的插件叫 ruby-build 能够安装 Ruby。这两个工具都支持 OS X、Linux 和其它类 UNIX 操作系统。</p><p>RVM（“Ruby Version Manager”）<br>RVM 能在系统中安装和管理多个 Ruby 版本。同时还能管理不同的 gem 集。支持 OS X、Linux 和其它类 UNIX 操作系统。</p><p>uru<br>Uru 是一个轻量级的命令行工具，支持多平台，能够帮你在 OS X、Linux 和 Windows 上使用不同的 Ruby 版本。</p><p>通过源码编译安装<br>当然，也可以通过源码安装 Ruby。下载，解压，然后执行：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./configure</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br></pre></td></tr></table></figure></p><p>默认情况下，Ruby 安装到 /usr/local 目录。如果想使用其他目录，可以把 –prefix=DIR 选项传给 ./configure 脚本。</p><p>因为无法使用任何工具来管理通过源码编译安装的 Ruby，所以使用第三方工具或者包管理器或许是更好的选择。</p><p>这边ubuntu环境选择的是<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> install ruby-full</span><br></pre></td></tr></table></figure></p><p>安装的，简单方便。</p><p>详情请查看 <a href="http://www.ruby-lang.org/zh_cn/documentation/installation/" target="_blank" rel="noopener">http://www.ruby-lang.org/zh_cn/documentation/installation/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;安装 Ruby&lt;br&gt;可以使用多种工具安装 Ruby。本页介绍如何使用主流的包管理系统和第三方工具管理和安装 Ruby，以及如何通过源码编译安装。&lt;/p&gt;
&lt;p&gt;选择安装方式&lt;br&gt;安装 Ruby 的方式有多种：&lt;/p&gt;
&lt;p&gt;如果使用的是类 UNIX 操作系统，使用系统的包管理器是最简单的安装方式。但是，包管理器中的 Ruby 版本通常都不是最新的。&lt;br&gt;安装工具能够安装指定的一个或多个 Ruby 版本。有针对 Windows 的安装包。&lt;br&gt;管理工具能帮助你在系统中安装的多个 Ruby 版本之间切换。&lt;br&gt;最后，也可以通过源码编译安装 Ruby。&lt;br&gt;下面概述针对不同需求和不同平台的安装方式。&lt;/p&gt;
    
    </summary>
    
    
      <category term="ruby" scheme="https://jiangshaobo.cn/tags/ruby/"/>
    
  </entry>
  
  <entry>
    <title>Hexo渲染时排除目录文件夹或部分文件</title>
    <link href="https://jiangshaobo.cn/20180131/Hexo%E6%B8%B2%E6%9F%93%E6%97%B6%E6%8E%92%E9%99%A4%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6%E5%A4%B9%E6%88%96%E9%83%A8%E5%88%86%E6%96%87%E4%BB%B6.html"/>
    <id>https://jiangshaobo.cn/20180131/Hexo渲染时排除目录文件夹或部分文件.html</id>
    <published>2018-01-31T05:28:03.000Z</published>
    <updated>2018-02-02T03:26:25.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看-config-yml的时候发现"><a href="#使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看-config-yml的时候发现" class="headerlink" title="使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看_config.yml的时候发现"></a>使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看_config.yml的时候发现</h4><a id="more"></a><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># Directory</span></span><br><span class="line"><span class="meta"># 资源文件夹，这个文件夹用来存放内容</span></span><br><span class="line">source_dir: source</span><br><span class="line"><span class="meta"># 公共文件夹，这个文件夹用于存放生成的站点文件</span></span><br><span class="line">public_dir: <span class="keyword">public</span></span><br><span class="line"><span class="meta"># 标签文件夹</span></span><br><span class="line">tag_dir: tags</span><br><span class="line"><span class="meta"># 归档文件夹</span></span><br><span class="line">archive_dir: archives</span><br><span class="line"><span class="meta"># 分类文件夹</span></span><br><span class="line">category_dir: categories</span><br><span class="line"><span class="meta"># Include code 文件夹</span></span><br><span class="line">code_dir: downloads/code</span><br><span class="line"><span class="meta"># 资源文件夹</span></span><br><span class="line">assets_dir: assets</span><br><span class="line"><span class="meta"># 国际化（i18n）文件夹</span></span><br><span class="line">i18n_dir: :lang</span><br><span class="line"><span class="meta"># 跳过指定文件的渲染，您可使用 glob 表达式来匹配路径</span></span><br><span class="line"><span class="meta"># skip_render: *.html</span></span><br></pre></td></tr></table></figure><p>注意skip_render，跳过指定文件的渲染，您可使用 glob 表达式来匹配路径，把注释去掉，让此配置起效。</p><p>在提交网址的时候，搜索引擎确认网站所有权时(站长统计验证)需要下载一个验证文件来进行验证，<br>要是这个文件被渲染了，验证就可能会失败了。<br>或者，有时候会写一些简单的html示例页面，这也是不希望Hexo渲染的。因此有必要针对某个文件或者目录进行排除。<br>Hexo的配置文件中提供了配置项skip_render。</p><p>注意<br>只有source目录下的文件才会发布到public（能够在网络上访问到），因此Hexo只渲染source目录下的文件。skip_render参数设置的路径是相对于source目录的路径。</p><p>设置排除项<br>假设source目录下的文件如以下目录树所示,<br>Ubuntu下 tree 命令以树形结构显示文件夹目录结构，先安装tree<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> install tree</span><br></pre></td></tr></table></figure></p><p>只查看当前第一级的目录和文件<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tree</span> -L <span class="number">1</span></span><br></pre></td></tr></table></figure></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── assets</span><br><span class="line">├── CNAME</span><br><span class="line">├── demo</span><br><span class="line">├── instagram</span><br><span class="line">├── <span class="built_in">labs</span></span><br><span class="line">├── photos</span><br><span class="line">├── _posts</span><br><span class="line">└── t</span><br></pre></td></tr></table></figure><p>只查看当前第二级的目录和文件</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tree</span> -L <span class="number">2</span></span><br></pre></td></tr></table></figure><p>结果如下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── assets</span><br><span class="line">│   ├── demo</span><br><span class="line">│   └── img</span><br><span class="line">├── CNAME</span><br><span class="line">├── demo</span><br><span class="line">│   ├── baidu.html</span><br><span class="line">│   ├── google.html</span><br><span class="line">│   └── index.html</span><br><span class="line">├── instagram</span><br><span class="line">│   └── index.md</span><br><span class="line">├── labs</span><br><span class="line">│   ├── index</span><br><span class="line">│   └── index.md</span><br><span class="line">├── photos</span><br><span class="line">│   ├── index.ejs</span><br><span class="line">│   ├── <span class="selector-tag">ins</span>.css</span><br><span class="line">│   ├── <span class="selector-tag">ins</span>.js</span><br><span class="line">│   ├── <span class="selector-tag">ins</span>.json</span><br><span class="line">│   ├── lazyload<span class="selector-class">.min</span><span class="selector-class">.js</span></span><br><span class="line">│   └── tools.js</span><br><span class="line">├── _posts</span><br><span class="line">│   ├── centos-ubuntu下安装nodejs环境.md</span><br><span class="line">│   ├── CNAME</span><br><span class="line">│   └── hello-world.md</span><br><span class="line">└── t</span><br><span class="line">    ├── index.ejs</span><br><span class="line">    ├── <span class="selector-tag">ins</span>.css</span><br><span class="line">    ├── <span class="selector-tag">ins</span>.js</span><br><span class="line">    ├── <span class="selector-tag">ins</span>.json</span><br><span class="line">    └── lazyload<span class="selector-class">.min</span><span class="selector-class">.js</span></span><br></pre></td></tr></table></figure></p><p>排除单个文件<br>排除demo/index.html<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">skip_render:</span> <span class="string">'demo/index.html'</span></span><br></pre></td></tr></table></figure></p><p>排除多个文件<br>排除baidu.html和google.html<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">skip_render:</span><br><span class="line">  -<span class="ruby"> <span class="string">'demo/baidu.html'</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">'demo/google.html'</span></span></span><br></pre></td></tr></table></figure></p><p>或者</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">skip_render:</span> <span class="string">'*.html'</span></span><br></pre></td></tr></table></figure><p>后者会排除source目录下所有后缀为html的文件，但是不会排除子目录如demo及其子目录中的html文件。</p><p>排除demo目录下baidu.html和google.html以及index.html<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">skip_render:</span><br><span class="line">  -<span class="ruby"> <span class="string">'demo/baidu.html'</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">'demo/google.html'</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">'demo/index.html'</span></span></span><br></pre></td></tr></table></figure></p><p>或者<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">skip_render:</span> <span class="string">'demo/*.html'</span></span><br></pre></td></tr></table></figure></p><p>demo目录下新增other目录，另外新增几个文件<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> <span class="built_in">demo</span>/other</span><br><span class="line">touch <span class="built_in">demo</span>/other/test.html</span><br><span class="line">touch <span class="built_in">demo</span>/other/test1.html</span><br><span class="line">touch <span class="built_in">demo</span>/other/test2.md</span><br></pre></td></tr></table></figure></p><p>排除source/demo/other目录中的所有html文件</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">skip_render:</span> <span class="string">'demo/other/*.html'</span></span><br></pre></td></tr></table></figure><p>这不会排除test2.md文件</p><p>排除source/demo/other目录中的所有文件</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">skip_render:</span> <span class="string">'demo/other/**'</span></span><br></pre></td></tr></table></figure><p>排除baidu.html和google.html以及整个source/demo目录</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">skip_render:</span><br><span class="line">  -<span class="ruby"> <span class="string">'demo/*.html'</span></span></span><br><span class="line"><span class="ruby">  - <span class="string">'demo/other/**'</span></span></span><br></pre></td></tr></table></figure><p>可以到public文件下查看<br>排除所有特定后缀的文件，使用 glob 表达式来匹配路径，那么什么是glob表达式呢？</p>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看-config-yml的时候发现&quot;&gt;&lt;a href=&quot;#使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看-config-yml的时候发现&quot; class=&quot;headerlink&quot; title=&quot;使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看_config.yml的时候发现&quot;&gt;&lt;/a&gt;使用Hexo的时候，有时候需要写点Demo实验，发现Hexo也渲染了，那么怎么才可以让Hexo跳过目录或者部分文件，在查看_config.yml的时候发现&lt;/h4&gt;
    
    </summary>
    
    
      <category term="hexo" scheme="https://jiangshaobo.cn/tags/hexo/"/>
    
      <category term="skip_render" scheme="https://jiangshaobo.cn/tags/skip-render/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 Source和Layer</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch05/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch05/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:08:15.970Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Source和Layer"><a href="#Source和Layer" class="headerlink" title="Source和Layer"></a>Source和Layer</h1><p>在前面的例子中，已经对<code>Source</code>和<code>Layer</code>有所了解了。比如我们加载了Open Street Map的地图。然而世界上的地图并不只有Open Street Map，还有很多其他的地图，比如Google地图，天地图，高德地图，百度地图等。如果OpenLayers支持的地图来源越多，就会越适用，越强大。除了加载基本的地图之外，GIS还需要加载很多其他的信息，比如街道名称，商店名称，公交站点，道路等等。那么在OpenLayers 3中，具体该如何把这些添加在地图上呢？</p><a id="more"></a><p>首先需要明白的一点是，<code>Source</code>和<code>Layer</code>是一对一的关系，有一个<code>Source</code>，必然需要一个<code>Layer</code>，然后把这个<code>Layer</code>添加到<code>Map</code>上，就可以显示出来了。通过官网的API搜索<code>ol.source</code>可以发现有很多不同的<code>Source</code>，但归纳起来共三种：<code>ol.source.Tile</code>，<code>ol.source.Image</code>和<code>ol.source.Vector</code>。 </p><ul><li><code>ol.source.Tile</code>对应的是瓦片数据源，现在网页地图服务中，绝大多数都是使用的瓦片地图，而OpenLayers 3作为一个WebGIS引擎，理所当然应该支持瓦片。</li><li><code>ol.source.Image</code>对应的是一整张图，而不像瓦片那样很多张图，从而无需切片，也可以加载一些地图，适用于一些小场景地图。</li><li><code>ol.source.Vector</code>对应的是矢量地图源，点，线，面等等常用的地图元素(Feature)，就囊括到这里面了。这样看来，只要这两种<code>Source</code>就可以搞定80%的需求了。</li></ul><p>从复杂度来分析，<code>ol.source.Image</code>和<code>ol.source.Vector</code>都不复杂，其数据格式和来源方式都简单。而<code>ol.source.Tile</code>则不一样，由于一些历史问题，多个服务提供商，多种标准等诸多原因，导致要支持世界上大多数的瓦片数据源，就需要针对这些差异提供不同的<code>Tile</code>数据源支持。在更进一步了解之前，我们先来看一下OpenLayers 3现在支持的<code>Source</code>具体有哪些：<br><img src="../img/ol.source.Tile.png" alt="ol.source.Tile类图"></p><p>上图中的类是按照继承关系，从左向右展开的，左边的为父类，右边的为子类。在使用时，一般来说，都是直接使用叶子节点上的类，基本就可以完成需求。父类需要自己进一步扩展或者处理才能有效使用的。</p><p>我们先了解最为复杂的<code>ol.source.Tile</code>，其叶子节点类有很多，大致可以分为几类：</p><ul><li>在线服务的<code>Source</code>，包括<code>ol.source.BingMaps</code>(使用的是微软提供的Bing在线地图数据)，<code>ol.source.MapQuest</code>(使用的是MapQuest提供的在线地图数据)<font color="#ff0000">(注: 由于MapQuest开始收费，ol v3.17.0就移除了<code>ol.source.MapQuest</code>)</font>，<code>ol.source.OSM</code>(使用的是Open Street Map提供的在线地图数据)，<code>ol.source.Stamen</code>(使用的是Stamen提供的在线地图数据)。没有自己的地图服务器的情况下，可直接使用它们，加载地图底图。</li><li>支持协议标准的<code>Source</code>，包括<code>ol.source.TileArcGISRest</code>，<code>ol.source.TileWMS</code>，<code>ol.source.WMTS</code>，<code>ol.source.UTFGrid</code>，<code>ol.source.TileJSON</code>。如果要使用它们，首先你得先学习对应的协议，之后必须找到支持这些协议的服务器来提供数据源，这些服务器可以是地图服务提供商提供的，也可以是自己搭建的服务器，关键是得支持这些协议。</li><li>ol.source.XYZ，这个需要单独提一下，因为是可以直接使用的，而且现在很多地图服务（在线的，或者自己搭建的服务器）都支持xyz方式的请求。国内在线的地图服务，高德，天地图等，都可以通过这种方式加载，本地离线瓦片地图也可以，用途广泛，且简单易学，需要掌握。</li></ul><p><code>ol.source.Image</code>虽然有几种不同的子类，但大多比较简单，因为不牵涉到过多的协议和服务器提供商。而<code>ol.source.Vector</code>就更加的简单了，但有时候其唯一的子类<code>ol.source.Cluster</code>在处理大量的<code>Feature</code>时，我们可能需要使用。</p><p>在大概了解了整个<code>Source</code>之后，紧接着该介绍它的搭档<code>Layer</code>了，同样的，我们还是先从OpenLayers 3现有的<code>Layer</code>类图大致了解一下：<br><img src="../img/ol_layer_Base.png" alt="ol.layer.Base类图"></p><p>为了便于了解和使用，图中标注了每一个<code>Layer</code>对应的<code>Source</code>。通过上图可以看到<code>Layer</code>相对于<code>Source</code>而言，真是太简单了。</p><p>对于初学者而言，如何选择和应用不同的<code>Source</code>和<code>Layer</code>是一个非常迷惑和困难的问题。为此，本章将围绕着<code>Source</code>和<code>Layer</code>展开，为大家解决这个问题。</p><h1 id="加载瓦片地图"><a href="#加载瓦片地图" class="headerlink" title="加载瓦片地图"></a>加载瓦片地图</h1><p>瓦片地图源于一种大地图解决方案，针对一整块非常大的地图进行切片，分成很多相同大小的小块地图，在用户访问的时候，再一块一块小地图加载，拼接在一起，从而还原成一整块大的地图。这样做的优点在于，用户在同一时间，同一个可见视图内，只能看到地图的一部分，而不是全部。如果一次加载整个大地图，会导致加载很慢，且不可用的问题。这对于在线服务来说，是非常致命的。所以几乎所有的在线网页地图服务，都使用的是瓦片地图。自然加载瓦片地图成了必不可少的功能，也是必须要掌握的，为此本节将重点介绍如何选择和加载瓦片地图，不用担心，都会结合具体的实例来讲解。</p><h1 id="最简单的加载在线地图"><a href="#最简单的加载在线地图" class="headerlink" title="最简单的加载在线地图"></a>最简单的加载在线地图</h1><p>本小节所介绍的这些在线地图，加载起来会非常简单，因为OpenLayers 3已经做了很好的封装，对于开发者而言，无须做过多的编码，即可直接使用。主要包括开源的Open Street Map，微软的Bing地图，Map Quest地图<font color="#ff0000">(注: 由于MapQuest开始收费，ol v3.17.0就移除了<code>ol.source.MapQuest</code>)</font>，Stamen地图。 </p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><input type="radio" checked="checked" name="mapSource" onclick="switch2OSM();">OpenStreetMap地图<br><input type="radio" name="mapSource" onclick="switch2BingMap();">Bing地图<br><input type="radio" name="mapSource" onclick="switch2StamenMap();">Stamen地图<br><input type="radio" name="mapSource" onclick="switch2MapQuest();">MapQuest地图<br><br><script><br><br>    // Open Street Map 地图层<br>    var openStreetMapLayer = new ol.layer.Tile({<br>        source: new ol.source.OSM()<br>    });<br><br>    // Bing地图层<br>    var bingMapLayer = new ol.layer.Tile({<br>        source: new ol.source.BingMaps({<br>            key: ‘AkjzA7OhS4MIBjutL21bkAop7dc41HSE0CNTR5c6HJy8JKc7U9U9RveWJrylD3XJ’,<br>      imagerySet: ‘Road’<br>        })<br>    });<br><br>    // Stamen地图层<br>    var stamenLayer = new ol.layer.Tile({<br>        source: new ol.source.Stamen({<br>            layer: ‘watercolor’<br>        })<br>    });<br><br>    // MapQuest地图层<br>    var mapQuestLayer = new ol.layer.Tile({<br>        source: new ol.source.MapQuest({<br>            layer: ‘osm’<br>        })<br>    });<br><br>    // 创建地图<br>  var map = new ol.Map({<br>        layers: [<br>            openStreetMapLayer<br>        ],<br>        view: new ol.View({<br>            // 设置成都为地图中心<br>            center: [104.06, 30.67],<br>            projection: ‘EPSG:4326’,<br>            zoom: 10<br>        }),<br>        target: ‘map’<br>  });<br><br>  function switch2OSM() {<br>      // 先移除当前的地图，再添加Open Street Map 地图<br>      map.removeLayer(map.getLayers().item(0));<br>      map.addLayer(openStreetMapLayer);<br>  }<br><br>  function switch2BingMap() {<br>      // 先移除当前的地图，再添加Bing地图<br>      map.removeLayer(map.getLayers().item(0));<br>      map.addLayer(bingMapLayer);<br>  }<br><br>  function switch2StamenMap() {<br>      // 先移除当前的地图，再添加stamen地图<br>      map.removeLayer(map.getLayers().item(0));<br>      map.addLayer(stamenLayer);<br>  }<br><br>  function switch2MapQuest() {<br>      // 先移除当前的地图，再添加MapQuest地图<br>      map.removeLayer(map.getLayers().item(0));<br>      map.addLayer(mapQuestLayer);<br>  }<br></script><br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">checked</span>=<span class="string">"checked"</span> <span class="attr">name</span>=<span class="string">"mapSource"</span> <span class="attr">onclick</span>=<span class="string">"switch2OSM();"</span> /&gt;</span>OpenStreetMap地图</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"mapSource"</span> <span class="attr">onclick</span>=<span class="string">"switch2BingMap();"</span> /&gt;</span>Bing地图</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"mapSource"</span> <span class="attr">onclick</span>=<span class="string">"switch2StamenMap();"</span> /&gt;</span>Stamen地图</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"mapSource"</span> <span class="attr">onclick</span>=<span class="string">"switch2MapQuest();"</span> /&gt;</span>MapQuest地图</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// Open Street Map 地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> openStreetMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// Bing地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> bingMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.BingMaps(&#123;</span></span><br><span class="line"><span class="actionscript">key: <span class="string">'AkjzA7OhS4MIBjutL21bkAop7dc41HSE0CNTR5c6HJy8JKc7U9U9RveWJrylD3XJ'</span>,</span></span><br><span class="line"><span class="actionscript">      imagerySet: <span class="string">'Road'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// Stamen地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> stamenLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Stamen(&#123;</span></span><br><span class="line"><span class="actionscript">layer: <span class="string">'watercolor'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// MapQuest地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mapQuestLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.MapQuest(&#123;</span></span><br><span class="line"><span class="actionscript">layer: <span class="string">'osm'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="undefined">openStreetMapLayer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">switch2OSM</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 先移除当前的地图，再添加Open Street Map 地图</span></span></span><br><span class="line"><span class="undefined">  map.removeLayer(map.getLayers().item(0));</span></span><br><span class="line"><span class="undefined">  map.addLayer(openStreetMapLayer);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">switch2BingMap</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 先移除当前的地图，再添加Bing地图</span></span></span><br><span class="line"><span class="undefined">  map.removeLayer(map.getLayers().item(0));</span></span><br><span class="line"><span class="undefined">  map.addLayer(bingMapLayer);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">switch2StamenMap</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 先移除当前的地图，再添加stamen地图</span></span></span><br><span class="line"><span class="undefined">  map.removeLayer(map.getLayers().item(0));</span></span><br><span class="line"><span class="undefined">  map.addLayer(stamenLayer);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">switch2MapQuest</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 先移除当前的地图，再添加MapQuest地图</span></span></span><br><span class="line"><span class="undefined">  map.removeLayer(map.getLayers().item(0));</span></span><br><span class="line"><span class="undefined">  map.addLayer(mapQuestLayer);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>代码很简单，因为OpenLayers 3对这几个在线服务都做了很好的封装，只用简单的配置一下<code>Source</code>的构造参数就可以了。此处并没有列出每一个类的所有构造参数，但可以通过API文档查询了解。<br><br>上面这个地图涉及到多个地图源，如果都放在地图上，就涉及到图层管理，这一部分的知识将在后续章节<a href="05-11.md">图层叠加及管理</a>有更详细的介绍。<br><br># 万能瓦片地图加载秘籍<br><br>其实加载瓦片地图基本是大同小异，你可能会觉得很惊讶，因为网上在线的地图服务，看起都不一样，本节即将为你解开这层神秘的面纱。在前面已基本介绍了瓦片地图的解决方案和作用，此处再用一张图来直观地认识一下瓦片结构：<br><img src="../img/lod.png" alt="瓦片地图结构"><br><br>从上图可知，大家常用的瓦片地图是一个三维的概念，我们通常使用xyz这样的坐标来精确定位一张瓦片。通常z用于表示地图层级，而xy表示某个层级内的瓦片平面，x为横纵坐标，y为纵轴坐标，类似于数学上常见的笛卡尔坐标系。在这个瓦片平面上的每一个瓦片在横轴和纵轴上都有对应的坐标：x和y。<br><br>## 加载简单的瓦片地图<br>虽然现在大多数网页地图都使用的是瓦片地图，但还是有必要先介绍一下如何识别它。在浏览器中打开任意一个在线的网页地图，然后打开浏览器的开发者工具，再随意拖动，放大缩小地图。之后在开发者工具里查看新发起的请求，是否有一些图片请求，查看请求返回的图片，是否为正在浏览的地图的一部分，如果是，则基本为瓦片地图。下面以百度地图为例，说明一下在线瓦片地图请求信息：<br><img src="../img/baiduMap.png" alt="百度地图"><br><br>在请求的url中，我们可以很明显地看到xyz这三个参数，这进一步说明了百度地图就是用了瓦片地图。如果你多分析一下现有的在线网页地图，基本都是瓦片地图。正因为如此，OpenLayers 3提供了<code>ol.source.XYZ</code>这种通用的<code>Source</code>来适应广大的在线瓦片地图数据源，具备很好的适用性。通常情况下，开发者想要加载不同的在线瓦片地图源，则只需要更改<code>ol.source.XYZ</code>的构造参数中<code>url</code>就可以了。 比如我们就可以不用<code>ol.source.OSM</code>，而用<code>ol.source.XYZ</code>来加载Open Street Map地图，结果一样：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// Open Street Map 地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> openStreetMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span></span><br><span class="line"><span class="actionscript">url: <span class="string">'http://&#123;a-c&#125;.tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="undefined">openStreetMapLayer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>除了Open Street Map可以这样加载外，还有很多其他的在线瓦片地图源也可以，比如高德地图：<br><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 高德地图层</span></span><br><span class="line"><span class="keyword">var</span> gaodeMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span><br><span class="line">url:<span class="string">'http://webst0&#123;1-4&#125;.is.autonavi.com/appmaptile?lang=zh_cn&amp;size=1&amp;scale=1&amp;style=7&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><br><br>比如Yahoo地图：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// yahoo地图层</span></span><br><span class="line"><span class="keyword">var</span> yahooMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span><br><span class="line">tileSize: <span class="number">512</span>,</span><br><span class="line">url:<span class="string">'https://&#123;0-3&#125;.base.maps.api.here.com/maptile/2.1/maptile/newest/normal.day/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;/512/png8?lg=ENG&amp;ppi=250&amp;token=TrLJuXVK62IQk0vuXFzaig%3D%3D&amp;requestid=yahoo.prod&amp;app_id=eAdkWGYRoc4RfxVo0Z4B'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><br><br>大同小异，非常简单。上面的三个例子，只有Yahoo地图的代码有点不一样：多了<code>tileSize</code>参数的设置。默认情况下，<code>tileSize</code>为256，这也是现在绝大多数瓦片采用的大小。但Yahoo地图使用的是512，所以我们需要显示指定。<br><br>## 瓦片地图之百度地图<br>通过上面的示例我们已经发现，其实可以非常轻松地加载多种不同来源的在线瓦片地图。但遗憾地是，上面这种简单方法并不适用于所有的在线瓦片地图，总有一些是特殊的，比如百度地图，上面这种方式就不生效了。此时，我们需要回过头来思考一下瓦片地图加载的整个过程：瓦片地图加载的关键在于找对瓦片，但要找对瓦片，就得知道瓦片的坐标，而坐标又需要明确的坐标系。我们在<a href="../ch04/04-02.md">坐标</a>里说过，任何坐标都得有坐标系才有意义。在OpenLayers 3中，默认使用的瓦片地图的坐标系是如何定义的？经分析可知，OpenLayers 3的瓦片坐标系的原点在左上角，向上为y轴正方向，向右为x轴正方向。具体到地图上来讲，地球经过投影，投影到一个平面上，平面最左边对应地球最西边，平面最上边对应地球最北边。原点就处于整个平面的左上角，即地球的西北角，从北向南为y轴负方向，从西向东为x轴正方向。理解这一点非常重要，因为并不是所有在线的瓦片地图都是采用这样的坐标系。用OpenLayers 3加载它们的时候，如果坐标系不同，计算出来的瓦片地址就获取不到对应的瓦片，为解决这个问题，我们必须要先对瓦片坐标进行转换。那么，具体该怎么实现转换？最详细明了的方式还是看实例，下面我们看一下加载百度地图一种实现方式：<br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="baiduMap" style="width: 100%"></div><br><script><br>    // 百度地图层<br>    var baiduMapLayer = new ol.layer.Tile({<br>        source: new ol.source.XYZ({<br>            tilePixelRatio: 2,<br>            tileUrlFunction: function(tileCoord){ // 参数tileCoord为瓦片坐标<br>                    var z = tileCoord[0];<br>          var x = tileCoord[1];<br>          var y = tileCoord[2];<br><br>          var halfTileNum = Math.pow(2, z-1);<br><br>          var baiduX =  x - halfTileNum;<br>          var baiduY =  y + halfTileNum;<br><br>          if (baiduX &lt; 0) {<br>              baiduX = ‘M’ + (-baiduX);<br>          }<br>          if (baiduY &lt; 0) {<br>              baiduY = ‘M’ + (-baiduY);<br>          }<br><br>          return ‘<a href="http://online2.map.bdimg.com/onlinelabel/?qt=tile&amp;x=&#39;">http://online2.map.bdimg.com/onlinelabel/?qt=tile&amp;x=&#39;</a> + baiduX + ‘&amp;y=’ + baiduY + ‘&amp;z=’ + z + ‘&amp;styles=pl&amp;udt=20160321&amp;scaler=2&amp;p=0’;<br>            }<br>        })<br>    });<br><br>    // 创建地图<br>  var map = new ol.Map({<br>        layers: [<br>            baiduMapLayer<br>        ],<br>        view: new ol.View({<br>            // 设置成都为地图中心<br>            center: [104.06, 30.67],<br>            projection: ‘EPSG:4326’,<br>            zoom: 4<br>        }),<br>        target: ‘baiduMap’<br>  });<br></script><br><br>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"baiduMap"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 百度地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> baiduMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span></span><br><span class="line"><span class="undefined">tilePixelRatio: 2,</span></span><br><span class="line"><span class="actionscript">tileUrlFunction: <span class="function"><span class="keyword">function</span><span class="params">(tileCoord)</span></span>&#123;  <span class="comment">// 参数tileCoord为瓦片坐标</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> z = tileCoord[<span class="number">0</span>];</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> x = tileCoord[<span class="number">1</span>];</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> y = tileCoord[<span class="number">2</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 计算当前层级下瓦片总数的一半，用于定位整个地图的中心点</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> halfTileNum = <span class="built_in">Math</span>.pow(<span class="number">2</span>, z<span class="number">-1</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 原点移到中心点后，计算xy方向上新的坐标位置</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> baiduX =  x - halfTileNum;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> baiduY =  y + halfTileNum;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 百度瓦片服务url将负数使用M前缀来标识</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (baiduX &lt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="actionscript">        baiduX = <span class="string">'M'</span> + (-baiduX);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (baiduY &lt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="actionscript">        baiduY = <span class="string">'M'</span> + (-baiduY);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 返回经过转换后，对应于百度在线瓦片的url</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="string">'http://online2.map.bdimg.com/onlinelabel/?qt=tile&amp;x='</span> + baiduX + <span class="string">'&amp;y='</span> + baiduY + <span class="string">'&amp;z='</span> + z + <span class="string">'&amp;styles=pl&amp;udt=20160321&amp;scaler=2&amp;p=0'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="undefined">baiduMapLayer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 4</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'baiduMap'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>和前面几个加载在线瓦片地图的例子不一样的地方在于，我们没有设置<code>url</code>，而是设置了<code>tileUrlFunction</code>，这是一个获取瓦片<code>url</code>的函数，如果自定义这个函数，就可以实现不同坐标系之间的转换，从而返回在线地图服务对应瓦片的<code>url</code>。通过代码可以看到，函数入参是一个瓦片坐标，然后进行一系列的转换，得到百度在线地图的瓦片地址。效果参见上方地图，不妨拖动、缩放试试，拼接无缝，并没有什么问题。<br><br><code>tileUrlFunction</code>这个自定义函数的代码实现有可能看不懂，虽然知道在进行坐标转换，但并不知道为什么要这样实现。为了彻底弄明白代码，我们必须得把之前遗漏的一个很重要环节补上：弄明白待加载的在线瓦片地图的坐标系。对百度在线瓦片坐标系进行简单分析发现，它是以某一个位置为原点，向右为x正方向，向上为y正方向的坐标系，进一步分析发现，原点应该在中心位置，为此，我们假设百度地图是以经纬度[0,0]为原点，在此基础上编写函数<code>tileUrlFunction</code>的实现。<code>halfTileNum</code>表示的是在当前缩放层级之下，总的瓦片个数的一半，意味着它就是中心位置。对于<code>baiduX</code>小于0的情况，百度使用了<code>M</code>来表示负号，所以要特殊处理一下。想必这下应该更加理解代码实现了。不同的在线瓦片地图的转换代码可能不同，需要根据对应的坐标系来确定。<br><br><br>但上面这个地图并不完美，因为我们设定的地图中心为成都，然而实际上显示的地图中心并不在成都。虽然无缝拼接，但位置偏差有点远。由此基本可以排除坐标转换的问题，看起来应该是OpenLayers 3的分辨率和百度在线瓦片地图使用的分辨率对不上。经过分析发现，确实如此，在网上也有很多分析文章可以查阅。那么我们是否可以重新定义分辨率呢？ 答案是肯定的，我们可以使用<code>ol.source.XYZ</code>的父类来解决问题。<br><br><br>## 重新定义OpenLayers 3的瓦片坐标系<br><code>ol.source.TileImage</code>作为<code>ol.source.XYZ</code>的父类，除了可以转换坐标之外，还具备更加强大的功能，修改分辨率。下面我们使用它来加载百度地图，这次是正确的：<br><div id="baiduMap2" style="width: 100%"></div><br><script><br><br>    // 自定义分辨率和瓦片坐标系<br>  var resolutions = [];<br>  var maxZoom = 18;<br><br>  for(var i=0; i&lt;=maxZoom; i++){<br>      resolutions[i] = Math.pow(2, maxZoom-i);<br>  }<br>  var tilegrid  = new ol.tilegrid.TileGrid({<br>      origin: [0,0],<br>      resolutions: resolutions<br>  });<br><br>  // 创建百度地图的数据源<br>  var baiduSource = new ol.source.TileImage({<br>      projection: ‘EPSG:3857’,<br>      tileGrid: tilegrid,<br>      tileUrlFunction: function(tileCoord, pixelRatio, proj){<br>          var z = tileCoord[0];<br>          var x = tileCoord[1];<br>          var y = tileCoord[2];<br><br>          if(x&lt;0){<br>              x = “M”+(-x);<br>          }<br>          if(y&lt;0){<br>              y = “M”+(-y);<br>          }<br><br>          return “<a href="http://online3.map.bdimg.com/onlinelabel/?qt=tile&amp;x=&quot;+x+&quot;&amp;y=&quot;+y+&quot;&amp;z=&quot;+z+&quot;&amp;styles=pl&amp;udt=20160321&amp;scaler=2&amp;p=1&quot;">http://online3.map.bdimg.com/onlinelabel/?qt=tile&amp;x=&quot;+x+&quot;&amp;y=&quot;+y+&quot;&amp;z=&quot;+z+&quot;&amp;styles=pl&amp;udt=20160321&amp;scaler=2&amp;p=1&quot;</a>;<br>      }<br>  });<br><br>    // 百度地图层<br>    var baiduMapLayer2 = new ol.layer.Tile({<br>        source: baiduSource<br>    });<br><br>    // 创建地图<br>  new ol.Map({<br>        layers: [<br>            baiduMapLayer2<br>        ],<br>        view: new ol.View({<br>            // 设置成都为地图中心<br>            center: [104.06, 30.67],<br>            projection: ‘EPSG:4326’,<br>            zoom: 10<br>        }),<br>        target: ‘baiduMap2’<br>  });<br></script><br><br>对应的代码：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"baiduMap2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 自定义分辨率和瓦片坐标系</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> resolutions = [];</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> maxZoom = <span class="number">18</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 计算百度使用的分辨率</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;=maxZoom; i++)&#123;</span></span><br><span class="line"><span class="javascript">      resolutions[i] = <span class="built_in">Math</span>.pow(<span class="number">2</span>, maxZoom-i);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> tilegrid  = <span class="keyword">new</span> ol.tilegrid.TileGrid(&#123;</span></span><br><span class="line"><span class="actionscript">      origin: [<span class="number">0</span>,<span class="number">0</span>],<span class="comment">// 设置原点坐标</span></span></span><br><span class="line"><span class="actionscript">      resolutions: resolutions<span class="comment">// 设置分辨率</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建百度地图的数据源</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> baiduSource = <span class="keyword">new</span> ol.source.TileImage(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:3857'</span>,</span></span><br><span class="line"><span class="undefined">      tileGrid: tilegrid,</span></span><br><span class="line"><span class="actionscript">      tileUrlFunction: <span class="function"><span class="keyword">function</span><span class="params">(tileCoord, pixelRatio, proj)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">var</span> z = tileCoord[<span class="number">0</span>];</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">var</span> x = tileCoord[<span class="number">1</span>];</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">var</span> y = tileCoord[<span class="number">2</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">          <span class="comment">// 百度瓦片服务url将负数使用M前缀来标识</span></span></span><br><span class="line"><span class="actionscript">          <span class="keyword">if</span>(x&lt;<span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="actionscript">              x = <span class="string">'M'</span> + (-x);</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">if</span>(y&lt;<span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="actionscript">              y = <span class="string">'M'</span> + (-y);</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined"> </span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> <span class="string">"http://online0.map.bdimg.com/onlinelabel/?qt=tile&amp;x="</span>+x+<span class="string">"&amp;y="</span>+y+<span class="string">"&amp;z="</span>+z+<span class="string">"&amp;styles=pl&amp;udt=20160426&amp;scaler=1&amp;p=0"</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 百度地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> baiduMapLayer2 = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="undefined">source: baiduSource</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="undefined">baiduMapLayer2</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="actionscript">center: ol.proj.transform([<span class="number">104.06</span>, <span class="number">30.67</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'baiduMap2'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>这个代码同上面的代码相比，引入了<code>ol.tilegrid.TileGrid</code>，由名字可见，这是定义瓦片网格，其实就是瓦片坐标系，构造时需要设定原点，紧接着设置分辨率，其作用在于设定每一地图层级的分辨率。我们是否遗漏了坐标系的正向和负向的设定？默认情况下，从左向右为x正方向，从下向上为y轴正方向。这和我们数学上通常定义的笛卡尔坐标系是一样的，这一点需要大家记住。如代码所示，就可以重新定义OpenLayers 3的瓦片地图坐标系，这种方式的代码比上一种方式更加的可读和简洁。 如果用通用的方法解决不了，请别忘记还有这一强大灵活的处理方式。<br><br>## 分析瓦片地图坐标系<br>如何分析不同在线瓦片地图的坐标系呢？非常重要的一点是，先从特例出发，找简单的情况分析，比如选择z为2或者3进行分析，这种情况下，瓦片的数量比较少，可以查看整个地球范围内的地图的瓦片请求，注意分析其请求的<code>url</code>参数。上述的所有地图都可以以这样的方式入手来分析，包括百度地图，可以自行尝试该方法。如果你有更好的方法，愿意的话，请给大家一起分享一下。<br><br>## 解密瓦片url<br>瓦片的url解析对于想直接使用在线瓦片服务的开发者而言，是一项经常要做的事。根据难度，大致可以分为三种情况：<br><br><em> 第一种是最简单的，请求瓦片的<code>url</code>明确有xyz参数，比如高德地图和百度地图。</em> 第二种稍微难一点，<code>xyz</code>作为路径直接存在于<code>url</code>里面，没有明确的参数表明哪些是xyz，比如Open Street Map和Yahoo地图，这种情况下，地图服务器接收到请求后，就直接在服务器按照这个路径获取图片，按照这个逻辑，一般第一个参数表示是z，第二个参数为x，第三个参数为y。要想确认是否真是这样，可以写一个小程序来验证一下，如果还有问题，建议按照上面分析地图坐标系中的方法，从z比较小的情况入手来分析x，y，z的位置。<br><em> 第三种则最难，地图服务提供商为了防止大家直接非法使用瓦片地图，对瓦片的url进行了加密，比如现在的微软Bing中文地图和Google地图，这种情况下只有知道如何解密才能使用。<br><br>## 加载微软Bing中文地图<br>前面两种url的实例已经有了，此处分享一下第三种情况的url解密，以微软Bing中文地图为例：<br><img src="../img/bingmap-zh.png" alt="Bing中文地图"><br><br>图中显示的瓦片地图请求的url，没有明显的xyz参数，最有可能的存放xyz参数的地方在于url前面那一串数字，真实情况确实是这样的，经过分析和解码，最终实现了加载Bing中文地图：<br><br><div id="bingMap" style="width: 100%"></div><br><script><br>    // Bing中文地图层<br>    var bingMapLayer = new ol.layer.Tile({<br>        source: new ol.source.XYZ({<br>            tilePixelRatio: 2,<br>            tileUrlFunction: function(tileCoord){<br>                var z = tileCoord[0];<br>        var x = tileCoord[1];<br>        var y = -tileCoord[2] - 1;<br>        var result=’’, zIndex=0;<br><br>        for(; zIndex&lt;z; zIndex++) {<br>            result = ((x&amp;1)+2</em>(y&amp;1)).toString() + result;<br>            x &gt;&gt;= 1;<br>            y &gt;&gt;= 1;<br>        }<br>        return ‘<a href="http://dynamic.t0.tiles.ditu.live.com/comp/ch/&#39;">http://dynamic.t0.tiles.ditu.live.com/comp/ch/&#39;</a> + result + ‘?it=G,VE,BX,L,LA&amp;mkt=zh-cn,syr&amp;n=z&amp;og=111&amp;ur=CN’;<br>      }<br>        })<br>    });<br><br>    // 创建地图<br>  var map = new ol.Map({<br>        layers: [<br>            bingMapLayer<br>        ],<br>        view: new ol.View({<br>            // 设置成都为地图中心<br>            center: [104.06, 30.67],<br>            projection: ‘EPSG:4326’,<br>            zoom: 10<br>        }),<br>        target: ‘bingMap’<br>  });<br></script><br><br>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"bingMap"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// Bing中文地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> bingMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span></span><br><span class="line"><span class="actionscript">tileUrlFunction: <span class="function"><span class="keyword">function</span><span class="params">(tileCoord)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> z = tileCoord[<span class="number">0</span>];</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> x = tileCoord[<span class="number">1</span>];</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> y = -tileCoord[<span class="number">2</span>] - <span class="number">1</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> result=<span class="string">''</span>, zIndex=<span class="number">0</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">for</span>(; zIndex&lt;z; zIndex++) &#123;</span></span><br><span class="line"><span class="undefined">            result = ((x&amp;1)+2*(y&amp;1)).toString() + result;</span></span><br><span class="line"><span class="undefined">            x &gt;&gt;= 1;</span></span><br><span class="line"><span class="undefined">            y &gt;&gt;= 1;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="string">'http://dynamic.t0.tiles.ditu.live.com/comp/ch/'</span> + result + <span class="string">'?it=G,VE,BX,L,LA&amp;mkt=zh-cn,syr&amp;n=z&amp;og=111&amp;ur=CN'</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="undefined">bingMapLayer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'bingMap'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>需要注意的是地图数据是非常昂贵的，如果使用某一个在线地图服务，请先核实对方的版权和数据使用申明，不要侵犯对方的权益，按照要求合法使用地图。几乎所有的在线地图服务都提供了响应的服务接口，强烈建议在商用项目中使用这些接口。对于这些接口的使用，服务商都有详细的说明，在此不累述。<br><br># google地图加载<br>有许多人都在问google地图加载的问题，因为地图url是加密的，通过分析url，可以采用下面的方式来加载：<br><div id="googleMap" style="width: 100%"></div><br><script><br>    // google地图层<br>    var googleMapLayer = new ol.layer.Tile({<br>        source: new ol.source.XYZ({<br>            url:’<a href="http://www.google.cn/maps/vt/pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i345013117!3m8!2szh-CN!3scn!5e1105!12m4!1e68!2m2!1sset!2sRoadmap!4e0&#39;">http://www.google.cn/maps/vt/pb=!1m4!1m3!1i{z}!2i{x}!3i{y}!2m3!1e0!2sm!3i345013117!3m8!2szh-CN!3scn!5e1105!12m4!1e68!2m2!1sset!2sRoadmap!4e0&#39;</a><br>        })<br>    });<br><br>    // 创建地图<br>  var map = new ol.Map({<br>        layers: [<br>            googleMapLayer<br>        ],<br>        view: new ol.View({<br>            // 设置成都为地图中心<br>            center: [104.06, 30.67],<br>            projection: ‘EPSG:4326’,<br>            zoom: 10<br>        }),<br>        target: ‘googleMap’<br>  });<br></script><br><br>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"googleMap"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// google地图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> googleMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span></span><br><span class="line"><span class="actionscript">url:<span class="string">'http://www.google.cn/maps/vt/pb=!1m4!1m3!1i&#123;z&#125;!2i&#123;x&#125;!3i&#123;y&#125;!2m3!1e0!2sm!3i345013117!3m8!2szh-CN!3scn!5e1105!12m4!1e68!2m2!1sset!2sRoadmap!4e0'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="undefined">googleMapLayer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'googleMap'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>至此，关于通用瓦片地图加载的秘籍就介绍完毕，希望大家都掌握了。<br><br><br># 加载离线瓦片地图<br>其实离线瓦片地图和在线瓦片地图是一样的原理，都是瓦片，只是离线瓦片地图的存取方式，是由开发者自己来定义的，而在线瓦片地图则不一定。 在不理解原理的情况下，很多人拥有了离线瓦片，却不知道如何加载，所以这里单独列出一个小节来讲解。<br><br>在很早之前，我在github上放出了一个加载离线瓦片的地图demo，现在还是使用这个demo来讲解：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br><br>    // 地图设置中心，设置到成都，在本地离线地图 offlineMapTiles刚好有一张zoom为4的成都瓦片<br>    var center = ol.proj.transform([104.06667, 30.66667], ‘EPSG:4326’, ‘EPSG:3857’);<br><br>    //创建地图<br>    var map = new ol.Map({<br>        view: new ol.View({<br>            center: center,<br>            zoom: 4<br>        }),<br>        target: ‘map’<br>    });<br><br>    // 添加一个使用离线瓦片地图的层<br>    var offlineMapLayer = new ol.layer.Tile({<br>        source: new ol.source.XYZ({<br>            // 设置本地离线瓦片所在路径，由于例子里面只有一张瓦片，页面显示时就只看得到一张瓦片。<br>            url: ‘../src/05-04/offlineMapTiles/{z}/{x}/{y}.png’<br>        })<br>    });<br><br>    map.addLayer(offlineMapLayer);<br></script><br><br>只是演示效果，所以瓦片就只有1张。 如果放大或者缩小，就可能看不到地图瓦片了。 先看代码：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 地图设置中心，设置到成都，在本地离线地图 offlineMapTiles刚好有一张zoom为4的成都瓦片</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> center = ol.proj.transform([<span class="number">104.06667</span>, <span class="number">30.66667</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">//创建地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123; </span></span><br><span class="line"><span class="undefined">center: center,</span></span><br><span class="line"><span class="undefined">zoom: 4 </span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个使用离线瓦片地图的层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> offlineMapLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.XYZ(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置本地离线瓦片所在路径，由于例子里面只有一张瓦片，页面显示时就只看得到一张瓦片。</span></span></span><br><span class="line"><span class="actionscript">url: <span class="string">'../src/05-04/offlineMapTiles/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">map.addLayer(offlineMapLayer);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>代码很简单，就不再做任何说明，参照注释。 这个例子中唯一的瓦片图片相对路径是： <code>offlineMapTiles/4/12/6.png</code>。 在开发时，会考虑这样一个问题： 是先在代码里面写<code>url</code>，还是先在本地放好瓦片地图？ 我建议瓦片地图数据优先，而且很多瓦片地图都是工具下载的，量大，如果需要修改目录结构，会比较费事。相对的，修改<code>url</code>的代码明显就要简单很多。<br><br><code>url</code>必须根据瓦片地图存放路径来编写，比如这个例子里面，4表示的是层级，12表示的是x，6表示的是y，我们的<code>url</code>参数就写成： <code>{z}/{x}/{y}.png</code>。 如果瓦片地图都放在一个目录下，采用z-x-y.png的方式命名，那么<code>url</code>参数就得写成： <code>{z}-{x}-{y}.png</code>。<br><br>在上一节中，我们提到过，瓦片地图最主要的是要考虑瓦片的坐标系和分辨率，对于离线瓦片地图也同样成立。 在使用之前，你必须要了解清楚这一点，方能正确加载和使用。<br><br>## 常见问题<br><br>&gt; Q: 为什么本地有离线瓦片地图，但在网页中没有显示地图？<br>&gt; A: 存在多种原因可能导致这个问题的出现，你需要逐一检查：<br>&gt; <em> 打开开发者工具，检查一下代码是否有错误提示。<br>&gt; </em> 检查一下HTTP请求的瓦片地址是否正确。<br>&gt; <em> 检查一下离线瓦片地图，是否包含了当前地图显示层级的瓦片地图。<br>&gt; </em> 检查一下离线瓦片地图的整个区域，是否包含了当前地图设置的中心点。<br>&gt; <em> 检查一下地图使用的坐标系，是否正确。 OpenLayers 3默认使用的是mercator，而不是wgs84。所以如果中心点想设置为经度30度，纬度30度，就需要显示设置<code>projection: &#39;EPSG:4326&#39;</code>，或者使用<code>ol.proj.transform([30, 30], &#39;EPSG:4326&#39;, &#39;EPSG:3857&#39;)</code>进行转换。同一个坐标，不同的坐标系，位置可能截然不同。<br><br>&gt; Q: 为什么加载的地图有瓦片错位，拼接不上？<br>&gt; A: 检查一下离线瓦片地图的坐标系，是否和OpenLayers 3默认的坐标系不一致，如果不一致，请按照上一小节的处理方式处理。<br><br><br># 静态地图及应用<br><br>此处说的静态地图指没有经过地理投影什么的普通地图，比如一些规划图，室内建筑图，平面示意图等等，这些图一般都不会很大，但常用于一些演示系统中。 会涉及到一些简单的定位，标注等。 OpenLayers 3也充分考虑到了这样的需求，提供了对应的<code>source</code>类： <code>ol.source.ImageStatic</code>。 示例请看下面这个地图，显示的是成都熊猫基地的平面图：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br><br>    // 地图设置中心，设置到成都，在本地离线地图 offlineMapTiles刚好有一张zoom为4的成都瓦片<br>    var center = ol.proj.transform([104.06667, 30.66667], ‘EPSG:4326’, ‘EPSG:3857’);<br>    // 计算熊猫基地地图映射到地图上的范围，图片像素为 550</em>344，保持比例的情况下，把分辨率放大一些<br>    var extent = [center[0]- 550<em>1000/2, center[1]-344</em>1000/2, center[0]+550<em>1000/2, center[1]+344</em>1000/2];<br><br>    //创建地图<br>    var map = new ol.Map({<br>        view: new ol.View({<br>            center: center,<br>            zoom: 7<br>        }),<br>        target: ‘map’<br>    });<br><br>    // 加载熊猫基地静态地图层<br>    map.addLayer(new ol.layer.Image({<br>        source: new ol.source.ImageStatic({<br>            url: ‘../img/pandaBase.jpg’, // 熊猫基地地图<br>            imageExtent: extent     // 映射到地图的范围<br>        })<br>    }));<br></script><br><br>因为应用于OpenLayers 3中，所以地图可以放大缩小，具备相应的功能，对于演示而言，无疑加快了开发效率。 对应的代码如下：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 地图设置中心，设置到成都，在本地离线地图 offlineMapTiles刚好有一张zoom为4的成都瓦片</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> center = ol.proj.transform([<span class="number">104.06667</span>, <span class="number">30.66667</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 计算熊猫基地地图映射到地图上的范围，图片像素为 550*344，保持比例的情况下，把分辨率放大一些</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> extent = [center[<span class="number">0</span>]- <span class="number">550</span>*<span class="number">1000</span>/<span class="number">2</span>, center[<span class="number">1</span>]<span class="number">-344</span>*<span class="number">1000</span>/<span class="number">2</span>, center[<span class="number">0</span>]+<span class="number">550</span>*<span class="number">1000</span>/<span class="number">2</span>, center[<span class="number">1</span>]+<span class="number">344</span>*<span class="number">1000</span>/<span class="number">2</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">//创建地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123; </span></span><br><span class="line"><span class="undefined">center: center,</span></span><br><span class="line"><span class="undefined">zoom: 7</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 加载熊猫基地静态地图层</span></span></span><br><span class="line"><span class="actionscript">map.addLayer(<span class="keyword">new</span> ol.layer.Image(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.ImageStatic(&#123;</span></span><br><span class="line"><span class="actionscript">url: <span class="string">'../img/pandaBase.jpg'</span>, <span class="comment">// 熊猫基地地图</span></span></span><br><span class="line"><span class="actionscript">imageExtent: extent <span class="comment">// 映射到地图的范围</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>代码中有详细注释，可帮助理解，要应用静态地图，需要注意设置图片在地图中占据的<code>extent</code>。 如果没有这个设置，图片就不能和位置关联在一起，也就不能应用于OpenLayers 3中。 大家肯定非常关心<code>extent</code>的计算<code>[center[0]- 550*1000/2, center[1]-344*1000/2, center[0]+550*1000/2, center[1]+344*1000/2]</code>，为什么这样计算？ 这个地方我想让图片本身的大小和地理范围产生联系，图片的大小为550<em>344像素，在此基础上同比放大1000倍，作地理范围。当然也可以不用放大，直接作为地理范围，只是这样需要放大地图到很高的层级才能看到它。 有了这样的映射关系后，图片能保持长宽比不变，从而不变形。 为什么引入<code>center</code>，除以2相关的计算？ 这是一个简单计算，目的在于设置图片显示在地图中心。<br><br><br>把地图加载出来只是第一步，我们最重要的是在地图上定位，并处理相应的业务。比如我们希望在图片[390,145]像素位置添加一个活动图标表示这个地方有现场活动，就像下面这样：<br><br><div id="map2" style="width: 100%"></div><br><script type="text/javascript"><br><br>    // 地图设置中心，设置到成都，在本地离线地图 offlineMapTiles刚好有一张zoom为4的成都瓦片<br>    var center2 = ol.proj.transform([104.06667, 30.66667], ‘EPSG:4326’, ‘EPSG:3857’);<br>    // 计算熊猫基地地图映射到地图上的范围，图片像素为 550</em>344，保持比例的情况下，把分辨率放大一些<br>    var extent2 = [center[0]- 550<em>1000/2, center[1]-344</em>1000/2, center[0]+550<em>1000/2, center[1]+344</em>1000/2];<br><br>    //创建地图<br>    var map2 = new ol.Map({<br>        view: new ol.View({<br>            center: center,<br>            zoom: 7<br>        }),<br>        target: ‘map2’<br>    });<br><br>    // 加载熊猫基地静态地图层<br>    map2.addLayer(new ol.layer.Image({<br>        source: new ol.source.ImageStatic({<br>            url: ‘../img/pandaBase.jpg’, // 熊猫基地地图<br>            imageExtent: extent2    // 映射到地图的范围<br>        })<br>    }));<br><br>    var activityLayer = new ol.layer.Vector({<br>        source: new ol.source.Vector()<br>    });<br>    var activity = new ol.Feature({<br>        geometry: new ol.geom.Point([center[0]- 550<em>1000/2 + 390 </em> 1000, center[1]-344<em>1000/2 + (344 - 145) </em> 1000])<br>    })<br>    activity.setStyle(new ol.style.Style({<br>        image: new ol.style.Icon({<br>            src: ‘../img/flag_right.png’,<br>            anchor: [0, 1],<br>            scale: 0.2<br>        })<br>    }));<br>    activityLayer.getSource().addFeature(activity);<br>    map2.addLayer(activityLayer);<br></script><br><br>看到地图上的小旗帜没有，它就是新加上去的活动图标。 那么我们是如何做到的呢：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 地图设置中心，设置到成都，在本地离线地图 offlineMapTiles刚好有一张zoom为4的成都瓦片</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> center2 = ol.proj.transform([<span class="number">104.06667</span>, <span class="number">30.66667</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 计算熊猫基地地图映射到地图上的范围，图片像素为 550*344，保持比例的情况下，把分辨率放大一些</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> extent2 = [center[<span class="number">0</span>]- <span class="number">550</span>*<span class="number">1000</span>/<span class="number">2</span>, center[<span class="number">1</span>]<span class="number">-344</span>*<span class="number">1000</span>/<span class="number">2</span>, center[<span class="number">0</span>]+<span class="number">550</span>*<span class="number">1000</span>/<span class="number">2</span>, center[<span class="number">1</span>]+<span class="number">344</span>*<span class="number">1000</span>/<span class="number">2</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">//创建地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123; </span></span><br><span class="line"><span class="undefined">center: center,</span></span><br><span class="line"><span class="undefined">zoom: 7</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 加载熊猫基地静态地图层</span></span></span><br><span class="line"><span class="actionscript">map2.addLayer(<span class="keyword">new</span> ol.layer.Image(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.ImageStatic(&#123;</span></span><br><span class="line"><span class="actionscript">url: <span class="string">'../img/pandaBase.jpg'</span>, <span class="comment">// 熊猫基地地图</span></span></span><br><span class="line"><span class="actionscript">imageExtent: extent2<span class="comment">// 映射到地图的范围</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建一个用于放置活动图标的layer</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> activityLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建一个活动图标需要的Feature，并设置位置</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> activity = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point([center[<span class="number">0</span>]- <span class="number">550</span>*<span class="number">1000</span>/<span class="number">2</span> + <span class="number">390</span> * <span class="number">1000</span>, center[<span class="number">1</span>]<span class="number">-344</span>*<span class="number">1000</span>/<span class="number">2</span> + (<span class="number">344</span> - <span class="number">145</span>) * <span class="number">1000</span>])</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置Feature的样式，使用小旗子图标</span></span></span><br><span class="line"><span class="actionscript">activity.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span></span><br><span class="line"><span class="actionscript">src: <span class="string">'../img/flag_right.png'</span>,</span></span><br><span class="line"><span class="undefined">anchor: [0, 1],</span></span><br><span class="line"><span class="undefined">scale: 0.2</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加活动Feature到layer上，并把layer添加到地图中</span></span></span><br><span class="line"><span class="undefined">activityLayer.getSource().addFeature(activity);</span></span><br><span class="line"><span class="undefined">map2.addLayer(activityLayer);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>注释足够帮助大家理解代码意图，我想最关键的在于<code>activity</code>这个<code>feature</code>的位置为什么要这样计算： <code>[center[0]- 550*1000/2 + 390 * 1000, center[1]-344*1000/2 + (344 - 145) * 1000]</code>。 如果翻译成下面这样，你可能会更容易理解：<code>extentLeft+picX, extentTop+picY</code>，此处的<code>picX</code>和<code>picY</code>显然是需要在图片像素位置的基础上放大1000倍，才能对应于地理位置。 <code>[center[0]- 550*1000/2</code>对应的就是<code>extentLeft</code>, <code>center[1]-344*1000/2</code>对应的是<code>extentBottom</code>，并不是<code>extentTop</code>，所以我们要做一个简单的计算<code>(344 - 145) * 1000</code>，而不是直接用<code>145*1000</code>。<br><br>从图片的像素坐标转换为地图的地理坐标，关键在于通过像素大小，映射到一个地理的<code>extent</code>，希望能理解这个过程。 在此基础上，就能充分应用OpenLayers 3的功能了。<br><br><br>对于图片比较大的情况，可以自行切片，然后分片加载，从而拼成一整张地图，可按照上面的方法自行尝试，作为课后练习。<br><br># 加载WMS服务地图<br><br># 矢量地图<br><br>矢量图使用直线和曲线来描述图形，这些图形的元素是一些点、线、矩形、多边形、圆和弧线等等，它们都是通过数学公式计算获得的。由于矢量图形可通过公式计算获得，所以矢量图形文件体积一般较小。矢量图形最大的优点是无论放大、缩小或旋转等不会失真。在地图中存在着大量的应用，是地图数据中非常重要的组成部分。<br><br>为了便于存储，传递，使用，矢量地图会按照一定的格式来表达，比如常见的<code>GeoJSON</code>，<code>TopoJSON</code>，<code>GML</code>，<code>KML</code>，<code>ShapeFile</code>等等。 除了最后一个<code>ShapeFile</code>，其他几个格式的矢量地图OpenLayers 3都支持，使用起来也是非常的简单，下面这个地图就加载了<code>GeoJSON</code>格式的矢量地图。<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br><br>    //创建地图<br>    var map = new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({<br>                source: new ol.source.OSM()<br>            }),<br>            new ol.layer.Vector({<br>                source: new ol.source.Vector({<br>                    url: ‘../data/geojson/line-samples.geojson’,<br>                    format: new ol.format.GeoJSON()<br>                })<br>            })<br>        ],<br>        view: new ol.View({<br>            center: [-72.980624870461128, 48.161307640513321],<br>            zoom: 8,<br>            projection: ‘EPSG:4326’<br>        }),<br>        target: ‘map’<br>    });<br></script><br><br>代码非常简单：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">//创建地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 底图用Open Street Map 地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 再加载一个geojson的矢量地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">url: <span class="string">'../data/geojson/line-samples.geojson'</span>, <span class="comment">// 地图来源</span></span></span><br><span class="line"><span class="actionscript">format: <span class="keyword">new</span> ol.format.GeoJSON()<span class="comment">// 解析矢量地图的格式化类</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123; </span></span><br><span class="line"><span class="undefined">center: [-72.980624870461128, 48.161307640513321],</span></span><br><span class="line"><span class="undefined">zoom: 8,</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>注释对代码进行了很好的说明，但有两点需要进一步说明：<br><br><em> 加载矢量图使用的<code>source</code>是<code>ol.source.Vector</code>, layer是<code>ol.layer.Vector</code>，不要错误的使用。</em> 加载代码之所以这么简单，是因为OpenLayers 3内置了对应矢量地图格式的解析类，比如<code>ol.format.GeoJSON</code>。 它们都位于包<code>ol.format</code>下面，可以在API官方文档中查询得到。 如果是<code>shapefile</code>这种不支持的，则需要自己解析。 解析后，矢量地图都会转换为对应于OpenLayer<br>s 3中的<code>feature</code>。 所以，当加载完成后，可以通过<code>source</code>的<code>getFeatures</code>方法来获取所有的矢量图形。<br><em> 需要注意坐标系，因为<code>.geojson</code>文档里用的是和当前地图用的不一样的坐标系。<br><br>对于不同格式的矢量地图，会有相应的一些不同用法，下面就针对一些大家经常会遇到的问题，给出相应的实例，用以说明。<br><br><br><br># 获取加载后的所有feature<br>这是一个很多人会遇到的问题，因为在加载矢量地图后，需要对矢量地图做一些简单的查询，分析等。 但是经常会遇到获取不到加载后的<code>feature</code>的问题。 原因就在于获取的时机不对，因为矢量地图是异步加载的。 下面就看一下正确的获取所有<code>feature</code>的做法是什么：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><div>矢量地图Feature总数： <span id="count"></span></div><br><script type="text/javascript"><br><br>    //创建地图<br>    var map = new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({<br>                source: new ol.source.OSM()<br>            })<br>        ],<br>        view: new ol.View({<br>            center: [-72.980624870461128, 48.161307640513321],<br>            zoom: 8,<br>            projection: ‘EPSG:4326’<br>        }),<br>        target: ‘map’<br>    });<br><br>    var vectorLayer = new ol.layer.Vector({<br>        source: new ol.source.Vector({<br>            url: ‘../data/geojson/line-samples.geojson’,<br>            format: new ol.format.GeoJSON()<br>        })<br>    });<br><br>    var listenerKey = vectorLayer.getSource().on(‘change’, function(){<br>        if (vectorLayer.getSource().getState() === ‘ready’) {<br>            document.getElementById(‘count’).innerHTML = vectorLayer.getSource().getFeatures().length;<br>            vectorLayer.getSource().unByKey(listenerKey);<br>        }<br>    });<br><br>    map.addLayer(vectorLayer);<br></script><br><br>从图上可以看到，共有9个<code>feature</code>， 在地图下方的统计数据也是9。 下面看看代码是如何实现的：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>矢量地图Feature总数： <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"count"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">//创建地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123; </span></span><br><span class="line"><span class="undefined">center: [-72.980624870461128, 48.161307640513321],</span></span><br><span class="line"><span class="undefined">zoom: 8,</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> vectorLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">url: <span class="string">'../data/geojson/line-samples.geojson'</span>, </span></span><br><span class="line"><span class="actionscript">format: <span class="keyword">new</span> ol.format.GeoJSON()</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 因为是异步加载，所以要采用事件监听的方式来判定是否加载完成</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> listenerKey = vectorLayer.getSource().on(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">if</span> (vectorLayer.getSource().getState() === <span class="string">'ready'</span>) &#123;<span class="comment">// 判定是否加载完成</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'count'</span>).innerHTML = vectorLayer.getSource().getFeatures().length;</span></span><br><span class="line"><span class="actionscript">vectorLayer.getSource().unByKey(listenerKey); <span class="comment">// 注销监听器</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">map.addLayer(vectorLayer);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 如果在此处调用vectorLayer.getSource().getFeatures()是完全有可能获取不到任何Feature的，这是常犯错误</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>对于其他格式的矢量地图加载也需要这样编写代码，才能正确获取到加载完成的所有<code>feature</code>。<br><br><br># 坐标转换<br>坐标转换也是矢量地图经常会遇到的问题，比如当前地图用的是<code>EPSG:3857</code>，但是矢量地图用的是<code>EPSG:4326</code>，这样就需要进行坐标转换。 由于OpenLayers 3为我们内置了地图格式解析器，那么自然只能依靠它来处理。 上一节中使用的<code>.geojson</code>文件内的坐标使用的是wgs84坐标，那么如果我们地图使用<code>EPSG:3857</code>，该怎么来加载？<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br>    <script type="text/javascript" src="../src/js/zepto.min.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br><br>    //创建地图<br>    var map = new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({<br>                source: new ol.source.OSM()<br>            }),<br><br>        ],<br>        view: new ol.View({<br>            center: ol.proj.fromLonLat([-72.980624870461128, 48.161307640513321]),<br>            zoom: 8<br>        }),<br>        target: ‘map’<br>    });<br><br>    function addGeoJSON(src) {<br>        var layer = new ol.layer.Vector({<br>            source: new ol.source.Vector({<br>                features: (new ol.format.GeoJSON()).readFeatures(src, {<br>                    dataProjection: ‘EPSG:4326’,<br>                    featureProjection: ‘EPSG:3857’<br>                })<br>            })<br>        });<br>        map.addLayer(layer);<br>    }<br><br>    $.ajax({<br>        url: ‘../data/geojson/line-samples.geojson’,<br>        success: function(data, status) {<br>            addGeoJSON(data);<br>        }<br>    });<br></script><br><br>详细实现参见代码：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">//创建地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123; </span></span><br><span class="line"><span class="undefined">center: ol.proj.fromLonLat([-72.980624870461128, 48.161307640513321]),</span></span><br><span class="line"><span class="undefined">zoom: 8</span></span><br><span class="line"><span class="undefined">&#125;), </span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 加载矢量地图</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">addGeoJSON</span><span class="params">(src)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">features: (<span class="keyword">new</span> ol.format.GeoJSON()).readFeatures(src, &#123; <span class="comment">// 用readFeatures方法可以自定义坐标系</span></span></span><br><span class="line"><span class="actionscript">dataProjection: <span class="string">'EPSG:4326'</span>,<span class="comment">// 设定JSON数据使用的坐标系</span></span></span><br><span class="line"><span class="actionscript">featureProjection: <span class="string">'EPSG:3857'</span> <span class="comment">// 设定当前地图使用的feature的坐标系</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined">map.addLayer(layer);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 使用ajax获取矢量地图数据</span></span></span><br><span class="line"><span class="javascript">$.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">url: <span class="string">'../data/geojson/line-samples.geojson'</span>,</span></span><br><span class="line"><span class="actionscript">success: <span class="function"><span class="keyword">function</span><span class="params">(data, status)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 成功获取到数据内容后，调用方法添加到地图</span></span></span><br><span class="line"><span class="undefined">addGeoJSON(data);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>代码稍微麻烦了一点，是因为目前<code>ol.format.GeoJSON</code>的构造参数不支持设定创建<code>feature</code>的坐标系，如果要支持也并不麻烦，期望后续官网能够改进。<br><br>注意，该方法可以适用于其他几种矢量地图。<code>readFeatures</code>这个方法在内置的几个解析类中都有。<br><br><br><br><br><br># 样式设置<br>对矢量元素进行样式设置，OpenLayers3 支持两种方式，一种是直接给<code>feature</code>设置样式，一种是给<code>layer</code>设置样式。系统默认优先考虑<code>feature</code>的样式，如果没有，则使用<code>layer</code>的样式，还有一种情况是<code>layer</code>也没有设置样式，则会采用系统默认的样式。<br><br>对于矢量地图而言，要想修改样式也只有这两种途径可选。比如之前例子中使用的<code>GeoJSON</code>，如果要改变线条的颜色成下面这样，可以考虑在<code>layer</code>上设置样式：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br><br>    //创建地图<br>    var map = new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({<br>                source: new ol.source.OSM()<br>            })<br>        ],<br>        view: new ol.View({<br>            center: [-72.980624870461128, 48.161307640513321],<br>            zoom: 8,<br>            projection: ‘EPSG:4326’<br>        }),<br>        target: ‘map’<br>    });<br><br>    var vectorLayer = new ol.layer.Vector({<br>        source: new ol.source.Vector({<br>            url: ‘../data/geojson/line-samples.geojson’,<br>            format: new ol.format.GeoJSON()<br>        }),<br>        style: new ol.style.Style({<br>            stroke: new ol.style.Stroke({<br>                color: ‘red’,<br>                size: 1<br>            })<br>        })<br>    });<br><br>    map.addLayer(vectorLayer);<br></script><br><br>代码很简单：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">//创建地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123; </span></span><br><span class="line"><span class="undefined">center: [-72.980624870461128, 48.161307640513321],</span></span><br><span class="line"><span class="undefined">zoom: 8,</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> vectorLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">url: <span class="string">'../data/geojson/line-samples.geojson'</span>, </span></span><br><span class="line"><span class="actionscript">format: <span class="keyword">new</span> ol.format.GeoJSON()</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置样式，颜色为红色，线条粗细为1个像素</span></span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">size: 1</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">map.addLayer(vectorLayer);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>如果要在<code>feature</code>上设置样式，就必须先获取到所有加载的<code>feature</code>，然后依次设置，显然直接设置<code>layer</code>的样式，会在代码编写上更容易一些。<br><br>## 自带样式的矢量地图修改样式<br><br>有些矢量地图数据自带样式，比如<code>KML</code>格式的矢量地图，如果要修改样式，则相对比较麻烦。得分情况考虑：</em> 一种是所有矢量地图都不使用自带的样式；<br>* 一种是部分矢量地图不使用自带的样式。<br><br>对于第一种情况，则相对比较简单一些，只需要把<code>ol.format.KML</code>的构造参数<code>extractStyles</code>设置为<code>false</code>即可，然后为<code>layer</code>设定自定义的样式。<br><br>对于第二种情况，则相对麻烦一些，必须要读取加载的所有<code>feature</code>，并进行过滤，对符合条件的<code>feature</code>重新设置样式。<br><br><br><br># 图层叠加及管理<br>分层管理是GIS渲染引擎及其他图形系统常用的策略，为业务的应用提高了较大的适用性。比如更换地图底图，不能影响在上地图上添加的一些标注。如果把地图底图和标注分开，放在不同的图层上，就很容易解决这个问题。<br><br>有了图层的概念，自然需要对图层进行控制，比如增删改查等，图层之间的顺序，图层可见度等等。这些都是大家经常会遇到的问题。下面先来看一下三个图层叠加的情况：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><body><br>    <div id="map" style="width: 100%"></div><br>    <div> 显示/隐藏：<br>        <input type="checkbox" checked="checked" onclick="checkOsm(this);">底图<br>        <input type="checkbox" checked="checked" onclick="checkCircle(this);">圆<br>        <input type="checkbox" checked="checked" onclick="checkPoint(this);">点<br>    </div><br>    <div><br>        图层顺序：<br>        <input name="seq" type="radio" value="" onclick="upOsm(this);">底图最上<br>        <input name="seq" type="radio" value="" checked="checked" onclick="upCircle(this);">圆最上<br>        <input name="seq" type="radio" value="" onclick="upPoint(this);">点最上<br>    </div><br>    <script><br><br>        // 创建3个图层<br>        var osmLayer = new ol.layer.Tile({<br>            source: new ol.source.OSM()<br>        });<br>        var pointLayer = new ol.layer.Vector({<br>            source: new ol.source.Vector()<br>        });<br>        var circleLayer = new ol.layer.Vector({<br>            source: new ol.source.Vector()<br>        });<br><br>      var map = new ol.Map({<br>            layers: [osmLayer, pointLayer, circleLayer],<br>            view: new ol.View({<br>                center: [0, 0],<br>                zoom: 2<br>            }),<br>            target: ‘map’<br>      });<br><br>      // 添加点<br>      var point = new ol.Feature({<br>          geometry: new ol.geom.Point([0, 0])<br>      });<br>      point.setStyle(new ol.style.Style({<br>          image: new ol.style.Circle({<br>              radius: 1,<br>              fill: new ol.style.Fill({<br>                  color: ‘red’<br>              }),<br>              stroke: new ol.style.Stroke({<br>                  color: ‘red’,<br>                  size: 1<br>              })<br>          })<br>      }));<br>      pointLayer.getSource().addFeature(point);<br><br><br>      // 添加圆<br>      var circle = new ol.Feature({<br>          geometry: new ol.geom.Point([0, 0])<br>      });<br>      circle.setStyle(new ol.style.Style({<br>          image: new ol.style.Circle({<br>              radius: 10,<br>              stroke: new ol.style.Stroke({<br>                  color: ‘blue’,<br>                  size: 1<br>              })<br>          })<br>      }));<br>      circleLayer.getSource().addFeature(circle);<br><br>      function checkOsm(elem) {<br>          osmLayer.setVisible(elem.checked);<br>      }<br><br>      function checkPoint(elem) {<br>          pointLayer.setVisible(elem.checked);<br>      }<br><br>      function checkCircle(elem) {<br>          circleLayer.setVisible(elem.checked);<br>      }<br><br>      function upOsm (elem) {<br>          if (elem.checked) {<br>              osmLayer.setZIndex(3);<br>              circleLayer.setZIndex(circleLayer.getZIndex()-1);<br>              pointLayer.setZIndex(pointLayer.getZIndex()-1);<br>          }<br>      }<br><br>      function upCircle (elem) {<br>          if (elem.checked) {<br>              circleLayer.setZIndex(3);<br>              osmLayer.setZIndex(osmLayer.getZIndex()-1);<br>              pointLayer.setZIndex(pointLayer.getZIndex()-1);<br>          }<br>      }<br><br>      function upPoint(elem) {<br>          if (elem.checked) {<br>              pointLayer.setZIndex(3);<br>              osmLayer.setZIndex(osmLayer.getZIndex()-1);<br>              circleLayer.setZIndex(circleLayer.getZIndex()-1);<br>          }<br>      }<br><br>    </script><br></body><p>上面这个地图示范了显示和隐藏的控制，以及图层顺序的控制。可以勾选上面的复选框和单选框试试。具体实现，参见下面的代码：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span> 显示/隐藏：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">checked</span>=<span class="string">"checked"</span> <span class="attr">onclick</span>=<span class="string">"checkOsm(this);"</span> /&gt;</span>底图</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">checked</span>=<span class="string">"checked"</span> <span class="attr">onclick</span>=<span class="string">"checkCircle(this);"</span>/&gt;</span>圆</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">checked</span>=<span class="string">"checked"</span> <span class="attr">onclick</span>=<span class="string">"checkPoint(this);"</span>/&gt;</span>点</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">图层顺序：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"seq"</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">onclick</span>=<span class="string">"upOsm(this);"</span> /&gt;</span>底图最上</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"seq"</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">checked</span>=<span class="string">"checked"</span> <span class="attr">onclick</span>=<span class="string">"upCircle(this);"</span>/&gt;</span>圆最上</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"seq"</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">onclick</span>=<span class="string">"upPoint(this);"</span>/&gt;</span>点最上</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建3个图层</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> osmLayer = <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> pointLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circleLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 在地图上添加上面创建的三个图层，图层顺序自下而上，依次是osm，point，circle</span></span></span><br><span class="line"><span class="undefined">layers: [osmLayer, pointLayer, circleLayer],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">center: [0, 0],</span></span><br><span class="line"><span class="undefined">zoom: 2</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加点</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> point = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">  geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">0</span>, <span class="number">0</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  point.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">  image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">  radius: 1,</span></span><br><span class="line"><span class="actionscript">  fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">  color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">  &#125;),</span></span><br><span class="line"><span class="actionscript">  stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">  color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">  size: 1</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined">  pointLayer.getSource().addFeature(point);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加圆</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> circle = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">  geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">0</span>, <span class="number">0</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  circle.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">  image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">  radius: 10,</span></span><br><span class="line"><span class="actionscript">  stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">  color: <span class="string">'blue'</span>,</span></span><br><span class="line"><span class="undefined">  size: 1</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined">  circleLayer.getSource().addFeature(circle);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 隐藏显示osm图层</span></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">checkOsm</span><span class="params">(elem)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">  osmLayer.setVisible(elem.checked);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 隐藏显示point图层</span></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">checkPoint</span><span class="params">(elem)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">  pointLayer.setVisible(elem.checked);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 隐藏显示circle图层</span></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">checkCircle</span><span class="params">(elem)</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">  circleLayer.setVisible(elem.checked);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 置顶osm图层到最上面</span></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">upOsm</span> <span class="params">(elem)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">if</span> (elem.checked) &#123;</span></span><br><span class="line"><span class="undefined">  osmLayer.setZIndex(3);</span></span><br><span class="line"><span class="undefined">  circleLayer.setZIndex(circleLayer.getZIndex()-1);</span></span><br><span class="line"><span class="undefined">  pointLayer.setZIndex(pointLayer.getZIndex()-1);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 置顶circle图层到最上面</span></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">upCircle</span> <span class="params">(elem)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">if</span> (elem.checked) &#123;</span></span><br><span class="line"><span class="undefined">  circleLayer.setZIndex(3);</span></span><br><span class="line"><span class="undefined">  osmLayer.setZIndex(osmLayer.getZIndex()-1);</span></span><br><span class="line"><span class="undefined">  pointLayer.setZIndex(pointLayer.getZIndex()-1);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 置顶point图层到最上面</span></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">upPoint</span><span class="params">(elem)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">if</span> (elem.checked) &#123;</span></span><br><span class="line"><span class="undefined">  pointLayer.setZIndex(3);</span></span><br><span class="line"><span class="undefined">  osmLayer.setZIndex(osmLayer.getZIndex()-1);</span></span><br><span class="line"><span class="undefined">  circleLayer.setZIndex(circleLayer.getZIndex()-1);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>简而言之，就是可以利用方法<code>setVisible</code>和<code>setZIndex</code>来控制图层，满足80%的这种需求。 除此之外，大家也可以使用很早之前使用的一种方式来实现管理，即删除/添加图层，参见<a href="05-02.md">最简单的加载在线地图</a>。</p><h1 id="openlayers3瓦片加载的源码浅析与小结"><a href="#openlayers3瓦片加载的源码浅析与小结" class="headerlink" title="openlayers3瓦片加载的源码浅析与小结"></a>openlayers3瓦片加载的源码浅析与小结</h1><p><strong>–感谢作者：老羽 (QQ：274103592, 邮箱：<a href="mailto:michael.zy@163.com" target="_blank" rel="noopener">michael.zy@163.com</a>, 简书：<a href="http://www.jianshu.com/users/261606a3714c/latest_articles" target="_blank" rel="noopener">老羽</a> )</strong></p><h2 id="一、类图与逻辑"><a href="#一、类图与逻辑" class="headerlink" title="一、类图与逻辑"></a>一、类图与逻辑</h2><p><img src="../img/ol.png" alt="ol-tilerender.png"></p><p>上图中列了关于瓦片图层加载相关的重要方法。</p><ol><li>Map对象初始化时根据options.renderer创建ol.renderer.Map的实例，默认是ol.renderer.canvas.Map；</li><li>ol.render.canvas.Map实现了抽象方法createLayerRenderer，这是一个简单工厂，根据不同的图层创建对应的ol.renderer.Layer。其中ol.layer.Tile对应的就是ol.renderer.canvas.TileLayer；</li><li>ol.renderer.canvas.TileLayer.prepareFrame调用source对应的<br>TileGrid.getTileRangeForExtentAndResolution获取可视范围内的瓦片范围，并循环遍历加载瓦片；</li><li>TileGrid在初始化时就计算出了对应layer的所有瓦片范围：<ol><li>calculateTileRanges_-》循环遍历resolutions_，调用<br>getTileRangeForExtentAndZ，根据extent计算瓦片范围；</li><li>getTileRangeForExtentAndResolution计算瓦片的范围：</li></ol></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ol.tilegrid.TileGrid.prototype.getTileRangeForExtentAndResolution = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  extent, resolution, opt_tileRange</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> tileCoord = ol.tilegrid.TileGrid.tmpTileCoord_;</span><br><span class="line">  <span class="comment">// 根据extent的左下角的计算瓦片坐标；</span></span><br><span class="line">  <span class="keyword">this</span>.getTileCoordForXYAndResolution_(</span><br><span class="line">    extent[<span class="number">0</span>], extent[<span class="number">1</span>], resolution, <span class="literal">false</span>, tileCoord);</span><br><span class="line">  <span class="keyword">var</span> minX = tileCoord[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">var</span> minY = tileCoord[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// 根据extent的右上角的计算瓦片坐标；</span></span><br><span class="line">   <span class="keyword">this</span>.getTileCoordForXYAndResolution_(</span><br><span class="line">      extent[<span class="number">2</span>], extent[<span class="number">3</span>], resolution, <span class="literal">true</span>, tileCoord);</span><br><span class="line">  <span class="comment">// 得到某个resolution级别下的瓦片范围（左下角瓦片坐标 - 右上角瓦片坐标）</span></span><br><span class="line">  <span class="keyword">return</span> ol.TileRange.createOrUpdate(</span><br><span class="line">    minX, tileCoord[<span class="number">1</span>], minY, tileCoord[<span class="number">2</span>], opt_tileRange);</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据extent左下角及右上角的坐标-origin后得到地图的长宽 / resolution得到像素值；</span></span><br><span class="line"><span class="comment">// 然后 / tileSize 得到需要多少张瓦片；</span></span><br><span class="line"><span class="comment">// 当计算extent右上角的瓦片坐标时，因为瓦片坐标是从0开始计算，当瓦片数量为例如1.5此类小数时，</span></span><br><span class="line"><span class="comment">// 应该是2张瓦片，从0开始计算，那么XY就应该向下取整，取1；0，1两张瓦片；</span></span><br><span class="line">ol.tilegrid.TileGrid.prototype.getTileCoordForXYAndResolution_ = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  x, y, resolution, reverseIntersectionPolicy, opt_tileCoord</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> z = <span class="keyword">this</span>.getZForResolution(resolution);</span><br><span class="line">  <span class="keyword">var</span> scale = resolution / <span class="keyword">this</span>.getResolution(z);</span><br><span class="line">  <span class="keyword">var</span> origin = <span class="keyword">this</span>.getOrigin(z);</span><br><span class="line">  <span class="keyword">var</span> tileSize = ol.size.toSize(<span class="keyword">this</span>.getTileSize(z), <span class="keyword">this</span>.tmpSize_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> adjustX = reverseIntersectionPolicy ? <span class="number">0.5</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> adjustY = reverseIntersectionPolicy ? <span class="number">0</span> : <span class="number">0.5</span>;</span><br><span class="line">  <span class="keyword">var</span> xFromOrigin = <span class="built_in">Math</span>.floor((x - origin[<span class="number">0</span>]) / resolution + adjustX);</span><br><span class="line">  <span class="keyword">var</span> yFromOrigin = <span class="built_in">Math</span>.floor((y - origin[<span class="number">1</span>]) / resolution + adjustY);</span><br><span class="line">  <span class="keyword">var</span> tileCoordX = scale * xFromOrigin / tileSize[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> tileCoordY = scale * yFromOrigin / tileSize[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (reverseIntersectionPolicy) &#123;</span><br><span class="line">    tileCoordX = <span class="built_in">Math</span>.ceil(tileCoordX) - <span class="number">1</span>;</span><br><span class="line">    tileCoordY = <span class="built_in">Math</span>.ceil(tileCoordY) - <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    tileCoordX = <span class="built_in">Math</span>.floor(tileCoordX);</span><br><span class="line">    tileCoordY = <span class="built_in">Math</span>.floor(tileCoordY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ol.tilecoord.createOrUpdate(z, tileCoordX, tileCoordY, opt_tileCoord);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="二、各种瓦片加载的小结"><a href="#二、各种瓦片加载的小结" class="headerlink" title="二、各种瓦片加载的小结"></a>二、各种瓦片加载的小结</h2><p>通过上述分析后，应该能较好的理解瓦片的坐标是如何计算的，当应用到不同的地图瓦片加载时就可以得心应手。以下通过不同的几种类型继续说明瓦片计算的方式：</p><h3 id="1、TMS瓦片加载"><a href="#1、TMS瓦片加载" class="headerlink" title="1、TMS瓦片加载"></a>1、TMS瓦片加载</h3><p>先看看TMS瓦片的规则，origin在左下角，X轴从左至右递增，Y轴从下往上递增（先计算左下角，然后计算右上角）。<br><img src="../img/ogc-tms.png" alt="TMS瓦片规则"></p><p>而TileGrid设置origin为ol.extent.getBottomLeft(extent)后，规则也是从左下角到右上角，X轴从左至右递增，Y轴从下往上递增，与TMS规则是完全一致的，参考代码与参考效果如下：       </p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> resolutions = [];</span><br><span class="line"><span class="keyword">var</span> tileSize = <span class="number">256</span>;</span><br><span class="line"><span class="keyword">var</span> extent = [<span class="number">12665080.52765571</span>, <span class="number">2550703.6338763316</span>, <span class="number">12725465.780000998</span>, <span class="number">2601457.820657688</span>]; <span class="comment">//深圳地区</span></span><br><span class="line"><span class="keyword">var</span> projection = <span class="keyword">new</span> ol.proj.<span class="keyword">get</span>(<span class="string">"EPSG:3857"</span>);</span><br><span class="line"><span class="keyword">var</span> projectionExtent = projection.getExtent();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">19</span>; i++) &#123;</span><br><span class="line">  resolutions[i] = Math.pow(<span class="number">2</span>, <span class="number">18</span> - i);</span><br><span class="line">&#125;            </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tilegrid = <span class="keyword">new</span> ol.tilegrid.TileGrid(&#123;</span><br><span class="line">  origin: ol.extent.getBottomLeft(projectionExtent),</span><br><span class="line">  resolutions: resolutions,</span><br><span class="line">  extent: projectionExtent,<span class="comment">//extent,</span></span><br><span class="line">  tileSize: [<span class="number">256</span>, <span class="number">256</span>],</span><br><span class="line">&#125;);         </span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.<span class="built_in">Map</span>(&#123;</span><br><span class="line">  target: <span class="string">"map"</span>,</span><br><span class="line">  layers: [</span><br><span class="line">    <span class="comment">// 调试瓦片</span></span><br><span class="line">    <span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">      source: <span class="keyword">new</span> ol.source.TileDebug(&#123;</span><br><span class="line">        projection: projection,</span><br><span class="line">        tileGrid: tilegrid,</span><br><span class="line">        tileSize: [<span class="number">256</span>, <span class="number">256</span>],</span><br><span class="line">        extent :  projectionExtent,</span><br><span class="line">        wrapX: <span class="keyword">false</span></span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  view: <span class="keyword">new</span> ol.View(&#123;</span><br><span class="line">    projection: projection,</span><br><span class="line">    center: [<span class="number">12697184.079535482</span>, <span class="number">2563239.3065151004</span>],<span class="comment">//深圳</span></span><br><span class="line">    resolutions: resolutions,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;);</span><br><span class="line">map.getView().setZoom(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><img src="../img/tms-demo.png" alt="示意图"></p><p>假如上面代码中，我想只显示深圳地区的瓦片，其余的瓦片不显示，这种场景是很普遍的，那么代码调整如下：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var tilegrid = new ol.tilegrid.TileGrid(&#123;</span><br><span class="line"><span class="symbol">  origin:</span> ol.extent.getBottomLeft(projectionExtent),  <span class="comment">//origin位置不能变！！！！！！</span></span><br><span class="line"><span class="symbol">  resolutions:</span> resolutions,</span><br><span class="line"><span class="symbol">  extent:</span>  extent,<span class="comment">//projectionExtent //设置extent为深圳片区的extent；</span></span><br><span class="line"><span class="symbol">  tileSize:</span> [<span class="number">256</span>, <span class="number">256</span>],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ..................</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调试瓦片</span></span><br><span class="line">new ol.layer.Tile(&#123;</span><br><span class="line"><span class="symbol">  source:</span> new ol.source.TileDebug(&#123;</span><br><span class="line"><span class="symbol">    projection:</span> projection,</span><br><span class="line"><span class="symbol">    tileGrid:</span> tilegrid,</span><br><span class="line"><span class="symbol">    extent:</span> extent,<span class="comment">//projectionExtent //设置extent为深圳片区的extent；</span></span><br><span class="line"><span class="symbol">    wrapX:</span> false</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="2、WMTS瓦片加载"><a href="#2、WMTS瓦片加载" class="headerlink" title="2、WMTS瓦片加载"></a>2、WMTS瓦片加载</h3><p>WMTS规则如下，origin在左上角，X轴从左至右递增，Y轴是从上往下递增（先计算左上角，然后计算右下角）</p><p><img src="../img/ogc-wmts.png" alt="WMTS规则"></p><p>那么将tileGrid设置origin为ol.extent.getTopLeft(projectionExtent), 但是TileGrid始终都是先计算左下角的瓦片坐标，然后计算右上角的瓦片坐标，因此Y轴是相反的。那么修改Y轴坐标就可以得到正确值：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tilegrid = <span class="keyword">new</span> ol.tilegrid.TileGrid(&#123;</span><br><span class="line">  origin: ol.extent.getTopLeft(projectionExtent),  <span class="comment">// WMTS Origin在左上角，origin位置不能变；</span></span><br><span class="line">  resolutions: resolutions,</span><br><span class="line">  extent: extent,</span><br><span class="line">  tileSize: [<span class="number">256</span>, <span class="number">256</span>],</span><br><span class="line">&#125;);</span><br><span class="line">        </span><br><span class="line"><span class="comment">// 其余代码略.....</span></span><br><span class="line"><span class="keyword">new</span> ol.layer.Tile(&#123;</span><br><span class="line">  source: <span class="keyword">new</span> ol.source.TileImage(&#123;</span><br><span class="line">    projection: projection,</span><br><span class="line">    tileGrid: tilegrid(),</span><br><span class="line">    tileUrlFunction: <span class="function"><span class="keyword">function</span> <span class="params">(tileCoord, pixelRatio, proj)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!tileCoord) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> z = tileCoord[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">var</span> x = tileCoord[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">var</span> y = -tileCoord[<span class="number">2</span>] - <span class="number">1</span>; <span class="comment">// y轴取反，-1目的是为了从0开始计数；</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>; <span class="comment">// 自行设置URL ，请注意 WMTS中用TileRow标识Y，用TileCol表示X；</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="3、百度地图瓦片加载"><a href="#3、百度地图瓦片加载" class="headerlink" title="3、百度地图瓦片加载"></a>3、百度地图瓦片加载</h3><p>百度瓦片片规则如下：Origin在[0,0]，X轴从左至右递增，Y轴从下往上递增（从左下角到右上角）。</p><p><img src="../img/baidu-tile.png" alt="Paste_Image.png"></p><p>从百度的瓦片规则看出来，与TileGrid的规则是完全一致，将origin设置为[0,0]即可。参考代码如下：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> tilegrid = <span class="keyword">new</span> ol.tilegrid.TileGrid(&#123;</span><br><span class="line">   origin: [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">   resolutions: resolutions,</span><br><span class="line">   extent: extent,<span class="comment">//projectionExtent,</span></span><br><span class="line">   tileSize: [<span class="number">256</span>, <span class="number">256</span>],</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tilesource = <span class="keyword">new</span> ol.source.TileImage(&#123;</span><br><span class="line">   projection: projection,</span><br><span class="line">   tileGrid: tilegrid,</span><br><span class="line">   tileUrlFunction: <span class="function"><span class="keyword">function</span> <span class="params">(xyz, obj1, obj2)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (!xyz) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">var</span> z = xyz[<span class="number">0</span>]+ <span class="number">11</span>; <span class="comment">// 从第11级开始加载；深圳地区；</span></span><br><span class="line">     <span class="keyword">var</span> x = xyz[<span class="number">1</span>];</span><br><span class="line">     <span class="keyword">var</span> y = xyz[<span class="number">2</span>];</span><br><span class="line">     <span class="keyword">if</span> (x &lt; <span class="number">0</span>) &#123;</span><br><span class="line">       x = <span class="string">"M"</span> + (-x);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (y &lt; <span class="number">0</span>) &#123;</span><br><span class="line">       y = <span class="string">"M"</span> + (-y);</span><br><span class="line">     &#125;                    </span><br><span class="line">     <span class="keyword">return</span> <span class="string">"http://online3.map.bdimg.com/tile/?qt=tile&amp;x="</span> + x + <span class="string">"&amp;y="</span> + y + <span class="string">"&amp;z="</span> + z + <span class="string">"&amp;styles=pl&amp;udt=20141119&amp;scaler=1"</span>;                   </span><br><span class="line">   &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p><h3 id="4、腾讯地图瓦片加载"><a href="#4、腾讯地图瓦片加载" class="headerlink" title="4、腾讯地图瓦片加载"></a>4、腾讯地图瓦片加载</h3><p>腾讯地图完全遵守TMS规则，地图投影坐标系采用Web Mercator投影，最小缩放级别为第4级。参考代码如下：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QQ地图完全遵守TMS规则;</span></span><br><span class="line"><span class="keyword">var</span> tileGrid = <span class="keyword">new</span> ol.tilegrid.TileGrid(&#123;</span><br><span class="line">  resolutions: resolutions3857,</span><br><span class="line">  tileSize: [<span class="number">256</span>, <span class="number">256</span>],</span><br><span class="line">  extent: projection3857Extent,</span><br><span class="line">  origin: ol.extent.getBottomLeft(projection3857Extent), <span class="comment">// Origin左下角</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tilesource = <span class="keyword">new</span> ol.source.TileImage(&#123;</span><br><span class="line">  tileUrlFunction: <span class="function"><span class="keyword">function</span> <span class="params">(xyz, obj1, obj2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!xyz) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> z = xyz[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> x = xyz[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">var</span> y = xyz[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"http://rt1.map.gtimg.com/realtimerender?z="</span> + z + <span class="string">"&amp;x="</span> + x + <span class="string">"&amp;y="</span> + y + <span class="string">"&amp;type=vector&amp;style=0&amp;v=1.1.2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  projection: projection3857,</span><br><span class="line">  tileGrid : tileGrid</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p></em></em></em>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Source和Layer&quot;&gt;&lt;a href=&quot;#Source和Layer&quot; class=&quot;headerlink&quot; title=&quot;Source和Layer&quot;&gt;&lt;/a&gt;Source和Layer&lt;/h1&gt;&lt;p&gt;在前面的例子中，已经对&lt;code&gt;Source&lt;/code&gt;和&lt;code&gt;Layer&lt;/code&gt;有所了解了。比如我们加载了Open Street Map的地图。然而世界上的地图并不只有Open Street Map，还有很多其他的地图，比如Google地图，天地图，高德地图，百度地图等。如果OpenLayers支持的地图来源越多，就会越适用，越强大。除了加载基本的地图之外，GIS还需要加载很多其他的信息，比如街道名称，商店名称，公交站点，道路等等。那么在OpenLayers 3中，具体该如何把这些添加在地图上呢？&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 动画</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch11/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch11/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:09:04.201Z</updated>
    
    <content type="html"><![CDATA[<h1 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h1><p>在OpenLayers 3中，动画是随处可见的，比如平移地图时，地图移动会有惯性，停止移动后，还会继续沿着之前的方向移动一会。 比如下面这个地图具有回到原始点的功能，一个是有动画效果的，一个是没有动画效果的。</p><a id="more"></a><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><p><input type="button" value="回到原点-不带动画" onclick="backNoAnim()"></p><p><input type="button" value="回到原点-带动画" onclick="backWithAnim()"></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    function backNoAnim() {    map.getView().setCenter(ol.proj.transform([104, 30], 'EPSG:4326', 'EPSG:3857'));    }    function backWithAnim() {        var pan = ol.animation.pan({      duration: 2000,      source: map.getView().getCenter()    });    map.beforeRender(pan);    map.getView().setCenter(ol.proj.transform([104, 30], 'EPSG:4326', 'EPSG:3857'));    }</script><p>先把地图移动到北京，再点击下方的两个按钮，感受一下带动画，和不带动画的差别，绝大多数人还是会喜欢带动画的。 无疑，动画具有很大的吸引力。 本章节将把你带入OpenLayers 3的动画世界，让你也能应用动画效果，做出漂亮的效果。</p><h1 id="动画简单应用"><a href="#动画简单应用" class="headerlink" title="动画简单应用"></a>动画简单应用</h1><p>前面那个回到原点的动画，使用了OpenLayers 3内置的动画效果，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--增加两个按钮，一个演示不带动画，一个演示带动画--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"回到原点-不带动画"</span> <span class="attr">onclick</span>=<span class="string">"backNoAnim()"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"回到原点-带动画"</span> <span class="attr">onclick</span>=<span class="string">"backWithAnim()"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 不带动画的实现</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">backNoAnim</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    map.getView().setCenter(ol.proj.transform([<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>));</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 带动画的实现</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">backWithAnim</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 注意： 应用内置的动画，实现平移动画</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> pan = ol.animation.pan(&#123;</span></span><br><span class="line"><span class="undefined">      duration: 2000,</span></span><br><span class="line"><span class="undefined">      source: map.getView().getCenter()</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 注意： 使用beforeRender来添加</span></span></span><br><span class="line"><span class="undefined">    map.beforeRender(pan);</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 然后才是重新设置地图中心点到原来的位置</span></span></span><br><span class="line"><span class="actionscript">    map.getView().setCenter(ol.proj.transform([<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>));</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>关键的代码始终在最后，结合注释，应该可以理解。 我们使用的内置动画是<code>ol.animation.pan</code>，用于平移动画，更详细的信息请参考<a href="http://openlayers.org/en/v3.13.1/apidoc/ol.animation.html#.pan" target="_blank" rel="noopener">官网API</a>。 可以看到它是一个函数，返回一个<code>ol.PreRenderFunction</code>，添加到<code>ol.Map</code>，从而在渲染的时候使用，实现动画。 </p><p>除了上面应用的动画之外，还有一些内置的动画，都在<code>ol.animation</code>里面，从官网API可以看到，包括：</p><ul><li><code>ol.animation.bounce</code>: 来回弹。</li><li><code>ol.animation.pan</code>: 平移。</li><li><code>ol.animation.rotate</code>: 旋转。</li><li><code>ol.animation.zoom</code>: 缩放。</li></ul><p>这些动画都可以尝试，或许就有你需要的。 </p><h1 id="动画高阶应用"><a href="#动画高阶应用" class="headerlink" title="动画高阶应用"></a>动画高阶应用</h1><p>虽然内置动画并不多，但是细心的同学已经发现了内置动画有个参数<code>easing</code>，这是一个强大的参数，因为可以让开发者自定义动画实现，从而实现动画效果的扩展。 其实已经内置了一些相关的实现，在<code>ol.easing</code>里面，涉及到一些常用的效果，包括：</p><ul><li><code>ol.easing.easeIn</code>: 加速</li><li><code>ol.easing.easeOut</code>: 减速</li><li><code>ol.easing.inAndOut</code>: 先加速再减速</li><li><code>ol.easing.linear</code>: 匀速</li><li><code>ol.easing.upAndDown</code>: 和inAndOut类似</li></ul><p>在前面的地图的基础上修改一下，让大家体验一下不同的动画的效果：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><p><select id="easing-type"><br>    <option>easeIn</option><br>    <option>easeOut</option><br>    <option>inAndOut</option><br>    <option>linear</option><br>    <option>upAndDown</option><br></select></p><p><input type="button" value="回到原点" onclick="backWithAnim();"></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    function backNoAnim() {    map.getView().setCenter(ol.proj.transform([104, 30], 'EPSG:4326', 'EPSG:3857'));    }    function getEasing() {        var typeSelect = document.getElementById('easing-type');        var easing = typeSelect.options[typeSelect.selectedIndex].text;        if (easing === 'easeIn') {            return ol.easing.easeIn;        } else if (easing === 'easeOut') {            return ol.easing.easeOut;        } else if (easing === 'inAndOut') {            return ol.easing.inAndOut;        } else if (easing === 'linear') {            return ol.easing.linear;        } else if (easing === 'upAndDown') {            return ol.easing.upAndDown;        }     }    function backWithAnim() {        var pan = ol.animation.pan({      duration: 2000,      source: map.getView().getCenter(),      easing: getEasing()    });    map.beforeRender(pan);    map.getView().setCenter(ol.proj.transform([104, 30], 'EPSG:4326', 'EPSG:3857'));    }</script><p>尝试完所有的动画方式后，可以看一下其实现代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--添加动画效果选择项--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span> = <span class="string">"easing-type"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">option</span>&gt;</span>easeIn<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">option</span>&gt;</span>easeOut<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">option</span>&gt;</span>inAndOut<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">option</span>&gt;</span>linear<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">option</span>&gt;</span>upAndDown<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"回到原点"</span> <span class="attr">onclick</span>=<span class="string">"backWithAnim()"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 根据选择项，返回对应的动画，供下面的backWithAnim函数使用</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">getEasing</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> typeSelect = <span class="built_in">document</span>.getElementById(<span class="string">'easing-type'</span>);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> easing = typeSelect.options[typeSelect.selectedIndex].text;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">if</span> (easing === <span class="string">'easeIn'</span>) &#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> ol.easing.easeIn;</span></span><br><span class="line"><span class="actionscript">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (easing === <span class="string">'easeOut'</span>) &#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> ol.easing.easeOut;</span></span><br><span class="line"><span class="actionscript">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (easing === <span class="string">'inAndOut'</span>) &#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> ol.easing.inAndOut;</span></span><br><span class="line"><span class="actionscript">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (easing === <span class="string">'linear'</span>) &#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> ol.easing.linear;</span></span><br><span class="line"><span class="actionscript">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (easing === <span class="string">'upAndDown'</span>) &#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> ol.easing.upAndDown;</span></span><br><span class="line"><span class="undefined">&#125; </span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">backWithAnim</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> pan = ol.animation.pan(&#123;</span></span><br><span class="line"><span class="undefined">      duration: 2000,</span></span><br><span class="line"><span class="undefined">      source: map.getView().getCenter(),</span></span><br><span class="line"><span class="actionscript">      easing: getEasing()<span class="comment">// 设置对应选择的动画</span></span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">    map.beforeRender(pan);</span></span><br><span class="line"><span class="actionscript">    map.getView().setCenter(ol.proj.transform([<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>));</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>通过上面这种方法，我们完全可以自定义动画函数，通过官网API文档可知，这些函数有一个参数<code>t</code>，范围在0-1之间，然后函数返回一个0-1之间的数。 结合动画业务来看，虽然官网没有说明参数表示什么意思，但是我们可以猜测它就是时间，返回的值应该目标达成比。 下面我们自己来实现一个sin曲线式的动画：</p><p><div id="map2" style="width: 100%"></div></p><p><input type="button" value="回到原点" onclick="backWithAnim2();"></p><script type="text/javascript">    var map2 = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map2',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // sin曲线动画    function sin(t) {        // 使用sin曲线公式        return Math.sin(t * Math.PI / 2);    }    function backWithAnim2() {        var pan = ol.animation.pan({      duration: 2000,      source: map2.getView().getCenter(),      easing: sin    });    map2.beforeRender(pan);    map2.getView().setCenter(ol.proj.transform([104, 30], 'EPSG:4326', 'EPSG:3857'));    }</script><p>速度一开始会快一点，然后慢下来， 对应的代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"回到原点"</span> <span class="attr">onclick</span>=<span class="string">"backWithAnim2();"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// sin曲线动画</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">sin</span><span class="params">(t)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 使用sin曲线公式</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">return</span> <span class="built_in">Math</span>.sin(t * <span class="built_in">Math</span>.PI / <span class="number">2</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">backWithAnim2</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> pan = ol.animation.pan(&#123;</span></span><br><span class="line"><span class="undefined">      duration: 2000,</span></span><br><span class="line"><span class="undefined">      source: map2.getView().getCenter(),</span></span><br><span class="line"><span class="actionscript">      easing: sin <span class="comment">// 应用sin曲线动画</span></span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">    map2.beforeRender(pan);</span></span><br><span class="line"><span class="actionscript">    map2.getView().setCenter(ol.proj.transform([<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>));</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h1 id="利用postcompose事件做动画"><a href="#利用postcompose事件做动画" class="headerlink" title="利用postcompose事件做动画"></a>利用postcompose事件做动画</h1><p>前面的内置动画，几乎都是和地图浏览相关的，很多时候我们有更多的动画需求，在此向大家介绍另一种可以做出动画的方式。 那就是利用<code>ol.Map</code>的<code>postcompose</code>事件，这个事件在地图渲染时都会触发，而我们只要改变地图上的某个<code>feature</code>或者<code>layer</code>或者其他任何东西，就会触发重新渲染。 如果利用这个原理，我们不断的改变<code>feature</code>的样式，就会触发<code>postcompose</code>，在这个事件的监听器里再改变<code>feature</code>的样式，就又会触发<code>postcompose</code>，从而一只循环下去，出现动画效果。  比如像下面这样：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var layer = new ol.layer.Vector({        source: new ol.source.Vector()    })    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          }),          layer        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    var circle = new ol.Feature({        geometry: new ol.geom.Point(ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'))    });    circle.setStyle(new ol.style.Style({        image: new ol.style.Circle({            radius: 0,            stroke: new ol.style.Stroke({                color: 'red',                size: 1            })        })    }));    layer.getSource().addFeature(circle);    var radius = 0;    map.on('postcompose', function(){        radius++;        radius = radius % 20;        circle.setStyle(new ol.style.Style({            image: new ol.style.Circle({                radius: radius,                stroke: new ol.style.Stroke({                    color: 'red',                    size: 1                })            })        }));    })</script><p>地图中间的小圆圈，不断的重复变大动画，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;),</span></span><br><span class="line"><span class="undefined">  layer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circle = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>))</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript">circle.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 0,</span></span><br><span class="line"><span class="actionscript">stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">size: 1</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined">layer.getSource().addFeature(circle);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 关键的地方在此：监听postcompose事件，在里面重新设置circle的样式</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> radius = <span class="number">0</span>;</span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'postcompose'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 增大半径，最大20</span></span></span><br><span class="line"><span class="undefined">radius++;</span></span><br><span class="line"><span class="undefined">radius = radius % 20;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置样式</span></span></span><br><span class="line"><span class="actionscript">circle.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: radius,</span></span><br><span class="line"><span class="actionscript">stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">size: 1</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用过<code>Javascript</code>做动画的同学可能会想，为什么弄的这么麻烦，直接用<code>requestAnimationFrame</code>不就行了？ 是的，我也这么认为，这个会比较简单，但如果你非要用OpenLayers 3的事件，也就可以照着上面的方式来实现动画了。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;动画&quot;&gt;&lt;a href=&quot;#动画&quot; class=&quot;headerlink&quot; title=&quot;动画&quot;&gt;&lt;/a&gt;动画&lt;/h1&gt;&lt;p&gt;在OpenLayers 3中，动画是随处可见的，比如平移地图时，地图移动会有惯性，停止移动后，还会继续沿着之前的方向移动一会。 比如下面这个地图具有回到原始点的功能，一个是有动画效果的，一个是没有动画效果的。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 介绍</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch01/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch01/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:06:44.153Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OpenLayers-3-介绍"><a href="#OpenLayers-3-介绍" class="headerlink" title="OpenLayers 3 介绍"></a>OpenLayers 3 介绍</h1><p>OpenLayers 3简称ol3，它是一个开源的Web GIS引擎，使用了JavaScript、最新的HTML5技术及CSS技术，支持<code>dom</code>，<code>canvas</code>和<code>webgl</code>三种渲染方式。除了支持网页端，还支持移动端（目前移动端还不成熟，有待进一步完善）。在地图数据源方面，支持各种类型的瓦片地图，既支持在线的，也支持离线的。比如OSM, Bing, MapBox, Stamen, MapQuest等等；还支持各种矢量地图，比如GeoJSON，TopoJSON，KML，GML等等。随着OpenLayers 3的进一步发展，将支持更多的地图类型。</p><a id="more"></a><h2 id="不兼容OpenLayers-2"><a href="#不兼容OpenLayers-2" class="headerlink" title="不兼容OpenLayers 2"></a>不兼容OpenLayers 2</h2><p>在OpenLayers 3之前，还有OpenLayers 2，虽然从名字上看是一个升级版本，但OpenLayers 3完全是重新设计，采用全新的架构，使用方式及API都不一样，只是在功能上完全实现OpenLayers 2已有的功能。为此，使用OpenLayers 3不必先学习OpenLayers 2。但使用过OpenLayers 2，并不等于直接就会用OpenLayers 3，仍然需要从零开始学习。</p><h2 id="浏览器支持"><a href="#浏览器支持" class="headerlink" title="浏览器支持"></a>浏览器支持</h2><p>由于OpenLayers 3使用了HTML5技术，所以对各种浏览器的版本有所要求。IE浏览器最低也需要IE9才行，以下的IE浏览器可以考虑使用OpenLayers 2。其他浏览器的最低版本要求为Firefox 3.5，Chrome 3.0，Safari 3.0，Opera 10.5。如果要使用<code>webgl</code>渲染方式，则又需要参考各大浏览器的支持程度进行选择。</p><h2 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h2><ul><li>OpenLayers 3采用面向对象的编程范式，类在API中随处可见，比如<code>ol.Map</code>，<code>ol.View</code>等等。如果你有面向对象的思维，将较为容易的理解API及使用。</li><li>OpenLayers 3采用包管理的方式管理代码，比如<code>layer</code>的包名为<code>ol.layer</code>，命名方式类似于JAVA的包名。这源于OpenLayers 3采用了Google的<a href="https://developers.google.com/closure/library/" target="_blank" rel="noopener">Closure库</a>。</li><li>OpenLayers 3采用<a href="http://baike.baidu.com/link?url=-N6ZFy7Q1645xbSZxDwv6CEluYjnBX2mn8hA3cabF0VNZiHnrPyRonRAqEr4GYXBte0GH0BzaIkZOFQFatV5tK" target="_blank" rel="noopener">驼峰式(Camel-Case)命名</a>，变量名采用小驼峰命名，类名使用大驼峰命名。</li></ul><h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p>OpenLayers 3的官网是<a href="http://openlayers.org/" target="_blank" rel="noopener">http://openlayers.org/</a>，若记不住，请保存到收藏夹。在官网首页上，即可看到相关的介绍，文档，API，以及Examples链接。这些资料都跟随最新的版本实时更新，如果发现本教程有些内容和官方不一致，请以官网资料为准，可能由于版本更新导致的。</p><p>喜欢研究源码的开发者，请关注github <a href="https://github.com/openlayers/ol3" target="_blank" rel="noopener">https://github.com/openlayers/ol3</a>。有能力者，可以考虑为OpenLayers 3提交PR和issue，不过在此之前请先阅读<a href="https://github.com/openlayers/ol3/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener">贡献文档</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;OpenLayers-3-介绍&quot;&gt;&lt;a href=&quot;#OpenLayers-3-介绍&quot; class=&quot;headerlink&quot; title=&quot;OpenLayers 3 介绍&quot;&gt;&lt;/a&gt;OpenLayers 3 介绍&lt;/h1&gt;&lt;p&gt;OpenLayers 3简称ol3，它是一个开源的Web GIS引擎，使用了JavaScript、最新的HTML5技术及CSS技术，支持&lt;code&gt;dom&lt;/code&gt;，&lt;code&gt;canvas&lt;/code&gt;和&lt;code&gt;webgl&lt;/code&gt;三种渲染方式。除了支持网页端，还支持移动端（目前移动端还不成熟，有待进一步完善）。在地图数据源方面，支持各种类型的瓦片地图，既支持在线的，也支持离线的。比如OSM, Bing, MapBox, Stamen, MapQuest等等；还支持各种矢量地图，比如GeoJSON，TopoJSON，KML，GML等等。随着OpenLayers 3的进一步发展，将支持更多的地图类型。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>一个简单的地图</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch02/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch02/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:07:41.301Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一个简单的地图"><a href="#一个简单的地图" class="headerlink" title="一个简单的地图"></a>一个简单的地图</h1><p>在有了初步了解之后，从本节开始，我们将直接进入主题，体验一下使用OpenLayers 3做地图的难度，及地图的外观和功能：</p><a id="more"></a><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><body><br>    <div id="map" style="width: 100%"></div><br>    <script><br>      new ol.Map({<br>            layers: [<br>                new ol.layer.Tile({source: new ol.source.OSM()})<br>            ],<br>            view: new ol.View({<br>                center: [0, 0],<br>                zoom: 2<br>            }),<br>            target: ‘map’<br>      });<br>    </script><br></body><p>要显示上面这个地图，仅需要新建一个html文档，在其中编写如下代码即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!Doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">http://www.w3.org/1999/xhtml</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>                  </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">Content-Type</span> <span class="attr">content</span>=<span class="string">"text/html;charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">X-UA-Compatible</span> <span class="attr">content</span>=<span class="string">"IE=edge,chrome=1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">always</span> <span class="attr">name</span>=<span class="string">referrer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>OpenLayers 3地图示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../ol3.13.1/ol.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../src/ol3.13.1/ol.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置地图图层</span></span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建一个使用Open Street Map地图源的瓦片图层</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置显示地图的视图</span></span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">  center: [<span class="number">0</span>, <span class="number">0</span>],<span class="comment">// 定义地图显示中心于经度0度，纬度0度处</span></span></span><br><span class="line"><span class="actionscript">  zoom: <span class="number">2</span><span class="comment">// 并且定义地图显示层级为2</span></span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让id为map的div作为地图的容器</span></span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>要想使用OpenLayers 3开发地图，首先你需要引入了OpenLayers 3的js库文件ol3.js及样式文件ol3.css，参见代码中html头部。它们可以在<a href="https://github.com/openlayers/ol3/releases" target="_blank" rel="noopener">github</a>上下载到。 请注意，每一个版本，都有4个下载链接，如果你不需要研究源码和例子，只用下载第一个 v*-dist.zip，下载解压后，里面包含<code>ol.css</code>，<code>ol.js</code>，<code>ol-debug.js</code>这三个文件，在初学时，尽量使用<code>ol-debug.js</code>，如果发生错误，堆栈信息更为可读，便于排查问题。 如果需要学习和研究源码，可以下载后面的三个文件，但注意，需要自己编译生成<code>ol.css</code>，<code>ol.js</code>，<code>ol-debug.js</code>，切不可直接使用源码中的同名文件。</p><p><strong>注意：</strong> 上面这个段代码注明html文件编码为utf-8，所以你新建的html文件本身编码需要保证为utf-8，不然会导致中文乱码。</p><p>紧接着就是使用OpenLayers 3的API创建地图，对应于<code>&lt;script&gt;...&lt;/script&gt;</code>代码块，如代码所见，7行代码就搞定了，是不是非常的简单？！至于代码的含义，可以暂时参照代码中的注释来理解。 看不懂也没有关系，接下来我们将详细的介绍它们。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;一个简单的地图&quot;&gt;&lt;a href=&quot;#一个简单的地图&quot; class=&quot;headerlink&quot; title=&quot;一个简单的地图&quot;&gt;&lt;/a&gt;一个简单的地图&lt;/h1&gt;&lt;p&gt;在有了初步了解之后，从本节开始，我们将直接进入主题，体验一下使用OpenLayers 3做地图的难度，及地图的外观和功能：&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3地图</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch03/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch03/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:07:55.851Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OpenLayers-3地图"><a href="#OpenLayers-3地图" class="headerlink" title="OpenLayers 3地图"></a>OpenLayers 3地图</h1><p>本章节将围绕前面那个简单的地图展开，从源码分析入手，逐步延伸到地图组成部分的分析，并学会借助API文档来帮助我们理解。 在此基础上，还提供了一些关于<code>ol.Map</code>类的应用实例，以帮助大家进一步的实践，为接下来更深入的学习和使用打下坚实的基础。</p><a id="more"></a><h1 id="初步解析地图组成"><a href="#初步解析地图组成" class="headerlink" title="初步解析地图组成"></a>初步解析地图组成</h1><p>创建地图的代码如此简单，以致于让一部分初学者误认为在此基础上的深入开发也很简单，这是一个非常错误的理解。此时，最关键的第一步是先弄明白每一句代码的含义，理解他们是如何组织起来的。否则，在后续的学习和使用过程中，犹如瞎子摸象，会找不到问题的关键点而迷失方向。让我们再次回顾一下之前那个简单地图的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建地图</span></span><br><span class="line"> <span class="keyword">new</span> ol.Map(&#123;</span><br><span class="line"><span class="comment">// 设置地图图层</span></span><br><span class="line">layers: [</span><br><span class="line">  <span class="comment">// 创建一个使用Open Street Map地图源的瓦片图层</span></span><br><span class="line">  <span class="keyword">new</span> ol.layer.Tile(&#123;<span class="attr">source</span>: <span class="keyword">new</span> ol.source.OSM()&#125;)</span><br><span class="line">],</span><br><span class="line"><span class="comment">// 设置显示地图的视图</span></span><br><span class="line">view: <span class="keyword">new</span> ol.View(&#123;</span><br><span class="line">  center: [<span class="number">0</span>, <span class="number">0</span>],<span class="comment">// 定义地图显示中心于经度0度，纬度0度处</span></span><br><span class="line">  zoom: <span class="number">2</span><span class="comment">// 并且定义地图显示层级为2</span></span><br><span class="line">&#125;),</span><br><span class="line"><span class="comment">// 让id为map的div作为地图的容器</span></span><br><span class="line">target: <span class="string">'map'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>注意，其实上面这段代码就只有一条语句:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ol.Map(&#123;...&#125;);</span><br></pre></td></tr></table></figure></p><p>其他代码只是用于设置地图的构造参数。由此可以推测出<code>ol.Map</code>是最主要的地图类，创建地图就需要构造这么一个对象。接下来依次分析每一个参数部分的代码。</p><ul><li>参数<code>layers</code>:<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">layers: [</span><br><span class="line">  <span class="comment">// 创建一个使用Open Street Map地图源的瓦片图层</span></span><br><span class="line">  <span class="keyword">new</span> ol.layer.Tile(&#123;<span class="attr">source</span>: <span class="keyword">new</span> ol.source.OSM()&#125;)</span><br><span class="line">],</span><br></pre></td></tr></table></figure></li></ul><p>从名字和具体的值可见这个地方可以设置多个<code>layer</code>，它是OpenLayers 3地图的组成结构单元，地图是由多个<code>layer</code>组成的，这种设计类似于Photoshop里面的图层，多个图层是可以叠加的，在最上面的会覆盖下面的，以此类推。在代码中我们添加了一个<a href="http://www.openstreetmap.org/" target="_blank" rel="noopener">Open Street Map</a>的地图<code>layer</code>。</p><ul><li>参数<code>view</code>：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">view: <span class="keyword">new</span> ol.View(&#123;</span><br><span class="line">  center: [<span class="number">0</span>, <span class="number">0</span>],<span class="comment">// 定义地图显示中心于经度0度，纬度0度处</span></span><br><span class="line">  zoom: <span class="number">2</span><span class="comment">// 并且定义地图显示层级为2</span></span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure></li></ul><p>通过字面意思可以看出，它为地图定义显示窗口，对应<code>ol.View</code>类，可以自定义地图显示的中心点，缩放层级等。</p><ul><li>参数<code>target</code>：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target: <span class="string">'map'</span></span><br></pre></td></tr></table></figure></li></ul><p>指定地图在页面中具体哪个位置进行显示，为此要记住地图显示还是离不开使用dom来实现。虽然和地图业务没什么关系，但也必不可少，因为它是<code>Web GIS</code>，最基本的还是依赖于HTML。</p><p>通过上面的源码解读，我们可以发现OpenLayers 3地图主要是由<code>layer</code>和<code>view</code>组成，<code>layer</code>可以有多个，<code>view</code>只能有一个。<br><img src="../img/map_structure.png" alt="图解地图组成"></p><p>上图能明确看到的是<code>layer</code>，看不出<code>view</code>在哪儿，只知道地图显示中心确实在经度0，纬度0处。除此之外，还能看到左上角的放大缩小按钮，以及右下角的属性信息按钮。如果在地图上双击鼠标左键，或者按住鼠标左键拖动，可以看到地图也是会放大或者移动的。这些都是分析代码并没有看到的。很明显OpenLayers 3有很多默认行为，一个地图的完整构成，远不是只有<code>view</code>和<code>layer</code>就行了。</p><h1 id="地图所有组成部分"><a href="#地图所有组成部分" class="headerlink" title="地图所有组成部分"></a>地图所有组成部分</h1><p>那么OpenLayers 3究竟由哪些部分组成？下面就将核心组成部分一一罗列出来：</p><ul><li>地图(Map)，对应的类是<code>ol.Map</code>，之前已有接触。从代码上来看，它就像是一个空壳子，感觉没做什么实事，因为具体事务都由其他组成部分处理了。但没有它，整个地图的其他组成部分就不能有效协调，组织在一起。同时对于开发者而言，它就是第一个入口，我们必须要掌握。</li><li>视图(View)，对应的类是<code>ol.View</code>，之前已有接触，控制地图显示的中心位置，范围，层级等，此处不再过多介绍。关于其详细说明参见<a href="../ch04/index.md">View</a>。</li><li>图层(Layer)，OpenLayers 3有多种多样用于不同业务的图层，每一种图层在实现上都对应于一个类，放在包<code>ol.layer</code>下面，之前已接触过的<code>ol.layer.Tile</code>就是其中的一种。OpenLayers 3允许多个<code>layer</code>重叠在一起，相互之间互不干扰，是一种图形显示和管理的有效方式。应用这种方式能有效处理地图数据来源的多样性和复杂性问题。对开发者而言，它更多的表现为组织管理的类。</li><li>数据源(Source)，它是和图层一一对应的，OpenLayers 3也存在多种不同的数据源，每一种在实现上也对应于一个具体的类，它们都放在包<code>ol.source</code>下面，之前接触过的<code>ol.source.OSM</code>就是其中的一种。 毫无 疑问，它是整个地图背后真正的核心。 如果没有数据，那么渲染引擎将没有任何价值。在数据技术(Data Technology)大行其道的今天，GIS引擎将需要支持各式各样的数据来源。目前ol3也确实是这样做的，已支持多种多样在线或离线的数据源；可以是静态图或者瓦片图；也可以是栅格化的或者矢量的。如果你想在地图上加载某种格式的数据，或者某种服务提供的数据，都可以优先查看一下OpenLayers 3是否已经支持了。图层和数据源是密不可分的，详情可参见<a href="../ch05/index.md">Source和Layer</a>。</li><li>控件(Control)，它为用户提供了和地图交互的入口。 针对不同的用途，具有不同的控件。其实现类都放在包<code>ol.control</code>下面，在此之前还没有具体接触过，但我们在地图上看到的放大缩小按钮就是众多控件中的一种。控件具备相同的一个特性，就是一直保持在地图的某个固定位置，不会随着地图移动而移动，也不会随着地图放大缩小而变化，一直处于地图的最上层。关于控件更详细的说明参见<a href="../ch10/index.md">Control</a>。</li><li>交互(Interaction)，这是所有软件都具备的一个组成部分，直观地是看不见的，其实现类放在包<code>ol.interaction</code>下面，之前也没具体接触过，但其实是使用到了，如果没有它，我们就没有办法直接用鼠标控制地图放大、缩小、移动。这并不仅仅存在于GIS引擎中，它存在于任何产品中。任何优秀的产品必然有着良好的交互能力，即使没有任何GIS知识，也能体会到它的作用和重要性。</li></ul><p>以上就是一个OpenLayer 3地图所有核心的组成部分， 他们有机的组合在一起，从而构成整个地图，实现了我们对地图的完整需要。 OpenLayer 3采用这样的模块化设计，不管是在实现上，还是对外提供API，都简化了整个系统。我们只要完整地了解每一个组成部分，就能游刃有余地运用它。在这些组成部分中，只有<code>Layer</code>和<code>Source</code>有直接的强联系，其他的组成部分，相互之间的联系很少。为此，在掌握某一部分后，就可以有效地处理这一部分的开发工作，从而不一定要掌握所有组成部分。 本教程的章节也是按照各个模块来分别介绍的，并不一定需要按照章节顺序进行学习。</p><h1 id="看懂API"><a href="#看懂API" class="headerlink" title="看懂API"></a>看懂API</h1><p>或许你已经迫不及待的想开始学习第一个组成部分<code>Map</code>了，但在此之前，还是不得不先学会使用官网的API文档。因为API的重要性众人皆知，对于一个快速开发中的开源项目，更是如此，每一个小版本之间都可能有些许变化。所以在更新版本后，如果遇到API方法不存在或者功能不正确，则需要优先核对官网API文档。本着授之以鱼不如授之以渔的原则，学会看懂API文档是关键，而不是翻译API文档。。</p><h2 id="API文档入口"><a href="#API文档入口" class="headerlink" title="API文档入口"></a>API文档入口</h2><p>在浏览器中打开<a href="http://openlayers.org/" target="_blank" rel="noopener">OpenLayers官网 http://openlayers.org/</a>，下图箭头所指向的地方即为API文档链接：<br><img src="../img/ol_API.png" alt="API文档入口"></p><p>点击进入即为整个API文档的首页，页面上方为工具栏，左边为搜索栏和列表，右边为OpenLayers 3组成部分的介绍，都是相关的类和一些简介。<br><img src="../img/OpenLayers_3_API_Reference_Index.png" alt="API文档首页"></p><p>上方工具栏中的<code>Stable Only</code>复选框选中后，API文档就只会显示功能已经稳定的类，参数，接口等信息。在查找新功能或新特性时，建议不要勾选。 </p><p>右边页面显示了地图组成的介绍，Map、View、Layers列在第一排，第二排及第三排依次列出了其他的组成部分。有简单的介绍，及对应的包和类，可以通过这些资料加深对他们的认识。</p><h2 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h2><p>左边的列表会根据搜索栏的内容进行过滤。大家可以尝试一下，在这里能搜索包名，类名，方法名和事件名。包名比如<code>ol.layer</code>，<code>ol.source</code>等，方法名比如<code>setCenter</code>，<code>setZoom</code>等，类名比如<code>View</code>，<code>Map</code>等，事件名比如`change:layers。但目前还不支持文档里面的内容的文本搜索。</p><h2 id="API文档介绍"><a href="#API文档介绍" class="headerlink" title="API文档介绍"></a>API文档介绍</h2><p>此处以<code>ol.Map</code>类的API文档为例进行说明。在搜索栏输入<code>ol.Map</code>，很快下方列表中的内容就变了，排在中第一项的就是<code>ol.Map</code>类，点击它，右边页面内容就变成了它的说明文档。文档内容从上向下，共分为三部分：</p><ul><li>类介绍，主要介绍该类用途，建议仔细阅读，这样才能根据具体业务找对需要的类。</li><li>构造参数、事件及继承关系，该内容的重要性无需多言，看不明白，就无法创建该类的对象。</li><li>类的所有方法，建议浏览一下，了解每个方法所实现的功能，在需要时，再详细查看对应的参数和使用方式。</li></ul><p>请结合上面的内容快速浏览一下<code>ol.Map</code>的说明文档，感受一下，总的来说，OpenLayers 3的API文档是比较全面的，内容也挺详实(ol3的API文档是从代码的注释中通过工具提取生产的，所以时刻能保持更新，且完全符合JSDoc规范，文档和代码完全匹配)。</p><p>文档中类的介绍部分是否能看懂，因人而异，当了解的越多，就越容易看明白。因为它只是类的一些简要说明，谈不上详细，也没有对应的应用说明。有些类的用途需要结合到其他的知识才能更明白。在不是很明白的情况下，建议多结合类提供的方法的用途来一起理解。</p><p>类的构造参数采用的是<a href="http://usejsdoc.org/" target="_blank" rel="noopener">JSDoc</a>规范定义的，使用工具提取而出，生成了下面的参数文档，在此对其格式进行简要说明，参见下面图解：<br><img src="../img/Class_Map.png" alt="ol.Map的构造参数说明"></p><p>页面右边的文件和行号标注都是可点击的，点击打开跳转到对应的源码，对于探究背后实现，或者分析Bug非常有用。然后是参数说明，很多对象的构造参数都是对象，以<code>{key1:value1, key2:value2}</code>这样的方式设置。这种方式有两方面的好处：</p><ul><li>可以只设置需要的参数，或者增加自定义参数</li><li>易于为指定参数设置正确的值，避免值对应到错误的参数上。</li></ul><p>需要注意的是参数类型<code>Type</code>的说明，使用符号<code>|</code>表示该参数可以赋予多种类型的值，对开发者是非常友好的，灵活强大。参数类型如果是容器，都会使用<code>&lt;&gt;</code>来表示。如果是OpenLayers 3自定义的类型，都是可以点击查看的。若为JavaScript的原生类型或DOM类型，则只给出类型名。对于各个参数的描述信息，就是一段文字，都比较详细。</p><p>除了参数之外，在OpenLayers 3中还大量使用了事件，用于解决实时通知的问题，这是典型的观察者模式。当对象改变时，能触发相应的操作。在API文档中，明确标注了各个类的事件，以及触发该事件的条件和时机。它们都列在<code>Fires:</code>这一栏，比如<code>ol.Map</code>就有很多事件，<code>click</code>、<code>dbclick</code>、<code>singleclick</code>、<code>moveend</code>等等。这些事件对于开发者来说非常重要，除了OpenLayers 3需要大量使用这些事件，很多应用开发也需要使用它们来实现一些关键功能。关于事件更详细的说明参见<a href="../ch07/index.md">事件</a>。</p><p>在事件说明之后，还有类继承的说明。<code>Subclasses</code>列出了当前类的所有子类；<code>Extends</code>列出了当前类的父类。不要小瞧这个说明，因为在面向对象编程范式中，所有能用父类的地方，都可以用子类。比如<code>ol.Map</code>的构造参数<code>options</code>可以设置<code>layers</code>属性，它的值是<code>ol.layer.Base</code>类型元素的集合，那么就可以用<code>ol.layer.Base</code>的子类<code>ol.layer.Group</code>或<code>ol.layer.Layer</code>，以此类推，也可以用这两个类的子类<code>ol.layer.Image</code>、<code>ol.layer.Tile</code>、<code>ol.layer.Vector</code>等。这样我们就知道具体哪些参数能用哪些类了。</p><p>最后就是这个类所有方法的说明了。方法的说明包含方法名，参数，以及方法功能描述。同类的说明差不多，为此不再累述。</p><p>最后，提醒一下，在遇到任何问题时，请优先查询API文档来排忧解惑。</p><h1 id="结合API文档分析代码"><a href="#结合API文档分析代码" class="headerlink" title="结合API文档分析代码"></a>结合API文档分析代码</h1><p>这次，有了API文档这个利器，必然会对代码有更深入的理解和认识。让我们再一次回顾之前那个简单的地图的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建地图</span></span><br><span class="line"> <span class="keyword">new</span> ol.Map(&#123;</span><br><span class="line"><span class="comment">// 设置地图图层</span></span><br><span class="line">layers: [</span><br><span class="line">  <span class="comment">// 创建一个使用Open Street Map地图源的瓦片图层</span></span><br><span class="line">  <span class="keyword">new</span> ol.layer.Tile(&#123;<span class="attr">source</span>: <span class="keyword">new</span> ol.source.OSM()&#125;)</span><br><span class="line">],</span><br><span class="line"><span class="comment">// 设置显示地图的视图</span></span><br><span class="line">view: <span class="keyword">new</span> ol.View(&#123;</span><br><span class="line">  center: [<span class="number">0</span>, <span class="number">0</span>],<span class="comment">// 定义地图显示中心于经度0度，纬度0度处</span></span><br><span class="line">  zoom: <span class="number">2</span><span class="comment">// 并且定义地图显示层级为2</span></span><br><span class="line">&#125;),</span><br><span class="line"><span class="comment">// 让id为map的div作为地图的容器</span></span><br><span class="line">target: <span class="string">'map'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>之前我们并不知道<code>ol.Map</code>类具体有什么构造参数，也不知道参数值可以设置什么类型的对象等等，现在就可以通过API文档查看。通过API文档可以看到，构造参数远不止上面代码中设置的这些参数，还存在很多其他的参数。这些参数在文档中注明是可以不设置的，OpenLayers3 会自动使用特定的默认值。通过这些参数，你是否已经发现它们其实就是地图的组成部分。为什么有些参数可以不设置而使用默认值，而有些参数就必须设置呢？请自行思考。</p><p>文档显示<code>ol.Map</code>的构造参数<code>layers</code>，可以是<code>ol.Collection</code>，也可以是Javascript数组，此处用了数组。我们统称为容器类型，包含的元素为<code>ol.layer.Base</code>类型。但代码里面创建了一个<code>ol.layer.Tile</code>类的实例，这样也行？通过API文档中的继承关系信息，我们可以了解到<code>ol.layer.Tile</code>继承于<code>ol.layer.Layer</code>，而<code>ol.layer.Layer</code>又继承于<code>ol.layer.Base</code>，所以这是可行的。</p><p>，若对<code>ol.layer.Tile</code>不了解，请使用API文档，在此之前，我们也可以通过包名大致推断出它是一个<code>layer</code>，属于地图层的一种。官网API文档说明：它是一种应用瓦片图片作为地图源的地图层。构造函数的参数里包含一个必须设置值的属性：<code>source</code>，用于设置地图源，类型为<code>ol.source.Tile</code>，但是代码里使用的是<code>ol.source.OSM</code>，这个问题同上，请自行查询API文档解答吧。注意，<code>Layer</code>和<code>Source</code>就是这样绑定在一起的。有什么样的<code>Layer</code>，就需要什么样的<code>Source</code>，看起来是<code>Layer</code>决定<code>Source</code>，其实<code>Layer</code>是为<code>Source</code>服务的，还是之前说的那样，数据才是最重要的。所以应该是<code>Source</code>起决定作用，根据需要构造对应的<code>Layer</code>。为此在做开发时，应该优先考虑需要什么样的<code>Source</code>。这个也可以通过API文档来查找，搜索<code>ol.source</code>即可查看到现有哪些不同类型的<code>source</code>，在结果中逐个查看，直到找到需要的<code>source</code>类。假设找到了<code>ol.source.Test</code>，那么要找<code>layer</code>就简单了，一般情况下，会有<code>ol.layer.Test</code>。 如果没有，请查找<code>ol.source.Test</code>的父类对应的<code>layer</code>，以此类推。</p><p>参数<code>View</code>是一个必须设置的属性，对应于<code>ol.View</code>类，通过官网API了解详细信息，顺便详细看看它的构造参数中的<code>center</code>和<code>zoom</code>表示什么？<code>View</code>至关重要，后续将更深入的了解。</p><p>认真查看API文档，可以发现一些你意想不到的东西，从而有所启发，或学到新知识，或排忧解难，所以请重视API文档。至此，你应该对上面的代码有了非常深入的理解了，此时不妨试试修改一些参数的值，查看地图有什么变化。</p><h1 id="ol-Map的应用"><a href="#ol-Map的应用" class="headerlink" title="ol.Map的应用"></a>ol.Map的应用</h1><p>到此，已经学习了足够多的知识，对<code>ol.Map</code>也比较熟悉了，如果遇到问题，也能从API文档中得到帮助，是时候动动手练习一下了。这之后就给出一些简单的应用，有兴趣的可以看看，没兴趣的可以直接跳过，进入下一章节。</p><h1 id="定制地图logo"><a href="#定制地图logo" class="headerlink" title="定制地图logo"></a>定制地图logo</h1><p>OpenLayers 3作为一个引擎，供开发者二次开发来发布产品，必然需要重新设置logo，具体怎么做？通过<code>ol.Map</code>的API文档发现它的构造参数里面<code>logo</code>的设置，简单动动手就能做出下面这样带自定义<code>logo</code>的地图，注意右下角的猴子：</p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><p><div id="map" style="width: 100%, height: 400px"></div></p><script>  new ol.Map({      controls: ol.control.defaults({          attributionOptions: ({            collapsible: false          })        }),        // logo: false,     // 不显示logo        // logo: 'face_monkey.png',     // 用一个图片 face_monkey.png 作为logo        logo: {src: '../img/face_monkey.png', href: 'http://www.openstreetmap.org/'},    // 点击能跳转到对应页面        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            center: [0, 0],            zoom: 2        }),        target: 'map'  });</script><p>因为今年是猴年，所以就用了它，当然你也可以换成任何其他想要的<code>logo</code>，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%, height: 400px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">  controls: ol.control.defaults(&#123;</span></span><br><span class="line"><span class="undefined">          attributionOptions: (&#123;</span></span><br><span class="line"><span class="actionscript">            collapsible: <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">          &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;),</span></span><br><span class="line"><span class="actionscript"><span class="comment">// logo: false, // 不显示logo</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// logo: 'face_monkey.png', // 用一个图片 face_monkey.png 作为logo</span></span></span><br><span class="line"><span class="actionscript">logo: &#123;src: <span class="string">'../img/face_monkey.png'</span>, href: <span class="string">'http://www.openstreetmap.org/'</span>&#125;,<span class="comment">// 点击能跳转到对应页面</span></span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">center: [0, 0],</span></span><br><span class="line"><span class="undefined">zoom: 2</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意看代码中设置<code>logo</code>参数的注释，演示了最复杂的情况，注释掉的代码是一些简单的用法。可自行尝试换成它们有什么效果。</p><p>除了<code>logo</code>参数之外，我们还设置了<code>controls</code>，算是这个例子夹带的私货，其大致的作用，从官网API文档可以了解到，是设置地图控件的。有什么作用？注意对比现在的地图和之前的地图的右下角，一个是<strong>i</strong>，一个是展开的一串信息。 </p><h1 id="单页面多地图"><a href="#单页面多地图" class="headerlink" title="单页面多地图"></a>单页面多地图</h1><p>在某些业务中，可能需要在一个页面中加载多个地图，用于对比，或者多个业务方面的同时展示。那么OpenLayers 3能否做到单页面多地图互不干扰呢？</p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><p>地图1</p><br><div id="map1" style="width: 100%"></div><br><p>地图2</p><br><div id="map2" style="width: 100%"></div><br><script><br>    // 创建第一个地图<br>  new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({source: new ol.source.OSM()})<br>        ],<br>        view: new ol.View({<br>            center: [0, 0],<br>            zoom: 2<br>        }),<br>        target: ‘map1’<br>  });<br><br>    // 创建第二个地图<br>    new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({source: new ol.source.OSM()})<br>        ],<br>        view: new ol.View({<br>            center: [0, 0],<br>            zoom: 2<br>        }),<br>        target: ‘map2’<br>  });<br></script><br><br>试试两个地图都操作一下，确认相互之间是否有影响？对应的代码非常简单，无非就是数量多了一个，如下：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>地图1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map1"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>地图2<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建第一个地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">center: [0, 0],</span></span><br><span class="line"><span class="undefined">zoom: 2</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map1'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建第二个地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">center: [0, 0],</span></span><br><span class="line"><span class="undefined">zoom: 2</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>这段代码真没有什么需要解释的了。<br><br><br># 地图联动<br>OpenLayers 3采用了MVC模型，V对应的就是<code>View</code>，这种设计模型有什么好处？我们还是直接看下面这两个地图：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><p>地图1</p><br><div id="map1" style="width: 100%"></div><br><p>地图2</p><br><div id="map2" style="width: 100%"></div><br><script><br>    // 创建一个视图<br>    var view = new ol.View({<br>            center: [0, 0],<br>            zoom: 2<br>        });<br><br>    // 创建第一个地图<br>  new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({source: new ol.source.OSM()})<br>        ],<br>        view: view,<br>        target: ‘map1’<br>  });<br><br>    // 创建第二个地图<br>    new ol.Map({<br>        layers: [<br>            new ol.layer.Tile({source: new ol.source.OSM()})<br>        ],<br>        view: view,<br>        target: ‘map2’<br>  });<br></script><br><br>拖动地图1的同时，看看地图2有什么变化，是不是很神奇，为什么呢？<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>地图1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map1"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>地图2<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建一个视图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">center: [0, 0],</span></span><br><span class="line"><span class="undefined">zoom: 2</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建第一个地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="undefined">view: view,</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map1'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建第二个地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="undefined">view: view,</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>代码只有一点不同，即两个<code>ol.Map</code>使用了同一个<code>view</code>，就是这么神奇。<br><br><br># 动态交换地图<br>在创建地图时，我们可以指定对应的地图容器，其实在创建完成之后，我们还可以动态设置不同的地图容器，从而可以让地图不断的变换位置，比如交换两个地图：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><p></p><p>地图1</p><p></p><p><div id="map1" style="width: 100%"></div></p><p></p><p>地图2</p><p></p><p><div id="map2" style="width: 100%"></div></p><p><input type="button" onclick="swapMap();" value="调换地图"></p><script>    // 创建第一个地图  var map1 = new ol.Map({        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            center: [0, 0],            zoom: 2        }),        target: 'map1'  });    // 创建第二个地图    var map2 = new ol.Map({        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            center: [0, 0],            zoom: 2        }),        target: 'map2'  });    function swapMap() {        // 改变两个地图的容器        map1.setTarget('map2');        map2.setTarget('map1');    }</script><p>为了让两个地图有所差别，你可以先放大第一个地图，然后点击<strong>调换地图</strong>按钮，看一下效果。要实现这个功能，其实只需要使用<code>setTarget</code>方法即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>地图1<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map1"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>地图2<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"swapMap();"</span> <span class="attr">value</span>=<span class="string">"调换地图"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建第一个地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map1 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">center: [0, 0],</span></span><br><span class="line"><span class="undefined">zoom: 2</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map1'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建第二个地图</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">center: [0, 0],</span></span><br><span class="line"><span class="undefined">zoom: 2</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">swapMap</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 改变两个地图的容器</span></span></span><br><span class="line"><span class="actionscript">map1.setTarget(<span class="string">'map2'</span>);</span></span><br><span class="line"><span class="actionscript">map2.setTarget(<span class="string">'map1'</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其实很多时候，只需要多留意一下API文档里面的方法，了解功能，就可能实现意想不到效果。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;OpenLayers-3地图&quot;&gt;&lt;a href=&quot;#OpenLayers-3地图&quot; class=&quot;headerlink&quot; title=&quot;OpenLayers 3地图&quot;&gt;&lt;/a&gt;OpenLayers 3地图&lt;/h1&gt;&lt;p&gt;本章节将围绕前面那个简单的地图展开，从源码分析入手，逐步延伸到地图组成部分的分析，并学会借助API文档来帮助我们理解。 在此基础上，还提供了一些关于&lt;code&gt;ol.Map&lt;/code&gt;类的应用实例，以帮助大家进一步的实践，为接下来更深入的学习和使用打下坚实的基础。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 View</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch04/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch04/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:08:07.703Z</updated>
    
    <content type="html"><![CDATA[<h1 id="View"><a href="#View" class="headerlink" title="View"></a>View</h1><p>所见即所得是大家喜闻乐见的，<code>View</code>就是这样的，作为地图的窗口，做一些改变，就能看到变化，便于初学者学习。同时，<code>View</code>是OpenLayers 3地图组成部分中非常重要的一个概念，涉及到地图移动，放大，缩小，旋转等，这些功能是任何一个GIS引擎必不可少的。为此，我们把它作为最先介绍和学习的组成部分。</p><a id="more"></a><h1 id="地图导航"><a href="#地图导航" class="headerlink" title="地图导航"></a>地图导航</h1><p>在深入学习之前，还是先来个开胃菜，见识一下<code>View</code>所承载的功能。下面将演示地图导航功能，关于导航相关功能，在前面操作地图的时候，已经有了充分的理解和认识。为什么我们还要再讨论它呢？因为这次的导航功能，需要自己来实现，而且只使用<code>ol.View</code>提供的方法就可以做到。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%, height: 400px"></div></p><p><div id="navigate-container"><br>    <input type="button" onclick="moveToLeft();" value="左移"><br>    <input type="button" onclick="moveToRight();" value="右移"><br>    <input type="button" onclick="moveToUp();" value="上移"><br>    <input type="button" onclick="moveToDown();" value="下移"><br>    <input type="button" onclick="moveToChengDu();" value="移到成都"><br>    <input type="button" onclick="zoomIn();" value="放大"><br>    <input type="button" onclick="zoomOut();" value="缩小"><br></div></p><script>  var map = new ol.Map({        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            // 设置成都为地图中心，此处进行坐标转换， 把EPSG:4326的坐标，转换为EPSG:3857坐标，因为ol默认使用的是EPSG:3857坐标            // 请阅读“地图坐标系”了解更多坐标系的信息。            center: ol.proj.transform([104.06, 30.67], 'EPSG:4326', 'EPSG:3857'),            zoom: 10        }),        target: 'map'  });    // 向左移动地图    function moveToLeft() {        var view = map.getView();        var mapCenter = view.getCenter();        // 让地图中心的x值增加，即可使得地图向左移动，增加的值根据效果可自由设定        mapCenter[0] += 50000;        view.setCenter(mapCenter);        map.render();    }    // 向右移动地图    function moveToRight() {        var view = map.getView();        var mapCenter = view.getCenter();        // 让地图中心的x值减少，即可使得地图向右移动，减少的值根据效果可自由设定        mapCenter[0] -= 50000;        view.setCenter(mapCenter);        map.render();    }    // 向上移动地图    function moveToUp() {        var view = map.getView();        var mapCenter = view.getCenter();        // 让地图中心的y值减少，即可使得地图向上移动，减少的值根据效果可自由设定        mapCenter[1] -= 50000;        view.setCenter(mapCenter);        map.render();    }    // 向下移动地图    function moveToDown() {        var view = map.getView();        var mapCenter = view.getCenter();        // 让地图中心的y值增加，即可使得地图向下移动，增加的值根据效果可自由设定        mapCenter[1] += 50000;        view.setCenter(mapCenter);        map.render();    }    // 移动到成都    function moveToChengDu() {        var view = map.getView();        // 设置地图中心为成都的坐标，即可让地图移动到成都        view.setCenter(ol.proj.transform([104.06, 30.67], 'EPSG:4326', 'EPSG:3857'));        map.render();    }    // 放大地图    function zoomIn() {        var view = map.getView();        // 让地图的zoom增加1，从而实现地图放大        view.setZoom(view.getZoom() + 1);    }    // 缩小地图    function zoomOut() {        var view = map.getView();        // 让地图的zoom减小1，从而实现地图缩小        view.setZoom(view.getZoom() - 1);    }</script><p>点击地图下方的几个按钮试试响应的功能，用它们就可以完整的实现地图导航了。按照惯例，下面我们会给出对应的源码，但我希望你能先学习一下<code>ol.View</code>的API文档，从中找出我们可能使用了的方法。</p><p>好了，下面就来揭晓答案：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%, height: 400px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"navigate-container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"moveToLeft();"</span> <span class="attr">value</span>=<span class="string">"左移"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"moveToRight();"</span> <span class="attr">value</span>=<span class="string">"右移"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"moveToUp();"</span> <span class="attr">value</span>=<span class="string">"上移"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"moveToDown();"</span> <span class="attr">value</span>=<span class="string">"下移"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"moveToChengDu();"</span> <span class="attr">value</span>=<span class="string">"移到成都"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"zoomIn();"</span> <span class="attr">value</span>=<span class="string">"放大"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"zoomOut();"</span> <span class="attr">value</span>=<span class="string">"缩小"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心，此处进行坐标转换， 把EPSG:4326的坐标，转换为EPSG:3857坐标，因为ol默认使用的是EPSG:3857坐标</span></span></span><br><span class="line"><span class="actionscript">center: ol.proj.transform([<span class="number">104.06</span>, <span class="number">30.67</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 向左移动地图</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">moveToLeft</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = map.getView();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mapCenter = view.getCenter();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让地图中心的x值增加，即可使得地图向左移动，增加的值根据效果可自由设定</span></span></span><br><span class="line"><span class="undefined">mapCenter[0] += 50000;</span></span><br><span class="line"><span class="undefined">view.setCenter(mapCenter);</span></span><br><span class="line"><span class="undefined">map.render();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 向右移动地图</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">moveToRight</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = map.getView();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mapCenter = view.getCenter();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让地图中心的x值减少，即可使得地图向右移动，减少的值根据效果可自由设定</span></span></span><br><span class="line"><span class="undefined">mapCenter[0] -= 50000;</span></span><br><span class="line"><span class="undefined">view.setCenter(mapCenter);</span></span><br><span class="line"><span class="undefined">map.render();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 向上移动地图</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">moveToUp</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = map.getView();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mapCenter = view.getCenter();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让地图中心的y值减少，即可使得地图向上移动，减少的值根据效果可自由设定</span></span></span><br><span class="line"><span class="undefined">mapCenter[1] -= 50000;</span></span><br><span class="line"><span class="undefined">view.setCenter(mapCenter);</span></span><br><span class="line"><span class="undefined">map.render();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 向下移动地图</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">moveToDown</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = map.getView();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mapCenter = view.getCenter();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让地图中心的y值增加，即可使得地图向下移动，增加的值根据效果可自由设定</span></span></span><br><span class="line"><span class="undefined">mapCenter[1] += 50000;</span></span><br><span class="line"><span class="undefined">view.setCenter(mapCenter);</span></span><br><span class="line"><span class="undefined">map.render();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 移动到成都</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">moveToChengDu</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = map.getView();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置地图中心为成都的坐标，即可让地图移动到成都</span></span></span><br><span class="line"><span class="actionscript">view.setCenter(ol.proj.transform([<span class="number">104.06</span>, <span class="number">30.67</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>));</span></span><br><span class="line"><span class="undefined">map.render();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 放大地图</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">zoomIn</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = map.getView();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让地图的zoom增加1，从而实现地图放大</span></span></span><br><span class="line"><span class="undefined">view.setZoom(view.getZoom() + 1);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 缩小地图</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">zoomOut</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> view = map.getView();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让地图的zoom减小1，从而实现地图缩小</span></span></span><br><span class="line"><span class="undefined">view.setZoom(view.getZoom() - 1);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用<code>input</code>标签增加了几个按钮，每个按钮都绑定了对应的点击事件监听，对应的监听函数实现了某一种导航的功能，都很简单，并且代码都有注释，容易理解。创建地图的代码几乎没有任何改变，也不过多说明，请结合代码和上面的地图进行理解。</p><p>在功能上，目前尚有两个方面的欠缺，一是按钮没有集成在地图上；二是移动并不平滑。这两部分功能缺失将在我们学习了<code>Control</code>和动画之后，一步一步再补充完善，此处暂时不深入下去。现在需要考虑的是我们在代码中使用了<code>ol.proj.transform</code>这个方法，它有什么作用？</p><h1 id="坐标"><a href="#坐标" class="headerlink" title="坐标"></a>坐标</h1><p>是否已经知道<code>ol.proj.transform</code>的功能了？你应该知道的，因为有API文档。它主要用于坐标转换，它的第一个参数是<code>ol.Coordinate</code>类型的坐标，后面两个参数依次是当前坐标所用的坐标系，及转换后的坐标所用的坐标系，<code>ol.proj.transform([104.06, 30.67], &#39;EPSG:4326&#39;, &#39;EPSG:3857&#39;)</code>就能把<code>EPSG:4326</code>的坐标<code>[104.06, 30.67]</code>转换为<code>EPSG:3857</code>的坐标。</p><p>在了解这个函数的功能后，可能不禁会问：为什么要弄的如此复杂，是不是还有很多其他的坐标系？是的，确实存在很多其他的坐标系，如果可以选择的话，应该没人愿意这样。道理如同这个世界上存在各种各样的货币一样。在下一个小节，就会详细介绍多个坐标系及存在的原因。但在此之前，我们得先了解一个有意义的坐标应该如何定义。 </p><p>如果单独地看<code>[45.06, 30.67]</code>，这是没有任何意义的两个数字，在不同的场景，不同的人眼里，它们可以是某个仪器的两个测量值，也可以是学生的考试成绩，还可以是某个坐标。大家或许已经意识到，场景是非常重要的，假如我们定义这两个数字表示的是一个地理位置的坐标，那请问你知道这个坐标所指的具体位置吗？肯定是不能的。因为我们并不知道这个坐标里面的数字使用什么单位，是度？是米？还是其他的单位？如果添加上单位，也还不够，假设单位是度，我们还是不知道坐标中的前一个数字是经度，还是纬度。即使定义经纬度，也还不够，因为还有很多不确定的东西，比如这个坐标相对的原点在哪里？二维还是三维，哪个方向为正向？</p><p>一个有意义的坐标并不是我们看上去那样简单，特别是地理坐标，但初学者往往会忽略这点，从而造成在应用中经常出现定位错误。</p><h1 id="坐标系及投影"><a href="#坐标系及投影" class="headerlink" title="坐标系及投影"></a>坐标系及投影</h1><p>关于原点，方向，单位等等的相关定义和描述，组成了我们常说的坐标系。谈到坐标系，就会想起初中数学中经常接触到的二维笛卡尔坐标系，在图形学中也会遇到三维坐标系，在GIS中我们需要地理坐标系。但它并不像笛卡尔坐标系那样简单，学过地理知识就知道，地球并不是一个完全规则的球体。在不同的地区，为了在数学上表示它，就出现了多种不同的参考椭球体，比如克拉索夫斯基(Krasovsky)椭球体，WGS1984椭球体，更多的椭球体参见<a href="https://zh.wikipedia.org/wiki/%E5%8F%82%E8%80%83%E6%A4%AD%E7%90%83%E4%BD%93" target="_blank" rel="noopener">参考椭球体</a>。在参考椭球体的基础上，就发展出了不同的地理坐标系，比如我国常用的WGS84，北京54，西安80坐标系，欧洲，北美也有不同的坐标系。北京54使用的是克拉索夫斯基(Krasovsky)椭球体，WGS84使用的是WGS1984椭球体。由此可见，多个坐标系是源于地理的复杂性。</p><p>由于存在着多种坐标系，即使同样的坐标，在不同的坐标系中，也表示的是不同的位置，这就是大家经常遇到的偏移问题的根源，要解决这类问题，就需要纠偏，把一个坐标系的坐标转换成另一个坐标系的坐标。由于WGS84是全球通用的坐标系，涉及到多个坐标系与它之间的转换，所以在此做个简单的介绍。</p><p>WGS84，全称World Geodetic System 1984，是为GPS全球定位系统使用而建立的坐标系统。通过遍布世界的卫星观测站观测到的坐标建立，其初次WGS84的精度为1-2m，在1994年1月2日，通过10个观测站在GPS测量方法上改正，得到了WGS84（G730），G表示由GPS测量得到，730表示为GPS时间第730个周。</p><p>1996年，National Imagery and Mapping Agency (NIMA) 为美国国防部 (U.S.Department of Defense, DoD)做了一个新的坐标系统。这样实现了新的WGS版本WGS（G873）。其因为加入了美国海军天文台和北京站的改正，其东部方向加入了31-39cm 的改正。所有的其他坐标都有在1分米之内的修正。</p><p>关于北京54和西安80坐标系，请自行通过网络查找相关资料进行了解。</p><p>有了坐标系后，我们就能精确的表示地球上的每一个位置，但为什么还需要投影呢？投影是为了把不可展的椭球面描绘到平面上，它使用几何透视方法或数学分析的方法，将地球上的点和线投影到可展的曲面(平面、园柱面或圆锥面)上，再将此可展曲面展成平面，建立该平面上的点、线和地球椭球面上的点、线的对应关系。正是因为有投影，大家才能在网页上看到二维平面的地球地图。</p><p>投影方式也多种多样，其中有一种投影叫墨卡托投影(Mercator Projection)，广泛使用于网页地图，对于OpenLayers 3的开发者而言，尤其重要，详情参见<a href="http://baike.baidu.com/view/301981.htm" target="_blank" rel="noopener">墨卡托投影</a>。</p><p>如果不了解上面这些基本知识，在使用OpenLayers 3的过程中，会感觉寸步难行，相反，则得心应手。</p><h1 id="OpenLayers-3使用的坐标系"><a href="#OpenLayers-3使用的坐标系" class="headerlink" title="OpenLayers 3使用的坐标系"></a>OpenLayers 3使用的坐标系</h1><p>目前OpenLayers 3支持两种投影，一个是<code>EPSG:4326</code>，等同于WGS84坐标系，参见<a href="http://spatialreference.org/ref/epsg/wgs-84/" target="_blank" rel="noopener">详情</a>。另一个是<code>EPSG:3857</code>，等同于900913，由Mercator投影而来，经常用于web地图，参见<a href="http://spatialreference.org/ref/sr-org/7483/" target="_blank" rel="noopener">详情</a>。一个是全球通用的，一个是web地图专用的，自然OpenLayers 3支持它们。在使用过程中，需要注意OpenLayers 3默认使用的是<code>EPSG:3857</code>。这也是为什么前面的代码里需要进行坐标转换的原因。 既然支持<code>EPSG:4326</code>，为什么还要转换？当然是可以不用转换的，但前提是你得指定使用具体那种投影，就像下面这样。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script>  new ol.Map({        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            // 设置成都为地图中心            center: [104.06, 30.67],            projection: 'EPSG:4326',            zoom: 10        }),        target: 'map'  });</script><p>代码很简单：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 指定投影使用EPSG:4326</span></span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>所以开发时需要记住的是当前OpenLayers 3使用的坐标系及投影，以及我们自己的数据所使用的坐标系及投影。在没有弄清楚之前，就不要继续后面的内容学习，直到弄清楚为止。</p><h1 id="ol-View的应用"><a href="#ol-View的应用" class="headerlink" title="ol.View的应用"></a>ol.View的应用</h1><p><a href="04-01.md">地图导航</a>是<code>View</code>应用的一个例子，但仅限于导航。其实<code>View</code>还有一些其他的功能，在开发中经常遇到。比如控制地图显示范围，自动适配某个范围等等。若有所了解，可跳过本章节，直接进入下一个章节。</p><h1 id="限制地图范围"><a href="#限制地图范围" class="headerlink" title="限制地图范围"></a>限制地图范围</h1><p>在实际使用中，往往只关心某一个区域的地图，而无需显示整个地球的地图，这样可以聚焦于业务，同时可以减少前端和后台的地图数据。无疑，这样的功能是非常有用的。下面我们就将看到，地图只能在经度29度到31度，纬度在102到104度之间显示。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script>  new ol.Map({        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            extent: [102, 29, 104, 31],            // 设置成都为地图中心            center: [104.06, 30.67],            projection: 'EPSG:4326',            zoom: 10        }),        target: 'map'  });</script><p>不妨上下左右拖拽地图试试，是否发现上下左右都存在着边界？其实代码很简单：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置地图中心范围</span></span></span><br><span class="line"><span class="undefined">extent: [102, 29, 104, 31],</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>就只是添加了    <code>extent: [102, 29, 104, 31],</code>这行代码就实现了功能。<code>extent</code>参数类型为<code>[minX, minY, maxX, maxY]</code>的<code>ol.Extent</code>，很容易记住。</p><p>如果对上面的地图进行缩小，然后再看地图，是否发现范围<code>[102, 29, 104, 31]</code>外的区域也显示出来了，而这并不是我们期望看到的。这时请注意仔细看<code>extent</code>参数的说明，这个范围指的是地图中心的限制范围，而不是整个地图显示的范围。那遇到这个问题该怎么办？我们发现，当我们地图放大后，这个问题并不那么明显，地图放大的越大，固定窗口显示的实际地理范围越小。一个简单的办法就是限制地图不能无限缩小，具体允许缩小到哪一级，可通过实际缩小地图到刚好填满整个窗口(<code>id</code>为<code>map</code>的<code>div</code>)来确定。限制地图缩放级别可参见<a href="04-07.md">下一节</a>。</p><p>这是一种简单的做法，虽然有效，但并不精确，如果要做到非常精确，还需要学习后面更多的知识(分辨率等)，在后续章节会有更深入的说明和示例。</p><h1 id="限制地图缩放级别"><a href="#限制地图缩放级别" class="headerlink" title="限制地图缩放级别"></a>限制地图缩放级别</h1><p>有时无限制地允许用户缩小或者放大地图，并不是一种明智的做法，在地图上的<code>feature</code>、标注、图形等都会变的不便于查看。为此，适中的地图缩放级别是被大多数场景所需要的。下面演示地图你只能在10到14级进行缩放。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script>  new ol.Map({        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            // 设置成都为地图中心            center: [104.06, 30.67],            projection: 'EPSG:4326',            zoom: 10,            minZoom: 10,            maxZoom: 14        }),        target: 'map'  });</script><p>缩放试试便知，地图现在不能无限缩小放大了，代码也是非常的简单：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10,</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 限制地图缩放最大级别为14，最小级别为10</span></span></span><br><span class="line"><span class="undefined">minZoom: 10,</span></span><br><span class="line"><span class="undefined">maxZoom: 14</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>很多初学者问这个问题，其实仔细阅读一下API文档就会知道如何编码，以至于很多已经知道这个功能的其他开发者不愿意回答这么基础的功能。如果只是显示最小级别则只用设置<code>minZoom</code>的值即可，反之只设置<code>maxZoom</code>的值。</p><p>除了使用<code>minZoom</code>和<code>maxZoom</code>之外，还可以使用<code>minResolution</code>和<code>maxResolution</code>，其具体原理和使用，在分辨率小节会有介绍。对于开发者而言，建议使用<code>minZoom</code>和<code>maxZoom</code>，简单直接。</p><h1 id="自适配区域"><a href="#自适配区域" class="headerlink" title="自适配区域"></a>自适配区域</h1><p>在实际应用中，会有一些地图查找和标注的业务，比如查看成都市锦江区。而这时，地图所在区域可能是北京，我们需要能够让地图直接定位到锦江区，并且最大化完全地显示这块区域。下面就将演示这个功能。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><p><input type="button" value="显示成都" onclick="fitToChengdu();"></p><script>  var map = new ol.Map({        layers: [            new ol.layer.Tile({source: new ol.source.OSM()})        ],        view: new ol.View({            // 设置成都为地图中心            center: [104.06, 30.67],            projection: 'EPSG:4326',            zoom: 10        }),        target: 'map'  });  function fitToChengdu() {      // 让地图最大化完全地显示区域[104, 30.6, 104.12, 30.74]      map.getView().fit([104, 30.6, 104.12, 30.74], map.getSize());  }</script><p>点击地图下方的按钮<strong>显示成都</strong>，看看有什么效果。代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"显示成都"</span> <span class="attr">onclick</span>=<span class="string">"fitToChengdu();"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置成都为地图中心</span></span></span><br><span class="line"><span class="undefined">center: [104.06, 30.67],</span></span><br><span class="line"><span class="actionscript">projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="function"><span class="keyword">function</span> <span class="title">fitToChengdu</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 让地图最大化完全地显示区域[104, 30.6, 104.12, 30.74]</span></span></span><br><span class="line"><span class="undefined">  map.getView().fit([104, 30.6, 104.12, 30.74], map.getSize());</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>只用了一行代码，<code>ol.View</code>的<code>fit</code>函数很强大，希望初学者能认真仔细的查看API文档，它的第三个参数还可以设置更多的选项，以适应更多的需要。关于更多的使用，参见官网例子<a href="http://openlayers.org/en/v3.13.1/examples/center.html" target="_blank" rel="noopener">Advanced View Positioning</a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;View&quot;&gt;&lt;a href=&quot;#View&quot; class=&quot;headerlink&quot; title=&quot;View&quot;&gt;&lt;/a&gt;View&lt;/h1&gt;&lt;p&gt;所见即所得是大家喜闻乐见的，&lt;code&gt;View&lt;/code&gt;就是这样的，作为地图的窗口，做一些改变，就能看到变化，便于初学者学习。同时，&lt;code&gt;View&lt;/code&gt;是OpenLayers 3地图组成部分中非常重要的一个概念，涉及到地图移动，放大，缩小，旋转等，这些功能是任何一个GIS引擎必不可少的。为此，我们把它作为最先介绍和学习的组成部分。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 注意事项</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch14/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch14/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:09:33.177Z</updated>
    
    <content type="html"><![CDATA[<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ol><li>EasyUI和OL3有冲突，体现在浏览器大小缩放时，地图会变形，具体原因未知。</li></ol><a id="more"></a><ol><li><code>ol.js</code>这个文件<strong>千万不能</strong>使用源码目录中的<code>src\ol\ol.js</code>。请下载官网的<code>*-dist.zip</code>，用解压后文件夹里面的<code>ol.js</code>。</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;注意事项&quot;&gt;&lt;a href=&quot;#注意事项&quot; class=&quot;headerlink&quot; title=&quot;注意事项&quot;&gt;&lt;/a&gt;注意事项&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;EasyUI和OL3有冲突，体现在浏览器大小缩放时，地图会变形，具体原因未知。&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 LOD与分辨率</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch06/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch06/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:08:27.106Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LOD与分辨率"><a href="#LOD与分辨率" class="headerlink" title="LOD与分辨率"></a>LOD与分辨率</h1><p>LOD是Levels of Detail的简写，用于根据当前的环境，渲染不同的图像，用于降低非重要的细节度，从而提高渲染效率，在电子游戏中经常运用，对于需要显示全球地图的<code>GIS</code>系统而言，更需要应用这项技术。在<a href="../ch05/05-03.md">万能瓦片地图加载秘籍</a>中，有简单的说明。 在不同的细节层次下，自然分辨率就可能不一样，这两者是紧密结合在一起的。 对于图形显示系统而言，分辨率作为屏幕坐标和世界坐标之间计算的纽带，其作用是非常重要的。 本章节将以实例的方式深入浅出的讲解这两个重要的概念，及在OpenLayers 3中的应用。</p><a id="more"></a><h1 id="LOD原理"><a href="#LOD原理" class="headerlink" title="LOD原理"></a>LOD原理</h1><p>在详细讲解之前，假设给你两张A4纸，在其中一张纸上把你家整个绘制上去，在另一张纸上只把你睡的房间绘制上去。如果别人想看你家，你会给哪一张纸？如果想看你睡的房间，你会给哪一张纸？ 相信你不会给错，<code>LOD</code>就是这种根据不同需要，采用不同图的技术方案。在地图应用中，最直观的体验，就是地图放大缩小。当地图放大后，能看到更详细的地理信息，比如街道，商店等等。当地图缩小再缩小，原来能看到的街道，商店就看不见了，当能看到更大的区域，我们的屏幕就相当于是A4纸，大小不变。 </p><p><code>LOD</code>这个技术方案非常棒，非常符合我们的自然习惯，所以在很多图形系统中都使用了这项技术。在GIS系统中，不断放大，就能看到更多地图细节，了解更加详细的信息。对于<code>GIS</code>引擎的开发者而言，需要实现这项技术，当发现用户放大地图时，就立马使用更有细节的地图图片，替换现在显示的地图图片。 现在问题来了：意思是说对于同一个地点而言，需要有很多张呈现不同细节程度的图片？是的，你没有猜错，虽然在使用地图的过程中，感觉放大缩小地图是浑然一体的，但其实就在你眼皮下发生了图片替换。 不同层级使用具有不同细节的地图图片，这就需要为每一个层级准备图片，如果使用离线工具下载瓦片地图，会看到下载的图片是按照层级Z进行存储的。开发者不用担心数据源的处理，只需要知道这个原理就可以了。</p><p>为了便于理解GIS系统中不同层级，使用不同的图片，下面使用google在线瓦片地图进行说明。 最小层级0情况下，只用了一张256*256像素的图片表示整个地球平面：</p><p><img src="../img/googleTiles/0-0-0.png" alt="层级0google地图瓦片"></p><p>稍大一个层级1情况下，用了四张256*256像素的图片来表示整个地球：</p><p><img src="../img/googleTiles/1-0-0.png" alt="层级1google地图瓦片"><img src="../img/googleTiles/1-1-0.png" alt="层级1google地图瓦片"><br><img src="../img/googleTiles/1-0-1.png" alt="层级1google地图瓦片"><img src="../img/googleTiles/1-1-1.png" alt="层级1google地图瓦片"></p><p>对照一下，是否更加的明白了LOD原理及在GIS中的应用？</p><h1 id="瓦片计算"><a href="#瓦片计算" class="headerlink" title="瓦片计算"></a>瓦片计算</h1><p>不同环境条件下，加载具有不同细节的图片资源，可以提高效率，但这并不是终点。 瓦片技术可以更进一步提高效率。 其原理是将一张大图片切割成很多张小图片，按照呈现需要，加载其中的几张小图片即可。 为什么这样就能提高效率？因为屏幕显示窗口的大小是固定，比如屏幕分辨率是800*600，或者1024*768，又或者是1920*800等等。如果屏幕分辨率是800*600，一张大图是9000*9000，那么同一时间，你只能看到这张图片的十分之一。 但是在不切片的情况下，你却必须要加载整个地图。 如果是在本地浏览还好，假如是发布在网络上，则网络传输和渲染，都将耗时。如果我们按照500*500大小进行切片，我们则只需要加载4张500*500的小图片就可以了。 对于<code>WebGIS</code>而言，需要在网络上发布，同时需要显示整个地球，自然需要使用瓦片技术。</p><h2 id="切片方式"><a href="#切片方式" class="headerlink" title="切片方式"></a>切片方式</h2><p>如果对整个地球图片进行切片，需要考虑的是整个地球图片大小，以及切片规则，切片大小。 对于<code>WebGIS</code>而言，在线地图几乎都采用墨卡托投影坐标系(Mercator)，对应的地图投影到平面上就是一个正方形。 为了方便使用，切片时大多按照正方形的方式来进行切片，比如切片大小为256*256。一个1024*1024的地图，就可以切成4张小的瓦片。 同时，瓦片大小几乎都是256*256，有一些则会增加到512*512。</p><p>LOD会使得不同层级下的全球地图大小不一致，结合瓦片技术一起，就出现了金字塔瓦片。 参见<a href="../ch05/05-03.md">万能瓦片地图加载秘籍</a>里面的图。 在<code>WebGIS</code>中，上一层级的一张瓦片，在更大一层级中，会用4张瓦片来表示，依次类推，比如上一节中看到的Google在线瓦片地图的第0级和第1级的瓦片地图。 这样做可以维持正方形的投影方式不变，同时按照2的幂次方放大，计算效率非常高。</p><h2 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h2><p>通过上面切片的介绍，我们可以对每一层级瓦片的数量进行简单的计算。 层级0的瓦片数是$$1=2^0<em>2^0$$， 层级1的瓦片数是$$4=2^1</em>2^1$$，层级n的瓦片数是$$2^n*2^n$$。 这个地方计算的是所有瓦片数，因为是一个正方形，所以是边长的平方，如只计算x轴或者y轴一边的瓦片数，就是$$2^n$$个。</p><h2 id="瓦片坐标"><a href="#瓦片坐标" class="headerlink" title="瓦片坐标"></a>瓦片坐标</h2><p>任意一个层级的地图，切成多个瓦片后，我们需要给瓦片编号，才能通过编号找到瓦片。这个问题在这就涉及到坐标系，在<a href="../ch05/05-03.md">万能瓦片地图加载秘籍</a>里我们提到过，不同的在线地图服务商，可能定义不一样的瓦片坐标系，坐标系不一样，那么对应的同一个位置的瓦片的坐标也会不一样。 需要引起重视。</p><p>在OpenLayers 3提供了一个用于调试瓦片的<code>source</code>: <code>ol.source.TileDebug</code>。可以清晰的看到每一个瓦片的坐标：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var osmSource = new ol.source.OSM();    var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: osmSource      }),      new ol.layer.Tile({        source: new ol.source.TileDebug({          projection: 'EPSG:3857',          tileGrid: osmSource.getTileGrid()        })      })    ],    target: 'map',    view: new ol.View({      center: ol.proj.transform(          [104, 30], 'EPSG:4326', 'EPSG:3857'),      zoom: 10    })});</script><p>代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> osmSource = <span class="keyword">new</span> ol.source.OSM();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 加载Open Street Map地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="undefined">    source: osmSource</span></span><br><span class="line"><span class="undefined">  &#125;),</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加一个显示Open Street Map地图瓦片网格的图层</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.TileDebug(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:3857'</span>,</span></span><br><span class="line"><span class="undefined">      tileGrid: osmSource.getTileGrid()</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>首先从上图可以看到地图上多了网格，每一个网格对应的就是一个瓦片。 其次网格中有三个数字，这些数字就表示当前瓦片的坐标，第一个数字是层级z，第二个数字是表示经度方向上的x，第三个数字是表示维度方向上的y。 同样的，可以采用上面的方式来看看在<a href="../ch05/05-03.md">万能瓦片地图加载秘籍</a>中提到的各种瓦片地图的瓦片坐标。</p><h1 id="分辨率"><a href="#分辨率" class="headerlink" title="分辨率"></a>分辨率</h1><p>前面简单提到过，分辨率是屏幕坐标和世界坐标的纽带，通过它，才能知道你在屏幕上用鼠标点击的位置对应于世界地图具体的经纬度位置。 当然你不用自己来做这个计算，OpenLayers 3的<code>ol.Map</code>已提供了对应的方法<code>getCoordinateFromPixel</code>来帮助你实现坐标转换。 你可能经常使用这个函数，但却不知道背后是怎样的一个原理，本小节将理清其中的来龙去脉。</p><p>上一节说到了每一个层级，会使用不同的瓦片数来表示整个地球，那么无论是哪一个层级，所表示的实际地理空间范围都是一致的。但使用的瓦片个数却是不一样的，以Google在线地图为例，层级0使用了一个瓦片，层级1使用了4个瓦片。 通过计算可以知道层级0整个地球图像为$$256<em>256$$像素大小，层级1整个地球图像为$$512</em>512$$像素大小。 层级0和层级1表示的地球范围都是一样的经度[-180, 180]，纬度[-90, 90]。 在层级0的时候，一个像素就表示$$\frac{360}{256} = 1.40625$$这么长的经度范围，$$\frac{180}{256}=0.703125$$这么长的纬度范围。 而这两个数字就是分辨率了，即一个像素所表达的范围是多少，这个范围可能是度，可能是米，或者其他单位，根据具体的情况而定。</p><h2 id="墨卡托投影坐标系下的分辨率"><a href="#墨卡托投影坐标系下的分辨率" class="headerlink" title="墨卡托投影坐标系下的分辨率"></a>墨卡托投影坐标系下的分辨率</h2><p>我们知道，在<code>WebGis</code>中使用的在线瓦片地图是采用的墨卡托(Mercator)投影坐标系，经过投影后，整个地球是一个正方形，所能表示的地球范围为经度[-180, 180]，纬度[-85, 85]，单位为度。 对应的墨卡托坐标系的范围x[-20037508.3427892, 20037508.3427892]，范围y同样是[-20037508.3427892, 20037508.3427892]，单位为m。 或许你会好奇这个范围是怎么计算而来的，如果详细了解过它的定义，应该知道墨卡托只是简单的把地球球面剖开拉伸为一个正方形而来，由于南北极两端采用这种拉伸会严重变形，并且南北极在使用过程中很少用到，所以干脆就只投影了[-85, 85]纬度范围的地球。 而展开时，因为纬度范围有缩减，所以肯定只能以经度来展开，即在经度-180度的地方从上到下剖开地球，然后按照赤道方向来展开成一张平面，那么这个平面的长，就等于以地球赤道半径按照圆来计算的周长。 近似的按照6378137米为半径来计算，那么整个赤道周长的一半，即为</p><blockquote><p>$$\pi<em>r=3.1415926</em>6378137=20037508.0009862$$</p></blockquote><p>以上就是墨卡托投影坐标系范围的完整的计算过程，墨卡托也有很多变形，会有细微的不同，OpenLayers 3默认使用的是EPSG:3857，对于该坐标系的详细定义，可以参见<a href="http://epsg.io/3857" target="_blank" rel="noopener">epsg.io 3867</a>。 </p><p>有了范围之后，要想计算分辨率，按照上面的计算过程就非常简单了，还是以Google在线瓦片地图为例，x方向上的分辨率计算公式可以归纳为：</p><blockquote><p>$$ resolution = \frac{rangeX}{256*2^{level}}$$</p></blockquote><p><code>rangeX</code>表示x方向上整个范围，比如 $$20037508.3427892 - (-20037508.3427892)$$，256表示的一个瓦片的宽度，单位为像素，$$2^{level}$$表示的在层级<code>level</code>下，x方向上的瓦片个数。 那么分母计算出来的结果就是在层级level下，整个地图在x方向上的宽度，单位为像素。 那么整个公式计算出来就是在x方向上一个像素所能代表的实际地理范围，即分辨率。</p><h2 id="OpenLayers默认使用的分辨率"><a href="#OpenLayers默认使用的分辨率" class="headerlink" title="OpenLayers默认使用的分辨率"></a>OpenLayers默认使用的分辨率</h2><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><p><div><span>当前层级：</span><span id="zoom"></span><span>分辨率：</span><span id="resolution"></span></div></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    map.getView().on('change:resolution', function(){        document.getElementById('zoom').innerHTML =  this.getZoom() + '，';        document.getElementById('resolution').innerHTML = this.getResolution();    })    document.getElementById('zoom').innerHTML = map.getView().getZoom() + '，';    document.getElementById('resolution').innerHTML = + map.getView().getResolution();</script><p>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>当前层级：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"zoom"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>分辨率：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"resolution"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 监听层级变化，输出当前层级和分辨率</span></span></span><br><span class="line"><span class="actionscript">map.getView().on(<span class="string">'change:resolution'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'zoom'</span>).innerHTML =  <span class="keyword">this</span>.getZoom() + <span class="string">'，'</span>;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'resolution'</span>).innerHTML = <span class="keyword">this</span>.getResolution();</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'zoom'</span>).innerHTML = map.getView().getZoom() + <span class="string">'，'</span>;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'resolution'</span>).innerHTML = + map.getView().getResolution();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>缩放上面的地图，从层级0开始，用前面介绍的公式和当前地图显示的分辨率进行比较，你会发现OpenLayers默认采用的分辨率和Google在线瓦片地图一样。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>为什么我们上面一直以Google在线瓦片地图举例说明？ 因为不同的在线瓦片地图可能采用不一样的分辨率，比如百度在线瓦片地图。 所以在使用在线瓦片地图或者自己制作的瓦片地图时，都需要知道使用的分辨率是多少。 如若不然，可能也会出现位置偏移。 </p><h1 id="自定义瓦片地图及加载"><a href="#自定义瓦片地图及加载" class="headerlink" title="自定义瓦片地图及加载"></a>自定义瓦片地图及加载</h1>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;LOD与分辨率&quot;&gt;&lt;a href=&quot;#LOD与分辨率&quot; class=&quot;headerlink&quot; title=&quot;LOD与分辨率&quot;&gt;&lt;/a&gt;LOD与分辨率&lt;/h1&gt;&lt;p&gt;LOD是Levels of Detail的简写，用于根据当前的环境，渲染不同的图像，用于降低非重要的细节度，从而提高渲染效率，在电子游戏中经常运用，对于需要显示全球地图的&lt;code&gt;GIS&lt;/code&gt;系统而言，更需要应用这项技术。在&lt;a href=&quot;../ch05/05-03.md&quot;&gt;万能瓦片地图加载秘籍&lt;/a&gt;中，有简单的说明。 在不同的细节层次下，自然分辨率就可能不一样，这两者是紧密结合在一起的。 对于图形显示系统而言，分辨率作为屏幕坐标和世界坐标之间计算的纽带，其作用是非常重要的。 本章节将以实例的方式深入浅出的讲解这两个重要的概念，及在OpenLayers 3中的应用。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 图标及提示信息</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch07/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch07/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:08:35.115Z</updated>
    
    <content type="html"><![CDATA[<h1 id="图标及提示信息"><a href="#图标及提示信息" class="headerlink" title="图标及提示信息"></a>图标及提示信息</h1><p>图标是GIS应用中必不可少的要素，比如在地图上标注饭店，学校，加油站等，就需要添加图标，点击图标，可能需要提示更为详细的信息，比如地址，评价，或者更为复杂的业务信息。本节将从基本的应用入手讲解，直到比较高级一些的自定义特色图标和信息展示。</p><a id="more"></a><h1 id="应用overlay"><a href="#应用overlay" class="headerlink" title="应用overlay"></a>应用overlay</h1><p>在OpenLayer3中添加图标有两种方式，一种是我们这一小节马上就要介绍的，比较传统的<code>overlay</code>，另一种是下一小节马上就要介绍的<code>Feature</code> + <code>Style</code>的方式。 <code>overlay</code>之所以传统，是因为它就是传统的<code>html</code>方式显示图片。 下面就是用这种方式加载一个锚点的示例：</p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><div id="anchor"><img src="../img/anchor.png" alt="示例锚点"></div><br><script type="text/javascript"><br>  var map = new ol.Map({<br>    layers: [<br>      new ol.layer.Tile({<br>        source: new ol.source.OSM()<br>      })<br>    ],<br>    target: ‘map’,<br>    view: new ol.View({<br>      projection: ‘EPSG:4326’,<br>      center: [104, 30],<br>      zoom: 10<br>    })<br>  });<br><br>  var anchor = new ol.Overlay({<br>    element: document.getElementById(‘anchor’)<br>  });<br>  anchor.setPosition([104, 30]);<br>  map.addOverlay(anchor);<br></script><br><br>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--下面就是传统的显示一个图片图标的方式，用img--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"anchor"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../img/anchor.png"</span> <span class="attr">alt</span>=<span class="string">"示例锚点"</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 下面把上面的图标附加到地图上，需要一个ol.Overlay</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> anchor = <span class="keyword">new</span> ol.Overlay(&#123;</span></span><br><span class="line"><span class="javascript">    element: <span class="built_in">document</span>.getElementById(<span class="string">'anchor'</span>)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 关键的一点，需要设置附加到地图上的位置</span></span></span><br><span class="line"><span class="undefined">  anchor.setPosition([104, 30]);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 然后添加到map上</span></span></span><br><span class="line"><span class="undefined">  map.addOverlay(anchor);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>代码的说明参加注释，最终效果是在地图中间有一个锚点图标。<br><br>## 缺点<br>当图标比较多的情况下，如果采用这种方式，那么我们会加入非常多的HTML元素，从而造成效率降低。 关于效率的测试，大家可以自行测试。 为什么会这样呢？ 因为界面上元素的遍历在数量比较多的情况下，会变慢，基于此基础上的渲染，鼠标事件都会变慢。<br><br>## 优点<br>这种使用传统的方式显示图标可以应用传统的HTML技术，比如鼠标移动到图标上，鼠标图标变成手势。 我们可以用css来处理就可以了，比如在<code>head</code>里面添加下面的代码：<br><br><style type="text/css"><br>    #anchor {<br>        cursor:pointer;<br>    }<br></style><br><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-id">#anchor</span> &#123;</span></span><br><span class="line"><span class="css"><span class="selector-tag">cursor</span><span class="selector-pseudo">:pointer</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>就可以看到鼠标放到锚点上去的时候，鼠标图标从箭头，变成手了。 类似的其他技术都可以应用上去，比如css动画。 鉴于动画在前端的重要性，下面单独分出一个小节用实例来讲解。<br><br># 动画图标<br><br>动起来的图标会更有吸引力，下面用<code>overlay</code>+<code>css</code>的方式来实现：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br>    <style type="text/css"><br>      @keyframes zoom<br>      {<br>        from {top: 0; left: 0; width: 32px; height: 32px;}<br>        50% {top: -16px; left: -16px; width: 64px; height: 64px;}<br>        to {top: 0; left: 0; width: 32px; height: 32px;}<br>      }<br><br>      @-moz-keyframes zoom /<em> Firefox </em>/<br>      {<br>        from {top: 0; left: 0; width: 32px; height: 32px;}<br>        50% {top: -16px; left: -16px; width: 64px; height: 64px;}<br>        to {top: 0; left: 0; width: 32px; height: 32px;}<br>      }<br><br>      @-webkit-keyframes zoom /<em> Safari 和 Chrome </em>/<br>      {<br>        from {top: 0; left: 0; width: 32px; height: 32px;}<br>        50% {top: -16px; left: -16px; width: 64px; height: 64px;}<br>        to {top: 0; left: 0; width: 32px; height: 32px;}<br>      }<br><br>      @-o-keyframes zoom /<em> Opera </em>/<br>      {<br>        from {top: 0; left: 0; width: 32px; height: 32px;}<br>        50% {top: -16px; left: -16px; width: 64px; height: 64px;}<br>        to {top: 0; left: 0; width: 32px; height: 32px;}<br>      }<br><br>      #anchorImg<br>      {<br>        display: block;<br>        position: absolute;<br>        animation: zoom 5s;<br>        animation-iteration-count: infinite;<br>        -moz-animation: zoom 5s; /<em> Firefox </em>/<br>        -moz-animation-iteration-count: infinite;<br>        -webkit-animation: zoom 5s;  /<em> Safari 和 Chrome </em>/<br>        -webkit-animation-iteration-count: infinite;<br>        -o-animation: zoom 5s; /<em> Opera </em>/<br>        -o-animation-iteration-count: infinite;<br>      }<br><br>    </style><br></head><p><div id="map" style="width: 100%"></div></p><p><div id="anchor" style="width: 64px;height: 64px;"><img id="anchorImg" src="../img/anchor.png" alt="示例锚点"></div></p><script type="text/javascript">  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      })    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var anchor = new ol.Overlay({    element: document.getElementById('anchor')  });  anchor.setPosition([104, 30]);  map.addOverlay(anchor);</script><p>代码和之前的例子差不多，只是多了css动画的设置：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--定义动画，图标先放大，再缩小--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">  @<span class="keyword">keyframes</span> zoom</span></span><br><span class="line"><span class="undefined">  &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">from</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="css">    50% &#123;<span class="attribute">top</span>: -<span class="number">16px</span>; <span class="attribute">left</span>: -<span class="number">16px</span>; <span class="attribute">width</span>: <span class="number">64px</span>; <span class="attribute">height</span>: <span class="number">64px</span>;&#125;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">to</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  @-<span class="keyword">moz</span>-<span class="keyword">keyframes</span> zoom /* Firefox */</span></span><br><span class="line"><span class="undefined">  &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">from</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="css">    50% &#123;<span class="attribute">top</span>: -<span class="number">16px</span>; <span class="attribute">left</span>: -<span class="number">16px</span>; <span class="attribute">width</span>: <span class="number">64px</span>; <span class="attribute">height</span>: <span class="number">64px</span>;&#125;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">to</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  @-<span class="keyword">webkit</span>-<span class="keyword">keyframes</span> zoom /* Safari 和 Chrome */</span></span><br><span class="line"><span class="undefined">  &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">from</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="css">    50% &#123;<span class="attribute">top</span>: -<span class="number">16px</span>; <span class="attribute">left</span>: -<span class="number">16px</span>; <span class="attribute">width</span>: <span class="number">64px</span>; <span class="attribute">height</span>: <span class="number">64px</span>;&#125;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">to</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  @-<span class="keyword">o</span>-<span class="keyword">keyframes</span> zoom /* Opera */</span></span><br><span class="line"><span class="undefined">  &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">from</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="css">    50% &#123;<span class="attribute">top</span>: -<span class="number">16px</span>; <span class="attribute">left</span>: -<span class="number">16px</span>; <span class="attribute">width</span>: <span class="number">64px</span>; <span class="attribute">height</span>: <span class="number">64px</span>;&#125;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">to</span> &#123;<span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">32px</span>; <span class="attribute">height</span>: <span class="number">32px</span>;&#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="comment">/* 应用css动画到图标元素上 */</span></span></span><br><span class="line"><span class="css">  <span class="selector-id">#anchorImg</span></span></span><br><span class="line"><span class="undefined">  &#123;</span></span><br><span class="line"><span class="undefined">    display: block;</span></span><br><span class="line"><span class="undefined">    position: absolute;</span></span><br><span class="line"><span class="undefined">    animation: zoom 5s;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">animation-iteration-count</span>: <span class="selector-tag">infinite</span>; <span class="comment">/* 一直重复动画 */</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">-moz-animation</span>: <span class="selector-tag">zoom</span> 5<span class="selector-tag">s</span>; <span class="comment">/* Firefox */</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">-moz-animation-iteration-count</span>: <span class="selector-tag">infinite</span>; <span class="comment">/* 一直重复动画 */</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">-webkit-animation</span>: <span class="selector-tag">zoom</span> 5<span class="selector-tag">s</span>;  <span class="comment">/* Safari 和 Chrome */</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">-webkit-animation-iteration-count</span>: <span class="selector-tag">infinite</span>; <span class="comment">/* 一直重复动画 */</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">-o-animation</span>: <span class="selector-tag">zoom</span> 5<span class="selector-tag">s</span>; <span class="comment">/* Opera */</span></span></span><br><span class="line"><span class="css">    <span class="selector-tag">-o-animation-iteration-count</span>: <span class="selector-tag">infinite</span>; <span class="comment">/* 一直重复动画 */</span></span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"anchor"</span> <span class="attr">style</span>=<span class="string">"width: 64px;height: 64px;"</span> &gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">'anchorImg'</span> <span class="attr">src</span>=<span class="string">"../img/anchor.png"</span> <span class="attr">alt</span>=<span class="string">"示例锚点"</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> anchor = <span class="keyword">new</span> ol.Overlay(&#123;</span></span><br><span class="line"><span class="javascript">    element: <span class="built_in">document</span>.getElementById(<span class="string">'anchor'</span>)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined">  anchor.setPosition([104, 30]);</span></span><br><span class="line"><span class="undefined">  map.addOverlay(anchor);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>除了这种css实现动画之外，你还可以直接加载gif动画，这是非常简单的，再此不表。</p><h1 id="设置图标位置"><a href="#设置图标位置" class="headerlink" title="设置图标位置"></a>设置图标位置</h1><p>如果像之前那样设置图标，不做任何位置设置，那么默认情况下，图标的中心点对应于地图位置。下面这个地图显示了这个位置，中心那个红点所处位置就是[104, 30]，可以这个点对应于图标的中心位置： </p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">  var layer2 = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map2 = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer2    ],    target: 'map2',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var anchor2 = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  anchor2.setStyle(new ol.style.Style({    image: new ol.style.Icon({      src: '../img/anchor.png'    })  }));  layer2.getSource().addFeature(anchor2);  var refFeature = new ol.Feature({      geometry: new ol.geom.Point([104, 30])  })  refFeature.setStyle(new ol.style.Style({      image: new ol.style.Circle({          radius: 2,          fill: new ol.style.Fill({              color: 'red'          })      })  }));  layer2.getSource().addFeature(refFeature);</script><p>有时候我们可能并不想这样，比如我们希望锚点图标下方的箭头指向地图位置。 比如这样：</p><p><div id="map3" style="width: 100%"></div></p><script type="text/javascript">  var layer3 = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map3 = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer3    ],    target: 'map3',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var anchor3 = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  anchor3.setStyle(new ol.style.Style({    image: new ol.style.Icon({      src: '../img/anchor.png',      anchor: [0.5, 1]    })  }));  layer3.getSource().addFeature(anchor3);  var refFeature3 = new ol.Feature({      geometry: new ol.geom.Point([104, 30])  })  refFeature3.setStyle(new ol.style.Style({      image: new ol.style.Circle({          radius: 2,          fill: new ol.style.Fill({              color: 'red'          })      })  }));  layer3.getSource().addFeature(refFeature3);</script><p>要做到这个效果，我们只需要把设置样式的代码加上<code>anchor</code>的设置：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span><br><span class="line">  src: <span class="string">'../img/anchor.png'</span>,</span><br><span class="line">  anchor: [<span class="number">0.5</span>, <span class="number">1</span>]<span class="comment">// 设置图标位置</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>为什么是[0.5, 1]这种值，表示什么？ 默认情况下，位置坐标是按照比例的方式来设置的，范围从0到1，x轴上0表示最左边，1表示最右边，y轴上0表示最上边，1表示最下边。 如代码所示，x设置为0.5可以让图片在x方向上居中，y设置为1可以让图片在y方向上移动到最底端。 大家可以给予上面这个代码修改一下，试试[0, 0]会让图标处于什么位置？</p><p>除了按照比例进行移动之外，还可以按照像素来计算位置，但必须显示设置<code>anchorXUnits</code>或    <code>anchorYUnits</code>为<code>pixels</code>。 根据不同的需要，可以采用不同的单位来设置。</p><h1 id="根据层级放大缩小图标"><a href="#根据层级放大缩小图标" class="headerlink" title="根据层级放大缩小图标"></a>根据层级放大缩小图标</h1><p>由于图标不会跟随图层的放大缩小而放大缩小，所以在某些业务应用中，可能并不合适，需要也跟随变化。 之前就有同学提到这个问题，在<code>ol.style.Icon</code>中是可以设置<code>scale</code>的，这样就为<br>我们提供了方便。 通过设置它，就可以做到。 下面这个地图中的锚点图标，就会随着地图放大缩小而变化大小：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var anchor = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  anchor.setStyle(new ol.style.Style({    image: new ol.style.Icon({      src: '../img/anchor.png'    })  }));  layer.getSource().addFeature(anchor);  map.getView().on('change:resolution', function(){      var style = anchor.getStyle();      style.getImage().setScale(this.getZoom() / 10);      anchor.setStyle(style);  })</script><p>和之前的代码绝大部分都是相同的：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> anchor = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  anchor.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    image: <span class="keyword">new</span> ol.style.Icon(&#123;</span></span><br><span class="line"><span class="actionscript">      src: <span class="string">'../img/anchor.png'</span></span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(anchor);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 监听地图层级变化</span></span></span><br><span class="line"><span class="actionscript">  map.getView().on(<span class="string">'change:resolution'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> style = anchor.getStyle();</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 重新设置图标的缩放率，基于层级10来做缩放</span></span></span><br><span class="line"><span class="actionscript">  style.getImage().setScale(<span class="keyword">this</span>.getZoom() / <span class="number">10</span>);</span></span><br><span class="line"><span class="undefined">  anchor.setStyle(style);</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>利用一个监听和<code>scale</code>改变，就实现了这个同比缩放。 具体缩放多少，请根据业务来设置，可以设置的更加精细，此处只是功能示例。 其实还有另外一种方式，可以实现动态缩放大小，参见<a href="07-04.md">styleFunction应用</a>。</p><h1 id="另类设置svg图标"><a href="#另类设置svg图标" class="headerlink" title="另类设置svg图标"></a>另类设置svg图标</h1><p>图标除了可以直接设置png的文件url之外，也可以设置svg的文件url，但这并不是唯一的加载svg图标的方式。 OpenLayers 3提供了直接使用图像对象来设置的方式，对应于<code>ol.style.Icon</code>构造函数中的<code>img</code>参数。 如下：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var anchor = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  // 构建svg的Image对象  var svg = '<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">'+    '<path fill="#156BB1" d="M22.906,10.438c0,4.367-6.281,14.312-7.906,17.031c-1.719-2.75-7.906-12.665-7.906-17.031S10.634,2.531,15,2.531S22.906,6.071,22.906,10.438z"/>'+'<circle fill="#FFFFFF" cx="15" cy="10.677" r="3.291"/></svg>';    var mysvg = new Image();    mysvg.src = 'data:image/svg+xml,' + escape(svg);  anchor.setStyle(new ol.style.Style({    image: new ol.style.Icon({      img: mysvg,    // 设置Image对象      imgSize: [30, 30]    // 及图标大小//          src: 'http://www.williambuck.com/portals/0/Skins/WilliamBuck2014/images/location-icon.svg',//          size: [30, 30]    })  }));  layer.getSource().addFeature(anchor);</script><p>对应的代码：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> anchor = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 构建svg的Image对象</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">  var svg = '<span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"30px"</span> <span class="attr">height</span>=<span class="string">"30px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 30 30"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 30 30"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>'+    </span></span></span><br><span class="line"><span class="handlebars"><span class="xml">'<span class="tag">&lt;<span class="name">path</span> <span class="attr">fill</span>=<span class="string">"#156BB1"</span> <span class="attr">d</span>=<span class="string">"M22.906,10.438c0,4.367-6.281,14.312-7.906,17.031c-1.719-2.75-7.906-12.665-7.906-17.031S10.634,2.531,15,2.531S22.906,6.071,22.906,10.438z"</span>/&gt;</span>'+</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">'<span class="tag">&lt;<span class="name">circle</span> <span class="attr">fill</span>=<span class="string">"#FFFFFF"</span> <span class="attr">cx</span>=<span class="string">"15"</span> <span class="attr">cy</span>=<span class="string">"10.677"</span> <span class="attr">r</span>=<span class="string">"3.291"</span>/&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span>';</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mysvg = <span class="keyword">new</span> Image();</span></span><br><span class="line"><span class="javascript">mysvg.src = <span class="string">'data:image/svg+xml,'</span> + <span class="built_in">escape</span>(svg);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  anchor.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    image: <span class="keyword">new</span> ol.style.Icon(&#123;</span></span><br><span class="line"><span class="actionscript">      img: mysvg,<span class="comment">// 设置Image对象</span></span></span><br><span class="line"><span class="actionscript">      imgSize: [<span class="number">30</span>, <span class="number">30</span>]<span class="comment">// 及图标大小</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">//          src: 'http://www.williambuck.com/portals/0/Skins/WilliamBuck2014/images/location-icon.svg',</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">//          size: [30, 30]</span></span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(anchor);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>前半部分代码都一样，最后设置样式的时候，可以根据注释来理解不一样的代码，构建<code>Image</code>对象，设置<code>src</code>是关键。</p><h1 id="规则几何体图标"><a href="#规则几何体图标" class="headerlink" title="规则几何体图标"></a>规则几何体图标</h1><p>相对于png而言，svg这样的矢量图在放大缩小方面更清晰，但对于规则几何体而言，如果也使用svg，未免复杂了一点，OpenLayers 3为了简化这样的操作，提供了一个规则几何体的样式类<code>ol.style.RegularShape</code>，使用它可以轻松绘制正方形，三角形等,也支持星形规则几何图形，比如下面这样：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var shape = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  shape.setStyle(new ol.style.Style({    image: new ol.style.RegularShape({      points: 3,      radius: 10,      stroke: new ol.style.Stroke({          color: 'red',          size: 2      })    })  }));  layer.getSource().addFeature(shape);    var star = new ol.Feature({    geometry: new ol.geom.Point([104.1, 30.1])  });  star.setStyle(new ol.style.Style({    image: new ol.style.RegularShape({      points: 5,      radius1: 20,      radius2: 10,      stroke: new ol.style.Stroke({          color: 'red',          size: 2      }),      fill: new ol.style.Fill({ // 设置五星填充样式          color: 'blue'      })    })  }));  layer.getSource().addFeature(star);</script><p>图上有一个三角形，一个5星，代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加一个三角形</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> shape = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  shape.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    image: <span class="keyword">new</span> ol.style.RegularShape(&#123;</span></span><br><span class="line"><span class="actionscript">      points: <span class="number">3</span>,<span class="comment">// 顶点数</span></span></span><br><span class="line"><span class="actionscript">      radius: <span class="number">10</span>,<span class="comment">// 图形大小，单位为像素</span></span></span><br><span class="line"><span class="actionscript">      stroke: <span class="keyword">new</span> ol.style.Stroke(&#123; <span class="comment">// 设置边的样式</span></span></span><br><span class="line"><span class="actionscript">      color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">      size: 2</span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(shape);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加一个五星</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> star = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104.1</span>, <span class="number">30.1</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  star.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    image: <span class="keyword">new</span> ol.style.RegularShape(&#123;</span></span><br><span class="line"><span class="actionscript">      points: <span class="number">5</span>,<span class="comment">// 顶点个数</span></span></span><br><span class="line"><span class="actionscript">      radius1: <span class="number">20</span>, <span class="comment">// 外圈大小</span></span></span><br><span class="line"><span class="actionscript">      radius2: <span class="number">10</span>, <span class="comment">// 内圈大小</span></span></span><br><span class="line"><span class="actionscript">      stroke: <span class="keyword">new</span> ol.style.Stroke(&#123; <span class="comment">// 设置边的样式</span></span></span><br><span class="line"><span class="actionscript">      color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">      size: 2</span></span><br><span class="line"><span class="undefined">      &#125;),</span></span><br><span class="line"><span class="actionscript">      fill: <span class="keyword">new</span> ol.style.Fill(&#123; <span class="comment">// 设置五星填充样式</span></span></span><br><span class="line"><span class="actionscript">      color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(star);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>除了基本的设置之外，还支持图形旋转，以及跟随地图旋转而旋转，这些设置在其他的应用中也多有涉及，此处不再用实例来介绍，可自行验证。</p><h1 id="用Canvas自绘图标"><a href="#用Canvas自绘图标" class="headerlink" title="用Canvas自绘图标"></a>用Canvas自绘图标</h1><p>除了规则的几何体之外，往往需要定义一些不规则的几何体，可以使用svg来实现，但也可以用<code>canvas</code>自己来绘制，比如像下面这个图标：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  // 使用canvas绘制一个不规则几何图形    var canvas =document.createElement('canvas');    canvas.width = 20;  canvas.height = 20;    var context = canvas.getContext("2d");    context.strokeStyle = "red";    context.lineWidth = 1;    context.beginPath();     context.moveTo(0, 0);  context.lineTo(20, 10);  context.lineTo(0, 20);  context.lineTo(10, 10);  context.lineTo(0, 0);    context.stroke();  // 把绘制了的canvas设置到style里面    var style = new ol.style.Style({        image: new ol.style.Icon({          img: canvas,          imgSize: [canvas.width, canvas.height],          rotation: 90 * Math.PI / 180        })    });    // 创建一个Feature  var shape = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  // 应用具有不规则几何图形的样式到Feature  shape.setStyle(style);  layer.getSource().addFeature(shape);</script><p>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 使用canvas绘制一个不规则几何图形</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> canvas =<span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span></span><br><span class="line"><span class="undefined">canvas.width = 20;</span></span><br><span class="line"><span class="undefined">  canvas.height = 20;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> context = canvas.getContext(<span class="string">"2d"</span>);</span></span><br><span class="line"><span class="actionscript">context.strokeStyle = <span class="string">"red"</span>;  </span></span><br><span class="line"><span class="undefined">  context.lineWidth = 1;  </span></span><br><span class="line"><span class="undefined">  context.beginPath();   </span></span><br><span class="line"><span class="undefined">  context.moveTo(0, 0);</span></span><br><span class="line"><span class="undefined">  context.lineTo(20, 10);</span></span><br><span class="line"><span class="undefined">  context.lineTo(0, 20);</span></span><br><span class="line"><span class="undefined">  context.lineTo(10, 10);</span></span><br><span class="line"><span class="undefined">  context.lineTo(0, 0);  </span></span><br><span class="line"><span class="undefined">  context.stroke();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 把绘制了的canvas设置到style里面</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> style = <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span></span><br><span class="line"><span class="undefined">  img: canvas,</span></span><br><span class="line"><span class="undefined">  imgSize: [canvas.width, canvas.height],</span></span><br><span class="line"><span class="javascript">  rotation: <span class="number">90</span> * <span class="built_in">Math</span>.PI / <span class="number">180</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建一个Feature</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> shape = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 应用具有不规则几何图形的样式到Feature</span></span></span><br><span class="line"><span class="undefined">  shape.setStyle(style);</span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(shape);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>和svg的那个例子一样，使用了<code>ol.style.Icon</code>样式的<code>img</code>属性来设置，需要注意的是，必须设置<code>imgSize</code>属性，因为仅仅通过<code>img</code>设置的图像对象，没有办法自动获取宽高。 同时，官网也提供了一个类似的例子<a href="http://openlayers.org/en/v3.13.1/examples/earthquake-custom-symbol.html" target="_blank" rel="noopener">earthquake-custom-symbol</a>，只是使用OpenLayers3 内部提供的封装库来绘制图像到<code>canvas</code>上，原理一样。</p><p>有了这种方式之后，相信做任何图标都不会遇到难题了。</p><h1 id="动态改变图标"><a href="#动态改变图标" class="headerlink" title="动态改变图标"></a>动态改变图标</h1><p>在实际业务应用中，需要根据环境条件，动态的修改图标样式，以反馈数据变化。 比如像下面这样，点击五星，五星图标会用红色填充：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });    var star = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  star.setStyle(new ol.style.Style({    image: new ol.style.RegularShape({      points: 5,      radius1: 20,      radius2: 10,      stroke: new ol.style.Stroke({          color: 'red',          size: 2      })    })  }));  layer.getSource().addFeature(star);  map.on('click', function(event){      var feature = map.forEachFeatureAtPixel(event.pixel, function(feature){          return feature;      });      if (feature) {          var style = feature.getStyle().getImage();          feature.setStyle(new ol.style.Style({            image: new ol.style.RegularShape({              points: 5,                  radius1: 20,                  radius2: 10,                  stroke: style.getStroke(),                  fill: new ol.style.Fill({                      color: 'red'                  })            })          }));      }  });</script><p>对应的代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加一个空心的五星</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> star = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  star.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    image: <span class="keyword">new</span> ol.style.RegularShape(&#123;</span></span><br><span class="line"><span class="undefined">      points: 5,</span></span><br><span class="line"><span class="undefined">      radius1: 20,</span></span><br><span class="line"><span class="undefined">      radius2: 10,</span></span><br><span class="line"><span class="actionscript">      stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">      color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">      size: 2</span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(star);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 监听地图点击事件</span></span></span><br><span class="line"><span class="actionscript">  map.on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> feature = map.forEachFeatureAtPixel(event.pixel, <span class="function"><span class="keyword">function</span><span class="params">(feature)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">return</span> feature;</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">if</span> (feature) &#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 将空心五星为红色实心五星</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> style = feature.getStyle().getImage();</span></span><br><span class="line"><span class="actionscript">  feature.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    image: <span class="keyword">new</span> ol.style.RegularShape(&#123;</span></span><br><span class="line"><span class="undefined">      points: 5,</span></span><br><span class="line"><span class="undefined">  radius1: 20,</span></span><br><span class="line"><span class="undefined">  radius2: 10,</span></span><br><span class="line"><span class="undefined">  stroke: style.getStroke(),</span></span><br><span class="line"><span class="actionscript">  fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">  color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h1 id="文字标注"><a href="#文字标注" class="headerlink" title="文字标注"></a>文字标注</h1><p>前面基本都在围绕着图标进行说明，其实用<code>Feature</code> + <code>Style</code>的方式，也是可以单独添加文字的，虽然简单，但可能有些同学会忽略这样的做法，所以在此用一个简单的示例来说明：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104.06, 30.67],      zoom: 10    })  });  var anchor = new ol.Feature({    geometry: new ol.geom.Point([104.06, 30.67])  });  anchor.setStyle(new ol.style.Style({    text: new ol.style.Text({      text: '淡叔所在地成都',      fill: new ol.style.Fill({          color: 'red'      })    })  }));  layer.getSource().addFeature(anchor);</script><p>代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104.06, 30.67],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> anchor = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104.06</span>, <span class="number">30.67</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 设置文字style</span></span></span><br><span class="line"><span class="actionscript">  anchor.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    text: <span class="keyword">new</span> ol.style.Text(&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// font: '10px sans-serif' 默认这个字体，可以修改成其他的，格式和css的字体设置一样</span></span></span><br><span class="line"><span class="actionscript">      text: <span class="string">'淡叔所在地成都'</span>,</span></span><br><span class="line"><span class="actionscript">      fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">      color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(anchor);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>还有很多属性可以设置，比如缩放，旋转，以及位移等等，非常简单，可自行设置调试。</p><h1 id="style及应用"><a href="#style及应用" class="headerlink" title="style及应用"></a>style及应用</h1><p>前面已经介绍了第一种加载图标的方式，现在介绍第二种方式，使用<code>Feature</code> + <code>Style</code>来实现，用这种方式实现之前的效果如下：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var anchor = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  anchor.setStyle(new ol.style.Style({    image: new ol.style.Icon({      src: '../img/anchor.png'    })  }));  layer.getSource().addFeature(anchor);</script><p>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 我们需要一个vector的layer来放置图标</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建一个Feature，并设置好在地图上的位置</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> anchor = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 设置样式，在样式中就可以设置图标</span></span></span><br><span class="line"><span class="actionscript">  anchor.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">    image: <span class="keyword">new</span> ol.style.Icon(&#123;</span></span><br><span class="line"><span class="actionscript">      src: <span class="string">'../img/anchor.png'</span></span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加到之前的创建的layer中去</span></span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(anchor);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>效果是一样的，但从代码上来看，是不一样的:</p><ul><li>首先<code>overlay</code>需要HTML元素<code>img</code>，但这种方式不需要</li><li><code>overlay</code>是添加在<code>map</code>上的，但是这种方式需要一个<code>Vector</code>的layer，并添加在其上</li><li>我们没有办法像<code>overlay</code>那样使用一些HTML技术</li></ul><h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>虽然不能用css直接修改图标显示，但并不是说使用这种方式没有自定义的余地，大家可以先在官网API上看一下<code>ol.style.Icon</code>的构造参数，会看到可以设置位置，透明度，放大缩小，旋转等，基本能满足大多数的应用，由于和<code>CSS</code>不同，很多同学在应用时遇到一些问题，所以下面给出了一些具体的使用示例。</p><h1 id="styleFunction应用"><a href="#styleFunction应用" class="headerlink" title="styleFunction应用"></a>styleFunction应用</h1><p>很多时候，我们会忽略<code>styleFunction</code>的存在，但很明显的，它可以让我们的图标或者标签应用更加灵活，比如<a href="07-03-02.md">根据层级放大缩小图标</a>也可以用<code>styleFunction</code>来实现：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol-debug.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">  var layer = new ol.layer.Vector({    source: new ol.source.Vector()  })  var map = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer    ],    target: 'map',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var anchor = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  anchor.setStyle(function(resolution){      return [new ol.style.Style({          image: new ol.style.Icon({            src: '../img/anchor.png',            scale: map.getView().getZoom() / 10          })        })];  });  layer.getSource().addFeature(anchor);</script><p>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> anchor = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 应用style function，动态的获取样式</span></span></span><br><span class="line"><span class="actionscript">  anchor.setStyle(<span class="function"><span class="keyword">function</span><span class="params">(resolution)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">return</span> [<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">  image: <span class="keyword">new</span> ol.style.Icon(&#123;</span></span><br><span class="line"><span class="actionscript">    src: <span class="string">'../img/anchor.png'</span>,</span></span><br><span class="line"><span class="undefined">    scale: map.getView().getZoom() / 10</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">&#125;)];</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  layer.getSource().addFeature(anchor);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>对比一下前面同样功能的代码，你会发现这样更加的简单， 同时在此基础上扩展开来的应用也会更加的多。 比如动态替换图标，或者让图标不显示等等，可自行来实现这两个需求，以掌握此方式的使用。 </p><p>在上面这个例子中，我们是在<code>feature</code>上应用了<code>styleFunction</code>，通过官网API文档可以看到，其类型为<code>ol.FeatureStyleFunction</code>，函数仅带有一个参数<code>resolution</code>，在上面的代码中看到了，在函数体内<code>this</code>指的是当前的<code>feature</code>，根据文档说明，这个函数要范围一个<code>style</code>数组。 这一点需要注意，虽然实际使用中，即使没有返回数组也不会出错，但还是希望大家能遵守官网API的说明来使用该接口。</p><p>我们知道，除了<code>feature</code>可以设置样式之外，<code>layer</code>也是可以设置样式的，同样地也支持<code>styleFunction</code>，但是需要注意的是，其定义和<code>feature</code>的不一样，类型为<code>ol.style.StyleFunction</code>，该函数具有两个参数，第一个参数为<code>feature</code>，第二个参数为<code>resolution</code>，同样地，该函数需要返回<code>style</code>数组。 </p><p><code>styleFunction</code>在<code>feature</code>上具有很好的灵活性，那么应用在<code>layer</code>上，同样威力无穷，比如像下面这个：</p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">  var layerStyleFunction = function(feature, resolution) {    var type = feature.get('type');    var style = null;    if (type === 'point') {      style = new ol.style.Style({        image: new ol.style.Circle({          radius: 1,          fill: new ol.style.Fill({            color: 'red'          })        })      });    } else if ( type === 'circle') {      style = new ol.style.Style({        image: new ol.style.Circle({          radius: 10,          stroke: new ol.style.Stroke({            color: 'red',            size: 1          })        })      });    } else {      style = new ol.style.Style({        image: new ol.style.RegularShape({          points: 5,          radius: 10,          fill: new ol.style.Fill({            color: 'blue'          })        })      });    }    return [style];  };  var layer2 = new ol.layer.Vector({    source: new ol.source.Vector(),    style: layerStyleFunction  });  var map2 = new ol.Map({    layers: [      new ol.layer.Tile({        source: new ol.source.OSM()      }),       layer2    ],    target: 'map2',    view: new ol.View({      projection: 'EPSG:4326',      center: [104, 30],      zoom: 10    })  });  var rect = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  layer2.getSource().addFeature(rect);  var circle = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  circle.set('type', 'circle');  layer2.getSource().addFeature(circle);  var point = new ol.Feature({    geometry: new ol.geom.Point([104, 30])  });  point.set('type', 'point');  layer2.getSource().addFeature(point);</script><p>在地图上可以看到中心位置有一个圆，一个点，一个五边形，但这次都没有直接在这些<code>feature</code>上设置样式，具体的代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建layer使用的style function，根据feature的自定义type，返回不同的样式</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layerStyleFunction = <span class="function"><span class="keyword">function</span><span class="params">(feature, resolution)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> type = feature.get(<span class="string">'type'</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> style = <span class="literal">null</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 点</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span> (type === <span class="string">'point'</span>) &#123;</span></span><br><span class="line"><span class="actionscript">      style = <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">          radius: 1,</span></span><br><span class="line"><span class="actionscript">          fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">            color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">          &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="actionscript">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( type === <span class="string">'circle'</span>) &#123; <span class="comment">// 圆形</span></span></span><br><span class="line"><span class="actionscript">      style = <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">          radius: 10,</span></span><br><span class="line"><span class="actionscript">          stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">            color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">            size: 1</span></span><br><span class="line"><span class="undefined">          &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="actionscript">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 其他形状</span></span></span><br><span class="line"><span class="actionscript">      style = <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        image: <span class="keyword">new</span> ol.style.RegularShape(&#123;</span></span><br><span class="line"><span class="undefined">          points: 5,</span></span><br><span class="line"><span class="undefined">          radius: 10,</span></span><br><span class="line"><span class="actionscript">          fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">            color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">          &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 返回 style 数组</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> [style];</span></span><br><span class="line"><span class="undefined">  &#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> layer2 = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">    style: layerStyleFunction <span class="comment">// 应用上面创建的 style function</span></span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">    layers: [</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), </span></span><br><span class="line"><span class="undefined">      layer2</span></span><br><span class="line"><span class="undefined">    ],</span></span><br><span class="line"><span class="actionscript">    target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">    view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">      projection: <span class="string">'EPSG:4326'</span>,</span></span><br><span class="line"><span class="undefined">      center: [104, 30],</span></span><br><span class="line"><span class="undefined">      zoom: 10</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 添加三个feature，并设置自定义属性 type</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> rect = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined">  layer2.getSource().addFeature(rect);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> circle = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  circle.set(<span class="string">'type'</span>, <span class="string">'circle'</span>);</span></span><br><span class="line"><span class="undefined">  layer2.getSource().addFeature(circle);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> point = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">    geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">104</span>, <span class="number">30</span>])</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="actionscript">  point.set(<span class="string">'type'</span>, <span class="string">'point'</span>);</span></span><br><span class="line"><span class="undefined">  layer2.getSource().addFeature(point);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这就是一个典型的根据<code>feature</code>的属性进行不同渲染的例子，可以在业务上无限扩展，比如<code>feature</code>的属性可以是速度，可以是大小，可以是时间，可以是权重等等。 由此可见，只要掌握了这个方法，前端按照条件渲染就不再困难。</p><h1 id="大量图标方案"><a href="#大量图标方案" class="headerlink" title="大量图标方案"></a>大量图标方案</h1><p>此处的大量图标方案，不涉及服务器端，如果图标不进行交互，可以把图标渲染到底图上。 此处只介绍说明在前端可交互的大量图标方案，在图标数量不大的情况，无论使用什么方式加载，都不会有性能问题，当图标多了之后，就会出现卡顿，内存占用增大等问题。 在OpenLayers 3开发中，可以考虑下面两个方案来解决这个问题。</p><h2 id="复用样式减少内存占用"><a href="#复用样式减少内存占用" class="headerlink" title="复用样式减少内存占用"></a>复用样式减少内存占用</h2><p>在应用大量图标的时候，其实图标样式差异化并不大，比如快餐店，公共厕所，公交站点等等有很多，但都是用同样的图标在地图上标准，在不注意的时候，我们是采用下面的方式来添加图标的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; <span class="number">10000</span>; index++) &#123;</span><br><span class="line"><span class="keyword">var</span> feature = <span class="keyword">new</span> ol.Feature(&#123;</span><br><span class="line">geometry: <span class="keyword">new</span> ol.geom.Point([latlon[index].lon, latlon[index].lat])</span><br><span class="line">&#125;);</span><br><span class="line">feature.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span><br><span class="line">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span><br><span class="line">src: <span class="string">'../img/marker.png'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意上面代码，对每个<code>feature</code>设置<code>style</code>的时候，都是直接<code>new</code>的，这样势必会创建很多对象，占用很多内存。 那么复用必然减少很多内存，重构上面的代码为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> style = <span class="keyword">new</span> ol.style.Style(&#123;</span><br><span class="line">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span><br><span class="line">src: <span class="string">'../img/marker.png'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; <span class="number">10000</span>; index++) &#123;</span><br><span class="line"><span class="keyword">var</span> feature = <span class="keyword">new</span> ol.Feature(&#123;</span><br><span class="line">geometry: <span class="keyword">new</span> ol.geom.Point([latlon[index].lon, latlon[index].lat])</span><br><span class="line">&#125;);</span><br><span class="line">feature.setStyle(style);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样，我们就只创建了一个<code>style</code>对象，那么势必减少内存占用。 如果有多类图标，可以用数组缓存下来：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> styles = [</span><br><span class="line"><span class="keyword">new</span> ol.style.Style(&#123;</span><br><span class="line">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span><br><span class="line">src: <span class="string">'../img/marker1.png'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;),</span><br><span class="line"><span class="keyword">new</span> ol.style.Style(&#123;</span><br><span class="line">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span><br><span class="line">src: <span class="string">'../img/marker2.png'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;),</span><br><span class="line"><span class="keyword">new</span> ol.style.Style(&#123;</span><br><span class="line">image: <span class="keyword">new</span> ol.style.Icon(&#123;</span><br><span class="line">src: <span class="string">'../img/marker3.png'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; <span class="number">10000</span>; index++) &#123;</span><br><span class="line"><span class="keyword">var</span> feature = <span class="keyword">new</span> ol.Feature(&#123;</span><br><span class="line">geometry: <span class="keyword">new</span> ol.geom.Point([latlon[index].lon, latlon[index].lat])</span><br><span class="line">&#125;);</span><br><span class="line">feature.setStyle(styles[index % styles.length]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于官网有实际的例子，大家请移步到<a href="http://openlayers.org/en/v3.13.1/examples/icon-sprite-webgl.html" target="_blank" rel="noopener">icon-sprite-webgl</a>。 下面是其中的一些代码片段，在里面加入了一些注释，便于大家理解：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预先设置好要使用的style，并缓存在icons数组中</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; iconCount; ++i) &#123;</span><br><span class="line">  <span class="keyword">var</span> info = iconInfo[i];</span><br><span class="line">  icons[i] = <span class="keyword">new</span> ol.style.Icon(&#123;</span><br><span class="line">    offset: info.offset,</span><br><span class="line">    opacity: info.opacity,</span><br><span class="line">    rotateWithView: info.rotateWithView,</span><br><span class="line">    rotation: info.rotation,</span><br><span class="line">    scale: info.scale,</span><br><span class="line">    size: info.size,</span><br><span class="line">    src: <span class="string">'data/Butterfly.png'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; featureCount; ++i) &#123;</span><br><span class="line">  geometry = <span class="keyword">new</span> ol.geom.Point(</span><br><span class="line">      [<span class="number">2</span> * e * <span class="built_in">Math</span>.random() - e, <span class="number">2</span> * e * <span class="built_in">Math</span>.random() - e]);</span><br><span class="line">  feature = <span class="keyword">new</span> ol.Feature(geometry);</span><br><span class="line">  feature.setStyle(</span><br><span class="line">      <span class="keyword">new</span> ol.style.Style(&#123;</span><br><span class="line">      <span class="comment">// 直接使用上面缓存的icons里面的样式</span></span><br><span class="line">        image: icons[i % (iconCount - <span class="number">1</span>)]</span><br><span class="line">      &#125;)</span><br><span class="line">  );</span><br><span class="line">  features[i] = feature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大家可在官网例子的基础上修改一下代码，验证一下复用和不复用的情况下，内存占用相差多少。</p><h2 id="复用Canvas提高效率"><a href="#复用Canvas提高效率" class="headerlink" title="复用Canvas提高效率"></a>复用Canvas提高效率</h2><p>采用上一种方式基本能解决掉绝大部分的问题，但是OpenLayers 3还提供了一种复用图标渲染使用的<code>Canvas</code>的方式，对应的类是<code>ol.style.AtlasManager</code>。 在了解其作用之前，需要先了解一点图标的渲染机制，比如<code>ol.style.Circle</code>和<code>ol.style.RegularShape</code>这样的图标，在内部渲染时，都会创建一个HTML的<code>canvas</code>，然后在这个画布上绘制图像，然后再把图像复制到地图上。 这样创建一个图标，就会在内部创建一个<code>canvas</code>。  <code>ol.style.AtlasManager</code>解决的问题就是，用一个大的<code>canvas</code>来绘制多个图标，这样就能减少<code>canvas</code>的数量，从而提高效率。 </p><p>官网有一个具体的例子来说明这种方法的使用，参见<a href="http://openlayers.org/en/v3.13.1/examples/symbol-atlas-webgl.html" target="_blank" rel="noopener">Symbols with WebGL</a>。 其中，关键的代码在：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> atlasManager = <span class="keyword">new</span> ol.style.AtlasManager(&#123;</span><br><span class="line">  <span class="comment">// we increase the initial size so that all symbols fit into</span></span><br><span class="line">  <span class="comment">// a single atlas image</span></span><br><span class="line">  initialSize: <span class="number">512</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">// circle symbol</span></span><br><span class="line">          symbols.push(<span class="keyword">new</span> ol.style.Circle(&#123;</span><br><span class="line">            opacity: info.opacity,</span><br><span class="line">            scale: info.scale,</span><br><span class="line">            radius: radiuses[j],</span><br><span class="line">            fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span><br><span class="line">              color: info.fillColor</span><br><span class="line">            &#125;),</span><br><span class="line">            stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span><br><span class="line">              color: info.strokeColor,</span><br><span class="line">              width: <span class="number">1</span></span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="comment">// by passing the atlas manager to the symbol,</span></span><br><span class="line">            <span class="comment">// the symbol will be added to an atlas</span></span><br><span class="line">            atlasManager: atlasManager  <span class="comment">// 注意：在创建style的这个地方设置了 atlasManager</span></span><br><span class="line">          &#125;));</span><br></pre></td></tr></table></figure><p>需要注意的是，在API官方文档上，并没有这个属性的设置，但内部实现是有这个优化的。 同时需要注意的是经常使用的<code>ol.style.Icon</code>目前是没有实现这个优化的。</p><h1 id="提示信息"><a href="#提示信息" class="headerlink" title="提示信息"></a>提示信息</h1><p>提示信息在很多业务场景中都需要，比如显示当前位置周边的饭店列表，或者点击饭店，显示饭店详细信息，交通路线，电话号码等等。 鉴于显示的业务信息比较多，所以通常的做法都是采用<code>overlay</code>的方式来做。 用传统的HTML来布局和排版信息，然后附加到地图上的指定位置就可以了。 官网中提供了一个具体的例子： <a href="http://openlayers.org/en/v3.13.1/examples/popup.html" target="_blank" rel="noopener">popup</a>。 下面就解读一下这个例子的代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!--此处用html布局，各种样式均在css中定义好了--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"popup"</span> <span class="attr">class</span>=<span class="string">"ol-popup"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">id</span>=<span class="string">"popup-closer"</span> <span class="attr">class</span>=<span class="string">"ol-popup-closer"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"popup-content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 获取到popup的节点</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> container = <span class="built_in">document</span>.getElementById(<span class="string">'popup'</span>);</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> content = <span class="built_in">document</span>.getElementById(<span class="string">'popup-content'</span>);</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> closer = <span class="built_in">document</span>.getElementById(<span class="string">'popup-closer'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建一个overlay, 绑定html元素container</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> overlay = <span class="keyword">new</span> ol.Overlay(<span class="comment">/** @type &#123;olx.OverlayOptions&#125; */</span> (&#123;</span></span><br><span class="line"><span class="undefined">    element: container,</span></span><br><span class="line"><span class="actionscript">    autoPan: <span class="literal">true</span>,</span></span><br><span class="line"><span class="undefined">    autoPanAnimation: &#123;</span></span><br><span class="line"><span class="undefined">      duration: 250</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  ......</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 监听地图点击事件</span></span></span><br><span class="line"><span class="actionscript">  map.on(<span class="string">'singleclick'</span>, <span class="function"><span class="keyword">function</span><span class="params">(evt)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 获取当前点击坐标，并设置到HTML元素上去</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> coordinate = evt.coordinate;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> hdms = ol.coordinate.toStringHDMS(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">        coordinate, <span class="string">'EPSG:3857'</span>, <span class="string">'EPSG:4326'</span>));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="handlebars"><span class="xml">    content.innerHTML = '<span class="tag">&lt;<span class="name">p</span>&gt;</span>You clicked here:<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>' + hdms +</span></span></span><br><span class="line"><span class="actionscript">        <span class="string">'&lt;/code&gt;'</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 设置overlay的位置，从而显示在鼠标点击处</span></span></span><br><span class="line"><span class="undefined">    overlay.setPosition(coordinate);</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;图标及提示信息&quot;&gt;&lt;a href=&quot;#图标及提示信息&quot; class=&quot;headerlink&quot; title=&quot;图标及提示信息&quot;&gt;&lt;/a&gt;图标及提示信息&lt;/h1&gt;&lt;p&gt;图标是GIS应用中必不可少的要素，比如在地图上标注饭店，学校，加油站等，就需要添加图标，点击图标，可能需要提示更为详细的信息，比如地址，评价，或者更为复杂的业务信息。本节将从基本的应用入手讲解，直到比较高级一些的自定义特色图标和信息展示。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 内置的地图控件</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch10/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch10/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:55:24.910Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Control"><a href="#Control" class="headerlink" title="Control"></a>Control</h1><p> 在OpenLayers 3中，地图控件指的是下图标注的这些，包括缩放按钮，标尺，版权说明，指北针等等。 </p><a id="more"></a><p> <img src="../img/03-01-annotation.png" alt="地图控件"><br> 他们不会随着地图的移动而移动，一直处于一个固定的位置。 在实现上，并不是在画布上绘制的，而是使用传统的HTML元素来实现的，便于同地图分离，也便于界面实现。 在本章节中，将先概览OpenLayers 3中已有的地图控件，对其实现进行分析，在此基础上进一步修改其样式，从而定义自己的控件。</p><h1 id="控件概览"><a href="#控件概览" class="headerlink" title="控件概览"></a>控件概览</h1><p>OpenLayers 3目前内置的地图控件类都在包<code>ol.control</code>下面，依次有：</p><ul><li><code>ol.control.Attribution</code>: 右下角的地图信息控件</li><li><code>ol.control.FullScreen</code>: 全屏控件</li><li><code>ol.control.MousePosition</code>: 鼠标位置控件</li><li><code>ol.control.OverviewMap</code>: 鸟瞰图控件</li><li><code>ol.control.Rotate</code>: 指北针控件</li><li><code>ol.control.ScaleLine</code>: 比例尺控件</li><li><code>ol.control.Zoom</code>: 缩放按钮控件</li><li><code>ol.control.ZoomSlider</code>: 缩放滚动条控件</li><li><code>ol.control.ZoomToExtent</code>: 放大到设定区域控件</li></ul><p>每一个类都有一些设置参数，可对照官网API的文档来了解其对应的功能。 </p><p>默认情况下，在地图上是不会显示这么多地图控件的，只会应用<code>ol.control.defaults()</code>这个函数返回的地图控件，默认包含了<code>ol.control.Zoom</code>，<code>ol.control.Rotate</code>和<code>ol.control.Attribution</code>这个控件。 其使用方式同<code>ol.interaction.defaults()</code>很像，同样可以设置一些参数来控制控件的一些功能，从而实现定制化需求。 比如下面这个地图上的控件稍微的同默认情况下的控件有点不一样，因为控件都不存在了。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var map = new ol.Map({        controls: ol.control.defaults({            attribution: false,            rotate: false,            zoom: false        }),        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });</script><p>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>                  </span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../src/ol3.13.1/ol.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../src/ol3.13.1/ol.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置地图控件，默认的三个控件都不显示</span></span></span><br><span class="line"><span class="undefined">controls: ol.control.defaults(&#123;</span></span><br><span class="line"><span class="actionscript">attribution: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">rotate: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">zoom: <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>当然，上面这个代码有更简洁的写法: <code>controls: []</code>，上面只是演示<code>ol.control.defaults</code>方法的使用而已。 如果需要把所有控件都显示出来，那么可以这样：</p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">    var map2 = new ol.Map({        controls: ol.control.defaults().extend([            new ol.control.FullScreen(),            new ol.control.MousePosition(),            new ol.control.OverviewMap(),            new ol.control.ScaleLine(),            new ol.control.ZoomSlider(),            new ol.control.ZoomToExtent()        ]),        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map2',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });</script><p>有些控件重叠在一起，得仔细分辨。 代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在默认控件的基础上，再加上其他内置的控件</span></span></span><br><span class="line"><span class="undefined">controls: ol.control.defaults().extend([</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.control.FullScreen(),</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.control.MousePosition(),</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.control.OverviewMap(),</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.control.ScaleLine(),</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.control.ZoomSlider(),</span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.control.ZoomToExtent()</span></span><br><span class="line"><span class="undefined">]),</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>下图是一个界面控件和类的对照关系图：<br><img src="../img/03-01-annotation.png" alt="控件类对照关系图"></p><p>每一个控件都有相应的参数设置，如果具体到某一个控件使用时，不能满足需求，可以先参照官网API说明，进行相应使用。</p><h1 id="探究控件原理"><a href="#探究控件原理" class="headerlink" title="探究控件原理"></a>探究控件原理</h1><p>在介绍后续的知识之前，先探究一下控件是如何做成的。 在chrome中打开一个最简单的地图例子，打开开发者工具面板，用工具栏最左边的元素选择器选择地图左上方的放大按钮，可以看到类似如下的界面：<br><img src="../img/zoomin-dom.png" alt="zoomin-dom结构"></p><p>上图可以看到放大按钮完整的dom结构图，从而一窥究竟，按钮原来就是简单的HTML的元素，结合<code>css</code>的效果做出来的，可以看到放大按钮的<code>css class</code>为<code>ol-zoom-in</code>，紧接着的就是缩小按钮的节点，其<code>css class</code>为<code>ol-zoom-out</code>，他们的父节点也有对应的<code>css class</code>： <code>ol-zoom</code>。 我们可以在<code>ol.css</code>文件中找到这些<code>class</code>的定义，设置了相应的样式。 控件<code>ui</code>的原理是清楚了，那么对应的控件要响应一些鼠标或者按键操作，应该也就是添加响应的事件监听器就可以了。</p><p>对于具体怎么做的，我们可以从控件<code>ol.control.Zoom</code>的部分源码来分析：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设定放大缩小按钮的提示信息</span></span><br><span class="line"> <span class="keyword">var</span> zoomInTipLabel = options.zoomInTipLabel !== <span class="literal">undefined</span> ?</span><br><span class="line">     options.zoomInTipLabel : <span class="string">'Zoom in'</span>;</span><br><span class="line"> <span class="keyword">var</span> zoomOutTipLabel = options.zoomOutTipLabel !== <span class="literal">undefined</span> ?</span><br><span class="line">     options.zoomOutTipLabel : <span class="string">'Zoom out'</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 创建放大按钮的dom节点</span></span><br><span class="line"> <span class="keyword">var</span> inElement = goog.dom.createDom(<span class="string">'BUTTON'</span>, &#123;</span><br><span class="line">   <span class="string">'class'</span>: className + <span class="string">'-in'</span>,</span><br><span class="line">   <span class="string">'type'</span> : <span class="string">'button'</span>,</span><br><span class="line">   <span class="string">'title'</span>: zoomInTipLabel</span><br><span class="line"> &#125;, zoomInLabel);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 并绑定鼠标点击事件的处理函数 handleClick_</span></span><br><span class="line"> ol.events.listen(inElement,</span><br><span class="line">     ol.events.EventType.CLICK, goog.partial(</span><br><span class="line">         ol.control.Zoom.prototype.handleClick_, delta), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"> ......</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 函数定义如下</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; delta Zoom delta.</span></span><br><span class="line"><span class="comment"> * @param &#123;Event&#125; event The event to handle</span></span><br><span class="line"><span class="comment"> * @private</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ol.control.Zoom.prototype.handleClick_ = <span class="function"><span class="keyword">function</span>(<span class="params">delta, event</span>) </span>&#123;</span><br><span class="line">  event.preventDefault(); <span class="comment">// 阻止事件传递到下面的map</span></span><br><span class="line">  <span class="keyword">this</span>.zoomByDelta_(delta);<span class="comment">// 调用具体的方法进行放大</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这个过程和我们平时的在界面上添加一个节点，再绑定事件处理函数，并没有什么差别，其他类似的控件也是一样的原理。这对我们来说，想改变<code>ui</code>样式，是非常容易的事，甚至可以改变它的默认行为。</p><h1 id="控件美颜"><a href="#控件美颜" class="headerlink" title="控件美颜"></a>控件美颜</h1><p>在知道原理后，想对控件美颜就是一件非常容易的事，大致有下面两种方式：</p><h2 id="自定义CSS样式"><a href="#自定义CSS样式" class="headerlink" title="自定义CSS样式"></a>自定义CSS样式</h2><p>知道控件的实现原理后，美颜就变得非常简单了，找到对应的<code>class</code>，设置<code>css</code>样式，就轻松搞定，这完全就是<code>css</code>范畴的内容了，比如你可以做到下面这样：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <link rel="stylesheet" type="text/css" href="../src/css/extend.css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });</script><p>代码只涉及<code>css</code>代码，如下：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.ol-zoom</span> <span class="selector-class">.ol-zoom-in</span> &#123;</span><br><span class="line"><span class="attribute">background-color</span>: <span class="number">#0000ff</span>;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#ff0000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这段代码可以放在单独的<code>css</code>文件里面，也可以直接加载<code>&lt;head&gt;&lt;/head&gt;</code>里面，但必须是在<code>ol.css</code>引入之后加，这样才能覆盖<code>ol3</code>默认的<code>css</code>样式。 最简单粗暴的，莫过于直接在<code>ol.css</code>里面修改，但这样侵入性太强，不利于<code>OpenLayers 3</code>的版本升级，升级一次，就得自己修改一次。 所以不推荐。</p><p>其他控件的<code>css</code>样式修改同上，此处不再累述，请自行修改验证。</p><h2 id="JavaScript修改"><a href="#JavaScript修改" class="headerlink" title="JavaScript修改"></a>JavaScript修改</h2><p>在前端除了<code>css</code>之外，还可以用强大的<code>javascript</code>代码进行修改，比如像下面这样，把最大化按钮的图标改变一下：</p><p><head><br>    <script type="text/javascript" src="../src/js/zepto.min.js" charset="utf-8"></script><br></head></p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">    new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map2',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    $('#map2 .ol-zoom-in').html('<>');</script><p>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置放大按钮符号，下面这个代码需要引入jquery，或者zepto库</span></span></span><br><span class="line"><span class="javascript">$(<span class="string">'#map2 .ol-zoom-in'</span>).html(<span class="string">'&lt;&gt;'</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>使用<code>javascript</code>代码势必能更进一步定制各种控件。</p><h1 id="自定义控件"><a href="#自定义控件" class="headerlink" title="自定义控件"></a>自定义控件</h1><p>有了前面的基础介绍，自定义控件就变得相对简单了，共分为两个步骤，第一步是构建界面，第二步是用代码实现功能。 下面自定义了一个分享当前地图的功能：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <link rel="stylesheet" type="text/css" href="../src/css/share.css"><br>    <script type="text/javascript" src="../src/js/zepto.min.js" charset="utf-8"></script><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    var viewport = map.getViewport();    $(viewport).append('<div id="share" class="share">分享地图</div>');    document.getElementById('share').onclick = function() {        alert('分享当前地图给朋友');    }</script><p>对应的代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在viewport节点下添加一个分享按钮</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> viewport = map.getViewport();</span></span><br><span class="line"><span class="handlebars"><span class="xml">$(viewport).append('<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"share"</span> <span class="attr">class</span>=<span class="string">"share"</span>&gt;</span>分享地图<span class="tag">&lt;/<span class="name">div</span>&gt;</span>');</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 监听按钮点击事件，执行相关操作</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'share'</span>).onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">alert(<span class="string">'分享当前地图给朋友'</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>结合注释理解代码，对于分享按钮的外观都是由<code>css</code>来定义：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.share</span> &#123;</span><br><span class="line"><span class="attribute">position</span>: absolute;</span><br><span class="line"><span class="attribute">top</span>: <span class="number">10px</span>;</span><br><span class="line"><span class="attribute">right</span>: <span class="number">10px</span>;</span><br><span class="line"><span class="attribute">border</span>: <span class="number">1px</span>;</span><br><span class="line"><span class="attribute">border-color</span>: <span class="number">#333</span>;</span><br><span class="line"><span class="attribute">background-color</span>: <span class="number">#339999</span>;</span><br><span class="line"><span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line"><span class="attribute">box-shadow</span>: <span class="number">0px</span> <span class="number">0px</span> <span class="number">2px</span> <span class="number">#666</span>;</span><br><span class="line"><span class="attribute">cursor</span>: pointer;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">0</span> <span class="number">4px</span> <span class="number">0</span> <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>由此可见，自定义控件也是一件非常简单的事。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Control&quot;&gt;&lt;a href=&quot;#Control&quot; class=&quot;headerlink&quot; title=&quot;Control&quot;&gt;&lt;/a&gt;Control&lt;/h1&gt;&lt;p&gt; 在OpenLayers 3中，地图控件指的是下图标注的这些，包括缩放按钮，标尺，版权说明，指北针等等。 &lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 事件</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch08/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch08/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:08:45.477Z</updated>
    
    <content type="html"><![CDATA[<h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><p>事件让很多业务的东西串联在一起，在前端中起着非常重要的作用，比如鼠标点击，移动事件。但其应用远不仅如此，现实生活中就存在很多大大小小的事件。 在OpenLayers 3中，同样存在非常多的事件，比如鼠标左键单击，双击等等。 同时还有一些用于各个模块之间进行协作使用的事件，比如<code>ol.Map</code>的<code>postrender</code>和<code>propertychange</code>事件。 通过这些事件，OpenLayers 3的功能模块协作一致，同样地，也可以让我们自己二次开发的功能模块运作起来。 同时，根据需要，我们还可以在系统中新增自定义事件，使得我们的开发使用方式同OpenLayers 3更加的一致。在本章节将详细介绍OpenLayers 3中的各种事件，及相关应用。</p><a id="more"></a><h1 id="一个简单的事件应用"><a href="#一个简单的事件应用" class="headerlink" title="一个简单的事件应用"></a>一个简单的事件应用</h1><p>在深入分析和理解之前，我们还是以简单的一个例子入手，来学习一下如何使用OpenLayers 3中的事件来做一个简单的事，从而熟悉整个流程。 用鼠标点击下面这个地图，将弹出一个对话框，显示点击位置的经纬度：</p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br>    var map = new ol.Map({<br>        layers: [<br>          new ol.layer.Tile({<br>            source: new ol.source.OSM()<br>          })<br>        ],<br>        target: ‘map’,<br>        view: new ol.View({<br>          center: ol.proj.transform(<br>              [104, 30], ‘EPSG:4326’, ‘EPSG:3857’),<br>          zoom: 10<br>        })<br>    });<br><br>    map.on(‘singleclick’, function(event){<br>        alert(ol.proj.transform(map.getEventCoordinate(event), ‘EPSG:3857’, ‘EPSG:4326’));<br>    })<br></script><br><br>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 监听singleclick事件</span></span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'singleclick'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 通过getEventCoordinate方法获取地理位置，再转换为wgs84坐标，并弹出对话框显示</span></span></span><br><span class="line"><span class="actionscript">alert(ol.proj.transform(map.getEventCoordinate(event), <span class="string">'EPSG:3857'</span>, <span class="string">'EPSG:4326'</span>));</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>代码很简单，但需要注意的是，任意的事件应用，必然会有三个步骤：<br><br><em> 找准事件发送者，比如上面这个例子，<code>map</code>就是事件发送者。 如何找到它呢？ 一般都是要交互的对象。</em> 找准事件名称，比如上面例子中的<code>singleclick</code>，切忌不要随便想象，或者按照惯例来写名称，初次使用，请一定参照API文档，不然后果自负。 如何参看一个类有什么事件？ 请参见<a href="../ch03/03-03.md">看懂API</a>。<br><em> 编写事件响应函数，在OpenLayers中，事件发送者都会有一个名字为<code>on</code>的函数，调用这个函数，就能监听指定的事件，响应函数<code>listener</code>具有一个参数<code>event</code>，这个<code>event</code>类就对应于API文档中事件名称后边括号里的类。<br><br>这三个步骤缺一不可，如果使用过<code>jquery</code>监听事件，应该对此比较熟悉。 除此之外，关于OpenLayers 3中的事件应用，还有下面两点需要说明：</em> 几乎OpenLayers 3中所有的类，都能监听事件和触发事件，因为它们都继承于类<code>ol.Observable</code>，这个类甚至是<code>ol.Object</code>的父类。 如此可见，OpenLayers在整个引擎中，是多么的依赖于事件通信。<br>* 而OpenLayers 3的整个事件机制，又是基于Google的<code>Closure Library</code>。所以如果你对这个库熟悉，那么对OpenLayers 3提供的事件机制会比较熟悉。<br><br>如果仅限于直接使用OpenLayers 3中的事件，就没有必要深入源码去探个究竟，只要遵照约定对事件进行应用就好。<br><br># 注销事件响应<br>上一节的示例仅仅演示了如何监听一个事件，并响应处理。 但如果之后又不需要再响应该事件了，要怎么办。 比如有一个引导用户使用的需求，用户第一次点击地图的时候，需要弹出一个使用说明，之后点击地图就不用再弹出这个使用说明了。 那我们有哪些方式可以做到这一点呢？ 尝试点击一下下面这个地图，之后再点击一次试试：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br>    var map = new ol.Map({<br>        layers: [<br>          new ol.layer.Tile({<br>            source: new ol.source.OSM()<br>          })<br>        ],<br>        target: ‘map’,<br>        view: new ol.View({<br>          center: ol.proj.transform(<br>              [104, 30], ‘EPSG:4326’, ‘EPSG:3857’),<br>          zoom: 10<br>        })<br>    });<br><br>    var key = map.on(‘singleclick’, function(event){<br>        alert(‘大家好，我是淡叔，这是一个演示如何取消事件监听的应用，之后再点击地图时，你将不会再看到这个说明。’);<br>        map.unByKey(key);<br>    })<br><br></script><br><br>第二次点击地图后，是否就不会再弹出提示信息了？ 其实代码很简单：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> key = map.on(<span class="string">'singleclick'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">alert(<span class="string">'大家好，我是淡叔，这是一个演示如何取消事件监听的应用，之后再点击地图时，你将不会再看到这个说明。'</span>);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 下面这行代码就是取消事件监听</span></span></span><br><span class="line"><span class="undefined">map.unByKey(key);</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>除了上面这个方式可以注销事件监听之外，还可以用下面这样的方式：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建事件监听器</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> singleclickListener = <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">alert(<span class="string">'大家好，我是淡叔，这是一个演示如何取消事件监听的应用，之后再点击地图时，你将不会再看到这个说明。'</span>);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在响应一次后，注销掉该监听器</span></span></span><br><span class="line"><span class="actionscript">map.un(<span class="string">'singleclick'</span>, singleclickListener);</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'singleclick'</span>, singleclickListener);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>针对这个应用，还可以按照下面这样来实现：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 使用once函数，只会响应一次事件，之后自动注销事件监听</span></span></span><br><span class="line"><span class="actionscript">map.once(<span class="string">'singleclick'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">alert(<span class="string">'大家好，我是淡叔，这是一个演示如何取消事件监听的应用，之后再点击地图时，你将不会再看到这个说明。'</span>);</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>到此，OpenLayers 3的事件应用基本介绍完毕，后续将介绍OpenLayers 3常用事件。<br><br><br># 常用事件<br><br>几乎OpenLayers主要的类都会派发相关的事件，虽然事件很多，但日常使用的事件大致分为下面几类。<br><br>## 常用鼠标事件<br><br>### 地图鼠标左键单击事件<br>对应的类为<code>ol.Map</code>，事件名为<code>singleclick</code>。<br><br>### 地图鼠标左键双击事件<br>对应的类为<code>ol.Map</code>，事件名为<code>dblclick</code>。<br><br>### 地图鼠标点击事件<br>对应的类为<code>ol.Map</code>，事件名为<code>click</code>。<br><br>### 地图鼠标移动事件<br>对应的类为<code>ol.Map</code>，事件名为<code>pointermove</code>。<br><br>### 地图鼠标拖拽事件<br>对应的类为<code>ol.Map</code>，事件名为<code>pointerdrag</code>。<br><br>### 地图移动事件<br>对应的类为<code>ol.Map</code>，事件名为<code>moveend</code>。<br><br>可以通过下面这个地图来尝试一下鼠标事件：<br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><br><div id="info" style="background-color: #999;">触发事件提示信息</div><br><div id="map" style="width: 100%"></div><br><script type="text/javascript"><br>    var map = new ol.Map({<br>        layers: [<br>          new ol.layer.Tile({<br>            source: new ol.source.OSM()<br>          })<br>        ],<br>        target: ‘map’,<br>        view: new ol.View({<br>          center: ol.proj.transform(<br>              [104, 30], ‘EPSG:4326’, ‘EPSG:3857’),<br>          zoom: 10<br>        })<br>    });<br><br>    map.on(‘singleclick’, function(event){<br>        document.getElementById(‘info’).innerHTML = ‘触发了ol.Map的单击事件：singleclick’;<br>    });<br><br>    map.on(‘dblclick’, function(event){<br>        document.getElementById(‘info’).innerHTML = ‘触发了ol.Map的双击事件：dblclick’;<br>    });<br><br>    map.on(‘click’, function(event){<br>        document.getElementById(‘info’).innerHTML = ‘触发了ol.Map的点击事件：click’;<br>    });<br><br>    // map.on(‘pointermove’, function(event){<br>    //     document.getElementById(‘info’).innerHTML = ‘触发了ol.Map的鼠标移动事件：pointermove’;<br>    // });<br><br>    map.on(‘pointerdrag’, function(event){<br>        document.getElementById(‘info’).innerHTML = ‘触发了ol.Map的拖拽事件：pointerdrag’;<br>    });<br><br>    map.on(‘moveend’, function(event){<br>        document.getElementById(‘info’).innerHTML = ‘触发了ol.Map的地图移动事件：moveend’;<br>    });<br><br></script><br><br>注意在<code>singleclick</code>和<code>dblclick</code>响应之前，都会触发<code>click</code>事件，在选择事件时，需要谨慎考虑。 同时发现<code>moveend</code>事件在地图缩放的时候，也会触发。 代码如下：<br><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"info"</span> <span class="attr">style</span>=<span class="string">"background-color: #999;"</span>&gt;</span>触发事件提示信息<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 响应单击事件</span></span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'singleclick'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'info'</span>).innerHTML = <span class="string">'触发了ol.Map的单击事件：singleclick'</span>;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 响应双击事件</span></span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'dblclick'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'info'</span>).innerHTML = <span class="string">'触发了ol.Map的双击事件：dblclick'</span>;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 响应点击事件</span></span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'info'</span>).innerHTML = <span class="string">'触发了ol.Map的点击事件：click'</span>;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 响应鼠标移动事件，事件太频繁，故注释掉了，可自行验证该事件</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// map.on('pointermove', function(event)&#123;</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// document.getElementById('info').innerHTML = '触发了ol.Map的鼠标移动事件：pointermove';</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// &#125;);</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 响应拖拽事件</span></span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'pointerdrag'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'info'</span>).innerHTML = <span class="string">'触发了ol.Map的拖拽事件：pointerdrag'</span>;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 地图移动事件</span></span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'moveend'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'info'</span>).innerHTML = <span class="string">'触发了ol.Map的地图移动事件：moveend'</span>;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br>## 非直接交互事件<br><br>### 地图缩放事件<br>对应的类为<code>ol.View</code>，事件名为 <code>change:resolution</code>，为什么？ 因为分辨率改变了，自然层级就变化了。<br><br>### 地图中心改变事件<br>对应的类是<code>ol.View</code>，事件名为 <code>change:center</code>。<br><br>下面这个地图，可以让你感受一下这两个事件：<br><br><div id="info2" style="background-color: #999;">事件提示信息</div><br><div id="map2" style="width: 100%"></div><br><script type="text/javascript"><br>    var map2 = new ol.Map({<br>        layers: [<br>          new ol.layer.Tile({<br>            source: new ol.source.OSM()<br>          })<br>        ],<br>        target: ‘map2’,<br>        view: new ol.View({<br>          center: ol.proj.transform(<br>              [104, 30], ‘EPSG:4326’, ‘EPSG:3857’),<br>          zoom: 10<br>        })<br>    });<br><br>    var view = map2.getView();<br>    view.on(‘change:resolution’, function(event){<br>        document.getElementById(‘info2’).innerHTML = ‘触发了ol.View的缩放事件：change:resolution，当前层级为： ‘ + this.getZoom();<br>    });<br><br>    view.on(‘change:center’, function(event){<br>        document.getElementById(‘info2’).innerHTML = ‘触发了ol.View的地图中心改变事件：change:center，当前中心点为： ‘ + ol.proj.transform(<br>              this.getCenter(), ‘EPSG:3857’, ‘EPSG:4326’);<br>    });<br></script><br><br>### 改变事件<br>OpenLayers 3的大多数类都拥有一些改变事件，这些事件常用于模块之间联动使用，在二次开发的业务需求中，也会经常需要，所以希望能引起重视，具体的事件可以参照API官网文档的说明。 比如上面的例子其实就是应用的这类事件。<br><br># 阻止事件传递<br><br><br># 自定义事件及应用<br><br>通过API文档，我们可以看到OpenLayers 3的相关类，都有一些事件，但这些事件大多是和现有引擎相关的，并不能满足我们大多数的业务需求。如果能为OpenLayers 3的类增加自定义事件，那么必然能更好地实现业务需求。接下来就尝试为<code>ol.Feature</code>添加一个<code>mouseover</code>的事件，通过这个事件，就可以实现在鼠标移到<code>Feature</code>上时，改变它的样式。<br><br>要添加自定义事件，需要知道这样一个事实：<code>ol.Feature</code>继承于<code>ol.Object</code>，而<code>ol.Object</code>具有派发事件(<a href="http://openlayers.org/en/v3.13.1/apidoc/ol.Object.html#dispatchEvent" target="_blank" rel="noopener">dispatchEvent</a>)和监听事件(<a href="http://openlayers.org/en/v3.13.1/apidoc/ol.Object.html#on" target="_blank" rel="noopener">on</a>)的功能。 关于这两个功能的详细信息可以参见API文档。这样，我们要自定义事件就非常容易了，如果注意观察，会发现OpenLayers 3中的类都继承于<code>ol.Object</code>，也就是说，如果自定义事件方法在<code>ol.Feature</code>上有效，那么在其他的OpenLayers 3的类上也是同样有效的。<br><br>下面就先展示一下通过自定义的<code>mouseover</code>事件来改变<code>Feature</code>的样式：<br><br><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head><p><div id="map" style="width: 100%, height: 400px"></div></p><script>    // 在原点处创建一个feature    var feature1 = new ol.Feature({        geometry: new ol.geom.Point([0, 0])    });    // 并设置为半径为100像素的圆，用红色填充    feature1.setStyle(new ol.style.Style({        image: new ol.style.Circle({            radius: 100,            fill: new ol.style.Fill({                color: 'red'            })        })    }));    // 在坐标[5000000, 5000000]处创建另一个feature    var feature2 = new ol.Feature({        geometry: new ol.geom.Point([5000000, 5000000])    });    // 并设置为半径为100像素的圆，用黄色填充    feature2.setStyle(new ol.style.Style({        image: new ol.style.Circle({            radius: 100,            fill: new ol.style.Fill({                color: 'yellow'            })        })    }));  // 创建地图  var map = new ol.Map({        // 设置地图图层        layers: [          // 创建一个使用Open Street Map地图源的瓦片图层          new ol.layer.Tile({source: new ol.source.OSM()}),          // 把之前创建的feature1和feature2放在另一个层里          new ol.layer.Vector({source: new ol.source.Vector({              features: [feature1, feature2]          })})        ],        // 设置显示地图的视图        view: new ol.View({          center: [0, 0],    // 定义地图显示中心于经度0度，纬度0度处          zoom: 2            // 并且定义地图显示层级为2        }),        // 让id为map的div作为地图的容器        target: 'map'        });  // 为地图注册鼠标移动事件的监听  map.on('pointermove', function(event){      map.forEachFeatureAtPixel(event.pixel, function(feature){          // 为移动到的feature发送自定义的mousemove消息          feature.dispatchEvent({type: 'mousemove', event: event});      });  });  // 为feature1注册自定义事件mousemove的监听  feature1.on('mousemove', function(event){      // 修改feature的样式为半径100像素的园，用蓝色填充      this.setStyle(new ol.style.Style({            image: new ol.style.Circle({                radius: 100,                fill: new ol.style.Fill({                    color: 'blue'                })            })        }));  });</script><p>为了对比，在地图上添加了两个圆，一个黄色的，一个红色的。鼠标移动到红色的圆上，它会变成蓝色的圆。但是鼠标移到黄色的圆上，不会有任何改变。这个功能在官网的例子中也有，参见<a href="http://openlayers.org/en/v3.13.1/examples/select-features.html" target="_blank" rel="noopener">select-features</a>。那么用自定义事件的方式来做，又该怎样来实现呢？对应的源码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!Doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">http://www.w3.org/1999/xhtml</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>                  </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">Content-Type</span> <span class="attr">content</span>=<span class="string">"text/html;charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">X-UA-Compatible</span> <span class="attr">content</span>=<span class="string">"IE=edge,chrome=1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">always</span> <span class="attr">name</span>=<span class="string">referrer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>OpenLayers 3地图示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../src/ol3.13.1/ol.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../src/ol3.13.1/ol.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%, height: 400px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在原点处创建一个feature</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> feature1 = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">0</span>, <span class="number">0</span>])</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 并设置为半径为100像素的圆，用红色填充</span></span></span><br><span class="line"><span class="actionscript">feature1.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 100,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在坐标[5000000, 5000000]处创建另一个feature</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> feature2 = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point([<span class="number">5000000</span>, <span class="number">5000000</span>])</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 并设置为半径为100像素的圆，用黄色填充</span></span></span><br><span class="line"><span class="actionscript">feature2.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 100,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'yellow'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建地图</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置地图图层</span></span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 创建一个使用Open Street Map地图源的瓦片图层</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;source: <span class="keyword">new</span> ol.source.OSM()&#125;),</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 把之前创建的feature1和feature2放在另一个层里</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Vector(&#123;source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="undefined">  features: [feature1, feature2]</span></span><br><span class="line"><span class="undefined">  &#125;)&#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置显示地图的视图</span></span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="actionscript">  center: [<span class="number">0</span>, <span class="number">0</span>],<span class="comment">// 定义地图显示中心于经度0度，纬度0度处</span></span></span><br><span class="line"><span class="actionscript">  zoom: <span class="number">2</span><span class="comment">// 并且定义地图显示层级为2</span></span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让id为map的div作为地图的容器</span></span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 为地图注册鼠标移动事件的监听</span></span></span><br><span class="line"><span class="actionscript">  map.on(<span class="string">'pointermove'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  map.forEachFeatureAtPixel(event.pixel, <span class="function"><span class="keyword">function</span><span class="params">(feature)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 为移动到的feature发送自定义的mousemove消息</span></span></span><br><span class="line"><span class="actionscript">  feature.dispatchEvent(&#123;type: <span class="string">'mousemove'</span>, event: event&#125;);</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 为feature1注册自定义事件mousemove的监听</span></span></span><br><span class="line"><span class="actionscript">  feature1.on(<span class="string">'mousemove'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 修改feature的样式为半径100像素的园，用蓝色填充</span></span></span><br><span class="line"><span class="actionscript">  <span class="keyword">this</span>.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 100,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>代码中有详细的注释，再辅以API文档，相信应该看懂绝大部分的代码，当然最关键的代码在于最后的两个事件监听，在这两段代码中，可能下面这句不是很明白：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feature.dispatchEvent(&#123;<span class="attr">type</span>: <span class="string">'mousemove'</span>, <span class="attr">event</span>: event&#125;);</span><br></pre></td></tr></table></figure></p><p><code>dispatchEvent</code>的参数具有<code>type</code>和<code>event</code>属性，必须这样构造吗？在回答这个问题之前，需要先看一下API文档，发现参数类型为<code>goog.events.EventLike</code>，说明它其实用的是google的closure库来实现的，通过closure库的源码我们知道，派发的事件如果是一个对象，那么<strong>必须</strong>包含<code>type</code>属性，用于表示事件类型。其他的属性可以自由定义，比如此处定义了<code>event</code>属性，并设置对应的值，为的是让鼠标事件传递给<code>feature1</code>的监听函数。</p><p><code>dispatchEvent</code>的参数会被原封不动的传递给事件响应函数，对应代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feature1.on(<span class="string">'mousemove'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br></pre></td></tr></table></figure></p><p>里<code>function</code>的参数<code>event</code>，可以通过调试窗口看到此处的<code>event</code>和<code>dispatchEvent</code>的参数是一样的。注意事件名称是可以自定义的，只要派发和监听使用的事件名称是一致的就可以。</p><p>除了可以通过<code>dispatchEvent({type: &#39;mousemove&#39;, event: event})</code>这种形式派发一个事件之外，还可以通过<code>dispatchEvent(&#39;mousemove&#39;)</code>这中形式直接发送<code>mousemove</code>事件。有兴趣的同学可以自行验证。</p><p>到此，我们就完成了自定义事件的三件事：定义事件类型，派发事件，监听事件。</p><p>使用自定义事件会带来下面几个好处：</p><ul><li>灵活控制，对比一下官网例子和这个例子，就能看出一二。</li><li>能更好地满足业务需要，适当地进行扩展。</li><li>采用更统一的事件处理框架。</li></ul><p>有很多同学为了处理多个<code>Feature</code>的鼠标事件，可能会为<code>Map</code>注册很多次<code>pointermove</code>事件监听，从而会导致性能降低，这种做法是不可取的。如果采用上面这种自定义事件的处理方式，就只用注册一次，让真正有需要的<code>Feature</code>通过注册事件响应来处理业务，从而还能简化处理逻辑。</p><p>上面这个例子鼠标移到红色圆后变蓝色，但是移出圆后，还是蓝色，能不能再移出圆的时候再变成红色呢？ 试试用自定义事件的方式再改进一下，实现<code>mousein</code>和<code>mouseout</code>两种事件。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;事件&quot;&gt;&lt;a href=&quot;#事件&quot; class=&quot;headerlink&quot; title=&quot;事件&quot;&gt;&lt;/a&gt;事件&lt;/h1&gt;&lt;p&gt;事件让很多业务的东西串联在一起，在前端中起着非常重要的作用，比如鼠标点击，移动事件。但其应用远不仅如此，现实生活中就存在很多大大小小的事件。 在OpenLayers 3中，同样存在非常多的事件，比如鼠标左键单击，双击等等。 同时还有一些用于各个模块之间进行协作使用的事件，比如&lt;code&gt;ol.Map&lt;/code&gt;的&lt;code&gt;postrender&lt;/code&gt;和&lt;code&gt;propertychange&lt;/code&gt;事件。 通过这些事件，OpenLayers 3的功能模块协作一致，同样地，也可以让我们自己二次开发的功能模块运作起来。 同时，根据需要，我们还可以在系统中新增自定义事件，使得我们的开发使用方式同OpenLayers 3更加的一致。在本章节将详细介绍OpenLayers 3中的各种事件，及相关应用。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 内置交互方式介绍</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch09/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch09/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:08:51.687Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Interaction"><a href="#Interaction" class="headerlink" title="Interaction"></a>Interaction</h1><p>交互是人机界面非常重要的一个部分，任何一个GIS引擎都会内置这一部分功能，而不是让开发者自己实现。 在交互方式上，几乎都是约定俗成的，比如用鼠标左键双击地图可以放大地图，按住鼠标左键拖动地图可以移动浏览地图，用滚动鼠标中间的滑轮可以放大缩小地图等等。 OpenLayers 3都内置支持这些交互方式，同时还具备更多的其他交互方式，这些都将一并在本章节介绍。 更为重要的是，了解其中的基本原理，并在此基础上，应用于自己的业务开发。</p><a id="more"></a><h1 id="内置交互方式介绍"><a href="#内置交互方式介绍" class="headerlink" title="内置交互方式介绍"></a>内置交互方式介绍</h1><p>OpenLayers 3提供了最基本的地图放大，缩小，平移等功能，以满足用户浏览地图的需要。 这些功能都是内置的，实现类都放在包<code>ol.interaction</code>下面，可以通过官网API查询到。 在做二次开发的时候，我们无需做任何设置，地图就具有这些功能，比如下面这个最简单的地图，你可以用鼠标对它进行浏览，不管是放大，还是缩小，平移都可以。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });</script><p>这个地图的代码在本教程最开始的时候，就已经见过了：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>虽然代码中没有做任何的设置，<code>ol.Map</code>的默认行为中，设置了和地图的交互方式，如果表示出来，代码是这样的：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">interactions: ol.interaction.defaults(),  <span class="comment">// 不设置的情况下，默认会设置为ol.interaction.defaults()</span></span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><code>ol.interaction.defaults()</code>这个函数用于返回默认的交互方式，通过API文档可知，还可以通过参数控制交互方式，非常的灵活。 在进一步深入之前，还是先了解一下默认都提供了那些交互方式：</p><ul><li>按住alt+shift键，用鼠标左键拖动地图，就能让地图旋转，对应的交互类为<code>ol.interaction.DragRotate</code>。</li><li>用鼠标左键双击地图，就可以放大地图，对应的交互类为<code>ol.interaction.DoubleClickZoom</code>。</li><li>用鼠标左键，拖拽地图，就可以平移地图，对应的交互类为<code>ol.interaction.DragPan</code>。</li><li>在触摸屏上，用两个手指在触摸屏上旋转，就可以旋转地图，对应的交互类为<code>ol.interaction.PinchRotate</code>。</li><li>在触摸屏上，用两个手指在触摸屏上缩放，就可以缩放地图，对应的交互类为<code>ol.interaction.PinchZoom</code>。</li><li>用键盘上的上下左右键，就可以平移地图，对应的交互类为<code>ol.interaction.KeyboardPan</code>。</li><li>用键盘上的+/-键，就可以缩放地图，对应的交互类为<code>ol.interaction.KeyboardZoom</code>。</li><li>滚动鼠标中间的滑轮，就可以缩放地图，对应的交互类为<code>ol.interaction.MouseWheelZoom</code>。</li><li>按住shift键，同时用鼠标左键在地图上拖动，就可以放大地图，对应的交互类为<code>ol.interaction.DragZoom</code>。</li></ul><p>从上面可以看到，支持的交互方式挺多的，归纳为缩放，平移，旋转三类。 同时支持键盘，鼠标，和触屏三种方式。 </p><p>虽然默认的交互方式很全，但如果我们的地图只是在PC端提供或者只是在触屏提供，那么有些交互方式就会显得多余，最好是去掉不需要的，或者我们的地图因为业务需要，不允许用户平移，或者缩放地图。 为了满足这样的需求，<code>ol.interaction.defaults()</code>提供了相应的参数来控制交互方式，详见<a href="http://openlayers.org/en/v3.13.1/apidoc/ol.interaction.html#.defaults" target="_blank" rel="noopener">ol.interaction.defaults API文档</a>。 下面简单演示一个不能缩放的地图：</p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">    new ol.Map({        interactions: ol.interaction.defaults({            doubleClickZoom: false,            mouseWheelZoom: false,            shiftDragZoom: false,            pinchZoom:false        }),        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map2',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });</script><p>代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 让所有的zoom开关都设置为false</span></span></span><br><span class="line"><span class="undefined">interactions: ol.interaction.defaults(&#123;</span></span><br><span class="line"><span class="actionscript">doubleClickZoom: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">mouseWheelZoom: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">shiftDragZoom: <span class="literal">false</span>,</span></span><br><span class="line"><span class="actionscript">pinchZoom:<span class="literal">false</span></span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>有时候也需要设置地图不能旋转，只要设置<code>altShiftDragRotate:false, pinchRotate:false</code>即可，可自行验证。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>细心的读者有可能已经发现了，前面的第一个地图，我们并没有做任何的限制，但是用键盘控制鼠标平移和缩放，是不行的。 原因在于地图使用的<code>target</code>获取不到键盘事件，我们需要做个简单的设置才行：</p><p><div id="map3" tabindex="0" style="width: 100%"></div></p><script type="text/javascript">    new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map3',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });</script><p>代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--注意：需要设置tabindex，才能使div获得键盘事件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map3"</span> <span class="attr">tabindex</span>=<span class="string">"0"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map3'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><p>不管是上一节中的哪一种交互方式，本质上都是通过监听事件，来处理相应的业务的，在<code>ol.Map</code>的实现代码中，有下面的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @private</span></span><br><span class="line"><span class="comment">  * @type &#123;ol.MapBrowserEventHandler&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">this</span>.mapBrowserEventHandler_ = <span class="keyword">new</span> ol.MapBrowserEventHandler(<span class="keyword">this</span>);</span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> ol.MapBrowserEvent.EventType) &#123;<span class="comment">// 遍历所有的事件类型</span></span><br><span class="line">   ol.events.listen(<span class="keyword">this</span>.mapBrowserEventHandler_, ol.MapBrowserEvent.EventType[key],</span><br><span class="line">       <span class="keyword">this</span>.handleMapBrowserEvent, <span class="keyword">this</span>);<span class="comment">// 监听事件，函数handleMapBrowserEvent为事件响应函数</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> ......</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param &#123;ol.MapBrowserEvent&#125; mapBrowserEvent The event to handle.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ol.Map.prototype.handleMapBrowserEvent = <span class="function"><span class="keyword">function</span>(<span class="params">mapBrowserEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.frameState_) &#123;</span><br><span class="line">    <span class="comment">// With no view defined, we cannot translate pixels into geographical</span></span><br><span class="line">    <span class="comment">// coordinates so interactions cannot be used.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.focus_ = mapBrowserEvent.coordinate;</span><br><span class="line">  mapBrowserEvent.frameState = <span class="keyword">this</span>.frameState_;</span><br><span class="line">  <span class="keyword">var</span> interactions = <span class="keyword">this</span>.getInteractions();</span><br><span class="line">  goog.asserts.assert(interactions !== <span class="literal">undefined</span>,</span><br><span class="line">      <span class="string">'interactions should be defined'</span>);</span><br><span class="line">  <span class="keyword">var</span> interactionsArray = interactions.getArray();</span><br><span class="line">  <span class="keyword">var</span> i;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.dispatchEvent(mapBrowserEvent) !== <span class="literal">false</span>) &#123;<span class="comment">// 注意：如果事件处理返回false，交互类就不起作用了</span></span><br><span class="line">    <span class="keyword">for</span> (i = interactionsArray.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;<span class="comment">// 遍历所有的交互方式</span></span><br><span class="line">      <span class="keyword">var</span> interaction = interactionsArray[i];</span><br><span class="line">      <span class="keyword">if</span> (!interaction.getActive()) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> cont = interaction.handleEvent(mapBrowserEvent);<span class="comment">// 让各个交互类处理响应的事件</span></span><br><span class="line">      <span class="keyword">if</span> (!cont) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>至于每一个交互类如何处理，就和业务相关了，再此之前，先看一下具体有哪些事件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constants for event names.</span></span><br><span class="line"><span class="comment"> * @enum &#123;string&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ol.MapBrowserEvent.EventType = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A true single click with no dragging and no double click. Note that this</span></span><br><span class="line"><span class="comment">   * event is delayed by 250 ms to ensure that it is not a double click.</span></span><br><span class="line"><span class="comment">   * @event ol.MapBrowserEvent#singleclick</span></span><br><span class="line"><span class="comment">   * @api stable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SINGLECLICK: <span class="string">'singleclick'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A click with no dragging. A double click will fire two of this.</span></span><br><span class="line"><span class="comment">   * @event ol.MapBrowserEvent#click</span></span><br><span class="line"><span class="comment">   * @api stable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  CLICK: ol.events.EventType.CLICK,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A true double click, with no dragging.</span></span><br><span class="line"><span class="comment">   * @event ol.MapBrowserEvent#dblclick</span></span><br><span class="line"><span class="comment">   * @api stable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  DBLCLICK: ol.events.EventType.DBLCLICK,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Triggered when a pointer is dragged.</span></span><br><span class="line"><span class="comment">   * @event ol.MapBrowserEvent#pointerdrag</span></span><br><span class="line"><span class="comment">   * @api</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  POINTERDRAG: <span class="string">'pointerdrag'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Triggered when a pointer is moved. Note that on touch devices this is</span></span><br><span class="line"><span class="comment">   * triggered when the map is panned, so is not the same as mousemove.</span></span><br><span class="line"><span class="comment">   * @event ol.MapBrowserEvent#pointermove</span></span><br><span class="line"><span class="comment">   * @api stable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  POINTERMOVE: <span class="string">'pointermove'</span>,</span><br><span class="line"></span><br><span class="line">  POINTERDOWN: <span class="string">'pointerdown'</span>,</span><br><span class="line">  POINTERUP: <span class="string">'pointerup'</span>,</span><br><span class="line">  POINTEROVER: <span class="string">'pointerover'</span>,</span><br><span class="line">  POINTEROUT: <span class="string">'pointerout'</span>,</span><br><span class="line">  POINTERENTER: <span class="string">'pointerenter'</span>,</span><br><span class="line">  POINTERLEAVE: <span class="string">'pointerleave'</span>,</span><br><span class="line">  POINTERCANCEL: <span class="string">'pointercancel'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这些事件在<code>ol.Map</code>的API文档里面，有些是能看到的，就是注释里面有<code>@api</code>的部分，其他的是暂时内部使用的。 按照这个逻辑，我们也可以实现自己的交互方式。 但有一点需要注意，<code>ol.Map</code>处理事件是有先后顺序的，注意看最前面的那段代码的注释，<code>ol.Map</code>会先派发事件给自己的监听器，然后才会把事件给<code>interaction</code>类处理。 如果前面的事件监听器返回<code>false</code>，那么后面的交互类就不会起作用。 比如像下面这样，用鼠标左键双击地图，并不能放大地图：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    map.on('dblclick', function(event){        return false;    });</script><p>为什么？ 注意看代码：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 监听了dblclick事件，并返回了false</span></span></span><br><span class="line"><span class="actionscript">map.on(<span class="string">'dblclick'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这样做了后，后果非常的严重，出问题后，可能还不知道为什么？ 所以建议不要轻易在<code>MapBrowserEvent</code>事件的监听器里面返回<code>false</code>。</p><p>到此，我们可以进一步分析一下<code>ol.interaction</code>相关交互类的内部实现了，以<code>ol.interaction.DoubleClickZoom</code>为例，其核心必然是处理事件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ol.interaction.DoubleClickZoom.handleEvent = <span class="function"><span class="keyword">function</span>(<span class="params">mapBrowserEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> stopEvent = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> browserEvent = mapBrowserEvent.originalEvent;</span><br><span class="line">  <span class="keyword">if</span> (mapBrowserEvent.type == ol.MapBrowserEvent.EventType.DBLCLICK) &#123;<span class="comment">// 事件类型过滤</span></span><br><span class="line">    <span class="keyword">var</span> map = mapBrowserEvent.map;</span><br><span class="line">    <span class="keyword">var</span> anchor = mapBrowserEvent.coordinate;</span><br><span class="line">    <span class="keyword">var</span> delta = browserEvent.shiftKey ? -<span class="keyword">this</span>.delta_ : <span class="keyword">this</span>.delta_;<span class="comment">// 按住shift键，就缩小，否则就放大</span></span><br><span class="line">    <span class="keyword">var</span> view = map.getView();</span><br><span class="line">    goog.asserts.assert(view, <span class="string">'map must have a view'</span>);</span><br><span class="line">    ol.interaction.Interaction.zoomByDelta(</span><br><span class="line">        map, view, delta, anchor, <span class="keyword">this</span>.duration_);<span class="comment">// 调用 ol.interaction.Interaction.zoomByDelta函数实现放大缩小</span></span><br><span class="line">    mapBrowserEvent.preventDefault();</span><br><span class="line">    stopEvent = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> !stopEvent;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>代码其实很简单，如果要自己实现一种交互方式，对照<code>ol.interaction.DoubleClickZoom</code>这个学习，再加以应用就可以了。</p><h1 id="Feature选取之选中样式"><a href="#Feature选取之选中样式" class="headerlink" title="Feature选取之选中样式"></a>Feature选取之选中样式</h1><p>OpenLayers 3除了在地图浏览方面提供内置的交互方式之外，还提供了地图上<code>Feature</code>选取的交互类： <code>ol.interaction.Select</code>。 这是一个经常会用到的类，应用范围非常的广。 我们可以先简单操作一下下面地图中的圆，点击一下，颜色就变了：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var layer = new ol.layer.Vector({        source: new ol.source.Vector()    });    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          }),           layer        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // 在地图上添加一个圆    var circle = new ol.Feature({        geometry: new ol.geom.Point(ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'))    })    circle.setStyle(new ol.style.Style({        image: new ol.style.Circle({            radius: 10,            fill: new ol.style.Fill({                color: 'red'            })        })    }));    layer.getSource().addFeature(circle);    // 添加一个用于选择Feature的交互方式    var selectSingleClick = new ol.interaction.Select({        // style: new ol.style.Style({        //     image: new ol.style.Circle({        //         radius: 10,        //         fill: new ol.style.Fill({        //             color: 'blue'        //         })        //     })        // })    });    map.addInteraction(selectSingleClick);    selectSingleClick.on('select', function(event){        event.selected[0].setStyle(new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'blue'                })            })        }));    })</script><p>在<a href="../ch08/08-05.md">自定义事件及应用</a>中，我们用了方法<code>map.forEachFeatureAtPixel</code>来获取当前选择的<code>Feature</code>，这个例子中，我们没有这样使用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector()</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;), </span></span><br><span class="line"><span class="undefined">  layer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在地图上添加一个圆</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circle = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>))</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="actionscript">circle.setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">layer.getSource().addFeature(circle);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 前面的代码我们已经看了很多遍了，关键是下面这段代码</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个用于选择Feature的交互方式</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> selectSingleClick = <span class="keyword">new</span> ol.interaction.Select(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// API文档里面有说明，可以设置style参数，用来设置选中后的样式，但是这个地方我们注释掉不用，因为就算不注释，也没作用，为什么？</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// style: new ol.style.Style(&#123;</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// image: new ol.style.Circle(&#123;</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// radius: 10,</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// fill: new ol.style.Fill(&#123;</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// color: 'blue'</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// &#125;)</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// &#125;)</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// &#125;)</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined">map.addInteraction(selectSingleClick);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 监听选中事件，然后在事件处理函数中改变被选中的`feature`的样式</span></span></span><br><span class="line"><span class="actionscript">selectSingleClick.on(<span class="string">'select'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">event.selected[<span class="number">0</span>].setStyle(<span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>官网其实有例子<a href="http://openlayers.org/en/v3.13.1/examples/select-features.html" target="_blank" rel="noopener">select-features</a>，但是这里面还是有一些需要注意的地方，比如上面注释里面说到的，为什么<code>style</code>参数设置了没用？ 因为我们的<code>circle</code>本身就设置了样式，而<code>style</code>参数设置的样式，其实是设置在内部新建的一个<code>layer</code>上的，而OpenLayers 3中，<code>feature</code>的样式优先级是大于<code>layer</code>的样式的优先级的。所以没生效，如果换成下面这种方式，就可以了：</p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">    var layer2 = new ol.layer.Vector({        source: new ol.source.Vector(),        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'red'                })            })        })    });    var map2 = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          }),           layer2        ],        target: 'map2',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // 在地图上添加一个圆    var circle2 = new ol.Feature({        geometry: new ol.geom.Point(ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'))    })    layer2.getSource().addFeature(circle2);    // 添加一个用于选择Feature的交互方式    map2.addInteraction(new ol.interaction.Select({        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'blue'                })            })        })    }));</script><p>代码变成这样了：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> layer2 = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 注意：把feature上的style，直接移到layer上，避免直接在feature上设置style</span></span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;), </span></span><br><span class="line"><span class="undefined">  layer2</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在地图上添加一个圆</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circle2 = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>))</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 此处不再为feature设置style</span></span></span><br><span class="line"><span class="undefined">layer2.getSource().addFeature(circle2);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个用于选择Feature的交互方式</span></span></span><br><span class="line"><span class="actionscript">map2.addInteraction(<span class="keyword">new</span> ol.interaction.Select(&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 设置选中后的style</span></span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>代码改成上面这样就可以了。在使用过程中，请千万留意这个问题。 </p><h1 id="Feature选取之条件过滤"><a href="#Feature选取之条件过滤" class="headerlink" title="Feature选取之条件过滤"></a>Feature选取之条件过滤</h1><p>涉及到选取，自然会有各种条件用于过滤，比如是鼠标左键单击，还是双击，是可以选取地图上的任意<code>feature</code>，还是某一类的<code>feature</code>。 对于这些需求，<code>ol.interaction.Select</code>都能满足，在API的文档里面就有相关的参数设置，下面就是一些简单的使用示例。</p><h2 id="改变默认的单击选取方式"><a href="#改变默认的单击选取方式" class="headerlink" title="改变默认的单击选取方式"></a>改变默认的单击选取方式</h2><p>默认情况下，是支持鼠标左键单击选取<code>feature</code>的，在地图上其他地方点击一下，就取消选取了，但这并不是定死的选取方式，你完全可以自定义。 比如鼠标移动到<code>feature</code>上，就选取了，试试：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var layer = new ol.layer.Vector({        source: new ol.source.Vector(),        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'red'                })            })        })    });    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          }),           layer        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // 在地图上添加一个圆    var circle = new ol.Feature({        geometry: new ol.geom.Point(ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'))    })    layer.getSource().addFeature(circle);    // 添加一个用于选择Feature的交互方式    map.addInteraction(new ol.interaction.Select({        condition: ol.events.condition.pointerMove,     // 唯一的不同之处，设置鼠标移到feature上就选取        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'blue'                })            })        })    }));</script><p>代码同之前的例子只有一个地方不同：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;), </span></span><br><span class="line"><span class="undefined">  layer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在地图上添加一个圆</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circle = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>))</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">layer.getSource().addFeature(circle);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个用于选择Feature的交互方式</span></span></span><br><span class="line"><span class="actionscript">map.addInteraction(<span class="keyword">new</span> ol.interaction.Select(&#123;</span></span><br><span class="line"><span class="actionscript">condition: ol.events.condition.pointerMove, <span class="comment">// 唯一的不同之处，设置鼠标移到feature上就选取</span></span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>ol.events.condition</code>里面有很多内置的条件过滤函数，可以在<a href="http://openlayers.org/en/v3.13.1/apidoc/ol.events.condition.html" target="_blank" rel="noopener">官网API</a>查询，如果内置方式没有，也可以自己写一个类似的函数，比如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ol.events.condition.singleClick = <span class="function"><span class="keyword">function</span>(<span class="params">mapBrowserEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> mapBrowserEvent.type == ol.MapBrowserEvent.EventType.SINGLECLICK;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>就只是一个类型判断而已，是否非常的简单，任何人都可以自定义一个这种条件过滤函数。</p><h2 id="直接对feature过滤"><a href="#直接对feature过滤" class="headerlink" title="直接对feature过滤"></a>直接对<code>feature</code>过滤</h2><p>除了可以自定义选取的交互方式之外，我们还可以对<code>feature</code>进行过滤，如果当前选取的并不是我们需要的<code>feature</code>，我们可以决定不选取。 比如我们只希望用户能选取圆形，而不能选取五星，选取方式为默认的单击：</p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">    var circleLayer = new ol.layer.Vector({        source: new ol.source.Vector(),        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'red'                })            })        })    });    var starLayer = new ol.layer.Vector({        source: new ol.source.Vector(),        style: new ol.style.Style({            image: new ol.style.RegularShape({                points: 5,                radius1: 20,                radius2: 10,                fill: new ol.style.Fill({                    color: 'red'                })            })        })    });    var map2 = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          }),           circleLayer, starLayer        ],        target: 'map2',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // 在地图上添加一个圆    var circle1 = new ol.Feature({        geometry: new ol.geom.Point(ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'))    })    circleLayer.getSource().addFeature(circle1);    // 在地图上添加一个五星    var star = new ol.Feature({        geometry: new ol.geom.Point(ol.proj.transform(              [104.06, 30.05], 'EPSG:4326', 'EPSG:3857'))    })    starLayer.getSource().addFeature(star);    // 添加一个用于选择Feature的交互方式    map2.addInteraction(new ol.interaction.Select({        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'blue'                })            })        }),        filter: function(feature, layer){            return layer === circleLayer;        }    }));</script><p>代码其实也是非常简单，前面大部分代码都是一样的，关键在最后：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建一个用于存放circle的layer</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circleLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 创建一个用于存放star的layer</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> starLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.RegularShape(&#123;</span></span><br><span class="line"><span class="undefined">points: 5,</span></span><br><span class="line"><span class="undefined">radius1: 20,</span></span><br><span class="line"><span class="undefined">radius2: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;), </span></span><br><span class="line"><span class="undefined">  circleLayer, starLayer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在地图上添加一个圆</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circle1 = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>))</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">circleLayer.getSource().addFeature(circle1);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在地图上添加一个五星</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> star = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104.06</span>, <span class="number">30.05</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>))</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">starLayer.getSource().addFeature(star);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个用于选择Feature的交互方式</span></span></span><br><span class="line"><span class="actionscript">map2.addInteraction(<span class="keyword">new</span> ol.interaction.Select(&#123;</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 关键： 设置过了条件，可以用feature来写过滤，也可以用layer来写过滤</span></span></span><br><span class="line"><span class="actionscript">filter: <span class="function"><span class="keyword">function</span><span class="params">(feature, layer)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">return</span> layer === circleLayer;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="选取多个feature"><a href="#选取多个feature" class="headerlink" title="选取多个feature"></a>选取多个feature</h2><p>前面的例子都只是一个<code>feature</code>的情况，在实际应用中，肯定是不止一个的，如果要能同时选择多个，只需要设置一下构造函数的参数<code>multi: true</code>，默认情况下，只能选取一个<code>feature</code>。 仿照上面的代码，可自行尝试。</p><h1 id="Feature选取之取消选中"><a href="#Feature选取之取消选中" class="headerlink" title="Feature选取之取消选中"></a>Feature选取之取消选中</h1><p> 取消选中有两种方式， 一种是在界面上以交互的方式取消选中，一种是用代码的方式取消选中，下面就分别介绍一下</p><h2 id="交互方式取消选中"><a href="#交互方式取消选中" class="headerlink" title="交互方式取消选中"></a>交互方式取消选中</h2><p>如果是采用的默认的方式选取<code>feature</code>，即使用鼠标左键单击<code>feature</code>就可选取。那么这种交互方式下，要取消选中，则只需要同样使用鼠标左键，在地图其他地方单击一下，就可取消选中。 可跳到<a href="09-03.md">要素选取之选中样式</a>，在第一个地图上试试。 </p><p>如果采用的是自定义的方式选取<code>feature</code>，那么要取消选中，交互方式还是一样的，只要目标不再是已选中的<code>feature</code>就行，就能取消选中。 比如<a href="09-04.md">要素选取之条件过滤</a>中，采用了自定义的鼠标移入<code>feature</code>就可选中，要取消选中，只需要把鼠标移出<code>feature</code>即可。</p><h2 id="代码方式取消选中"><a href="#代码方式取消选中" class="headerlink" title="代码方式取消选中"></a>代码方式取消选中</h2><p>点击地图下方的“取消选中”按钮，就可触发代码，取消<code>circle</code>的选中状态：</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><p><input type="button" value="取消选中" onclick="unselectFeature();"></p><script type="text/javascript">    var layer = new ol.layer.Vector({        source: new ol.source.Vector(),        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'red'                })            })        })    });    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          }),           layer        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // 在地图上添加一个圆    var circle = new ol.Feature({        geometry: new ol.geom.Point(ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'))    })    layer.getSource().addFeature(circle);    // 添加一个用于选择Feature的交互方式    var clickSelect = new ol.interaction.Select({        style: new ol.style.Style({            image: new ol.style.Circle({                radius: 10,                fill: new ol.style.Fill({                    color: 'blue'                })            })        })    });    map.addInteraction(clickSelect);    // 取消选中    function unselectFeature() {        clickSelect.getFeatures().clear();        // 下面这样也是可以取消选中的，根据情况选择        // map.removeInteraction(clickSelect);    }</script><p>前面的代码都一样，关键在最后：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"取消选中"</span> <span class="attr">onclick</span>=<span class="string">"unselectFeature();"</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> layer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;), </span></span><br><span class="line"><span class="undefined">  layer</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 在地图上添加一个圆</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> circle = <span class="keyword">new</span> ol.Feature(&#123;</span></span><br><span class="line"><span class="actionscript">geometry: <span class="keyword">new</span> ol.geom.Point(ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>))</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">layer.getSource().addFeature(circle);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个用于选择Feature的交互方式</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> clickSelect = <span class="keyword">new</span> ol.interaction.Select(&#123;</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">image: <span class="keyword">new</span> ol.style.Circle(&#123;</span></span><br><span class="line"><span class="undefined">radius: 10,</span></span><br><span class="line"><span class="actionscript">fill: <span class="keyword">new</span> ol.style.Fill(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'blue'</span></span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined">map.addInteraction(clickSelect);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 取消选中</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">unselectFeature</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">clickSelect.getFeatures().clear();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// 下面这样也是可以取消选中的，根据情况选择</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// map.removeInteraction(clickSelect);</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>至此，地图上元素的选取相关的知识点都介绍完毕，希望能逐个掌握并融会贯通于实际应用中。</p><h1 id="绘图"><a href="#绘图" class="headerlink" title="绘图"></a>绘图</h1><p>除了内置了用于选取<code>feature</code>的类之外，OpenLayers 3还提供了用户绘图的类<code>ol.interaction.Draw</code>，支持绘制点，线，多边形，圆等绘制。 我们可以先看一下下面这个可以绘制一条线的例子，用鼠标左键单击地图，地图上就会出现待绘制线的起点，随后移动鼠标，就看到了线，再单击地图，就在这个线上添加了点，依次可以添加多个点，如果要完成线的绘制，在最后一个点处，再点击一下鼠标左键即可。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    map.addInteraction(new ol.interaction.Draw({        type: 'LineString'    }));</script><p>代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加绘图的交互类</span></span></span><br><span class="line"><span class="actionscript">map.addInteraction(<span class="keyword">new</span> ol.interaction.Draw(&#123;</span></span><br><span class="line"><span class="actionscript">type: <span class="string">'LineString'</span> <span class="comment">// 设置绘制线</span></span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>看起来非常的简单。 但貌似还不可用，因为不知道怎么保存起来，下面我们把绘制完的线保存起来：</p><p><div id="map2" style="width: 100%"></div></p><script type="text/javascript">    var map2 = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map2',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // 添加一个绘制的线使用的layer    var lineLayer = new ol.layer.Vector({        source: new ol.source.Vector(),        style: new ol.style.Style({            stroke: new ol.style.Stroke({                color: 'red',                size: 1            })        })    })    map2.addLayer(lineLayer);    map2.addInteraction(new ol.interaction.Draw({        type: 'LineString',        source: lineLayer.getSource()    // 注意设置source，这样绘制好的线，就会添加到这个source里    }));</script><p>比上一个地图写的代码稍微多一点，关键的代码还是在最后：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map2"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map2 = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map2'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个绘制的线使用的layer</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> lineLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">size: 1</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">map2.addLayer(lineLayer);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">map2.addInteraction(<span class="keyword">new</span> ol.interaction.Draw(&#123;</span></span><br><span class="line"><span class="actionscript">type: <span class="string">'LineString'</span>,</span></span><br><span class="line"><span class="actionscript">source: lineLayer.getSource()<span class="comment">// 注意设置source，这样绘制好的线，就会添加到这个source里</span></span></span><br><span class="line"><span class="undefined">&#125;));</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样，在地图上绘制一条线的工作基本上算是完成了。 按照这个流程，修改<code>ol.interaction.Draw</code>的构造参数<code>type</code>的值为’Point’，’Polygon’,，’MultiPoint’，’MultiLineString’，’MultiPolygon’ 或者 ‘Circle’就可以添加点，多边形，多个点，多条线，多个多边形，及圆。 可以自行修改验证。</p><h1 id="绘图进阶"><a href="#绘图进阶" class="headerlink" title="绘图进阶"></a>绘图进阶</h1><p>前面只是简单的绘制上了一条线，在实际业务中，可能还需要设置绘图时的样式，限制绘制的点的个数，获取绘制的图形的所有坐标等。 在上一节的基础上，以下面这个地图为例，再给大家介绍一下这些方面的更深入的应用。下面绘制这条线的点不能超过4个，在绘制时，样式会和前一节的样式不太一样，在地图上方，会显示当前绘制完的线的所有点的坐标。</p><p><head><br>    <link href="../src/ol3.13.1/ol.css" rel="stylesheet" type="text/css"><br>    <script type="text/javascript" src="../src/ol3.13.1/ol.js" charset="utf-8"></script><br></head></p><p><div style="background-color: #999;"><span>当前绘制线的坐标：</span><span id="points"></span></div></p><p><div id="map" style="width: 100%"></div></p><script type="text/javascript">    var map = new ol.Map({        layers: [          new ol.layer.Tile({            source: new ol.source.OSM()          })        ],        target: 'map',        view: new ol.View({          center: ol.proj.transform(              [104, 30], 'EPSG:4326', 'EPSG:3857'),          zoom: 10        })    });    // 添加一个绘制的线使用的layer    var lineLayer = new ol.layer.Vector({        source: new ol.source.Vector(),        style: new ol.style.Style({            stroke: new ol.style.Stroke({                color: 'red',                size: 1            })        })    })    map.addLayer(lineLayer);    var lineDraw = new ol.interaction.Draw({        type: 'LineString',        source: lineLayer.getSource(),    // 注意设置source，这样绘制好的线，就会添加到这个source里        style: new ol.style.Style({            stroke: new ol.style.Stroke({                color: '#009933',                size: 1            })        }),        maxPoints: 4    });    // 监听线绘制结束事件，获取坐标    lineDraw.on('drawend', function(event){        document.getElementById('points').innerHTML = JSON.stringify(event.feature.getGeometry().getCoordinates());    });    map.addInteraction(lineDraw);</script><p>代码如下，关键代码还是放在最后：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"background-color: #999;"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>当前绘制线的坐标：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">'points'</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="undefined">layers: [</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">    source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">  &#125;)</span></span><br><span class="line"><span class="undefined">],</span></span><br><span class="line"><span class="actionscript">target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">  center: ol.proj.transform(</span></span><br><span class="line"><span class="actionscript">      [<span class="number">104</span>, <span class="number">30</span>], <span class="string">'EPSG:4326'</span>, <span class="string">'EPSG:3857'</span>),</span></span><br><span class="line"><span class="undefined">  zoom: 10</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 添加一个绘制的线使用的layer</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> lineLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">size: 1</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">map.addLayer(lineLayer);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> lineDraw = <span class="keyword">new</span> ol.interaction.Draw(&#123;</span></span><br><span class="line"><span class="actionscript">type: <span class="string">'LineString'</span>,</span></span><br><span class="line"><span class="actionscript">source: lineLayer.getSource(),<span class="comment">// 注意设置source，这样绘制好的线，就会添加到这个source里</span></span></span><br><span class="line"><span class="actionscript">style: <span class="keyword">new</span> ol.style.Style(&#123;<span class="comment">// 设置绘制时的样式</span></span></span><br><span class="line"><span class="actionscript">stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">color: <span class="string">'#009933'</span>,</span></span><br><span class="line"><span class="undefined">size: 1</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined">&#125;),</span></span><br><span class="line"><span class="actionscript">maxPoints: <span class="number">4</span><span class="comment">// 限制不超过4个点</span></span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 监听线绘制结束事件，获取坐标</span></span></span><br><span class="line"><span class="actionscript">lineDraw.on(<span class="string">'drawend'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// event.feature 就是当前绘制完成的线的Feature</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.getElementById(<span class="string">'points'</span>).innerHTML = <span class="built_in">JSON</span>.stringify(event.feature.getGeometry().getCoordinates());</span></span><br><span class="line"><span class="undefined">&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">map.addInteraction(lineDraw);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>如果需要取消当前绘制，直接用<code>map.removeInteraction(lineDraw)</code>就可以了。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="交互实现流程"><a href="#交互实现流程" class="headerlink" title="交互实现流程"></a>交互实现流程</h2><p>从地图浏览的交互类，到<code>feature</code>选取的类，再到绘制图形的类，都是从事件入手，在引擎内部，提供了一个事件传递的通道，支持通过<code>ol.Map</code>添加<code>interaction</code>的方式，接收事件消息，然后再根据业务进行处理。 </p><h2 id="封装的优点和缺点"><a href="#封装的优点和缺点" class="headerlink" title="封装的优点和缺点"></a>封装的优点和缺点</h2><p>毫无疑问，已经内置实现的功能，将极大地提高系统可用性，减少开发者的负担。 但内置的这些通用功能，如果是简单的封装，并不能满足大多数的需要，但是过多的封装，将增大复杂性，比如很多<code>interaction</code>类都有很多的参数设置，必然增加学习和使用成本，这就是缺点。</p><p>对于一般的开发者而言，没有能力自己重新定制开发交互方式，那么最好是学会内置类的应用，虽然有学习成本，但能保证功能没有问题。对于高阶开发者而言，可选择性就很多了，如果效率不行或者流程太复杂，就自己开发。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Interaction&quot;&gt;&lt;a href=&quot;#Interaction&quot; class=&quot;headerlink&quot; title=&quot;Interaction&quot;&gt;&lt;/a&gt;Interaction&lt;/h1&gt;&lt;p&gt;交互是人机界面非常重要的一个部分，任何一个GIS引擎都会内置这一部分功能，而不是让开发者自己实现。 在交互方式上，几乎都是约定俗成的，比如用鼠标左键双击地图可以放大地图，按住鼠标左键拖动地图可以移动浏览地图，用滚动鼠标中间的滑轮可以放大缩小地图等等。 OpenLayers 3都内置支持这些交互方式，同时还具备更多的其他交互方式，这些都将一并在本章节介绍。 更为重要的是，了解其中的基本原理，并在此基础上，应用于自己的业务开发。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 常见问题</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch13/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch13/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:09:21.354Z</updated>
    
    <content type="html"><![CDATA[<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><ul><li><p>Q: ol3支持gif吗？</p><p>A: ol.style.Icon并不支持，但可以通过ol.Overlay来加载dom的方式支持。注意：在一个地图中如果存在几千个overlay，将影响效率。</p></li></ul><a id="more"></a><ul><li><p>Q: 地图缩小后，在一个页面出现多个一样的地图，如何才能只显示一个？</p><p>A: 在创建source的时候，设置wrapX属性为false就可以。</p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;常见问题&quot;&gt;&lt;a href=&quot;#常见问题&quot; class=&quot;headerlink&quot; title=&quot;常见问题&quot;&gt;&lt;/a&gt;常见问题&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Q: ol3支持gif吗？&lt;/p&gt;
&lt;p&gt;A: ol.style.Icon并不支持，但可以通过ol.Overlay来加载dom的方式支持。注意：在一个地图中如果存在几千个overlay，将影响效率。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>OpenLayers 3 进阶实例</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/ch12/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/ch12/index.html</id>
    <published>2018-01-18T12:29:59.000Z</published>
    <updated>2018-01-30T14:09:11.558Z</updated>
    
    <content type="html"><![CDATA[<h1 id="进阶实例"><a href="#进阶实例" class="headerlink" title="进阶实例"></a>进阶实例</h1><p>前面的基础知识，用于应对基本应用没有问题，但如果想更进一步的结合在一起应用，或者解决更为复杂一点的问题，则稍显困难。本章节针对这类问题给出一些实例讲解，以解决广大ol3使用者的困惑，用于感谢大家对本教程的支持。针对这类问题，曾经在Openlayer3 QQ群里面收集统计过，下面的例子就是基于这些统计数据分析讨论而出的。如果你有什么其他的想法或意见，请在下方留言或QQ联系我（11364382），谢谢。</p><a id="more"></a><h1 id="通过wfs增删改查要素"><a href="#通过wfs增删改查要素" class="headerlink" title="通过wfs增删改查要素"></a>通过wfs增删改查要素</h1><p>本节将讲解ol3使用wfs同后台geoserver进行交互，从而实现要素的增删改查。由于geoserver需要服务器端，所以我们将从环境搭建开始讲解，使用公开的数据源，进行查询，修改，添加，删除操作的演示，使得大家最终学会。</p><h1 id="在windows环境下配置GeoServer"><a href="#在windows环境下配置GeoServer" class="headerlink" title="在windows环境下配置GeoServer"></a>在windows环境下配置GeoServer</h1><p>由于wfs协议涉及到跨域的问题，在配置过程中，我们也将把跨域的环境配置好。虽然跨域的解决方式有很多，但此处选择一个稍微简单的方式，详见下面的具体步骤。</p><h2 id="安装Java环境"><a href="#安装Java环境" class="headerlink" title="安装Java环境"></a>安装Java环境</h2><p>我们使用tomcat作为服务器，所以需要java环境，如果你不确定是否安装有java环境，则可以在命令终端执行： <code>java -version</code>，比如我的环境：<br><img src="../img/java-version.png" alt="java-version"></p><p>如果提示<code>java</code>命令找不到的错误，说明你得优先安装java环境，请到<a href="http://www.java.com/zh_CN/" target="_blank" rel="noopener">官网</a>下载最新的Java进行安装。</p><h2 id="下载Tomcat"><a href="#下载Tomcat" class="headerlink" title="下载Tomcat"></a>下载Tomcat</h2><p>安装好java环境后，我们就到<a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat官网</a>下载Tomcat，如果java环境是64位的，记得下载64位的Tomcat，如果是32位的java环境，就需要下载32位的tomcat。如上图所示，我的是64位java环境，我选择下载8.5.4版本，64位的windows环境的tomcat： <a href="https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.4/bin/apache-tomcat-8.5.4-windows-x64.zip" target="_blank" rel="noopener">apache-tomcat-8.5.4-windows-x64.zip</a>。</p><p>下载后，解压到一个指定的目录， 我放在了<code>F:\apache-tomcat-8.5.4</code>。记住，解压就可以了，免安装，此时需要验证一下是否能正常启动Tomcat，启动命令终端，执行tomcat目录下的<code>bin\startup.bat</code>，如下：<br><img src="../img/tomcat-startup-fail.png" alt="tomcat-startup-fail"></p><p>从上图可以发现，我们还没有配置环境变量<code>JAVA_HOME</code>或者<code>JRE_HOME</code>。那么我先配置一个<code>JAVA_HOME</code>的环境变量，配置好后，记得注销或者重启电脑，让环境变量生效。 然后重新执行命令，正确启动如下：<br><img src="../img/tomcat-startup-ok.png" alt="tomcat-startup-ok"></p><p>成功启动会弹出一个新的<code>tomcat</code>命令行窗口，参见上图左边的命令行窗口。</p><h2 id="安装GeoServer"><a href="#安装GeoServer" class="headerlink" title="安装GeoServer"></a>安装GeoServer</h2><p>此时，我们需要到<a href="http://geoserver.org/" target="_blank" rel="noopener">GeoServer官网</a>去下载geoserver，我选择了最新的2.9.1版本，由于我使用tomcat作为服务器，所以我选择下载<code>Web Archive</code>格式的<a href="https://sourceforge.net/projects/geoserver/files/GeoServer/2.9.1/geoserver-2.9.1-war.zip/download" target="_blank" rel="noopener">geoserver-2.9.1-war.zip</a>。</p><p>下载后解压到得到war文件：<code>geoserver.war</code>，把该文件放置到tomcat目录下的webapps目录下，比如放置该文件后，我的路径为：<code>F:\apache-tomcat-8.5.4\webapps\geoserver.war</code>。</p><p>然后在命令行终端启动tomcat，可能需要稍微等待一下，因为要部署geoserver，待tomcat命令行终端启动完成，就可以打开浏览器输入<code>http://localhost:8080/geoserver</code>打开geoserver的管理页面，如下：<br><img src="../img/geoserver-index.png" alt="geoserver-index"></p><p>见到这个页面，也就安装成功了。如果没有出现该页面，请按照前面的步骤检查一下什么地方出问题了。</p><h2 id="跨域配置"><a href="#跨域配置" class="headerlink" title="跨域配置"></a>跨域配置</h2><p>由于tomcat从7.0.41版本开始就支持跨域了，参见<a href="http://enable-cors.org/server_tomcat.html" target="_blank" rel="noopener">CORS on Tomcat</a>，我们下载的tomcat是8.5.4，自然就能很好的支持了，只需要进行下面的简单配置：</p><ul><li>找到geoserver的<code>web.xml</code>文件，我的电脑对应的路径为<code>F:\apache-tomcat-8.5.4\webapps\geoserver\WEB-INF\web.xml</code></li><li>打开该文件，把下面的配置添加在该文件中：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CorsFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.catalina.filters.CorsFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CorsFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p><img src="../img/web-cross.png" alt="web-cross-config"></p><p>然后再重新启动tomcat即可。</p><h1 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h1><p>为了后续进行wfs的各项使用演示，我就使用geoserver官方中使用的数据<a href="http://docs.geoserver.org/latest/en/user/_downloads/nyc_roads.zip" target="_blank" rel="noopener">nyc_roads.zip</a>。这份数据的配置，官网也提供了指导，参见<a href="http://docs.geoserver.org/latest/en/user/gettingstarted/shapefile-quickstart/index.html" target="_blank" rel="noopener">Publishing a shapefile</a>。</p><p>下面就以我的计算机配置为例，进行说明：</p><ol><li><p>下载后解压，把压缩包里面的<code>nyc_roads.dbf, nyc_roads.prj, nyc_roads.shp, nyc_roads.shx</code>放在目录<code>F:\apache-tomcat-8.5.4\webapps\geoserver\data\data\nyc_roads</code>下，<code>nyc_roads</code>这个目录没有，就新建一个。</p></li><li><p>启动tomcat，在浏览器中打开geoserver的配置页面<code>http://localhost:8080/geoserver</code>，使用用户admin登录，密码为geoserver。</p></li><li><p>创建<code>工作区</code>：</p></li></ol><p><img src="../img/create-workspace.png" alt="create-workspace"><br><img src="../img/new-workspace.png" alt="new-workspace"></p><ol><li>创建<code>数据存储</code>：</li></ol><p><img src="../img/create-database.png" alt="create-database"><br><img src="../img/create-database-2.png" alt="create-database2"><br><img src="../img/new-database.png" alt="new-database"></p><ol><li>创建<code>图层</code>，数据源配置好后，保存，就出现下面这个界面：</li></ol><p><img src="../img/create-layer.png" alt="create-layer"><br>点击<code>发布</code>创建新图层：<br><img src="../img/edit-layer.png" alt="edit-layer"><br><img src="../img/edit-layer2.png" alt="edit-layer2"></p><p>最后点击页面最下方的<code>保存</code>按钮，就配置好了。</p><ol><li>最后预览一下，点击左边的<code>Layer Preview</code>，在右边找到刚才创建的图层<code>nyc_roads:nyc_roads</code>，点击右边的OpenLayers，就可以打开新页面，显示预览结果。<br><img src="../img/layer-preview.png" alt="layer-preview"><br><img src="../img/nyc_roads-result.png" alt="layer-preview"></li></ol><p>出现最后一个页面，就说明数据源配置好了。 </p><h1 id="通过wfs查询要素"><a href="#通过wfs查询要素" class="headerlink" title="通过wfs查询要素"></a>通过wfs查询要素</h1><p>一切都准备好了，现在终于可以通过ol3加载配置好的数据了。上一节中最后的预览结果，大家已经看到了，此处我们自己通过ol3来实现这个预览页面，效果图如下：</p><p><img src="../img/wfs-query-nyc-roads.png" alt="wfs query demo"></p><p>对应的代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>wfs demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../ol3.15.1/ol.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../ol3.17.1/ol-debug.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> vector = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">      source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">        format: <span class="keyword">new</span> ol.format.GeoJSON(),</span></span><br><span class="line"><span class="actionscript">        url: <span class="string">'http://localhost:8080/geoserver/wfs?service=wfs&amp;version=1.1.0&amp;request=GetFeature&amp;typeNames=nyc_roads:nyc_roads&amp;outputFormat=application/json&amp;srsname=EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">      &#125;),</span></span><br><span class="line"><span class="actionscript">      style: <span class="function"><span class="keyword">function</span><span class="params">(feature, resolution)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">          stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">            color: <span class="string">'blue'</span>,</span></span><br><span class="line"><span class="undefined">            width: 1</span></span><br><span class="line"><span class="undefined">          &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">      layers: [<span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), vector],</span></span><br><span class="line"><span class="actionscript">      target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">      view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">        center: [-73.99710639567148, 40.742270050255556],</span></span><br><span class="line"><span class="undefined">        maxZoom: 19,</span></span><br><span class="line"><span class="undefined">        zoom: 14,</span></span><br><span class="line"><span class="actionscript">        projection: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>和一般的矢量地图加载没什么两样，对于wfs而言，需要弄明白的是<code>ol.source.Vector</code>的<code>url</code>参数： <code>http://localhost:8080/geoserver/wfs?service=wfs&amp;version=1.1.0&amp;request=GetFeature&amp;typeNames=nyc_roads:nyc_roads&amp;outputFormat=application/json&amp;srsname=EPSG:4326</code>。 如果对wfs协议不太清楚的，建议优先看一下geoserver的官网文档<a href="http://docs.geoserver.org/stable/en/user/services/wfs/index.html" target="_blank" rel="noopener">WFS</a>。 </p><p>此处我们要获取所有的要素，所以设置<code>request=GetFeature</code>，<code>typeNames</code>的值设置为<code>nyc_roads:nyc_roads</code>，是因为我们之前配置的图层命名如此，可以在geoserver管理页面的<code>Layer Preview</code>里面看对应图层的<code>Name</code>。 对于<code>outputFormat</code>和<code>srsname</code>就不做过多解释，大家看值就容易明白了。因为<code>view</code>设置的<code>projection: &#39;EPSG:4326&#39;</code>，所以此处设置<code>srsname=EPSG:4326</code>。</p><p>BTW: 上面是全部查询，我们知道wfs也支持filter，所以我们可以在<code>url</code>里面设置filter，从而实现更细粒度的查询，比如这样：<code>http://localhost:8080/geoserver/wfs?service=wfs&amp;version=1.1.0&amp;request=GetFeature&amp;typeNames=nyc_roads:nyc_roads&amp;outputFormat=application/json&amp;srsname=EPSG:4326&amp;cql_filter=in (&#39;nyc_roads.1162&#39;)</code>。 大家可以自行用这个url进行测试一下。关于filter更详细的信息参见<a href="http://docs.geoserver.org/latest/en/user/filter/syntax.html" target="_blank" rel="noopener">Supported filter languages</a>。 因为这不是教程的重点，所以此处不进行细说。</p><h1 id="通过wfs修改要素"><a href="#通过wfs修改要素" class="headerlink" title="通过wfs修改要素"></a>通过wfs修改要素</h1><p>在查询的基础上，本小节我们更进一步对界面上呈现的要素进行修改，然后通过wfs协议保存到服务器端。界面效果如下:</p><p><img src="../img/wfs-modify.png" alt="wfs modify demo"></p><p>在界面上方，先点击<code>查询</code>按钮，通过wfs协议把所有的要素查询到前端界面上显示，然后选择复选框<code>编辑</code>，就可以选择界面上的线段，进行编辑，比如把直线编辑成<code>W</code>形状，然后点击按钮<code>保存</code>，就可以把编辑后的线段保存下来。</p><p>在点击<code>保存</code>按钮之前，请打开开发者面板，然后再点击<code>保存</code>，之后就可以看到发起了一个wfs的http请求到geoserver服务器，请求的url为：<code>http://localhost:8080/geoserver/wfs?service=wfs</code>，发送的内容大致为:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Transaction</span> <span class="attr">xmlns</span>=<span class="string">"http://www.opengis.net/wfs"</span> <span class="attr">service</span>=<span class="string">"WFS"</span> <span class="attr">version</span>=<span class="string">"1.1.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Update</span> <span class="attr">typeName</span>=<span class="string">"feature:nyc_roads"</span> <span class="attr">xmlns:feature</span>=<span class="string">"http://geoserver.org/nyc_roads"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>the_geom<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">MultiLineString</span> <span class="attr">xmlns</span>=<span class="string">"http://www.opengis.net/gml"</span> <span class="attr">srsName</span>=<span class="string">"EPSG:4326"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">lineStringMember</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">LineString</span> <span class="attr">srsName</span>=<span class="string">"EPSG:4326"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">posList</span>&gt;</span>-73.98528635501862 40.768332481384284 -73.98608637 40.76719342 -73.98449242115021 40.767849683761604 -73.98447096347809 40.76647639274598 -73.98299038410187 40.767334699630744 -73.98336657 40.76604531<span class="tag">&lt;/<span class="name">posList</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">LineString</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">lineStringMember</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">MultiLineString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>modified<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>5/28/2001<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>name<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>W 56 ST<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>vsam<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>15060<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>sourcedate<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>3/31/1996<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>sourcetype<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>Photogrammetric<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>source_id<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>96083<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>borough<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>Manhattan<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>feat_code<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>2900<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>feat_desc<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>Paved Road<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>exported<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>05/19/2004<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Name</span>&gt;</span>feat_type<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">xmlns</span>=<span class="string">"http://www.opengis.net/ogc"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FeatureId</span> <span class="attr">fid</span>=<span class="string">"nyc_roads.882"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Transaction</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>如果保存成功，则<code>response</code>的内容大致如下：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;wf<span class="variable">s:TransactionResponse</span> </span><br><span class="line">  xmln<span class="variable">s:xs</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> </span><br><span class="line">  xmln<span class="variable">s:sf</span>=<span class="string">"http://www.openplans.org/spearfish"</span> </span><br><span class="line">  xmln<span class="variable">s:wfs</span>=<span class="string">"http://www.opengis.net/wfs"</span> </span><br><span class="line">  xmln<span class="variable">s:gml</span>=<span class="string">"http://www.opengis.net/gml"</span> </span><br><span class="line">  xmln<span class="variable">s:nyc_roads</span>=<span class="string">"http://geoserver.org/nyc_roads"</span> </span><br><span class="line">  xmln<span class="variable">s:ogc</span>=<span class="string">"http://www.opengis.net/ogc"</span> </span><br><span class="line">  xmln<span class="variable">s:ows</span>=<span class="string">"http://www.opengis.net/ows"</span> </span><br><span class="line">  xmln<span class="variable">s:tiger</span>=<span class="string">"http://www.census.gov"</span> </span><br><span class="line">  xmln<span class="variable">s:topp</span>=<span class="string">"http://www.openplans.org/topp"</span> </span><br><span class="line">  xmln<span class="variable">s:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="keyword">x</span></span><br><span class="line">  mln<span class="variable">s:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> </span><br><span class="line">  <span class="keyword">version</span>=<span class="string">"1.1.0"</span> </span><br><span class="line">  xsi:schemaLocation=<span class="string">"http://www.opengis.net/wfs http://localhost:8080/geoserver/schemas/wfs/1.1.0/wfs.xsd"</span>&gt;</span><br><span class="line"></span><br><span class="line">  &lt;wf<span class="variable">s:TransactionSummary</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:totalInserted</span>&gt;<span class="number">0</span>&lt;/wf<span class="variable">s:totalInserted</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:totalUpdated</span>&gt;<span class="number">1</span>&lt;/wf<span class="variable">s:totalUpdated</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:totalDeleted</span>&gt;<span class="number">0</span>&lt;/wf<span class="variable">s:totalDeleted</span>&gt;</span><br><span class="line">  &lt;/wf<span class="variable">s:TransactionSummary</span>&gt;</span><br><span class="line">  &lt;wf<span class="variable">s:TransactionResults</span>/&gt;</span><br><span class="line">  &lt;wf<span class="variable">s:InsertResults</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:Feature</span>&gt;&lt;ogc:FeatureId fid=<span class="string">"none"</span>/&gt;&lt;/wf<span class="variable">s:Feature</span>&gt;</span><br><span class="line">  &lt;/wf<span class="variable">s:InsertResults</span>&gt;</span><br><span class="line">&lt;/wf<span class="variable">s:TransactionResponse</span>&gt;</span><br></pre></td></tr></table></figure></p><p>重新刷新页面后，再次点击<code>查询</code>按钮，可以验证之前修改的线段是否修改成功。由于不能提供geoserver服务器，所以只能让大家自行用下面的代码在本地验证：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>wfs modify demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../ol3.17.1/ol.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../ol3.17.1/ol-debug.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../3rdparty/zepto.min.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"查询"</span> <span class="attr">onclick</span>=<span class="string">"queryWfs();"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"select"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"select"</span> /&gt;</span>选择</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"modify"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"modify"</span> /&gt;</span>编辑</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"save"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"保存"</span> <span class="attr">onclick</span>=<span class="string">"onSave();"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> wfsVectorLayer = <span class="literal">null</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> modifiedFeatures = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 选择器</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> selectInteraction = <span class="keyword">new</span> ol.interaction.Select(&#123;</span></span><br><span class="line"><span class="actionscript">      style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">          color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">          width: 2</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 修改器</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> modifyInteraction = <span class="keyword">new</span> ol.interaction.Modify(&#123;</span></span><br><span class="line"><span class="actionscript">      style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">          color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">          width: 5</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;),</span></span><br><span class="line"><span class="undefined">      features: selectInteraction.getFeatures()</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="actionscript">    modifyInteraction.on(<span class="string">'modifyend'</span>, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 把修改完成的feature暂存起来</span></span></span><br><span class="line"><span class="undefined">      modifiedFeatures = e.features;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">      layers: [<span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;)],</span></span><br><span class="line"><span class="actionscript">      target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">      view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">        center: [-73.99710639567148, 40.742270050255556],</span></span><br><span class="line"><span class="undefined">        maxZoom: 19,</span></span><br><span class="line"><span class="undefined">        zoom: 13,</span></span><br><span class="line"><span class="actionscript">        projection: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 通过wfs查询所有的要素</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">queryWfs</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 支持重新查询</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (wfsVectorLayer) &#123;</span></span><br><span class="line"><span class="undefined">        map.removeLayer(wfsVectorLayer);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">      </span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 创建新的图层来加载wfs的要素</span></span></span><br><span class="line"><span class="actionscript">      wfsVectorLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">          format: <span class="keyword">new</span> ol.format.GeoJSON(&#123;</span></span><br><span class="line"><span class="actionscript">            geometryName: <span class="string">'the_geom'</span> <span class="comment">// 因为数据源里面字段the_geom存储的是geometry，所以需要指定</span></span></span><br><span class="line"><span class="undefined">          &#125;),</span></span><br><span class="line"><span class="actionscript">          url: <span class="string">'http://localhost:8080/geoserver/wfs?service=wfs&amp;version=1.1.0&amp;request=GetFeature&amp;typeNames=nyc_roads:nyc_roads&amp;outputFormat=application/json&amp;srsname=EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">        &#125;),</span></span><br><span class="line"><span class="actionscript">        style: <span class="function"><span class="keyword">function</span><span class="params">(feature, resolution)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">            stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">              color: <span class="string">'blue'</span>,</span></span><br><span class="line"><span class="undefined">              width: 5</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">          &#125;);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">      map.addLayer(wfsVectorLayer);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    $(<span class="string">'#select'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (<span class="keyword">this</span>.checked) &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 勾选选择复选框时，添加选择器到地图</span></span></span><br><span class="line"><span class="undefined">        map.removeInteraction(selectInteraction);</span></span><br><span class="line"><span class="undefined">        map.addInteraction(selectInteraction);</span></span><br><span class="line"><span class="actionscript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 不勾选选择复选框的情况下，移出选择器和修改器</span></span></span><br><span class="line"><span class="undefined">        map.removeInteraction(selectInteraction);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">'modify'</span>).checked = <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        map.removeInteraction(modifyInteraction);</span></span><br><span class="line"><span class="actionscript">        modifiedFeatures = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'#modify'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (<span class="keyword">this</span>.checked) &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 勾选修改复选框时，添加选择器和修改器到地图</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">'select'</span>).checked = <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">        map.removeInteraction(modifyInteraction);</span></span><br><span class="line"><span class="undefined">        map.addInteraction(modifyInteraction);</span></span><br><span class="line"><span class="undefined">        map.removeInteraction(selectInteraction);</span></span><br><span class="line"><span class="undefined">        map.addInteraction(selectInteraction);</span></span><br><span class="line"><span class="actionscript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 不勾选修改复选框时，移出修改器</span></span></span><br><span class="line"><span class="undefined">        map.removeInteraction(modifyInteraction);</span></span><br><span class="line"><span class="actionscript">        modifiedFeatures = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 保存已经编辑的要素</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">onSave</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (modifiedFeatures &amp;&amp; modifiedFeatures.getLength() &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 转换坐标</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> modifiedFeature = modifiedFeatures.item(<span class="number">0</span>).clone();</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 注意ID是必须，通过ID才能找到对应修改的feature</span></span></span><br><span class="line"><span class="undefined">        modifiedFeature.setId(modifiedFeatures.item(0).getId());</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 调换经纬度坐标，以符合wfs协议中经纬度的位置</span></span></span><br><span class="line"><span class="actionscript">        modifiedFeature.getGeometry().applyTransform(<span class="function"><span class="keyword">function</span><span class="params">(flatCoordinates, flatCoordinates2, stride)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; flatCoordinates.length; j += stride) &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> y = flatCoordinates[j];</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> x = flatCoordinates[j + <span class="number">1</span>];</span></span><br><span class="line"><span class="undefined">            flatCoordinates[j] = x;</span></span><br><span class="line"><span class="undefined">            flatCoordinates[j + 1] = y;</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">        modifyWfs([modifiedFeature]);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 把修改提交到服务器端</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">modifyWfs</span><span class="params">(features)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> WFSTSerializer = <span class="keyword">new</span> ol.format.WFS();</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> featObject = WFSTSerializer.writeTransaction(<span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">        features, <span class="literal">null</span>, &#123;</span></span><br><span class="line"><span class="actionscript">          featureType: <span class="string">'nyc_roads'</span>, </span></span><br><span class="line"><span class="actionscript">          featureNS: <span class="string">'http://geoserver.org/nyc_roads'</span>,  <span class="comment">// 注意这个值必须为创建工作区时的命名空间URI</span></span></span><br><span class="line"><span class="actionscript">          srsName: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 转换为xml内容发送到服务器端</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> serializer = <span class="keyword">new</span> XMLSerializer();</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> featString = serializer.serializeToString(featObject);</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">      request.open(<span class="string">'POST'</span>, <span class="string">'http://localhost:8080/geoserver/wfs?service=wfs'</span>);</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 指定内容为xml类型</span></span></span><br><span class="line"><span class="actionscript">      request.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/xml'</span>);</span></span><br><span class="line"><span class="undefined">      request.send(featString);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="通过wfs添加要素"><a href="#通过wfs添加要素" class="headerlink" title="通过wfs添加要素"></a>通过wfs添加要素</h1><p>现在我们该介绍一下如何在前端绘制一个新的要素，并且保存到服务器端。还是先看一下界面：</p><p><img src="../img/wfs-add.png" alt="wfs add demo"></p><p>勾选<code>新增</code>复选框之后，就可以在界面上绘制新的线段，如图，绘制了一个<code>W</code>形状的线，绘制完成后，点击按钮<code>保存</code>就可以把界面上新增的线保存到服务器端，在开发者工具界面可以看到http请求: <code>http://localhost:8080/geoserver/wfs?service=wfs</code>，请求发送的内容为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Transaction</span> <span class="attr">xmlns</span>=<span class="string">"http://www.opengis.net/wfs"</span> <span class="attr">service</span>=<span class="string">"WFS"</span> <span class="attr">version</span>=<span class="string">"1.1.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nyc_roads</span> <span class="attr">xmlns</span>=<span class="string">"http://geoserver.org/nyc_roads"</span> <span class="attr">fid</span>=<span class="string">"nyc_roads.new.1"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">the_geom</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">MultiLineString</span> <span class="attr">xmlns</span>=<span class="string">"http://www.opengis.net/gml"</span> <span class="attr">srsName</span>=<span class="string">"EPSG:4326"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">lineStringMember</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">LineString</span> <span class="attr">srsName</span>=<span class="string">"EPSG:4326"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">posList</span>&gt;</span>-73.99970054626465 40.732669830322266 -73.98974418640137 40.71481704711914 -73.98545265197754 40.730438232421875 -73.98064613342285 40.71636199951172 -73.97360801696777 40.73284149169922<span class="tag">&lt;/<span class="name">posList</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">LineString</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">lineStringMember</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">MultiLineString</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">the_geom</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>nyc_roads.new.1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">modified</span>&gt;</span>nyc_roads.new.1<span class="tag">&lt;/<span class="name">modified</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">vsam</span>&gt;</span>0<span class="tag">&lt;/<span class="name">vsam</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">sourcedate</span>&gt;</span><span class="tag">&lt;/<span class="name">sourcedate</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">sourcetype</span>&gt;</span><span class="tag">&lt;/<span class="name">sourcetype</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source_id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">source_id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">borough</span>&gt;</span><span class="tag">&lt;/<span class="name">borough</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">feat_code</span>&gt;</span>0<span class="tag">&lt;/<span class="name">feat_code</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">feat_desc</span>&gt;</span>11<span class="tag">&lt;/<span class="name">feat_desc</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">feat_type</span>&gt;</span>0<span class="tag">&lt;/<span class="name">feat_type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">exported</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nyc_roads</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Transaction</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>服务器端<code>response</code>的内容为：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">  &lt;wf<span class="variable">s:TransactionResponse</span> xmln<span class="variable">s:xs</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> xmln<span class="variable">s:sf</span>=<span class="string">"http://www.openplans.org/spearfish"</span> xmln<span class="variable">s:wfs</span>=<span class="string">"http://www.opengis.net/wfs"</span> xmln<span class="variable">s:gml</span>=<span class="string">"http://www.opengis.net/gml"</span> xmln<span class="variable">s:nyc_roads</span>=<span class="string">"http://geoserver.org/nyc_roads"</span> xmln<span class="variable">s:ogc</span>=<span class="string">"http://www.opengis.net/ogc"</span> xmln<span class="variable">s:ows</span>=<span class="string">"http://www.opengis.net/ows"</span> xmln<span class="variable">s:tiger</span>=<span class="string">"http://www.census.gov"</span> xmln<span class="variable">s:topp</span>=<span class="string">"http://www.openplans.org/topp"</span> xmln<span class="variable">s:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> xmln<span class="variable">s:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="keyword">version</span>=<span class="string">"1.1.0"</span> xsi:schemaLocation=<span class="string">"http://www.opengis.net/wfs http://localhost:8080/geoserver/schemas/wfs/1.1.0/wfs.xsd"</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:TransactionSummary</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:totalInserted</span>&gt;<span class="number">1</span>&lt;/wf<span class="variable">s:totalInserted</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:totalUpdated</span>&gt;<span class="number">0</span>&lt;/wf<span class="variable">s:totalUpdated</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:totalDeleted</span>&gt;<span class="number">0</span>&lt;/wf<span class="variable">s:totalDeleted</span>&gt;</span><br><span class="line">    &lt;/wf<span class="variable">s:TransactionSummary</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:TransactionResults</span>/&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:InsertResults</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:Feature</span>&gt;</span><br><span class="line">        &lt;ogc:FeatureId fid=<span class="string">"new0"</span> /&gt;</span><br><span class="line">      &lt;/wf<span class="variable">s:Feature</span>&gt;</span><br><span class="line">    &lt;/wf<span class="variable">s:InsertResults</span>&gt;</span><br><span class="line">  &lt;/wf<span class="variable">s:TransactionResponse</span>&gt;</span><br></pre></td></tr></table></figure></p><p>通过再次刷新界面，点击<code>查询</code>按钮查看所有的feature，可以确认是否添加成功，请自行验证。下面给出对应的代码：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>wfs add demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../ol3.17.1/ol.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../ol3.17.1/ol-debug.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../3rdparty/zepto.min.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"查询"</span> <span class="attr">onclick</span>=<span class="string">"queryWfs();"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"add"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"add"</span> /&gt;</span>新增</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"saveNew"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"保存"</span> <span class="attr">onclick</span>=<span class="string">"onSaveNew();"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> newId = <span class="number">1</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> wfsVectorLayer = <span class="literal">null</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> drawedFeature = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 创建用于新绘制feature的layer</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> drawLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">      source: <span class="keyword">new</span> ol.source.Vector(),</span></span><br><span class="line"><span class="actionscript">      style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">          color: <span class="string">'blue'</span>,</span></span><br><span class="line"><span class="undefined">          width: 5</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 添加绘制新图形的interaction，用于添加新的线条</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> drawInteraction = <span class="keyword">new</span> ol.interaction.Draw(&#123;</span></span><br><span class="line"><span class="actionscript">      type: <span class="string">'LineString'</span>, <span class="comment">// 设定为线条</span></span></span><br><span class="line"><span class="actionscript">      style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">          color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">          width: 10</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;),</span></span><br><span class="line"><span class="undefined">      source: drawLayer.getSource()</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="actionscript">    drawInteraction.on(<span class="string">'drawend'</span>, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 绘制结束时暂存绘制的feature</span></span></span><br><span class="line"><span class="undefined">      drawedFeature = e.feature;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">      layers: [<span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;), drawLayer],</span></span><br><span class="line"><span class="actionscript">      target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">      view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">        center: [-73.99710639567148, 40.742270050255556],</span></span><br><span class="line"><span class="undefined">        maxZoom: 19,</span></span><br><span class="line"><span class="undefined">        zoom: 13,</span></span><br><span class="line"><span class="actionscript">        projection: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">queryWfs</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (wfsVectorLayer) &#123;</span></span><br><span class="line"><span class="undefined">        map.removeLayer(wfsVectorLayer);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">      wfsVectorLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">          format: <span class="keyword">new</span> ol.format.GeoJSON(&#123;</span></span><br><span class="line"><span class="actionscript">            geometryName: <span class="string">'the_geom'</span></span></span><br><span class="line"><span class="undefined">          &#125;),</span></span><br><span class="line"><span class="actionscript">          url: <span class="string">'http://localhost:8080/geoserver/wfs?service=wfs&amp;version=1.1.0&amp;request=GetFeature&amp;typeNames=nyc_roads:nyc_roads&amp;outputFormat=application/json&amp;srsname=EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">        &#125;),</span></span><br><span class="line"><span class="actionscript">        style: <span class="function"><span class="keyword">function</span><span class="params">(feature, resolution)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">            stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">              color: <span class="string">'blue'</span>,</span></span><br><span class="line"><span class="undefined">              width: 5</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">          &#125;);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">      map.addLayer(wfsVectorLayer);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'#add'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (<span class="keyword">this</span>.checked) &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 勾选新增复选框时，添加绘制的Interaction</span></span></span><br><span class="line"><span class="undefined">        map.removeInteraction(drawInteraction);</span></span><br><span class="line"><span class="undefined">        map.addInteraction(drawInteraction);</span></span><br><span class="line"><span class="actionscript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 取消勾选新增复选框时，移出绘制的Interaction，删除已经绘制的feature</span></span></span><br><span class="line"><span class="undefined">        map.removeInteraction(drawInteraction);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (drawedFeature) &#123;</span></span><br><span class="line"><span class="undefined">          drawLayer.getSource().removeFeature(drawedFeature);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="actionscript">        drawedFeature = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 保存新绘制的feature</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">onSaveNew</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 转换坐标</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> geometry = drawedFeature.getGeometry().clone();</span></span><br><span class="line"><span class="actionscript">      geometry.applyTransform(<span class="function"><span class="keyword">function</span><span class="params">(flatCoordinates, flatCoordinates2, stride)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; flatCoordinates.length; j += stride) &#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">var</span> y = flatCoordinates[j];</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">var</span> x = flatCoordinates[j + <span class="number">1</span>];</span></span><br><span class="line"><span class="undefined">          flatCoordinates[j] = x;</span></span><br><span class="line"><span class="undefined">          flatCoordinates[j + 1] = y;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">      </span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 设置feature对应的属性，这些属性是根据数据源的字段来设置的</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> newFeature = <span class="keyword">new</span> ol.Feature();</span></span><br><span class="line"><span class="actionscript">      newFeature.setId(<span class="string">'nyc_roads.new.'</span> + newId);</span></span><br><span class="line"><span class="actionscript">      newFeature.setGeometryName(<span class="string">'the_geom'</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'the_geom'</span>, <span class="literal">null</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'name'</span>, newFeature.getId());</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'modified'</span>, newFeature.getId());</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'vsam'</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'sourcedate'</span>, <span class="string">''</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'sourcetype'</span>, <span class="string">''</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'source_id'</span>, newId);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'borough'</span>, <span class="string">''</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'feat_code'</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'feat_desc'</span>, <span class="string">'11'</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'feat_type'</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.set(<span class="string">'exported'</span>, <span class="string">'true'</span>);</span></span><br><span class="line"><span class="actionscript">      newFeature.setGeometry(<span class="keyword">new</span> ol.geom.MultiLineString([geometry.getCoordinates()]));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      addWfs([newFeature]);</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 更新id</span></span></span><br><span class="line"><span class="undefined">      newId = newId + 1;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 3秒后，自动刷新页面上的feature</span></span></span><br><span class="line"><span class="actionscript">      setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">        drawLayer.getSource().clear();</span></span><br><span class="line"><span class="undefined">        queryWfs();</span></span><br><span class="line"><span class="undefined">      &#125;, 3000);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 添加到服务器端</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">addWfs</span><span class="params">(features)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> WFSTSerializer = <span class="keyword">new</span> ol.format.WFS();</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> featObject = WFSTSerializer.writeTransaction(features,</span></span><br><span class="line"><span class="actionscript">        <span class="literal">null</span>, <span class="literal">null</span>, &#123;</span></span><br><span class="line"><span class="actionscript">          featureType: <span class="string">'nyc_roads'</span>,</span></span><br><span class="line"><span class="actionscript">          featureNS: <span class="string">'http://geoserver.org/nyc_roads'</span>,</span></span><br><span class="line"><span class="actionscript">          srsName: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> serializer = <span class="keyword">new</span> XMLSerializer();</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> featString = serializer.serializeToString(featObject);</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">      request.open(<span class="string">'POST'</span>, <span class="string">'http://localhost:8080/geoserver/wfs?service=wfs'</span>);</span></span><br><span class="line"><span class="actionscript">      request.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/xml'</span>);</span></span><br><span class="line"><span class="undefined">      request.send(featString);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="通过wfs删除要素"><a href="#通过wfs删除要素" class="headerlink" title="通过wfs删除要素"></a>通过wfs删除要素</h1><p>删除feature是wfs协议中的最后一个例子了，和之前的修改，添加差不多，大同小异。还是先看界面：</p><p><img src="../img/wfs-delete.png" alt="wfs delete demo"></p><p>选择<code>查询</code>按钮，把所有的feature加载到前端，然后勾选<code>选择</code>复选框，就可以在地图上选择要删除的feature，图示选择之前添加的<code>W</code>形状的线条，然后点击<code>删除选中Feature</code>按钮，就可以把feature删除掉。</p><p>在开发者工具窗口里面可以看到删除feature的http请求： <code>http://localhost:8080/geoserver/wfs?service=wfs</code>，其发送的内容为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Transaction</span> <span class="attr">xmlns</span>=<span class="string">"http://www.opengis.net/wfs"</span> <span class="attr">service</span>=<span class="string">"WFS"</span> <span class="attr">version</span>=<span class="string">"1.1.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Delete</span> <span class="attr">typeName</span>=<span class="string">"feature:nyc_roads"</span> <span class="attr">xmlns:feature</span>=<span class="string">"http://geoserver.org/nyc_roads"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Filter</span> <span class="attr">xmlns</span>=<span class="string">"http://www.opengis.net/ogc"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FeatureId</span> <span class="attr">fid</span>=<span class="string">"nyc_roads.1302"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Transaction</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>服务器端<code>response</code>的内容为：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">  &lt;wf<span class="variable">s:TransactionResponse</span> xmln<span class="variable">s:xs</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> xmln<span class="variable">s:sf</span>=<span class="string">"http://www.openplans.org/spearfish"</span> xmln<span class="variable">s:wfs</span>=<span class="string">"http://www.opengis.net/wfs"</span> xmln<span class="variable">s:gml</span>=<span class="string">"http://www.opengis.net/gml"</span> xmln<span class="variable">s:nyc_roads</span>=<span class="string">"http://geoserver.org/nyc_roads"</span> xmln<span class="variable">s:ogc</span>=<span class="string">"http://www.opengis.net/ogc"</span> xmln<span class="variable">s:ows</span>=<span class="string">"http://www.opengis.net/ows"</span> xmln<span class="variable">s:tiger</span>=<span class="string">"http://www.census.gov"</span> xmln<span class="variable">s:topp</span>=<span class="string">"http://www.openplans.org/topp"</span> xmln<span class="variable">s:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> xmln<span class="variable">s:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="keyword">version</span>=<span class="string">"1.1.0"</span> xsi:schemaLocation=<span class="string">"http://www.opengis.net/wfs http://localhost:8080/geoserver/schemas/wfs/1.1.0/wfs.xsd"</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:TransactionSummary</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:totalInserted</span>&gt;<span class="number">0</span>&lt;/wf<span class="variable">s:totalInserted</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:totalUpdated</span>&gt;<span class="number">0</span>&lt;/wf<span class="variable">s:totalUpdated</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:totalDeleted</span>&gt;<span class="number">1</span>&lt;/wf<span class="variable">s:totalDeleted</span>&gt;</span><br><span class="line">    &lt;/wf<span class="variable">s:TransactionSummary</span>&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:TransactionResults</span>/&gt;</span><br><span class="line">    &lt;wf<span class="variable">s:InsertResults</span>&gt;</span><br><span class="line">      &lt;wf<span class="variable">s:Feature</span>&gt;</span><br><span class="line">        &lt;ogc:FeatureId fid=<span class="string">"none"</span> /&gt;</span><br><span class="line">      &lt;/wf<span class="variable">s:Feature</span>&gt;</span><br><span class="line">    &lt;/wf<span class="variable">s:InsertResults</span>&gt;</span><br><span class="line">  &lt;/wf<span class="variable">s:TransactionResponse</span>&gt;</span><br></pre></td></tr></table></figure></p><p>通过再次刷新查询，可以确认刚才的feature是否成功删除。请自行验证，对应实例的代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>wfs crud demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../ol3.17.1/ol.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../ol3.17.1/ol-debug.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../3rdparty/zepto.min.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"查询"</span> <span class="attr">onclick</span>=<span class="string">"queryWfs();"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"select"</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"select"</span> /&gt;</span>选择</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"delete"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"删除选中Feature"</span> <span class="attr">onclick</span>=<span class="string">"onDeleteFeature();"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map"</span> <span class="attr">style</span>=<span class="string">"width:100%;height:100%;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> wfsVectorLayer = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 选择器</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> selectInteraction = <span class="keyword">new</span> ol.interaction.Select(&#123;</span></span><br><span class="line"><span class="actionscript">      style: <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">        stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">          color: <span class="string">'red'</span>,</span></span><br><span class="line"><span class="undefined">          width: 10</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> map = <span class="keyword">new</span> ol.Map(&#123;</span></span><br><span class="line"><span class="actionscript">      layers: [<span class="keyword">new</span> ol.layer.Tile(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.OSM()</span></span><br><span class="line"><span class="undefined">      &#125;)],</span></span><br><span class="line"><span class="actionscript">      target: <span class="string">'map'</span>,</span></span><br><span class="line"><span class="actionscript">      view: <span class="keyword">new</span> ol.View(&#123;</span></span><br><span class="line"><span class="undefined">        center: [-73.99710639567148, 40.742270050255556],</span></span><br><span class="line"><span class="undefined">        maxZoom: 19,</span></span><br><span class="line"><span class="undefined">        zoom: 13,</span></span><br><span class="line"><span class="actionscript">        projection: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">queryWfs</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (wfsVectorLayer) &#123;</span></span><br><span class="line"><span class="undefined">        map.removeLayer(wfsVectorLayer);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">      wfsVectorLayer = <span class="keyword">new</span> ol.layer.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">        source: <span class="keyword">new</span> ol.source.Vector(&#123;</span></span><br><span class="line"><span class="actionscript">          format: <span class="keyword">new</span> ol.format.GeoJSON(&#123;</span></span><br><span class="line"><span class="actionscript">            geometryName: <span class="string">'the_geom'</span></span></span><br><span class="line"><span class="undefined">          &#125;),</span></span><br><span class="line"><span class="actionscript">          url: <span class="string">'http://localhost:8080/geoserver/wfs?service=wfs&amp;version=1.1.0&amp;request=GetFeature&amp;typeNames=nyc_roads:nyc_roads&amp;outputFormat=application/json&amp;srsname=EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">        &#125;),</span></span><br><span class="line"><span class="actionscript">        style: <span class="function"><span class="keyword">function</span><span class="params">(feature, resolution)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> <span class="keyword">new</span> ol.style.Style(&#123;</span></span><br><span class="line"><span class="actionscript">            stroke: <span class="keyword">new</span> ol.style.Stroke(&#123;</span></span><br><span class="line"><span class="actionscript">              color: <span class="string">'blue'</span>,</span></span><br><span class="line"><span class="undefined">              width: 5</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">          &#125;);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined">      map.addLayer(wfsVectorLayer);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'#select'</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (<span class="keyword">this</span>.checked) &#123;</span></span><br><span class="line"><span class="undefined">        map.removeInteraction(selectInteraction);</span></span><br><span class="line"><span class="undefined">        map.addInteraction(selectInteraction);</span></span><br><span class="line"><span class="actionscript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">        map.removeInteraction(selectInteraction);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">onDeleteFeature</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="comment">// 删选择器选中的feature</span></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (selectInteraction.getFeatures().getLength() &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="undefined">        deleteWfs([selectInteraction.getFeatures().item(0)]);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 3秒后自动更新features</span></span></span><br><span class="line"><span class="actionscript">        setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">          selectInteraction.getFeatures().clear();</span></span><br><span class="line"><span class="undefined">          queryWfs();</span></span><br><span class="line"><span class="undefined">        &#125;, 3000);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 在服务器端删除feature</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">deleteWfs</span><span class="params">(features)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> WFSTSerializer = <span class="keyword">new</span> ol.format.WFS();</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> featObject = WFSTSerializer.writeTransaction(<span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">        <span class="literal">null</span>, features, &#123;</span></span><br><span class="line"><span class="actionscript">          featureType: <span class="string">'nyc_roads'</span>,</span></span><br><span class="line"><span class="actionscript">          featureNS: <span class="string">'http://geoserver.org/nyc_roads'</span>,</span></span><br><span class="line"><span class="actionscript">          srsName: <span class="string">'EPSG:4326'</span></span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> serializer = <span class="keyword">new</span> XMLSerializer();</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> featString = serializer.serializeToString(featObject);</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">      request.open(<span class="string">'POST'</span>, <span class="string">'http://localhost:8080/geoserver/wfs?service=wfs'</span>);</span></span><br><span class="line"><span class="actionscript">      request.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/xml'</span>);</span></span><br><span class="line"><span class="undefined">      request.send(featString);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;进阶实例&quot;&gt;&lt;a href=&quot;#进阶实例&quot; class=&quot;headerlink&quot; title=&quot;进阶实例&quot;&gt;&lt;/a&gt;进阶实例&lt;/h1&gt;&lt;p&gt;前面的基础知识，用于应对基本应用没有问题，但如果想更进一步的结合在一起应用，或者解决更为复杂一点的问题，则稍显困难。本章节针对这类问题给出一些实例讲解，以解决广大ol3使用者的困惑，用于感谢大家对本教程的支持。针对这类问题，曾经在Openlayer3 QQ群里面收集统计过，下面的例子就是基于这些统计数据分析讨论而出的。如果你有什么其他的想法或意见，请在下方留言或QQ联系我（11364382），谢谢。&lt;/p&gt;
    
    </summary>
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/categories/openLayers/"/>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>openlayers</title>
    <link href="https://jiangshaobo.cn/20180118/openlayers/index.html"/>
    <id>https://jiangshaobo.cn/20180118/openlayers/index.html</id>
    <published>2018-01-18T12:00:31.000Z</published>
    <updated>2018-01-30T15:04:08.480Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OpenLayers-3-Primer"><a href="#OpenLayers-3-Primer" class="headerlink" title="OpenLayers 3 Primer"></a>OpenLayers 3 Primer</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>由于在学习OpenLayers3，有缘看到OpenLayers 3 Primer教程，真是很荣幸。转到博客，仅仅方便地铁上阅读，学习。<br>这是一个关于OpenLayers 3使用的入门教程。帮助初学者逐步认识OpenLayers 3，理解地图组成，以及各个组成部分的作用。在此基础上，逐个突破，结合大量的实例，指导大家应用OpenLayers 3开发出符合业务的地图。在这个过程中，辅以对应的理论知识，学习了解OpenLayers 3背后的原理，尽量做到知其然且知其所以然，为更高级的OpenLayers 3开发打下坚实的基础。本教程将坚持实用为主，对应用中遇到的重点、难点加以详细讲解，提出实用方案。</p><p>为了满足广大初学者的需要，教程将坚持一个原则：即以<strong>浅显易懂</strong>为基础，以<strong>有效实用</strong>为最终目标的原则。</p><a id="more"></a><h2 id="为什么要写这样一个教程"><a href="#为什么要写这样一个教程" class="headerlink" title="为什么要写这样一个教程"></a>为什么要写这样一个教程</h2><p>故事是从我学习OpenLayers 3开始的。那时版本才3.0.0，当时学习OpenLayers 3很快就入手了，没有遇到任何障碍。 但后来发现有些初学者并不是这样的，都不知道怎么入手，遇到很多问题，我在回答了很多类似问题后，开始寻找入门难的原因。 总结下来有两个主要原因：</p><ul><li>第一，虽然官网有关于每个类和方法的API文档，也有相关的例子，但就是没有一个系统的教程把他们串起来，对着例子虽然能做出一些类似的业务，但并不能灵活应用，自然会遇到很多问题。 同时国内目前并没有一本关于OpenLayers 3学习的书籍或教程，这是比较让人遗憾的事。庆幸地是国外的同仁已经写了两本英文书籍，一本是<a href="https://www.packtpub.com/web-development/openlayers-3-beginner%E2%80%99s-guide" target="_blank" rel="noopener">OpenLayers 3: Beginner’s Guide</a>，需要付费；另一本是<a href="https://leanpub.com/thebookofopenlayers3" target="_blank" rel="noopener">The book of OpenLayers 3</a>，需要付费，但同时也支持开放。但对于国内开发者而言，还是中文更加可读。 (国外最近又出了两本需要付费的书，一本是<a href="https://www.packtpub.com/web-development/mastering-openlayers-3" target="_blank" rel="noopener">Mastering Openlayers 3</a>，这本书内容涵盖也比较全面，对英文没有障碍的初学者，可以学习。 另一本是<a href="https://www.packtpub.com/web-development/openlayers-3x-cookbook-second-edition" target="_blank" rel="noopener">OpenLayers 3.x Cookbook - Second Edition</a>)</li><li>第二，使用OpenLayers 3的初学者并不都是GIS专业出身，有很大一部分是前端开发者，或者其他领域的开发者，GIS相关的理论知识欠缺。同时，还有一些开发者连JavaScript语言也不熟练，API文档都不知道如何阅读。 但由于任务或者项目压身，不得不使用Openlayers开发，自然会遇到很多困难。</li></ul><p>为了解决这个问题，我写过一篇<a href="http://www.jianshu.com/p/6785e755fa0d" target="_blank" rel="noopener">OpenLayers 3 入门指南</a>，一开始想当然地认为可以解决入门问题，直到有一天在群里来了一个初学者，他看了这篇文章后，觉得并没有什么卵用。这时我才意识到问题的严重性，问题没解决，反而多了一篇垃圾。因为入门者需要的是更为具体的东西。 在征集了大多数人的意见后，我决定写这本教程（在此一并感谢QQ群里那些提出意见，给予帮助的帅哥美女们）。目前国内存在很多OpenLayers 3的爱好者和使用者，我所在的QQ群就有将近千人，同时还存在很多其他关于OpenLayers的群，后续还会有更多的开发者使用它。</p><p>本教程作为一次尝试，我愿意做第一本国内的OpenLayers 3教程，希望能在开放的情况下，真正帮助到国内OpenLayers 3的初学者入门，虽然这并不容易，但我愿意挑战自己，并加入到开源的潮流中去，以此向OpenLayers 3这个优秀的开源引擎致敬，向它的开发团队和所有贡献者致敬！</p><h2 id="目标读者"><a href="#目标读者" class="headerlink" title="目标读者"></a>目标读者</h2><p>本教程的主要目标读者是刚开始接触OpenLayers 3的应用开发者，但对它有一定了解的开发者也可以通过这个教程的后续部分来提升自己的理解和认识。同时希望对它有深入了解的开发者review本教程，提交issue或者PR。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>OpenLayers 3的版本: 3.13.1</li><li>浏览器: chrome 47.0.2526.111(64bit)</li></ul><h3 id="关于环境，这边可能会使用openlayers-3或者4来实验和学习。"><a href="#关于环境，这边可能会使用openlayers-3或者4来实验和学习。" class="headerlink" title="关于环境，这边可能会使用openlayers 3或者4来实验和学习。"></a>关于环境，这边可能会使用openlayers 3或者4来实验和学习。</h3><h2 id="关于作者"><a href="#关于作者" class="headerlink" title="关于作者"></a>关于作者</h2><p>QQ群 OpenLayers官方旗舰群[2] 里面的 <strong>扯淡大叔</strong><br>QQ: 11364382</p><h3 id="BTW"><a href="#BTW" class="headerlink" title="BTW"></a>BTW</h3><p>我和一帮天南海北的朋友们正在开发一个开源的WEB 3D GIS引擎<a href="http://www.f3earth.com" target="_blank" rel="noopener">F3Earth</a>，有兴趣的朋友可以了解一下，谢谢大家的支持。</p><h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><ul><li><a href="./ch01/index.html">OpenLayers 3 介绍</a></li><li><a href="./ch02/index.html">一个简单的地图</a></li><li><a href="./ch03/index.html">OpenLayers 3地图</a><ul><li><a href="./ch03/index.html">初步解析地图组成</a></li><li><a href="./ch03/index.html">地图所有组成部分</a></li><li><a href="./ch03/index.html">看懂API</a></li><li><a href="./ch03/index.html">结合API文档分析代码</a></li><li><a href="./ch03/index.html">ol.Map的应用</a><ul><li><a href="./ch03/index.html">定制地图logo</a></li><li><a href="./ch03/index.html">单页面多地图</a></li><li><a href="./ch03/index.html">地图联动</a></li><li><a href="./ch03/index.html">动态交换地图</a></li></ul></li></ul></li><li><a href="./ch04/index.html">View</a><ul><li><a href="./ch04/index.html">地图导航</a></li><li><a href="./ch04/index.html">坐标</a></li><li><a href="./ch04/index.html">坐标系及投影</a></li><li><a href="./ch04/index.html">OpenLayers 3使用的坐标系</a></li><li><a href="./ch04/index.html">ol.View的应用</a><ul><li><a href="./ch04/index.html">限制地图范围</a></li><li><a href="./ch04/index.html">限制地图缩放级别</a></li><li><a href="./ch04/index.html">自适配区域</a></li></ul></li></ul></li><li><a href="./ch05/index.html">Source和Layer</a><ul><li><a href="./ch05/index.html">加载瓦片地图</a><ul><li><a href="./ch05/index.html">最简单的加载在线地图</a></li><li><a href="./ch05/index.html">万能瓦片地图加载秘籍</a></li><li><a href="./ch05/index.html">加载离线瓦片地图</a></li><li><a href="./ch05/index.html">瓦片加载的源码浅析与小结</a></li></ul></li><li><a href="./ch05/index.html">静态地图及应用</a></li><li><a href="./ch05/index.html">加载WMS服务地图</a></li><li><a href="./ch05/index.html">矢量地图</a><ul><li><a href="./ch05/index.html">获取加载后的所有feature</a></li><li><a href="./ch05/index.html">坐标转换</a></li><li><a href="./ch05/index.html">样式设置</a></li></ul></li><li><a href="./ch05/index.html">图层叠加及管理</a></li></ul></li><li><a href="./ch06/index.html">LOD与分辨率</a><ul><li><a href="./ch06/index.html">LOD原理</a></li><li><a href="./ch06/index.html">瓦片计算</a></li><li><a href="./ch06/index.html">分辨率</a></li><li><a href="./ch06/index.html">自定义瓦片地图及加载</a></li></ul></li><li><a href="./ch07/index.html">图标及提示信息</a><ul><li><a href="./ch07/index.html">应用overlay</a></li><li><a href="./ch07/index.html">动画图标</a></li><li><a href="./ch07/index.html">style及应用</a><ul><li><a href="./ch07/index.html">设置图标位置</a></li><li><a href="./ch07/index.html">根据层级放大缩小图标</a></li><li><a href="./ch07/index.html">另类设置svg图标</a></li><li><a href="./ch07/index.html">规则几何体图标</a></li><li><a href="./ch07/index.html">用Canvas自绘图标</a></li><li><a href="./ch07/index.html">动态改变图标</a></li><li><a href="./ch07/index.html">文字标注</a></li></ul></li><li><a href="./ch07/index.html">styleFunction应用</a></li><li><a href="./ch07/index.html">大量图标方案</a></li><li><a href="./ch07/index.html">提示信息</a></li></ul></li><li><a href="./ch08/index.html">事件</a><ul><li><a href="./ch08/index.html">一个简单的事件应用</a></li><li><a href="./ch08/index.html">注销事件响应</a></li><li><a href="./ch08/index.html">常用事件</a></li><li><a href="./ch08/index.html">自定义事件及应用</a></li></ul></li><li><a href="./ch09/index.html">Interaction</a><ul><li><a href="./ch09/index.html">内置交互方式介绍</a></li><li><a href="./ch09/index.html">实现原理</a></li><li><a href="./ch09/index.html">Feature选取之选中样式</a></li><li><a href="./ch09/index.html">Feature选取之条件过滤</a></li><li><a href="./ch09/index.html">Feature选取之取消选中</a></li><li><a href="./ch09/index.html">绘制一条线</a></li><li><a href="./ch09/index.html">绘图进阶</a></li><li><a href="./ch09/09-08.md">总结</a></li></ul></li><li><a href="./ch10/index.html">Control</a><ul><li><a href="./ch10/10-01.md">控件概览</a></li><li><a href="./ch10/10-02.md">探究控件原理</a></li><li><a href="./ch10/10-03.md">控件美颜</a></li><li><a href="./ch10/10-04.md">自定义控件</a></li></ul></li><li><a href="./ch11/index.html">动画</a><ul><li><a href="./ch11/11-01.md">动画简单应用</a></li><li><a href="./ch11/11-02.md">动画高阶应用</a></li><li><a href="./ch11/11-03.md">利用postcompose事件做动画</a></li></ul></li><li><a href="./ch12/index.html">进阶实例</a><ul><li><a href="./ch12/index.html">通过wfs增删改查要素</a><ul><li><a href="./ch12/index.html">GeoServer环境配置</a></li><li><a href="./ch12/index.html">配置数据源</a></li><li><a href="./ch12/index.html">通过wfs查询要素</a></li><li><a href="./ch12/index.html">通过wfs修改要素</a></li><li><a href="./ch12/index.html">通过wfs添加要素</a></li><li><a href="./ch12/index.html">通过wfs删除要素</a></li></ul></li></ul></li><li><a href="./ch13/index.html">常见问题</a></li><li><a href="./ch14/index.html">注意事项</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;OpenLayers-3-Primer&quot;&gt;&lt;a href=&quot;#OpenLayers-3-Primer&quot; class=&quot;headerlink&quot; title=&quot;OpenLayers 3 Primer&quot;&gt;&lt;/a&gt;OpenLayers 3 Primer&lt;/h1&gt;&lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;由于在学习OpenLayers3，有缘看到OpenLayers 3 Primer教程，真是很荣幸。转到博客，仅仅方便地铁上阅读，学习。&lt;br&gt;这是一个关于OpenLayers 3使用的入门教程。帮助初学者逐步认识OpenLayers 3，理解地图组成，以及各个组成部分的作用。在此基础上，逐个突破，结合大量的实例，指导大家应用OpenLayers 3开发出符合业务的地图。在这个过程中，辅以对应的理论知识，学习了解OpenLayers 3背后的原理，尽量做到知其然且知其所以然，为更高级的OpenLayers 3开发打下坚实的基础。本教程将坚持实用为主，对应用中遇到的重点、难点加以详细讲解，提出实用方案。&lt;/p&gt;
&lt;p&gt;为了满足广大初学者的需要，教程将坚持一个原则：即以&lt;strong&gt;浅显易懂&lt;/strong&gt;为基础，以&lt;strong&gt;有效实用&lt;/strong&gt;为最终目标的原则。&lt;/p&gt;
    
    </summary>
    
    
      <category term="openLayers" scheme="https://jiangshaobo.cn/tags/openLayers/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat运行一段时间后报错cache eviction process was unable to free [10]</title>
    <link href="https://jiangshaobo.cn/20180118/Tomcat%E8%BF%90%E8%A1%8C%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%E6%8A%A5%E9%94%99cache-eviction-process-was-unable-to-free.html"/>
    <id>https://jiangshaobo.cn/20180118/Tomcat运行一段时间后报错cache-eviction-process-was-unable-to-free.html</id>
    <published>2018-01-18T09:50:25.000Z</published>
    <updated>2018-02-04T14:22:17.896Z</updated>
    
    <content type="html"><![CDATA[<h5 id="应用运行一段时间后崩掉了。查看日志记录如下"><a href="#应用运行一段时间后崩掉了。查看日志记录如下" class="headerlink" title="应用运行一段时间后崩掉了。查看日志记录如下:"></a>应用运行一段时间后崩掉了。查看日志记录如下:</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">15-Jan-2018 16:56:55.801 INFO [ContainerBackgroundProcessor[StandardEngine[Catal</span><br><span class="line">ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c</span><br><span class="line">ache eviction process was unable to free [10] percent of the <span class="keyword">cache</span> <span class="keyword">for</span> <span class="keyword">Context</span> [</span><br><span class="line">] - <span class="keyword">consider</span> increasing the maximum <span class="keyword">size</span> <span class="keyword">of</span> the cache. <span class="keyword">After</span> eviction approximat</span><br><span class="line">ely [<span class="number">24</span>,<span class="number">460</span>] KB <span class="keyword">of</span> <span class="keyword">data</span> remained <span class="keyword">in</span> the cache.</span><br><span class="line"><span class="number">15</span>-Jan<span class="number">-2018</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">05.810</span> INFO [ContainerBackgroundProcessor[StandardEngine[Catal</span><br><span class="line">ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c</span><br><span class="line">ache eviction process was unable <span class="keyword">to</span> free [<span class="number">10</span>] <span class="keyword">percent</span> <span class="keyword">of</span> the <span class="keyword">cache</span> <span class="keyword">for</span> <span class="keyword">Context</span> [</span><br><span class="line">] - <span class="keyword">consider</span> increasing the maximum <span class="keyword">size</span> <span class="keyword">of</span> the cache. <span class="keyword">After</span> eviction approximat</span><br><span class="line">ely [<span class="number">24</span>,<span class="number">460</span>] KB <span class="keyword">of</span> <span class="keyword">data</span> remained <span class="keyword">in</span> the cache.</span><br><span class="line"><span class="number">15</span>-Jan<span class="number">-2018</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">15.819</span> INFO [ContainerBackgroundProcessor[StandardEngine[Catal</span><br><span class="line">ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c</span><br><span class="line">ache eviction process was unable <span class="keyword">to</span> free [<span class="number">10</span>] <span class="keyword">percent</span> <span class="keyword">of</span> the <span class="keyword">cache</span> <span class="keyword">for</span> <span class="keyword">Context</span> [</span><br><span class="line">] - <span class="keyword">consider</span> increasing the maximum <span class="keyword">size</span> <span class="keyword">of</span> the cache. <span class="keyword">After</span> eviction approximat</span><br><span class="line">ely [<span class="number">24</span>,<span class="number">460</span>] KB <span class="keyword">of</span> <span class="keyword">data</span> remained <span class="keyword">in</span> the cache.</span><br><span class="line"><span class="number">15</span>-Jan<span class="number">-2018</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">25.827</span> INFO [ContainerBackgroundProcessor[StandardEngine[Catal</span><br><span class="line">ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c</span><br><span class="line">ache eviction process was unable <span class="keyword">to</span> free [<span class="number">10</span>] <span class="keyword">percent</span> <span class="keyword">of</span> the <span class="keyword">cache</span> <span class="keyword">for</span> <span class="keyword">Context</span> [</span><br><span class="line">] - <span class="keyword">consider</span> increasing the maximum <span class="keyword">size</span> <span class="keyword">of</span> the cache. <span class="keyword">After</span> eviction approximat</span><br><span class="line">ely [<span class="number">24</span>,<span class="number">460</span>] KB <span class="keyword">of</span> <span class="keyword">data</span> remained <span class="keyword">in</span> the cache.</span><br></pre></td></tr></table></figure><a id="more"></a><h5 id="日志中记录并给出了建议："><a href="#日志中记录并给出了建议：" class="headerlink" title="日志中记录并给出了建议："></a>日志中记录并给出了建议：</h5><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consider increasing <span class="keyword">the</span> maximum size <span class="keyword">of</span> <span class="keyword">the</span> cache</span><br></pre></td></tr></table></figure><p>也就是增加最大缓存。</p><p>打开tomcat下的conf文件下(tomcat_home/conf/Catalina/localhost/里的context文件里)<br>的context.xml在文件尾部前增加添加这么一行：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Resources <span class="attribute">cachingAllowed</span>=<span class="string">"true"</span> <span class="attribute">cacheMaxSize</span>=<span class="string">"100000"</span> /&gt;</span><br></pre></td></tr></table></figure></p><p>把cacheMaxSize调大就行了。</p><h5 id="群友说可能是代码的问题，正在排查中。"><a href="#群友说可能是代码的问题，正在排查中。" class="headerlink" title="群友说可能是代码的问题，正在排查中。"></a>群友说可能是代码的问题，正在排查中。</h5><p>最后来个群友发的段子。</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">我今天突然觉得递归可以这样通俗的表达出来：</span><br><span class="line">两个人玩成语接龙，第一个人说：为所欲为。</span><br><span class="line">第二个人说：为所欲为。</span><br><span class="line">......</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;应用运行一段时间后崩掉了。查看日志记录如下&quot;&gt;&lt;a href=&quot;#应用运行一段时间后崩掉了。查看日志记录如下&quot; class=&quot;headerlink&quot; title=&quot;应用运行一段时间后崩掉了。查看日志记录如下:&quot;&gt;&lt;/a&gt;应用运行一段时间后崩掉了。查看日志记录如下:&lt;/h5&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;15-Jan-2018 16:56:55.801 INFO [ContainerBackgroundProcessor[StandardEngine[Catal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ache eviction process was unable to free [10] percent of the &lt;span class=&quot;keyword&quot;&gt;cache&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;Context&lt;/span&gt; [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;] - &lt;span class=&quot;keyword&quot;&gt;consider&lt;/span&gt; increasing the maximum &lt;span class=&quot;keyword&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; the cache. &lt;span class=&quot;keyword&quot;&gt;After&lt;/span&gt; eviction approximat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ely [&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;460&lt;/span&gt;] KB &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt; remained &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; the cache.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;-Jan&lt;span class=&quot;number&quot;&gt;-2018&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;57&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;05.810&lt;/span&gt; INFO [ContainerBackgroundProcessor[StandardEngine[Catal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ache eviction process was unable &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; free [&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;] &lt;span class=&quot;keyword&quot;&gt;percent&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; the &lt;span class=&quot;keyword&quot;&gt;cache&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;Context&lt;/span&gt; [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;] - &lt;span class=&quot;keyword&quot;&gt;consider&lt;/span&gt; increasing the maximum &lt;span class=&quot;keyword&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; the cache. &lt;span class=&quot;keyword&quot;&gt;After&lt;/span&gt; eviction approximat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ely [&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;460&lt;/span&gt;] KB &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt; remained &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; the cache.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;-Jan&lt;span class=&quot;number&quot;&gt;-2018&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;57&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;15.819&lt;/span&gt; INFO [ContainerBackgroundProcessor[StandardEngine[Catal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ache eviction process was unable &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; free [&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;] &lt;span class=&quot;keyword&quot;&gt;percent&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; the &lt;span class=&quot;keyword&quot;&gt;cache&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;Context&lt;/span&gt; [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;] - &lt;span class=&quot;keyword&quot;&gt;consider&lt;/span&gt; increasing the maximum &lt;span class=&quot;keyword&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; the cache. &lt;span class=&quot;keyword&quot;&gt;After&lt;/span&gt; eviction approximat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ely [&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;460&lt;/span&gt;] KB &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt; remained &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; the cache.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;15&lt;/span&gt;-Jan&lt;span class=&quot;number&quot;&gt;-2018&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;57&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;25.827&lt;/span&gt; INFO [ContainerBackgroundProcessor[StandardEngine[Catal&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ina]]] org.apache.catalina.webresources.Cache.backgroundProcess The background c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ache eviction process was unable &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; free [&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;] &lt;span class=&quot;keyword&quot;&gt;percent&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; the &lt;span class=&quot;keyword&quot;&gt;cache&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;Context&lt;/span&gt; [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;] - &lt;span class=&quot;keyword&quot;&gt;consider&lt;/span&gt; increasing the maximum &lt;span class=&quot;keyword&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; the cache. &lt;span class=&quot;keyword&quot;&gt;After&lt;/span&gt; eviction approximat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ely [&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;460&lt;/span&gt;] KB &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt; remained &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; the cache.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="tomcat" scheme="https://jiangshaobo.cn/tags/tomcat/"/>
    
  </entry>
  
  <entry>
    <title>win10安装Postgresql 错误解决方案 Failed to load sql modules into the</title>
    <link href="https://jiangshaobo.cn/20180114/win10%E5%AE%89%E8%A3%85Postgresql-%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-Failed-to-load-sql-modules-into-the.html"/>
    <id>https://jiangshaobo.cn/20180114/win10安装Postgresql-错误解决方案-Failed-to-load-sql-modules-into-the.html</id>
    <published>2018-01-14T08:28:57.000Z</published>
    <updated>2018-02-04T14:22:28.030Z</updated>
    
    <content type="html"><![CDATA[<h4 id="win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了-Failed-to-load-sql-modules-into-the-database-cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。"><a href="#win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了-Failed-to-load-sql-modules-into-the-database-cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。" class="headerlink" title="win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了 Failed to load sql modules into the database cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。"></a>win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了 Failed to load sql modules into the database cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。</h4><p>步骤如下：<br>I was getting this same error when trying to install PostgreSQL v9.4.4 on Windows 10 Pro. Starting with a solution hosted on Stack Exchange, I came up with the following steps that allowed the installer to run successfully:</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) Create <span class="keyword">a</span> <span class="built_in">new</span> user account, called postgres</span><br><span class="line"><span class="number">2</span>) Add <span class="keyword">the</span> <span class="built_in">new</span> account <span class="built_in">to</span> <span class="keyword">the</span> Administrators <span class="keyword">and</span> Power Users groups</span><br><span class="line"><span class="number">3</span>) Restart <span class="keyword">the</span> computer</span><br><span class="line">    NOTE: I added step <span class="comment">#3, since step #4 didn't work without it</span></span><br><span class="line"><span class="number">4</span>) Run <span class="keyword">a</span> <span class="keyword">command</span> <span class="title">prompt</span> <span class="title">as</span> <span class="title">the</span> <span class="title">postgres</span> <span class="title">user</span>, <span class="title">using</span> <span class="title">the</span> <span class="title">command</span>:</span><br><span class="line">    runas /user:postgres cmd.exe</span><br><span class="line"><span class="number">5</span>) Run <span class="keyword">the</span> installer <span class="built_in">from</span> <span class="keyword">the</span> postgres <span class="keyword">command</span> <span class="title">window</span></span><br><span class="line"><span class="number">6</span>) Delete <span class="keyword">the</span> postgres user account, <span class="keyword">as</span> well <span class="keyword">as</span> <span class="keyword">the</span> user <span class="built_in">directory</span></span><br><span class="line">    NOTE: I added step <span class="comment">#6, since the postgres account is not required after installation</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>第二步的话，在win10下很简单，在此电脑（我的电脑）下右键选管理，右键-》新增用户（postgres），然后重启用原来的用户登陆。<br>注意第四步，可以按win+r打开运行命令，然后输入<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runas /<span class="keyword">user</span>:postgres <span class="keyword">cmd</span>.<span class="bash">exe</span></span><br></pre></td></tr></table></figure></p><p>之后在cmd里面直接运行postgresql-10.1-3-windows-x64.exe，安装成功。<br>win10安装Postgresql 错误解决方案 Failed to load sql modules into the database cluster<br>win10安装Postgresql 错误解决方案 新增用户</p><p><img src="https://www.whatled.com/content/uploadfile/201712/38de1513519156.png" alt=""><br><img src="https://www.whatled.com/content/uploadfile/201712/704c1513519157.png" alt=""></p><p>建议访问：<a href="https://stackoverflow.com/questions/30689251/failed-to-load-sql-modules-into-the-database-cluster-during-postgresql-installat/" target="_blank" rel="noopener">stackoverflow</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了-Failed-to-load-sql-modules-into-the-database-cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。&quot;&gt;&lt;a href=&quot;#win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了-Failed-to-load-sql-modules-into-the-database-cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。&quot; class=&quot;headerlink&quot; title=&quot;win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了 Failed to load sql modules into the database cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。&quot;&gt;&lt;/a&gt;win10安装postgrelsql安装了很多次都是报错，开始查明以为是权限的问题，然后就给文件夹赋予权限，以为快解决了，又出现了 Failed to load sql modules into the database cluster的错误，于是根据错误去继续寻找解决方案，ubuntu下分分钟就install了。最后翻看stackoverflow找到解决方案。&lt;/h4&gt;&lt;p&gt;步骤如下：&lt;br&gt;I was getting this same error when trying to install PostgreSQL v9.4.4 on Windows 10 Pro. Starting with a solution hosted on Stack Exchange, I came up with the following steps that allowed the installer to run successfully:&lt;/p&gt;
&lt;figure class=&quot;highlight livecodeserver&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) Create &lt;span class=&quot;keyword&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;new&lt;/span&gt; user account, called postgres&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) Add &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;new&lt;/span&gt; account &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; Administrators &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; Power Users groups&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) Restart &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; computer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    NOTE: I added step &lt;span class=&quot;comment&quot;&gt;#3, since step #4 didn&#39;t work without it&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;) Run &lt;span class=&quot;keyword&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;prompt&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;postgres&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;user&lt;/span&gt;, &lt;span class=&quot;title&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;command&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    runas /user:postgres cmd.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;) Run &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; installer &lt;span class=&quot;built_in&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; postgres &lt;span class=&quot;keyword&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;window&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;) Delete &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; postgres user account, &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; well &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; user &lt;span class=&quot;built_in&quot;&gt;directory&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    NOTE: I added step &lt;span class=&quot;comment&quot;&gt;#6, since the postgres account is not required after installation&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="postgresql" scheme="https://jiangshaobo.cn/tags/postgresql/"/>
    
      <category term="win10" scheme="https://jiangshaobo.cn/tags/win10/"/>
    
      <category term="fail" scheme="https://jiangshaobo.cn/tags/fail/"/>
    
  </entry>
  
  <entry>
    <title>centos ubuntu下安装nodejs环境</title>
    <link href="https://jiangshaobo.cn/20180113/centos-ubuntu%E4%B8%8B%E5%AE%89%E8%A3%85nodejs%E7%8E%AF%E5%A2%83.html"/>
    <id>https://jiangshaobo.cn/20180113/centos-ubuntu下安装nodejs环境.html</id>
    <published>2018-01-13T09:33:18.000Z</published>
    <updated>2018-02-04T15:06:16.126Z</updated>
    
    <content type="html"><![CDATA[<h4 id="申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。"><a href="#申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。" class="headerlink" title="申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。"></a>申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。</h4><p>顺便从头记录node学习相关。</p><p>先安装一个node环境，到node官网下载node安装包<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span>//nodejs<span class="meta">.org</span>/<span class="built_in">zh</span>-cn/download/</span><br></pre></td></tr></table></figure></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nodejs.org/dist/v8.<span class="number">9.3</span>/<span class="keyword">node</span><span class="title">-v8</span>.<span class="number">9.3</span>-linux-x64.tar.xz</span><br></pre></td></tr></table></figure><a id="more"></a><p>centos ubuntu下安装nodejs环境</p><p>由于是新的环境，一切都是新的。</p><p>首先cd到/temp下，wget <a href="https://nodejs.org/dist/v8.9.3/node-v8.9.3-linux-x64.tar.xz" target="_blank" rel="noopener">https://nodejs.org/dist/v8.9.3/node-v8.9.3-linux-x64.tar.xz</a></p><p>然后解压node-v8.9.3-linux-x64.tar.xz文件(默认使用的root用户，非root用户命令前加sudo)。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xvf -d <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">9.3</span>-linux-x64.tar.xz</span><br><span class="line">mv <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">9.3</span>-linux-x64 <span class="keyword">node</span><span class="title"></span></span><br><span class="line"><span class="title">cp</span> -R <span class="keyword">node</span> <span class="title">/usr</span>/local</span><br></pre></td></tr></table></figure><p>将node-v8.9.3-linux-x64重新命名为node</p><p>再把node复制到/usr/local下。</p><p>之后配置环境变量，由于没有安装vim，先使用vi来编辑，</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/<span class="keyword">profile</span></span><br></pre></td></tr></table></figure><p>在/etc/profile下追加node环境配置</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">NODE_HOME</span>=/usr/local/node</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$NODE_HOME</span>/bin:$PATH</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">NODE_PATH</span>=<span class="variable">$NODE_HOME</span>/lib/node_modules:$PATH</span><br></pre></td></tr></table></figure><p>然后按esc之后输入:wq（保存并退出）</p><p>让配置生效source /etc/profile</p><p>这样安装完成。可以使用node -v查看node版本，可以使用npm -v查看npm版本</p><p>安装cnpm或者换源。</p><h4 id="如果在centos下（ubuntu也是类似，只是命令不一样）要编译安装node"><a href="#如果在centos下（ubuntu也是类似，只是命令不一样）要编译安装node" class="headerlink" title="如果在centos下（ubuntu也是类似，只是命令不一样）要编译安装node"></a>如果在centos下（ubuntu也是类似，只是命令不一样）要编译安装node</h4><p>首先</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">yum</span> <span class="literal">-</span><span class="comment">y</span> <span class="comment">install</span> <span class="comment">gcc</span> <span class="comment">make</span> <span class="comment">gcc</span><span class="literal">-</span><span class="comment">c</span><span class="literal">+</span><span class="literal">+</span> <span class="comment">openssl</span><span class="literal">-</span><span class="comment">devel</span> <span class="comment">wget</span></span><br></pre></td></tr></table></figure><p>下载源码</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://nodejs.org/dist/v8.<span class="number">9.3</span>/<span class="keyword">node</span><span class="title">-v8</span>.<span class="number">9.3</span>.tar.gz</span><br></pre></td></tr></table></figure><p>解压<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">9.3</span>-linux-x64.tar.gz</span><br></pre></td></tr></table></figure></p><p>编译安装</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line"><span class="built_in">make</span> &amp;&amp; <span class="built_in">make</span> install</span><br></pre></td></tr></table></figure><p>然后验证</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">-v</span></span><br></pre></td></tr></table></figure><p>安装pm2<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Unitech/</span>pm2</span><br></pre></td></tr></table></figure></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> General</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install pm2 -g            <span class="comment"># Install PM2</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start app.js              <span class="comment"># Start, Daemonize and auto-restart application (Node)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start app.py              <span class="comment"># Start, Daemonize and auto-restart application (Python)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start npm -- start        <span class="comment"># Start, Daemonize and auto-restart Node application</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Cluster Mode (Node.js only)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start app.js -i 4         <span class="comment"># Start 4 instances of application in cluster mode</span></span></span><br><span class="line">                                # it will load balance network queries to each app</span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 reload all                <span class="comment"># Zero Second Downtime Reload</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 scale [app-name] 10       <span class="comment"># Scale Cluster app to 10 process</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Process Monitoring</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 list                      <span class="comment"># List all processes started with PM2</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 monit                     <span class="comment"># Display memory and cpu usage of each app</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 show [app-name]           <span class="comment"># Show all information about application</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Log management</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 logs                      <span class="comment"># Display logs of all apps</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 logs [app-name]           <span class="comment"># Display logs for a specific app</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 logs --json               <span class="comment"># Logs in JSON format</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 flush</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 reloadLogs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Process State Management</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start app.js --name=<span class="string">"api"</span> <span class="comment"># Start application and name it "api"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start app.js -- -a 34     <span class="comment"># Start app and pass option "-a 34" as argument</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start app.js --watch      <span class="comment"># Restart application on file change</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start script.sh           <span class="comment"># Start bash script</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 start app.json            <span class="comment"># Start all applications declared in app.json</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 reset [app-name]          <span class="comment"># Reset all counters</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 stop all                  <span class="comment"># Stop all apps</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 stop 0                    <span class="comment"># Stop process with id 0</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 restart all               <span class="comment"># Restart all apps</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 gracefulReload all        <span class="comment"># Gracefully reload all apps in cluster mode</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 delete all                <span class="comment"># Kill and delete all apps</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 delete 0                  <span class="comment"># Delete app with id 0</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Startup/Boot management</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 startup                   <span class="comment"># Detect init system, generate and configure pm2 boot on startup</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 save                      <span class="comment"># Save current process list</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 resurrect                 <span class="comment"># Restore previously saved processes</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 unstartup                 <span class="comment"># Disable and remove startup system</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 update                    <span class="comment"># Save processes, kill PM2 and restore processes</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 generate                  <span class="comment"># Generate a sample json configuration file</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Deployment</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 deploy app.json prod setup    <span class="comment"># Setup "prod" remote server</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 deploy app.json prod          <span class="comment"># Update "prod" remote server</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 deploy app.json prod revert 2 <span class="comment"># Revert "prod" remote server by 2</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Module system</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 module:generate [name]    <span class="comment"># Generate sample module with name [name]</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 install pm2-logrotate     <span class="comment"># Install module (here a log rotation system)</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 uninstall pm2-logrotate   <span class="comment"># Uninstall module</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pm2 publish                   <span class="comment"># Increment version, git push and npm publish</span></span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。&quot;&gt;&lt;a href=&quot;#申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。&quot; class=&quot;headerlink&quot; title=&quot;申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。&quot;&gt;&lt;/a&gt;申请了阿里云的主机，后续打算将博客转移到阿里云上，之前的腾讯云由于没有备案都闲置了，用作测试。&lt;/h4&gt;&lt;p&gt;顺便从头记录node学习相关。&lt;/p&gt;
&lt;p&gt;先安装一个node环境，到node官网下载node安装包&lt;br&gt;&lt;figure class=&quot;highlight avrasm&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;https:&lt;/span&gt;//nodejs&lt;span class=&quot;meta&quot;&gt;.org&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;zh&lt;/span&gt;-cn/download/&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight crmsh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;https://nodejs.org/dist/v8.&lt;span class=&quot;number&quot;&gt;9.3&lt;/span&gt;/&lt;span class=&quot;keyword&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;title&quot;&gt;-v8&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;9.3&lt;/span&gt;-linux-x64.tar.xz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="nodejs" scheme="https://jiangshaobo.cn/tags/nodejs/"/>
    
      <category term="node.js" scheme="https://jiangshaobo.cn/tags/node-js/"/>
    
      <category term="centos" scheme="https://jiangshaobo.cn/tags/centos/"/>
    
      <category term="ubuntu" scheme="https://jiangshaobo.cn/tags/ubuntu/"/>
    
  </entry>
  
</feed>
